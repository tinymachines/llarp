
<h1 class="sectionedit1" id="device_supportmac_address_setup">Device Support: MAC address setup</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Device Support: MAC address setup&quot;,&quot;hid&quot;:&quot;device_supportmac_address_setup&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-49&quot;} -->
<h2 class="sectionedit2" id="retrieve_addresses_from_stock_firmware">Retrieve addresses from stock firmware</h2>
<div class="level2">

<p>
The first step is to find out which addresses are present in stock configuration.
The procedure depends on your level of access to the device&#039;s firmware.
</p>

<p>
The result would be a list like the following:
</p>
<pre class="code">LAN ..:..:..:..:..:0a
WAN ..:..:..:..:..:0b
2.4 GHz ..:..:..:..:..:0c
5 GHz ..:..:..:..:..:0a</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Retrieve addresses from stock firmware&quot;,&quot;hid&quot;:&quot;retrieve_addresses_from_stock_firmware&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;50-415&quot;} -->
<h2 class="sectionedit3" id="find_out_about_flash_locations">Find out about flash locations</h2>
<div class="level2">

<p>
If you already have OpenWrt running on the device, you can try to find out about MAC locations on flash (note that not all devices store addresses there).
</p>

<p>
List partitions:
</p>
<pre class="code">$ cat /proc/mtd
dev:    size   erasesize  name
mtd0: 00020000 00010000 &quot;u-boot&quot;
mtd1: 00189ce4 00010000 &quot;kernel&quot;
mtd2: 0064631c 00010000 &quot;rootfs&quot;
mtd3: 003b0000 00010000 &quot;rootfs_data&quot;
mtd4: 00010000 00010000 &quot;art&quot;
mtd5: 007d0000 00010000 &quot;firmware&quot;</pre>

<p>
You would normally expect WiFi MAC addresses in the art partition. To check for that, use hexdump on the corresponding mtd4:
</p>
<pre class="code">$ hexdump -C /dev/mtd4</pre>

<p>
This will dump the whole partition to your console. Now you can look for addresses there: Take one byte of the vendor part of the address (first three bytes) and do text search ...
</p>

<p>
The same should be done for other partitions. Usual suspects are:
</p>
<ul>
<li class="level1"><div class="li"> factory</div>
</li>
<li class="level1"><div class="li"> mac</div>
</li>
<li class="level1"><div class="li"> config</div>
</li>
<li class="level1"><div class="li"> art</div>
</li>
<li class="level1"><div class="li"> u-boot</div>
</li>
</ul>

<p>
If you are successful, you will have a list of addresses and locations, e.g.
</p>
<pre class="code">factory 0xe000 *:0A
factory 0xe006 *:0B
art 0x4 *:0A</pre>

<p>
You can check your data by using OpenWrt&#039;s get_mac_binary command (based on mtdX):
</p>
<pre class="code">. /lib/functions/system.sh
get_mac_binary /dev/mtd4 0x4</pre>

<p>
or by using mtd_get_mac_binary (based on partition label):
</p>
<pre class="code">. /lib/functions/system.sh
mtd_get_mac_binary art 0x4</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Find out about flash locations&quot;,&quot;hid&quot;:&quot;find_out_about_flash_locations&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:3,&quot;range&quot;:&quot;416-1785&quot;} -->
<h2 class="sectionedit4" id="merge_your_data">Merge your data</h2>
<div class="level2">

<p>
Now, combine data from stock firmware and your research to have a complete list:
</p>
<pre class="code">LAN *:0a factory 0xe000
WAN *:0b factory 0xe006
5 GHz *:0a art 0x4
2.4 Ghz *:0c calculated from art 0x4 + 2</pre>

<p>
You could also include this list in your commit message to preserve the information.
</p>

<p>
As in the example, it is possible that the same address is present in different locations. In this case, use the location that “belongs” to the interface, i.e. art for WiFi, others for ethernet.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Merge your data&quot;,&quot;hid&quot;:&quot;merge_your_data&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:4,&quot;range&quot;:&quot;1786-2303&quot;} -->
<h2 class="sectionedit5" id="set_mac_addresses">Set MAC addresses</h2>
<div class="level2">

<p>
TBD: mtd_mac_address, 02_network, ...
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Set MAC addresses&quot;,&quot;hid&quot;:&quot;set_mac_addresses&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:5,&quot;range&quot;:&quot;2304-2374&quot;} -->
<h3 class="sectionedit6" id="mac_address_pulled_by_driver">MAC address pulled by driver</h3>
<div class="level3">

<p>
In several cases, the MAC address is already provided at the correct location for the driver to use it automatically.
</p>

<p>
<em>(This list is incomplete. Please extend it.)</em>
</p>

<p>
Known cases:
</p>
<ul>
<li class="level1"><div class="li"> ath79: <strong>mtd-cal-data</strong>: The MAC address will be read from start +2</div>
</li>
<li class="level1"><div class="li"> ramips: <strong>mediatek,mtd-eeprom/ralink,mtd-eeprom</strong>: The MAC address will be read from start +4</div>
</li>
<li class="level1"><div class="li"> <strong>ath9k</strong>: offset + 2 (mostly)</div>
</li>
<li class="level1"><div class="li"> <strong>ath10k</strong>: offset + 6</div>
</li>
</ul>

<p>
So, if you have MAC location matching those, you do not have to specify the MAC address in DTS or base-files for the particular interface.
</p>

<p>
Correct:
</p>
<pre class="code">&amp;wmac {
	status = &quot;okay&quot;;

	mtd-cal-data = &lt;&amp;art 0x1000&gt;;
};</pre>

<p>
Suboptimal (not precisely wrong):
</p>
<pre class="code">&amp;wmac {
	status = &quot;okay&quot;;

	mtd-cal-data = &lt;&amp;art 0x1000&gt;;
	mtd-mac-address = &lt;&amp;art 0x1002&gt;;
};</pre>

<p>
This can also be exploited for setting the label MAC address (see below) via 02_network.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;MAC address pulled by driver&quot;,&quot;hid&quot;:&quot;mac_address_pulled_by_driver&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:6,&quot;range&quot;:&quot;2375-3290&quot;} -->
<h2 class="sectionedit7" id="label_mac_address">Label MAC address</h2>
<div class="level2">

<p>
refs:
<a href="https://github.com/openwrt/openwrt/pull/2159" class="urlextern" title="https://github.com/openwrt/openwrt/pull/2159" rel="ugc nofollow">https://github.com/openwrt/openwrt/pull/2159</a>
<a href="https://github.com/openwrt/openwrt/pull/2253" class="urlextern" title="https://github.com/openwrt/openwrt/pull/2253" rel="ugc nofollow">https://github.com/openwrt/openwrt/pull/2253</a>
</p>

<p>
Many devices bear a label with one or several MAC addresses on it. Those may be used to identify the device in the network and thus represent a valuable additional information about the device.
</p>

<p>
When adding device support, you should also check which of the interface addresses corresponds to address on the label. If we assume the label MAC address ends with <code>0a</code>, we could assign either <abbr title="Local Area Network">LAN</abbr> or 5 <abbr title="Gigahertz">GHz</abbr> to it. The choice for an ambiguous address is arbitrary, so let&#039;s choose 5 <abbr title="Gigahertz">GHz</abbr>.
</p>

<p>
There are two options to specify the label MAC address in OpenWrt:
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Label MAC address&quot;,&quot;hid&quot;:&quot;label_mac_address&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:7,&quot;range&quot;:&quot;3291-3972&quot;} -->
<h3 class="sectionedit8" id="label-mac-device_dts_file">label-mac-device DTS file</h3>
<div class="level3">

<p>
We can refer to the device bearing the label MAC address in DTS. For that purpose, one needs to reference the node with an alias, e.g.
</p>
<pre class="code">aliases {
	label-mac-device = &amp;wifi0;
}</pre>

<p>
Obviously, this is only valid if the 5 <abbr title="Gigahertz">GHz</abbr> Wifi device tree node actually has been named wifi0.
</p>

<p>
<em>Attention: Not all interface can be referenced this way. To check whether there actually is a usable MAC address, check the device tree on your router:</em>
</p>

<p>
Run
</p>
<pre class="code">find /proc/device-tree/ -name &quot;*mac-address&quot;</pre>

<p>
on your device.
</p>

<p>
<em>Attention: This will only work if you have already set up MAC addresses correctly based on the information retrieved above.</em>
</p>

<p>
It will give you a list like the following:
</p>
<pre class="code">/proc/device-tree/ahb/eth@1a000000/mac-address
/proc/device-tree/ahb/eth@1a000000/mtd-mac-address
/proc/device-tree/ahb/eth@19000000/mac-address
/proc/device-tree/ahb/eth@19000000/mtd-mac-address
/proc/device-tree/ahb/apb/wmac@18100000/mac-address
/proc/device-tree/ahb/apb/wmac@18100000/mtd-mac-address</pre>

<p>
For each of the returned paths (if there are any), retrieve the mac-address, e.g.
</p>
<pre class="code">. /lib/functions/system.sh
get_mac_binary &quot;/proc/device-tree/ahb/eth@1a000000/mac-address&quot; 0</pre>

<p>
Valid choices are only <code>mac-address</code> or <code>local-mac-address</code>. There may be one, two or no paths giving the correct address.
</p>

<p>
If you find the label MAC address here, check your DTS for the corresponding parent node. The correct node for <code>/proc/device-tree/ahb/apb/wmac@18100000/mac-address</code> would be <code>/ahb/apb/wmac@18100000</code>. Use this node&#039;s alias or add a reasonable one yourself if missing.
</p>

<p>
<em>Attention: Note that label MAC addresses are assigned relatively randomly by vendors, so label-mac-device should be regularly put into DTS files or DTSIs with few users, so it is not inherited by accident.</em>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;label-mac-device DTS file&quot;,&quot;hid&quot;:&quot;label-mac-device_dts_file&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:8,&quot;range&quot;:&quot;3973-5826&quot;} -->
<h3 class="sectionedit9" id="set_label_mac_address_via_02_network">Set label MAC address via 02_network</h3>
<div class="level3">

<p>
If device tree does not lead to the relevant MAC address, we can still set it in 02_network. In this case, you need to set label_mac in a similar way as it is already used for lan_mac and wan_mac, e.g.
</p>
<pre class="code">cudy,wr1000)
	wan_mac=$(mtd_get_mac_binary factory 0x2e)
	label_mac=$(mtd_get_mac_binary factory 0x4) # e.g. on ramips when caldata is read from factory 0x0

belkin,f9k1109v1)
	wan_mac=$(mtd_get_mac_ascii uboot-env HW_WAN_MAC)
	lan_mac=$(mtd_get_mac_ascii uboot-env HW_LAN_MAC)
	label_mac=$wan_mac</pre>

<p>
This is evaluated below by the line
</p>
<pre class="code">[ -n &quot;$label_mac&quot; ] &amp;&amp; ucidef_set_label_macaddr $label_mac</pre>

<p>
If possible, setting the address with the DTS approach is preferred.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Set label MAC address via 02_network&quot;,&quot;hid&quot;:&quot;set_label_mac_address_via_02_network&quot;,&quot;codeblockOffset&quot;:13,&quot;secid&quot;:9,&quot;range&quot;:&quot;5827-6569&quot;} -->
<h3 class="sectionedit10" id="using_the_label_mac_address">Using the label MAC address</h3>
<div class="level3">

<p>
When everything is set up correctly, the label MAC address can be accessed with:
</p>
<pre class="code">. /lib/functions.sh
. /lib/functions/system.sh
label_mac_addr=$(get_mac_label)</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Using the label MAC address&quot;,&quot;hid&quot;:&quot;using_the_label_mac_address&quot;,&quot;codeblockOffset&quot;:15,&quot;secid&quot;:10,&quot;range&quot;:&quot;6570-6784&quot;} -->
<h2 class="sectionedit11" id="common_mac_address_locations">Common MAC address locations</h2>
<div class="level2">

<p>
If there is an ART partition, WiFi MAC addresses are frequently/typically stored there.
</p>

<p>
ath79:
</p>
<ul>
<li class="level1"><div class="li"> All TP-LINK routers using old tp-link header (those using Device/tplink-Xm or Device/tplink-Xmlzma templates defined in target/linux/ath79/image/common-tplink.mk), store only one mac address in &lt;&amp;uboot 0x1fc00&gt;, which is the label mac address.</div>
</li>
</ul>

<p>
ramips:
For ramips, typical locations for ethernet addresses are as follows:
</p>
<ul>
<li class="level1"><div class="li"> mt7621: lan mac is at factory 0xe000 and wan mac at factory 0xe006. This is the default location for mt7621 boards in MTK&#039;s SDK.</div>
</li>
<li class="level1"><div class="li"> For mt7620/mt76x8 boards if there&#039;s a lan mac at 0x28 there may be a wan mac at 0x2e. (There&#039;s only one GMAC for these two chips so GMAC2_OFFSET defined above isn&#039;t used.)</div>
</li>
</ul>

<p>
<em>Attention: Those are </em>typical<em> addresses. Some vendors mix them, invert them, or even use completely different locations!</em>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Common MAC address locations&quot;,&quot;hid&quot;:&quot;common_mac_address_locations&quot;,&quot;codeblockOffset&quot;:16,&quot;secid&quot;:11,&quot;range&quot;:&quot;6785-&quot;} -->