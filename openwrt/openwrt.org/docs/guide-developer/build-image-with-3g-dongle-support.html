
<h1 class="sectionedit1" id="building_image_with_support_for_3g4g_and_usb_tethering">Building image with support for 3g/4g and usb tethering</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Building image with support for 3g\/4g and usb tethering&quot;,&quot;hid&quot;:&quot;building_image_with_support_for_3g4g_and_usb_tethering&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-72&quot;} -->
<h2 class="sectionedit2" id="preparing_build_environment">Preparing build environment</h2>
<div class="level2">

<p>
First of all, you need a complete build environment, either physical or virtual system, as described on the <a href="/docs/guide-developer/start" class="wikilink1" title="docs:guide-developer:start" data-wiki-id="docs:guide-developer:start">OpenWrt developer guide</a>.
</p>

<p>
You need to clone OpenWrt git repository on your build system and synchronize all package feeds with your config file.
</p>

<p>
Be sure to understand the <a href="/docs/guide-user/additional-software/imagebuilder" class="wikilink1" title="docs:guide-user:additional-software:imagebuilder" data-wiki-id="docs:guide-user:additional-software:imagebuilder">build procedure</a> to prevent build failure.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Preparing build environment&quot;,&quot;hid&quot;:&quot;preparing_build_environment&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;73-520&quot;} -->
<h2 class="sectionedit3" id="configuring_packages">Configuring packages</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuring packages&quot;,&quot;hid&quot;:&quot;configuring_packages&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;521-554&quot;} -->
<h3 class="sectionedit4" id="selecting_target_architecture_and_profile">Selecting target architecture and profile</h3>
<div class="level3">

<p>
Run <code>make menuconfig</code>.
</p>

<p>
Select your architecture on which you would put your compiled OpenWrt image. Then select your target profile, according your hardware type.
</p>

<p>
If you have selected correct value for target system, target profile, and target images, go to next step.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Selecting target architecture and profile&quot;,&quot;hid&quot;:&quot;selecting_target_architecture_and_profile&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;555-882&quot;} -->
<h3 class="sectionedit5" id="selecting_kernel_modules_for_usb_networking_support">Selecting kernel modules for usb networking support.</h3>
<div class="level3">

<p>
Go to <code>Kernel Modules → USB Support</code>.
</p>

<p>
Select the following modules by pressing <code>y</code> to include the modules within the compiled image.
</p>
<pre class="code">Kernel Modules -&gt; USB Support
&lt;*&gt; kmod-usb2
&lt;*&gt; kmod-usb-ohci
&lt;*&gt; kmod-usb-uhci
&lt;*&gt; kmod-usb-acm # For ACM based modem, such as Nokia Phones
&lt;*&gt; kmod-usb-net # For tethering and rndis support</pre>

<p>
<strong>kmod-usb-net</strong> → to support usb networking interface.
</p>

<p>
Select all subsets if you want perfect support for usb network interfaces, including Android and iPhone tethering. Some newer 4g dongles use usb network interface (rndis) instead of legacy serial protocol. 
</p>
<pre class="code">&lt;*&gt; kmod-usb-net............... Kernel modules for USB-to-Ethernet convertors
  &lt;*&gt;   kmod-usb-net-asix...... Kernel module for USB-to-Ethernet Asix convertors  
  &lt;*&gt;   kmod-usb-net-cdc-eem..................... Support for CDC EEM connections  
  -*-   kmod-usb-net-cdc-ether.............. Support for cdc ethernet connections  
  &lt;*&gt;   kmod-usb-net-cdc-mbim..................... Kernel module for MBIM Devices  
  -*-   kmod-usb-net-cdc-ncm..................... Support for CDC NCM connections  
  &lt;*&gt;   kmod-usb-net-cdc-subset...... Support for CDC Ethernet subset connections  
  &lt;*&gt;   kmod-usb-net-dm9601-ether........ Support for DM9601 ethernet connections  
  &lt;*&gt;   kmod-usb-net-hso.. Kernel module for Option USB High Speed Mobile Devices  
  &lt;*&gt;   kmod-usb-net-ipheth..................... Apple iPhone USB Ethernet driver  
  &lt;*&gt;   kmod-usb-net-kalmia................... Samsung Kalmia based LTE USB modem  
  &lt;*&gt;   kmod-usb-net-kaweth.. Kernel module for USB-to-Ethernet Kaweth convertors  
  &lt;*&gt;   kmod-usb-net-mcs7830                                                       
  &lt;*&gt;   kmod-usb-net-pegasus                                                       
  &lt;*&gt;   kmod-usb-net-qmi-wwan.................................... QMI WWAN driver  
  &lt;*&gt;   kmod-usb-net-rndis......................... Support for RNDIS connections  
  &lt;*&gt;   kmod-usb-net-sierrawireless.......... Support for Sierra Wireless devices  
  &lt;*&gt;   kmod-usb-net-smsc95xx. SMSC LAN95XX based USB 2.0 10/100 ethernet devices
  </pre>

<p>
<strong>kmod-usb-serial</strong> → to support legacy 3g dongles.
</p>

<p>
Select all subsets to ensure that your dongle works. Most 3g dongles use the option driver or generic serial driver to work. Note that option driver has better capability of distinguishing between modem serial interfaces and storage interface than generic usb serial driver.
</p>
<pre class="code">&lt;*&gt; kmod-usb-serial..................... Support for USB-to-Serial converters    
  &lt;*&gt;   kmod-usb-serial-ark3116........ Support for ArkMicroChips ARK3116 devices  
  &lt;*&gt;   kmod-usb-serial-belkin........................ Support for Belkin devices  
  &lt;*&gt;   kmod-usb-serial-ch341.......................... Support for CH341 devices  
  &lt;*&gt;   kmod-usb-serial-cp210x........... Support for Silicon Labs cp210x devices  
  &lt;*&gt;   kmod-usb-serial-cypress-m8.............. Support for CypressM8 USB-Serial  
  &lt;*&gt;   kmod-usb-serial-ftdi............................ Support for FTDI devices  
  &lt;*&gt; kmod-usb-serial-ipw.................... Support for IPWireless 3G devices    
  &lt;*&gt; kmod-usb-serial-keyspan........ Support for Keyspan USB-to-Serial devices    
  &lt;*&gt; kmod-usb-serial-mct.............. Support for Magic Control Tech. devices    
  &lt;*&gt; kmod-usb-serial-mos7720.............. Support for Moschip MOS7720 devices    
  &lt;*&gt; kmod-usb-serial-motorola-phone............ Support for Motorola usb phone    
  &lt;*&gt; kmod-usb-serial-option................... Support for Option HSDPA modems    
  &lt;*&gt; kmod-usb-serial-oti6858...... Support for Ours Technology OTI6858 devices    
  &lt;*&gt; kmod-usb-serial-pl2303............... Support for Prolific PL2303 devices    
  &lt;*&gt; kmod-usb-serial-qualcomm................. Support for Qualcomm USB serial    
  &lt;*&gt; kmod-usb-serial-sierrawireless....... Support for Sierra Wireless devices    
  &lt;*&gt; kmod-usb-serial-ti-usb...................... Support for TI USB 3410/5052    
  &lt;*&gt; kmod-usb-serial-visor............... Support for Handspring Visor devices    
  -*- kmod-usb-serial-wwan..................... Support for GSM and CDMA modems
  </pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Selecting kernel modules for usb networking support.&quot;,&quot;hid&quot;:&quot;selecting_kernel_modules_for_usb_networking_support&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;883-5101&quot;} -->
<h3 class="sectionedit6" id="additional_packages_required_for_3g_functionality">Additional packages required for 3g functionality</h3>
<div class="level3">

</div>

<h4 id="ppp_chat_and_uqmi">ppp, chat, and uqmi</h4>
<div class="level4">

<p>
Go to <code>Network</code> section. Select `uqmi` to support qmi interface and `ppp` to support standard point-to-point protocol. <code>chat</code> is needed to establish serial communication to prepare PPP link negotiation.
</p>
<pre class="code">Network
  &lt;*&gt;chat
  &lt;*&gt;ppp
  &lt;*&gt;uqmi</pre>

</div>

<h4 id="mbim">mbim</h4>
<div class="level4">

<p>
Some dongles are using mbim protocol. To make use of mbim protocol, install <code>umbim</code> package.
</p>
<pre class="code">Network
  &lt;*&gt;umbim</pre>

</div>

<h4 id="comgt_and_usb-modeswitch">comgt and usb-modeswitch</h4>
<div class="level4">

<p>
Go to <code>Utilities</code> section. Select <code>comgt</code> to provide control over 3g interface and <code>usb-modeswitch</code> to provide mode switching between virtual cd-rom interface to serial interface.
</p>
<pre class="code">Utilities
  &lt;*&gt;comgt
  &lt;*&gt;usb-modeswitch</pre>

</div>

<h4 id="minicom_picocom_and_screen">minicom, picocom, and screen</h4>
<div class="level4">

<p>
If you want to debug serial communication, you may want to install serial terminal. There are several choices of serial terminal, such as minicom, picocom, and screen. I recommend <code>picocom</code> because of its small size.
</p>
<pre class="code">Utilities --&gt; Terminal
  &lt;*&gt;picocom</pre>

<p>
Screen can be used as persistent session manager. Minicom has a nice interface, optimized for serial communication.
</p>
<pre class="code">Utilities
  &lt; &gt;screen
Utilities --&gt; Terminal
  &lt; &gt;minicom</pre>

<p>
For devices with 4MB flash, <code>picocom</code> is the only serial terminal that can be installed.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Additional packages required for 3g functionality&quot;,&quot;hid&quot;:&quot;additional_packages_required_for_3g_functionality&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:6,&quot;range&quot;:&quot;5102-6458&quot;} -->
<h3 class="sectionedit7" id="web_interface_support">Web Interface Support</h3>
<div class="level3">

<p>
If you want to control your 3g dongle with Luci web interface, go to Luci.
</p>
<pre class="code">Luci
1. Collections
  &lt;*&gt; luci
3. Applications
  &lt;*&gt; luci-app-multiwan (optional to support multiple 3g dongles)
  &lt;*&gt; luci-app-qos (optional to provide QOS support)
6. Protocols
  &lt;*&gt; luci-proto-3g
  -*- luci-proto-ppp</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Web Interface Support&quot;,&quot;hid&quot;:&quot;web_interface_support&quot;,&quot;codeblockOffset&quot;:8,&quot;secid&quot;:7,&quot;range&quot;:&quot;6459-6802&quot;} -->
<h2 class="sectionedit8" id="build_process">Build process</h2>
<div class="level2">

<p>
Continue selecting packages as needed. When you are done, run the build process
</p>
<pre class="code">time make V=s download &amp;&amp;
time make V=s</pre>

<p>
Faster build time can be achieved by enabling multiple build jobs. In case of quad-core cpu.
</p>
<pre class="code">time make -j8 V=s</pre>

<p>
If build process is successful, your firmware images will be located on <code>bin/target-platform/</code>.
</p>

<p>
If your hardware-specific image name could not be found, it&#039;s possible that you added too many packages that don&#039;t fit your hardware flash memory. Try reducing packages and restart the build process if such case happens.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Build process&quot;,&quot;hid&quot;:&quot;build_process&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:8,&quot;range&quot;:&quot;6803-&quot;} -->