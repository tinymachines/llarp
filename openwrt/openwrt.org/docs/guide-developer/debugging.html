
<h1 class="sectionedit1" id="debugging">Debugging</h1>
<div class="level1">

<p>
Debugging hardware can be tricky especially when doing kernel and drivers development. It might become handy for you to add serial console to your device as well as using JTAG to debug your code.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Debugging&quot;,&quot;hid&quot;:&quot;debugging&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-221&quot;} -->
<h2 class="sectionedit2" id="serial_port">Serial Port</h2>
<div class="level2">

<p>
→ <a href="/docs/techref/hardware/port.serial" class="wikilink1" title="docs:techref:hardware:port.serial" data-wiki-id="docs:techref:hardware:port.serial">port.serial</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Serial Port&quot;,&quot;hid&quot;:&quot;serial_port&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;222-287&quot;} -->
<h2 class="sectionedit3" id="jtag">JTAG</h2>
<div class="level2">

<p>
→ <a href="/docs/techref/hardware/port.jtag" class="wikilink1" title="docs:techref:hardware:port.jtag" data-wiki-id="docs:techref:hardware:port.jtag">port.jtag</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;JTAG&quot;,&quot;hid&quot;:&quot;jtag&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;288-344&quot;} -->
<h2 class="sectionedit4" id="gdb">GDB</h2>
<div class="level2">

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> → <a href="/docs/guide-developer/gdb" class="wikilink1" title="docs:guide-developer:gdb" data-wiki-id="docs:guide-developer:gdb">gdb</a> a very short introduction on the GNU Debugger
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;GDB&quot;,&quot;hid&quot;:&quot;gdb&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;345-443&quot;} -->
<h2 class="sectionedit5" id="perfoprofile_cpu_profiling">perf/oprofile cpu profiling</h2>
<div class="level2">

<p>
→ <a href="http://false.ekta.is/2012/11/cpu-profiling-applications-on-openwrt-with-perf-or-oprofile/" class="urlextern" title="http://false.ekta.is/2012/11/cpu-profiling-applications-on-openwrt-with-perf-or-oprofile/" rel="ugc nofollow">http://false.ekta.is/2012/11/cpu-profiling-applications-on-openwrt-with-perf-or-oprofile/</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;perf\/oprofile cpu profiling&quot;,&quot;hid&quot;:&quot;perfoprofile_cpu_profiling&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;444-577&quot;} -->
<h2 class="sectionedit6" id="wireless">Wireless</h2>
<div class="level2">

<p>
When encountering wireless bugs, such as connection drop or wpa rekeying issues, it is possible to remotely run <code>tcpdump</code> in order to capture wireless management traffic for later analysis of the communication leading to the problem.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Wireless&quot;,&quot;hid&quot;:&quot;wireless&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;578-835&quot;} -->
<h3 class="sectionedit7" id="capture_management_traffic">Capture Management Traffic</h3>
<div class="level3">

<p>
The command below will spawn a monitor interface with a mac80211 based driver, start <code>tcpdump</code> and save the captured data locally into <code>/tmp</code>:
</p>
<pre class="code bash"><span class="kw2">ssh</span> root<span class="sy0">@</span>192.168.1.1 <span class="st_h">'grep -q mon0 /proc/net/dev || /usr/sbin/iw phy phy0 interface add mon0 type monitor;
    /sbin/ifconfig mon0 up; /usr/sbin/tcpdump -s 0 -i mon0 -y IEEE802_11_RADIO -w -'</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>wifi.pcap</pre>

<p>
A smaller alternative to <code>tcpdump</code> is the <code>iwcap</code> utility. Its MIPS binary only ~5KB large and it does not require <code>libpcap</code> to function.
It also supports the filtering of data frames through the <code>-D</code> switch to cut down the amount of captured traffic;
</p>
<pre class="code bash"><span class="kw2">ssh</span> root<span class="sy0">@</span>192.168.1.1 <span class="st_h">'grep -q mon0 /proc/net/dev || /usr/sbin/iw phy phy0 interface add mon0 type monitor;
    /sbin/ifconfig mon0 up; /usr/sbin/iwcap -i mon0 -s'</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>wifi.pcap</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Capture Management Traffic&quot;,&quot;hid&quot;:&quot;capture_management_traffic&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;836-1712&quot;} -->
<h3 class="sectionedit8" id="logging_hostapd_behaviour">Logging hostapd behaviour</h3>
<div class="level3">

<p>
Note that recent versions of openwrt ship with a version of hostapd which has verbose debug messages disabled in order to save on space (see <a href="https://dev.openwrt.org/ticket/15658" class="urlextern" title="https://dev.openwrt.org/ticket/15658" rel="ugc nofollow">https://dev.openwrt.org/ticket/15658</a> ).
</p>

<p>
<del>To enable debug you need to install the debug build of hostapd from the packages for your router (package name hostapd), having first removed the cut-down version:

&lt;code bash&gt;
opkg remove wpad-mini
[download the wpad-debug package for your router to /tmp]
opkg install /tmp/wpad-debug*.ipk
&lt;/code&gt;
</del>
</p>

<p>
Increase the log level for hostapd:
</p>
<pre class="code"># Levels (minimum value for logged events):
#  0 = verbose debugging
#  1 = debugging
#  2 = informational messages
#  3 = notification
#  4 = warning&quot;</pre>

<p>
... the default is “informational messages”.  The example below shows you how to change this to “debugging”.
</p>

<p>
Check the log level currently being used:
</p>
<pre class="code bash"><span class="co4">root@OpenWrt:~# </span><span class="kw2">ps</span> <span class="sy0">|</span> <span class="kw2">grep</span> hostapd
 <span class="nu0">6948</span> root      <span class="nu0">1784</span> S    <span class="sy0">/</span>usr<span class="sy0">/</span>sbin<span class="sy0">/</span>hostapd <span class="re5">-P</span> <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>wifi-phy1.pid <span class="re5">-B</span> <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>hostapd-phy1.conf
 <span class="nu0">6987</span> root      <span class="nu0">1784</span> S    <span class="sy0">/</span>usr<span class="sy0">/</span>sbin<span class="sy0">/</span>hostapd <span class="re5">-P</span> <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>wifi-phy0.pid <span class="re5">-B</span> <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>hostapd-phy0.conf
 <span class="nu0">7019</span> root      <span class="nu0">1448</span> S    <span class="kw2">grep</span> hostapd</pre>

<p>
let say for the sake of argument you&#039;re only interested in addressing a problem with the phy0 hostapd.  First check the current level for this hostapd:
</p>
<pre class="code bash"><span class="co4">root@OpenWrt:~# </span><span class="kw2">grep</span> _level <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>hostapd-phy0.conf 
<span class="re2">logger_syslog_level</span>=<span class="nu0">2</span>
<span class="re2">logger_stdout_level</span>=<span class="nu0">2</span></pre>

<p>
... log level 2 is selected.  Let&#039;s change this:
</p>
<pre class="code bash"><span class="co4">root@OpenWrt:~# </span>uci <span class="kw1">set</span> wireless.radio0.log_level=<span class="nu0">1</span>
<span class="co4">root@OpenWrt:~# </span>uci commit wireless
<span class="co4">root@OpenWrt:~# </span>wifi up
<span class="co4">root@OpenWrt:~# </span><span class="kw2">grep</span> _level <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>hostapd-phy0.conf 
<span class="re2">logger_syslog_level</span>=<span class="nu0">1</span>
<span class="re2">logger_stdout_level</span>=<span class="nu0">1</span></pre>

<p>
... and we can see that the level has been changed.  The logread command will now show brief debug messages like those below:
</p>
<pre class="code bash">Tue Apr <span class="nu0">22</span> <span class="nu0">11</span>:<span class="nu0">35</span>:<span class="nu0">41</span> <span class="nu0">2014</span> daemon.debug hostapd: wlan0: STA <span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span> MLME: MLME-REASSOCIATE.indication<span class="br0">&#40;</span><span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span><span class="br0">&#41;</span>
Tue Apr <span class="nu0">22</span> <span class="nu0">11</span>:<span class="nu0">35</span>:<span class="nu0">41</span> <span class="nu0">2014</span> daemon.debug hostapd: wlan0: STA <span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span> MLME: MLME-DELETEKEYS.request<span class="br0">&#40;</span><span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span><span class="br0">&#41;</span>
Tue Apr <span class="nu0">22</span> <span class="nu0">11</span>:<span class="nu0">35</span>:<span class="nu0">41</span> <span class="nu0">2014</span> daemon.debug hostapd: wlan0: STA <span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span> WPA: event <span class="nu0">1</span> notification
Tue Apr <span class="nu0">22</span> <span class="nu0">11</span>:<span class="nu0">35</span>:<span class="nu0">41</span> <span class="nu0">2014</span> daemon.debug hostapd: wlan0: STA <span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span> WPA: start authentication
Tue Apr <span class="nu0">22</span> <span class="nu0">11</span>:<span class="nu0">35</span>:<span class="nu0">41</span> <span class="nu0">2014</span> daemon.debug hostapd: wlan0: STA <span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span> IEEE 802.1X: unauthorizing port
Tue Apr <span class="nu0">22</span> <span class="nu0">11</span>:<span class="nu0">35</span>:<span class="nu0">41</span> <span class="nu0">2014</span> daemon.debug hostapd: wlan0: STA <span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span> WPA: sending <span class="nu0">1</span><span class="sy0">/</span><span class="nu0">4</span> msg of <span class="nu0">4</span>-Way Handshake
Tue Apr <span class="nu0">22</span> <span class="nu0">11</span>:<span class="nu0">35</span>:<span class="nu0">41</span> <span class="nu0">2014</span> daemon.debug hostapd: wlan0: STA <span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span> WPA: received EAPOL-Key frame <span class="br0">&#40;</span><span class="nu0">2</span><span class="sy0">/</span><span class="nu0">4</span> Pairwise<span class="br0">&#41;</span>
Tue Apr <span class="nu0">22</span> <span class="nu0">11</span>:<span class="nu0">35</span>:<span class="nu0">41</span> <span class="nu0">2014</span> daemon.debug hostapd: wlan0: STA <span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span> WPA: sending <span class="nu0">3</span><span class="sy0">/</span><span class="nu0">4</span> msg of <span class="nu0">4</span>-Way Handshake
Tue Apr <span class="nu0">22</span> <span class="nu0">11</span>:<span class="nu0">35</span>:<span class="nu0">41</span> <span class="nu0">2014</span> daemon.debug hostapd: wlan0: STA <span class="nu0">20</span>:<span class="nu0">16</span>:d8:db:aa:<span class="nu0">56</span> WPA: received EAPOL-Key frame <span class="br0">&#40;</span><span class="nu0">4</span><span class="sy0">/</span><span class="nu0">4</span> Pairwise<span class="br0">&#41;</span></pre>

<p>
... you may want to then setup remote logging via syslog to another computer by setting a logfile (warning - this won&#039;t be auto-rotated, so make sure it doesn&#039;t fill up a vital filesystem).
</p>
<pre class="code bash">uci <span class="kw1">set</span> system.<span class="sy0">@</span>system<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.log_file=<span class="br0">&#91;</span>path-to-my-logfile<span class="br0">&#93;</span>
uci commit
<span class="br0">&#91;</span>reboot required<span class="br0">&#93;</span></pre>

<p>
or alternatively, if you&#039;re able to, it might be better to use system.@system[0].log_ip to log to a remote machine (which must be running an appropriate listener e.g. rsyslogd - see <a href="https://forum.openwrt.org/viewtopic.php?id=11912" class="urlextern" title="https://forum.openwrt.org/viewtopic.php?id=11912" rel="ugc nofollow">https://forum.openwrt.org/viewtopic.php?id=11912</a>).
</p>

<p>
If you wish to debug on the command line instead, you may be able to do-so using a command like this:
</p>
<pre class="code bash"><span class="kw3">kill</span> <span class="sy0">`</span><span class="kw2">cat</span> <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>wifi-phy0.pid<span class="sy0">`</span> ; <span class="sy0">/</span>usr<span class="sy0">/</span>sbin<span class="sy0">/</span>hostapd <span class="re5">-dd</span> <span class="re5">-P</span> <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>wifi-phy0.pid  <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>hostapd-phy0.conf</pre>

<p>
... use the output of ps above to create the necessary commandline - remove the &#039;-B&#039; argument to stop hostapd forking into the background, and add &#039;-dd&#039; to verbose debug to stdout.
</p>

<p>
depending on your hardware and interface state, it may be necessary to create or re-create the relevant wlan device before starting hostapd e.g.
</p>
<pre class="code bash">iw dev wlan0 del
iw phy phy0 interface add wlan0 <span class="kw3">type</span> managed</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Logging hostapd behaviour&quot;,&quot;hid&quot;:&quot;logging_hostapd_behaviour&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:8,&quot;range&quot;:&quot;1713-5818&quot;} -->
<h2 class="sectionedit9" id="add_and_modify_compiler_debug_flags">Add and modify compiler debug flags</h2>
<div class="level2">

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> The “Compile with debug” entry in advanced developer menu enables “-g3” compile option.
</p>

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> You have to disable _sstrip_ to keep debug information.
</p>

<p>
Note, if you just want to build a single package unstripped, try, “make package/foo/compile STRIP=true”
Also, unstripped binaries are placed in “staging_dir/target-*/root-*/” where your host side tools can use them.  (Remember, gdbserver can attach to the stripped binary, while gdb loads the unstripped binary)
see <a href="/docs/guide-developer/gdb" class="wikilink1" title="docs:guide-developer:gdb" data-wiki-id="docs:guide-developer:gdb">gdb</a>
</p>

<p>
Alternatively: You can add or modify “Custom Target Options” like add “-g3 -ggdb3”
</p>

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> Be aware there are default compiler options defined in include/target.mk for example (“-Os -pipe”)
</p>

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> Some packets might overwrite or not use the flags. Check your compile log.
</p>

<p>
Additional tips:
</p>
<ul>
<li class="level1"><div class="li"> check with different gcc versions</div>
</li>
<li class="level1"><div class="li"> There is “-O0” to disable compiler optimizations.</div>
</li>
<li class="level1"><div class="li"> “-Wall -Wextra” might provide useful warnings</div>
</li>
<li class="level1"><div class="li"> see <a href="https://gcc.gnu.org/bugs/" class="urlextern" title="https://gcc.gnu.org/bugs/" rel="ugc nofollow">https://gcc.gnu.org/bugs/</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Add and modify compiler debug flags&quot;,&quot;hid&quot;:&quot;add_and_modify_compiler_debug_flags&quot;,&quot;codeblockOffset&quot;:10,&quot;secid&quot;:9,&quot;range&quot;:&quot;5819-&quot;} -->