
<h1 class="sectionedit1" id="create_meson-based_packages_in_openwrt">Create Meson-based packages in OpenWrt</h1>
<div class="level1">

<p>
This tutorial provides a step-by-step guide to creating and installing meson-based packages in OpenWrt. We assume that the source code is local, but the process is the same for other cases such as Git, SVN, etc.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Create Meson-based packages in OpenWrt&quot;,&quot;hid&quot;:&quot;create_meson-based_packages_in_openwrt&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-265&quot;} -->
<h2 class="sectionedit2" id="general_instructions_in_building_packages">General instructions in building packages</h2>
<div class="level2">

<p>
The <code>include</code> directory in OpenWrt contains information about the build system for different types of packages. Here, For example, <code>meson.mk</code> in the <code>include</code> directory provides useful insights:
</p>
<pre class="code bash"><span class="co0"># To build your package using meson:</span>
<span class="co0">#</span>
<span class="co0"># include $(INCLUDE_DIR)/meson.mk</span>
<span class="co0"># MESON_ARGS+=-Dfoo -Dbar=baz</span>
<span class="co0">#</span>
<span class="co0"># To pass additional environment variables to meson:</span>
<span class="co0">#</span>
<span class="co0"># MESON_VARS+=FOO=bar</span>
<span class="co0">#</span>
.
.
.
<span class="co0">#</span>
<span class="co0"># same for Build/Compile and Build/Install</span>
<span class="co0">#</span>
<span class="co0"># Host packages are built in the same fashion, just use these vars instead:</span>
<span class="co0">#</span>
<span class="co0"># MESON_HOST_ARGS+=-Dfoo -Dbar=baz</span>
<span class="co0"># MESON_HOST_VARS+=FOO=bar</span></pre>

<p>
To create a Meson package for OpenWrt, we need to perform a few steps. Firstly, we should include <code>$(INCLUDE_DIR)/meson.mk</code> in the <code>Makefile</code>, which will enable us to use Meson build system within the OpenWRT environment. Secondly, we can pass Meson arguments to specify various configuration options by using the <code>MESON_ARGS+=&lt;arg&gt;</code> syntax. This is especially useful when we want to customize build settings, such as choosing a specific compiler or setting optimization flags. Additionally, we can also pass environmental variables to Meson by using <code>MESON_VARS</code>. This allows us to define environment-specific settings or pass additional information to the build system. By following these steps, we can create a robust and flexible Meson package for OpenWRT that meets our specific requirements.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;General instructions in building packages&quot;,&quot;hid&quot;:&quot;general_instructions_in_building_packages&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;266-1725&quot;} -->
<h2 class="sectionedit3" id="a_simple_meson_package">A simple Meson package</h2>
<div class="level2">

<p>
Meson is a build system that is designed to optimize and simplify the process of building software. By creating a Meson package, we can take advantage of this build system to automate the process of building and installing our software package.
To begin with, we will be creating a single Meson package. This package will be located in the directory path <code>/media/workspace/packages/mesonsexmpl/</code>. 
</p>
<pre class="code bash"><span class="kw2">mkdir</span> <span class="sy0">/</span>media<span class="sy0">/</span>workspace<span class="sy0">/</span>packages<span class="sy0">/</span>mesonsexmpl<span class="sy0">/</span>helloworld
<span class="kw3">cd</span> <span class="sy0">/</span>media<span class="sy0">/</span>workspace<span class="sy0">/</span>packages<span class="sy0">/</span>mesonsexmpl<span class="sy0">/</span>helloworld</pre>

<p>
Next, we will create the required files. These files are <code>main.c</code> source file and <code>meson.build</code> configuration file.
</p>
<pre class="code bash"><span class="kw2">touch</span> main.c  meson.build</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;A simple Meson package&quot;,&quot;hid&quot;:&quot;a_simple_meson_package&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:3,&quot;range&quot;:&quot;1726-2453&quot;} -->
<h3 class="sectionedit4" id="mainc">main.c</h3>
<div class="level3">

<p>
To demonstrate a basic scenario, we will be populating the <code>main.c</code> file with a straightforward yet classic <code>“Hello World!”</code> message. 
</p>
<pre class="code c"><span class="co1">// main.c</span>
<span class="co2">#include &lt;stdio.h&gt;</span>
&nbsp;
<span class="kw4">int</span> main<span class="br0">&#40;</span><span class="kw4">int</span> argc<span class="sy0">,</span> <span class="kw4">char</span><span class="sy0">**</span> argv<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
	<a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span>“Hello World\n”<span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="kw1">return</span> <span class="nu0">0</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;main.c&quot;,&quot;hid&quot;:&quot;mainc&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:4,&quot;range&quot;:&quot;2454-2735&quot;} -->
<h3 class="sectionedit5" id="mesonbuild">meson.build</h3>
<div class="level3">

<p>
For the <code>meson.build</code> file, we use the simple build file provided by the meson tutorial:
</p>
<pre class="code cmake"><span class="co1"># meson.build</span>
<a href="http://www.cmake.org/cmake/help/cmake2.6docs.html#command:project"><span class="kw1">project</span></a><span class="sy0">(</span>'helloworld', 'c'<span class="sy0">)</span>
executable<span class="sy0">(</span>'helloworld', 'main.c'<span class="sy0">)</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;meson.build&quot;,&quot;hid&quot;:&quot;mesonbuild&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:5,&quot;range&quot;:&quot;2736-2947&quot;} -->
<h3 class="sectionedit6" id="makefile">Makefile</h3>
<div class="level3">

<p>
The <code>Makefile</code> plays a crucial role in our <code>helloworld</code> package, as it provides instructions for compiling and building the software. Without it, the program would not be able to run properly. To ensure that our <code>helloworld</code> package is functional, we have created a <code>Makefile</code> that outlines the necessary steps for building the program. You can find the <code>Makefile</code> below.
</p>
<pre class="code makefile">include $(TOPDIR)/rules.mk
include $(INCLUDE_DIR)/meson.mk
include $(INCLUDE_DIR)/package.mk
include $(INCLUDE_DIR)/nls.mk
# Name, version and release number
# The name and version of your package are used to define the variable to point to the build directory of your package: $(PKG_BUILD_DIR)
PKG_NAME:=helloworld
PKG_VERSION:=1.0
PKG_RELEASE:=1
&nbsp;
# Source settings (i.e. where to find the source codes)
# This is a custom variable, used below
SOURCE_DIR:=/media/workspace/packages/mesonsexmpl/helloworld/src
&nbsp;
&nbsp;
# Package definition; instructs on how and where our package will appear in the overall configuration menu ('make menuconfig')
define Package/helloworld
  SECTION:=examples
  CATEGORY:=Examples
  TITLE:=Hello, World!
endef
&nbsp;
# Package description; a more verbose description on what our package does
define Package/helloworld/description
  A simple &quot;Hello, world!&quot; -application.
endef
&nbsp;
define Package/helloworld/install
	$(INSTALL_DIR) $(1)/usr/bin/
	$(INSTALL_BIN)  $(PKG_BUILD_DIR)/openwrt-build/helloworld $(1)/usr/bin
&nbsp;
endef
&nbsp;
$(eval $(call BuildPackage,helloworld))</pre>

<p>
In order to incorporate our new package, we will need to make some changes to the <code>feeds.conf</code> file that is located at the root directory of OpenWrt source code . By making these modifications, we can ensure that our new package is successfully added and integrated into the system.
</p>
<pre class="code bash">src-link mesonpackages <span class="sy0">/</span>media<span class="sy0">/</span>workspace<span class="sy0">/</span>packages<span class="sy0">/</span>mesonsexmpl</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Makefile&quot;,&quot;hid&quot;:&quot;makefile&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:6,&quot;range&quot;:&quot;2948-4822&quot;} -->
<h3 class="sectionedit7" id="feedsconf">feeds.conf</h3>
<div class="level3">

<p>
Next, we need to update the package feed.
</p>
<pre class="code">./scripts/feeds update mesonpackages
./scripts/feeds install -a -p  mesonpackages</pre>

<p>
Once we have updated the necessary feeds, the next step is to select the correct package for building. To do this, we must open the configuration menu by typing <code>make menuconfig</code> in the command line. From there, we should look for the <code>helloworld</code> package and select it to proceed with the build process.
</p>

<p>
To finish building the package, we need to execute the build command. Running this command will compile all the necessary files and create the final package that can be used for deployment or distribution.
</p>
<pre class="code bash"><span class="kw2">make</span> package<span class="sy0">/</span>helloworld<span class="sy0">/</span>compile</pre>

<p>
If everything goes smoothly, the package that is built will be located in &#039;&#039;&lt;BIN_DIR&gt;/packages/&lt;target&gt;/mesonpackages/packages&#039;. For instance:
</p>
<pre class="code">helloworld_1.0-1_arm_cortex-a7_neon-vfpv4.ipk</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;feeds.conf&quot;,&quot;hid&quot;:&quot;feedsconf&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:7,&quot;range&quot;:&quot;4823-&quot;} -->