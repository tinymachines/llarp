
<h1 class="sectionedit1" id="generic_flashing_over_the_serial_port">Generic flashing over the Serial port</h1>
<div class="level1">

</div>

<h4 id="technical_references">Technical references</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> <a href="/docs/techref/hardware/port.serial" class="wikilink1" title="docs:techref:hardware:port.serial" data-wiki-id="docs:techref:hardware:port.serial">port.serial</a></div>
</li>
<li class="level1"><div class="li"> Platform <em>ar71xx</em> bootloader <em><a href="/docs/techref/bootloader/uboot" class="wikilink1" title="docs:techref:bootloader:uboot" data-wiki-id="docs:techref:bootloader:uboot">Das U-Boot</a></em>: <a href="/toh/tp-link/tl-wr1043nd#installation" class="wikilink1" title="toh:tp-link:tl-wr1043nd" data-wiki-id="toh:tp-link:tl-wr1043nd">TL-WR1043ND</a></div>
</li>
</ul>

</div>

<h4 id="actual_procedure">Actual procedure</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> first, launch a tftp server running on address <em>192.168.1.234</em>, serving the openwrt firmware file, renamed to <em>firm.bin</em></div>
</li>
</ul>
<pre class="code">mkdir -p /tmp/tftp/
cp openwrt-...-factory.bin /tmp/tftp/firm.bin

sudo ip addr add 192.168.1.234/24 dev eth0
sudo dnsmasq -d --port=0 --enable-tftp --tftp-root=/tmp/tftp/</pre>
<ul>
<li class="level1"><div class="li"> then, on another console, run a serial terminal program (e.g. screen or minicom) set to <strong>115200 8N1</strong>, no flow control</div>
</li>
</ul>
<pre class="code">screen /dev/ttyUSB0 115200</pre>
<ul>
<li class="level1"><div class="li"> finally, instruct the bootloader to transfer the <em>firm.bin</em> from the tftp server on your computer and save it to RAM memory (0x81000000); then erase <em>0x7c0000</em> bytes (7.75 MiB) from the flash (starting at 0xbf020000); finally copy the image stored in RAM to flash</div>
</li>
</ul>

<p>
<img src="/_media/meta/icons/tango/48px-dialog-warning.svg.png?w=20&amp;h=20&amp;tok=dc529c" class="media" loading="lazy" alt="" width="20" height="20" /> DO NOT USE THESE VALUES. FIND OUT THE RIGHT ONES! NO, NOT KIDDING.
</p>
<ul>
<li class="level1"><div class="li"> 0x7c0000: size of the firmware (be aware that you may have a different size thus bricking your router)</div>
</li>
<li class="level1 node"><div class="li"> in GNU-Linux <abbr title="Operating System">OS</abbr> distro <code>Terminal</code> window, find-out serial port list with below command<strong>:</strong></div>
<ul>
<li class="level2"><div class="li"> list all serial/TTY devices+ports<strong>:</strong> <code>ll /sys/class/tty</code></div>
</li>
<li class="level2"><div class="li"> list serial/TTY devices that have <em>device/driver</em> entry<strong>:</strong> <code>ll /sys/class/tty/*/device/driver</code></div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> in Windows <code>Command-Prompt</code> window, find-out serial port list with below command<strong>:</strong></div>
<ul>
<li class="level2"><div class="li"> list ports &amp; device names<strong>:</strong> <code>chgport</code></div>
</li>
<li class="level2"><div class="li"> list all serial ports<strong>:</strong> <code>reg query HKLM\HARDWARE\DEVICEMAP\SERIALCOMM</code></div>
</li>
<li class="level2"><div class="li"> list all CON (console), available COM &amp; LPT devices<strong>:</strong> <code>mode</code></div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> in macOS <code>Terminal</code> utility app/window, find-out serial port list with this command<strong>:</strong> <code>ls /dev/{tty,cu}.*</code></div>
</li>
</ul>

<p>
Commands:
</p>
<pre class="code">setenv serverip 192.168.1.234
tftpboot 0x81000000 firm.bin
erase 0xbf020000 +0x7c0000
cp.b 0x81000000 0xbf020000 0x7c0000
bootm 0xbf020000</pre>

<p>
To get a rough idea of the process, check <a href="/toh/tp-link/tl-wr1043nd/flashlog" class="wikilink1" title="toh:tp-link:tl-wr1043nd:flashlog" data-wiki-id="toh:tp-link:tl-wr1043nd:flashlog">an example serial console log during the whole procedure</a>
</p>

</div>

<h4 id="kermit">Kermit</h4>
<div class="level4">

<p>
You can use a client using the <a href="https://en.wikipedia.org/wiki/Kermit (protocol)" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Kermit (protocol)">Kermit (protocol)</a> to transfer the new image. It may take forever and a half (15-20min) to copy. But it&#039;s easier and more secure than running a <a href="/docs/guide-user/troubleshooting/tftpserver" class="wikilink1" title="docs:guide-user:troubleshooting:tftpserver" data-wiki-id="docs:guide-user:troubleshooting:tftpserver">tftpd server</a>. These instructions assume you&#039;re using a Linux system, but they will give you all you need to do the same on a Windows box.
</p>

<p>
Requirements:
</p>
<ul>
<li class="level1"><div class="li"> terminal program (e.g. minicom) set to <strong>115200 8N1</strong>, no flow control</div>
</li>
<li class="level1"><div class="li"> file named <em>code.bin</em> containing openwrt firmware.</div>
</li>
<li class="level1"><div class="li"> Kermit client (these instructions will involve using C-Kermit under Linux)</div>
</li>
</ul>

<p>
<img src="/_media/meta/icons/tango/48px-dialog-warning.svg.png?w=20&amp;h=20&amp;tok=dc529c" class="media" loading="lazy" alt="" width="20" height="20" /> DO NOT USE THESE VALUES. FIND OUT THE RIGHT ONES! NO, NOT KIDDING.
</p>
<pre class="code">erase 0xbf020000 +7c0000 # 7c0000: size of the firmware (be aware that you may have a different size thus bricking your router)
loadb 0x81000000</pre>

<p>
Fire up C-Kermit and run the following commands (or configure your Kermit client to these parameters):
</p>
<pre class="code">set line /dev/ttyUSB0 # Just make sure you got the right USB interface
set speed 115200
set carrier-watch off
set handshake none
set flow-control none
robust
set file type bin
set file name lit
set rec pack 1000
set send pack 1000
set window 5
send code.bin # Make sure you include a proper path to the file. That&#039;s why I just kept it in /home/$user</pre>

<p>
After the 15-20min file transfer, the new firmware should be on your router and you can continue in terminal:
</p>

<p>
<img src="/_media/meta/icons/tango/48px-dialog-warning.svg.png?w=20&amp;h=20&amp;tok=dc529c" class="media" loading="lazy" alt="" width="20" height="20" /> DO NOT USE THESE VALUES. FIND OUT THE RIGHT ONES! NO, NOT KIDDING.
</p>
<pre class="code">cp.b 0x81000000 0xbf020000 0x7c0000
bootm 0xbf020000</pre>

<p>
Note: This serial transfer method doesn&#039;t solve the “chicken or the egg” dilemma (if your Ethernet port is not working on U-Boot) because you cannot use tftpboot to transfer code.bin to u-boot. Fortunately U-Boot supports serial transfer using modem protocol: <a href="http://acassis.wordpress.com/2009/10/23/transfering-file-to-u-boot-over-serial/" class="urlextern" title="http://acassis.wordpress.com/2009/10/23/transfering-file-to-u-boot-over-serial/" rel="ugc nofollow">http://acassis.wordpress.com/2009/10/23/transfering-file-to-u-boot-over-serial/</a>
</p>

</div>
