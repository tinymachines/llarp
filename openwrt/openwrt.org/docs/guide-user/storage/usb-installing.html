
<h1 class="sectionedit1" id="installing_and_troubleshooting_usb_drivers">Installing and troubleshooting USB Drivers</h1>
<div class="level1">
<ol>
<li class="level1"><div class="li"> A <strong><a href="/docs/guide-user/storage/usb-drives-quickstart" class="wikilink1" title="docs:guide-user:storage:usb-drives-quickstart" data-wiki-id="docs:guide-user:storage:usb-drives-quickstart">Quick Start for installing a USB drive</a></strong> is available. This solves the very common case of installing a single USB drive onto your OpenWrt device.</div>
</li>
<li class="level1"><div class="li"> If the <a href="/docs/guide-user/storage/usb-drives-quickstart" class="wikilink1" title="docs:guide-user:storage:usb-drives-quickstart" data-wiki-id="docs:guide-user:storage:usb-drives-quickstart">Quick Start</a> doesn&#039;t address your question, you can install USB drivers manually. Background information about the different USB host controller interfaces (OHCI, UHCI, EHCI, xHCI) is given in a <a href="https://en.wikipedia.org/wiki/Host controller interface" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Host controller interface">Wikipedia article</a>. Please refer to your device documentation to find out which USB driver version your device needs.</div>
</li>
<li class="level1"><div class="li"> There is a more complete <a href="/docs/guide-user/storage/usb-drives" class="wikilink1" title="docs:guide-user:storage:usb-drives" data-wiki-id="docs:guide-user:storage:usb-drives">USB Drives</a> page</div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installing and troubleshooting USB Drivers&quot;,&quot;hid&quot;:&quot;installing_and_troubleshooting_usb_drivers&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-753&quot;} -->
<h2 class="sectionedit2" id="to_install_usb_drivers_manually">To install USB Drivers Manually</h2>
<div class="level2">
<ol>
<li class="level1"><div class="li"> Start with refreshing the list of available packages<pre class="code">opkg update</pre>
</div>
</li>
<li class="level1"><div class="li"> Obtain a list of already installed USB packages:<pre class="code">opkg list-installed *usb*</pre>

<p>
Result: 
</p>
<pre class="code">kmod-usb-core - 4.9.58-1
kmod-usb-storage - 4.9.58-1
kmod-usb3 - 4.9.58-1
...</pre>
</div>
</li>
<li class="level1"><div class="li"> Install the USB core package (all USB versions), if the previous list-output does not list it:<pre class="code">opkg install kmod-usb-core
insmod usbcore</pre>
</div>
</li>
<li class="level1"><div class="li"> Install the USB storage package (all USB versions), if the previous list-output does not list it:<pre class="code">opkg install kmod-usb-storage</pre>
</div>
</li>
<li class="level1"><div class="li"> To install USB 1.1 drivers, first try the UHCI driver:<pre class="code">opkg install kmod-usb-uhci
insmod uhci_hcd</pre>

<p>
If this fails with an error “No such device”, try installing the alternative OHCI driver for USB 1.1:
</p>
<pre class="code">opkg install kmod-usb-ohci
insmod ohci</pre>

<p>
<span style='color:#ed1c24; '>Someone would have to verify this <em>insmod uhci</em> command as inconsistent with the installed package - ohci package vs. uhci insmod command</span>
</p>
</div>
</li>
</ol>

<p>
(to remove non-working drivers, use <code>opkg remove</code>. Note: If both UCHI and OHCI drivers fail, we do not have USB 1.1.)
</p>
<ol>
<li class="level1"><div class="li"> To install USB 2.0 drivers:<pre class="code">opkg install kmod-usb2
insmod ehci-hcd</pre>
</div>
</li>
<li class="level1"><div class="li"> To install USB 3.0 drivers:<pre class="code">opkg install kmod-usb3
insmod xhci-hcd</pre>
</div>
</li>
<li class="level1"><div class="li"> To install support for UASP aka <a href="https://en.wikipedia.org/wiki/USB_Attached_SCSI" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/USB_Attached_SCSI">USB Attached SCSI</a> (supported by many USB drives and drive enclosures, especially if USB 3.0. It enhances performance if it&#039;s supported by both the drive and the host controller in your device):<pre class="code">opkg install kmod-usb-storage-uas</pre>
</div>
</li>
</ol>

<p>
<strong>NOTES:</strong>
</p>
<ul>
<li class="level1"><div class="li"> Some devices (e.g. Asus WL-500g router, brcm47xx) additionally need the kmod-usb2 module (even though they only have an USB 1.1 controller)</div>
</li>
<li class="level1"><div class="li"> Some devices (e.g. NLSU2, LinkSys WRT54G3GV2) additionally need the following packages: <pre class="code">opkg install kmod-usb-ohci-pci
opkg install kmod-usb2-pci</pre>
</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;To install USB Drivers Manually&quot;,&quot;hid&quot;:&quot;to_install_usb_drivers_manually&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;754-2703&quot;} -->
<h2 class="sectionedit3" id="troubleshooting_usb_drivers">Troubleshooting USB Drivers</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting USB Drivers&quot;,&quot;hid&quot;:&quot;troubleshooting_usb_drivers&quot;,&quot;codeblockOffset&quot;:11,&quot;secid&quot;:3,&quot;range&quot;:&quot;2704-2744&quot;} -->
<h3 class="sectionedit4" id="diagnostics_using_dmesg">Diagnostics using dmesg</h3>
<div class="level3">

<p>
Most firmware images already have USB or SATA support integrated in the default profile/image, so it should not be necessary to install additional packages.<br/>

To check, if USB support in included and if connected USB devices get detected:<br/>

1. Execute <code>dmesg</code> in the terminal, note its output. These are “driver messages”, events related to hardware being connected/started or disconnected/shut-down.<br/>

2. Now connect your external storage device, wait a few seconds and then execute <code>dmesg</code> on the terminal again.<br/>

3. If USB drivers are active and your device has successfully been recognized, you will notice that additional log output has been added at the end. 
</p>

<p>
Here is an example of the dmesg text about an USB device being connected and properly recognized. 
</p>
<pre class="code">[   96.603945] usb 1-1: new high-speed USB device number 2 using ehci-pci
[   96.812362] usb-storage 1-1:1.0: USB Mass Storage device detected
[   96.842945] scsi host4: usb-storage 1-1:1.0
[   98.242956] scsi 4:0:0:0: Direct-Access     JetFlash Transcend 8GB    1100 PQ: 0 ANSI: 4
[   98.415163] sd 4:0:0:0: [sdb] 15826944 512-byte logical blocks: (8.10 GB/7.55 GiB)
[   98.443523] sd 4:0:0:0: [sdb] Write Protect is off
[   98.732241] sd 4:0:0:0: [sdb] Mode Sense: 43 00 00 00
[   98.738043] sd 4:0:0:0: [sdb] No Caching mode page found
[   98.752681] sd 4:0:0:0: [sdb] Assuming drive cache: write through
[   98.893168]  sdb: sdb1 sdb2
[   98.951053] sd 4:0:0:0: [sdb] Attached SCSI disk</pre>

<p>
If your log output does not show USB-related output like this, please check that you have the right drivers and report this as a bug in the <a href="https://bugs.openwrt.org/" class="urlextern" title="https://bugs.openwrt.org/" rel="ugc nofollow">bugtracker</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Diagnostics using dmesg&quot;,&quot;hid&quot;:&quot;diagnostics_using_dmesg&quot;,&quot;codeblockOffset&quot;:11,&quot;secid&quot;:4,&quot;range&quot;:&quot;2745-4438&quot;} -->
<h3 class="sectionedit5" id="diagnostics_using_lsusb">Diagnostics using lsusb</h3>
<div class="level3">

<p>
Further diagnostics information about connected USB drives can be obtained, when installing the optional &#039;usbutils&#039; package:
</p>
<pre class="code">opkg update &amp;&amp; opkg install usbutils</pre>

<p>
This package installs the <code>lsusb</code> command that will output information of the router-built in USB-hub and connected USB-devices. The following example was run on a router with a single USB port. 
lsusb has recognized USB 2.0 and 3.0 support on this port and a connected device consisting of an USB-to-SATA-disk-bridge from ASMedia. Since this device is listed with the same bus-ID as the 3.0 hub, the USB-harddisk obviously is connected via the USB 3.0 protocol:
</p>
<pre class="code">Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 002: ID 174c:1153 ASMedia Technology Inc. ASM2115 SATA 6Gb/s bridge
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub</pre>

<p>
The command <code>lsusb -t</code> reveals, if your personal combination of device, OpenWrt firmware and external USB drive supports the newer and slightly faster USB 3.0 UASP Extension (USB Attached SCSI Protocol) or the older USB 3.0 block driver:
</p>
<pre class="code">...
/:  Bus 02.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/6p, 5000M
    |__ Port 2: Dev 3, If 0, Class=Mass Storage, Driver=uas, 5000M
    |__ Port 4: Dev 5, If 0, Class=Mass Storage, Driver=usb-storage, 5000M
...</pre>

<p>
In this example, device 3 (“Driver=uas”) is UASP-capable, while device 5 (“Driver=usb-storage”) is not.
</p>

<p>
On USB storage device problems, pay attention to the “Driver” output of <code>lsusb -t</code>. If it returned something like
</p>
<pre class="code">|__ Port 4: Dev 5, If 0, Class=Mass Storage, Driver=, 5000M</pre>

<p>
instead of
</p>
<pre class="code">|__ Port 4: Dev 5, If 0, Class=Mass Storage, Driver=usb-storage, 5000M</pre>

<p>
then OpenWrt has recognized the attached USB storage device, but does not have an USB-Storage driver installed yet. In this case you will need to install USB storage drivers first:
</p>
<pre class="code">opkg install kmod-usb-storage</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Diagnostics using lsusb&quot;,&quot;hid&quot;:&quot;diagnostics_using_lsusb&quot;,&quot;codeblockOffset&quot;:12,&quot;secid&quot;:5,&quot;range&quot;:&quot;4439-6432&quot;} -->
<h3 class="sectionedit6" id="diagnostics_using_cat">Diagnostics using cat</h3>
<div class="level3">

<p>
If you are truly out of options, you can use <code>cat</code>. Thanks to linux&#039;s “everything is a file” feature, you can look over USB debug information:
</p>
<pre class="code">cat /sys/kernel/debug/usb/devices

T:  Bus=01 Lev=00 Prnt=00 Port=00 Cnt=00 Dev#=  1 Spd=480  MxCh= 2
B:  Alloc=  0/800 us ( 0%), #Int=  0, #Iso=  0
D:  Ver= 2.00 Cls=09(hub  ) Sub=00 Prot=01 MxPS=64 #Cfgs=  1
P:  Vendor=1d6b ProdID=0002 Rev= 4.14
S:  Manufacturer=Linux 4.14.171 xhci-hcd
S:  Product=xHCI Host Controller
S:  SerialNumber=1e1c0000.xhci
C:* #Ifs= 1 Cfg#= 1 Atr=e0 MxPwr=  0mA
I:* If#= 0 Alt= 0 #EPs= 1 Cls=09(hub  ) Sub=00 Prot=00 Driver=hub
E:  Ad=81(I) Atr=03(Int.) MxPS=   4 Ivl=256ms

T:  Bus=01 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#=  4 Spd=480  MxCh= 0
D:  Ver= 2.10 Cls=00(&gt;ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs=  1
P:  Vendor=0781 ProdID=5583 Rev= 1.00
S:  Manufacturer=SanDisk
S:  Product=Ultra Fit
S:  SerialNumber=4C530001091024119291
C:* #Ifs= 1 Cfg#= 1 Atr=80 MxPwr=224mA
I:* If#= 0 Alt= 0 #EPs= 2 Cls=08(stor.) Sub=06 Prot=50 Driver=(none)
E:  Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms</pre>

<p>
You can piece enough information together from this output for diagnostics.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Diagnostics using cat&quot;,&quot;hid&quot;:&quot;diagnostics_using_cat&quot;,&quot;codeblockOffset&quot;:18,&quot;secid&quot;:6,&quot;range&quot;:&quot;6433-&quot;} -->