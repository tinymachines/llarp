
<h1 class="sectionedit1" id="openwrt_in_lxc_containers">OpenWrt in LXC containers</h1>
<div class="level1">

<p>
OpenWrt can run inside an LXC container, using the same kernel as running on the host system. This can be useful for development as well as for VM hosting.
</p>

<p>
You may also benefit from better performance, bigger memory, and bigger storage, found in pfSense/OPNsense appliances and Mini PCs, commonly found for purchase, and replace their <abbr title="Operating System">OS</abbr> with a Linux distro plus an OpenWrt container.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;OpenWrt in LXC containers&quot;,&quot;hid&quot;:&quot;openwrt_in_lxc_containers&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-428&quot;} -->
<h2 class="sectionedit2" id="installation">Installation</h2>
<div class="level2">

<p>
The following gives a rough idea on how to get things up and running. Before anything, install LXC on the host machine and make sure it supports running unprivileged containers. You will likely also need bridge functionality and/or additional underlying related subsystems (macvlan, etc.) if used. 
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation&quot;,&quot;hid&quot;:&quot;installation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;429-754&quot;} -->
<h3 class="sectionedit3" id="via_image">Via image</h3>
<div class="level3">

<p>
For some (<em>amd64</em>, <em>arm</em>...) architectures, the <em>download</em> template allows to retrieve an OpenWrt image from the <a href="https://images.linuxcontainers.org/" class="urlextern" title="https://images.linuxcontainers.org/" rel="ugc nofollow">remote mirror</a>.
To create the OpenWrt container, just do:
</p>
<pre class="code">lxc-create -n &lt;container_name&gt; -t download -- -d openwrt -a amd64</pre>

<p>
and spell the release you want to install when asked to. For any error related to fetching the GPG key, just specify a different keyserver (e.g. keyserver.ubuntu.com) by either setting <code>DOWNLOAD_KEYSERVER</code> or appending the <code>--keyserver</code> option.
</p>

<p>
The container will be created according to your default LXC config files (unless you use <code>--config</code> to specify a different config), so you may probably want to customize it further (e.g. add network interfaces or mount points) by modifying the final config in the container directory (see <em>lxc.container.conf(5)</em> man page). Depending on your setup, you may need to <code>attach</code> and temporarily give a fixed <abbr title="Internet Protocol">IP</abbr> address to the relevant interface in order to establish the first connection.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Via image&quot;,&quot;hid&quot;:&quot;via_image&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;755-1810&quot;} -->
<h3 class="sectionedit4" id="via_rootfs_extraction">Via rootfs extraction</h3>
<div class="level3">

<p>
For all other architectures, some manual steps are required:
</p>
<ol>
<li class="level1"><div class="li"> Create the VM folder manually at <code>.local/share/lxc/&lt;vm-name&gt;/</code></div>
</li>
<li class="level1"><div class="li"> Download a snapshot rootfs of OpenWrt and unpack it to <code>.local/share/lxc/&lt;vm-name&gt;/rootfs</code></div>
</li>
<li class="level1"><div class="li"> Create a <code>.local/share/lxc/&lt;vm-name&gt;/config</code> containing the following content:<br/>
<pre class="code">lxc.include = /etc/lxc/default.conf
lxc.include = /usr/share/lxc/config/common.conf
lxc.include = /usr/share/lxc/config/userns.conf
lxc.arch = linux64

# find your ids via
# cat  /etc/s*id|grep $USER
lxc.idmap = u 0 100000 65536
lxc.idmap = g 0 100000 65536

lxc.mount.auto = proc:mixed sys:ro cgroup:mixed

# lan interface
lxc.net.0.type = veth

# wan interface
lxc.net.1.type = veth
lxc.net.1.link = lxcbr0

# adapt &lt;user&gt; and &lt;vm-name&gt;
lxc.rootfs.path = dir:/home/&lt;user&gt;/.local/share/lxc/&lt;vm-name&gt;/rootfs</pre>
</div>
</li>
<li class="level1"><div class="li"> run <code>chmod</code> on the rootfs folder with the id you obtained earlier</div>
</li>
<li class="level1"><div class="li"> run <code>lxc-start -n &lt;vm-name&gt;</code></div>
</li>
<li class="level1"><div class="li"> run <code>lxc-attach -n &lt;vm-name&gt;</code></div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Via rootfs extraction&quot;,&quot;hid&quot;:&quot;via_rootfs_extraction&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:4,&quot;range&quot;:&quot;1811-2823&quot;} -->
<h2 class="sectionedit5" id="upgrading">Upgrading</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Upgrading&quot;,&quot;hid&quot;:&quot;upgrading&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:5,&quot;range&quot;:&quot;2824-2846&quot;} -->
<h3 class="sectionedit6" id="via_opkg">Via OPKG</h3>
<div class="level3">

<p>
Just edit all repositories versions at <code>/etc/opkg/distfeeds.conf</code> (e.g. from <code>/releases/24.10.0</code> to <code>/releases/24.10.1</code>), then run:
</p>
<pre class="code">opkg update
opkg list-upgradable | cut -d &#039; &#039; -f 1 | xargs opkg upgrade --force-depends</pre>

<p>
Kernel modules will fail to upgrade as the <code>kernel</code> package isn&#039;t available in the package list. You can ignore these failings as the host modules are used instead.
</p>

<p>
Alternatively, upgrade the <code>kernel</code> by downloading it directly from <a href="https://downloads.openwrt.org/releases/24.10.2/targets/x86/64/packages" class="urlextern" title="https://downloads.openwrt.org/releases/24.10.2/targets/x86/64/packages" rel="ugc nofollow">https://downloads.openwrt.org/releases/24.10.2/targets/x86/64/packages</a> with <code>wget</code> and installing via <code>opkg install</code>, for example:
</p>
<pre class="code">wget https://mirror-03.infra.openwrt.org/releases/24.10.2/targets/x86/64/packages/kernel_6.6.93~1745ebad77278f5cdc8330d17a3f43d6-r1_x86_64.ipk
opkg install kernel_6.6.93~1745ebad77278f5cdc8330d17a3f43d6-r1_x86_64.ipk</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Via OPKG&quot;,&quot;hid&quot;:&quot;via_opkg&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:6,&quot;range&quot;:&quot;2847-3713&quot;} -->
<h3 class="sectionedit7" id="reinstall">Reinstall</h3>
<div class="level3">

<p>
Once a new release becomes available, as announced by the OpenWrt team, you can install and migrate to it:
</p>
<ol>
<li class="level1"><div class="li"> install the new release image as above (it will typically be available within the next day)</div>
</li>
<li class="level1"><div class="li"> replace the new container&#039;s config file with the old one (remember to edit relevant options if needed e.g. the rootfs path, the host name, the autostart flag...)</div>
</li>
<li class="level1"><div class="li"> backup the settings of the currently running OpenWrt as you would usually do, and shut it down</div>
</li>
<li class="level1"><div class="li"> start the new container and, if it&#039;s safe to do so (as it usually is for minor releases), restore OpenWrt settings from backup</div>
</li>
</ol>

<p>
Note: if you are still getting the previous image after more than 24h since the new release (images are currently built daily by lxc), chances are an old cached image is being used. In this case, you can delete the old image by appending the <code>--flush-cache</code> option to the command.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Reinstall&quot;,&quot;hid&quot;:&quot;reinstall&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:7,&quot;range&quot;:&quot;3714-4617&quot;} -->
<h2 class="sectionedit8" id="configuration">Configuration</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuration&quot;,&quot;hid&quot;:&quot;configuration&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:8,&quot;range&quot;:&quot;4618-4643&quot;} -->
<h3 class="sectionedit9" id="start_on_boot">Start on boot</h3>
<div class="level3">

<p>
To load the OpenWrt container with the host system boot, add to the LXC config:
</p>
<pre class="code">lxc.start.auto = 1</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Start on boot&quot;,&quot;hid&quot;:&quot;start_on_boot&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:9,&quot;range&quot;:&quot;4644-4782&quot;} -->
<h3 class="sectionedit10" id="physical_port_assignment">Physical port assignment</h3>
<div class="level3">

<p>
Giving the OpenWrt container full control over some physical ports is often useful.
You can map the host interfaces to container named interfaces with the following config:
</p>
<pre class="code"># Interface 1: Host en2s0 -&gt; Container wan
lxc.net.1.hwaddr = AA:BB:CC:DD:EE:FF
lxc.net.1.type = phys
lxc.net.1.link = enp2s0
lxc.net.1.name = wan
lxc.net.1.flags = up
# Interface 2: Host eno1 -&gt; Container lan1
lxc.net.2.type = phys
lxc.net.2.link = eno1
lxc.net.2.name = lan1
lxc.net.2.flags = up</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Physical port assignment&quot;,&quot;hid&quot;:&quot;physical_port_assignment&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:10,&quot;range&quot;:&quot;4783-5304&quot;} -->
<h3 class="sectionedit11" id="host_openwrt_connection">Host &lt;=&gt; OpenWrt connection</h3>
<div class="level3">

<p>
To connect OpenWrt with the host, and vice-versa, using a <abbr title="Local Area Network">LAN</abbr> <abbr title="Internet Protocol">IP</abbr>, which is useful to offer OpenWrt visibility and redirection abilities to the host, you can use directly the LXC bridge, so you don&#039;t need another physical port, which might be a bottleneck.
</p>

<p>
1. Configure the LXC network interface:
</p>
<pre class="code"># host lan configuration
lxc.net.0.type = veth
lxc.net.0.link = lxcbr0
lxc.net.0.name = lan-host
lxc.net.0.flags = up</pre>

<p>
2. Configure a static <abbr title="Internet Protocol">IP</abbr> with LXC-NET bridge at <code>/etc/default/lxc-net</code>. Replace <code>LXC_ADDR</code> <abbr title="Internet Protocol">IP</abbr> with a desired <abbr title="Internet Protocol">IP</abbr> inside your <abbr title="Local Area Network">LAN</abbr> <abbr title="Internet Protocol">IP</abbr> range.
</p>
<pre class="code">USE_LXC_BRIDGE=&quot;true&quot;
LXC_BRIDGE=&quot;lxcbr0&quot;
LXC_ADDR=&quot;10.0.0.2&quot;
LXC_NETMASK=&quot;255.255.255.0&quot;
LXC_NETWORK=&quot;10.0.0.0/24&quot;</pre>

<p>
Restart the <code>lxc</code> and the <code>lxc-net</code> services. (e.g. with <code>sudo systemctl restart lxc-net lxc</code>)
</p>

<p>
3. In OpenWrt, add the device <code>lan-host</code> device to the <code>br-lan</code> bridge. There is no need to configure an interface for it.
</p>

<p>
Now the OpenWrt container should be able to ping the host <abbr title="Internet Protocol">IP</abbr> (specified above at <code>LXC_ADDR</code>), and vice-versa.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Host &lt;=&gt; OpenWrt connection&quot;,&quot;hid&quot;:&quot;host_openwrt_connection&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:11,&quot;range&quot;:&quot;5305-6389&quot;} -->
<h3 class="sectionedit12" id="ipv6_ra_conflict">IPv6 RA conflict</h3>
<div class="level3">

<p>
LXC-NET advertises <abbr title="Internet Protocol version 6">IPv6</abbr> RA and likely will conflict with OpenWrt <abbr title="Internet Protocol version 6">IPv6</abbr> RA configuration.
</p>

<p>
Disabling LXC&#039;s <abbr title="Internet Protocol version 6">IPv6</abbr> is an easy workaround, adding <code>LXC_IPV6_ENABLE=“false”</code> to <code>/etc/default/lxc-net</code>. This requires LXC 6.0.4 or greater.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;IPv6 RA conflict&quot;,&quot;hid&quot;:&quot;ipv6_ra_conflict&quot;,&quot;codeblockOffset&quot;:8,&quot;secid&quot;:12,&quot;range&quot;:&quot;6390-6650&quot;} -->
<h3 class="sectionedit13" id="pppoe_use">PPPoE use</h3>
<div class="level3">

<p>
PPPoE <abbr title="Wide Area Network">WAN</abbr> interface requires the kernel device <code>/dev/ppp</code>. You need to mount the device in the LXC configuration file:
</p>
<pre class="code">lxc.cgroup2.devices.allow = c 108:* rwm
lxc.mount.entry = /dev/ppp dev/ppp none bind,create=file</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;PPPoE use&quot;,&quot;hid&quot;:&quot;pppoe_use&quot;,&quot;codeblockOffset&quot;:8,&quot;secid&quot;:13,&quot;range&quot;:&quot;6651-6904&quot;} -->
<h3 class="sectionedit14" id="modules_load">Modules load</h3>
<div class="level3">

<p>
OpenWRT can&#039;t load modules through the container. Instead, you must load them manually on the host. To load them on boot automatically, create the file <code>/etc/modules-load.d/openwrt.conf</code> with a list of modules required, for example:
</p>
<pre class="code">pppoe
pppox
wireguard
br-netfilter
8021q</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Modules load&quot;,&quot;hid&quot;:&quot;modules_load&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:14,&quot;range&quot;:&quot;6905-&quot;} -->