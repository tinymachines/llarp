
<h1 class="sectionedit1" id="openwrt_on_utm_on_apple_silicon_howto">OpenWrt on UTM on Apple Silicon HowTo</h1>
<div class="level1">

<p>
This document describes how to run the <code>armsr/armv8</code> OpenWrt images in a <abbr title="Virtual Machine">VM</abbr> hosted on macOS (Apple Silicon hardware) using <a href="https://docs.getutm.app/" class="urlextern" title="https://docs.getutm.app/" rel="ugc nofollow">UTM</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;OpenWrt on UTM on Apple Silicon HowTo&quot;,&quot;hid&quot;:&quot;openwrt_on_utm_on_apple_silicon_howto&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-243&quot;} -->
<h2 class="sectionedit2" id="prerequisites">Prerequisites</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="https://docs.getutm.app/installation/macos/" class="urlextern" title="https://docs.getutm.app/installation/macos/" rel="ugc nofollow">UTM</a> installed</div>
</li>
<li class="level1"><div class="li"> Familiarity with the command line on macOS (Terminal window)</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level2">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:6,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:7,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level2">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:9,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_important plugin_wrap">
<p>
This article may contain network configuration that depends on migration to DSA in OpenWrt 21.02
</p>
<ul>
<li class="level1"><div class="li"> Check if your device uses DSA or swconfig as not all devices have been migrated</div>
</li>
<li class="level1"><div class="li"> ifname@interface has been moved to device sections</div>
</li>
<li class="level1"><div class="li"> <a href="/docs/guide-user/network/dsa/start" class="wikilink1" title="docs:guide-user:network:dsa:start" data-wiki-id="docs:guide-user:network:dsa:start">DSA Networking</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://forum.openwrt.org/t/mini-tutorial-for-dsa-network-config/96998" class="urlextern" title="https://forum.openwrt.org/t/mini-tutorial-for-dsa-network-config/96998" rel="ugc nofollow">Mini tutorial for DSA network config</a> on the forum</div>
</li>
<li class="level1"><div class="li"> <a href="https://openwrt.org/releases/21.02/notes-21.02.0#new_network_configuration_syntax_and_boardjson_change" class="urlextern" title="https://openwrt.org/releases/21.02/notes-21.02.0#new_network_configuration_syntax_and_boardjson_change" rel="ugc nofollow">DSA in the 21.02 release notes</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:10,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:8,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Prerequisites&quot;,&quot;hid&quot;:&quot;prerequisites&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;244-573&quot;} -->
<h3 class="sectionedit11" id="select_an_openwrt_image">Select an OpenWrt image</h3>
<div class="level3">

<p>
You need an ARM system-ready 64-bit version of OpenWrt.
There are two versions:
</p>
<ul>
<li class="level1"><div class="li"> <code>combined-squashfs.img.gz</code>: This edition, as of release 23.05.0, does not work correctly with sysupgrade.  </div>
</li>
<li class="level1"><div class="li"> <code>combined-ext4.img.gz</code> This disk image uses a single read-write ext4 partition with no read-only squashfs root filesystem.  Features like Failsafe Mode or Factory Reset won&#039;t be available as they need a read-only squashfs partition to function.</div>
</li>
</ul>

<p>
In the guide we&#039;ll use <em>openwrt-armsr-armv8-generic-ext4-combined.img.gz</em> because it supports sysupgrade.
</p>
<ul>
<li class="level1"><div class="li"> Download a stable release of the <em>generic-ext4-combined.img.gz</em> image from <a href="https://downloads.openwrt.org/releases/" class="urlextern" title="https://downloads.openwrt.org/releases/" rel="ugc nofollow">targets/armsr/arvm8/ folder</a>, e.g. <a href="https://downloads.openwrt.org/releases/23.05.2/targets/armsr/armv8/openwrt-23.05.2-armsr-armv8-generic-ext4-combined.img.gz" class="urlextern" title="https://downloads.openwrt.org/releases/23.05.2/targets/armsr/armv8/openwrt-23.05.2-armsr-armv8-generic-ext4-combined.img.gz" rel="ugc nofollow">23.05.2</a>.</div>
</li>
<li class="level1"><div class="li"> Or you can try a more recent but experimental <a href="https://downloads.openwrt.org/snapshots/targets/armsr/armv8/openwrt-armsr-armv8-generic-ext4-combined.img.gz" class="urlextern" title="https://downloads.openwrt.org/snapshots/targets/armsr/armv8/openwrt-armsr-armv8-generic-ext4-combined.img.gz" rel="ugc nofollow">snapshot</a> image.</div>
</li>
<li class="level1"><div class="li"> Uncompress the gzip&#039;ed img file. On macOS in a Terminal window use the command <code>gzcat openwrt-*ext4-combined.img.gz &gt; openwrt.img</code>.   As a result you get the raw <code>openwrt.img</code> image  file.</div>
</li>
</ul>

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> Tip: keep a copy of the original gzip&#039;ed image file, it can be used as an image for sysupgrade.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Select an OpenWrt image&quot;,&quot;hid&quot;:&quot;select_an_openwrt_image&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:11,&quot;range&quot;:&quot;574-1937&quot;} -->
<h2 class="sectionedit12" id="vm_setup_in_utm">VM Setup in UTM</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;VM Setup in UTM&quot;,&quot;hid&quot;:&quot;vm_setup_in_utm&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:12,&quot;range&quot;:&quot;1938-1965&quot;} -->
<h3 class="sectionedit13" id="vm_creation">VM creation</h3>
<div class="level3">

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> Tutorial and screenshots from UTM 4.4.4 on Apple Silicon
</p>

<p>
<a href="/_media/media/virtualization/utm/1-utmstart.png" class="media" title="media:virtualization:utm:1-utmstart.png"><img src="/_media/media/virtualization/utm/1-utmstart.png?w=70&amp;tok=be7540" class="media" loading="lazy" alt="" width="70" /></a> Start UTM and click <em>Create a new Virtual Machine</em>
</p>
<hr />

<p>
<a href="/_media/media/virtualization/utm/2-virtualize.png" class="media" title="media:virtualization:utm:2-virtualize.png"><img src="/_media/media/virtualization/utm/2-virtualize.png?w=70&amp;tok=87834d" class="media" loading="lazy" alt="" width="70" /></a> Select <em>Virtualize</em>
</p>
<hr />

<p>
<a href="/_media/media/virtualization/utm/3-other.png" class="media" title="media:virtualization:utm:3-other.png"><img src="/_media/media/virtualization/utm/3-other.png?w=70&amp;tok=9afe5a" class="media" loading="lazy" alt="" width="70" /></a> Select <em>Other</em> (because the <em>Linux</em> install path assumes an install ISO image, which we are not using for OpenWrt)
</p>
<hr />

<p>
<a href="/_media/media/virtualization/utm/4-no-iso-boot.png" class="media" title="media:virtualization:utm:4-no-iso-boot.png"><img src="/_media/media/virtualization/utm/4-no-iso-boot.png?w=70&amp;tok=f80f70" class="media" loading="lazy" alt="" width="70" /></a> Check the <em>Skip ISO boot</em> box
</p>
<hr />

<p>
<a href="/_media/media/virtualization/utm/5-cpu-memory.png" class="media" title="media:virtualization:utm:5-cpu-memory.png"><img src="/_media/media/virtualization/utm/5-cpu-memory.png?w=70&amp;tok=7413cc" class="media" loading="lazy" alt="" width="70" /></a> Configure 512MB and 2 CPUs (enough memory for running sysupgrade later)
</p>
<hr />

<p>
<a href="/_media/media/virtualization/utm/6-storage.png" class="media" title="media:virtualization:utm:6-storage.png"><img src="/_media/media/virtualization/utm/6-storage.png?w=70&amp;tok=9301c5" class="media" loading="lazy" alt="" width="70" /></a> Accept the default storage setting (we will remove this drive later and replace it with the OpenWrt image)
</p>
<hr />

<p>
<a href="/_media/media/virtualization/utm/7-shared.png" class="media" title="media:virtualization:utm:7-shared.png"><img src="/_media/media/virtualization/utm/7-shared.png?w=70&amp;tok=c5fb1d" class="media" loading="lazy" alt="" width="70" /></a> Leave the shared directory configuration blank
</p>
<hr />

<p>
<a href="/_media/media/virtualization/utm/8-summary.png" class="media" title="media:virtualization:utm:8-summary.png"><img src="/_media/media/virtualization/utm/8-summary.png?w=70&amp;tok=7659b2" class="media" loading="lazy" alt="" width="70" /></a> Check the <em>Open VM Settings</em> box.  Fill in a name for the VM.  Click <em>Save</em>.  This brings you to the VM settings page.
</p>
<hr />

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;VM creation&quot;,&quot;hid&quot;:&quot;vm_creation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:13,&quot;range&quot;:&quot;1966-3096&quot;} -->
<h3 class="sectionedit14" id="vm_configuration">VM configuration</h3>
<div class="level3">

<p>
The configuration you will set up by following this tutorial is:
</p>
<ul>
<li class="level1"><div class="li"> <strong>br-lan</strong> of the VM on <strong>lan</strong> interface, fixed address 10.0.2.2, set in UTM as <strong>Host Only Network</strong>.  This interface will <em class="u">always</em> be available to the host even if host or VM are disconnected from any network.</div>
</li>
<li class="level1"><div class="li"> <strong>eth1</strong> of the VM on <strong>wan</strong> interface, dynamic address, set in UTM as <strong>Shared Network</strong> (<abbr title="Network Address Translation">NAT</abbr>). This interface will be used to access the Internet through whatever setup the host also uses.</div>
</li>
</ul>

<p>
Note that the <em>order</em> of the “Host Only” and “Shared Network” networks is important for turn-key operation of OpenWrt in the VM. While it can be configured using the console, configuration in this way simplifies getting to a running configuration.
</p>

</div>

<h4 id="vm_settings">VM settings</h4>
<div class="level4">

</div>

<h5 id="remove_unused_devices">Remove unused devices</h5>
<div class="level5">

<p>
<a href="/_media/media/virtualization/utm/10-remove.png" class="media" title="media:virtualization:utm:10-remove.png"><img src="/_media/media/virtualization/utm/10-remove.png?w=70&amp;tok=41321c" class="media" loading="lazy" alt="" width="70" /></a>
Control-click on <em>Display</em> and remove it.  Control-click on <em>Sound</em> and remove it.  Control-click on the <em>VirtIO Drive</em> and remove it.  Confirm deleting the drive with <em>Delete</em>.  (This is the blank disk that UTM creates during VM creation.  We don&#039;t need it.)
</p>
<hr />

</div>

<h5 id="network_settings">Network Settings</h5>
<div class="level5">

<p>
<a href="/_media/media/virtualization/utm/11-host-only.png" class="media" title="media:virtualization:utm:11-host-only.png"><img src="/_media/media/virtualization/utm/11-host-only.png?w=70&amp;tok=c16a12" class="media" loading="lazy" alt="" width="70" /></a> Select <em>Network</em>.  Change the Network Mode to <em>Host Only</em>. Check the <em>Show Advanced Settings</em> box.  In the <em>Guest Network</em> box, type in the network range for the VM&#039;s <abbr title="Local Area Network">LAN</abbr>: <em>10.0.2.0/24</em>.
</p>
<hr />

<p>
<a href="/_media/media/virtualization/utm/12-wan.png" class="media" title="media:virtualization:utm:12-wan.png"><img src="/_media/media/virtualization/utm/12-wan.png?w=70&amp;tok=492023" class="media" loading="lazy" alt="" width="70" /></a> Under Devices, click the <em>+New</em> entry and add a new <em>Network</em>.  Click on the network and confirm it is configured as <em>Shared Network</em>.
</p>
<hr />

</div>

<h5 id="other_device_settings">Other Device Settings</h5>
<div class="level5">

<p>
<a href="/_media/media/virtualization/utm/13-serial.png" class="media" title="media:virtualization:utm:13-serial.png"><img src="/_media/media/virtualization/utm/13-serial.png?w=70&amp;tok=39b0ae" class="media" loading="lazy" alt="" width="70" /></a> Under Devices, click the
<em>+New</em> entry and add a new <em>Serial</em> device.  Click on the Serial
device and check the mode.  The default is a built-in terminal
window that supports copy and paste with native macOS keyboard shortcuts.
</p>
<hr />

<p>
<a href="/_media/media/virtualization/utm/14-disk.png" class="media" title="media:virtualization:utm:14-disk.png"><img src="/_media/media/virtualization/utm/14-disk.png?w=70&amp;tok=18a783" class="media" loading="lazy" alt="" width="70" /></a> Under the <em>Drives</em>
section, select <em>New...</em>.  Accept the interface default (VirtIO) and
click on <em>Import...</em>.  Navigate to the <code>openwrt.img</code> file you
unpacked in previous steps.
</p>
<hr />

<p>
<em>Save</em> the configuration.
</p>

</div>

<h4 id="virtual_machine_openwrt_settings">Virtual Machine OpenWrt Settings</h4>
<div class="level4">
<hr />
<ul>
<li class="level1"><div class="li"> Start your Virtual Machine (click the Play icon button)</div>
</li>
<li class="level1"><div class="li"> Wait 4 seconds for GRUB to boot automatically</div>
</li>
<li class="level1"><div class="li"> Press Enter to activate the console when the boot messages have finished scrolling by.</div>
</li>
<li class="level1"><div class="li"> Display the current <abbr title="Local Area Network">LAN</abbr> network configuration.  Note that the default <abbr title="Local Area Network">LAN</abbr> address of 192.168.1.1 is present on first boot.<pre class="code">root@openwrt:~# uci show network.lan
network.lan=interface
network.lan.device=&#039;br-lan&#039;
network.lan.proto=&#039;static&#039;
network.lan.ipaddr=&#039;192.168.1.1&#039;
network.lan.netmask=&#039;255.255.255.0&#039;
network.lan.ip6assign=&#039;60&#039;</pre>
</div>
</li>
<li class="level1"><div class="li"> Edit the network configuration to allow <abbr title="Secure Shell">SSH</abbr> access by pasting these commands into the console:<pre class="code">uci set network.lan.ipaddr=&#039;10.0.2.2&#039;
uci commit
service network restart</pre>
</div>
</li>
<li class="level1"><div class="li"> Now your VM is accessible from <abbr title="Secure Shell">SSH</abbr>, user <strong>root</strong> (no password) address <strong>10.0.2.2</strong></div>
</li>
<li class="level1"><div class="li"> If you installed a release image such as 23.05.0, the LuCi web interface is available at <a href="http://10.0.2.2/" class="urlextern" title="http://10.0.2.2/" rel="ugc nofollow">http://10.0.2.2/</a> (no password)</div>
</li>
<li class="level1"><div class="li"> If you installed a snapshot that doesn&#039;t include LuCi, install it with <pre class="code">opkg update &amp;&amp; opkg install luci</pre>
</div>
</li>
<li class="level1"><div class="li"> You should have both internet access (try a <strong>opkg update</strong>) AND a <abbr title="Local Area Network">LAN</abbr> interface with a static address you can connect your <abbr title="Secure Shell">SSH</abbr> client program to even if your PC is disconnected from a local network.</div>
</li>
<li class="level1"><div class="li"> If you have more complex requirements you will have to set that up on your own by reading the documentation, or through LuCi.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;VM configuration&quot;,&quot;hid&quot;:&quot;vm_configuration&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:14,&quot;range&quot;:&quot;3097-6751&quot;} -->
<h2 class="sectionedit15" id="see_also">See also</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="/docs/guide-user/virtualization/start" class="wikilink1" title="docs:guide-user:virtualization:start" data-wiki-id="docs:guide-user:virtualization:start">Other virtualization options</a>: Docker, VMware etc.</div>
</li>
<li class="level1"><div class="li"> <a href="/docs/guide-user/virtualization/fusion" class="wikilink1" title="docs:guide-user:virtualization:fusion" data-wiki-id="docs:guide-user:virtualization:fusion">VMware Fusion</a>: Configuring on a VM hosted on VMware Fusion</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;See also&quot;,&quot;hid&quot;:&quot;see_also&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:15,&quot;range&quot;:&quot;6752-&quot;} -->