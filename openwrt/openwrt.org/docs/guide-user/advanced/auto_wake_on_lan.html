
<h1 class="sectionedit1" id="auto_wake_on_lan_script_for_hosts">Auto Wake On LAN script for hosts</h1>
<div class="level1">

<p>
At the very least, users should consider putting the LOGFILE on <code>/tmp/</code> rather than on flash.
OpenWrt also does not serve <abbr title="HyperText Markup Language">HTML</abbr> pages in the same way as DD-WRT.
</p>

<p>
Note also problems with rebooting a router running this script described at <a href="https://forum.openwrt.org/t/cant-reboot-while-sleep-script-wol/" class="urlextern" title="https://forum.openwrt.org/t/cant-reboot-while-sleep-script-wol/" rel="ugc nofollow">https://forum.openwrt.org/t/cant-reboot-while-sleep-script-wol/</a>
</p>
<hr />

<p>
Hi guys,
I found on <a href="https://www.dd-wrt.com/wiki/index.php/Useful_Scripts#Web_Server_Wake-up" class="urlextern" title="https://www.dd-wrt.com/wiki/index.php/Useful_Scripts#Web_Server_Wake-up" rel="ugc nofollow">https://www.dd-wrt.com/wiki/index.php/Useful_Scripts#Web_Server_Wake-up</a> this useful script for wake up a host by request.<br/>

I use it to wake up my NAS if my Kodi or PC want anything from it.
</p>

<p>
Requirements:
</p>
<ul>
<li class="level1"><div class="li"> Firmware Version: OpenWrt Barrier Breaker 14.07 / LuCI Trunk (0.12+svn-r10530)</div>
</li>
<li class="level1"><div class="li"> Kernel Version: 3.10.49</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Auto Wake On LAN script for hosts&quot;,&quot;hid&quot;:&quot;auto_wake_on_lan_script_for_hosts&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-699&quot;} -->
<h2 class="sectionedit2" id="script_settings">Script settings</h2>
<div class="level2">
<div class="table sectionedit3"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Required to change </th><th class="col1"> Variables </th><th class="col2"> Default value </th><th class="col3"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> optional </td><td class="col1"> INTERVAL </td><td class="col2"> 5 </td><td class="col3"> repeat the script every N second </td>
	</tr>
	<tr class="row2">
		<td class="col0"> not required </td><td class="col1"> OLD </td><td class="col2"> empty </td><td class="col3"> should be empty </td>
	</tr>
	<tr class="row3">
		<td class="col0"> optional </td><td class="col1"> PORT </td><td class="col2"> 80 </td><td class="col3"> it the port who looks the script </td>
	</tr>
	<tr class="row4">
		<td class="col0"> optional </td><td class="col1"> NUMP </td><td class="col2"> 3 </td><td class="col3"> the retries, before the script gave up </td>
	</tr>
	<tr class="row5">
		<td class="col0"> yes </td><td class="col1"> TARGET </td><td class="col2"> 192.168.1.1 </td><td class="col3"> the wake up device </td>
	</tr>
	<tr class="row6">
		<td class="col0"> yes </td><td class="col1"> INTERFACE </td><td class="col2"> br-lan </td><td class="col3"> here you can type in a broadcast address or a interface, i like more interface </td>
	</tr>
	<tr class="row7">
		<td class="col0"> yes </td><td class="col1"> MAC </td><td class="col2"> 00:00:00:00:00:00 </td><td class="col3"> the target mac adress </td>
	</tr>
	<tr class="row8">
		<td class="col0"> not required </td><td class="col1"> WOL </td><td class="col2"> /usr/bin/etherwake </td><td class="col3"> the program and path for wol </td>
	</tr>
	<tr class="row9">
		<td class="col0"> optional </td><td class="col1"> LOGFILE </td><td class="col2"> “/www/wol/index.html” </td><td class="col3"> the log output folder, in this case for the url &lt;ROUTER-<abbr title="Internet Protocol">IP</abbr>&gt;/wol/index.html </td>
	</tr>
	<tr class="row10">
		<td class="col0"> optional </td><td class="col1"> LOGPROG </td><td class="col2"> “logread” </td><td class="col3"> i will read the logs from LOGREAD, but you can also read from “dmesg” or something else </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;728-1574&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Script settings&quot;,&quot;hid&quot;:&quot;script_settings&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;700-1575&quot;} -->
<h2 class="sectionedit4" id="instructions">Instructions</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Instructions&quot;,&quot;hid&quot;:&quot;instructions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;1576-1600&quot;} -->
<h3 class="sectionedit5" id="preparation">1. Preparation</h3>
<div class="level3">

<p>
Install the required packages.
</p>
<pre class="code bash">opkg update
opkg <span class="kw2">install</span> etherwake</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;1. Preparation&quot;,&quot;hid&quot;:&quot;preparation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;1601-1713&quot;} -->
<h3 class="sectionedit6" id="auto_wol_script">2. Auto WoL script</h3>
<div class="level3">

<p>
Saving the script.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>bin<span class="sy0">/</span>autowol.sh
<span class="co0">#!/bin/sh</span>
<span class="co0">#Enable JFFS2 and place script in /jffs/ then run on startup in web interface.</span>
<span class="co0">#You can check the log from http://192.168.1.1/user/wol.html</span>
&nbsp;
<span class="co0">#debugging</span>
<span class="co0">#set -xv</span>
&nbsp;
<span class="re2">INTERVAL</span>=<span class="nu0">5</span>
<span class="re2">NUMP</span>=<span class="nu0">3</span>
<span class="re2">OLD</span>=<span class="st0">&quot;&quot;</span>
<span class="re2">PORT</span>=<span class="nu0">80</span>
<span class="re2">TARGET</span>=192.168.1.1
<span class="re2">INTERFACE</span>=br-lan
<span class="re2">MAC</span>=00:00:00:00:00:00
<span class="re2">WOL</span>=<span class="sy0">/</span>usr<span class="sy0">/</span>bin<span class="sy0">/</span>etherwake
<span class="re2">LOGFILE</span>=<span class="st0">&quot;/www/wol/index.html&quot;</span>
<span class="re2">LOGPROG</span>=<span class="st0">&quot;logread&quot;</span> <span class="co0"># default: dmesg</span>
&nbsp;
<span class="kw3">echo</span> <span class="st0">&quot;&lt;meta http-equiv=<span class="es1">\&quot;</span>refresh<span class="es1">\&quot;</span> content=<span class="es1">\&quot;</span>10<span class="es1">\&quot;</span>&gt;&quot;</span> <span class="sy0">&gt;</span> <span class="re1">$LOGFILE</span>
<span class="kw3">echo</span> <span class="st0">&quot;AUTO WOL Script started at&quot;</span> <span class="sy0">`</span><span class="kw2">date</span><span class="sy0">`</span> <span class="st0">&quot;&lt;br&gt;&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="re1">$LOGFILE</span>
&nbsp;
wake_up <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="re2">PORT</span>=<span class="re4">$1</span>
	<span class="re2">TARGET</span>=<span class="re4">$2</span>
	<span class="re2">BROADCAST</span>=<span class="re4">$3</span>
	<span class="re2">MAC</span>=<span class="re4">$4</span>
	<span class="re2">NEW</span>=<span class="sy0">`</span><span class="re1">$LOGPROG</span> <span class="sy0">|</span> <span class="kw2">awk</span> <span class="st_h">'/WOL_LOG/ &amp;&amp; /DST='</span><span class="st0">&quot;<span class="es2">$TARGET</span>&quot;</span><span class="st_h">'/ &amp;&amp; /DPT='</span><span class="st0">&quot;<span class="es2">$PORT</span>&quot;</span><span class="st_h">'/ {print }'</span> <span class="sy0">|</span> <span class="kw2">tail</span> -<span class="nu0">1</span><span class="sy0">`</span>
	<span class="re2">SRC</span>=<span class="sy0">`</span><span class="re1">$LOGPROG</span> <span class="sy0">|</span> <span class="kw2">awk</span> <span class="re5">-F</span><span class="st_h">'[=| ]'</span> <span class="st_h">'/WOL_LOG/ &amp;&amp; /DST='</span><span class="st0">&quot;<span class="es2">$TARGET</span>&quot;</span><span class="st_h">'/ &amp;&amp; /DPT='</span><span class="st0">&quot;<span class="es2">$PORT</span>&quot;</span><span class="st_h">'/ {print }'</span> <span class="sy0">|</span> <span class="kw2">tail</span> -<span class="nu0">1</span><span class="sy0">`</span>
	<span class="re2">LINE</span>=<span class="sy0">`</span><span class="re1">$LOGPROG</span> <span class="sy0">|</span> <span class="kw2">awk</span> <span class="st_h">'/WOL_LOG/ &amp;&amp; /DST='</span><span class="st0">&quot;<span class="es2">$TARGET</span>&quot;</span><span class="st_h">'/ &amp;&amp; /DPT='</span><span class="st0">&quot;<span class="es2">$PORT</span>&quot;</span><span class="st_h">'/'</span><span class="sy0">`</span>
	<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="st0">&quot;<span class="es2">$NEW</span>&quot;</span> <span class="sy0">!</span>= <span class="st0">&quot;&quot;</span> <span class="re5">-a</span> <span class="st0">&quot;<span class="es2">$NEW</span>&quot;</span> <span class="sy0">!</span>= <span class="st0">&quot;<span class="es2">$OLD</span>&quot;</span> <span class="br0">&#93;</span>; <span class="kw1">then</span>
		<span class="kw1">if</span> <span class="kw2">ping</span> <span class="re5">-qc</span> <span class="re1">$NUMP</span> <span class="re1">$TARGET</span> <span class="sy0">&gt;/</span>dev<span class="sy0">/</span>null; <span class="kw1">then</span>
			<span class="kw3">echo</span> <span class="st0">&quot;NOWAKE <span class="es2">$TARGET</span> was accessed by <span class="es2">$SRC</span> and is already alive at&quot;</span> <span class="sy0">`</span><span class="kw2">date</span><span class="sy0">`</span> <span class="st0">&quot;&lt;br&gt;&quot;</span><span class="sy0">&gt;&gt;</span> <span class="re1">$LOGFILE</span>
		<span class="kw1">else</span>
			<span class="kw3">echo</span> <span class="st0">&quot;WAKE <span class="es2">$SRC</span> causes wake on lan at&quot;</span> <span class="sy0">`</span><span class="kw2">date</span><span class="sy0">`</span> <span class="st0">&quot;&lt;br&gt;&quot;</span><span class="sy0">&gt;&gt;</span> <span class="re1">$LOGFILE</span>
			<span class="re1">$WOL</span> <span class="re5">-i</span> <span class="re1">$BROADCAST</span> <span class="re1">$MAC</span> <span class="sy0">&gt;&gt;</span> <span class="re1">$LOGFILE</span>
			<span class="kw3">echo</span> <span class="st0">&quot;&lt;br&gt;&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="re1">$LOGFILE</span>
			<span class="kw2">sleep</span> <span class="nu0">5</span>
		<span class="kw1">fi</span>
		<span class="re2">OLD</span>=<span class="re1">$NEW</span>
	<span class="kw1">fi</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">while</span> <span class="kw2">sleep</span> <span class="re1">$INTERVAL</span>; <span class="kw1">do</span>
wake_up <span class="re1">$PORT</span> <span class="re1">$TARGET</span> <span class="re1">$INTERFACE</span> <span class="re1">$MAC</span>;
<span class="kw1">done</span>
EOF
<span class="kw2">chmod</span> +x <span class="sy0">/</span>bin<span class="sy0">/</span>autowol.sh</pre>

<p>
Pro Tip: Don&#039;t copy the code above as it causes a bunch of errors due to a stray CRLF character at the end of each line. Instead just download a copy of the file <a href="https://drive.google.com/file/d/0Bx6d-VNCJvgBb1VFMTQxUTc1d2M/view" class="urlextern" title="https://drive.google.com/file/d/0Bx6d-VNCJvgBb1VFMTQxUTc1d2M/view" rel="ugc nofollow"> here</a>, and save yourself a day of troubleshooting!
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;2. Auto WoL script&quot;,&quot;hid&quot;:&quot;auto_wol_script&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:6,&quot;range&quot;:&quot;1714-3361&quot;} -->
<h3 class="sectionedit7" id="autostart">3. Autostart</h3>
<div class="level3">

<p>
First autostart, if the script is ok.
</p>

<p>
Go to <strong>System → Startup → Local Startup</strong> and type in:
</p>
<pre class="code bash"><span class="sy0">/</span>bin<span class="sy0">/</span>autowol.sh</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;3. Autostart&quot;,&quot;hid&quot;:&quot;autostart&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:7,&quot;range&quot;:&quot;3362-3519&quot;} -->
<h2 class="sectionedit8" id="troubleshooting">Troubleshooting</h2>
<div class="level2">

<p>
Enable debug output:
</p>
<pre class="code bash"><span class="kw2">sh</span> <span class="re5">-x</span> <span class="re5">-v</span> <span class="sy0">/</span>bin<span class="sy0">/</span>autowol.sh</pre>

<p>
Check the log file:
<a href="http://192.168.1.1/wol/" class="urlextern" title="http://192.168.1.1/wol/" rel="ugc nofollow">http://192.168.1.1/wol/</a>
</p>

<p>
Go to <strong>Network → Firewall → Custom Rules</strong> and add this rule:
</p>
<pre class="code bash">iptables <span class="re5">-I</span> FORWARD <span class="nu0">1</span> <span class="re5">-p</span> tcp <span class="re5">-d</span> 192.168.1.1 <span class="re5">-m</span> limit <span class="re5">--limit</span> <span class="nu0">1</span><span class="sy0">/</span>min <span class="re5">-j</span> LOG <span class="re5">--log-prefix</span> <span class="st0">&quot;WOL_LOG:  &quot;</span> <span class="re5">--log-level</span> <span class="nu0">7</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:8,&quot;range&quot;:&quot;3520-&quot;} -->