
<h1 class="sectionedit1" id="expanding_root_partition_and_filesystem">Expanding root partition and filesystem</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Expanding root partition and filesystem&quot;,&quot;hid&quot;:&quot;expanding_root_partition_and_filesystem&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-136&quot;} -->
<h2 class="sectionedit6" id="introduction">Introduction</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> This instruction expands OpenWrt root partition and filesystem on <a href="/docs/guide-user/installation/openwrt_x86" class="wikilink1" title="docs:guide-user:installation:openwrt_x86" data-wiki-id="docs:guide-user:installation:openwrt_x86">x86</a> target.</div>
</li>
<li class="level1"><div class="li"> Follow the automated section for quick setup, or click the expand link below for manual setup.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;137-388&quot;} -->
<h2 class="sectionedit7" id="features">Features</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Support <code>ext4</code> and <code>squashfs</code> image types.</div>
</li>
<li class="level1"><div class="li"> Automatically identify the root partition and filesystem.</div>
</li>
<li class="level1"><div class="li"> Expand the root partition and filesystem using free space.</div>
</li>
<li class="level1"><div class="li"> Preserve the scripts through firmware upgrade.</div>
</li>
<li class="level1"><div class="li"> Automatically run after firmware upgrade.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Features&quot;,&quot;hid&quot;:&quot;features&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;389-683&quot;} -->
<h2 class="sectionedit8" id="instructions_manual">Instructions (manual)</h2>
<div class="level2">
<div class="hiddenGlobal  hiddenActive"><div class="hiddenElements"></div><div class="hiddenHead  hiddenSinceBeginning"><div class="hiddenOnHidden">
<p>
Click to display ⇲
</p>
</div><div class="hiddenOnVisible">
<p>
Click to hide ⇱
</p>
</div></div> <!-- .hiddenHead --><div class="hiddenBody">
<p>
Manual installation of script (C&amp;P)
</p>
<pre class="code bash"><span class="co0"># Configure startup scripts</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>uci-defaults<span class="sy0">/</span><span class="nu0">70</span>-rootpt-resize
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="sy0">!</span> <span class="re5">-e</span> <span class="sy0">/</span>etc<span class="sy0">/</span>rootpt-resize <span class="br0">&#93;</span> \
<span class="sy0">&amp;&amp;</span> <span class="kw3">type</span> parted <span class="sy0">&gt;</span> <span class="sy0">/</span>dev<span class="sy0">/</span>null \
<span class="sy0">&amp;&amp;</span> lock <span class="re5">-n</span> <span class="sy0">/</span>var<span class="sy0">/</span>lock<span class="sy0">/</span>root-resize
<span class="kw1">then</span>
<span class="re2">ROOT_BLK</span>=<span class="st0">&quot;$(readlink -f /sys/dev/block/&quot;</span>$<span class="br0">&#40;</span><span class="kw2">awk</span> <span class="re5">-e</span> \
<span class="st_h">'$9==&quot;/dev/root&quot;{print $3}'</span> <span class="sy0">/</span>proc<span class="sy0">/</span>self<span class="sy0">/</span>mountinfo<span class="br0">&#41;</span><span class="st0">&quot;)&quot;</span>
<span class="re2">ROOT_DISK</span>=<span class="st0">&quot;/dev/<span class="es4">$(basename &quot;${ROOT_BLK%/*}&quot;)</span>&quot;</span>
<span class="re2">ROOT_PART</span>=<span class="st0">&quot;<span class="es3">${ROOT_BLK##*[^0-9]}</span>&quot;</span>
parted <span class="re5">-f</span> <span class="re5">-s</span> <span class="st0">&quot;<span class="es3">${ROOT_DISK}</span>&quot;</span> \
resizepart <span class="st0">&quot;<span class="es3">${ROOT_PART}</span>&quot;</span> <span class="nu0">100</span><span class="sy0">%</span>
mount_root <span class="kw1">done</span>
<span class="kw2">touch</span> <span class="sy0">/</span>etc<span class="sy0">/</span>rootpt-resize
&nbsp;
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-e</span> <span class="sy0">/</span>boot<span class="sy0">/</span>cmdline.txt <span class="br0">&#93;</span>
<span class="kw1">then</span> 
<span class="re2">NEW_UUID</span>=<span class="sy0">`</span>blkid <span class="co1">${ROOT_DISK}</span>p<span class="co1">${ROOT_PART}</span> <span class="sy0">|</span> <span class="kw2">sed</span> <span class="re5">-n</span> <span class="st_h">'s/.*PARTUUID=&quot;\([^&quot;]*\)&quot;.*/\1/p'</span><span class="sy0">`</span>
<span class="kw2">sed</span> <span class="re5">-i</span> <span class="st0">&quot;s/PARTUUID=[^ ]*/PARTUUID=<span class="es3">${NEW_UUID}</span>/&quot;</span> <span class="sy0">/</span>boot<span class="sy0">/</span>cmdline.txt
<span class="kw1">fi</span>
&nbsp;
reboot
<span class="kw1">fi</span>
<span class="kw3">exit</span> <span class="nu0">1</span>
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>uci-defaults<span class="sy0">/</span><span class="nu0">80</span>-rootfs-resize
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="sy0">!</span> <span class="re5">-e</span> <span class="sy0">/</span>etc<span class="sy0">/</span>rootfs-resize <span class="br0">&#93;</span> \
<span class="sy0">&amp;&amp;</span> <span class="br0">&#91;</span> <span class="re5">-e</span> <span class="sy0">/</span>etc<span class="sy0">/</span>rootpt-resize <span class="br0">&#93;</span> \
<span class="sy0">&amp;&amp;</span> <span class="kw3">type</span> losetup <span class="sy0">&gt;</span> <span class="sy0">/</span>dev<span class="sy0">/</span>null \
<span class="sy0">&amp;&amp;</span> <span class="kw3">type</span> resize2fs <span class="sy0">&gt;</span> <span class="sy0">/</span>dev<span class="sy0">/</span>null \
<span class="sy0">&amp;&amp;</span> lock <span class="re5">-n</span> <span class="sy0">/</span>var<span class="sy0">/</span>lock<span class="sy0">/</span>root-resize
<span class="kw1">then</span>
<span class="re2">ROOT_BLK</span>=<span class="st0">&quot;$(readlink -f /sys/dev/block/&quot;</span>$<span class="br0">&#40;</span><span class="kw2">awk</span> <span class="re5">-e</span> \
<span class="st_h">'$9==&quot;/dev/root&quot;{print $3}'</span> <span class="sy0">/</span>proc<span class="sy0">/</span>self<span class="sy0">/</span>mountinfo<span class="br0">&#41;</span><span class="st0">&quot;)&quot;</span>
<span class="re2">ROOT_DEV</span>=<span class="st0">&quot;/dev/<span class="es3">${ROOT_BLK##*/}</span>&quot;</span>
<span class="re2">LOOP_DEV</span>=<span class="st0">&quot;$(awk -e '$5==&quot;</span><span class="sy0">/</span>overlay<span class="st0">&quot;{print $9}' <span class="es1">\
</span>/proc/self/mountinfo)&quot;</span>
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-z</span> <span class="st0">&quot;<span class="es3">${LOOP_DEV}</span>&quot;</span> <span class="br0">&#93;</span>
<span class="kw1">then</span>
<span class="re2">LOOP_DEV</span>=<span class="st0">&quot;<span class="es4">$(losetup -f)</span>&quot;</span>
losetup <span class="st0">&quot;<span class="es3">${LOOP_DEV}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${ROOT_DEV}</span>&quot;</span>
<span class="kw1">fi</span>
resize2fs <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${LOOP_DEV}</span>&quot;</span>
mount_root <span class="kw1">done</span>
<span class="kw2">touch</span> <span class="sy0">/</span>etc<span class="sy0">/</span>rootfs-resize
reboot
<span class="kw1">fi</span>
<span class="kw3">exit</span> <span class="nu0">1</span>
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>sysupgrade.conf
<span class="sy0">/</span>etc<span class="sy0">/</span>uci-defaults<span class="sy0">/</span><span class="nu0">70</span>-rootpt-resize
<span class="sy0">/</span>etc<span class="sy0">/</span>uci-defaults<span class="sy0">/</span><span class="nu0">80</span>-rootfs-resize
EOF</pre>

<p>
Execution 
</p>
<pre class="code bash"><span class="co0"># Install packages</span>
opkg update
opkg <span class="kw2">install</span> parted losetup resize2fs blkid
&nbsp;
<span class="co0"># Expand root partition/filesystem</span>
<span class="kw2">sh</span> <span class="sy0">/</span>etc<span class="sy0">/</span>uci-defaults<span class="sy0">/</span><span class="nu0">70</span>-rootpt-resize</pre>
</div></div>
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Instructions (manual)&quot;,&quot;hid&quot;:&quot;instructions_manual&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;684-2365&quot;} -->
<h2 class="sectionedit9" id="automated">Automated</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Install packages</span>
opkg update
opkg <span class="kw2">install</span> parted losetup resize2fs blkid
&nbsp;
<span class="co0"># Download expand-root.sh</span>
<span class="kw2">wget</span> <span class="re5">-U</span> <span class="st0">&quot;&quot;</span> <span class="re5">-O</span> expand-root.sh <span class="st0">&quot;https://openwrt.org/_export/code/docs/guide-user/advanced/expand_root?codeblock=0&quot;</span>
&nbsp;
<span class="co0"># Source the script (creates /etc/uci-defaults/70-rootpt-resize and /etc/uci-defaults/80-rootpt-resize, and adds them to /etc/sysupgrade.conf so they will be re-run after a sysupgrade)</span>
. .<span class="sy0">/</span>expand-root.sh
&nbsp;
<span class="co0"># Resize root partition and filesystem (will resize partiton, reboot resize filesystem, and reboot again)</span>
<span class="kw2">sh</span> <span class="sy0">/</span>etc<span class="sy0">/</span>uci-defaults<span class="sy0">/</span><span class="nu0">70</span>-rootpt-resize</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Automated&quot;,&quot;hid&quot;:&quot;automated&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:9,&quot;range&quot;:&quot;2366-&quot;} -->