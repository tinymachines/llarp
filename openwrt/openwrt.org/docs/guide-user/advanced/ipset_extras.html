
<h1 class="sectionedit1" id="ip_set_extras">IP set extras</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;IP set extras&quot;,&quot;hid&quot;:&quot;ip_set_extras&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-110&quot;} -->
<h2 class="sectionedit6" id="introduction">Introduction</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> This instruction extends the functionality of <a href="/docs/guide-user/firewall/start" class="wikilink1" title="docs:guide-user:firewall:start" data-wiki-id="docs:guide-user:firewall:start">Firewall</a>.</div>
</li>
<li class="level1"><div class="li"> Follow the <a href="/docs/guide-user/advanced/ipset_extras#automated" class="wikilink1" title="docs:guide-user:advanced:ipset_extras" data-wiki-id="docs:guide-user:advanced:ipset_extras">automated</a> section for quick setup.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;111-333&quot;} -->
<h2 class="sectionedit7" id="features">Features</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Create and populate <abbr title="Internet Protocol">IP</abbr> sets with domains, CIDRs, ASNs and GeoIP.</div>
</li>
<li class="level1"><div class="li"> Populate <abbr title="Internet Protocol">IP</abbr> sets automatically at startup.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Features&quot;,&quot;hid&quot;:&quot;features&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;334-471&quot;} -->
<h2 class="sectionedit8" id="implementation">Implementation</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Rely on <a href="/docs/guide-user/base-system/dhcp#ip_sets" class="wikilink1" title="docs:guide-user:base-system:dhcp" data-wiki-id="docs:guide-user:base-system:dhcp">DNS</a>/<a href="/docs/guide-user/firewall/firewall_configuration#ip_sets" class="wikilink1" title="docs:guide-user:firewall:firewall_configuration" data-wiki-id="docs:guide-user:firewall:firewall_configuration">Firewall</a> <abbr title="Internet Protocol">IP</abbr> set UCI configurations.</div>
</li>
<li class="level1"><div class="li"> Process settings with <a href="https://github.com/openwrt/openwrt/blob/master/package/base-files/files/lib/functions.sh" class="urlextern" title="https://github.com/openwrt/openwrt/blob/master/package/base-files/files/lib/functions.sh" rel="ugc nofollow">OpenWrt functions</a>.</div>
</li>
<li class="level1"><div class="li"> Utilize <a href="/packages/pkgdata/resolveip" class="wikilink1" title="packages:pkgdata:resolveip" data-wiki-id="packages:pkgdata:resolveip">resolveip</a> to resolve domains.</div>
</li>
<li class="level1"><div class="li"> Fetch ASN prefixes using <a href="https://stat.ripe.net/docs/data_api" class="urlextern" title="https://stat.ripe.net/docs/data_api" rel="ugc nofollow">RIPEstat Data API</a>.</div>
</li>
<li class="level1"><div class="li"> Fetch GeoIP data using <a href="https://www.ipdeny.com/ipblocks/" class="urlextern" title="https://www.ipdeny.com/ipblocks/" rel="ugc nofollow">IPdeny GeoIP Data</a>.</div>
</li>
<li class="level1"><div class="li"> Use <a href="/docs/guide-user/advanced/hotplug_extras" class="wikilink1" title="docs:guide-user:advanced:hotplug_extras" data-wiki-id="docs:guide-user:advanced:hotplug_extras">Hotplug extras</a> to trigger setup automatically.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Implementation&quot;,&quot;hid&quot;:&quot;implementation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;472-1127&quot;} -->
<h2 class="sectionedit9" id="commands">Commands</h2>
<div class="level2">
<div class="table sectionedit10"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Sub-command </th><th class="col1"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code><strong>setup</strong></code> </td><td class="col1"> Set up <abbr title="Internet Protocol">IP</abbr> sets. </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code><strong>unset</strong></code> </td><td class="col1"> Unset <abbr title="Internet Protocol">IP</abbr> sets. </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:10,&quot;range&quot;:&quot;1149-1249&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Commands&quot;,&quot;hid&quot;:&quot;commands&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;1128-1250&quot;} -->
<h2 class="sectionedit11" id="instructions">Instructions</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Configure profile</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>ipset.sh
ipset<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">IPSET_CMD</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${IPSET_CMD}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>setup<span class="sy0">|</span><span class="kw3">unset</span><span class="br0">&#41;</span> ipset_proc <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">command</span> ipset <span class="st0">&quot;<span class="es3">${@}</span>&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="br0">&#125;</span>
&nbsp;
ipset_proc<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
. <span class="sy0">/</span>lib<span class="sy0">/</span>functions.sh
config_load dhcp
config_foreach ipset_proc_<span class="st0">&quot;<span class="es3">${IPSET_CMD}</span>&quot;</span> ipset
uci_commit firewall
service firewall reload
fw4 reload-sets
<span class="br0">&#125;</span>
&nbsp;
ipset_proc_setup<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">IPSET_CONF</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">IPSET_TEMP</span>=<span class="st0">&quot;<span class="es4">$(mktemp -t ipset.XXXXXX)</span>&quot;</span>
<span class="br0">&#123;</span>
config_list_foreach <span class="st0">&quot;<span class="es3">${IPSET_CONF}</span>&quot;</span> domain ipset_domain
config_list_foreach <span class="st0">&quot;<span class="es3">${IPSET_CONF}</span>&quot;</span> cidr ipset_cidr
config_list_foreach <span class="st0">&quot;<span class="es3">${IPSET_CONF}</span>&quot;</span> asn ipset_asn
config_list_foreach <span class="st0">&quot;<span class="es3">${IPSET_CONF}</span>&quot;</span> geoip ipset_geoip
<span class="br0">&#125;</span> <span class="sy0">|</span> <span class="kw2">sort</span> <span class="re5">-u</span> <span class="sy0">&gt;</span> <span class="st0">&quot;<span class="es3">${IPSET_TEMP}</span>&quot;</span>
config_list_foreach <span class="st0">&quot;<span class="es3">${IPSET_CONF}</span>&quot;</span> name ipset_<span class="st0">&quot;<span class="es3">${IPSET_CMD}</span>&quot;</span>
<span class="kw2">rm</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${IPSET_TEMP}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
ipset_proc_unset<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">IPSET_CONF</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
config_list_foreach <span class="st0">&quot;<span class="es3">${IPSET_CONF}</span>&quot;</span> name ipset_<span class="st0">&quot;<span class="es3">${IPSET_CMD}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
ipset_setup<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">IPSET_NAME</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">IPSET_FILE</span>=<span class="st0">&quot;/var/ipset-<span class="es3">${IPSET_NAME}</span>&quot;</span>
<span class="kw3">local</span> IPSET_FAMILY
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${IPSET_NAME}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="nu0">6</span><span class="br0">&#41;</span> <span class="re2">IPSET_FAMILY</span>=<span class="st0">&quot;ipv6&quot;</span>
<span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;/\./d&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="re2">IPSET_FAMILY</span>=<span class="st0">&quot;ipv4&quot;</span>
<span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;/:/d&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span> <span class="sy0">&lt;</span> <span class="st0">&quot;<span class="es3">${IPSET_TEMP}</span>&quot;</span> <span class="sy0">&gt;</span> <span class="st0">&quot;<span class="es3">${IPSET_FILE}</span>&quot;</span>
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
set firewall.'${IPSET_NAME//-/_}'='ipset'
set firewall.'${IPSET_NAME//-/_}'.name='${IPSET_NAME}'
set firewall.'${IPSET_NAME//-/_}'.family='${IPSET_FAMILY}'
set firewall.'${IPSET_NAME//-/_}'.match='net'
set firewall.'${IPSET_NAME//-/_}'.loadfile='${IPSET_FILE}'
EOI</span>
<span class="br0">&#125;</span>
&nbsp;
ipset_unset<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">IPSET_NAME</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">IPSET_FILE</span>=<span class="st0">&quot;/var/ipset-<span class="es3">${IPSET_NAME}</span>&quot;</span>
<span class="kw2">rm</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${IPSET_FILE}</span>&quot;</span>
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
delete firewall.'${IPSET_NAME//-/_}'.loadfile
EOI</span>
<span class="br0">&#125;</span>
&nbsp;
ipset_domain<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">IPSET_ENTRY</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
resolveip <span class="st0">&quot;<span class="es3">${IPSET_ENTRY}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
ipset_cidr<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">IPSET_ENTRY</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw3">echo</span> <span class="st0">&quot;<span class="es3">${IPSET_ENTRY}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
ipset_asn<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">IPSET_ENTRY</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw2">wget</span> <span class="re5">-O</span> - <span class="st0">&quot;https://stat.ripe.net/data/<span class="es1">\
</span>announced-prefixes/data.json?resource=<span class="es3">${IPSET_ENTRY}</span>&quot;</span> \
<span class="sy0">|</span> jsonfilter <span class="re5">-e</span> <span class="st0">&quot;@['data']['prefixes'][*]['prefix']&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
ipset_geoip<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">IPSET_ENTRY</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw2">wget</span> <span class="re5">-O</span> - <span class="st0">&quot;https://www.ipdeny.com/ipblocks/data/<span class="es1">\
</span>aggregated/<span class="es3">${IPSET_ENTRY}</span>-aggregated.zone&quot;</span> \
<span class="st0">&quot;https://www.ipdeny.com/ipv6/ipaddresses/<span class="es1">\
</span>aggregated/<span class="es3">${IPSET_ENTRY}</span>-aggregated.zone&quot;</span>
<span class="br0">&#125;</span>
EOF
. <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>ipset.sh
&nbsp;
<span class="co0"># Configure hotplug</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>online
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>online<span class="sy0">/</span><span class="nu0">70</span>-ipset-setup
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-z</span> <span class="st0">&quot;<span class="es3">${TERM}</span>&quot;</span> <span class="br0">&#93;</span> \
<span class="sy0">&amp;&amp;</span> <span class="br0">&#91;</span> <span class="sy0">!</span> <span class="re5">-e</span> <span class="sy0">/</span>var<span class="sy0">/</span>lock<span class="sy0">/</span>ipset-setup <span class="br0">&#93;</span> \
<span class="sy0">||</span> <span class="br0">&#91;</span> <span class="re5">-n</span> <span class="st0">&quot;<span class="es3">${TERM}</span>&quot;</span> <span class="br0">&#93;</span> \
<span class="sy0">&amp;&amp;</span> lock <span class="re5">-n</span> <span class="sy0">/</span>var<span class="sy0">/</span>lock<span class="sy0">/</span>ipset-setup \
<span class="sy0">&amp;&amp;</span> <span class="kw2">sleep</span> <span class="nu0">10</span>
<span class="kw1">then</span> . <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>ipset.sh
ipset setup
lock <span class="re5">-u</span> <span class="sy0">/</span>var<span class="sy0">/</span>lock<span class="sy0">/</span>ipset-setup
<span class="kw1">fi</span>
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>sysupgrade.conf
<span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>online<span class="sy0">/</span><span class="nu0">70</span>-ipset-setup
EOF
&nbsp;
<span class="co0"># Configure cron</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>crontabs<span class="sy0">/</span>root
<span class="nu0">0</span> <span class="sy0">*/</span><span class="nu0">3</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> . <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>online<span class="sy0">/</span><span class="nu0">70</span>-ipset-setup
EOF
service cron restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Instructions&quot;,&quot;hid&quot;:&quot;instructions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:11,&quot;range&quot;:&quot;1251-4011&quot;} -->
<h2 class="sectionedit12" id="examples">Examples</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Install packages</span>
opkg update
opkg <span class="kw2">install</span> resolveip
&nbsp;
<span class="co0"># Configure IP sets, domains, CIDRs and ASNs</span>
uci <span class="kw1">set</span> dhcp.example=<span class="st0">&quot;ipset&quot;</span>
uci add_list dhcp.example.name=<span class="st0">&quot;example&quot;</span>
uci add_list dhcp.example.name=<span class="st0">&quot;example6&quot;</span>
uci add_list dhcp.example.domain=<span class="st0">&quot;example.com&quot;</span>
uci add_list dhcp.example.domain=<span class="st0">&quot;example.net&quot;</span>
uci add_list dhcp.example.cidr=<span class="st0">&quot;9.9.9.9/32&quot;</span>
uci add_list dhcp.example.cidr=<span class="st0">&quot;2620:fe::fe/128&quot;</span>
uci add_list dhcp.example.asn=<span class="st0">&quot;2906&quot;</span>
uci add_list dhcp.example.asn=<span class="st0">&quot;40027&quot;</span>
uci add_list dhcp.example.geoip=<span class="st0">&quot;cn&quot;</span>
uci add_list dhcp.example.geoip=<span class="st0">&quot;ru&quot;</span>
uci commit dhcp
&nbsp;
<span class="co0"># Populate IP sets</span>
ipset setup</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Examples&quot;,&quot;hid&quot;:&quot;examples&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:12,&quot;range&quot;:&quot;4012-4649&quot;} -->
<h2 class="sectionedit13" id="automated">Automated</h2>
<div class="level2">
<pre class="code bash"><span class="kw2">wget</span> <span class="re5">-U</span> <span class="st0">&quot;&quot;</span> <span class="re5">-O</span> ipset-extras.sh <span class="st0">&quot;https://openwrt.org/_export/code/docs/guide-user/advanced/ipset_extras?codeblock=0&quot;</span>
. .<span class="sy0">/</span>ipset-extras.sh</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Automated&quot;,&quot;hid&quot;:&quot;automated&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:13,&quot;range&quot;:&quot;4650-&quot;} -->