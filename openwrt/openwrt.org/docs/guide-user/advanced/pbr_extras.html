
<h1 class="sectionedit1" id="pbr_extras">PBR extras</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;PBR extras&quot;,&quot;hid&quot;:&quot;pbr_extras&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-107&quot;} -->
<h2 class="sectionedit6" id="introduction">Introduction</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> This instruction configures <a href="https://en.wikipedia.org/wiki/Policy-based_routing" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Policy-based_routing">PBR</a> with <a href="/docs/techref/netifd" class="wikilink1" title="docs:techref:netifd" data-wiki-id="docs:techref:netifd">netifd</a> on OpenWrt.</div>
</li>
<li class="level1"><div class="li"> Follow the <a href="/docs/guide-user/advanced/pbr_extras#automated" class="wikilink1" title="docs:guide-user:advanced:pbr_extras" data-wiki-id="docs:guide-user:advanced:pbr_extras">automated</a> section for quick setup.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;108-345&quot;} -->
<h2 class="sectionedit7" id="features">Features</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Utilize multiple upstream interfaces with their own gateways.</div>
</li>
<li class="level1"><div class="li"> Route different subnets/clients to a different gateway.</div>
</li>
<li class="level1"><div class="li"> Prioritize routing for local subnets and tunnel endpoints.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Features&quot;,&quot;hid&quot;:&quot;features&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;346-556&quot;} -->
<h2 class="sectionedit8" id="implementation">Implementation</h2>
<div class="level2">

<p>
Automatically set up <abbr title="Policy Based Routing">PBR</abbr> with netifd:
</p>
<ul>
<li class="level1"><div class="li"> Set up named routing tables for each interface.</div>
</li>
<li class="level1"><div class="li"> Assign each interface to its own routing table.</div>
</li>
<li class="level1"><div class="li"> Create default routes for unmanaged interfaces.</div>
</li>
<li class="level1"><div class="li"> Create default routing rules after subnets/endpoints.</div>
</li>
</ul>

<p>
Create custom routing rules before the default ones.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Implementation&quot;,&quot;hid&quot;:&quot;implementation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;557-889&quot;} -->
<h2 class="sectionedit9" id="commands">Commands</h2>
<div class="level2">
<div class="table sectionedit10"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Sub-command </th><th class="col1"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code><strong>setup</strong></code> </td><td class="col1"> Set up policy-based routing. </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code><strong>unset</strong></code> </td><td class="col1"> Unset policy-based routing. </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:10,&quot;range&quot;:&quot;911-1037&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Commands&quot;,&quot;hid&quot;:&quot;commands&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;890-1038&quot;} -->
<h2 class="sectionedit11" id="instructions">Instructions</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Configure profile</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>pbr.sh
pbr<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">PBR_CMD</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${PBR_CMD}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>setup<span class="sy0">|</span><span class="kw3">unset</span><span class="br0">&#41;</span> pbr_proc <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">command</span> pbr <span class="st0">&quot;<span class="es3">${@}</span>&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="br0">&#125;</span>
&nbsp;
pbr_proc<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
. <span class="sy0">/</span>lib<span class="sy0">/</span>functions.sh
. <span class="sy0">/</span>lib<span class="sy0">/</span>functions<span class="sy0">/</span>network.sh
network_flush_cache
config_load network
config_foreach pbr_iface_proc interface
<span class="kw1">for</span> IPV <span class="kw1">in</span> <span class="nu0">4</span> <span class="nu0">6</span>
<span class="kw1">do</span> pbr_rule_<span class="st0">&quot;<span class="es3">${PBR_CMD}</span>&quot;</span>
<span class="kw1">done</span>
uci commit network
service network restart
<span class="br0">&#125;</span>
&nbsp;
pbr_iface_proc<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">NET_CONF</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw3">local</span> NET_PROTO
config_get NET_PROTO <span class="st0">&quot;<span class="es3">${NET_CONF}</span>&quot;</span> proto
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${NET_CONF}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>loopback<span class="br0">&#41;</span> <span class="kw3">return</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${NET_PROTO}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>gre<span class="sy0">*|</span>vti<span class="sy0">*|</span>vxlan<span class="sy0">|</span>xfrm<span class="sy0">|</span>relay<span class="br0">&#41;</span> <span class="kw3">return</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span>none<span class="br0">&#41;</span> <span class="kw1">for</span> IPV <span class="kw1">in</span> <span class="nu0">4</span> <span class="nu0">6</span>
<span class="kw1">do</span> pbr_route_<span class="st0">&quot;<span class="es3">${PBR_CMD}</span>&quot;</span>
<span class="kw1">done</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw1">for</span> IPV <span class="kw1">in</span> <span class="nu0">4</span> <span class="nu0">6</span>
<span class="kw1">do</span> pbr_table_<span class="st0">&quot;<span class="es3">${PBR_CMD}</span>&quot;</span>
<span class="kw1">done</span>
pbr_ipr_<span class="st0">&quot;<span class="es3">${PBR_CMD}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
pbr_rule_setup<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> NET_CONF
<span class="kw3">eval</span> network_find_wan<span class="st0">&quot;<span class="es3">${IPV%4}</span>&quot;</span> NET_CONF
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
set network.default'${IPV%4}'='rule${IPV%4}'
set network.default'${IPV%4}'.lookup='${NET_CONF%6}'
set network.default'${IPV%4}'.priority='80000'
EOI</span>
<span class="br0">&#125;</span>
&nbsp;
pbr_rule_unset<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
delete network.default'${IPV%4}'
EOI</span>
<span class="br0">&#125;</span>
&nbsp;
pbr_route_setup<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> NET_TARG
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${IPV}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span><span class="nu0">4</span><span class="br0">&#41;</span> <span class="re2">NET_TARG</span>=<span class="st0">&quot;0.0.0.0/0&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="nu0">6</span><span class="br0">&#41;</span> <span class="re2">NET_TARG</span>=<span class="st0">&quot;::/0&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
set network.'${NET_CONF}'_rt'${IPV%4}'='route${IPV%4}'
set network.'${NET_CONF}'_rt'${IPV%4}'.interface='${NET_CONF}'
set network.'${NET_CONF}'_rt'${IPV%4}'.target='${NET_TARG}'
EOI</span>
<span class="br0">&#125;</span>
&nbsp;
pbr_route_unset<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
delete network.'${NET_CONF}'_rt'${IPV%4}'
EOI</span>
<span class="br0">&#125;</span>
&nbsp;
pbr_table_setup<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
set network.'${NET_CONF}'.ip'${IPV}'table='${NET_CONF%6}'
EOI</span>
<span class="br0">&#125;</span>
&nbsp;
pbr_table_unset<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
delete network.'${NET_CONF}'.ip'${IPV}'table
EOI</span>
<span class="br0">&#125;</span>
&nbsp;
pbr_ipr_setup<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw1">if</span> <span class="sy0">!</span> <span class="kw2">grep</span> <span class="re5">-q</span> <span class="re5">-E</span> <span class="re5">-e</span> <span class="st0">&quot;^[0-9]+\s+<span class="es3">${NET_CONF%6}</span>$&quot;</span> \
<span class="sy0">/</span>etc<span class="sy0">/</span>iproute2<span class="sy0">/</span>rt_tables
<span class="kw1">then</span> <span class="kw2">sed</span> <span class="re5">-i</span> <span class="re5">-e</span> <span class="st0">&quot;<span class="es1">\$</span>a $(($(sort -r -n <span class="es1">\
</span>/etc/iproute2/rt_tables 2&gt; /dev/null <span class="es1">\
</span>| grep -o -E -m 1 &quot;</span>^<span class="br0">&#91;</span><span class="nu0">0</span>-<span class="nu0">9</span><span class="br0">&#93;</span>+<span class="st0">&quot;)+1))<span class="es1">\t</span><span class="es3">${NET_CONF%6}</span>&quot;</span> \
<span class="sy0">/</span>etc<span class="sy0">/</span>iproute2<span class="sy0">/</span>rt_tables
<span class="kw1">fi</span>
<span class="br0">&#125;</span>
&nbsp;
pbr_ipr_unset<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw2">sed</span> <span class="re5">-i</span> <span class="re5">-r</span> <span class="re5">-e</span> <span class="st0">&quot;/^[0-9]+\s+<span class="es3">${NET_CONF%6}</span>$/d&quot;</span> \
<span class="sy0">/</span>etc<span class="sy0">/</span>iproute2<span class="sy0">/</span>rt_tables
<span class="br0">&#125;</span>
EOF
. <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>pbr.sh</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Instructions&quot;,&quot;hid&quot;:&quot;instructions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:11,&quot;range&quot;:&quot;1039-3140&quot;} -->
<h2 class="sectionedit12" id="examples">Examples</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Set up PBR</span>
pbr setup</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Examples&quot;,&quot;hid&quot;:&quot;examples&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:12,&quot;range&quot;:&quot;3141-3205&quot;} -->
<h2 class="sectionedit13" id="automated">Automated</h2>
<div class="level2">
<pre class="code bash"><span class="kw2">wget</span> <span class="re5">-U</span> <span class="st0">&quot;&quot;</span> <span class="re5">-O</span> pbr-extras.sh <span class="st0">&quot;https://openwrt.org/_export/code/docs/guide-user/advanced/pbr_extras?codeblock=0&quot;</span>
. .<span class="sy0">/</span>pbr-extras.sh</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Automated&quot;,&quot;hid&quot;:&quot;automated&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:13,&quot;range&quot;:&quot;3206-&quot;} -->