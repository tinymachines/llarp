
<h1 class="sectionedit1" id="sysupgrade_extras">Sysupgrade extras</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Sysupgrade extras&quot;,&quot;hid&quot;:&quot;sysupgrade_extras&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-114&quot;} -->
<h2 class="sectionedit6" id="introduction">Introduction</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> This instruction extends the functionality of <a href="/docs/techref/sysupgrade" class="wikilink1" title="docs:techref:sysupgrade" data-wiki-id="docs:techref:sysupgrade">Sysupgrade</a> on <a href="/docs/guide-user/installation/openwrt_x86" class="wikilink1" title="docs:guide-user:installation:openwrt_x86" data-wiki-id="docs:guide-user:installation:openwrt_x86">x86</a> target.</div>
</li>
<li class="level1"><div class="li"> Follow the <a href="/docs/guide-user/advanced/sysupgrade_extras#automated" class="wikilink1" title="docs:guide-user:advanced:sysupgrade_extras" data-wiki-id="docs:guide-user:advanced:sysupgrade_extras">automated</a> section for quick setup.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;115-396&quot;} -->
<h2 class="sectionedit7" id="features">Features</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Check the latest firmware release available.</div>
</li>
<li class="level1"><div class="li"> Download the firmware image and verify its checksum.</div>
</li>
<li class="level1"><div class="li"> Allow to force/skip upgrade matching the current release.</div>
</li>
<li class="level1"><div class="li"> Save/restore the state of enabled/disabled services.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Features&quot;,&quot;hid&quot;:&quot;features&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;397-643&quot;} -->
<h2 class="sectionedit8" id="options">Options</h2>
<div class="level2">
<div class="table sectionedit9"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Option </th><th class="col1"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code><strong>-A</strong></code> </td><td class="col1"> Download and upgrade firmware if a newer stable release is available. </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code><strong>-U</strong></code> </td><td class="col1"> Download and upgrade firmware for the latest stable release. </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code><strong>-S</strong></code> </td><td class="col1"> Save the current state of enabled/disabled services to UCI. </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code><strong>-R</strong></code> </td><td class="col1"> Restore the state of enabled/disabled services. </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:9,&quot;range&quot;:&quot;664-995&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Options&quot;,&quot;hid&quot;:&quot;options&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;644-996&quot;} -->
<h2 class="sectionedit10" id="instructions">Instructions</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Configure profile</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>sysupgrade.sh
sysupgrade<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">SYSUP_CMD</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${SYSUP_CMD}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>-A<span class="sy0">|</span>-U<span class="br0">&#41;</span> sysupgrade_proc <span class="st0">&quot;<span class="es3">${@}</span>&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span>-S<span class="br0">&#41;</span> service_save <span class="sy0">;;</span>
<span class="br0">&#40;</span>-R<span class="br0">&#41;</span> service_restore <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">command</span> sysupgrade <span class="st0">&quot;<span class="es3">${@}</span>&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="br0">&#125;</span>
&nbsp;
sysupgrade_proc<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
. <span class="sy0">/</span>etc<span class="sy0">/</span>os-release
<span class="kw3">local</span> <span class="re2">SYSUP_VER</span>=<span class="st0">&quot;<span class="es4">$(sysupgrade_ver)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">SYSUP_URL</span>=<span class="st0">&quot;<span class="es4">$(sysupgrade_url)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">SYSUP_REV</span>=<span class="st0">&quot;<span class="es4">$(sysupgrade_rev)</span>&quot;</span>
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="st0">&quot;<span class="es3">${SYSUP_REV}</span>&quot;</span> <span class="sy0">!</span>= <span class="st0">&quot;<span class="es3">${BUILD_ID}</span>&quot;</span> <span class="br0">&#93;</span> \
<span class="sy0">||</span> <span class="br0">&#91;</span> <span class="st0">&quot;<span class="es3">${SYSUP_CMD}</span>&quot;</span> = <span class="st0">&quot;-U&quot;</span> <span class="br0">&#93;</span>
<span class="kw1">then</span> <span class="kw3">shift</span>
<span class="kw3">local</span> <span class="re2">SYSUP_DEV</span>=<span class="st0">&quot;<span class="es4">$(sysupgrade_dev)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">SYSUP_PROF</span>=<span class="st0">&quot;<span class="es4">$(sysupgrade_prof)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">SYSUP_FS</span>=<span class="st0">&quot;<span class="es4">$(sysupgrade_fs)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">SYSUP_TYPE</span>=<span class="st0">&quot;<span class="es4">$(sysupgrade_type)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">SYSUP_EFI</span>=<span class="st0">&quot;<span class="es4">$(sysupgrade_efi)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">SYSUP_IMG</span>=<span class="st0">&quot;<span class="es4">$(sysupgrade_img)</span>&quot;</span>
sysupgrade <span class="st0">&quot;<span class="es3">${@}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${SYSUP_URL}</span>/<span class="es3">${SYSUP_IMG}</span>&quot;</span>
<span class="kw1">fi</span>
<span class="br0">&#125;</span>
&nbsp;
sysupgrade_ver<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${VERSION_ID}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>snapshot<span class="br0">&#41;</span> <span class="kw3">echo</span> <span class="st0">&quot;../snapshots&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw2">wget</span> <span class="re5">-O</span> - \
<span class="st0">&quot;https://api.github.com/repos/openwrt/openwrt/tags&quot;</span> \
<span class="sy0">|</span> jsonfilter <span class="re5">-e</span> <span class="st0">&quot;@[*]['name']&quot;</span> \
<span class="sy0">|</span> <span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;/-rc[0-9]*$/d;s/^v//;q&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="br0">&#125;</span>
&nbsp;
sysupgrade_url<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">echo</span> <span class="st0">&quot;https://downloads.openwrt.org/<span class="es1">\
</span>releases/<span class="es3">${SYSUP_VER}</span>/targets/<span class="es3">${OPENWRT_BOARD}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
sysupgrade_rev<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw2">wget</span> <span class="re5">-O</span> - <span class="st0">&quot;<span class="es3">${SYSUP_URL}</span>/version.buildinfo&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
sysupgrade_dev<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
ubus call system board \
<span class="sy0">|</span> jsonfilter <span class="re5">-e</span> <span class="st0">&quot;@['board_name']&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
sysupgrade_prof<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPENWRT_BOARD}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>x86<span class="sy0">/*</span><span class="br0">&#41;</span> <span class="kw3">echo</span> <span class="st0">&quot;generic&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">echo</span> <span class="st0">&quot;<span class="es3">${SYSUP_DEV//,/_}</span>&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="br0">&#125;</span>
&nbsp;
sysupgrade_fs<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
ubus call system board \
<span class="sy0">|</span> jsonfilter <span class="re5">-e</span> <span class="st0">&quot;@['rootfs_type']&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
sysupgrade_type<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPENWRT_BOARD}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>x86<span class="sy0">/*</span><span class="br0">&#41;</span> <span class="kw3">echo</span> <span class="st0">&quot;combined&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">echo</span> <span class="st0">&quot;sysupgrade&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="br0">&#125;</span>
&nbsp;
sysupgrade_efi<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-d</span> <span class="sy0">/</span>sys<span class="sy0">/</span>firmware<span class="sy0">/</span>efi <span class="br0">&#93;</span>
<span class="kw1">then</span> <span class="kw3">echo</span> <span class="st0">&quot;-efi&quot;</span>
<span class="kw1">fi</span>
<span class="br0">&#125;</span>
&nbsp;
sysupgrade_img<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw2">wget</span> <span class="re5">-O</span> - <span class="st0">&quot;<span class="es3">${SYSUP_URL}</span>/profiles.json&quot;</span> \
<span class="sy0">|</span> jsonfilter <span class="re5">-e</span> <span class="st0">&quot;@['profiles']['<span class="es3">${SYSUP_PROF}</span>']
['images'][@['type']='<span class="es3">${SYSUP_TYPE}</span><span class="es3">${SYSUP_EFI}</span>'
&amp;&amp;@['filesystem']='<span class="es3">${SYSUP_FS}</span>']['name']&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
service_save<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">SVC_NAME</span>=<span class="st0">&quot;<span class="es4">$(ls /etc/init.d)</span>&quot;</span>
<span class="kw3">local</span> SVC_AUTO
<span class="kw1">for</span> SVC_NAME <span class="kw1">in</span> <span class="co1">${SVC_NAME}</span>
<span class="kw1">do</span> <span class="kw1">if</span> <span class="kw3">command</span> service <span class="st0">&quot;<span class="es3">${SVC_NAME}</span>&quot;</span> enabled
<span class="kw1">then</span> <span class="re2">SVC_AUTO</span>=<span class="st0">&quot;enable&quot;</span>
<span class="kw1">else</span> <span class="re2">SVC_AUTO</span>=<span class="st0">&quot;disable&quot;</span>
<span class="kw1">fi</span>
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
set system.service='service'
del_list system.service.enable='${SVC_NAME}'
del_list system.service.disable='${SVC_NAME}'
add_list system.service.'${SVC_AUTO}'='${SVC_NAME}'
EOI</span>
<span class="kw1">done</span>
uci commit system
<span class="br0">&#125;</span>
&nbsp;
service_restore<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> SVC_NAME
<span class="kw3">local</span> <span class="re2">SVC_AUTO</span>=<span class="st0">&quot;enable disable&quot;</span>
<span class="kw1">for</span> SVC_AUTO <span class="kw1">in</span> <span class="co1">${SVC_AUTO}</span>
<span class="kw1">do</span> <span class="re2">SVC_NAME</span>=<span class="st0">&quot;<span class="es4">$(uci -q get system.service.&quot;${SVC_AUTO}&quot;)</span>&quot;</span>
<span class="kw1">for</span> SVC_NAME <span class="kw1">in</span> <span class="co1">${SVC_NAME}</span>
<span class="kw1">do</span> <span class="kw3">command</span> service <span class="st0">&quot;<span class="es3">${SVC_NAME}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${SVC_AUTO}</span>&quot;</span>
<span class="kw1">done</span>
<span class="kw1">done</span>
<span class="br0">&#125;</span>
EOF
. <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>sysupgrade.sh
&nbsp;
<span class="co0"># Configure startup scripts</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>uci-defaults<span class="sy0">/</span><span class="nu0">60</span>-service-restore
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="sy0">!</span> <span class="re5">-e</span> <span class="sy0">/</span>etc<span class="sy0">/</span>service-restore <span class="br0">&#93;</span>
<span class="kw1">then</span> . <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>sysupgrade.sh
sysupgrade <span class="re5">-R</span>
<span class="kw2">touch</span> <span class="sy0">/</span>etc<span class="sy0">/</span>service-restore
<span class="kw1">fi</span>
<span class="kw3">exit</span> <span class="nu0">1</span>
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>sysupgrade.conf
<span class="sy0">/</span>etc<span class="sy0">/</span>uci-defaults<span class="sy0">/</span><span class="nu0">60</span>-service-restore
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Instructions&quot;,&quot;hid&quot;:&quot;instructions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:10,&quot;range&quot;:&quot;997-3828&quot;} -->
<h2 class="sectionedit11" id="examples">Examples</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Automated interactive Sysupgrade</span>
sysupgrade <span class="re5">-A</span> <span class="re5">-i</span>
&nbsp;
<span class="co0"># Forced interactive Sysupgrade</span>
sysupgrade <span class="re5">-U</span> <span class="re5">-i</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Examples&quot;,&quot;hid&quot;:&quot;examples&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:11,&quot;range&quot;:&quot;3829-3972&quot;} -->
<h2 class="sectionedit12" id="automated">Automated</h2>
<div class="level2">
<pre class="code bash"><span class="kw2">wget</span> <span class="re5">-U</span> <span class="st0">&quot;&quot;</span> <span class="re5">-O</span> sysupgrade-extras.sh <span class="st0">&quot;https://openwrt.org/_export/code/docs/guide-user/advanced/sysupgrade_extras?codeblock=0&quot;</span>
. .<span class="sy0">/</span>sysupgrade-extras.sh</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Automated&quot;,&quot;hid&quot;:&quot;automated&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:12,&quot;range&quot;:&quot;3973-&quot;} -->