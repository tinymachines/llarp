
<h1 class="sectionedit1" id="opkg_extras">Opkg extras</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Opkg extras&quot;,&quot;hid&quot;:&quot;opkg_extras&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-108&quot;} -->
<h2 class="sectionedit6" id="introduction">Introduction</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> This instruction extends the functionality of <a href="/docs/guide-user/additional-software/opkg" class="wikilink1" title="docs:guide-user:additional-software:opkg" data-wiki-id="docs:guide-user:additional-software:opkg">Opkg</a>.</div>
</li>
<li class="level1"><div class="li"> Follow the <a href="/docs/guide-user/advanced/opkg_extras#automated" class="wikilink1" title="docs:guide-user:advanced:opkg_extras" data-wiki-id="docs:guide-user:advanced:opkg_extras">automated</a> section for quick setup.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;109-336&quot;} -->
<h2 class="sectionedit7" id="features">Features</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Save, restore and roll back Opkg profiles.</div>
</li>
<li class="level1"><div class="li"> Support automatic and custom profiles.</div>
</li>
<li class="level1"><div class="li"> Support RWM, overlay and extroot setup.</div>
</li>
<li class="level1"><div class="li"> Identify user-removed/installed packages.</div>
</li>
<li class="level1"><div class="li"> Restore automatically after firmware upgrade.</div>
</li>
<li class="level1"><div class="li"> Upgrade all upgradable packages.</div>
</li>
<li class="level1"><div class="li"> Fix symbolic links for installed alternatives.</div>
</li>
<li class="level1"><div class="li"> Find new configurations for upgraded packages.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Features&quot;,&quot;hid&quot;:&quot;features&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;337-727&quot;} -->
<h2 class="sectionedit8" id="implementation">Implementation</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Wrap Opkg calls to provide a seamless invocation method.</div>
</li>
<li class="level1"><div class="li"> Rely on <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">UCI</a> and <a href="https://github.com/openwrt/openwrt/blob/master/package/base-files/Makefile#L47" class="urlextern" title="https://github.com/openwrt/openwrt/blob/master/package/base-files/Makefile#L47" rel="ugc nofollow">backup defaults</a> to store and manage profiles.</div>
</li>
<li class="level1"><div class="li"> Identify package types with <a href="http://man.cx/grep%281%29" class="interwiki iw_man" title="http://man.cx/grep%281%29">grep</a> and <a href="http://man.cx/find%281%29" class="interwiki iw_man" title="http://man.cx/find%281%29">find</a>, and RWM with <a href="http://man.cx/mount%288%29" class="interwiki iw_man" title="http://man.cx/mount%288%29">mount</a>.</div>
</li>
<li class="level1"><div class="li"> Support importing <a href="https://github.com/openwrt/openwrt/blob/master/package/base-files/files/sbin/sysupgrade#L249-L255" class="urlextern" title="https://github.com/openwrt/openwrt/blob/master/package/base-files/files/sbin/sysupgrade#L249-L255" rel="ugc nofollow">user-installed</a> packages from <a href="/docs/techref/sysupgrade" class="wikilink1" title="docs:techref:sysupgrade" data-wiki-id="docs:techref:sysupgrade">Sysupgrade</a>.</div>
</li>
<li class="level1"><div class="li"> Use <a href="/docs/guide-user/advanced/hotplug_extras" class="wikilink1" title="docs:guide-user:advanced:hotplug_extras" data-wiki-id="docs:guide-user:advanced:hotplug_extras">Hotplug extras</a> to detect <abbr title="Wide Area Network">WAN</abbr> connectivity and trigger profile restore.</div>
</li>
<li class="level1"><div class="li"> Utilize lockfiles with <a href="https://github.com/openwrt/openwrt/blob/master/package/utils/busybox/patches/220-add_lock_util.patch" class="urlextern" title="https://github.com/openwrt/openwrt/blob/master/package/utils/busybox/patches/220-add_lock_util.patch" rel="ugc nofollow">lock</a> to avoid race conditions and loops.</div>
</li>
<li class="level1"><div class="li"> Perform <a href="http://man.cx/reboot%288%29" class="interwiki iw_man" title="http://man.cx/reboot%288%29">reboot</a> to apply changes after automatic profile restore.</div>
</li>
<li class="level1"><div class="li"> Fetch the default profile to restore and roll back from UCI, unless specified manually.</div>
</li>
<li class="level1"><div class="li"> Take precedence for remove over install to avoid package conflicts while restoring profile.</div>
</li>
<li class="level1"><div class="li"> Limit the operation scope to save time: remove installed, install missing, upgrade upgradable.</div>
</li>
<li class="level1"><div class="li"> Process packages one by one to minimize resource consumption and avoid transaction failure.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Implementation&quot;,&quot;hid&quot;:&quot;implementation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;728-2076&quot;} -->
<h2 class="sectionedit9" id="commands">Commands</h2>
<div class="level2">
<div class="table sectionedit10"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Sub-command </th><th class="col1"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code><strong>init</strong></code> </td><td class="col1"> Initialize Opkg configuration. </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code><strong>uci</strong> [&lt;prof&gt;] &lt; &lt;uciprof&gt;</code> </td><td class="col1"> Import Opkg profile from stdin or file to UCI. </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code><strong>import</strong> [&lt;bakprof&gt;]</code> </td><td class="col1"> Import Opkg profile from Sysupgrade backup to UCI. </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code><strong>save</strong></code> </td><td class="col1"> Save the current Opkg profile to UCI. </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <code><strong>restore</strong> [&lt;prof&gt;]</code> </td><td class="col1"> Restore Opkg profile:<br/>
<code>main</code> or none - default profile,<br/>
<code>init</code> - RWM/minimal profile,<br/>
<code>custom</code> - custom profile. </td>
	</tr>
	<tr class="row6">
		<td class="col0"> <code><strong>rollback</strong> [&lt;prof&gt;]</code> </td><td class="col1"> Roll back Opkg profile:<br/>
remove user-installed packages,<br/>
install user-removed packages,<br/>
skip upgraded packages. </td>
	</tr>
	<tr class="row7">
		<td class="col0"> <code><strong>upgr</strong> [&lt;pkgtype&gt;]</code> </td><td class="col1"> Upgrade packages by type:<br/>
<code>ai</code> or none - all installed,<br/>
<code>oi</code> - overlay-installed. </td>
	</tr>
	<tr class="row8">
		<td class="col0"> <code><strong>export</strong> [&lt;pkgtype&gt;]</code> </td><td class="col1"> Export packages by type:<br/>
<code>ai</code> or none - all installed,<br/>
<code>au</code> - all upgradable,<br/>
<code>ri</code> - ROM-installed,<br/>
<code>wr</code> - RWM-removed,<br/>
<code>wi</code> - RWM-installed,<br/>
<code>or</code> - overlay-removed,<br/>
<code>oi</code> - overlay-installed,<br/>
<code>ur</code> - user-removed,<br/>
<code>ui</code> - user-installed,<br/>
<code>pr</code> - profile-removed,<br/>
<code>pi</code> - profile-installed. </td>
	</tr>
	<tr class="row9">
		<td class="col0"> <code><strong>proc</strong> &lt;cmd&gt; &lt; &lt;pkgs&gt;</code> </td><td class="col1"> Process packages from stdin with the given sub-command. </td>
	</tr>
	<tr class="row10">
		<td class="col0"> <code><strong>reinstall</strong> &lt;pkgs&gt;</code> </td><td class="col1"> Reinstall specific packages. </td>
	</tr>
	<tr class="row11">
		<td class="col0"> <code><strong>altlink</strong></code> </td><td class="col1"> Fix symbolic links for installed alternatives. </td>
	</tr>
	<tr class="row12">
		<td class="col0"> <code><strong>newconf</strong> [&lt;path&gt;]</code> </td><td class="col1"> Find new configurations for upgraded packages. </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:10,&quot;range&quot;:&quot;2098-3490&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Commands&quot;,&quot;hid&quot;:&quot;commands&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;2077-3491&quot;} -->
<h2 class="sectionedit11" id="instructions">Instructions</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Configure profile</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>opkg.sh
opkg<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_CMD</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_UCI</span>=<span class="st0">&quot;<span class="es4">$(uci -q get opkg.defaults.&quot;${OPKG_CMD}&quot;)</span>&quot;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPKG_CMD}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>init<span class="sy0">|</span>uci<span class="sy0">|</span>import<span class="sy0">|</span>save<span class="sy0">|</span>restore<span class="sy0">|</span>rollback<span class="sy0">|</span>upgr\
<span class="sy0">|</span><span class="kw3">export</span><span class="sy0">|</span>proc<span class="sy0">|</span>reinstall<span class="sy0">|</span>altlink<span class="sy0">|</span>newconf<span class="br0">&#41;</span> opkg_<span class="st0">&quot;<span class="es3">${@}</span>&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">command</span> opkg <span class="st0">&quot;<span class="es3">${@}</span>&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_init<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
uci import opkg <span class="sy0">&lt;</span> <span class="sy0">/</span>dev<span class="sy0">/</span>null
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
set opkg.defaults='opkg'
set opkg.defaults.import='/etc/backup/installed_packages.txt'
set opkg.defaults.restore='init main'
set opkg.defaults.rollback='main'
set opkg.defaults.upgr='ai'
set opkg.defaults.export='ai'
set opkg.defaults.proc='--force-depends'
set opkg.defaults.reinstall='--force-reinstall'
set opkg.defaults.newconf='/etc'
EOI</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_uci<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OPT</span>=<span class="st0">&quot;<span class="es3">${1:-${OPKG_UCI}</span>}&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OPT</span>=<span class="st0">&quot;<span class="es3">${OPKG_OPT:-main}</span>&quot;</span>
<span class="kw1">if</span> <span class="sy0">!</span> uci <span class="re5">-q</span> get opkg <span class="sy0">&gt;</span> <span class="sy0">/</span>dev<span class="sy0">/</span>null
<span class="kw1">then</span> opkg init
<span class="kw1">fi</span>
uci <span class="re5">-q</span> batch <span class="co2">&lt;&lt; EOI
delete opkg.'${OPKG_OPT}'
set opkg.'${OPKG_OPT}'='opkg'
$(sed -r -e &quot;s/^(.*)\s(.*)$/\
del_list opkg.'${OPKG_OPT}'.'\2'='\1'\n\
add_list opkg.'${OPKG_OPT}'.'\2'='\1'/&quot;)
commit opkg
EOI</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_import<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OPT</span>=<span class="st0">&quot;<span class="es3">${1:-${OPKG_UCI}</span>}&quot;</span>
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-e</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT}</span>&quot;</span> <span class="br0">&#93;</span>
<span class="kw1">then</span> <span class="kw2">sed</span> <span class="re5">-n</span> <span class="re5">-r</span> <span class="re5">-e</span> <span class="st0">&quot;s/\s(overlay|unknown)$/<span class="es1">\
</span><span class="es1">\t</span>ipkg/p&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT}</span>&quot;</span> \
<span class="sy0">|</span> opkg uci main
<span class="kw1">fi</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_save<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_WR</span>=<span class="st0">&quot;<span class="es4">$(opkg export wr)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_WI</span>=<span class="st0">&quot;<span class="es4">$(opkg export wi)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_UR</span>=<span class="st0">&quot;<span class="es4">$(opkg export ur)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_UI</span>=<span class="st0">&quot;<span class="es4">$(opkg export ui)</span>&quot;</span>
<span class="kw1">if</span> uci <span class="re5">-q</span> get fstab.rwm <span class="sy0">&gt;</span> <span class="sy0">/</span>dev<span class="sy0">/</span>null \
<span class="sy0">&amp;&amp;</span> <span class="kw2">grep</span> <span class="re5">-q</span> <span class="re5">-e</span> <span class="st0">&quot;\s/rwm\s&quot;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>mtab
<span class="kw1">then</span> <span class="br0">&#123;</span>
<span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;s/$/<span class="es1">\t</span>rpkg/&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_WR}</span>&quot;</span>
<span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;s/$/<span class="es1">\t</span>ipkg/&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_WI}</span>&quot;</span>
<span class="br0">&#125;</span> <span class="sy0">|</span> opkg uci init
<span class="kw1">fi</span>
<span class="br0">&#123;</span>
<span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;s/$/<span class="es1">\t</span>rpkg/&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_UR}</span>&quot;</span>
<span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;s/$/<span class="es1">\t</span>ipkg/&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_UI}</span>&quot;</span>
<span class="br0">&#125;</span> <span class="sy0">|</span> opkg uci main
<span class="kw2">rm</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_WR}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_WI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_UR}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_UI}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_restore<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OPT</span>=<span class="st0">&quot;<span class="es3">${1:-${OPKG_UCI}</span>}&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_CONF</span>=<span class="st0">&quot;<span class="es3">${OPKG_OPT}</span>&quot;</span>
<span class="kw1">for</span> OPKG_CONF <span class="kw1">in</span> <span class="co1">${OPKG_CONF}</span>
<span class="kw1">do</span>
<span class="kw3">local</span> <span class="re2">OPKG_AI</span>=<span class="st0">&quot;<span class="es4">$(opkg export ai)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_PR</span>=<span class="st0">&quot;<span class="es4">$(opkg export pr)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_PI</span>=<span class="st0">&quot;<span class="es4">$(opkg export pi)</span>&quot;</span>
<span class="kw2">grep</span> <span class="re5">-x</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_AI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_PR}</span>&quot;</span> \
<span class="sy0">|</span> opkg proc remove
<span class="kw2">grep</span> <span class="re5">-v</span> <span class="re5">-x</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_AI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_PI}</span>&quot;</span> \
<span class="sy0">|</span> opkg proc <span class="kw2">install</span>
<span class="kw2">rm</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_AI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_PR}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_PI}</span>&quot;</span>
<span class="kw1">done</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_rollback<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OPT</span>=<span class="st0">&quot;<span class="es3">${1:-${OPKG_UCI}</span>}&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_CONF</span>=<span class="st0">&quot;<span class="es3">${OPKG_OPT}</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_UR</span>=<span class="st0">&quot;<span class="es4">$(opkg export ur)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_UI</span>=<span class="st0">&quot;<span class="es4">$(opkg export ui)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_PR</span>=<span class="st0">&quot;<span class="es4">$(opkg export pr)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_PI</span>=<span class="st0">&quot;<span class="es4">$(opkg export pi)</span>&quot;</span>
<span class="kw1">if</span> uci <span class="re5">-q</span> get opkg.<span class="st0">&quot;<span class="es3">${OPKG_CONF}</span>&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>dev<span class="sy0">/</span>null
<span class="kw1">then</span> opkg restore <span class="st0">&quot;<span class="es3">${OPKG_CONF}</span>&quot;</span>
<span class="kw2">grep</span> <span class="re5">-v</span> <span class="re5">-x</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_PI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_UI}</span>&quot;</span> \
<span class="sy0">|</span> opkg proc remove
<span class="kw2">grep</span> <span class="re5">-v</span> <span class="re5">-x</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_PR}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_UR}</span>&quot;</span> \
<span class="sy0">|</span> opkg proc <span class="kw2">install</span>
<span class="kw1">fi</span>
<span class="kw2">rm</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_UR}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_UI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_PR}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_PI}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_upgr<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OPT</span>=<span class="st0">&quot;<span class="es3">${1:-${OPKG_UCI}</span>}&quot;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>ai<span class="sy0">|</span>oi<span class="br0">&#41;</span> opkg_<span class="st0">&quot;<span class="es3">${OPKG_CMD}</span>&quot;</span>_type <span class="sy0">;;</span>
<span class="kw1">esac</span> <span class="sy0">|</span> opkg proc upgrade
<span class="br0">&#125;</span>
&nbsp;
opkg_upgr_type<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_AI</span>=<span class="st0">&quot;<span class="es4">$(opkg export ai)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OI</span>=<span class="st0">&quot;<span class="es4">$(opkg export oi)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_AU</span>=<span class="st0">&quot;<span class="es4">$(opkg export au)</span>&quot;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT::1}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>a<span class="br0">&#41;</span> <span class="kw2">grep</span> <span class="re5">-x</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_AI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_AU}</span>&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span>o<span class="br0">&#41;</span> <span class="kw2">grep</span> <span class="re5">-x</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_OI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_AU}</span>&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw2">rm</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_AI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_OI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_AU}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_export<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OPT</span>=<span class="st0">&quot;<span class="es3">${1:-${OPKG_UCI}</span>}&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_TEMP</span>=<span class="st0">&quot;<span class="es4">$(mktemp -t opkg.XXXXXX)</span>&quot;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>ai<span class="sy0">|</span>au<span class="br0">&#41;</span> opkg_<span class="st0">&quot;<span class="es3">${OPKG_CMD}</span>&quot;</span>_cmd <span class="sy0">;;</span>
<span class="br0">&#40;</span>ri<span class="sy0">|</span>wr<span class="sy0">|</span>wi<span class="sy0">|</span>or<span class="sy0">|</span>oi<span class="br0">&#41;</span> opkg_<span class="st0">&quot;<span class="es3">${OPKG_CMD}</span>&quot;</span>_type <span class="sy0">;;</span>
<span class="br0">&#40;</span>ur<span class="sy0">|</span>ui<span class="br0">&#41;</span> opkg_<span class="st0">&quot;<span class="es3">${OPKG_CMD}</span>&quot;</span>_run <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="kw2">pr</span><span class="sy0">|</span>pi<span class="br0">&#41;</span> opkg_<span class="st0">&quot;<span class="es3">${OPKG_CMD}</span>&quot;</span>_uci <span class="sy0">;;</span>
<span class="kw1">esac</span> <span class="sy0">&gt;</span> <span class="st0">&quot;<span class="es3">${OPKG_TEMP}</span>&quot;</span>
<span class="kw3">echo</span> <span class="st0">&quot;<span class="es3">${OPKG_TEMP}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_export_cmd<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> OPKG_TYPE
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT:1}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>i<span class="br0">&#41;</span> <span class="re2">OPKG_TYPE</span>=<span class="st0">&quot;installed&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span>u<span class="br0">&#41;</span> <span class="re2">OPKG_TYPE</span>=<span class="st0">&quot;upgradable&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
opkg list-<span class="st0">&quot;<span class="es3">${OPKG_TYPE}</span>&quot;</span> \
<span class="sy0">|</span> <span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;s/\s.*$//&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_export_type<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_INFO</span>=<span class="st0">&quot;/usr/lib/opkg/info&quot;</span>
<span class="kw3">local</span> OPKG_TYPE
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT::1}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>r<span class="br0">&#41;</span> <span class="re2">OPKG_INFO</span>=<span class="st0">&quot;/rom<span class="es3">${OPKG_INFO}</span>&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="kw2">w</span><span class="br0">&#41;</span> <span class="re2">OPKG_INFO</span>=<span class="st0">&quot;/rwm/upper<span class="es3">${OPKG_INFO}</span>&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span>o<span class="br0">&#41;</span> <span class="re2">OPKG_INFO</span>=<span class="st0">&quot;/overlay/upper<span class="es3">${OPKG_INFO}</span>&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT:1}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>r<span class="br0">&#41;</span> <span class="re2">OPKG_TYPE</span>=<span class="st0">&quot;c&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span>i<span class="br0">&#41;</span> <span class="re2">OPKG_TYPE</span>=<span class="st0">&quot;f&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw2">find</span> <span class="st0">&quot;<span class="es3">${OPKG_INFO}</span>&quot;</span> <span class="re5">-name</span> <span class="st0">&quot;*.control&quot;</span> \
<span class="re5">-type</span> <span class="st0">&quot;<span class="es3">${OPKG_TYPE}</span>&quot;</span> <span class="nu0">2</span><span class="sy0">&gt;</span> <span class="sy0">/</span>dev<span class="sy0">/</span>null \
<span class="sy0">|</span> <span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;s/^.*\///;s/\.control$//&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_export_run<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_AI</span>=<span class="st0">&quot;<span class="es4">$(opkg export ai)</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_RI</span>=<span class="st0">&quot;<span class="es4">$(opkg export ri)</span>&quot;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT:1}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>r<span class="br0">&#41;</span> <span class="kw2">grep</span> <span class="re5">-v</span> <span class="re5">-x</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_AI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_RI}</span>&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span>i<span class="br0">&#41;</span> <span class="kw2">grep</span> <span class="re5">-v</span> <span class="re5">-x</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_RI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_AI}</span>&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw2">rm</span> <span class="re5">-f</span> <span class="st0">&quot;<span class="es3">${OPKG_AI}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_RI}</span>&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_export_uci<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> OPKG_TYPE
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT:1}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>r<span class="br0">&#41;</span> <span class="re2">OPKG_TYPE</span>=<span class="st0">&quot;rpkg&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span>i<span class="br0">&#41;</span> <span class="re2">OPKG_TYPE</span>=<span class="st0">&quot;ipkg&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
uci <span class="re5">-q</span> get opkg.<span class="st0">&quot;<span class="es3">${OPKG_CONF}</span>&quot;</span>.<span class="st0">&quot;<span class="es3">${OPKG_TYPE}</span>&quot;</span> \
<span class="sy0">|</span> <span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;s/\s/<span class="es1">\n</span>/g&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_proc<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OPT</span>=<span class="st0">&quot;<span class="es3">${OPKG_UCI}</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">OPKG_CMD</span>=<span class="st0">&quot;<span class="es3">${1:?}</span>&quot;</span>
<span class="kw3">local</span> OPKG_PKG
<span class="kw1">while</span> <span class="kw3">read</span> <span class="re5">-r</span> OPKG_PKG
<span class="kw1">do</span> opkg <span class="st0">&quot;<span class="es3">${OPKG_CMD}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_PKG}</span>&quot;</span> <span class="co1">${OPKG_OPT}</span>
<span class="kw1">done</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_reinstall<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OPT</span>=<span class="st0">&quot;<span class="es3">${OPKG_UCI}</span>&quot;</span>
opkg <span class="kw2">install</span> <span class="st0">&quot;<span class="es3">${@}</span>&quot;</span> <span class="co1">${OPKG_OPT}</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_altlink<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw2">sed</span> <span class="re5">-n</span> <span class="re5">-e</span> <span class="st0">&quot;/^Alternatives:/<span class="es1">\
</span>{s/^\S*\s*//;s/,\s/<span class="es1">\n</span>/gp}&quot;</span> <span class="sy0">/</span>usr<span class="sy0">/</span>lib<span class="sy0">/</span>opkg<span class="sy0">/</span>status \
<span class="sy0">|</span> <span class="kw2">sort</span> <span class="re5">-n</span> <span class="re5">-t</span> <span class="st0">&quot;:&quot;</span> \
<span class="sy0">|</span> <span class="kw1">while</span> <span class="re2">IFS</span>=<span class="st0">&quot;:&quot;</span> <span class="kw3">read</span> <span class="re5">-r</span> OPKG_PRIO OPKG_LINK OPKG_ALT
<span class="kw1">do</span> <span class="kw2">ln</span> <span class="re5">-f</span> <span class="re5">-s</span> <span class="st0">&quot;<span class="es3">${OPKG_ALT}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${OPKG_LINK}</span>&quot;</span>
<span class="kw1">done</span>
<span class="br0">&#125;</span>
&nbsp;
opkg_newconf<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">OPKG_OPT</span>=<span class="st0">&quot;<span class="es3">${1:-${OPKG_UCI}</span>}&quot;</span>
<span class="kw2">find</span> <span class="st0">&quot;<span class="es3">${OPKG_OPT}</span>&quot;</span> <span class="re5">-name</span> <span class="st0">&quot;*-opkg&quot;</span>
<span class="br0">&#125;</span>
EOF
. <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>opkg.sh
&nbsp;
<span class="co0"># Configure hotplug</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>online
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>online<span class="sy0">/</span><span class="nu0">50</span>-opkg-restore
<span class="re2">OPKG_CONF</span>=<span class="st0">&quot;<span class="es4">$(uci -q get opkg.defaults.restore)</span>&quot;</span>
<span class="kw1">for</span> OPKG_CONF <span class="kw1">in</span> <span class="co1">${OPKG_CONF}</span>
<span class="kw1">do</span> <span class="kw1">if</span> <span class="br0">&#91;</span> <span class="sy0">!</span> <span class="re5">-e</span> <span class="sy0">/</span>etc<span class="sy0">/</span>opkg-restore-<span class="st0">&quot;<span class="es3">${OPKG_CONF}</span>&quot;</span> <span class="br0">&#93;</span> \
<span class="sy0">&amp;&amp;</span> lock <span class="re5">-n</span> <span class="sy0">/</span>var<span class="sy0">/</span>lock<span class="sy0">/</span>opkg-restore \
<span class="sy0">&amp;&amp;</span> <span class="kw2">sleep</span> <span class="nu0">10</span> \
<span class="sy0">&amp;&amp;</span> opkg update
<span class="kw1">then</span> . <span class="sy0">/</span>etc<span class="sy0">/</span>profile.d<span class="sy0">/</span>opkg.sh
opkg restore <span class="st0">&quot;<span class="es3">${OPKG_CONF}</span>&quot;</span> <span class="sy0">&amp;&gt;</span> \
<span class="sy0">/</span>var<span class="sy0">/</span>log<span class="sy0">/</span>opkg-restore-<span class="st0">&quot;<span class="es3">${OPKG_CONF}</span>&quot;</span>
<span class="kw2">touch</span> <span class="sy0">/</span>etc<span class="sy0">/</span>opkg-restore-<span class="st0">&quot;<span class="es3">${OPKG_CONF}</span>&quot;</span>
lock <span class="re5">-u</span> <span class="sy0">/</span>var<span class="sy0">/</span>lock<span class="sy0">/</span>opkg-restore
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${OPKG_CONF}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>init<span class="br0">&#41;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> reboot <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw3">break</span>
<span class="kw1">fi</span>
<span class="kw1">done</span>
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>sysupgrade.conf
<span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>online<span class="sy0">/</span><span class="nu0">50</span>-opkg-restore
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Instructions&quot;,&quot;hid&quot;:&quot;instructions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:11,&quot;range&quot;:&quot;3492-9068&quot;} -->
<h2 class="sectionedit12" id="examples">Examples</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Save Opkg profile</span>
opkg save
&nbsp;
<span class="co0"># Restore Opkg profile</span>
opkg update
opkg restore
&nbsp;
<span class="co0"># Roll back Opkg profile</span>
opkg rollback
&nbsp;
<span class="co0"># Set up Opkg profiles</span>
uci <span class="kw1">set</span> opkg.defaults.restore=<span class="st0">&quot;init custom&quot;</span>
uci <span class="kw1">set</span> opkg.init=<span class="st0">&quot;opkg&quot;</span>
uci add_list opkg.init.ipkg=<span class="st0">&quot;losetup&quot;</span>
uci add_list opkg.init.ipkg=<span class="st0">&quot;parted&quot;</span>
uci add_list opkg.init.ipkg=<span class="st0">&quot;resize2fs&quot;</span>
uci <span class="kw1">set</span> opkg.custom=<span class="st0">&quot;opkg&quot;</span>
uci add_list opkg.custom.rpkg=<span class="st0">&quot;dnsmasq&quot;</span>
uci add_list opkg.custom.rpkg=<span class="st0">&quot;ppp&quot;</span>
uci add_list opkg.custom.ipkg=<span class="st0">&quot;curl&quot;</span>
uci add_list opkg.custom.ipkg=<span class="st0">&quot;diffutils&quot;</span>
uci add_list opkg.custom.ipkg=<span class="st0">&quot;dnsmasq-full&quot;</span>
uci commit opkg
&nbsp;
<span class="co0"># Check Opkg log</span>
<span class="kw2">tail</span> <span class="re5">-f</span> <span class="sy0">/</span>var<span class="sy0">/</span>log<span class="sy0">/</span>opkg-<span class="sy0">*</span>
&nbsp;
<span class="co0"># Upgrade packages</span>
opkg update
opkg upgr
&nbsp;
<span class="co0"># Maintenance</span>
opkg altlink
opkg newconf</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Examples&quot;,&quot;hid&quot;:&quot;examples&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:12,&quot;range&quot;:&quot;9069-9805&quot;} -->
<h2 class="sectionedit13" id="automated">Automated</h2>
<div class="level2">
<pre class="code bash"><span class="kw2">wget</span> <span class="re5">-U</span> <span class="st0">&quot;&quot;</span> <span class="re5">-O</span> opkg-extras.sh <span class="st0">&quot;https://openwrt.org/_export/code/docs/guide-user/advanced/opkg_extras?codeblock=0&quot;</span>
. .<span class="sy0">/</span>opkg-extras.sh</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Automated&quot;,&quot;hid&quot;:&quot;automated&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:13,&quot;range&quot;:&quot;9806-&quot;} -->