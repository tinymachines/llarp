
<h1 class="sectionedit1" id="usb_guest_configuration">USB Guest configuration</h1>
<div class="level1">

<p>
Also called USB OTG.<br/>

This Linux functionality is a bit obscure to most people yet very commonplace in consumer embedded linux devices. It allows to connect your device as if it was a USB peripheral of various types (serial port, usb storage, ethernet port, CD drive, audio device, keyboard/mouse and more).
</p>

<p>
To make an example, most modern 3G/4G dongles use this functionality to show themselves as: ethernet port (to provide the network connection), some serial ports (for comntrolling them), a CD drive (that holds an installer for some program to use them on Windows/MacOS) and usb storage (if they have a microSDcard port). Yes, there is a Linux system inside them, among other things.
</p>

<p>
Also most Android phones can do this, to show themselves as mass storage (usually not anymore in newer phones), to show themselves as MTP devices (most modern smartphones do this) so you can transfer files over, and as ethernet ports (when you enable usb tethering).
</p>

<p>
This feature requires hardware support and its own drivers, and some kind of system configuration before being used.
</p>

<p>
The USB port you use with this feature must be native, not generated by independent controllers (connected over PCIe usually), nor by a USB hub (that has a well-defined upstream port and downstream ports).
</p>

<p>
Most of the info in this article was taken from <a href="http://trac.gateworks.com/wiki/linux/OTG" class="urlextern" title="http://trac.gateworks.com/wiki/linux/OTG" rel="ugc nofollow">Gatework&#039;s wiki</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;USB Guest configuration&quot;,&quot;hid&quot;:&quot;usb_guest_configuration&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-1435&quot;} -->
<h2 class="sectionedit2" id="available_modes_and_their_drivers_in_linux_kernel">Available modes and their drivers (in linux kernel)</h2>
<div class="level2">

<p>
The device needs to have a &#039;Gadget driver&#039; loaded which implements the personality of the device(s) type you want. Note that most devices won&#039;t have so much drivers to choose from in LEDE because none packaged them (as most functions are very niche).
</p>

<p>
There are several Linux gadget drivers in today&#039;s linux kernel. These can be found under the <strong>Device Drivers → USB support → USB Gadget Support</strong> menu in the Linux kernel menuconfig (NOT in LEDE&#039;s menuconfig):
</p>
<ul>
<li class="level1"><div class="li"><strong>g_zero</strong> (CONFIG_USB_ZERO)</div>
</li>
<li class="level1"><div class="li"><strong>g_audio</strong> (CONFIG_USB_AUDIO)</div>
</li>
<li class="level1"><div class="li"><strong>g_ether</strong> (CONFIG_USB_ETH) - implement a &#039;Communication Device Class&#039; (CDC) Ethernet device to create a &#039;USB to Ethernet&#039; network connection.</div>
</li>
<li class="level1"><div class="li"><strong>g_ncm</strong> (CONFIG_USB_G_NCM) - implement USB CDC NCM subclass standard. NCM is an advanced protocol for Ethernet encapsulation and allows grouping of several ethernet frames into one USB transfer.</div>
</li>
<li class="level1"><div class="li"><strong>g_mass_storage</strong> (CONFIG_USB_MASS_STORAGE) - acts as a USB Mass Storage disk driver. Its storage repository can use a regular file or a block device specified as a module parameter or sysfs option.</div>
</li>
<li class="level1"><div class="li"><strong>g_serial</strong> (CONFIG_USB_G_SERIAL) - behave as a ACM Serial device to create a &#039;USB to Serial&#039; connection which can be used to interoperate with MS-Windows hosts or with the Linux-USB &#039;cdc-acm&#039; driver.</div>
</li>
<li class="level1"><div class="li"><strong>g_midi</strong> (CONFIG_USB_MIDI_GADGET) - acts as a USB Audio device with one MIDI input and one MIDI output.</div>
</li>
<li class="level1"><div class="li"><strong>g_printer</strong> (CONFIG_USB_G_PRINTER) - channels data between the USB host and a user-space program driving the print engine.</div>
</li>
<li class="level1"><div class="li"><strong>g_cdc</strong> (CONFIG_USB_CDC_COMPOSITE) - provides two functions in one configuration: a CDC Ethernet (ECM) link, and a CDC ACM (serial port) link</div>
</li>
<li class="level1"><div class="li"><strong>g_acm_ms</strong> (CONFIG_USB_G_ACM_MS) - provides two functions in one configuration: a USB Mass Storage device and a CDC ACM (serial port) link</div>
</li>
<li class="level1"><div class="li"><strong>g_multi</strong> (CONFIG_USB_G_MULTI) - A multi-function composite gadget that can provide Ethernet (RNDIS and/or CDC), mass storage, and ACM serial link interfaces</div>
</li>
<li class="level1"><div class="li"><strong>g_hid</strong> (CONFIG_USB_G_HID) - A Human Interface Device (HID) gadget that provides a generic interface for things such as keyboards, mice, touchscreens</div>
</li>
<li class="level1"><div class="li"><strong>g_webcam</strong> - A Webcam Device </div>
</li>
</ul>

<p>
Additionally The Linux Configfs (CONFIG_CONFIGFS_FS) support allows complete dynamic configuration of gadget devices from userspace in which case you can create a single configuration or multi-configuration composite device with one or more of the functions available from drivers/usb/gadget/udc/functions. See below for more details on how to use this.
</p>

<p>
Note that only one gadget driver (device personality) can be loaded at a time but there are some &#039;composite&#039; gadget drivers that behave as &#039;composite devices&#039; meaning they have multiple endpoints per USB device. 
Note that the Vendor ID (VID) and Device ID (DID) that is presented to the USB host is configurable (see ​<a href="https://www.kernel.org/doc/Documentation/usb/gadget_configfs.txt" class="urlextern" title="https://www.kernel.org/doc/Documentation/usb/gadget_configfs.txt" rel="ugc nofollow">this linux kernel documentation</a> for details) 
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Available modes and their drivers (in linux kernel)&quot;,&quot;hid&quot;:&quot;available_modes_and_their_drivers_in_linux_kernel&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;1436-4460&quot;} -->
<h2 class="sectionedit3" id="available_modes_and_their_drivers_in_lede">Available modes and their drivers (in LEDE)</h2>
<div class="level2">

<p>
LEDE packages only a few of the above drivers, you will find them in <a href="/packages/index_lede17_1/kernel-modules---usb-support" class="wikilink2" title="packages:index_lede17_1:kernel-modules---usb-support" rel="nofollow" data-wiki-id="packages:index_lede17_1:kernel-modules---usb-support">**Kernel modules -&gt; USB Support**</a> category.
</p>
<ul>
<li class="level1"><div class="li"> <strong>kmod-usb-gadget</strong> (main driver which should select your device&#039;s base usb gadget drivers, may have a different name as seen with <strong>Qualcomm-Atheros AR9331</strong> below) </div>
</li>
<li class="level1"><div class="li"> <strong>kmod-usb-gadget-ehci-debug</strong> (Kernel support for USB EHCI debug port Gadget)</div>
</li>
<li class="level1"><div class="li"> <strong>kmod-usb-gadget-eth</strong> (Kernel support for USB Ethernet Gadget)</div>
</li>
<li class="level1"><div class="li"> <strong>kmod-usb-gadget-mass-storage</strong> (Kernel support for USB Gadget Mass Storage)</div>
</li>
<li class="level1"><div class="li"> <strong>kmod-usb-gadget-serial</strong> (Kernel support for USB Serial Gadget)</div>
</li>
</ul>

<p>
Note that all of these packages will attempt to autoload their respective kernel module so whichever one is alphabetically first will be loaded. You can see what is loaded by looking at the current modules: <code>lsmod | grep g_*</code>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Available modes and their drivers (in LEDE)&quot;,&quot;hid&quot;:&quot;available_modes_and_their_drivers_in_lede&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;4461-5391&quot;} -->
<h2 class="sectionedit4" id="tested_and_working_devices">Tested and working devices</h2>
<div class="level2">

<p>
I&#039;ve tested this on a <strong>TP-Link MR3020</strong> minirouter after I replicated the minor hardware modifications I&#039;ve seen done on a <strong>TP-Link WR703N</strong>. Both devices use the same SoC, a <strong>Qualcomm-Atheros AR9331</strong>, and both had a very similar board.
</p>

<p>
-raspberry pi 4 (or similar) via dtoverlay=dwc2 in config.txt and kmod-usb-dwc2
</p>

<p>
Please add other known working devices here, and the steps to have the function enabled if they differ from mine.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Tested and working devices&quot;,&quot;hid&quot;:&quot;tested_and_working_devices&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;5392-5869&quot;} -->
<h2 class="sectionedit5" id="installation">Installation</h2>
<div class="level2">

<p>
To get this working on a <strong>Qualcomm-Atheros AR9331</strong> device I had to install <strong>kmod-usb-chipidea</strong> instead of the <strong>kmod-usb-gadget</strong> (that was not available) and then I installed my gadget driver of choice, <strong>kmod-usb-gadget-eth</strong>.
</p>

<p>
That device has 4 <abbr title="Megabyte">MB</abbr> of flash, so it was a bit more involved than just using opkg, but it&#039;s not relevant for enabling USB guest feature.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation&quot;,&quot;hid&quot;:&quot;installation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;5870-6267&quot;} -->
<h2 class="sectionedit6" id="configuration">Configuration</h2>
<div class="level2">

<p>
Here you can see module-specific configuration.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuration&quot;,&quot;hid&quot;:&quot;configuration&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;6268-6343&quot;} -->
<h3 class="sectionedit7" id="kmod-usb-gadget-eth_aka_g_ether_gadget">kmod-usb-gadget-eth AKA g_ether Gadget</h3>
<div class="level3">

<p>
<a href="/packages/pkgdata/kmod-usb-gadget-eth" class="wikilink1" title="packages:pkgdata:kmod-usb-gadget-eth" data-wiki-id="packages:pkgdata:kmod-usb-gadget-eth">kmod-usb-gadget-eth</a>
</p>

<p>
The g_ether gadget driver behaves as a USB-to-Ethernet dongle. Once loaded the device-mode system will add a &#039;usb&lt;n&gt;&#039; network device which can be used the same as any other network device. On the USB host system, a similar network device will appear as long as a driver supporting the &#039;CDC Ethernet&#039; standard is available.
</p>

<p>
This module in LEDE is built with the following options:<br/>

<strong>CONFIG_USB_ETH_RNDIS=y</strong> (RNDIS support is an additional and more CPU intensive option that makes this device more compatible with Windows drivers)<br/>

<strong>CONFIG_USB_ETH_EEM=n</strong> (CDC Ethernet Emulation Model (EEM) is a newer standard that has a a simpler interface that can be used by more USB host hardware)<br/>

</p>

<p>
Usage example:
</p>
<ul>
<li class="level1 node"><div class="li"> on target device (a device with an OTG controller) write <code>modprobe g_ether</code> (or nothing, as this module seems to be loaded automatically on boot) and then you will see a <strong>usb0</strong> network interface. (you can treat it like any other network interface) </div>
<ul>
<li class="level2"><div class="li"> module parameters can specify the VID, PID, device version, manufacturer string, product string, serialnumber</div>
</li>
<li class="level2"><div class="li"> module parameters can specify the device and host ethernet address and whether or not to use CDC EEM mode</div>
</li>
<li class="level2"><div class="li"> To see module parameters write in the console <code>modinfo g_ether</code> (maybe on a PC linux system?)</div>
</li>
</ul>
</li>
</ul>
<ul>
<li class="level1 node"><div class="li"> on host device (for example a PC or anything else) </div>
<ul>
<li class="level2"><div class="li"> Linux Host: cdc_ether driver will create a &#039;usbX&#039; device (X= number) with VID:PID 0525:a4a2, which to most userspace programs will act like a normal ethernet port.</div>
</li>
<li class="level2"><div class="li"> Windows Host: in Windows 7 and above in the device manager will appear a &#039;USB Ethernet/RNDIS Gadget&#039; and can be configured as any other network interface. </div>
</li>
</ul>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;kmod-usb-gadget-eth AKA g_ether Gadget&quot;,&quot;hid&quot;:&quot;kmod-usb-gadget-eth_aka_g_ether_gadget&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;6344-8141&quot;} -->
<h3 class="sectionedit8" id="g_mass_storage_-_usb_mass_storage_device">g_mass_storage - USB Mass Storage Device</h3>
<div class="level3">

<p>
The g_file_storage driver behaves as a USB Mass Storage device such as a USB hard-disk or USB flash drive. You can decide whether to use a &#039;file&#039; as a backing store, or a block device (ie a flash partition, or a physical disk). The file/device is provided to the module via the &#039;file&#039; module parameter.<br/>

The file or device in use by g_mass_storage will NOT be accessible to LEDE system, only to the host device. Also the driver exposes raw block devices (or partitions) so the LEDE system does not need any filesystem driver.<br/>

Make sure you choose a partition/filesystem scheme that is compatible with the USB Host system you are going to use (ie, Windows doesn&#039;t have native drivers for ext2/ext3/ext4 partitions, so you may want to use VFAT or NTFS, same applies to MacOS/OSX), although you can also use the host to format any partition/file/device you expose like this.
</p>

<p>
If using a backing storage &#039;file&#039; you must create it beforehand with its desired size. For example to create a 64MB backing store:
</p>

<p>
<code>dd bs=1M count=64 if=/dev/zero of=/backing_file</code>
</p>

<p>
To use this as a backing store:
</p>

<p>
<code>modprobe g_mass_storage file=/backing_file</code>
</p>

<p>
You can also use a whole device or partition like this:
</p>

<p>
<code>modprobe g_mass_storage file=/dev/sda</code>
</p>

<p>
On host device (ie PC) a USB Mass Storage device (VID:PID 0525:a4a5 by default) will appear and behave as any other USB Mass Storage device (ie flash stick) would.<br/>

Module parameters can specify the serialnumber, number of LUNs to support as well as some other low-level features (see &#039;modinfo g_mass_storage&#039; for details)
</p>

</div>

<h4 id="further_reading">Further reading</h4>
<div class="level4">

<p>
<a href="https://www.kernel.org/doc/Documentation/usb/mass-storage.txt" class="urlextern" title="https://www.kernel.org/doc/Documentation/usb/mass-storage.txt" rel="ugc nofollow">https://www.kernel.org/doc/Documentation/usb/mass-storage.txt</a><br/>

<a href="http://www.linux-usb.org/gadget/file_storage.html" class="urlextern" title="http://www.linux-usb.org/gadget/file_storage.html" rel="ugc nofollow">http://www.linux-usb.org/gadget/file_storage.html</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;g_mass_storage - USB Mass Storage Device&quot;,&quot;hid&quot;:&quot;g_mass_storage_-_usb_mass_storage_device&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;8142-9907&quot;} -->
<h3 class="sectionedit9" id="g_serial_-_serial_device_gadget">g_serial - Serial Device Gadget</h3>
<div class="level3">

<p>
The Serial Gadget supports CDC-ACM and CDC-OBEX which can inter-operate with the MS-Windows hosts or with Linux hosts using the &#039;cdc-acm&#039; driver to create a &#039;USB-to-Serial&#039; connection.
</p>

<p>
Example:
</p>
<ul>
<li class="level1"><div class="li"> on target device load module (should be autoloaded in LEDE)<br/>
</div>
</li>
</ul>

<p>
<code>modprobe g_serial</code>
</p>
<ul>
<li class="level1"><div class="li"> on host device (ie PC) a USB CDC ACM device (VID:PID 0525:a4a7 by default) will appear and behave as a serial device. On Linux the cdc_acm driver will enumerate this device as &#039;/dev/ttyACMx&#039; (x= number), on Windows new COM ports will appear.</div>
</li>
</ul>

<p>
module parameters can specify the VID, PID, device version, manufacturer string, product string, serialnumber, whether or not to use CDC ACM, CDC OBEX, and the number of ports to create.
</p>

</div>

<h4 id="further_reading1">Further reading</h4>
<div class="level4">

<p>
<a href="https://www.kernel.org/doc/Documentation/usb/gadget_serial.txt" class="urlextern" title="https://www.kernel.org/doc/Documentation/usb/gadget_serial.txt" rel="ugc nofollow">https://www.kernel.org/doc/Documentation/usb/gadget_serial.txt</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;g_serial - Serial Device Gadget&quot;,&quot;hid&quot;:&quot;g_serial_-_serial_device_gadget&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;9908-10762&quot;} -->
<h3 class="sectionedit10" id="g_cdc_-_composite_ethernet_serial_gadget">g_cdc - Composite Ethernet + Serial Gadget</h3>
<div class="level3">

<p>
(available on limited devices)
</p>

<p>
The g_cdc gadget supports two functions in one configuration:
</p>
<ul>
<li class="level1"><div class="li">     a CDC Ethernet (ECM) link (USB-to-Ethernet connection)</div>
</li>
<li class="level1"><div class="li">     a CDC ACM (serial port) link (USB-to-Serial connection) </div>
</li>
</ul>

<p>
Example:
</p>

<p>
on target device load module <code>modprobe g_cdc</code>
</p>

<p>
on host device (ie PC) a USB CDC ACM device (VID:PID 0525:a4aa) will appear 
</p>

<p>
<strong>Linux USB Host notes:</strong><br/>

the cdc_acm driver will enumerate this device as &#039;/dev/ttyACM&lt;n&gt;&#039;<br/>

the cdc_ether driver will enumerate this device as a &#039;usb&lt;n&gt;&#039; network device 
</p>

<p>
<strong>Windows USB Host notes:</strong>
A CDC Composite Gadget device will appear in Device Manager<br/>

</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;g_cdc - Composite Ethernet + Serial Gadget&quot;,&quot;hid&quot;:&quot;g_cdc_-_composite_ethernet_serial_gadget&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:10,&quot;range&quot;:&quot;10763-11440&quot;} -->
<h3 class="sectionedit11" id="g_multi_-_composite_ethernet_serial_mass_storage_gadget">g_multi - Composite Ethernet + Serial + Mass Storage Gadget</h3>
<div class="level3">

<p>
(currently not available in LEDE)
</p>

<p>
The g_multi gadget supports multiple functions in one configuration:
</p>
<ul>
<li class="level1"><div class="li"> a CDC Ethernet (ECM) link</div>
</li>
<li class="level1"><div class="li"> a CDC ACM (serial port) link</div>
</li>
<li class="level1"><div class="li"> a USB Mass Storage device </div>
</li>
</ul>

<p>
Example:
</p>

<p>
on target device load module <code>modprobe g_cdc</code>
</p>

<p>
on host device (ie PC) a USB CDC ACM device (VID:PID 1d6b:0104 by default) will appear<br/>

module parameters can specify the VID, PID, device version, manufacturer string, product string, serialnumber<br/>

module parameters can specify the ethernet device and host address and queue length multiplier at high speed <br/>

</p>

<p>
<strong>Linux USB Host notes:</strong>
</p>
<ul>
<li class="level1"><div class="li">     the cdc_acm driver will enumerate this device as &#039;/dev/ttyACM&lt;n&gt;&#039;</div>
</li>
<li class="level1"><div class="li">     the cdc_ether driver will enumerate this device as a &#039;usb&lt;n&gt;&#039; network device</div>
</li>
<li class="level1"><div class="li">     the usb-storage driver will provide the USB Mass Storage feature </div>
</li>
</ul>

<p>
<strong>Windows USB Host notes:</strong>
</p>
<pre class="code">  A Multifunction Composite Gadget device will appear in Device Manager\\
  see ​the Further Reading for details on Windows configuration </pre>

</div>

<h4 id="further_reading2">Further reading</h4>
<div class="level4">

<p>
<a href="https://www.kernel.org/doc/Documentation/usb/gadget_multi.txt" class="urlextern" title="https://www.kernel.org/doc/Documentation/usb/gadget_multi.txt" rel="ugc nofollow">https://www.kernel.org/doc/Documentation/usb/gadget_multi.txt</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;g_multi - Composite Ethernet + Serial + Mass Storage Gadget&quot;,&quot;hid&quot;:&quot;g_multi_-_composite_ethernet_serial_mass_storage_gadget&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:11,&quot;range&quot;:&quot;11441-12608&quot;} -->
<h3 class="sectionedit12" id="g_hid_-_human_interface_device_hid_gadget">g_hid - Human Interface Device (HID) Gadget</h3>
<div class="level3">

<p>
(available on limited devices)
</p>

<p>
The HID gadget driver provides generic emulation of USB Human Interface Devices (HID), for example keyboards, mice, touchscreens, etc
</p>

<p>
Example:
</p>

<p>
on target device load module <code>modprobe g_hid</code>
</p>

<p>
module parameters can specify the VID, PID, device version, manufacturer string, product string, serial number 
</p>

</div>

<h4 id="further_reading3">Further reading</h4>
<div class="level4">

<p>
<a href="https://www.kernel.org/doc/Documentation/usb/gadget_hid.txt" class="urlextern" title="https://www.kernel.org/doc/Documentation/usb/gadget_hid.txt" rel="ugc nofollow">https://www.kernel.org/doc/Documentation/usb/gadget_hid.txt</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;g_hid - Human Interface Device (HID) Gadget&quot;,&quot;hid&quot;:&quot;g_hid_-_human_interface_device_hid_gadget&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:12,&quot;range&quot;:&quot;12609-13089&quot;} -->
<h3 class="sectionedit13" id="g_webcam_-_composite_usb_audio_and_video_class_gadget">g_webcam - Composite USB Audio and Video Class Gadget</h3>
<div class="level3">

<p>
(currently not available in LEDE)
</p>

<p>
The g_webcam gadget driver provides a Composite USB Audio and Video Class device.
</p>

<p>
Example:
</p>

<p>
on target device load module <code>modprobe g_webcam</code>
</p>

<p>
on host device (ie PC) a &#039;Linux Foundation Webcam Gadget&#039; device (VID:PID 1d6b:0102 by default) will appear<br/>

on target device (Gateworks board) a /dev/video&lt;n&gt; device will be created and avialable as a Video4Linux output device supporting 320/240 YUYV video<br/>

module parameters can specify the VID, PID, device version, manufacturer string, product string, serialnumber 
</p>

<p>
<strong>Linux USB Host notes:</strong><br/>

the uvcvideo driver will enumerate the device and create a /dev/videoX (X= number) video capture device 
</p>

<p>
<strong>Windows USB Host notes:</strong><br/>

A USB Composite device will appear in Device Manager<br/>

A UVC Camera device will appear under Imaging devices in the device manager and be available to capture video 
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;g_webcam - Composite USB Audio and Video Class Gadget&quot;,&quot;hid&quot;:&quot;g_webcam_-_composite_usb_audio_and_video_class_gadget&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:13,&quot;range&quot;:&quot;13090-14036&quot;} -->
<h3 class="sectionedit14" id="g_ncm_-_usb_cdc_ncm_subclass_ethernet_gadget">g_ncm - USB CDC NCM subclass Ethernet Gadget</h3>
<div class="level3">

<p>
(available on limited devices)
</p>

<p>
The g_ncm gadget driver provides a a USB CDC NCM subclass. NCM is an advanced protocol for Ethernet encapsulation, allowing grouping of several ethernet frames into one USB transfer with various alignment possibilities.
</p>

<p>
Example:
</p>

<p>
on target device load module <code>modprobe g_ncm</code>
</p>

<p>
on host device (ie PC) a &#039;Linux-USB Ethernet Gadget&#039; device (VID:PID 0525:a4a1 by default) will appear<br/>

on target device (Gateworks board) a usb&lt;n&gt; network device will be created<br/>

module parameters can specify the VID, PID, device version, manufacturer string, product string, serialnumber<br/>

module parameters can specify the device and host ethernet addresses and the queue length multiplier used at high speeds 
</p>

<p>
<strong>Linux USB Host notes:</strong><br/>

the cdc_ncm driver will enumerate the device and create a /dev/video&lt;n&gt; video capture device 
</p>

<p>
<strong>Windows USB Host notes:</strong><br/>

A NCM Gadget device will appear in Device Manager
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;g_ncm - USB CDC NCM subclass Ethernet Gadget&quot;,&quot;hid&quot;:&quot;g_ncm_-_usb_cdc_ncm_subclass_ethernet_gadget&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:14,&quot;range&quot;:&quot;14037-15024&quot;} -->
<h3 class="sectionedit15" id="configfs">ConfigFs</h3>
<div class="level3">

<p>
(I don&#039;t know what LEDE supports of this paragraph, it will likely require source code contributions to activate this functionality in LEDE builds)
</p>

<p>
The Linux Configfs (CONFIG_CONFIGFS_FS) support allows complete dynamic configuration of gadget devices from userspace in which case you can create a single configuration or multi-configuration composite device with one or more of the functions available from drivers/usb/gadget/udc/functions:
</p>
<ul>
<li class="level1"><div class="li">     <strong>usb_f_acm</strong> - CDC Serial (ACM - Abstract Control Model)</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_ecm</strong> - CDC Ethernet (ECM - Ethernet Networking Control Model)</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_eem</strong> - CDC Ethernet (EEM - Ethernet Emulation Model)</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_fs</strong> - Filesystem</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_hid</strong> - HID Interface</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_mass_storage</strong> - USB Mass Storage class</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_midi</strong> - MIDI</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_ncm</strong> - CDC Network (NCM - Network Control Model Ethernet)</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_obex</strong> - CDC OBEX (Object Exchange Model)</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_phonet</strong> - CDC Phonet</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_printer</strong> - Printer function</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_rndis</strong> - (Remote Network Driver Interface Specification - Microsoft Ethernet over USB)</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_serial</strong> - Generic serial function</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_subset</strong> - CDC Subset (Ethernet with no control mechanism - just raw data transfer)</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_uac1</strong> - USB Audio class</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_uac2</strong> - USB Audio class 2.0</div>
</li>
<li class="level1"><div class="li">     <strong>usb_f_uvc</strong> - USB Video class </div>
</li>
</ul>

<p>
Examples:
</p>

<p>
Create a CDC ACM Serial device:
</p>
<pre class="code Bash"><span class="co0"># mount configfs</span>
<span class="kw2">mount</span> <span class="re5">-t</span> configfs none <span class="sy0">/</span>sys<span class="sy0">/</span>kernel<span class="sy0">/</span>config
<span class="co0"># load libcomposite module</span>
modprobe libcomposite
<span class="co0"># create a gadget</span>
<span class="kw2">mkdir</span> <span class="sy0">/</span>sys<span class="sy0">/</span>kernel<span class="sy0">/</span>config<span class="sy0">/</span>usb_gadget<span class="sy0">/</span>g1
<span class="co0"># cd to its configfs node</span>
<span class="kw3">cd</span> <span class="sy0">/</span>sys<span class="sy0">/</span>kernel<span class="sy0">/</span>config<span class="sy0">/</span>usb_gadget<span class="sy0">/</span>g1
<span class="co0"># configure it (vid/pid can be anything if USB Class is used for driver compat)</span>
<span class="kw3">echo</span> 0xabcd <span class="sy0">&gt;</span> idVendor
<span class="kw3">echo</span> 0x1234 <span class="sy0">&gt;</span> idProduct
<span class="co0"># configure its serial/mfg/product</span>
<span class="kw2">mkdir</span> strings<span class="sy0">/</span>0x409
<span class="kw3">echo</span> myserial <span class="sy0">&gt;</span> strings<span class="sy0">/</span>0x409<span class="sy0">/</span>serialnumber
<span class="kw3">echo</span> mymfg <span class="sy0">&gt;</span> strings<span class="sy0">/</span>0x409<span class="sy0">/</span>manufacturer
<span class="kw3">echo</span> myproduct <span class="sy0">&gt;</span> strings<span class="sy0">/</span>0x409<span class="sy0">/</span>product
<span class="co0"># create a config</span>
<span class="kw2">mkdir</span> configs<span class="sy0">/</span>c.1
<span class="co0"># configure it with attributes if needed</span>
<span class="kw3">echo</span> <span class="nu0">120</span> <span class="sy0">&gt;</span> configs<span class="sy0">/</span>c.1<span class="sy0">/</span>MaxPower
<span class="co0"># ensure function is loaded</span>
modprobe usb_f_acm
<span class="co0"># create the function (name must match a usb_f_&lt;name&gt; module such as 'acm')</span>
<span class="kw2">mkdir</span> functions<span class="sy0">/</span>acm.0
<span class="co0"># associate function with config</span>
<span class="kw2">ln</span> <span class="re5">-s</span> functions<span class="sy0">/</span>acm.0 configs<span class="sy0">/</span>c.1
<span class="co0"># enable gadget by binding it to a UDC from /sys/class/udc</span>
<span class="kw3">echo</span> 0000:01:<span class="nu0">00.0</span> <span class="sy0">&gt;</span> UDC
<span class="co0"># to unbind it: echo &quot;&quot; UDC; sleep 1; rm -rf /sys/kernel/config/usb_gadget/g1</span></pre>

<p>
Create a CDC ECM Ethernet device:
</p>
<pre class="code Bash"><span class="co0"># mount configfs</span>
<span class="kw2">mount</span> <span class="re5">-t</span> configfs none <span class="sy0">/</span>sys<span class="sy0">/</span>kernel<span class="sy0">/</span>config
<span class="co0"># load libcomposite module</span>
modprobe libcomposite
<span class="co0"># create a gadget</span>
<span class="kw2">mkdir</span> <span class="sy0">/</span>sys<span class="sy0">/</span>kernel<span class="sy0">/</span>config<span class="sy0">/</span>usb_gadget<span class="sy0">/</span>g1
<span class="co0"># cd to its configfs node</span>
<span class="kw3">cd</span> <span class="sy0">/</span>sys<span class="sy0">/</span>kernel<span class="sy0">/</span>config<span class="sy0">/</span>usb_gadget<span class="sy0">/</span>g1
<span class="co0"># configure it (vid/pid can be anything if USB Class is used for driver compat)</span>
<span class="kw3">echo</span> 0xabcd <span class="sy0">&gt;</span> idVendor
<span class="kw3">echo</span> 0x1234 <span class="sy0">&gt;</span> idProduct
<span class="co0"># configure its serial/mfg/product</span>
<span class="kw2">mkdir</span> strings<span class="sy0">/</span>0x409
<span class="kw3">echo</span> myserial <span class="sy0">&gt;</span> strings<span class="sy0">/</span>0x409<span class="sy0">/</span>serialnumber
<span class="kw3">echo</span> mymfg <span class="sy0">&gt;</span> strings<span class="sy0">/</span>0x409<span class="sy0">/</span>manufacturer
<span class="kw3">echo</span> myproduct <span class="sy0">&gt;</span> strings<span class="sy0">/</span>0x409<span class="sy0">/</span>product
<span class="co0"># create a config</span>
<span class="kw2">mkdir</span> configs<span class="sy0">/</span>c.1
<span class="co0"># configure it with attributes if needed</span>
<span class="kw3">echo</span> <span class="nu0">120</span> <span class="sy0">&gt;</span> configs<span class="sy0">/</span>c.1<span class="sy0">/</span>MaxPower
<span class="co0"># ensure function is loaded</span>
modprobe usb_f_ecm
<span class="co0"># create the function (name must match a usb_f_&lt;name&gt; module such as 'ecm')</span>
<span class="kw2">mkdir</span> functions<span class="sy0">/</span>ecm.0
<span class="co0"># associate function with config</span>
<span class="kw2">ln</span> <span class="re5">-s</span> functions<span class="sy0">/</span>ecm.0 configs<span class="sy0">/</span>c.1
<span class="co0"># enable gadget by binding it to a UDC from /sys/class/udc</span>
<span class="kw3">echo</span> 0000:01:<span class="nu0">00.0</span> <span class="sy0">&gt;</span> UDC
<span class="co0"># to unbind it: echo &quot;&quot; UDC; sleep 1; rm -rf /sys/kernel/config/usb_gadget/g1</span></pre>

<p>
Create a USB Mass Storage device (with 2 LUN&#039;s 16MB each):
</p>
<pre class="code Bash"><span class="co0"># mount configfs</span>
<span class="kw2">mount</span> <span class="re5">-t</span> configfs none <span class="sy0">/</span>sys<span class="sy0">/</span>kernel<span class="sy0">/</span>config
<span class="co0"># load libcomposite module</span>
modprobe libcomposite
<span class="co0"># create a gadget</span>
<span class="kw2">mkdir</span> <span class="sy0">/</span>sys<span class="sy0">/</span>kernel<span class="sy0">/</span>config<span class="sy0">/</span>usb_gadget<span class="sy0">/</span>g1
<span class="co0"># cd to its configfs node</span>
<span class="kw3">cd</span> <span class="sy0">/</span>sys<span class="sy0">/</span>kernel<span class="sy0">/</span>config<span class="sy0">/</span>usb_gadget<span class="sy0">/</span>g1
<span class="co0"># configure it (vid/pid can be anything if USB Class is used for driver compat)</span>
<span class="kw3">echo</span> 0xabcd <span class="sy0">&gt;</span> idVendor
<span class="kw3">echo</span> 0x1234 <span class="sy0">&gt;</span> idProduct
<span class="co0"># configure its serial/mfg/product</span>
<span class="kw2">mkdir</span> strings<span class="sy0">/</span>0x409
<span class="kw3">echo</span> myserial <span class="sy0">&gt;</span> strings<span class="sy0">/</span>0x409<span class="sy0">/</span>serialnumber
<span class="kw3">echo</span> mymfg <span class="sy0">&gt;</span> strings<span class="sy0">/</span>0x409<span class="sy0">/</span>manufacturer
<span class="kw3">echo</span> myproduct <span class="sy0">&gt;</span> strings<span class="sy0">/</span>0x409<span class="sy0">/</span>product
<span class="co0"># create configs</span>
<span class="kw2">mkdir</span> configs<span class="sy0">/</span>c.1
<span class="kw2">mkdir</span> configs<span class="sy0">/</span>c.2
<span class="kw2">mkdir</span> configs<span class="sy0">/</span>c.3
<span class="co0"># configure them with attributes if needed</span>
<span class="kw3">echo</span> <span class="nu0">120</span> <span class="sy0">&gt;</span> configs<span class="sy0">/</span>c.1<span class="sy0">/</span>MaxPower
<span class="kw3">echo</span> <span class="nu0">120</span> <span class="sy0">&gt;</span> configs<span class="sy0">/</span>c.2<span class="sy0">/</span>MaxPower
<span class="kw3">echo</span> <span class="nu0">120</span> <span class="sy0">&gt;</span> configs<span class="sy0">/</span>c.2<span class="sy0">/</span>MaxPower
<span class="co0"># ensure function is loaded</span>
modprobe usb_f_mass_storage
<span class="co0"># create the function (name must match a usb_f_&lt;name&gt; module such as 'acm')</span>
<span class="kw2">mkdir</span> functions<span class="sy0">/</span>mass_storage.0
<span class="co0"># create backing store(s): in this example 2 LUN's 16MB each</span>
<span class="kw2">dd</span> <span class="re2">bs</span>=1M <span class="re2">count</span>=<span class="nu0">16</span> <span class="re2">if</span>=<span class="sy0">/</span>dev<span class="sy0">/</span>zero <span class="re2">of</span>=<span class="sy0">/</span>tmp<span class="sy0">/</span>lun0.img <span class="co0"># 16MB</span>
<span class="kw2">dd</span> <span class="re2">bs</span>=1M <span class="re2">count</span>=<span class="nu0">16</span> <span class="re2">if</span>=<span class="sy0">/</span>dev<span class="sy0">/</span>zero <span class="re2">of</span>=<span class="sy0">/</span>tmp<span class="sy0">/</span>lun1.img <span class="co0"># 16MB</span>
<span class="co0"># associate with partitions</span>
<span class="kw2">mkdir</span> functions<span class="sy0">/</span>mass_storage.0<span class="sy0">/</span>lun.0
<span class="kw3">echo</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>lun0.img <span class="sy0">&gt;</span> functions<span class="sy0">/</span>mass_storage.0<span class="sy0">/</span>lun.0<span class="sy0">/</span><span class="kw2">file</span>
<span class="kw2">mkdir</span> functions<span class="sy0">/</span>mass_storage.0<span class="sy0">/</span>lun.1
<span class="kw3">echo</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>lun1.img <span class="sy0">&gt;</span> functions<span class="sy0">/</span>mass_storage.0<span class="sy0">/</span>lun.1<span class="sy0">/</span><span class="kw2">file</span>
<span class="co0"># associate function with config</span>
<span class="kw2">ln</span> <span class="re5">-s</span> functions<span class="sy0">/</span>mass_storage.0 configs<span class="sy0">/</span>c.1
<span class="co0"># enable gadget by binding it to a UDC from /sys/class/udc</span>
<span class="kw3">echo</span> 0000:01:<span class="nu0">00.0</span> <span class="sy0">&gt;</span> UDC
<span class="co0"># to unbind it: echo &quot;&quot; UDC; sleep 1; rm -rf /sys/kernel/config/usb_gadget/g1</span></pre>

</div>

<h4 id="further_reading4">Further reading</h4>
<div class="level4">

<p>
<a href="https://www.kernel.org/doc/Documentation/usb/gadget_configfs.txt" class="urlextern" title="https://www.kernel.org/doc/Documentation/usb/gadget_configfs.txt" rel="ugc nofollow">https://www.kernel.org/doc/Documentation/usb/gadget_configfs.txt</a><br/>

<a href="https://wiki.tizen.org/USB/Linux_USB_Layers/Configfs_Composite_Gadget/General_configuration" class="urlextern" title="https://wiki.tizen.org/USB/Linux_USB_Layers/Configfs_Composite_Gadget/General_configuration" rel="ugc nofollow">https://wiki.tizen.org/USB/Linux_USB_Layers/Configfs_Composite_Gadget/General_configuration</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;ConfigFs&quot;,&quot;hid&quot;:&quot;configfs&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:15,&quot;range&quot;:&quot;15025-&quot;} -->