
<h1 class="sectionedit1" id="bluetooth_speakersheadphones">Bluetooth Speakers/Headphones</h1>
<div class="level1">

<p>
OpenWrt is a Linux distribution which is geared towards networking on routers. However, some of the travel routers which can run OpenWrt, are ideal portable music servers which can be connected to Bluetooth headphones and speakers which can play and control music from an OpenWrt Router. The <a href="/toh/hwdata/hootoo/hootoo_ht-tm03_tripmate_mini" class="wikilink1" title="toh:hwdata:hootoo:hootoo_ht-tm03_tripmate_mini" data-wiki-id="toh:hwdata:hootoo:hootoo_ht-tm03_tripmate_mini">HooToo TM03</a> is one of the travel routers which is an ideal portable music player.
</p>
<ul>
<li class="level1"><div class="li"> It fits is the palm of your hand</div>
</li>
<li class="level1"><div class="li"> It has a USB A port which you can use to connect a USB Bluetooth dongle</div>
</li>
<li class="level1"><div class="li"> It has a MicroSD slot which allows for continuous operation with an <a href="/docs/guide-user/additional-software/extroot_configuration" class="wikilink1" title="docs:guide-user:additional-software:extroot_configuration" data-wiki-id="docs:guide-user:additional-software:extroot_configuration">overlay</a> file system. </div>
</li>
<li class="level1"><div class="li"> It contains a 3000mAh battery for easy portable operation.</div>
</li>
</ul>

<p>
This has been tested with OpenWrt 18.06.4 running on a <a href="/toh/hwdata/hootoo/hootoo_ht-tm03_tripmate_mini" class="wikilink1" title="toh:hwdata:hootoo:hootoo_ht-tm03_tripmate_mini" data-wiki-id="toh:hwdata:hootoo:hootoo_ht-tm03_tripmate_mini">HooToo TM03</a> and <a href="/toh/ravpower/rp-wd02" class="wikilink1" title="toh:ravpower:rp-wd02" data-wiki-id="toh:ravpower:rp-wd02">RAVPower RP-WD02</a> with a MicroSD card <a href="/docs/guide-user/additional-software/extroot_configuration" class="wikilink1" title="docs:guide-user:additional-software:extroot_configuration" data-wiki-id="docs:guide-user:additional-software:extroot_configuration">overlay</a> file systems with a <a href="https://www.newegg.com/p/1B4-00M5-00031?Description=USB%20Bluetooth%20dongle&amp;cm_re=USB_Bluetooth%20dongle-_-9SIA2XB39D1325-_-Product" class="urlextern" title="https://www.newegg.com/p/1B4-00M5-00031?Description=USB%20Bluetooth%20dongle&amp;cm_re=USB_Bluetooth%20dongle-_-9SIA2XB39D1325-_-Product" rel="ugc nofollow">Plugable</a> USB Bluetooth dongle. The microSD card also contains a 128MB <a href="/docs/guide-user/storage/fstab#the_swap_sections" class="wikilink1" title="docs:guide-user:storage:fstab" data-wiki-id="docs:guide-user:storage:fstab">swap</a> partition.
</p>

</div>

<h4 id="notes">Notes</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> OpenWrt 18.06.1 Bluetooth does not work correctly</div>
</li>
<li class="level1"><div class="li"> Do not use OpenWrt 19.xx.xx with the <a href="/toh/hwdata/hootoo/hootoo_ht-tm03_tripmate_mini" class="wikilink1" title="toh:hwdata:hootoo:hootoo_ht-tm03_tripmate_mini" data-wiki-id="toh:hwdata:hootoo:hootoo_ht-tm03_tripmate_mini">HooToo TM03</a> or <a href="/toh/ravpower/rp-wd02" class="wikilink1" title="toh:ravpower:rp-wd02" data-wiki-id="toh:ravpower:rp-wd02">RAVPower RP-WD02</a> since the kernel has been compiled to no longer support <a href="/docs/guide-user/additional-software/extroot_configuration" class="wikilink1" title="docs:guide-user:additional-software:extroot_configuration" data-wiki-id="docs:guide-user:additional-software:extroot_configuration">overlay</a> file systems with these devices.</div>
</li>
<li class="level1"><div class="li"> Although you can connect multiple Bluetooth devices simultaneously, the <a href="/toh/hwdata/hootoo/hootoo_ht-tm03_tripmate_mini" class="wikilink1" title="toh:hwdata:hootoo:hootoo_ht-tm03_tripmate_mini" data-wiki-id="toh:hwdata:hootoo:hootoo_ht-tm03_tripmate_mini">HooToo TM03</a> or <a href="/toh/ravpower/rp-wd02" class="wikilink1" title="toh:ravpower:rp-wd02" data-wiki-id="toh:ravpower:rp-wd02">RAVPower RP-WD02</a> do not have enough horsepower to drive Bluetooth speakers/headphones and <a href="/docs/guide-user/hardware/bluetooth/bluetooth.tether" class="wikilink1" title="docs:guide-user:hardware:bluetooth:bluetooth.tether" data-wiki-id="docs:guide-user:hardware:bluetooth:bluetooth.tether">tethering</a> simultaneously.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Bluetooth Speakers\/Headphones&quot;,&quot;hid&quot;:&quot;bluetooth_speakersheadphones&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-2070&quot;} -->
<h3 class="sectionedit2" id="required_openwrt_packages">Required OpenWrt packages:</h3>
<div class="level3">

<p>
Your OpenWrt router configured with an <a href="/docs/guide-user/additional-software/extroot_configuration" class="wikilink1" title="docs:guide-user:additional-software:extroot_configuration" data-wiki-id="docs:guide-user:additional-software:extroot_configuration">overlay</a> file system.
</p>
<ol>
<li class="level1"><div class="li"> kmod-input-uinput</div>
</li>
<li class="level1"><div class="li"> bluez-daemon</div>
</li>
<li class="level1"><div class="li"> bluez-utils</div>
</li>
<li class="level1"><div class="li"> dbus</div>
</li>
<li class="level1"><div class="li"> dbus-utils</div>
</li>
<li class="level1"><div class="li"> pulseaudio-daemon-avahi</div>
</li>
<li class="level1"><div class="li"> pulseaudio-profiles</div>
</li>
<li class="level1"><div class="li"> pulseaudio-tools</div>
</li>
<li class="level1"><div class="li"> mpd-full</div>
</li>
<li class="level1"><div class="li"> mpc</div>
</li>
<li class="level1"><div class="li"> madplay</div>
</li>
<li class="level1"><div class="li"> inotifywait</div>
</li>
<li class="level1"><div class="li"> gawk</div>
</li>
<li class="level1"><div class="li"> grep</div>
</li>
<li class="level1"><div class="li"> kmod-6lowpan</div>
</li>
<li class="level1"><div class="li"> kmod-bluetooth_6lowpan</div>
</li>
<li class="level1"><div class="li"> wget</div>
</li>
</ol>

<p>
This should result in the installation of other dependencies including the USB packages.
</p>

</div>

<h4 id="notes1">Notes</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> Since there is no OpenWrt bluezalsa package, we will use pulseaudio.</div>
</li>
<li class="level1"><div class="li"> Since the <code>mpd-mini</code> package does not support <code>pipe</code> or pulseaudio, we are forced to install the <code>mpd-full</code> package which does not support pulseaudio either, but does support <code>pipe</code> which we can use with the pulsaudio <code>pacat</code> utility.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Required OpenWrt packages:&quot;,&quot;hid&quot;:&quot;required_openwrt_packages&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;2071-2933&quot;} -->
<h3 class="sectionedit3" id="modify_default_configuration_files">Modify Default Configuration files</h3>
<div class="level3">

</div>

<h4 id="etcbluetoothmainconf">/etc/bluetooth/main.conf</h4>
<div class="level4">

<p>
In <code>/etc/bluetooth/main.conf</code>,
change the last line to
<code>AutoEnable=true</code>
</p>

</div>

<h4 id="etcpulsesystempa">/etc/pulse/system.pa</h4>
<div class="level4">

<p>
Modify <code>/etc/pulse/system.pa</code> to look as below.
</p>
<pre class="code">#!/usr/bin/pulseaudio -nF
#
# This file is part of PulseAudio.

load-module module-stream-restore
load-module module-device-restore
load-module module-card-restore

load-module module-bluez5-discover
load-module module-bluetooth-policy

load-module module-switch-on-port-available

load-module module-rescue-streams

load-module module-always-sink

load-module module-suspend-on-idle

load-module module-native-protocol-unix auth-group=pulse-access</pre>

</div>

<h4 id="etcdbus-1systemdbluetoothconf">/etc/dbus-1/system.d/bluetooth.conf</h4>
<div class="level4">

<p>
In <code>/etc/dbus-1/system.d/bluetooth.conf</code>, add 
</p>
<pre class="code">    &lt;allow send_type=&quot;method_call&quot;/&gt;
    &lt;allow send_type=&quot;method_return&quot;/&gt;</pre>

<p>
to the <code>root</code> policy block. The <code>root</code> policy block should now look like
</p>
<pre class="code">  &lt;policy user=&quot;root&quot;&gt;
    &lt;allow own=&quot;org.bluez&quot;/&gt;
    &lt;allow send_destination=&quot;org.bluez&quot;/&gt;
    &lt;allow send_interface=&quot;org.bluez.Agent1&quot;/&gt;
    &lt;allow send_interface=&quot;org.bluez.MediaEndpoint1&quot;/&gt;
    &lt;allow send_interface=&quot;org.bluez.MediaPlayer1&quot;/&gt;
    &lt;allow send_interface=&quot;org.bluez.Profile1&quot;/&gt;
    &lt;allow send_interface=&quot;org.bluez.GattCharacteristic1&quot;/&gt;
    &lt;allow send_interface=&quot;org.bluez.GattDescriptor1&quot;/&gt;
    &lt;allow send_interface=&quot;org.bluez.LEAdvertisement1&quot;/&gt;
    &lt;allow send_interface=&quot;org.freedesktop.DBus.ObjectManager&quot;/&gt;
    &lt;allow send_interface=&quot;org.freedesktop.DBus.Properties&quot;/&gt;
    &lt;allow send_type=&quot;method_call&quot;/&gt;
    &lt;allow send_type=&quot;method_return&quot;/&gt;
  &lt;/policy&gt;</pre>

</div>

<h4 id="etcdbus-1systemdpulseaudio-systemconf">/etc/dbus-1/system.d/pulseaudio-system.conf</h4>
<div class="level4">

<p>
Modify <code>/etc/dbus-1/system.d/pulseaudio-system.conf</code> to look as below
</p>
<pre class="code">&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!--*-nxml-*--&gt;
&lt;!DOCTYPE busconfig PUBLIC &quot;-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN&quot;
 &quot;http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd&quot;&gt;

&lt;!--
This file is part of PulseAudio.

PulseAudio is free software; you can redistribute it and/or modify it
under the terms of the GNU Lesser General Public License as
published by the Free Software Foundation; either version 2.1 of the
License, or (at your option) any later version.

PulseAudio is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General
Public License for more details.

You should have received a copy of the GNU Lesser General Public
License along with PulseAudio; if not, see &lt;http://www.gnu.org/licenses/&gt;.
--&gt;

&lt;busconfig&gt;

  &lt;!-- System-wide PulseAudio runs as &#039;pulse&#039; user. This fragment is
       not necessary for user PulseAudio instances. --&gt;

  &lt;policy user=&quot;pulse&quot;&gt;
    &lt;allow own=&quot;org.pulseaudio.Server&quot;/&gt;
    &lt;allow send_type=&quot;method_call&quot;/&gt;
    &lt;allow send_type=&quot;method_return&quot;/&gt;
  &lt;/policy&gt;

&lt;/busconfig&gt;</pre>

</div>

<h4 id="etcpasswd">/etc/passwd</h4>
<div class="level4">

<p>
Make sure that <code>/etc/passwd</code> has the following entry.
</p>
<pre class="code">pulse:x:51:51:pulse:/var/run/pulse:/bin/false</pre>

</div>

<h4 id="etcgroup">/etc/group</h4>
<div class="level4">

<p>
Make sure that <code>/etc/group</code> has the following entries.
</p>
<pre class="code">pulse:x:51:pulse:root
pulse-rt:x:53:
pulse-access:x:54:root</pre>

</div>

<h4 id="etcinitdpulseaudio">/etc/init.d/pulseaudio</h4>
<div class="level4">

<p>
Modify <code>/etc/init.d/pulseaudio</code> to look as below.
</p>
<pre class="code">
#!/bin/sh /etc/rc.common
# Copyright (C) 2011 OpenWrt.org

START=99
STOP=65

USE_PROCD=1
PROG=/usr/bin/pulseaudio

start_service() {
	[ -d /var/run/pulse ] || {
		mkdir -m 0755 -p /var/run/pulse
		chmod 0750 /var/run/pulse
		chown pulse:pulse /var/run/pulse
	}
	[ -d /var/lib/pulse ] || {
		mkdir -m 0755 -p /var/lib/pulse
		chmod 0750 /var/lib/pulse
		chown pulse:pulse /var/lib/pulse
	}

	
	procd_open_instance
	procd_set_param command $PROG --system --disallow-exit --disable-shm --exit-idle-time=-1 --realtime=false
	procd_close_instance
}</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Modify Default Configuration files&quot;,&quot;hid&quot;:&quot;modify_default_configuration_files&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;2934-6832&quot;} -->
<h3 class="sectionedit4" id="pair_trust_and_connect_bluetooth_speakerheadphones">Pair, Trust and Connect Bluetooth Speaker/Headphones</h3>
<div class="level3">

<p>
While logged into your OpenWrt device, type in the command <code>bluetoothctl</code>. 
</p>

<p>
Make sure that your Bluetooth speaker/headphones is in pairing mode and then issue the command <code>scan on</code>. 
</p>

<p>
Wait for your speaker/headphones Bluetooth MAC address to appear and then type <code>pair XX:XX:XX:XX:XX:XX</code> where XX represents the Bluetooth MAC address of your speaker/headphones. For example, for my VERSE headphones, I type <code>pair 1C:A0:D3:D2:AE:75</code> and accept any pins.
</p>

<p>
When your speaker/headphones has paired successfully, type <code>connect XX:XX:XX:XX:XX:XX</code> where XX represents the Bluetooth MAC address of your speaker/headphones. For example, for my VERSE Headphones, I type <code>connect 1C:A0:D3:D2:AE:75</code>
</p>

<p>
If you have connected to your speaker/headphones successfully, you should see the <code>bluetoothctl</code> prompt change from <code>[bluetooth]#</code> to the name of your connected device. For example, for my VERSE headphones, the <code>bluetoothctl</code> prompt changes to <code>[VERSE]#</code>.
</p>

<p>
If your speaker/headphones has connected successfully, type <code>trust XX:XX:XX:XX:XX:XX</code> where XX represents the Bluetooth MAC address of your speaker/headphones. For example, for my VERSE Headphones, I type <code>trust 1C:A0:D3:D2:AE:75</code>. Trusting your Bluetooth speaker/headphones will allow them to auto connect in the future.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Pair, Trust and Connect Bluetooth Speaker\/Headphones&quot;,&quot;hid&quot;:&quot;pair_trust_and_connect_bluetooth_speakerheadphones&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:4,&quot;range&quot;:&quot;6833-8191&quot;} -->
<h3 class="sectionedit5" id="testing_and_debugging_the_bluetooth_connection">Testing and Debugging the Bluetooth Connection</h3>
<div class="level3">

<p>
If your OpenWrt router has Internet access and you live in a country that does not block Google, issue the following command while logged into your OpenWrt router.
</p>
<pre class="code">wget --quiet -O - -U &quot;stream-mp3/mpg123/0.59r&quot; &#039;http://translate.google.com/translate_tts?ie=UTF-8&amp;client=tw-ob&amp;q=Joy%20to%20the%20world&amp;tl=en&#039; | madplay -Q -o wave:- - | paplay</pre>

<p>
If you do not hear <em>Joy to the world</em> on your connected  Bluetooth speaker/headphones, try rebooting your OpenWrt router and running <code>bluetoothd</code> and <code>pulseaudio</code> manually in debug mode and look for any error messages.
</p>

<p>
If you are still having problems, connect your Bluetooth dongle to a Debian machine and follow the steps in the previous section to pair. connect and trust your Bluetooth speaker/headphones. If you can connect successfully, copy everything in your Debian <code>/var/lib/bluetooth</code> directory to your OpenWrt <code> /etc/bluetooth/keys</code> directory. Reconnect your Bluetooth dongle to your OpenWrt router and reboot. Your Bluetooth speaker/headphones should now connect automatically to your OpenWrt router. 
</p>

<p>
If your have your Bluetooth speaker/headphone paired with multiple devices, auto-connection may not always occur. Log into your OpenWrt router and issue the command
</p>
<pre class="code">bluetoothctl connect XX:XX:XX:XX:XX:XX</pre>

<p>
 where XX:XX:XX:XX:XX:XX is the MAC address of your Bluetooth speaker/headphones.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Testing and Debugging the Bluetooth Connection&quot;,&quot;hid&quot;:&quot;testing_and_debugging_the_bluetooth_connection&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:5,&quot;range&quot;:&quot;8192-9629&quot;} -->
<h3 class="sectionedit6" id="mpd_configuration">MPD Configuration</h3>
<div class="level3">

<p>
We will be using <a href="https://www.musicpd.org/" class="urlextern" title="https://www.musicpd.org/" rel="ugc nofollow">mpd</a> to play our music through our Bluetooth headphones/speakers.
</p>
<ul>
<li class="level1"><div class="li"> Place all your music in your OpenWrt router <code>/data/share/mp3</code> directory</div>
</li>
<li class="level1"><div class="li"> Place your playlists in your <code>/data/share/mp3/playlists</code> directory</div>
</li>
</ul>

<p>
Sample playlist file which contains music files.
</p>

<p>
<code>Moby.m3u</code>
</p>
<pre class="code">/data/share/mp3/moby/everything_is_wrong/Moby - Everything Is Wrong - 13 - When It&#039;s Cold I&#039;d Like To Die.flac
/data/share/mp3/moby/i_like_to_score/01_novio.mp3
/data/share/mp3/moby/play/03 Radio 4.mp3
/data/share/mp3/moby/play/04 Toss The Feathers.mp3</pre>

<p>
Sample playlist file which contains Radio streams.
</p>

<p>
<code>Radio.m3u</code>
</p>
<pre class="code">https://kexp-mp3-128.streamguys1.com/kexp128.mp3
https://onair.wfuv.org/onair-hi
http://listen.noagendastream.com/noagenda
http://icecast-ruvr.cdnvideo.ru/rian.voiceusa
http://stream.wqxr.org/wqxr</pre>
<ul>
<li class="level1"><div class="li"> Modify your <code>/etc/mpd.conf</code> file to look like the below.</div>
</li>
</ul>
<pre class="code">music_directory		&quot;/data/share/mp3&quot;
playlist_directory	&quot;/data/share/mp3/playlists&quot;
db_file			&quot;/data/mpd/tag_cache&quot;
pid_file		&quot;/data/mpd/pid&quot;
state_file		&quot;/data/mpd/state&quot;
sticker_file		&quot;/data/mpd/sticker.sql&quot;

audio_output {
	type		&quot;pipe&quot;
	name		&quot;mypipe&quot;
	command		&quot;/usr/bin/pacat --rate=44100 --format=s16le --channels=2 2&gt;/dev/null&quot;
	format		&quot;44100:16:2&quot;
}</pre>

<p>
 <img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> Note that you must manually create any directories that do not exist.
</p>
<ul>
<li class="level1"><div class="li"> Reboot your OpenWrt router and then issue the command <code>mpc update</code></div>
</li>
</ul>

<p>
Once the update has completed, you can now create and load playlists and play music using <a href="https://www.musicpd.org/clients/mpc/" class="urlextern" title="https://www.musicpd.org/clients/mpc/" rel="ugc nofollow">mpc</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;MPD Configuration&quot;,&quot;hid&quot;:&quot;mpd_configuration&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:6,&quot;range&quot;:&quot;9630-11254&quot;} -->
<h3 class="sectionedit7" id="controlling_music_playback_with_your_headphonesspeaker">Controlling Music Playback with your Headphones/Speaker</h3>
<div class="level3">

<p>
If your headphones/speaker supports the Bluetooth <a href="https://en.wikipedia.org/wiki/List_of_Bluetooth_profiles#Audio%2FVideo_Remote_Control_Profile_%28AVRCP%29" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/List_of_Bluetooth_profiles#Audio%2FVideo_Remote_Control_Profile_%28AVRCP%29">AVRCP</a> profile, you can use the Play/Pause/Next/Previous buttons on your speaker/headphones to control music playback. In Linux, these buttons can be read just like any other keyboard event.
</p>

</div>

<h4 id="set_up_cross-compiling_environment">Set up cross-compiling environment</h4>
<div class="level4">

<p>
Follow the instructions <a href="https://electrosome.com/cross-compile-openwrt-c-program/" class="urlextern" title="https://electrosome.com/cross-compile-openwrt-c-program/" rel="ugc nofollow">here</a> to set up a cross-compiling environment. Be sure to pull the environment that matches the OpenWrt version on your router.
</p>

<p>
My cross-compile environmental variables which need to be set before I cross-compile are as follows
</p>
<pre class="code">export STAGING_DIR=/home/user/openwrt/staging_dir
export TOOLCHAIN_DIR=$STAGING_DIR/toolchain-mipsel_24kc_gcc-7.3.0_musl
export LDCFLAGS=$TOOLCHAIN_DIR/usr/lib
export LD_LIBRARY_PATH=$TOOLCHAIN_DIR/usr/lib
export PATH=$TOOLCHAIN_DIR/bin:$PATH</pre>

</div>

<h4 id="compile_buttonloggerc">Compile buttonlogger.c</h4>
<div class="level4">

<p>
Anywhere on your cross-compile computer, create a file <code>buttonlogger.c</code> with the following contents. 
</p>
<pre class="code">#include &lt;fcntl.h&gt;
#include &lt;linux/input.h&gt;
#include &lt;unistd.h&gt;
#include &lt;signal.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;



int main(int argc, char *argv[])
{

        if (argc &lt; 2) {
                fprintf(stderr, &quot;Need /dev/input/eventx arguement\n&quot;);
                return 1;
        }


        int device = open(argv[1], O_RDONLY);
        struct input_event ev;


        read(device,&amp;ev, sizeof(ev));
        if(ev.type == 1 &amp;&amp; ev.value == 1)buttonlogger /dev/input/event0{
              /* printf(&quot;Key: %i State: %i\n&quot;,ev.code,ev.value); */
	      switch(ev.code) {
		case KEY_PLAYCD :
			printf(&quot;PLAY\n&quot;);
			break;
		case KEY_PAUSECD :
			printf(&quot;PAUSE\n&quot;);
			break;
		case KEY_NEXTSONG :
			printf(&quot;NEXT\n&quot;);
			break;
		case KEY_PREVIOUSSONG :
			printf(&quot;PREVIOUS\n&quot;);
			break;
	      }
			
        }
	else if(ev.value == 300 &amp;&amp; ev.code == 0) printf(&quot;START\n&quot;);
}</pre>

<p>
Now compile <code>buttonlogger.c</code> with your cross C compiler. For my system, the command is 
</p>
<pre class="code">mipsel-openwrt-linux-gcc -o buttonlogger buttonlogger.c</pre>

<p>
This will create an executable called <code>buttonlogger</code> which you can copy to your OpenWrt router <code>$PATH</code>.
</p>

</div>

<h4 id="test_buttonlogger">Test buttonlogger</h4>
<div class="level4">

<p>
Press your Bluetooth speaker/headphones <strong>Play</strong> button while connected to your OpenWrt router.  Then issue the following command.
</p>
<pre class="code">buttonlogger /dev/input/event0</pre>

<p>
 while logged into your OpenWrt router.
</p>

<p>
Press your Bluetooth speaker/headphones <strong>Play</strong> button again. <code>butoonlogger</code> should return <strong>PLAY</strong>. 
</p>

<p>
Your can re-issue the command 
</p>
<pre class="code">buttonlogger /dev/input/event0</pre>

<p>
 and test all your other Bluetooth speaker/headphone buttons
</p>

<p>
Notes
</p>
<ul>
<li class="level1"><div class="li"> <code>/dev/input/event0</code> is dynamically created when your Bluetooth <a href="https://en.wikipedia.org/wiki/List_of_Bluetooth_profiles#Audio%2FVideo_Remote_Control_Profile_%28AVRCP%29" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/List_of_Bluetooth_profiles#Audio%2FVideo_Remote_Control_Profile_%28AVRCP%29">AVRCP</a> profile speaker/headphones are connected to your OpenWrt router. For some speaker/headphones, you need to press the <strong>Play</strong> button before <code>/dev/input/event0</code> is created. </div>
</li>
<li class="level1"><div class="li"> The <strong>NEXT</strong> and <strong>PREVIOUS</strong> buttons will only work while audio is playing through your Bluetooth speaker/headphones.</div>
</li>
<li class="level1"><div class="li"> Similarly, the <strong>PAUSE</strong> button may only work while music is playing. </div>
</li>
<li class="level1"><div class="li"> Some Bluetooth speakers/headphones only output <strong>PLAY</strong> and never <strong>PAUSE</strong>. For these Bluetooth headphones/speakers, your controlling script will need to determine if music is currently playing so it knows whether to issue an <code>mpc play</code> or <code>mpc pause</code> command. </div>
</li>
</ul>

</div>

<h4 id="music_playback_controlling_script">Music Playback Controlling Script</h4>
<div class="level4">

<p>
I execute the following script on my OpenWrt router which allows me to use my Bluetooth speaker/headphones playback buttons to control music track playback.
</p>

<p>
 <code>button-monitor.sh</code>
</p>
<pre class="code">#!/bin/bash

# Bluetooth speaker/headphone button monitor


urlencode() {
    # urlencode &lt;string&gt;

    old_lc_collate=$LC_COLLATE
    LC_COLLATE=C

    local length=&quot;${#1}&quot;
    for (( i = 0; i &lt; length; i++ )); do
        local c=&quot;${1:$i:1}&quot;
        case $c in
            [a-zA-Z0-9.~_-]) printf &#039;%s&#039; &quot;$c&quot; ;;
            *) printf &#039;%%%02X&#039; &quot;&#039;$c&quot; ;;
        esac
    done

    LC_COLLATE=$old_lc_collate
}

google_tts() {

    # google_tts &lt;string&gt;
    
    wget --quiet -O - -U &quot;stream-mp3/mpg123/0.59r&quot; \
        &#039;http://translate.google.com/translate_tts?ie=UTF-8&amp;client=tw-ob&amp;q=&#039;$(urlencode &quot;$@&quot;)&#039;&amp;tl=en&#039; |  madplay -Q -o wave:- -
 

}

# Select Text To Speech Engine
TTS_ENGINE=&quot;google_tts&quot;


while true
do

# If result is empty, bluetooth device is not connected. Wait for new
# input device and try again
	while [ ! -e /dev/input/event0 ]
	do	
		if [ ! -d /dev/input ]
		then
			inotifywait -qqe create /dev
		else
			inotifywait -qqe create /dev/input
		fi	
	done

# Parse the output of the Bluetooth speaker/headphone buttonlogger 
# program and output voice and control mpd accordingly.
	BUTTON=$(/usr/local/bin/buttonlogger /dev/input/event0)
	case $BUTTON in
		PLAY)
                  paplay /usr/local/share/voices/play-track.wav
		  mpc -q play
		  ;;
		START)
                  paplay /usr/local/share/voices/play-track.wav
		  mpc -q play
		  ;;
		PAUSE)
	 	  CURRENT_SONG=&quot;$(mpc current | sed -e &#039;s|[&quot;&#039;\&#039;&#039;]||g&#039;)&quot;
		  mpc -q pause
                  paplay /usr/local/share/voices/pause-track.wav
		  if [ $(grep -c wlan0-1 /proc/net/wireless) -eq 1 ]
		  then
    		       $TTS_ENGINE  &quot;$CURRENT_SONG&quot; | paplay
		  fi
		  ;;
		NEXT)
		  mpc -q pause
                  paplay /usr/local/share/voices/next-track.wav
		  mpc -q next
		  ;;
		PREVIOUS)
		  mpc -q pause
                  paplay /usr/local/share/voices/previous-track.wav
		  mpc -q prev
		  ;;
	esac


done
</pre>

<p>
Notes
</p>
<ul>
<li class="level1"><div class="li"> The above script requires the <code>bash</code> shell. </div>
</li>
<li class="level1"><div class="li"> Pre-recorded <code>.wav</code> files are in my OpenWrt router <code>/usr/local/share/voices/</code> directory. The script plays the appropriate voice file when a Bluetooth speaker/headphone button is pressed.</div>
</li>
<li class="level1"><div class="li"> When my OpenWrt has Internet access (is in <a href="/docs/guide-user/network/wifi/ap_sta" class="wikilink1" title="docs:guide-user:network:wifi:ap_sta" data-wiki-id="docs:guide-user:network:wifi:ap_sta">AP+STA</a> mode) and the speaker/headphones <strong>Pause</strong> button is pressed, the script uses the <code>mpc current</code> command to retrieve the current track artist and song title, urlencode this information, send the text to Google for text to speech conversion and then play the result on my Bluetooth speaker/headphones.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Controlling Music Playback with your Headphones\/Speaker&quot;,&quot;hid&quot;:&quot;controlling_music_playback_with_your_headphonesspeaker&quot;,&quot;codeblockOffset&quot;:12,&quot;secid&quot;:7,&quot;range&quot;:&quot;11255-17614&quot;} -->
<h3 class="sectionedit8" id="controlling_mpd_via_a_web_browser">Controlling MPD via a Web Browser</h3>
<div class="level3">

<p>
Rather than ssh into your OpenWrt router and control <a href="https://www.musicpd.org/" class="urlextern" title="https://www.musicpd.org/" rel="ugc nofollow">mpd</a> via <a href="https://www.musicpd.org/clients/mpc/" class="urlextern" title="https://www.musicpd.org/clients/mpc/" rel="ugc nofollow">mpc</a>, we will control the OpenWrt <a href="https://www.musicpd.org/" class="urlextern" title="https://www.musicpd.org/" rel="ugc nofollow">mpd</a> daemon via an <abbr title="HyperText Markup Language">HTML</abbr> 5 compliant Web browser. Note that the latest versions of Firefox and Safari are <abbr title="HyperText Markup Language">HTML</abbr> 5 compliant. <a href="https://www.ympd.org/" class="urlextern" title="https://www.ympd.org/" rel="ugc nofollow">ympd</a> is extremely lightweight and fast since it is written in C, uses web-sockets and <abbr title="HyperText Markup Language">HTML</abbr> 5 putting all the CPU load on the client Web browser. <a href="https://www.ympd.org/" class="urlextern" title="https://www.ympd.org/" rel="ugc nofollow">ympd</a> even includes an extremely lightweight web server in its executable. With <a href="https://www.ympd.org/" class="urlextern" title="https://www.ympd.org/" rel="ugc nofollow">ympd</a>, you will be able to use your Smart Phone, Tablet or PC web browser to search for music, create playlists, start/stop/next/previous track and seek to different times within a track while your Smart Phone is connected to your OpenWrt <a href="/docs/guide-quick-start/basic_wifi" class="wikilink1" title="docs:guide-quick-start:basic_wifi" data-wiki-id="docs:guide-quick-start:basic_wifi">AP</a>. Neither your Smart Phone/Tablet/PC or your OpenWrt router needs to have Internet Access for this to work. I assume your already set up a successful cross-compiler environment as is described in the previous section.
</p>

</div>

<h4 id="build_libmpdclient">Build libmpdclient</h4>
<div class="level4">

<p>
Download and extract the source code for libmpdclient which can be found <a href="https://github.com/MusicPlayerDaemon/libmpdclient" class="urlextern" title="https://github.com/MusicPlayerDaemon/libmpdclient" rel="ugc nofollow">here</a>. Install both <a href="https://en.wikipedia.org/wiki/Ninja_(build_system)" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Ninja_(build_system)">ninja</a> and <a href="https://mesonbuild.com/" class="urlextern" title="https://mesonbuild.com/" rel="ugc nofollow">meson</a> on your Linux cross-compiler computer. For Debian based Linux, the commands are
</p>
<pre class="code">sudo apt install ninja-build
sudo apt install meson</pre>

<p>
In the <code>build/cross</code> sub-directory create a file called <code>openwrt.txt</code>. My <code>openwrt.txt</code> file is as follows
</p>
<pre class="code">[binaries]
c = &#039;/home/user/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-7.3.0_musl/bin/mipsel-openwrt-linux-gcc&#039;
cpp = &#039;/home/user/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-7.3.0_musl/bin/mipsel-openwrt-linux-g++&#039;
ar = &#039;/home/user/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-7.3.0_musl/bin/mipsel-openwrt-linux-ar&#039;
strip = &#039;/home/user/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-7.3.0_musl/bin/mipsel-openwrt-linux-musl-strip&#039;
pkgconfig = &#039;/home/user/openwrt/Programs/libmpdclient-2.19/build/openwrt/pkg-config.sh&#039;

[properties]
root = &#039;/home/user/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-7.3.0_musl&#039;

[host_machine]
system = &#039;linux&#039;
cpu_family = &#039;mips&#039;
cpu = &#039;mips&#039;
endian = &#039;big&#039;</pre>

<p>
Modify the above for your environment as per <a href="https://mesonbuild.com/Cross-compilation.html" class="urlextern" title="https://mesonbuild.com/Cross-compilation.html" rel="ugc nofollow">here</a>. Then issue the following commands.
</p>
<pre class="code">meson . output --cross-file build/cross/openwrt.txt
ninja -C output
ninja -C output install</pre>

<p>
Verify that the following files were installed correctly into the cross compiling environment.
</p>
<pre class="code">ls /home/user/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-7.3.0_musl/usr/include/mpd

async.h         entity.h       neighbor.h   protocol.h     socket.h
audio_format.h  error.h        output.h     queue.h        song.h
capabilities.h  fingerprint.h  pair.h       recv.h         stats.h
client.h        idle.h         parser.h     replay_gain.h  status.h
compiler.h      list.h         partition.h  response.h     sticker.h
connection.h    message.h      password.h   search.h       tag.h
database.h      mixer.h        player.h     send.h         version.h
directory.h     mount.h        playlist.h   settings.h     version.h.in</pre>
<pre class="code">ls -l /home/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-7.3.0_musl/usr/lib

lrwxrwxrwx 1 user user     20 Oct 16 20:28 libmpdclient.so -&gt; libmpdclient.so.2.19
lrwxrwxrwx 1 user user     20 Oct 16 20:28 libmpdclient.so.2 -&gt; libmpdclient.so.2.19
-rwxrwxr-x 1 user user 391700 Oct 16 20:27 libmpdclient.so.2.19</pre>

<p>
 <img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> Note that your build environment cross-compiling paths may differ.
</p>

</div>

<h4 id="build_ympd">Build ympd</h4>
<div class="level4">

<p>
Download and extract the source code for <a href="https://www.ympd.org/" class="urlextern" title="https://www.ympd.org/" rel="ugc nofollow">ympd</a> which can be found <a href="https://github.com/notandy/ympd" class="urlextern" title="https://github.com/notandy/ympd" rel="ugc nofollow">here</a>. Install <a href="https://en.wikipedia.org/wiki/CMake" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/CMake">cmake</a> on your Linux cross-compiler computer. For Debian based Linux, the command is 
</p>
<pre class="code">sudo apt install cmake</pre>

<p>
Create a <code>cmake</code> cross-compiling definition file as per the instructions <a href="https://cmake.org/cmake/help/latest/manual/cmake-toolchains.7.html#cross-compiling-for-linux" class="urlextern" title="https://cmake.org/cmake/help/latest/manual/cmake-toolchains.7.html#cross-compiling-for-linux" rel="ugc nofollow">here</a>. My <code>cmake</code> cross-compiling definition file, which I named <code>ympd.cross</code> is below.
</p>
<pre class="code">set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR mips)
set(CMAKE_SYSROOT /home/user/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-7.3.0_musl)
set(tools /home/user/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-7.3.0_musl)
set(CMAKE_C_COMPILER ${tools}/bin/mipsel-openwrt-linux-gcc)
set(CMAKE_CXX_COMPILER ${tools}/bin/mipsel-openwrt-linux-g++)
set(include_directories ${tools}/usr/include)</pre>

<p>
 <img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> Note that your build environment cross-compiling paths may differ.
</p>

<p>
Execute the following commands in the <code>ympd</code> diectory.
</p>
<pre class="code">cmake -DCMAKE_TOOLCHAIN_FILE=/home/user/openwrt/ympd/ympd.cross -DWITH_SSL=no
make</pre>

<p>
Copy <code>ympd</code> to somewhere in your OpenWrt router <code>$PATH</code>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Controlling MPD via a Web Browser&quot;,&quot;hid&quot;:&quot;controlling_mpd_via_a_web_browser&quot;,&quot;codeblockOffset&quot;:18,&quot;secid&quot;:8,&quot;range&quot;:&quot;17615-22633&quot;} -->
<h3 class="sectionedit9" id="automatic_start">Automatic Start</h3>
<div class="level3">

<p>
Start up everything automatically at power up by adding <code>button-monitor.sh</code> and <code>ympd</code> to your OpenWrt router <code>/etc/rc.local</code> file. My <code>/etc/rc.local</code> file contents are as follows.
</p>
<pre class="code"># Put your custom commands here that should be executed once
# the system init finished. By default this file does nothing.

/usr/local/bin/ympd -w 80 &amp;

/usr/local/bin/button-monitor.sh &amp;

exit 0</pre>

<p>
When I power up my OpenWrt router, my Bluetooth speaker/headphones automatically connects and I can start playing music my simply pressing my Bluetooth speaker&#039;s/headphones&#039; play button. If I want to change the playlist, I simply connect my Smart Phone or tablet to my OpenWrt <a href="/docs/guide-quick-start/basic_wifi" class="wikilink1" title="docs:guide-quick-start:basic_wifi" data-wiki-id="docs:guide-quick-start:basic_wifi">AP</a> and browse to <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">LuCI</a>.
</p>

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> Since I don&#039;t use <a href="/docs/guide-user/luci/start" class="wikilink1" title="docs:guide-user:luci:start" data-wiki-id="docs:guide-user:luci:start">LUCI</a> and want to free up port 80 for <code>ympd</code>, I have disabled <code>uhttpd</code> by issuing the following command.
</p>
<pre class="code">/etc/init.d/uhttpd disable</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Automatic Start&quot;,&quot;hid&quot;:&quot;automatic_start&quot;,&quot;codeblockOffset&quot;:26,&quot;secid&quot;:9,&quot;range&quot;:&quot;22634-23648&quot;} -->
<h3 class="sectionedit10" id="todo">TODO</h3>
<div class="level3">

<p>
Since OpenWrt does not include the <a href="https://packages.debian.org/sid/ofono" class="urlextern" title="https://packages.debian.org/sid/ofono" rel="ugc nofollow">ofono</a> package, we cannot get audio from the Bluetooth speaker/headphones microphone. If OpenWrt did include the <a href="https://packages.debian.org/sid/ofono" class="urlextern" title="https://packages.debian.org/sid/ofono" rel="ugc nofollow">ofono</a> and the <a href="https://packages.debian.org/sid/darkice" class="urlextern" title="https://packages.debian.org/sid/darkice" rel="ugc nofollow">Darkice</a> package, we could take audio from the the Bluetooth speaker/headphones microphone, send it to an <a href="https://icecast.org/" class="urlextern" title="https://icecast.org/" rel="ugc nofollow">Icecast</a> server and listen or capture it as an audio stream.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;TODO&quot;,&quot;hid&quot;:&quot;todo&quot;,&quot;codeblockOffset&quot;:28,&quot;secid&quot;:10,&quot;range&quot;:&quot;23649-&quot;} -->