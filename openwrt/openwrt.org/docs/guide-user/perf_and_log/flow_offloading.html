


<h1 class="sectionedit1" id="flow_offloading">Flow offloading</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:construction&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:construction" id="plugin_include__meta__infobox__construction">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_center wrap_construction plugin_wrap" style="width: 70%;">
<p>
<strong>Under Construction!</strong><br/>

This page is currently under construction. You can edit the article to help completing it.
</p>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:construction&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Flow offloading&quot;,&quot;hid&quot;:&quot;flow_offloading&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;97-191&quot;} -->
<h2 class="sectionedit6" id="intro">Intro</h2>
<div class="level2">

<p>
The <em>Flow offload</em> may significantly increases throughput of device with slow CPU.
</p>

<p>
Some facts:
</p>
<ul>
<li class="level1"><div class="li"> Technically, the <em>software flow offload</em> is just a firewall rule.</div>
</li>
<li class="level1"><div class="li"> Neither flow forwarding offload is directly related to network adapter offload functions controlled by <code>ethtool -k/-K</code>.</div>
</li>
<li class="level1"><div class="li"> Flow offloading applies to forwarded connections, including those to containers like <a href="/lxc_openwrt_host" class="wikilink1" title="lxc_openwrt_host" data-wiki-id="lxc_openwrt_host">LXC</a> or <a href="/packages/pkgdata/podman" class="wikilink1" title="packages:pkgdata:podman" data-wiki-id="packages:pkgdata:podman">podman</a>, but not locally running web-server.</div>
</li>
<li class="level1"><div class="li"> <em>Hardware offload</em> bypasses <abbr title="Quality of Service">QoS</abbr> traffic controls at high priority making former ineffective.</div>
</li>
<li class="level1"><div class="li"> <em>Hardware offload</em> can handle very limited number of connections at once, e.g. 64, thus will not significantly help p2p, returning surplus connections to software offload pool.</div>
</li>
<li class="level1"><div class="li"> <em>Software offload</em> typically increases forwarding bandwidth 2-3x over firewall filtering each packet, sometimes that relieves fully loaded CPU and improves overall latency/jitter.</div>
</li>
</ul>

<p>
Abbreviations:
</p>
<ul>
<li class="level1"><div class="li"> <abbr title="Hardware flow offloading">HFO</abbr> — hardware flow offloading.</div>
</li>
<li class="level1"><div class="li"> <abbr title="Wireless Ethernet dispatch">WED</abbr> — wireless offloading, wireless Ethernet dispatch.</div>
</li>
<li class="level1"><div class="li"> <abbr title="Packet processing engine">PPE</abbr> — kernel interface for hardware flow offload, monitored via <code>/sys/kernel/debug/ppe0/entries</code> special file.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Intro&quot;,&quot;hid&quot;:&quot;intro&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;192-1539&quot;} -->
<h2 class="sectionedit7" id="how_to_enable">How to enable</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;How to enable&quot;,&quot;hid&quot;:&quot;how_to_enable&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;1540-1566&quot;} -->
<h3 class="sectionedit8" id="luci_web_ui">LuCI web UI</h3>
<div class="level3">

<p>
Using LuCI web UI: <code>Network → Firewall</code> and select “Software flow offloading” or “Hardware flow offloading”, then hit “Save &amp; Apply”.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;LuCI web UI&quot;,&quot;hid&quot;:&quot;luci_web_ui&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;1567-1727&quot;} -->
<h3 class="sectionedit9" id="uci">UCI</h3>
<div class="level3">

<p>
CLI with <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">UCI</a> (choose the one option you want):
</p>
<pre class="code shell">uci set 'firewall.@defaults[0].flow_offloading=1'
uci set 'firewall.@defaults[0].flow_offloading_hw=1'
uci commit
/etc/init.d/firewall restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;UCI&quot;,&quot;hid&quot;:&quot;uci&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;1728-1990&quot;} -->
<h3 class="sectionedit10" id="cli">CLI</h3>
<div class="level3">

<p>
CLI: edit <code>/etc/config/firewall</code> and insert the following under the config defaults section (choose the one option you want):
</p>
<pre class="code ini">config defaults
…
  option flow_offloading <span class="st0">'1'</span>
  option flow_offloading_hw <span class="st0">'1'</span></pre>

<p>
Then restart the firewall:
</p>
<pre class="code shell">/etc/init.d/firewall restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;CLI&quot;,&quot;hid&quot;:&quot;cli&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:10,&quot;range&quot;:&quot;1991-2313&quot;} -->
<h2 class="sectionedit11" id="hardware_implementation">Hardware implementation</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Hardware implementation&quot;,&quot;hid&quot;:&quot;hardware_implementation&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:11,&quot;range&quot;:&quot;2314-2350&quot;} -->
<h3 class="sectionedit12" id="mediatek_mt76">MediaTek mt76</h3>
<div class="level3">

<p>
The main page about MediaTek chipsets: <a href="/docs/techref/hardware/soc/soc.mediatek" class="wikilink1" title="docs:techref:hardware:soc:soc.mediatek" data-wiki-id="docs:techref:hardware:soc:soc.mediatek">soc.mediatek</a>.
</p>

<p>
Hardware offloading is supported on <a href="/docs/techref/driver.wlan/mt76" class="wikilink1" title="docs:techref:driver.wlan:mt76" data-wiki-id="docs:techref:driver.wlan:mt76">mt76</a> platforms starting from <a href="/docs/techref/hardware/soc" class="wikilink1" title="docs:techref:hardware:soc" data-wiki-id="docs:techref:hardware:soc">SoC</a> mt7621.
</p>

<p>
WED enablement (i.e hardware offloading for Wi-Fi): TODO.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;MediaTek mt76&quot;,&quot;hid&quot;:&quot;mediatek_mt76&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:12,&quot;range&quot;:&quot;2351-2660&quot;} -->
<h2 class="sectionedit13" id="known_issues">Known issues</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> The <em>Hardware offload</em> is supported by limited amount of platforms.</div>
</li>
<li class="level1"><div class="li"> Stale connections/freezes when changing Wi-Fi band (for example from 2.4 <abbr title="Gigahertz">GHz</abbr> to 5 <abbr title="Gigahertz">GHz</abbr>).</div>
</li>
<li class="level1"><div class="li"> Prevents Wi-Fi roaming by keeping stale connection mappings.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Known issues&quot;,&quot;hid&quot;:&quot;known_issues&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:13,&quot;range&quot;:&quot;2661-2918&quot;} -->
<h2 class="sectionedit14" id="links">Links</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="https://www.kernel.org/doc/html/v5.15/networking/nf_flowtable.html" class="urlextern" title="https://www.kernel.org/doc/html/v5.15/networking/nf_flowtable.html" rel="ugc nofollow">Netfilter’s flowtable infrastructure</a> — the Linux kernel documentation with description of both <em>Software flow offload</em> and <em>Hardware offload</em> and with a list of limitations.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Links&quot;,&quot;hid&quot;:&quot;links&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:14,&quot;range&quot;:&quot;2919-&quot;} -->