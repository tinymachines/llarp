
<h1 class="sectionedit1" id="qos_configurationetcconfigqos">QoS configuration /etc/config/qos</h1>
<div class="level1">

<p>
This is the documentation for the UCI configuration file <code>/etc/config/qos</code>. It is used by the package <code>qos-scripts</code> only.
</p>
<div class="table sectionedit2"><table class="inline">
	<tr class="row0">
		<td class="col0"> <img src="/_media/meta/icons/tango/48px-emblem-important.svg.png" class="media" loading="lazy" alt="" /> </td><td class="col1"> Do NOT install multiple <abbr title="Quality of Service">QoS</abbr>-packages simultaneously! Uninstall the old package before installing a new one. <br/>
There are at least two other <abbr title="Quality of Service">QoS</abbr>/ToS packages in the OpenWrt repositories regarding: <code><a href="https://github.com/openwrt/packages/blob/master/net/sqm-scripts" class="urlextern" title="https://github.com/openwrt/packages/blob/master/net/sqm-scripts" rel="ugc nofollow">sqm-scripts</a></code> and <code><a href="https://github.com/openwrt/packages/tree/master/net/wshaper" class="urlextern" title="https://github.com/openwrt/packages/tree/master/net/wshaper" rel="ugc nofollow">wshaper</a></code>. They do NOT use this file.<br/>
<br/>
<code>sqm-scripts</code> is the most modern and has Luci support. Configuration advice for it can be found at <a href="http://www.bufferbloat.net/projects/cerowrt/wiki/Setting_up_SQM_for_CeroWrt_310" class="urlextern" title="http://www.bufferbloat.net/projects/cerowrt/wiki/Setting_up_SQM_for_CeroWrt_310" rel="ugc nofollow">http://www.bufferbloat.net/projects/cerowrt/wiki/Setting_up_SQM_for_CeroWrt_310</a> <br/>
<code>qos-scripts</code> is written in AWK/shell script and uses <a href="/docs/guide-user/network/traffic-shaping/sch_hfsc" class="wikilink1" title="docs:guide-user:network:traffic-shaping:sch_hfsc" data-wiki-id="docs:guide-user:network:traffic-shaping:sch_hfsc">sch_hfsc</a> and <a href="/docs/guide-user/network/traffic-shaping/sch_fq_codel" class="wikilink1" title="docs:guide-user:network:traffic-shaping:sch_fq_codel" data-wiki-id="docs:guide-user:network:traffic-shaping:sch_fq_codel">sch_fq_codel</a><br/>
<code>wshaper</code> uses <a href="/docs/guide-user/network/traffic-shaping/sch_sfq" class="wikilink1" title="docs:guide-user:network:traffic-shaping:sch_sfq" data-wiki-id="docs:guide-user:network:traffic-shaping:sch_sfq">sch_sfq</a> <a href="/docs/guide-user/network/traffic-shaping/sch_htb" class="wikilink1" title="docs:guide-user:network:traffic-shaping:sch_htb" data-wiki-id="docs:guide-user:network:traffic-shaping:sch_htb">sch_htb</a> <a href="/doc/howto/packet.scheduler/act_police" class="wikilink2" title="doc:howto:packet.scheduler:act_police" rel="nofollow" data-wiki-id="doc:howto:packet.scheduler:act_police">act_police</a>; <a href="http://lartc.org/wondershaper/" class="urlextern" title="http://lartc.org/wondershaper/" rel="ugc nofollow">http://lartc.org/wondershaper/</a> (Last release has been in 2002, so it is mostly unmaintained) <br/>
<br/>
For help writing your own script please see <a href="/docs/guide-user/network/traffic-shaping/packet.scheduler" class="wikilink1" title="docs:guide-user:network:traffic-shaping:packet.scheduler" data-wiki-id="docs:guide-user:network:traffic-shaping:packet.scheduler">Traffic Control on OpenWrt: configuring the Linux Network Scheduler</a>. </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;176-1434&quot;} --><div class="table sectionedit3"><table class="inline">
	<tr class="row0">
		<td class="col0"> <img src="/_media/meta/icons/tango/dialog-information.png" class="media" loading="lazy" alt="" /> </td><td class="col1"> You can browse the scripts here: <code><a href="https://dev.openwrt.org/browser/trunk/package/network/config/qos-scripts" class="urlextern" title="https://dev.openwrt.org/browser/trunk/package/network/config/qos-scripts" rel="ugc nofollow">qos-scripts</a></code><br/>
There is direct LuCI-support for <code>qos-scripts</code> called: <code>luci-app-qos</code>.<br/>
NOTE: <code>luci-app-qos</code> won&#039;t start until you enable the <code>qos</code> Initscript within the System-→Startup tab as well as enable qos under Network-→<abbr title="Quality of Service">QoS</abbr> </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table1&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;1436-1847&quot;} --><div class="table sectionedit4"><table class="inline">
	<tr class="row0">
		<td class="col0"> <img src="/_media/meta/icons/tango/48px-outdated.svg.png" class="media" loading="lazy" alt="" /> </td><td class="col1"> As of <a href="https://dev.openwrt.org/changeset/31759" class="urlextern" title="https://dev.openwrt.org/changeset/31759" rel="ugc nofollow">r31759</a> <code>qos-scripts</code> replaced sfq/red with fq_codel to massively improve latency under load. <br/>
<br/>
As of <a href="https://dev.openwrt.org/changeset/25641/trunk" class="urlextern" title="https://dev.openwrt.org/changeset/25641/trunk" rel="ugc nofollow">r25641</a> <code>qos-scripts</code> dropped the use of IMQ (package <code>iptables-mod-imq</code> – Intermediate Queueing Device). Its successor is <a href="http://www.linuxfoundation.org/collaborate/workgroups/networking/ifb" class="urlextern" title="http://www.linuxfoundation.org/collaborate/workgroups/networking/ifb" rel="ugc nofollow">IFB (Intermediate Functional Block device)</a>, (requires package: <code>kmod-ifb</code> and the scheduler action <em><a href="https://dev.openwrt.org/browser/trunk/package/iproute2/patches/200-act_connmark.patch?rev=25639" class="urlextern" title="https://dev.openwrt.org/browser/trunk/package/iproute2/patches/200-act_connmark.patch?rev=25639" rel="ugc nofollow">act_connmark</a></em> included).</td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table2&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;1849-2541&quot;} -->
<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> <code>luci-app-qos</code> won’t start until you enable the <code>qos</code> Initscript within the System-→Startup tab as well as enable qos under Network-→QoS
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;QoS configuration \/etc\/config\/qos&quot;,&quot;hid&quot;:&quot;qos_configurationetcconfigqos&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-2694&quot;} -->
<h2 class="sectionedit5" id="sections">Sections</h2>
<div class="level2">

<p>
A minimal <abbr title="Quality of Service">QoS</abbr> configuration usually consists of:
</p>
<ul>
<li class="level1"><div class="li"> one <em>interface</em> section</div>
</li>
<li class="level1"><div class="li"> some <em>rules</em> allocating packets to at least two buckets</div>
</li>
<li class="level1"><div class="li"> <em>configuration</em> of the buckets.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Sections&quot;,&quot;hid&quot;:&quot;sections&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;2695-2895&quot;} -->
<h3 class="sectionedit6" id="interface">Interface</h3>
<div class="level3">

<p>
Each Interface can have its own buffer. The <code>interface</code> section declares global characteristics of the connection on which the specified interface is communicating. The following options are defined within this section:
</p>
<pre class="code bash">config interface dsl
        option enabled      <span class="nu0">1</span>
        option classgroup  <span class="st0">&quot;Default&quot;</span>
        option overhead     <span class="nu0">1</span>
        option upload       <span class="nu0">512</span>
        option download     <span class="nu0">4096</span></pre>
<div class="table sectionedit7"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Name </th><th class="col1"> Type </th><th class="col2"> Required </th><th class="col3"> Default </th><th class="col4"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>enabled</code> </td><td class="col1"> boolean </td><td class="col2"> yes </td><td class="col3"> <code>1</code> </td><td class="col4"> Enable/Disable <abbr title="Quality of Service">QoS</abbr> </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>classgroup</code> </td><td class="col1"> string </td><td class="col2"> yes </td><td class="col3"> <code>Default</code> </td><td class="col4"> Specify <code>classgroup</code> used for this interface (see description of <code>classgroup</code> below) </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>overhead</code> </td><td class="col1"> boolean </td><td class="col2"> yes </td><td class="col3"> <code>1</code> </td><td class="col4"> decrease upload and download ratio to prevent link saturation </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code>download</code> </td><td class="col1"> integer </td><td class="col2"> yes </td><td class="col3"> <code>4096</code> </td><td class="col4"> Download limit in <code>kilobits/second</code> </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <code>upload</code> </td><td class="col1"> integer </td><td class="col2"> yes </td><td class="col3"> <code>512</code> </td><td class="col4"> Upload limit in <code>kilobits/second</code> </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table3&quot;,&quot;secid&quot;:7,&quot;range&quot;:&quot;3343-3861&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Interface&quot;,&quot;hid&quot;:&quot;interface&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;2896-3862&quot;} -->
<h3 class="sectionedit8" id="rules">Rules</h3>
<div class="level3">

<p>
Each <code>classify</code> section defines one group of packets and which target (i.e. bucket) this group belongs to. All the packets share the bucket specified.
</p>
<div class="table sectionedit9"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Name </th><th class="col1"> Type </th><th class="col2"> Required </th><th class="col3"> Default </th><th class="col4"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>target</code> </td><td class="col1"> bucket </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> The four defaults are: <code>Priority, Express, Normal</code> and <code>Bulk</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>proto</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <code>0</code> </td><td class="col4"> Packets matching this protocol belong to the bucket defined in target </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>srchost</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this source host(s) (single <abbr title="Internet Protocol">IP</abbr> or in CIDR notation) belong to the bucket defined in target </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code>dsthost</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this destination host(s) (single <abbr title="Internet Protocol">IP</abbr> or in CIDR notation) belong to the bucket defined in target </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <code>ports</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this, belong to the bucket defined in target </td>
	</tr>
	<tr class="row6">
		<td class="col0"> <code>srcports</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this, belong to the bucket defined in target </td>
	</tr>
	<tr class="row7">
		<td class="col0"> <code>dstports</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this, belong to the bucket defined in target </td>
	</tr>
	<tr class="row8">
		<td class="col0"> <code>portrange</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this, belong to the bucket defined in target </td>
	</tr>
	<tr class="row9">
		<td class="col0"> <code>pktsize</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this exact length or length, a range of length separated by a dash. This is handled by the length match of iptables. </td>
	</tr>
	<tr class="row10">
		<td class="col0"> <code>tcpflags</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this, belong to the bucket defined in target </td>
	</tr>
	<tr class="row11">
		<td class="col0"> <code>mark</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this, belong to the bucket defined in target </td>
	</tr>
	<tr class="row12">
		<td class="col0"> <code>connbytes</code> </td><td class="col1"> int </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this, belong to the bucket defined in target </td>
	</tr>
	<tr class="row13">
		<td class="col0"> <code>tos</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this, belong to the bucket defined in target </td>
	</tr>
	<tr class="row14">
		<td class="col0"> <code>dscp</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this, belong to the bucket defined in target </td>
	</tr>
	<tr class="row15">
		<td class="col0"> <code>direction</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Packets matching this traffic direction (<code>in</code> or <code>out</code>) belong to the bucket defined in target </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table4&quot;,&quot;secid&quot;:9,&quot;range&quot;:&quot;4033-5898&quot;} -->
<p>
Note: the already broken &#039;layer7&#039; option was removed by r45425.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Rules&quot;,&quot;hid&quot;:&quot;rules&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:8,&quot;range&quot;:&quot;3863-5964&quot;} -->
<h3 class="sectionedit10" id="classgroup">Classgroup</h3>
<div class="level3">

<p>
As we can have more then one interface, we can have more then one classgroup.
</p>
<pre class="code bash">config classgroup <span class="st0">&quot;Default&quot;</span>
	option classes      <span class="st0">&quot;Priority Express Normal Bulk&quot;</span>
	option default      <span class="st0">&quot;Normal&quot;</span></pre>
<div class="table sectionedit11"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Name </th><th class="col1"> Type </th><th class="col2"> Required </th><th class="col3"> Default </th><th class="col4"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>classes</code> </td><td class="col1"> bucket names </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4 leftalign"> Specifies the list of  names of <em>classes</em>  </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>default</code> </td><td class="col1"> bucket name </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Defines which <em>class</em> is considered default </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table5&quot;,&quot;secid&quot;:11,&quot;range&quot;:&quot;6196-6440&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Classgroup&quot;,&quot;hid&quot;:&quot;classgroup&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:10,&quot;range&quot;:&quot;5965-6441&quot;} -->
<h3 class="sectionedit12" id="classes">Classes</h3>
<div class="level3">

<p>
Each Bucket has its own configuration.
</p>

<p>
Example:
</p>
<pre class="code bash">config class <span class="st0">&quot;Normal&quot;</span>
	option packetsize  <span class="nu0">1500</span>
	option packetdelay <span class="nu0">100</span>
	option avgrate     <span class="nu0">10</span>
	option priority    <span class="nu0">5</span></pre>
<div class="table sectionedit13"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Name </th><th class="col1"> Type </th><th class="col2"> Required </th><th class="col3"> Default </th><th class="col4"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>packetsize</code> </td><td class="col1"> integer </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> in bytes </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>packetdelay</code> </td><td class="col1"> integer </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> in ms </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>maxsize</code> </td><td class="col1"> integer </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> in bytes </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code>avgrate</code> </td><td class="col1"> integer </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Average rate for this class, value in % of bandwidth (this value uses for calculate vaues &#039;Nx&#039; of <code>&#039;tc ... hfsc rt m1 N1 d N2 m2 N3</code>&#039;) </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <code>limitrate</code> </td><td class="col1"> integer </td><td class="col2 leftalign"> no  </td><td class="col3"> 100 </td><td class="col4"> Defines to how much percent of the available bandwidth this class is capped to, value in % </td>
	</tr>
	<tr class="row6">
		<td class="col0"> <code>maxsize</code> </td><td class="col1"> integer </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> in bytes </td>
	</tr>
	<tr class="row7">
		<td class="col0"> <code>priority</code> </td><td class="col1"> integer </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> in % </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table6&quot;,&quot;secid&quot;:13,&quot;range&quot;:&quot;6647-7295&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Classes&quot;,&quot;hid&quot;:&quot;classes&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:12,&quot;range&quot;:&quot;6442-7296&quot;} -->
<h3 class="sectionedit14" id="classes_for_advanced_users">Classes (For Advanced Users)</h3>
<div class="level3">

<p>
Below is unverified technical breakdown of each /etc/config/qos class parameters. Source: <a href="http://pastebin.com/YL55na2E" class="urlextern" title="http://pastebin.com/YL55na2E" rel="ugc nofollow">http://pastebin.com/YL55na2E</a>
</p>
<pre class="code bash"><span class="co0">### Params:</span>
<span class="co0">#</span>
<span class="co0"># maxsize:</span>
<span class="co0">#       limits packet size in iptables rule</span>
<span class="co0">#</span>
<span class="co0"># avgrate: (note: sum(avgrates) ~ 100)</span>
<span class="co0">#       rt m1 = avgrate / sum (avgrate) * max_bandwidth</span>
<span class="co0">#       rt m2 = avgrate * max_bandwidth / 100</span>
<span class="co0">#       ls m1 = rt m1</span>
<span class="co0">#</span>
<span class="co0"># packetsize &amp; packetdelay: (only works if avgrate is present)</span>
<span class="co0">#       rt d = max( packetdelay, 'time required for packetsize to transfer' ) (smaller ps -&gt; smaller d)</span>
<span class="co0">#       ls d = rt d</span>
<span class="co0">#</span>
<span class="co0"># priority:</span>
<span class="co0">#       ls m2 = priority / sum (priority) * max_bandwidth</span>
<span class="co0">#</span>
<span class="co0"># limitrate:</span>
<span class="co0">#       ul rate = limitrate * max_bandwidth / 100</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Classes (For Advanced Users)&quot;,&quot;hid&quot;:&quot;classes_for_advanced_users&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:14,&quot;range&quot;:&quot;7297-8040&quot;} -->
<h2 class="sectionedit15" id="quick_start_guide">Quick start guide</h2>
<div class="level2">

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> check free space first. At least 200kb free. Run <strong>df</strong>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> if you get no left space... opkg may has been corrupted. I recommend re-flash ( sysupgrade firware file stuff ) before reboot
</p>

<p>
1. Install the qos-scripts package:
</p>
<pre class="code bash">opkg <span class="kw2">install</span> qos-scripts</pre>

<p>
2. Basic configuration using UCI command line:
</p>
<pre class="code bash">uci <span class="kw1">set</span> qos.wan.upload=<span class="nu0">1000</span>            <span class="co0"># Upload speed in kBits/s</span>
uci <span class="kw1">set</span> qos.wan.download=<span class="nu0">16000</span>         <span class="co0"># Download speed in kBits/s</span>
uci <span class="kw1">set</span> qos.wan.enabled=<span class="nu0">1</span>
uci commit qos</pre>

<p>
3. Start it and look for error output and test):
</p>
<pre class="code bash"><span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>qos start</pre>

<p>
4. Make script run at every boot up:
</p>
<pre class="code bash"><span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>qos <span class="kw3">enable</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Quick start guide&quot;,&quot;hid&quot;:&quot;quick_start_guide&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:15,&quot;range&quot;:&quot;8041-8761&quot;} -->
<h2 class="sectionedit16" id="troubleshooting">Troubleshooting</h2>
<div class="level2">

<p>
(Last updated for: Barrier Breaker 14.07)
</p>

<p>
If your <abbr title="Quality of Service">QoS</abbr> doesn&#039;t seem to be working, it may be an error or typo in the config file is preventing it from loading properly.
</p>
<ul>
<li class="level1"><div class="li"> Check <code>enabled</code> is set to 1 in <code>/etc/config/qos</code>(!)</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li"> Run <code>iptables-save</code> and check there are lines near the top prefixed with either <code>-A qos_Default</code> or <code>-A qos_Default_ct</code>, and featuring the <code>--set-xmark</code> directive. Here&#039;s an example:</div>
</li>
</ul>
<pre class="code bash"><span class="re5">-A</span> qos_Default <span class="re5">-p</span> tcp <span class="re5">-m</span> mark <span class="re5">--mark</span> 0x0<span class="sy0">/</span>0xf0 <span class="re5">-m</span> tcp <span class="re5">--sport</span> <span class="nu0">1024</span>:<span class="nu0">65535</span> <span class="re5">--dport</span> <span class="nu0">1024</span>:<span class="nu0">65535</span> <span class="re5">-j</span> MARK <span class="re5">--set-xmark</span> 0x44<span class="sy0">/</span>0xff</pre>

<p>
The <code>--set-xmark</code> is what flags the packet so it is picked up the traffic control subsystem.
</p>
<ul>
<li class="level1"><div class="li"> Look at the generated traffic control qdisc settings by running:</div>
</li>
</ul>
<pre class="code bash">tc qdisc</pre>

<p>
The default (ie no-<abbr title="Quality of Service">QoS</abbr>-applied) values for any interface look like this:
</p>
<pre class="code bash">qdisc fq_codel <span class="nu0">0</span>: dev eth0 root refcnt <span class="nu0">2</span> limit 1024p flows <span class="nu0">1024</span> quantum <span class="nu0">300</span> target 5.0ms interval 100.0ms ecn</pre>

<p>
Any interface with only a single qdisc line printed, showing the same settings as this line (this one is for <code>dev eth0</code>), indicates no <abbr title="Quality of Service">QoS</abbr> on that interface.
</p>

<p>
Network interfaces with <abbr title="Quality of Service">QoS</abbr> enabled will have multiple qdisc lines printed, each corresponding to a <abbr title="Quality of Service">QoS</abbr> class, etc.
</p>
<ul>
<li class="level1"><div class="li"> If the printed qdisc settings don&#039;t seem to be correct, you can preview the <code>tc</code> commands generated from the OpenWRT <code>/etc/config/qos</code> by running:</div>
</li>
</ul>
<pre class="code bash"><span class="sy0">/</span>usr<span class="sy0">/</span>lib<span class="sy0">/</span>qos<span class="sy0">/</span>generate.sh interface wan</pre>

<p>
(Replace <code>wan</code> with the OpenWRT interface name you&#039;re debugging, as given in the <code>/etc/config/qos</code> file.)
</p>

<p>
This should print a series of <code>insmod</code> and <code>tc</code> commands used to set up the <abbr title="Quality of Service">QoS</abbr> subsystem. You can debug any errors caused by running these commands by running:
</p>
<pre class="code bash"><span class="sy0">/</span>usr<span class="sy0">/</span>lib<span class="sy0">/</span>qos<span class="sy0">/</span>generate.sh interface wan <span class="sy0">|</span> <span class="kw2">sh</span> <span class="re5">-x</span></pre>

<p>
(Note <code>-x</code> option which tells <code>sh</code> to print each line as it is executed.)
</p>

<p>
The output of <code>/usr/lib/qos/generate.sh</code> is normally executed automatically as part of <code>/etc/hotplug.d/iface/10-qos</code>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:8,&quot;secid&quot;:16,&quot;range&quot;:&quot;8762-10800&quot;} -->
<h2 class="sectionedit17" id="txqueuelen">txqueuelen</h2>
<div class="level2">

<p>
<em>Recent versions of trunk uses <a href="http://www.bufferbloat.net/projects/codel/wiki" class="urlextern" title="http://www.bufferbloat.net/projects/codel/wiki" rel="ugc nofollow">CoDel</a> (pronounced: Coddle), so this should not be needed. <a href="http://www.bufferbloat.net/projects/bloat/wiki/Linux_Tips#Reduce-transmit-queue-length" class="urlextern" title="http://www.bufferbloat.net/projects/bloat/wiki/Linux_Tips#Reduce-transmit-queue-length" rel="ugc nofollow">bufferbloat.net</a></em>
</p>

<p>
Note: after i know about bufferbloat - websearchd and many misguided users are asking about <em>raising</em> txqueuelen, or how to set it, and this was a recommended read posted for them -, and that just enabling <abbr title="Quality of Service">QoS</abbr> and setting up the rules i wanted didnt produce results, i thought of reduce txqueuelen from the default size of 1000 packets. On most SOHO applications the upload speed is much-much lower than the interface speed (100M or 1G), and it&#039;s written that the def buffer is tailored for enterprise size usage. I used values of 90 where[only] it was 1000 and it is wonderfully responsive and effective now, on a 256k connection. I also raised lenghts of 3 and 5 to 20 as i imagined it might be hard to do any queuing/shaping on such ultra short buffers. Leave the 0-s as 0. Btw, the 90 came by, that with 1500byte packet size and 256kbit speed, it takes just half a sec to empty it. Well, i mistakenly took mtu as bits so it&#039;s 4 second really but i didnt have the courage for a drastically smaller than default value, 90 already seem so smallish, and it works nicely anyway, awesome lack of latency, jitter and packetloss on the other machine, according to <a href="http://pingtest.net" class="urlextern" title="http://pingtest.net" rel="ugc nofollow">http://pingtest.net</a>, before of this there was no difference between mine and that. Note that this time doesnt correspond to ping values. The point is to allow built-in <abbr title="Transmission Control Protocol">TCP</abbr> congestion control <em>to work</em> to reduce “spamming”, set speeds as it was envisioned, and keep things leveled out rather than fluctuating widely. While this doesnt directly effects <abbr title="Quality of Service">QoS</abbr>-ing itself, it is extremely beneficial, even essential, to the results usually expected from employing it. It sets a foundation, a healthy network environment over which <abbr title="Quality of Service">QoS</abbr> to function.
</p>
<pre class="code bash"><span class="kw2">ifconfig</span>
<span class="kw2">ifconfig</span> eth0 txqueuelen <span class="nu0">90</span>
<span class="kw2">ifconfig</span> pppoe-wan txqueuelen <span class="nu0">20</span>
uci commit
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>network reload</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;txqueuelen&quot;,&quot;hid&quot;:&quot;txqueuelen&quot;,&quot;codeblockOffset&quot;:13,&quot;secid&quot;:17,&quot;range&quot;:&quot;10801-12969&quot;} -->
<h2 class="sectionedit18" id="types_and_groups">Types and Groups</h2>
<div class="level2">

<p>
The <code>qos-scripts</code> package didn&#039;t come with documentation and there has been some confusion about its features, among users. The information in this section comes straight from nbd (the developer), so it should come a long way to clearing some confusion on two major issues.
</p>

<p>
The biggest item of contention was which group setting gives better performance, <strong>Priority</strong> or <strong>Express</strong>. As it turns out, it depends on the application. <strong>Priority</strong> boosts low-bandwidth small frames, such as <abbr title="Transmission Control Protocol">TCP</abbr>-ACKs and <abbr title="Domain Name System">DNS</abbr> more than Express. <strong>Express</strong> is for prioritizing bigger frames, which would include stuff like <abbr title="Voice over Internet Protocol">VoIP</abbr> (port 5060).
</p>

<p>
Another biggie was the exact meaning of each type. Types are necessary for connection tracking. By default, <strong>Classify</strong> is not run on a connection that had already been assigned a traffic class, so it is the initial connection-tracked classification. <strong>Reclassify</strong> can override the traffic class per packet, without altering the connection tracking mark. <strong>Default</strong> is a fall-back for everything that has not been marked by Classify/Reclassify. Rules get processed by type first (Classify gets processed first, then Reclassify and finally Default) and then based on the order in the configuration file (top to bottom).
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Types and Groups&quot;,&quot;hid&quot;:&quot;types_and_groups&quot;,&quot;codeblockOffset&quot;:14,&quot;secid&quot;:18,&quot;range&quot;:&quot;12970-14245&quot;} -->
<h2 class="sectionedit19" id="traffic_shaping">Traffic Shaping</h2>
<div class="level2">

<p>
Basic Shaping
</p>

<p>
Create a new classes at the end of qos file:
</p>
<pre class="code bash">config class <span class="st0">&quot;X1&quot;</span>
	option packetsize  <span class="nu0">1500</span>
	option packetdelay <span class="nu0">100</span>
	option avgrate     <span class="nu0">1</span>
	option limitrate   <span class="nu0">50</span>  <span class="co0"># max rate in %</span>
&nbsp;
config class <span class="st0">&quot;X2&quot;</span>
	option packetsize  <span class="nu0">1500</span>
	option packetdelay <span class="nu0">100</span>
	option avgrate     <span class="nu0">1</span>
	option limitrate   <span class="nu0">30</span>  <span class="co0"># max rate in %</span></pre>

<p>
Add it to class group:
</p>
<pre class="code bash">config classgroup <span class="st0">&quot;Default&quot;</span>
	option classes      <span class="st0">&quot;Priority Express Normal Bulk X1 X2&quot;</span>
	option default      <span class="st0">&quot;Normal&quot;</span></pre>

<p>
Add next stuff to begin of qos file, after Priority, Express...
</p>

<p>
Shaping a user:
</p>
<pre class="code bash">config classify
	option target <span class="st_h">'X1'</span>
	option srchost <span class="st_h">'192.168.1.100'</span>
	option comment <span class="st_h">'user'</span></pre>

<p>
Shaping a site:
</p>
<pre class="code bash">config classify
	option target <span class="st_h">'X1'</span>
	option dsthost <span class="st_h">'8.8.8.8'</span>
	option comment <span class="st_h">'site'</span></pre>

<p>
Two users: will share X1. Example: 500kB/s for both. Max user1+user2=500kB/s !
</p>
<pre class="code bash">config classify
	option target <span class="st_h">'X1'</span>
	option srchost <span class="st_h">'192.168.1.101'</span>
	option comment <span class="st_h">'user1'</span>
&nbsp;
<span class="sy0">&lt;</span>code <span class="kw2">bash</span><span class="sy0">&gt;</span>
config classify
	option target <span class="st_h">'X1'</span>
	option srchost <span class="st_h">'192.168.1.102'</span>
	option comment <span class="st_h">'user2'</span></pre>

<p>
Two users: diferent buckets. 500kB/s and 300kB/s .. as example. Max 500+300=800kB/s !
</p>
<pre class="code bash">config classify
	option target <span class="st_h">'X1'</span>
	option srchost <span class="st_h">'192.168.1.101'</span>
	option comment <span class="st_h">'user1'</span>
&nbsp;
config classify
	option target <span class="st_h">'X2'</span>
	option srchost <span class="st_h">'192.168.1.102'</span>
	option comment <span class="st_h">'user2'</span></pre>

<p>
Calc %:
</p>

<p>
8000kbps * 50% / 8 = 500kB/s
</p>

<p>
Notes:
</p>

<p>
Will affect both upload/download.
A 12000/1000 line will be shaped at 6000/500...
</p>

<p>
edit: *X1* limit upload or both if *X1_down* not present...
*X1_down* limit down...
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Traffic Shaping&quot;,&quot;hid&quot;:&quot;traffic_shaping&quot;,&quot;codeblockOffset&quot;:14,&quot;secid&quot;:19,&quot;range&quot;:&quot;14246-15898&quot;} -->
<h2 class="sectionedit20" id="ts8mb8mb_lte">TS: 8Mb/8Mb LTE</h2>
<div class="level2">

<p>
<strong>Why shaping?</strong>
</p>

<p>
- Now i have 100GB quota, it will go wasted easly with youtube...
</p>

<p>
- Youtube android app cache all video, even if you only see a few seconds
</p>

<p>
- 1080p smart tv are :evil:
</p>

<p>
<strong>About Youtube</strong>
</p>

<p>
- Shape google 216.* may not work, because cache.google.com are in your <abbr title="Internet Service Provider">ISP</abbr>
</p>

<p>
- Shaping YouTube will shape all cacheable contents: Play Store...
</p>

<p>
- YouTube use port 443 almost
</p>

<p>
- Almost all web traffic are port 443. Http priority is useless today
</p>
<pre class="code bash">config interface <span class="st_h">'wan'</span>
	option classgroup <span class="st_h">'nikito'</span>
	option upload   <span class="st_h">'8000'</span>
	option download <span class="st_h">'8000'</span>
	option overhead <span class="st_h">'0'</span>
	option enabled  <span class="st_h">'1'</span>
&nbsp;
config classify
	option target <span class="st_h">'yt'</span>
	option proto <span class="st_h">'tcp'</span>
	option dstports <span class="st_h">'80,443'</span>
	option srchost <span class="st_h">'10.2.1.90'</span>
	option comment <span class="st_h">'tv youtube'</span>
&nbsp;
config classgroup <span class="st_h">'nikito'</span>
	option classes <span class="st_h">'n yt'</span>
	option default <span class="st_h">'n'</span>
&nbsp;
config class <span class="st_h">'n'</span>
	option packetsize <span class="st_h">'1500'</span>
	option packetdelay <span class="st_h">'100'</span>
	option avgrate <span class="st_h">'10'</span>
	option priority <span class="st_h">'5'</span>
&nbsp;
config class <span class="st_h">'n_down'</span>
	option avgrate <span class="st_h">'20'</span>
&nbsp;
config class <span class="st_h">'yt'</span>
	option avgrate   <span class="st_h">'10'</span>
&nbsp;
config class <span class="st_h">'yt_down'</span>
	option avgrate   <span class="st_h">'10'</span>
	option limitrate  <span class="st_h">'10'</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;TS: 8Mb\/8Mb LTE&quot;,&quot;hid&quot;:&quot;ts8mb8mb_lte&quot;,&quot;codeblockOffset&quot;:20,&quot;secid&quot;:20,&quot;range&quot;:&quot;15899-&quot;} -->