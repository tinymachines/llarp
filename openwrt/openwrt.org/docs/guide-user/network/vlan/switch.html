
<h1 class="sectionedit1" id="switch_documentation">Switch documentation</h1>
<div class="level1">

<p>
<img src="/lib/images/smileys/fixme.svg" class="icon smiley" alt="FIXME" />: This page is very outdated and incomplete, from the era of kernel 2.6 or 3 and early UCI-driven configuration.
If your device has multiple interfaces, the default configuration of VLANs will likely be very different than that described here.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_important plugin_wrap">
<p>
This article may contain network configuration that depends on migration to DSA in OpenWrt 21.02
</p>
<ul>
<li class="level1"><div class="li"> Check if your device uses DSA or swconfig as not all devices have been migrated</div>
</li>
<li class="level1"><div class="li"> ifname@interface has been moved to device sections</div>
</li>
<li class="level1"><div class="li"> <a href="/docs/guide-user/network/dsa/start" class="wikilink1" title="docs:guide-user:network:dsa:start" data-wiki-id="docs:guide-user:network:dsa:start">DSA Networking</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://forum.openwrt.org/t/mini-tutorial-for-dsa-network-config/96998" class="urlextern" title="https://forum.openwrt.org/t/mini-tutorial-for-dsa-network-config/96998" rel="ugc nofollow">Mini tutorial for DSA network config</a> on the forum</div>
</li>
<li class="level1"><div class="li"> <a href="https://openwrt.org/releases/21.02/notes-21.02.0#new_network_configuration_syntax_and_boardjson_change" class="urlextern" title="https://openwrt.org/releases/21.02/notes-21.02.0#new_network_configuration_syntax_and_boardjson_change" rel="ugc nofollow">DSA in the 21.02 release notes</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

<p>
See also:
</p>
<ul>
<li class="level1"><div class="li"> <a href="/docs/guide-user/network/network_configuration" class="wikilink1" title="docs:guide-user:network:network_configuration" data-wiki-id="docs:guide-user:network:network_configuration">network_configuration</a> </div>
</li>
<li class="level1"><div class="li"> <a href="/docs/guide-user/network/vlan/switch_configuration" class="wikilink1" title="docs:guide-user:network:vlan:switch_configuration" data-wiki-id="docs:guide-user:network:vlan:switch_configuration">switch_configuration</a></div>
</li>
</ul>

<p>
<span style='color:red; '>Make sure you can safemode or <abbr title="Time To Live">TTL</abbr> before changing network/switch settings</span>
</p>

<p>
<img src="/lib/images/smileys/fixme.svg" class="icon smiley" alt="FIXME" />: This page assumes you know what this is and why you want it.  (see <a href="/docs/guide-user/network/vlan/switch_configuration" class="wikilink1" title="docs:guide-user:network:vlan:switch_configuration" data-wiki-id="docs:guide-user:network:vlan:switch_configuration">switch_configuration</a>).
</p>

<p>
If your device has more than 1 <abbr title="Local Area Network">LAN</abbr> port, it may contain a special connection between the different ports called <strong>switch</strong>.
Most likely the internals may look like in the following picture:
</p>

<p>
<a href="/_detail/oldwiki/openwrtdocs/asus-internals-default.png?id=docs%3Aguide-user%3Anetwork%3Avlan%3Aswitch" class="media" title="oldwiki:openwrtdocs:asus-internals-default.png"><img src="/_media/oldwiki/openwrtdocs/asus-internals-default.png?w=600&amp;tok=b063e9" class="media" loading="lazy" alt="" width="600" /></a>
</p>

<p>
If you want to change how these ports are connected to each other you need to configure the <strong>switch</strong> of your device (see also <a href="/docs/guide-developer/networking/network.interfaces" class="wikilink1" title="docs:guide-developer:networking:network.interfaces" data-wiki-id="docs:guide-developer:networking:network.interfaces">network.interfaces</a>)
</p>

<p>
Different routers have different switch layouts, so look at the Wiki for your specific device.
The TP-Link Archer C7 has eth0 = <abbr title="Wide Area Network">WAN</abbr>, and eth1 = <abbr title="Local Area Network">LAN</abbr> (the 4 switch ports).
Port 0 of the switch = eth1 (labelled CPU in Luci), Port 6 = eth0. Port 1 is labelled <abbr title="Wide Area Network">WAN</abbr> in Luci.
Look at the wiki for your router. Every router is different. The popular TP-Link WDR4300 only has eth0.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Switch documentation&quot;,&quot;hid&quot;:&quot;switch_documentation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-1533&quot;} -->
<h2 class="sectionedit6" id="uci_config_swconfig_style">UCI config, swconfig style</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;UCI config, swconfig style&quot;,&quot;hid&quot;:&quot;uci_config_swconfig_style&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;1534-1572&quot;} -->
<h3 class="sectionedit7" id="known_problems">Known problems</h3>
<div class="level3">
<ul>
<li class="level1 node"><div class="li"> if a switch interface (for the cpu point of view) is controlling several &#039;physical interfaces&#039;, every time than one physical interface is connected, then all the switch interface result connected (that means all the ports <code>ethN.Y</code> are UP) and therefore every rule (routing for example) is applied. This could cause serious problem, for example if one relies on the automatic mechanism of routing metric when one route is not available anymore.</div>
<ul>
<li class="level2"><div class="li"> One way to detect this is: <code>swconfig dev &lt;switch_interface_name&gt; show | grep link</code> or see <a href="/docs/techref/swconfig" class="wikilink1" title="docs:techref:swconfig" data-wiki-id="docs:techref:swconfig">swconfig</a></div>
</li>
</ul>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Known problems&quot;,&quot;hid&quot;:&quot;known_problems&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;1573-2172&quot;} -->
<h3 class="sectionedit8" id="assumptions">Assumptions</h3>
<div class="level3">

<p>
<img src="/lib/images/smileys/fixme.svg" class="icon smiley" alt="FIXME" /> Some of the assumptions, does not see to add up with the provided diagram. Someone familiar with the matter, should either fix them or add a better explanation.
</p>
<ul>
<li class="level1"><div class="li"> device is running kernel 2.6 or 3</div>
</li>
<li class="level1"><div class="li"> device uses an <code>swconfig</code> type switch configuration</div>
</li>
<li class="level1"><div class="li"> ---------------------------------------------------</div>
</li>
<li class="level1"><div class="li"> The switch is on <code>eth1</code>.  <img src="/lib/images/smileys/fixme.svg" class="icon smiley" alt="FIXME" /> (Many are on <code>eth0</code>)  [Howto find out: → /proc/switch directory appears to contain the right eth number for the switch. please confirm], and also on chips like <code>rtl8366s</code></div>
</li>
<li class="level1"><div class="li"> Five-port switch with 0-3 connected externally, 4 not connected, and 5 connected to the CPU&#039;s eth1 interface (which adds up to six ports except that 4 is not counted)</div>
</li>
<li class="level1"><div class="li"> <code>vlan0</code> is to be all external ports but the last one</div>
</li>
<li class="level1"><div class="li"> <code>vlan1</code> is only the last external port [Howto find out which Port corresponds:]</div>
</li>
<li class="level1"><div class="li"> <code>vlan0</code> is the default vlan, meaning if a packet is untagged, it will be treated a vlan0 packet</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Assumptions&quot;,&quot;hid&quot;:&quot;assumptions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;2173-3146&quot;} -->
<h3 class="sectionedit9" id="the_configuration">The configuration</h3>
<div class="level3">

</div>

<h4 id="the_switch">The Switch</h4>
<div class="level4">
<pre class="code bash"><span class="co0"># /etc/config/network</span>
&nbsp;
config <span class="st_h">'switch'</span> <span class="st_h">'eth1'</span>
   option <span class="st_h">'enable'</span>      <span class="st_h">'1'</span>
   option <span class="st_h">'enable_vlan'</span> <span class="st_h">'1'</span>
   option <span class="st_h">'reset'</span>       <span class="st_h">'1'</span></pre>

</div>

<h4 id="vlanswitch_config">VLAN: switch config</h4>
<div class="level4">

</div>

<h5 id="notes">Notes</h5>
<div class="level5">

<p>
The number of the <abbr title="Virtual Local Area Network">VLAN</abbr> is specified on the <code>option vlan</code> line. The VID (<abbr title="Virtual Local Area Network">VLAN</abbr> ID) associated with a <abbr title="Virtual Local Area Network">VLAN</abbr> is by default the same as the number of the <abbr title="Virtual Local Area Network">VLAN</abbr>. This is overridden by using an <code>option vid</code> line so, for example, that <abbr title="Virtual Local Area Network">VLAN</abbr> 1 could use VID 100. For some hardware, the value of the vlan option may be limited to 127; exceeding this value may result in the <abbr title="Virtual Local Area Network">VLAN</abbr> not being configured at all.
</p>

<p>
In the <code>option ports</code> line, a number indicates that the specified vlan includes the port with that number.  If the number is followed by a “t” then packets <strong>transmitted</strong> out that port on this <abbr title="Virtual Local Area Network">VLAN</abbr> are tagged, and that packets <strong>received</strong> on that port may be received with this <abbr title="Virtual Local Area Network">VLAN</abbr> tag.  5 is generally the CPU or &#039;internal&#039; port and is most often used as tagged. Other suffixes are ignored on devices using <code>swconfig</code> but Broadcom kmod-switch style interfaces (<code>/proc/switch/</code>) use “*” and “u” to indicate PVID and untagged ports respectively (as they have the CPU port implicitly tagged one needs to use “u” to untag it).
</p>

<p>
So, &#039;0 1 2 3 5t&#039; would mean that packets on this <abbr title="Virtual Local Area Network">VLAN</abbr> are transmitted untagged when leaving ports 0, 1, 2 and 3, but tagged when leaving port 5 (generally the CPU internal port as described above).
</p>

<p>
Tagged packets received on a port will be directed to the <abbr title="Virtual Local Area Network">VLAN</abbr> indicated by the VID contained in the packet. Untagged packets received on a port will be directed to the default port <abbr title="Virtual Local Area Network">VLAN</abbr> (usually called the PVID). A separate <code>config switch_port</code> section is required to set the default port <abbr title="Virtual Local Area Network">VLAN</abbr>.
</p>

<p>
The relevant standards document is 801.2q which says that VID values 0 and 4095 may not be used for tagging packets as they denote reserved values - VID 0 is the default &#039;native&#039; vlan - leaving 4094 valid values in between, although VID 1 is often reserved for network management (see Dell 2708 for example). This means vlan0 can be used as a <abbr title="Virtual Local Area Network">VLAN</abbr> within or between devices, but you cannot tag packets with it.
</p>

</div>

<h5 id="the_config_sections">The config sections</h5>
<div class="level5">
<pre class="code bash"><span class="co0"># /etc/config/network</span>
&nbsp;
config <span class="st_h">'switch_vlan'</span>
   option <span class="st_h">'vlan'</span>       <span class="st_h">'0'</span>
   option <span class="st_h">'device'</span>     <span class="st_h">'eth1'</span>
   option <span class="st_h">'ports'</span>      <span class="st_h">'0 1 2 5t'</span>
&nbsp;
config <span class="st_h">'switch_vlan'</span>
   option <span class="st_h">'vlan'</span>       <span class="st_h">'1'</span>
   option <span class="st_h">'device'</span>     <span class="st_h">'eth1'</span>
   option <span class="st_h">'ports'</span>      <span class="st_h">'3 5t'</span>
&nbsp;
config <span class="st_h">'switch_port'</span>
    option <span class="st_h">'port'</span>      <span class="st_h">'3'</span>
    option <span class="st_h">'pvid'</span>      <span class="st_h">'1'</span></pre>

</div>

<h4 id="vlaninterfacenetwork_config">VLAN: interface/network config</h4>
<div class="level4">

<p>
<abbr title="Virtual Local Area Network">VLAN</abbr> interface sections look just like regular interface sections, except that instead of <code>eth1</code> (or <code>eth0</code>, or whatever), you have <code>eth1.0</code>, <code>eth1.1</code>, etc. where a digit after a <code>.</code> is a <abbr title="Virtual Local Area Network">VLAN</abbr> number.  (that is, for kernel 2.6; 2.4 kernels do something different).
</p>

<p>
The following example is for a two-interface router, with eth0 being the <abbr title="Wide Area Network">WAN</abbr> and eth1 being the five-port switch configured as above.  It goes in <code>/etc/config/network</code>
</p>

<p>
e.g.
</p>
<pre class="code bash"><span class="co0"># /etc/config/network</span>
&nbsp;
config <span class="st_h">'interface'</span> <span class="st_h">'lan'</span>
    option <span class="st_h">'ifname'</span> <span class="st_h">'eth1.0'</span>
    option <span class="st_h">'proto'</span> <span class="st_h">'static'</span>
    option <span class="st_h">'ipaddr'</span> <span class="st_h">'192.168.1.1'</span>
    option <span class="st_h">'netmask'</span> <span class="st_h">'255.255.255.0'</span>
    option <span class="st_h">'defaultroute'</span> <span class="st_h">'0'</span>
    option <span class="st_h">'peerdns'</span> <span class="st_h">'0'</span>
    option <span class="st_h">'nat'</span>    <span class="st_h">'1'</span>
&nbsp;
config <span class="st_h">'interface'</span> <span class="st_h">'extranet'</span>
    option <span class="st_h">'ifname'</span>  <span class="st_h">'eth1.1'</span>
    option <span class="st_h">'proto'</span>   <span class="st_h">'dhcp'</span>
&nbsp;
config <span class="st_h">'interface'</span>  <span class="st_h">'wan'</span>
   option <span class="st_h">'ifname'</span>  <span class="st_h">'eth0.2'</span>
   option <span class="st_h">'proto'</span>   <span class="st_h">'pppoe'</span>
   option <span class="st_h">'username'</span> <span class="st_h">'szabozsolt-em'</span>
   option <span class="st_h">'password'</span> <span class="st_h">'M3IuWBt4'</span></pre>

<p>
Of course, if you only had a five port switch on eth0 (and no other interfaces), you might make the <code>wan</code> interface <code>eth0.1</code> and the lan <code>eth0.0</code> with appropriately matching <code>switch</code>, <code>switch_vlan</code> and <code>switch_port</code> sections.
</p>

<p>
See also <a href="https://en.wikipedia.org/wiki/backplane" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/backplane">backplane</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;The configuration&quot;,&quot;hid&quot;:&quot;the_configuration&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;3147-6971&quot;} -->
<h3 class="sectionedit10" id="examples">Examples</h3>
<div class="level3">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Examples&quot;,&quot;hid&quot;:&quot;examples&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:10,&quot;range&quot;:&quot;6972-6990&quot;} -->
<h3 class="sectionedit11" id="example_on_the_asus_wl500gp_v2_openwrt_1003_every_physical_port">Example on the asus wl500gp v2 , openwrt 10.03, every physical port</h3>
<div class="level3">
<pre class="code bash"><span class="co0"># /etc/config/network</span>
&nbsp;
config <span class="st_h">'switch'</span> <span class="st_h">'eth0'</span>
	option <span class="st_h">'enable'</span> <span class="st_h">'1'</span>
&nbsp;
config <span class="st_h">'switch_vlan'</span> <span class="st_h">'eth0_0'</span>
	option <span class="st_h">'device'</span> <span class="st_h">'eth0'</span>
	option <span class="st_h">'vlan'</span> <span class="st_h">'0'</span>
	option <span class="st_h">'ports'</span> <span class="st_h">'4 5'</span> <span class="co0">#wan</span>
&nbsp;
config <span class="st_h">'switch_vlan'</span> <span class="st_h">'eth0_1'</span>
	option <span class="st_h">'device'</span> <span class="st_h">'eth0'</span>
	option <span class="st_h">'vlan'</span> <span class="st_h">'1'</span>
	option <span class="st_h">'ports'</span> <span class="st_h">'3 5'</span> <span class="co0">#lan 1</span>
&nbsp;
config <span class="st_h">'switch_vlan'</span> <span class="st_h">'eth0_2'</span>
	option <span class="st_h">'device'</span> <span class="st_h">'eth0'</span>
	option <span class="st_h">'vlan'</span> <span class="st_h">'2'</span>
	option <span class="st_h">'ports'</span> <span class="st_h">'2 5'</span> <span class="co0">#lan2</span>
&nbsp;
config <span class="st_h">'switch_vlan'</span> <span class="st_h">'eth0_3'</span>
	option <span class="st_h">'device'</span> <span class="st_h">'eth0'</span>
	option <span class="st_h">'vlan'</span> <span class="st_h">'3'</span>
	option <span class="st_h">'ports'</span> <span class="st_h">'1 5'</span> <span class="co0">#lan3</span>
&nbsp;
config <span class="st_h">'switch_vlan'</span> <span class="st_h">'eth0_4'</span>
	option <span class="st_h">'device'</span> <span class="st_h">'eth0'</span>
	option <span class="st_h">'vlan'</span> <span class="st_h">'4'</span>
	option <span class="st_h">'ports'</span> <span class="st_h">'0 5'</span> <span class="co0">#lan4</span>
&nbsp;
<span class="co0">#note that to use a particular port in an interface the ifname</span>
<span class="co0">#should be 'devicename.vlan' . So for example ifname 'eth0.3'</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Example on the asus wl500gp v2 , openwrt 10.03, every physical port&quot;,&quot;hid&quot;:&quot;example_on_the_asus_wl500gp_v2_openwrt_1003_every_physical_port&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:11,&quot;range&quot;:&quot;6991-7792&quot;} -->
<h3 class="sectionedit12" id="example_vmware_linux_guest_openwrt_x86_generic_1209_combined_2virtualized_intel_e1000">Example vmware linux guest, openwrt x86 generic 12.09 combined, 2virtualized intel e1000</h3>
<div class="level3">

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> More research on vlan on x86 devices has to be done to collect more information on the wiki.
</p>

<p>
The majority of x86 devices do not have any programmable switch,
but it does not seem to be a problem. The syntax used
on devices with programmable switches seems completely not necessary.
</p>

<p>
For example we want to create two &#039;virtual interfaces&#039; associated to the same
physical interface, <code>eth1</code>. To do this, we do the following in <code>/etc/config/network</code>
</p>
<pre class="code bash"><span class="co0"># /etc/config/network</span>
...
&nbsp;
config interface lan1
        option ifname eth1.100
        ...
&nbsp;
config interface lan2
        option ifname eth1.101
        ...</pre>

<p>
According to what the contributors of this section have read online, 
so far seems that the packet will be tagged by default, 
because they are associated to one physical ports that 
at most will have one PVID (port vlan id) but more than one virtual interfaces.
Therefore, having multiple virtual interfaces, the packets must be tagged else it
won&#039;t make sense, they won&#039;t be able to reach the interfaces or to go out.
</p>

<p>
The tests seems to confirm that because (using a vmware switch and portgroups) to let two
openwrt x86 vmware guests reach each other the portgroups had to be configured with the trunk
vlan id (that is: vlan id 4095,
According to white papers: <em>VMware Virtual Networking Concepts</em> and <em>VMware ESX Server 3 802.1Q <abbr title="Virtual Local Area Network">VLAN</abbr> Solutions</em>).
</p>

<p>
Side note: if different virtual interfaces related to different vlan are in the same logical network, there will be conflict in terms of metrics, in that case bridging the interfaces could be a solution (has to be tested).
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Example vmware linux guest, openwrt x86 generic 12.09 combined, 2virtualized intel e1000&quot;,&quot;hid&quot;:&quot;example_vmware_linux_guest_openwrt_x86_generic_1209_combined_2virtualized_intel_e1000&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:12,&quot;range&quot;:&quot;7793-&quot;} -->