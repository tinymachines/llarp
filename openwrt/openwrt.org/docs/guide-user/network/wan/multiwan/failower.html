
<h1 class="sectionedit1" id="multiwanconnection_to_spare_internet_provider">multiwan: Connection to spare internet provider</h1>
<div class="level1">
<div class="table sectionedit2"><table class="inline">
	<tr class="row0">
		<td class="col0"> <img src="/lib/images/smileys/fixme.svg" class="icon smiley" alt="FIXME" />:</td><td class="col1"> It is only skeleton of the article. It is need to full translate from <a href="/ru/doc/howto/multiwan.failower" class="wikilink1" title="ru:doc:howto:multiwan.failower" data-wiki-id="ru:doc:howto:multiwan.failower">russian</a>. </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;65-190&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;multiwan: Connection to spare internet provider&quot;,&quot;hid&quot;:&quot;multiwanconnection_to_spare_internet_provider&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;2-191&quot;} -->
<h2 class="sectionedit3" id="conditions_and_definitions">Conditions and definitions</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <strong>Main uplink</strong> -- connection to main internet provider.</div>
</li>
<li class="level1"><div class="li"> <strong>Spare link</strong> -- connection to router of the friendly organisation.</div>
</li>
<li class="level1"><div class="li"> <strong>Main condition</strong> -- subnets of the local network, Main uplink and Spare link do not overlap each other.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Conditions and definitions&quot;,&quot;hid&quot;:&quot;conditions_and_definitions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;192-476&quot;} -->
<h2 class="sectionedit4" id="configuring_a_router">Configuring a router</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuring a router&quot;,&quot;hid&quot;:&quot;configuring_a_router&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;477-510&quot;} -->
<h3 class="sectionedit5" id="install_openwrt">Install OpenWRT</h3>
<div class="level3">

<p>
Download OpenWRT for <a href="/toh/start" class="wikilink1" title="toh:start" data-wiki-id="toh:start">your device</a>. Follow instructions in <a href="/docs/guide-user/installation/generic.flashing" class="wikilink1" title="docs:guide-user:installation:generic.flashing" data-wiki-id="docs:guide-user:installation:generic.flashing">generic.flashing</a> and <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">walkthrough_login</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Install OpenWRT&quot;,&quot;hid&quot;:&quot;install_openwrt&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;511-711&quot;} -->
<h3 class="sectionedit6" id="packages_installation">Packages installation</h3>
<div class="level3">

<p>
If you are installing a <a href="http://downloads.openwrt.org/snapshots/trunk/" class="urlextern" title="http://downloads.openwrt.org/snapshots/trunk/" rel="ugc nofollow">trunk version</a>, it&#039;s recommended to install also the web user interface <a href="/docs/guide-user/luci/luci.essentials" class="wikilink1" title="docs:guide-user:luci:luci.essentials" data-wiki-id="docs:guide-user:luci:luci.essentials">LuCI</a> for ease of operations.
<a href="http://downloads.openwrt.org/attitude_adjustment/12.09/" class="urlextern" title="http://downloads.openwrt.org/attitude_adjustment/12.09/" rel="ugc nofollow">Current version</a> should have the web user interface already installed and enabled by default.
</p>

<p>
Next to be installed is the <strong>luci-app-miltiwan</strong> package that in turn will pull also the dependencies like the required <a href="/docs/guide-user/network/wan/multiwan/multiwan_package" class="wikilink1" title="docs:guide-user:network:wan:multiwan:multiwan_package" data-wiki-id="docs:guide-user:network:wan:multiwan:multiwan_package">multiwan_package</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Packages installation&quot;,&quot;hid&quot;:&quot;packages_installation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;712-1294&quot;} -->
<h3 class="sectionedit7" id="set_up">Set up</h3>
<div class="level3">

</div>

<h4 id="setup_connection_to_main_uplink">Setup connection to Main uplink</h4>
<div class="level4">

<p>
LuCI: fill all required fields on <em>Network</em> → <em>Interfaces</em> → <em><abbr title="Wide Area Network">WAN</abbr></em> and click <code>Save &amp; Apply</code>
UCI: edit a file <code>/etc/config/network</code>:
</p>
<pre class="code">config interface &#039;wan&#039;
        option ifname &#039;eth1&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;198.51.100.195&#039;
        option netmask &#039;255.255.255.128&#039;
        option gateway &#039;198.51.100.129&#039;
        option dns &#039;192.0.2.160 8.8.8.8 192.0.2.190&#039;</pre>

<p>
And apply changes:
</p>
<pre class="code bash"><span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>network reload</pre>

<p>
It is recommends specify some public <abbr title="Domain Name System">DNS</abbr> in addition to <abbr title="Domain Name System">DNS</abbr> of provider “Main aplink”. It is need to avoid failures of resolving when Main uplink will down.
</p>

</div>

<h4 id="create_a_vlan">Create a VLAN</h4>
<div class="level4">

<p>
First, it is need exlude one port from existing “<abbr title="Local Area Network">LAN</abbr>” <abbr title="Virtual Local Area Network">VLAN</abbr>. This <abbr title="Virtual Local Area Network">VLAN</abbr> has number “1”.
Second, need create new <abbr title="Virtual Local Area Network">VLAN</abbr> (with number “2” or another less or equal 4096) and include into new <abbr title="Virtual Local Area Network">VLAN</abbr> freed port with untagged mode and Port 5 (“CPU port”) in the tagged mode.
</p>

<p>
In UCI: change file <code>/etc/config/network</code>:
replace 
</p>
<pre class="code">config switch_vlan
        option device &#039;rtl8366s&#039;
        option vlan &#039;1&#039;
        option ports &#039;0 1 2 3 5t&#039;</pre>

<p>
with
</p>
<pre class="code">config switch_vlan
        option device &#039;rtl8366s&#039;
        option vlan &#039;1&#039;
        option ports &#039;0 1 2 5t&#039;
config switch_vlan
        option device &#039;rtl8366s&#039;
        option vlan &#039;2&#039;
        option ports &#039;3 5t&#039;</pre>

<p>
After <code>/etc/config/network</code> is changes it is need to run:
</p>
<pre class="code bash"><span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>network restart</pre>

<p>
for apply changes.
</p>

</div>

<h4 id="setup_multiwan">Setup multiwan</h4>
<div class="level4">

</div>

<h5 id="interfaces_assignation">Interfaces assignation</h5>
<div class="level5">

<p>
It is need assign virtual interface to phisical.
LuCI: <em>Network</em> → <em>Interfaces</em>:
</p>
<ul>
<li class="level1"><div class="li"> Click <em>Add New Interface</em></div>
</li>
<li class="level1"><div class="li"> Write name <em><abbr title="Wireless Wide Area Network">WWAN</abbr></em></div>
</li>
<li class="level1"><div class="li"> Select phisical interface “<em><abbr title="Virtual Local Area Network">VLAN</abbr> interface: eth0.2</em>”</div>
</li>
<li class="level1"><div class="li"> In a line <em>Protocol of the new interface</em> select <em><abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> Client</em> (or required by Spare link)</div>
</li>
<li class="level1"><div class="li"> Click <em>Submit</em></div>
</li>
</ul>

<p>
UCI: Add following lines into <code>/etc/config/network</code>:
</p>
<pre class="code">config interface &#039;wwan&#039;
        option ifname &#039;eth0.2&#039;
        option proto &#039;dhcp&#039;</pre>

</div>

<h5 id="setup_firewall">Setup firewall</h5>
<div class="level5">

<p>
Set up firewall parameters for new interface:
</p>
<ul>
<li class="level1"><div class="li"> LuCI:  <em>Network</em> → <em>Interfaces</em> → <em><abbr title="Wireless Wide Area Network">WWAN</abbr></em> → <em>Firewall settings</em> select a zone “<code>wan</code>”.</div>
</li>
</ul>

</div>

<h5 id="set_up_parameters_of_multiwan">Set up parameters of multiwan</h5>
<div class="level5">

<p>
<strong>In LuCI</strong>: <em>Network</em> → <em>Multi-<abbr title="Wide Area Network">WAN</abbr></em>
</p>
<ul>
<li class="level1"><div class="li"> Remove <code>WAN2</code></div>
</li>
<li class="level1"><div class="li"> Create <code><abbr title="Wireless Wide Area Network">WWAN</abbr></code></div>
</li>
<li class="level1"><div class="li"> Set <em>Failover Traffic Destination</em> to another interface: <code><abbr title="Wide Area Network">WAN</abbr></code> in <code>wwan</code> interface section and <code><abbr title="Wireless Wide Area Network">WWAN</abbr></code> in <code>wan</code> section</div>
</li>
<li class="level1"><div class="li"> Best solution for <abbr title="Domain Name System">DNS</abbr>: insert <abbr title="Domain Name System">DNS</abbr> server of provider of link and one of public save <abbr title="Domain Name System">DNS</abbr> server (for example, Google&#039;s public <abbr title="Domain Name System">DNS</abbr> servers)</div>
</li>
<li class="level1"><div class="li"> A parameter <em>Health Monitor <abbr title="Internet Control Message Protocol">ICMP</abbr> Host(s)</em> should be set with different save servers but not servers of provider of links (because link may be up but internet are down)</div>
</li>
</ul>

<p>
Next assign policy for multiwan:
</p>
<ul>
<li class="level1"><div class="li"> <em>Default Route</em>: <code>wan</code></div>
</li>
</ul>

<p>
(Main  uplink should use for all traffic if it up, and Spare link only in case when Main uplink are down.
</p>

<p>
Last remove unneeded rules from <em>Multi-<abbr title="Wide Area Network">WAN</abbr> Traffic Rules</em> and enable multiwan.
</p>

<p>
Don&#039;t forget click <em>Save &amp; Apply</em>. 
</p>

<p>
<strong>In UCI</strong> need change <code>/etc/config/multiwan</code>:
</p>
<pre class="code">config multiwan &#039;config&#039;               
        option enabled &#039;1&#039;
        option default_route &#039;wan&#039;
                                          
config interface &#039;wan&#039;                    
        option weight &#039;10&#039;                
        option health_interval &#039;10&#039;       
        option timeout &#039;3&#039;                
        option health_fail_retries &#039;3&#039;    
        option health_recovery_retries &#039;5&#039;
        option dns &#039;auto&#039;           
        option icmp_hosts &#039;8.8.8.8&#039;   
        option failover_to &#039;wwan&#039;         
                                          
config interface &#039;wwan&#039;                   
        option weight &#039;10&#039;                
        option health_interval &#039;10&#039;       
        option timeout &#039;3&#039;                
        option health_fail_retries &#039;3&#039;    
        option health_recovery_retries &#039;5&#039;
        option dns &#039;auto&#039;                 
        option icmp_hosts &#039;8.8.4.4&#039;
        option failover_to &#039;wan&#039;          </pre>

<p>
Next apply changes:
</p>
<pre class="code">/etc/init.d/multiwan restart</pre>

</div>

<h5 id="set_up_dnsmask">Set up dnsmask</h5>
<div class="level5">

<p>
<strong>LuCI</strong>: <em>Network</em> → <em><abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> and <abbr title="Domain Name System">DNS</abbr></em> → <em>General settings</em>. In section <em><abbr title="Domain Name System">DNS</abbr> forwardings</em> enumerate <abbr title="Domain Name System">DNS</abbr> servers of both links and, for better work, one or two public <abbr title="Domain Name System">DNS</abbr> servers.
</p>

<p>
<strong>UCI:</strong> enumerate <abbr title="Domain Name System">DNS</abbr> servers in lines <code>list server …</code> in section <code>config dnsmasq</code> of file <code>/etc/config/dhcp</code>, for example:
</p>
<pre class="code">config dnsmasq
	list server &#039;8.8.8.8&#039;
	list server &#039;8.8.4.4&#039;
	list server &#039;192.0.2.160&#039;
	list server &#039;192.0.2.190&#039;
…</pre>

<p>
And apply changes:
</p>
<pre class="code">/etc/init.d/dnsmasq reload</pre>

<p>
Just work!
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Set up&quot;,&quot;hid&quot;:&quot;set_up&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;1295-&quot;} -->