
<h1 class="sectionedit1" id="mwan_with_netifd">MWAN with netifd</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;MWAN with netifd&quot;,&quot;hid&quot;:&quot;mwan_with_netifd&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-113&quot;} -->
<h2 class="sectionedit6" id="introduction">Introduction</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> This instruction configures multi-<abbr title="Wide Area Network">WAN</abbr> with <a href="/docs/techref/netifd" class="wikilink1" title="docs:techref:netifd" data-wiki-id="docs:techref:netifd">netifd</a> on OpenWrt.</div>
</li>
<li class="level1"><div class="li"> Enable <a href="/docs/guide-user/firewall/fw3_configurations/fw3_nat#ipv6_nat" class="wikilink1" title="docs:guide-user:firewall:fw3_configurations:fw3_nat" data-wiki-id="docs:guide-user:firewall:fw3_configurations:fw3_nat">IPv6 NAT or NPT</a> and disable <a href="/docs/guide-user/network/ipv6/ipv6_extras#disabling_ipv6_source_filter" class="wikilink1" title="docs:guide-user:network:ipv6:ipv6_extras" data-wiki-id="docs:guide-user:network:ipv6:ipv6_extras">IPv6 source filter</a> if necessary.</div>
</li>
<li class="level1"><div class="li"> Follow <a href="/docs/guide-user/network/routing/pbr_netifd" class="wikilink1" title="docs:guide-user:network:routing:pbr_netifd" data-wiki-id="docs:guide-user:network:routing:pbr_netifd">PBR with netifd</a> to customize your routing configuration.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;114-555&quot;} -->
<h2 class="sectionedit7" id="features">Features</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Implement multi-<abbr title="Wide Area Network">WAN</abbr> based on <abbr title="Policy Based Routing">PBR</abbr> with netifd.</div>
</li>
<li class="level1"><div class="li"> Support dual-stack setups using <abbr title="Internet Protocol version 4">IPv4</abbr> and <abbr title="Internet Protocol version 6">IPv6</abbr>.</div>
</li>
<li class="level1"><div class="li"> Perform connectivity check with <abbr title="Internet Control Message Protocol">ICMP</abbr> and ICMPv6.</div>
</li>
<li class="level1"><div class="li"> Provide a simple failover method.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Features&quot;,&quot;hid&quot;:&quot;features&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;556-769&quot;} -->
<h2 class="sectionedit8" id="command-line_instructions">Command-line instructions</h2>
<div class="level2">

<p>
Assuming pre-configured upstream interfaces.
Set up <abbr title="Policy Based Routing">PBR</abbr> with netifd using <a href="/docs/guide-user/advanced/pbr_extras" class="wikilink1" title="docs:guide-user:advanced:pbr_extras" data-wiki-id="docs:guide-user:advanced:pbr_extras">PBR extras</a>.
Save the failover script.
Configure cron to run the failover script.
Specify the managed interfaces.
</p>
<pre class="code bash"><span class="co0"># Failover script</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>iface<span class="sy0">/</span><span class="nu0">80</span>-mwan
iface_proc<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">NET_IF</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw3">local</span> NET_RT
<span class="kw3">local</span> NET_OK
<span class="kw1">for</span> IPV <span class="kw1">in</span> <span class="nu0">4</span> <span class="nu0">6</span>
<span class="kw1">do</span> <span class="re2">NET_OK</span>=<span class="st0">&quot;<span class="es4">$(eval echo &quot;\${NET_OK${IPV}}&quot;)</span>&quot;</span>
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-z</span> <span class="st0">&quot;<span class="es3">${NET_OK}</span>&quot;</span> <span class="br0">&#93;</span> \
<span class="sy0">&amp;&amp;</span> iface_check <span class="st0">&quot;<span class="es3">${NET_IF}</span>&quot;</span>
<span class="kw1">then</span> <span class="kw3">eval</span> NET_OK<span class="st0">&quot;<span class="es3">${IPV}</span>&quot;</span>=<span class="st0">&quot;1&quot;</span>
<span class="re2">NET_RT</span>=<span class="st0">&quot;<span class="es4">$(uci -q get network.&quot;${NET_IF}&quot;.ip&quot;${IPV}&quot;table)</span>&quot;</span>
uci <span class="kw1">set</span> network.default<span class="st0">&quot;<span class="es3">${IPV%4}</span>&quot;</span>.lookup=<span class="st0">&quot;<span class="es3">${NET_RT}</span>&quot;</span>
service network reload
<span class="kw1">fi</span>
<span class="kw1">done</span>
<span class="br0">&#125;</span>
&nbsp;
iface_check<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw3">local</span> <span class="re2">PING_IF</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="kw3">local</span> <span class="re2">PING_CNT</span>=<span class="st0">&quot;2&quot;</span>
<span class="kw3">local</span> <span class="re2">PING_WAIT</span>=<span class="st0">&quot;3&quot;</span>
<span class="kw3">local</span> PING_SRC
<span class="kw3">local</span> PING_DST
<span class="kw3">eval</span> network_get_ipaddr<span class="st0">&quot;<span class="es3">${IPV%4}</span>&quot;</span> PING_SRC <span class="st0">&quot;<span class="es3">${PING_IF}</span>&quot;</span>
<span class="kw3">eval</span> network_get_gateway<span class="st0">&quot;<span class="es3">${IPV%4}</span>&quot;</span> PING_DST <span class="st0">&quot;<span class="es3">${PING_IF}</span>&quot;</span>
<span class="kw1">case</span> <span class="st0">&quot;<span class="es3">${PING_DST}</span>&quot;</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>0.0.0.0<span class="br0">&#41;</span> <span class="re2">PING_DST</span>=<span class="st0">&quot;<span class="es3">${NET_HOST%% *}</span>&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span>::<span class="br0">&#41;</span> <span class="re2">PING_DST</span>=<span class="st0">&quot;<span class="es3">${NET_HOST##* }</span>&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw2">ping</span> <span class="re5">-q</span> <span class="re5">-c</span> <span class="st0">&quot;<span class="es3">${PING_CNT}</span>&quot;</span> <span class="re5">-W</span> <span class="st0">&quot;<span class="es3">${PING_WAIT}</span>&quot;</span> \
<span class="re5">-I</span> <span class="st0">&quot;<span class="es3">${PING_SRC}</span>&quot;</span> <span class="st0">&quot;<span class="es3">${PING_DST}</span>&quot;</span> <span class="sy0">&amp;&gt;</span> <span class="sy0">/</span>dev<span class="sy0">/</span>null
<span class="br0">&#125;</span>
&nbsp;
<span class="re2">NET_IF</span>=<span class="st0">&quot;<span class="es4">$(uci -q get network.mwan.iface)</span>&quot;</span>
<span class="re2">NET_HOST</span>=<span class="st0">&quot;<span class="es4">$(uci -q get network.mwan.host)</span>&quot;</span>
. <span class="sy0">/</span>lib<span class="sy0">/</span>functions<span class="sy0">/</span>network.sh
network_flush_cache
<span class="kw1">for</span> NET_IF <span class="kw1">in</span> <span class="co1">${NET_IF}</span>
<span class="kw1">do</span> iface_proc <span class="st0">&quot;<span class="es3">${NET_IF}</span>&quot;</span>
<span class="kw1">done</span>
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>sysupgrade.conf
<span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>iface<span class="sy0">/</span><span class="nu0">80</span>-mwan
EOF
&nbsp;
<span class="co0"># Configure cron</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>crontabs<span class="sy0">/</span>root
<span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> . <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>iface<span class="sy0">/</span><span class="nu0">80</span>-mwan
EOF
uci <span class="kw1">set</span> system.<span class="sy0">@</span>system<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.cronloglevel=<span class="st0">&quot;9&quot;</span>
uci commit system
service cron restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Command-line instructions&quot;,&quot;hid&quot;:&quot;command-line_instructions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;770-2319&quot;} -->
<h2 class="sectionedit9" id="examples">Examples</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Configure interfaces</span>
<span class="re2">NET_IF</span>=<span class="st0">&quot;wana wana6 wanb wanb6 wanc wanc6&quot;</span>
<span class="re2">NET_HOST</span>=<span class="st0">&quot;8.8.8.8 2001:4860:4860::8888&quot;</span>
uci <span class="re5">-q</span> delete network.mwan
uci <span class="kw1">set</span> network.mwan=<span class="st0">&quot;mwan&quot;</span>
<span class="kw1">for</span> NET_IF <span class="kw1">in</span> <span class="co1">${NET_IF}</span>
<span class="kw1">do</span> uci add_list network.mwan.iface=<span class="st0">&quot;<span class="es3">${NET_IF}</span>&quot;</span>
<span class="kw1">done</span>
<span class="kw1">for</span> NET_HOST <span class="kw1">in</span> <span class="co1">${NET_HOST}</span>
<span class="kw1">do</span> uci add_list network.mwan.host=<span class="st0">&quot;<span class="es3">${NET_HOST}</span>&quot;</span>
<span class="kw1">done</span>
uci commit network
service network restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Examples&quot;,&quot;hid&quot;:&quot;examples&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:9,&quot;range&quot;:&quot;2320-2721&quot;} -->
<h2 class="sectionedit10" id="automated">Automated</h2>
<div class="level2">
<pre class="code bash"><span class="kw2">wget</span> <span class="re5">-U</span> <span class="st0">&quot;&quot;</span> <span class="re5">-O</span> mwan-netifd.sh <span class="st0">&quot;https://openwrt.org/_export/code/docs/guide-user/network/wan/multiwan/mwan_netifd?codeblock=0&quot;</span>
. .<span class="sy0">/</span>mwan-netifd.sh</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Automated&quot;,&quot;hid&quot;:&quot;automated&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:10,&quot;range&quot;:&quot;2722-&quot;} -->