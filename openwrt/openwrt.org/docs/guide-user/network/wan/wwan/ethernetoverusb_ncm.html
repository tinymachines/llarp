
<h1 class="sectionedit1" id="use_ncm_usb_dongle_for_wan_connection">Use NCM USB Dongle for WAN connection</h1>
<div class="level1">

<p>
<a href="http://www.mcci.com/mcci-v5/hostside/ncm_drivers.html" class="urlextern" title="http://www.mcci.com/mcci-v5/hostside/ncm_drivers.html" rel="ugc nofollow">NCM</a> (Network Control Model) is <a href="https://en.wikipedia.org/wiki/Ethernet_over_USB" class="urlextern" title="https://en.wikipedia.org/wiki/Ethernet_over_USB" rel="ugc nofollow">Ethernet over USB</a> protocol used by some USB modems.
</p>

<p>
The same applies to external modems connected to USB ports (“dongles”) and internal models installed into M.2(NGFF) or mPCIe slots.
</p>

<p>
For more information about other protocols commonly used:
</p>
<ul>
<li class="level1"><div class="li"> <strong>PPP</strong>, see <a href="/docs/guide-user/network/wan/wwan/3gdongle" class="wikilink1" title="docs:guide-user:network:wan:wwan:3gdongle" data-wiki-id="docs:guide-user:network:wan:wwan:3gdongle">How to use 3g/UMTS USB Dongle for WAN connection</a></div>
</li>
<li class="level1"><div class="li"> <strong>QMI</strong> and <strong>MBIM</strong>, see <a href="/docs/guide-user/network/wan/wwan/ltedongle" class="wikilink1" title="docs:guide-user:network:wan:wwan:ltedongle" data-wiki-id="docs:guide-user:network:wan:wwan:ltedongle">How to use LTE modem in QMI mode for WAN connection</a></div>
</li>
<li class="level1"><div class="li"> <strong>ECM</strong>, see <a href="/docs/guide-user/network/wan/wwan/ethernetoverusb_cdc" class="wikilink1" title="docs:guide-user:network:wan:wwan:ethernetoverusb_cdc" data-wiki-id="docs:guide-user:network:wan:wwan:ethernetoverusb_cdc">Use cdc_ether driver based dongles for WAN connection</a></div>
</li>
<li class="level1"><div class="li"> <strong>RNDIS</strong>, see <a href="/docs/guide-user/network/wan/wwan/ethernetoverusb_rndis" class="wikilink1" title="docs:guide-user:network:wan:wwan:ethernetoverusb_rndis" data-wiki-id="docs:guide-user:network:wan:wwan:ethernetoverusb_rndis">How to use LTE modem in RNDIS mode for WAN connection</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Use NCM USB Dongle for WAN connection&quot;,&quot;hid&quot;:&quot;use_ncm_usb_dongle_for_wan_connection&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-940&quot;} -->
<h2 class="sectionedit2" id="modem_preparation">Modem Preparation</h2>
<div class="level2">

<p>
You may need to switch your modem to provide a native <strong>NCM</strong> interface instead of <em>serial</em> <strong>Modem</strong> interface.
</p>

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> Please read about <a href="/docs/guide-user/network/wan/wwan/at_commands" class="wikilink1" title="docs:guide-user:network:wan:wwan:at_commands" data-wiki-id="docs:guide-user:network:wan:wwan:at_commands">AT commands</a> for your modem.
</p>

<p>
Once you&#039;ve done - you can disconnect modem from the PC and connect it to the router.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Modem Preparation&quot;,&quot;hid&quot;:&quot;modem_preparation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;941-1273&quot;} -->
<h2 class="sectionedit3" id="router_preparation">Router Preparation</h2>
<div class="level2">

<p>
1. Install OpenWrt
</p>

<p>
2. Complete steps <a href="/docs/guide-quick-start/checks_and_troubleshooting" class="wikilink1" title="docs:guide-quick-start:checks_and_troubleshooting" data-wiki-id="docs:guide-quick-start:checks_and_troubleshooting">OpenWrt Configuration</a>
</p>

<p>
Router should be turned on and connected to the Internet to get the needed packages. Please refer to: <a href="/docs/guide-user/network/wan/internet.connection" class="wikilink1" title="docs:guide-user:network:wan:internet.connection" data-wiki-id="docs:guide-user:network:wan:internet.connection">Internet Connection</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Router Preparation&quot;,&quot;hid&quot;:&quot;router_preparation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;1274-1595&quot;} -->
<h3 class="sectionedit4" id="required_packages">Required Packages</h3>
<div class="level3">

<p>
To make use of NCM protocol, packages <code>kmod-usb-net-huawei-cdc-ncm</code> and <code>comgt-ncm</code> are needed (for Huawei modems). Other modems may require different <code>kmod-*</code> packages.
</p>

<p>
To access the PC UI Interface (AT Command port) package <code>kmod-usb-serial-option</code> is typically needed. Some modems may need <code>kmod-usb-acm</code> driver instead.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Required Packages&quot;,&quot;hid&quot;:&quot;required_packages&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;1596-1959&quot;} -->
<h3 class="sectionedit5" id="optional_packages">Optional Packages</h3>
<div class="level3">

<p>
1. Install <code>usb-modeswitch</code> <em class="u">only if</em> that is needed for switching the modem into a “working” state. More about: <a href="/docs/guide-user/network/wan/wwan/usb-modeswitching" class="wikilink1" title="docs:guide-user:network:wan:wwan:usb-modeswitching" data-wiki-id="docs:guide-user:network:wan:wwan:usb-modeswitching">USB mode switch</a>
</p>

<p>
2. A terminal program like <code>picocom</code> will be needed to manually send AT commands.
</p>

<p>
3. Add support for FlashCard of your dongle - refer to: <a href="/docs/guide-user/storage/usb-drives" class="wikilink1" title="docs:guide-user:storage:usb-drives" data-wiki-id="docs:guide-user:storage:usb-drives">USB Storage</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Optional Packages&quot;,&quot;hid&quot;:&quot;optional_packages&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;1960-2373&quot;} -->
<h2 class="sectionedit6" id="installation">Installation</h2>
<div class="level2">

<p>
1. Install all the needed packages either in Luci → System → Software or via command line:
</p>
<ul>
<li class="level1"><div class="li"> For Huawei modems:</div>
</li>
</ul>
<pre class="code">root@OpenWrt:~# opkg update
root@OpenWrt:~# opkg install kmod-usb-net-huawei-cdc-ncm luci-proto-ncm picocom</pre>
<ul>
<li class="level1"><div class="li"> other modems may require different packages, this is an example for Mikrotik modems:</div>
</li>
</ul>
<pre class="code">root@OpenWrt:~# opkg update
root@OpenWrt:~# opkg install kmod-usb-net-rndis kmod-usb-acm luci-proto-ncm picocom</pre>

<p>
Additional packages will be automatically installed as <em>dependencies</em>.
</p>

<p>
You can also add the necessary packages when building a new image with <a href="https://firmware-selector.openwrt.org/" class="urlextern" title="https://firmware-selector.openwrt.org/" rel="ugc nofollow">Firmware Selector</a>.
</p>

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> If your have not enough space on your device - think about upgrading your hardware or installing <a href="/docs/guide-user/additional-software/extroot_configuration" class="wikilink1" title="docs:guide-user:additional-software:extroot_configuration" data-wiki-id="docs:guide-user:additional-software:extroot_configuration">Rootfs on External Storage (extroot)</a>. Refer to your router wiki page or forum thread for possibility and instructions.
</p>

<p>
2. Reboot the router by executing <code>reboot</code> on the console.
</p>

<p>
3. Check if you got a new <em>device</em>:
</p>
<pre class="code">root@OpenWrt:~# ls -l /dev/cdc*

crw-r--r--    1 root     root      180, 176 Oct  1 12:03 /dev/cdc-wdm0</pre>

<p>
If there is no such device found, there is a possibility that completely different name is in use by the device driver, like <code>usb0</code> or <code>eth1</code>. Try to get more details:
</p>
<ul>
<li class="level1"><div class="li"> Open System Log from Luci web interface and see what it shows regarding newly discovered USB device(s)</div>
</li>
<li class="level1"><div class="li"> execute <code>dmesg</code> on the console and see if any relevant information is present in the kernel log</div>
</li>
<li class="level1"><div class="li"> check the details about USB devices detected by the system by running <code>cat /sys/kernel/debug/usb/devices</code> on the console:</div>
</li>
</ul>
<pre class="code">[...]
T:  Bus=03 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#=  2 Spd=480  MxCh= 0
D:  Ver= 2.10 Cls=00(&gt;ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs=  1
P:  Vendor=12d1 ProdID=1506 Rev= 1.02
S:  Manufacturer=HUAWEI_MOBILE
S:  Product=HUAWEI_MOBILE
C:* #Ifs= 5 Cfg#= 1 Atr=80 MxPwr=  2mA
I:* If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=03 Prot=10 Driver=(none)
E:  Ad=82(I) Atr=03(Int.) MxPS=  10 Ivl=32ms
E:  Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I:* If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=03 Prot=12 Driver=option
E:  Ad=83(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I:  If#= 2 Alt= 0 #EPs= 1 Cls=ff(vend.) Sub=03 Prot=16 Driver=huawei_cdc_ncm
E:  Ad=85(I) Atr=03(Int.) MxPS=  16 Ivl=2ms
I:* If#= 2 Alt= 1 #EPs= 3 Cls=ff(vend.) Sub=03 Prot=16 Driver=huawei_cdc_ncm
E:  Ad=85(I) Atr=03(Int.) MxPS=  16 Ivl=2ms
E:  Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I:* If#= 3 Alt= 0 #EPs= 2 Cls=08(stor.) Sub=06 Prot=50 Driver=usb-storage
E:  Ad=86(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=04(O) Atr=02(Bulk) MxPS= 512 Ivl=125us
I:* If#= 4 Alt= 0 #EPs= 2 Cls=08(stor.) Sub=06 Prot=50 Driver=usb-storage
E:  Ad=87(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=05(O) Atr=02(Bulk) MxPS= 512 Ivl=125us</pre>

<p>
See Troubleshooting Section of this page for more information.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation&quot;,&quot;hid&quot;:&quot;installation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;2374-5445&quot;} -->
<h2 class="sectionedit7" id="configuration">Configuration</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuration&quot;,&quot;hid&quot;:&quot;configuration&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:7,&quot;range&quot;:&quot;5446-5471&quot;} -->
<h3 class="sectionedit8" id="protocol_configuration">Protocol Configuration</h3>
<div class="level3">

<p>
<a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">UCI</a> is supporting <strong>NCM</strong> network protocol configuration. 
</p>
<div class="table sectionedit9"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> Name      </th><th class="col1 leftalign"> Type       </th><th class="col2 leftalign"> Required  </th><th class="col3 leftalign"> Default          </th><th class="col4 leftalign"> Description                                                                                                                  </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign"> device    </td><td class="col1 leftalign"> file path  </td><td class="col2 leftalign"> yes       </td><td class="col3 leftalign"> (none)           </td><td class="col4 leftalign"> NCM device node, usually <code>/dev/ttyUSBx</code> or <code>/dev/ttyACMx</code>; acts as a control interface                                   </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> apn       </td><td class="col1 leftalign"> string     </td><td class="col2 leftalign"> yes       </td><td class="col3 leftalign"> (none)           </td><td class="col4 leftalign"> APN to use                                                                                                                   </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"> pincode   </td><td class="col1 leftalign"> number     </td><td class="col2 leftalign"> no        </td><td class="col3 leftalign"> (none)           </td><td class="col4 leftalign"> PIN code to unlock SIM card                                                                                                  </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign"> username  </td><td class="col1 leftalign"> string     </td><td class="col2 leftalign"> no        </td><td class="col3 leftalign"> (none)           </td><td class="col4 leftalign"> Username for PAP/CHAP authentication                                                                                         </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign"> password  </td><td class="col1 leftalign"> string     </td><td class="col2 leftalign"> no        </td><td class="col3 leftalign"> (none)           </td><td class="col4 leftalign"> Password for PAP/CHAP authentication                                                                                         </td>
	</tr>
	<tr class="row6">
		<td class="col0 leftalign"> auth      </td><td class="col1 leftalign"> string     </td><td class="col2 leftalign"> no        </td><td class="col3 leftalign"> (none)           </td><td class="col4 leftalign"> Authentication type: <strong>pap</strong>, <strong>chap</strong>, <strong>both</strong>, <strong>none</strong>                                                                   </td>
	</tr>
	<tr class="row7">
		<td class="col0 leftalign"> mode      </td><td class="col1 leftalign"> string     </td><td class="col2 leftalign"> no        </td><td class="col3 leftalign"> (modem default)  </td><td class="col4 leftalign"> Used network mode, not every device support every mode: <strong>preferlte</strong>, <strong>preferumts</strong>, <strong>lte</strong>, <strong>umts</strong>, <strong>gsm</strong>, <strong>auto</strong>  </td>
	</tr>
	<tr class="row8">
		<td class="col0 leftalign"> pdptype   </td><td class="col1 leftalign"> string     </td><td class="col2 leftalign"> no        </td><td class="col3 leftalign"> <abbr title="Internet Protocol">IP</abbr>               </td><td class="col4 leftalign"> PDP Context Type, <strong><abbr title="Internet Protocol">IP</abbr></strong> (for <abbr title="Internet Protocol version 4">IPv4</abbr>), <strong>IPV6</strong> (for <abbr title="Internet Protocol version 6">IPv6</abbr>) or <strong>IPV4V6</strong> (for dual-stack)                                      </td>
	</tr>
	<tr class="row9">
		<td class="col0 leftalign"> profile   </td><td class="col1 leftalign"> number     </td><td class="col2 leftalign"> no        </td><td class="col3 leftalign"> 1                </td><td class="col4 leftalign"> PDP Context Identifier                                                                                                       </td>
	</tr>
	<tr class="row10">
		<td class="col0 leftalign"> ifname    </td><td class="col1 leftalign"> string     </td><td class="col2 leftalign"> no        </td><td class="col3 leftalign"> (none)           </td><td class="col4 leftalign"> Data interface name                                                                                                          </td>
	</tr>
	<tr class="row11">
		<td class="col0 leftalign"> delay     </td><td class="col1 leftalign"> number     </td><td class="col2 leftalign"> no        </td><td class="col3 leftalign"> 0                </td><td class="col4 leftalign"> Seconds to wait before trying to interact with the modem (some modems require up to 30 s.)                                   </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:9,&quot;range&quot;:&quot;5601-7820&quot;} -->
<p>
You can configure the interface manually using <a href="/docs/techref/uci" class="wikilink1" title="docs:techref:uci" data-wiki-id="docs:techref:uci">uci command line</a> or <a href="/docs/guide-user/base-system/user.beginner.cli#editingfiles" class="wikilink1" title="docs:guide-user:base-system:user.beginner.cli" data-wiki-id="docs:guide-user:base-system:user.beginner.cli"> text editor</a> or with <a href="/docs/techref/luci" class="wikilink1" title="docs:techref:luci" data-wiki-id="docs:techref:luci"> Luci</a> package <strong>luci-proto-ncm</strong>.
</p>

<p>
 <img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> If option “mode” is set, the corresponding AT command is sent to the modem on every connection attempt. Most of modems (at least all Huawei models) store this setting in internal flash. So on each connection OpenWrt writes to modem flash. It is recommended to not use this option after the required mode is set once.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Protocol Configuration&quot;,&quot;hid&quot;:&quot;protocol_configuration&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:8,&quot;range&quot;:&quot;5472-8380&quot;} -->
<h3 class="sectionedit10" id="network_configuration">Network configuration</h3>
<div class="level3">

<p>
Using Luci web interface: navigate to Network → Interfaces → Add new interface… → Protocol : NCM, Interface: “ttyUSB1”
</p>

<p>
The interface selected above is the “AT Command Port” or “PCUI” in Huawei terms, <code>ttyUSB1</code> is shown here as an example only, different modems have different port assignments like <code>/dev/ttyUSBx</code> or <code>/dev/ttyACMx</code>. The <em>data</em> interface like <code>wwan0</code> and corresponding device like <code>/dev/cdc-wdm0</code> will be discovered by the connection script automatically.
</p>

<p>
Enter your APN and select the &#039;<abbr title="Internet Protocol">IP</abbr> Protocol&#039; as instructed by the carrier.
</p>

<p>
Assign the firewall zone (wan) on &#039;Firewall Settings&#039; tab.<br/>

<br/>

Alternatively you can edit the configuration files with any text editor like <code>vi</code> or <code>nano</code>:
</p>
<ul>
<li class="level1"><div class="li"> add a new <strong>Interface</strong> in <code>/etc/config/network</code>:</div>
</li>
</ul>
<pre class="code">config interface &#039;wwan&#039;
        option proto &#039;ncm&#039;
        option device &#039;/dev/ttyUSB1&#039;
        option pdptype &#039;IP&#039;
        option apn &#039;internet&#039;</pre>
<ul>
<li class="level1"><div class="li"> add the same interface name to the “wan” firewall zone in <code>/etc/config/firewall</code>:</div>
</li>
</ul>
<pre class="code">config zone
    option name &#039;wan&#039;
    [...]
    list network &#039;wwan&#039;</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Network configuration&quot;,&quot;hid&quot;:&quot;network_configuration&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:10,&quot;range&quot;:&quot;8381-9539&quot;} -->
<h3 class="sectionedit11" id="additional_steps">Additional Steps</h3>
<div class="level3">

<p>
Some providers of mobile Internet use Web redirection to their service pages for access activation, modem configuration, etc.
If a <em>private</em> (rfc1918) <abbr title="Internet Protocol">IP</abbr> address is used in redirection (example: YOTA in Russia), name resolution will be blocked by <code>dnsmasq</code> by default:
</p>
<pre class="code">Jan 18 14:36:49 OpenWrt daemon.warn dnsmasq[1325]: possible DNS-rebind attack detected: my.yota.ru</pre>

<p>
To overcome this issue add the required domain to a <em>whitelist</em>: navigate in LuCI to “Network” → “<abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> and <abbr title="Domain Name System">DNS</abbr>” → “Filter” tab and type “yota.ru” without quotes in the “Domain whitelist” field then click on “+” next to it. Save &amp; apply.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Additional Steps&quot;,&quot;hid&quot;:&quot;additional_steps&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:11,&quot;range&quot;:&quot;9540-10197&quot;} -->
<h2 class="sectionedit12" id="troubleshooting">Troubleshooting</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:12,&quot;range&quot;:&quot;10198-10225&quot;} -->
<h3 class="sectionedit13" id="my_router_is_not_detecting_the_modem_what_should_i_do">My router is not detecting the modem. What should I do?</h3>
<div class="level3">

<p>
Get the information about  USB devices with <code>cat /sys/kernel/debug/usb/devices</code>
</p>

<p>
Find a section for your device, look for “Manufacturer” and/or “Product” lines corresponding to your modem, for example:
</p>
<pre class="code">S:  Manufacturer=HUAWEI_MOBILE
S:  Product=HUAWEI_MOBILE</pre>

<p>
See if necessary drivers are loaded for your device:
</p>
<pre class="code">I:* If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=03 Prot=12 Driver=option
[...]
I:  If#= 2 Alt= 0 #EPs= 1 Cls=ff(vend.) Sub=03 Prot=16 Driver=huawei_cdc_ncm</pre>

<p>
If the drivers are missing, install the missing packages and/or change the operating mode of the modem to expose the necessary interfaces. 
</p>

<p>
Finally, ask in the forum.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;My router is not detecting the modem. What should I do?&quot;,&quot;hid&quot;:&quot;my_router_is_not_detecting_the_modem_what_should_i_do&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:13,&quot;range&quot;:&quot;10226-10940&quot;} -->
<h3 class="sectionedit14" id="my_modem_doesn_t_reconnect_after_it_loses_the_connection">My modem doesn&#039;t reconnect after it loses the connection</h3>
<div class="level3">

<p>
This script <a href="https://github.com/oilervoss/openvpnForNordvpn/tree/master/etc/init.d" class="urlextern" title="https://github.com/oilervoss/openvpnForNordvpn/tree/master/etc/init.d" rel="ugc nofollow">GitHub oilervoss</a> will check the connection pinging a public <abbr title="Internet Protocol">IP</abbr> and, under failure, it will send AT commands to the serial interface of the modem restarting it.
</p>

<p>
To achieve continuous monitoring of the connection, it must be called recurrently through a cron job as:
</p>
<pre class="code">#/etc/crontabs/root
#min    h   day  mon  week  command
*/20    *    *    *    *    /etc/init.d/ncm-fix start</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;My modem doesn&#039;t reconnect after it loses the connection&quot;,&quot;hid&quot;:&quot;my_modem_doesn_t_reconnect_after_it_loses_the_connection&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:14,&quot;range&quot;:&quot;10941-11487&quot;} -->
<h3 class="sectionedit15" id="i_am_using_huawei_cdc_ncm_module_and_thedevcdc-wdm0_does_not_respond_what_do_i_do">I am using &#039;huawei_cdc_ncm&#039; module and the /dev/cdc-wdm0 does not respond. What do I do?</h3>
<div class="level3">

<p>
This is probably related to ticket #18673 (<a href="https://dev.openwrt.org/ticket/18673" class="urlextern" title="https://dev.openwrt.org/ticket/18673" rel="ugc nofollow">https://dev.openwrt.org/ticket/18673</a>).
You should be able to use the modem by starting ndis manually by sending the following to <em>/dev/ttyUSB1</em>
</p>
<pre class="code">AT^NDISDUP=1,1,&quot;your_apn_address&quot;</pre>

<p>
It is possible to automate this task using <a href="/docs/techref/hotplug_legacy" class="wikilink1" title="docs:techref:hotplug_legacy" data-wiki-id="docs:techref:hotplug_legacy">hotplug</a>. Below are some scripts fetched from <a href="http://forum.ixbt.com/post.cgi?id=print:14:59307&amp;page=4" class="urlextern" title="http://forum.ixbt.com/post.cgi?id=print:14:59307&amp;page=4" rel="ugc nofollow">http://forum.ixbt.com/post.cgi?id=print:14:59307&amp;page=4</a>. Do not forget to modify them to your needs. The scripts are for Huawei modems obviously.
</p>

<p>
<em>/etc/init.d/ncm-network</em>:
</p>
<pre class="code">#!/bin/sh /etc/rc.common

#
DEVICE=&#039;/dev/ttyUSB1&#039;
# Interface name from /etc/config/network
IFNAME=&#039;WWAN&#039;
# Your APN:
APN=&#039;your_apn_here&#039;

START=70
STOP=90

start() {
        if [ -e ${DEVICE} ]; then
                echo -ne &quot;AT^NDISDUP=1,0\r\n&quot; &gt; ${DEVICE}
                sleep 3
                echo -ne &quot;AT^NDISDUP=1,1,\&quot;${APN}\&quot;\r\n&quot; &gt; ${DEVICE}
                sleep 3
                ifup $IFNAME
        else
                echo &quot;No such device ${DEVICE}&quot; | logger -t &quot;ncm-network[$$]&quot; -p info
        fi
}

stop() {
        if [ -e ${DEVICE} ]; then
                ifdown $IFNAME
                sleep 3
                echo -ne &quot;AT^NDISDUP=1,0\r\n&quot; &gt; ${DEVICE}
        else
                echo &quot;No such device ${DEVICE}&quot; | logger -t &quot;ncm-network[$$]&quot; -p info
        fi
}</pre>

<p>
<em>/etc/hotplug.d/usb/70-ncm-network</em>
</p>
<pre class="code">#!/bin/sh

# Uncomment set line below and check your modalias I from tmp file
MODEM_ID=&#039;usb:v12D1p1506d0102dc00dsc00dp00ic08isc06ip50in05&#039;
PAUSE=10
PAUSE_FOR_HOTPLUG=5

#set &gt;&gt; /tmp/ncm-network.debug

if [ &quot;${MODALIAS}&quot; != &quot;${MODEM_ID}&quot; ]; then
        exit 0
fi

case &quot;$ACTION&quot; in
        add)
                SYSTEM_UPTIME=$(cat /proc/uptime | awk -F&quot;\.&quot; &#039;{ print $1 }&#039;)
                if [ &quot;${SYSTEM_UPTIME}&quot; -gt 60 ]; then
                        PAUSE=$PAUSE_FOR_HOTPLUG
                fi
                {
                sleep ${PAUSE} &amp;&amp; \
                echo &quot;Start modem ${MODEM_ID}&quot; | logger -t &quot;hotplug[$$]&quot; -p info &amp;&amp; \
                /etc/init.d/ncm-network start
                } &amp;
                ;;
        remove)
                echo &quot;Stop modem ${MODEM_ID}&quot; | logger -t &quot;hotplug[$$]&quot; -p info
                /etc/init.d/ncm-network stop
                ;;
esac</pre>

<p>
Some modems does not reconnect after losing connection.
Here is a connection check sh script which checks if it can ping remote servers with time intervals. If all pings fail, it tries to start the network by executing <em>/etc/init.d/ncm-network start</em>
</p>
<pre class="code">#!/bin/sh

# Enter the FQDNs you want to check with ping (space separated)
# Script does nothing if any tries to any FQDN succeeds
FQDN=&quot;www.google.com&quot;
FQDN=&quot;$FQDN www.amd.com&quot;
FQDN=&quot;$FQDN www.juniper.net&quot;

# Sleep between ping checks of a FQDN (seconds between pings)
SLEEP=3                         # Sleep time between each retry
RETRY=3                         # Retry each FQDN $RETRY times
SLEEP_MAIN=60                   # Main loop sleep time

check_connection()
{
  for NAME in $FQDN; do
    for i in $(seq 1 $RETRY); do
      ping -c 1 $NAME &gt; /dev/null 2&gt;&amp;1
      if [ $? -eq 0 ]; then
        return 0
      fi
      sleep $SLEEP
    done
  done
  # If we are here, it means all failed
  return 1
}

while true; do
  check_connection
  if [ $? -ne 0 ]; then
    /etc/init.d/ncm-network start
  fi
  sleep $SLEEP_MAIN
done
</pre>

<p>
If your SIM receives a voice call. It will downgrade to CS network which means you will downgrade into 3G mode.
To avoid this, set the stick to use only PS network by creating `/etc/hotplug.d/iface/99-ifupwwan` file with following code.
Make sure to modify it to use correct serial interface and correct AT command for your device.
</p>
<pre class="code">[ &quot;$ACTION&quot; = &quot;ifup&quot; -a &quot;$INTERFACE&quot; = &quot;wwan&quot; ] &amp;&amp; {
    logger &quot;iface wwan up detected...&quot;
    # We need to set this to stop the card from receiving phone calls
    # This is for EC-25
    #echo -ne &quot;\r\nAT+QCFG=\&quot;servicedomain\&quot;,1,1\r\n&quot; &gt; /dev/ttyUSB2
    # This is for Huawei
    echo -ne &quot;\r\nAT^SYSCFGEX=\&quot;00\&quot;,3FFFFFFF,1,1,7FFFFFFFFFFFFFFF,,\r\n&quot; &gt; /dev/ttyUSB2
}</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;I am using &#039;huawei_cdc_ncm&#039; module and the \/dev\/cdc-wdm0 does not respond. What do I do?&quot;,&quot;hid&quot;:&quot;i_am_using_huawei_cdc_ncm_module_and_thedevcdc-wdm0_does_not_respond_what_do_i_do&quot;,&quot;codeblockOffset&quot;:8,&quot;secid&quot;:15,&quot;range&quot;:&quot;11488-&quot;} -->