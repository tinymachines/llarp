
<h1 class="sectionedit1" id="routing_basics">Routing basics</h1>
<div class="level1">

<p>
See also:
<a href="http://linux-ip.net/pages/the-guide.html" class="urlextern" title="http://linux-ip.net/pages/the-guide.html" rel="ugc nofollow">IP Layer Network Administration</a>,
<a href="https://www.inetdaemon.com/tutorials/internet/ip/routing/" class="urlextern" title="https://www.inetdaemon.com/tutorials/internet/ip/routing/" rel="ugc nofollow">IP routing tutorial</a>
</p>

<p>
<a href="https://en.wikipedia.org/wiki/Routing" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Routing">Routing</a> is the process of selecting a path to send network traffic.
There are several <a href="https://en.wikipedia.org/wiki/Routing_protocol" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Routing_protocol">routing protocols</a> for <em>dynamic routing</em>, specifically <a href="/docs/guide-user/network/wifi/mesh/batman" class="wikilink1" title="docs:guide-user:network:wifi:mesh:batman" data-wiki-id="docs:guide-user:network:wifi:mesh:batman">B.A.T.M.A.N.</a> and <a href="/docs/guide-user/network/wifi/mesh/olsr" class="wikilink1" title="docs:guide-user:network:wifi:mesh:olsr" data-wiki-id="docs:guide-user:network:wifi:mesh:olsr">OLSR</a> for mesh networking, however <em>static routing</em> is typically enough for most use cases.
Routing is handled by a kernel component and can be configured by the user space tool <a href="http://man.cx/ip%288%29" class="interwiki iw_man" title="http://man.cx/ip%288%29">ip</a> from the package <a href="https://en.wikipedia.org/wiki/iproute2" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/iproute2">iproute2</a>.
Note that by default OpenWrt announces <abbr title="Internet Protocol version 6">IPv6</abbr> default route only for GUA and applies source filter for <abbr title="Internet Protocol version 6">IPv6</abbr> that allows routing only for prefixes delegated from the upstream router.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Routing basics&quot;,&quot;hid&quot;:&quot;routing_basics&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-897&quot;} -->
<h2 class="sectionedit2" id="how_it_works">How it works</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;How it works&quot;,&quot;hid&quot;:&quot;how_it_works&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;898-922&quot;} -->
<h3 class="sectionedit3" id="basic_routing">Basic routing</h3>
<div class="level3">

<p>
In a trivial case, the route is selected by the traffic destination, highest netmask and lowest metric.
Routing rules are expected to be in their default state and can be basically ignored, the same applies to routing tables other than the <code>main</code> table.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Basic routing&quot;,&quot;hid&quot;:&quot;basic_routing&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;923-1203&quot;} -->
<h3 class="sectionedit4" id="policy-based_routing">Policy-based routing</h3>
<div class="level3">

<p>
See also: 
<a href="/docs/guide-user/network/routing/pbr" class="wikilink1" title="docs:guide-user:network:routing:pbr" data-wiki-id="docs:guide-user:network:routing:pbr">Policy-based routing</a>
</p>

<p>
In general case, the kernel iterates over the routing rules from lower to higher numeric priority values.
By default, only the <code>main</code> routing table contains the default route and the corresponding rule is automatically created with a priority of <code>32766</code>.
If we utilize custom routing tables with <code>ip4table</code> and/or <code>ip6table</code> options, netifd creates the rules for each local address as source and each local subnet as destination with respective priorities of <code>10000</code> and <code>20000</code>.
To override the default route in the <code>main</code> table, we can add a rule with a priority of about <code>30000</code>, or assign each upstream interface to a separate routing table and lookup it after the <code>main</code> table.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Policy-based routing&quot;,&quot;hid&quot;:&quot;policy-based_routing&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;1204-2009&quot;} -->
<h2 class="sectionedit5" id="configuration">Configuration</h2>
<div class="level2">

<p>
See also: 
<a href="/docs/guide-user/network/routing/routes_configuration" class="wikilink1" title="docs:guide-user:network:routing:routes_configuration" data-wiki-id="docs:guide-user:network:routing:routes_configuration">Static routes</a>,
<a href="/docs/guide-user/network/routing/ip_rules" class="wikilink1" title="docs:guide-user:network:routing:ip_rules" data-wiki-id="docs:guide-user:network:routing:ip_rules">Routing rules</a>
</p>

<p>
<code><a href="/docs/guide-user/network/network_configuration" class="wikilink1" title="docs:guide-user:network:network_configuration" data-wiki-id="docs:guide-user:network:network_configuration">/etc/config/network</a></code> is the UCI configuration file where all routing related adjustments are made in OpenWrt.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuration&quot;,&quot;hid&quot;:&quot;configuration&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;2010-2342&quot;} -->
<h3 class="sectionedit6" id="default_routing_tables">Default routing tables</h3>
<div class="level3">

<p>
See also: <a href="http://man.cx/ip-route%288%29" class="interwiki iw_man" title="http://man.cx/ip-route%288%29">ip-route</a>
</p>
<div class="table sectionedit7"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> ID </th><th class="col1"> Name </th><th class="col2"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>0</code> </td><td class="col1"> <code>unspec</code> </td><td class="col2"> Special table matching all table names/IDs. </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>253</code> </td><td class="col1"> <code>default</code> </td><td class="col2"> Reserved table, empty by default. </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>254</code> </td><td class="col1"> <code>main</code> </td><td class="col2"> Routing table with all non-policy routes. </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code>255</code> </td><td class="col1"> <code>local</code> </td><td class="col2"> Special table with local and broadcast addresses. </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:7,&quot;range&quot;:&quot;2416-2717&quot;} -->
<p>
Edit <code>/etc/iproute2/rt_tables</code> to customize routing tables.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Default routing tables&quot;,&quot;hid&quot;:&quot;default_routing_tables&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;2343-2781&quot;} -->
<h3 class="sectionedit8" id="default_routing_rules">Default routing rules</h3>
<div class="level3">

<p>
See also: <a href="http://man.cx/ip-rule%288%29" class="interwiki iw_man" title="http://man.cx/ip-rule%288%29">ip-rule</a>
</p>
<div class="table sectionedit9"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Priority </th><th class="col1"> Match </th><th class="col2"> Lookup table </th><th class="col3"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>0</code> </td><td class="col1"> anything </td><td class="col2"> <code>local</code> </td><td class="col3"> High priority routing for local and broadcast addresses. </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>10000</code> </td><td class="col1"> local addresses as source </td><td class="col2"> <code>&lt;custom&gt;</code> </td><td class="col3"> A list of rules for each local address created by netifd when using <code>ip4table</code> or <code>ip6table</code>. </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>20000</code> </td><td class="col1"> local subnets as destination </td><td class="col2"> <code>&lt;custom&gt;</code> </td><td class="col3"> A list of rules for each local subnet created by netifd when using <code>ip4table</code> or <code>ip6table</code>. </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code>32766</code> </td><td class="col1"> anything </td><td class="col2"> <code>main</code> </td><td class="col3"> Non-policy routing, can be overridden with other rules by the administrator, also offers routes for tunnel endpoints. </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <code>32767</code> </td><td class="col1"> <abbr title="Internet Protocol version 4">IPv4</abbr> traffic </td><td class="col2"> <code>default</code> </td><td class="col3"> Post-processing for <abbr title="Internet Protocol version 4">IPv4</abbr> traffic missed by previous rules. </td>
	</tr>
	<tr class="row6">
		<td class="col0"> <code>90000+</code> </td><td class="col1"> traffic from local system </td><td class="col2"> <code>&lt;custom&gt;</code> </td><td class="col3"> A list of rules for each interface created by netifd when using <code>ip4table</code> or <code>ip6table</code>, works as failover for traffic from the local system. </td>
	</tr>
	<tr class="row7">
		<td class="col0"> <code>4200000000+</code> </td><td class="col1"> <abbr title="Internet Protocol version 6">IPv6</abbr> traffic to interfaces </td><td class="col2"> <code>-</code> </td><td class="col3"> A list of terminating rules automatically created for each <abbr title="Internet Protocol version 6">IPv6</abbr> interface. </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table1&quot;,&quot;secid&quot;:9,&quot;range&quot;:&quot;2852-3910&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Default routing rules&quot;,&quot;hid&quot;:&quot;default_routing_rules&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;2782-3911&quot;} -->
<h2 class="sectionedit10" id="testing">Testing</h2>
<div class="level2">

<p>
Verify your routing <a href="http://man.cx/traceroute%288%29" class="interwiki iw_man" title="http://man.cx/traceroute%288%29">traceroute</a> and <a href="http://man.cx/traceroute6%288%29" class="interwiki iw_man" title="http://man.cx/traceroute6%288%29">traceroute6</a>.
</p>
<pre class="code bash">traceroute openwrt.org
traceroute6 openwrt.org</pre>

<p>
Check your <abbr title="Internet Protocol">IP</abbr> and <abbr title="Domain Name System">DNS</abbr> provider.
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://ipleak.net/" class="urlextern" title="https://ipleak.net/" rel="ugc nofollow">ipleak.net</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://www.dnsleaktest.com/" class="urlextern" title="https://www.dnsleaktest.com/" rel="ugc nofollow">dnsleaktest.com</a></div>
</li>
</ul>

<p>
Test routing for a specific destination.
</p>
<pre class="code bash"><span class="kw2">ip route</span> get 198.51.100.1
<span class="kw2">ip route</span> get 198.51.100.1 from 192.168.1.1
<span class="kw2">ip route</span> get <span class="nu0">2001</span>:db8::<span class="nu0">1</span>
<span class="kw2">ip route</span> get <span class="nu0">2001</span>:db8::<span class="nu0">1</span> from fd00:<span class="nu0">1</span>::<span class="nu0">1</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Testing&quot;,&quot;hid&quot;:&quot;testing&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:10,&quot;range&quot;:&quot;3912-4415&quot;} -->
<h2 class="sectionedit11" id="troubleshooting">Troubleshooting</h2>
<div class="level2">

<p>
Collect and analyze the following information.
</p>
<pre class="code bash"><span class="co0"># Restart services</span>
service log restart; service network restart; <span class="kw2">sleep</span> <span class="nu0">10</span>
&nbsp;
<span class="co0"># Log and status</span>
logread; ifstatus wan; ifstatus wan6
&nbsp;
<span class="co0"># Runtime configuration</span>
<span class="kw2">ip</span> address show; <span class="kw2">ip route</span> show table all
<span class="kw2">ip rule</span> show; <span class="kw2">ip</span> <span class="re5">-6</span> rule show; nft list ruleset
&nbsp;
<span class="co0"># Persistent configuration</span>
uci show network; uci show dhcp; uci show firewall
<span class="kw2">grep</span> <span class="re5">-v</span> <span class="re5">-e</span> <span class="st0">&quot;^#&quot;</span> <span class="re5">-e</span> <span class="st0">&quot;^$&quot;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>iproute2<span class="sy0">/</span>rt_tables</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:11,&quot;range&quot;:&quot;4416-&quot;} -->