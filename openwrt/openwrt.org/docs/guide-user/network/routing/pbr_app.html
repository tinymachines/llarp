
<h1 class="sectionedit1" id="pbr_app">PBR app</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;PBR app&quot;,&quot;hid&quot;:&quot;pbr_app&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-104&quot;} -->
<h2 class="sectionedit6" id="introduction">Introduction</h2>
<div class="level2">

<p>
<a href="https://docs.openwrt.melmac.net/pbr/" class="urlextern" title="https://docs.openwrt.melmac.net/pbr/" rel="ugc nofollow">PBR app</a> provides an advanced policy-based routing solution.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;105-231&quot;} -->
<h2 class="sectionedit7" id="command-line_instructions">Command-line instructions</h2>
<div class="level2">

<p>
Install and enable <abbr title="Policy Based Routing">PBR</abbr> app.
</p>
<pre class="code bash"><span class="co0"># Install packages</span>
opkg update
opkg <span class="kw2">install</span> pbr
&nbsp;
<span class="co0"># Enable PBR</span>
uci <span class="kw1">set</span> pbr.config.enabled=<span class="st0">&quot;1&quot;</span>
uci commit pbr
service pbr restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Command-line instructions&quot;,&quot;hid&quot;:&quot;command-line_instructions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;232-447&quot;} -->
<h2 class="sectionedit8" id="extras">Extras</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Extras&quot;,&quot;hid&quot;:&quot;extras&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:8,&quot;range&quot;:&quot;448-466&quot;} -->
<h3 class="sectionedit9" id="web_interface">Web interface</h3>
<div class="level3">

<p>
If you want to manage <abbr title="Policy Based Routing">PBR</abbr> settings using web interface.
Install the necessary packages.
</p>
<pre class="code bash"><span class="co0"># Install packages</span>
opkg update
opkg <span class="kw2">install</span> luci-app-pbr
service rpcd restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Web interface&quot;,&quot;hid&quot;:&quot;web_interface&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:9,&quot;range&quot;:&quot;467-678&quot;} -->
<h3 class="sectionedit10" id="support_openvpn">Support OpenVPN</h3>
<div class="level3">

<p>
Support unmanaged protocols like OpenVPN.
</p>
<pre class="code bash"><span class="co0"># Support OpenVPN</span>
uci add_list pbr.config.supported_interface=<span class="st0">&quot;tun*&quot;</span>
uci commit pbr
service pbr restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Support OpenVPN&quot;,&quot;hid&quot;:&quot;support_openvpn&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:10,&quot;range&quot;:&quot;679-872&quot;} -->
<h3 class="sectionedit11" id="support_tailscale">Support Tailscale</h3>
<div class="level3">

<p>
Create rules with a lower numeric priority value when using <a href="/docs/guide-user/services/vpn/tailscale/start" class="wikilink1" title="docs:guide-user:services:vpn:tailscale:start" data-wiki-id="docs:guide-user:services:vpn:tailscale:start">Tailscale</a>. Note that Tailscale (with exit node configured) sets itself up as the default and this may not be reflected in <abbr title="Policy Based Routing">PBR</abbr> Luci (which might, e.g., still show <abbr title="Wide Area Network">WAN</abbr> as default route).
</p>
<pre class="code bash"><span class="co0"># Support Tailscale</span>
uci <span class="kw1">set</span> pbr.config.wan_ip_rules_priority=<span class="st0">&quot;1000&quot;</span>
uci commit pbr
service pbr restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Support Tailscale&quot;,&quot;hid&quot;:&quot;support_tailscale&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:11,&quot;range&quot;:&quot;873-1319&quot;} -->
<h3 class="sectionedit12" id="route_lan_to_vpn">Route LAN to VPN</h3>
<div class="level3">

<p>
<a href="https://docs.openwrt.melmac.net/pbr/#a-word-about-default-routing" class="urlextern" title="https://docs.openwrt.melmac.net/pbr/#a-word-about-default-routing" rel="ugc nofollow">Disable gateway redirection</a> in the <abbr title="Virtual Private Network">VPN</abbr> client configuration.
Route <abbr title="Local Area Network">LAN</abbr> <code>192.168.1.0/24</code> to <abbr title="Virtual Private Network">VPN</abbr>.
</p>
<pre class="code bash"><span class="co0"># Route LAN to VPN</span>
uci add pbr policy
uci <span class="kw1">set</span> pbr.<span class="sy0">@</span>policy<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.src_addr=<span class="st0">&quot;192.168.1.0/24&quot;</span>
uci <span class="kw1">set</span> pbr.<span class="sy0">@</span>policy<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.interface=<span class="st0">&quot;vpn&quot;</span>
uci commit pbr
service pbr restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Route LAN to VPN&quot;,&quot;hid&quot;:&quot;route_lan_to_vpn&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:12,&quot;range&quot;:&quot;1320-1699&quot;} -->
<h3 class="sectionedit13" id="forward_wan_port">Forward WAN port</h3>
<div class="level3">

<p>
Forward <abbr title="Wide Area Network">WAN</abbr> port to a webserver running on <code>192.168.1.2</code>.
Arrange this policy above more generic ones.
</p>
<pre class="code bash"><span class="co0"># Forward WAN port</span>
uci add pbr policy
uci <span class="kw1">set</span> pbr.<span class="sy0">@</span>policy<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.src_addr=<span class="st0">&quot;192.168.1.2&quot;</span>
uci <span class="kw1">set</span> pbr.<span class="sy0">@</span>policy<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.src_port=<span class="st0">&quot;443&quot;</span>
uci <span class="kw1">set</span> pbr.<span class="sy0">@</span>policy<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.proto=<span class="st0">&quot;tcp&quot;</span>
uci <span class="kw1">set</span> pbr.<span class="sy0">@</span>policy<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.interface=<span class="st0">&quot;wan&quot;</span>
uci reorder pbr.<span class="sy0">@</span>policy<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>=<span class="st0">&quot;1&quot;</span>
uci commit pbr
service pbr restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Forward WAN port&quot;,&quot;hid&quot;:&quot;forward_wan_port&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:13,&quot;range&quot;:&quot;1700-2120&quot;} -->
<h3 class="sectionedit14" id="prioritize_local_subnets">Prioritize local subnets</h3>
<div class="level3">

<p>
Prioritize routing between local subnets <code>192.168.1.0/24</code> and <code>192.168.3.0/24</code>.
Arrange this policy above all others.
</p>
<pre class="code bash"><span class="co0"># Prioritize local subnets</span>
uci <span class="kw1">set</span> pbr.config.webui_show_ignore_target=<span class="st0">&quot;1&quot;</span>
uci add pbr policy
uci <span class="kw1">set</span> pbr.<span class="sy0">@</span>policy<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.dest_addr=<span class="st0">&quot;192.168.1.0/24 192.168.3.0/24&quot;</span>
uci <span class="kw1">set</span> pbr.<span class="sy0">@</span>policy<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.interface=<span class="st0">&quot;ignore&quot;</span>
uci reorder pbr.<span class="sy0">@</span>policy<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>=<span class="st0">&quot;1&quot;</span>
uci commit pbr
service pbr restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Prioritize local subnets&quot;,&quot;hid&quot;:&quot;prioritize_local_subnets&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:14,&quot;range&quot;:&quot;2121-&quot;} -->