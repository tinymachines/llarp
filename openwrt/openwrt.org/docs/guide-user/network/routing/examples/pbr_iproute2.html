
<h1 class="sectionedit1" id="routing_examplepbr_with_iproute2">Routing example: PBR with iproute2</h1>
<div class="level1">

<p>
Routing through your tunnel can be as simple as &#039;send-it-all&#039;, the default if you use LuCI to create the interface, or as complex as you want.
Advanced routing is not the purpose of this howto, but if all you want is to do simple source based routing, that is, route traffic through your <abbr title="Virtual Private Network">VPN</abbr> based in the hosts <abbr title="Internet Protocol">IP</abbr> addresses, here is how.
</p>

<p>
First you need to install the <code>ip</code> package (formerly <code>iproute2</code>).
It allows you, among other things, to enable more than one routing table and to create rules to apply them, without any additional firewall rules.
For this to work, host&#039;s <abbr title="Internet Protocol">IP</abbr> must be always the same.
You can configure it manually in the host or designate one in your <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> using its MAC address or host name.
</p>

<p>
Now use <code>opkg</code> or LuCI to install <code>ip</code> and create a new routing table.
To do that edit <code><a href="/docs/guide-user/base-system/notuci.config#etciproute2rt_tables" class="wikilink1" title="docs:guide-user:base-system:notuci.config" data-wiki-id="docs:guide-user:base-system:notuci.config">/etc/iproute2/rt_tables</a></code>.
It should look like this:
</p>
<pre class="code bash"><span class="co0">#</span>
<span class="co0"># reserved values</span>
<span class="co0">#</span>
<span class="nu0">255</span>  <span class="kw3">local</span>
<span class="nu0">254</span>  main
<span class="nu0">253</span>  default
<span class="nu0">10</span>   vpn
<span class="nu0">0</span>    unspec
<span class="co0">#</span>
<span class="co0"># local</span>
<span class="co0">#</span>
<span class="co0">#1   inr.ruhelp</span></pre>

<p>
Only the line <code>10  vpn</code> was added, and both the number and the name are for you to chose. To learn more about the number and names, read <a href="https://web.archive.org/web/20210902034600/https://serverfault.com/questions/963206/confused-about-iproute2-rt-tables" class="urlextern" title="https://web.archive.org/web/20210902034600/https://serverfault.com/questions/963206/confused-about-iproute2-rt-tables" rel="ugc nofollow">https://web.archive.org/web/20210902034600/https://serverfault.com/questions/963206/confused-about-iproute2-rt-tables</a>.
Save the file and add one ore more host rules in the terminal.
Supposing you want to route two hosts with addresses 192.168.1.20 and 192.168.1.30 (could be any addresses) use
</p>
<pre class="code bash"><span class="kw2">ip rule</span> add from 192.168.1.20 table vpn
<span class="kw2">ip rule</span> add from 192.168.1.30 table vpn</pre>

<p>
Now add a default route to your new table and flush the route cache using
</p>
<pre class="code bash"><span class="kw2">ip route</span> add default via <span class="sy0">&lt;</span>ip_of_the_far_end_of_your_tunnel<span class="sy0">&gt;</span> dev <span class="sy0">&lt;</span>pptp_iface_name<span class="sy0">&gt;</span> table vpn
<span class="kw2">ip route</span> flush cache</pre>

<p>
<strong>Update:</strong> If you can&#039;t get <abbr title="Internet Control Message Protocol">ICMP</abbr> packets to pass through and thus you are unable to open half of the websites you want, add a few more lines to the above configuration so it looks like:
</p>
<pre class="code bash"><span class="kw2">ip rule</span> add from 192.168.1.20 table vpn
<span class="kw2">ip rule</span> add from 192.168.1.30 table vpn
<span class="kw2">ip route</span> add 192.168.1.20 dev <span class="sy0">&lt;</span>pptp_iface_name<span class="sy0">&gt;</span> table vpn
<span class="kw2">ip route</span> add 192.168.1.30 dev <span class="sy0">&lt;</span>pptp_iface_name<span class="sy0">&gt;</span> table vpn
<span class="kw2">ip route</span> add default via <span class="sy0">&lt;</span>ip_of_the_far_end_of_your_tunnel<span class="sy0">&gt;</span> dev <span class="sy0">&lt;</span>pptp_iface_name<span class="sy0">&gt;</span> table vpn
<span class="kw2">ip route</span> flush cache</pre>

<p>
Now all the traffic from hosts using the alternate routing table will go through the <abbr title="Virtual Private Network">VPN</abbr>.
You can <code>traceroute</code> from a <abbr title="Virtual Private Network">VPN</abbr> routed host to check it.
The table you created will survive reboots (it&#039;s written), but the route and rules won&#039;t so you must add them using a script.
Search documentation for the proper way to do that.
</p>

<p>
<strong>Update:</strong> If you can ping external <abbr title="Internet Protocol">IP</abbr> addresses from the host through the <abbr title="Virtual Private Network">VPN</abbr>, but not any other local hosts in your network (traceroute not working), the default gateway or you (probably) cannot ping qualified domain addresses (<abbr title="Domain Name System">DNS</abbr> not working), check the following:
</p>

<p>
If you see something like this in your current configuration, it means that the rules you added precede <code>local</code> rule.
This means that local traffic is routed through the <code>vpn</code> table you just added, because new rules have a higher priority.
This might be undesirable in many cases.
</p>
<pre class="code bash"><span class="co0"># ip rule list</span>
<span class="nu0">0</span>:      from 192.168.1.20 lookup vpn
<span class="nu0">0</span>:      from 192.168.1.30 lookup vpn
<span class="nu0">0</span>:	from all lookup <span class="kw3">local</span> 
<span class="nu0">32766</span>:	from all lookup main 
<span class="nu0">32767</span>:	from all lookup default</pre>

<p>
All you need to do is to set the correct priority for your rules.
Modify the <code>ip rule add</code> commands to the following:
</p>
<pre class="code bash"><span class="kw2">ip rule</span> add from 192.168.1.20 priority <span class="nu0">10</span> table vpn
<span class="kw2">ip rule</span> add from 192.168.1.30 priority <span class="nu0">10</span> table vpn</pre>

<p>
You should be able to traceroute to any host on the Internet and verify that your traffic goes through the <abbr title="Virtual Private Network">VPN</abbr>.
You also should be able to ping your default gateway now.
</p>

<p>
You can do a lot using only <code>ip</code> package routing manipulation.
For even more complex routing rules, it can also be coupled with <code>iptables</code> marking rules: <code>iptables</code> marks the packets using <code>PREROUTING</code> and <code>mangle</code> table, and <code>ip</code> routes them according to the marking.
Just google for information about it.
</p>

</div>
