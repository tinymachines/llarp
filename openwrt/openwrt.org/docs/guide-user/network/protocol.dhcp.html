
<h1 class="sectionedit1" id="dhcp_client_scripts">DHCP client scripts</h1>
<div class="level1">

<p>
See:
<a href="/docs/guide-user/network/ipv4/configuration#protocol_dhcp" class="wikilink1" title="docs:guide-user:network:ipv4:configuration" data-wiki-id="docs:guide-user:network:ipv4:configuration">DHCP client</a>,
<a href="/docs/guide-user/network/ipv6/configuration#protocol_dhcpv6" class="wikilink1" title="docs:guide-user:network:ipv6:configuration" data-wiki-id="docs:guide-user:network:ipv6:configuration">DHCPv6 client</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;DHCP client scripts&quot;,&quot;hid&quot;:&quot;dhcp_client_scripts&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-191&quot;} -->
<h2 class="sectionedit2" id="troubleshooting">Troubleshooting</h2>
<div class="level2">
<pre class="code bash"><span class="co0"># Install packages </span>
opkg update
opkg <span class="kw2">install</span> tcpdump
&nbsp;
<span class="co0"># Capture DHCP traffic</span>
tcpdump <span class="re5">-evni</span> any udp port <span class="nu0">67</span> <span class="sy0">&amp;</span> \
<span class="kw2">sleep</span> <span class="nu0">5</span>; \
<span class="kw2">killall</span> <span class="re5">-SIGUSR1</span> udhcpc; \
<span class="kw2">sleep</span> <span class="nu0">5</span>; \
<span class="kw2">killall</span> tcpdump
&nbsp;
<span class="co0"># Capture DHCPv6 traffic</span>
tcpdump <span class="re5">-evni</span> any udp port <span class="nu0">547</span> <span class="sy0">&amp;</span> \
<span class="kw2">sleep</span> <span class="nu0">5</span>; \
<span class="kw2">killall</span> <span class="re5">-SIGUSR1</span> odhcp6c; \
<span class="kw2">sleep</span> <span class="nu0">5</span>; \
<span class="kw2">killall</span> tcpdump</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;192-543&quot;} -->
<h2 class="sectionedit3" id="dhcp_client_scripts1">DHCP client scripts</h2>
<div class="level2">

<p>
See also:
<a href="/docs/guide-user/base-system/dhcp_configuration#providing_isp_dns_with_dhcp" class="wikilink1" title="docs:guide-user:base-system:dhcp_configuration" data-wiki-id="docs:guide-user:base-system:dhcp_configuration">Providing ISP DNS with DHCP</a>,
<a href="/docs/guide-user/base-system/hotplug" class="wikilink1" title="docs:guide-user:base-system:hotplug" data-wiki-id="docs:guide-user:base-system:hotplug">Hotplug</a>
</p>
<pre class="code bash"><span class="co0"># Logging DHCP client</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>udhcpc.user.d<span class="sy0">/</span>00-logger
logger <span class="re5">-t</span> <span class="co1">${0##*/}</span> <span class="co1">${@}</span> $<span class="br0">&#40;</span><span class="kw2">env</span><span class="br0">&#41;</span>
EOF
&nbsp;
<span class="co0"># Logging DHCPv6 client</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>odhcp6c.user.d<span class="sy0">/</span>00-logger
logger <span class="re5">-t</span> <span class="co1">${0##*/}</span> <span class="co1">${@}</span> $<span class="br0">&#40;</span><span class="kw2">env</span><span class="br0">&#41;</span>
EOF
&nbsp;
<span class="co0"># Fetching new leases</span>
<span class="kw2">ifup</span> wan
<span class="kw2">ifup</span> wan6
&nbsp;
<span class="co0"># Reading logs</span>
logread <span class="re5">-e</span> dhcp.script
logread <span class="re5">-e</span> dhcpv6.script
&nbsp;
<span class="co0"># Checking status</span>
ifstatus wan
ifstatus wan6</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;DHCP client scripts&quot;,&quot;hid&quot;:&quot;dhcp_client_scripts1&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:3,&quot;range&quot;:&quot;544-1121&quot;} -->
<h2 class="sectionedit4" id="references">References</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="https://udhcp.busybox.net/README.udhcpc" class="urlextern" title="https://udhcp.busybox.net/README.udhcpc" rel="ugc nofollow">udhcpc documentation</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/openwrt/odhcp6c#readme" class="urlextern" title="https://github.com/openwrt/odhcp6c#readme" rel="ugc nofollow">odhcp6c documentation and examples</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;References&quot;,&quot;hid&quot;:&quot;references&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:4,&quot;range&quot;:&quot;1122-1299&quot;} -->
<h2 class="sectionedit5" id="extras">Extras</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Extras&quot;,&quot;hid&quot;:&quot;extras&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:5,&quot;range&quot;:&quot;1300-1318&quot;} -->
<h3 class="sectionedit6" id="updating_default_route">Updating default route</h3>
<div class="level3">

<p>
Update default route.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>udhcpc.user.d<span class="sy0">/</span><span class="nu0">30</span>-default-route
<span class="re2">DHCPC_EVENT</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="re2">DHCPC_IF</span>=<span class="st0">&quot;<span class="es3">${interface}</span>&quot;</span>
<span class="re2">DHCPC_GW</span>=<span class="st0">&quot;<span class="es3">${router}</span>&quot;</span>
<span class="kw1">case</span> <span class="co1">${DHCPC_EVENT}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>bound<span class="sy0">|</span>renew<span class="br0">&#41;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">exit</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw2">ip route</span> delete default dev <span class="st0">&quot;<span class="es3">${DHCPC_IF}</span>&quot;</span>
<span class="kw2">ip route</span> add default via <span class="st0">&quot;<span class="es3">${DHCPC_GW}</span>&quot;</span> dev <span class="st0">&quot;<span class="es3">${DHCPC_IF}</span>&quot;</span>
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Updating default route&quot;,&quot;hid&quot;:&quot;updating_default_route&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:6,&quot;range&quot;:&quot;1319-1672&quot;} -->
<h3 class="sectionedit7" id="updating_ipv6_default_route">Updating IPv6 default route</h3>
<div class="level3">

<p>
Update <abbr title="Internet Protocol version 6">IPv6</abbr> default route.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>odhcp6c.user.d<span class="sy0">/</span><span class="nu0">30</span>-default-route
<span class="re2">DHCPC_EVENT</span>=<span class="st0">&quot;<span class="es3">${2}</span>&quot;</span>
<span class="re2">DHCPC_IF</span>=<span class="st0">&quot;<span class="es3">${INTERFACE}</span>&quot;</span>
<span class="re2">DHCPC_GW</span>=<span class="st0">&quot;<span class="es3">${SERVER}</span>&quot;</span>
<span class="kw1">case</span> <span class="co1">${DHCPC_EVENT}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>bound<span class="sy0">|</span>informed<span class="sy0">|</span>updated<span class="sy0">|</span>rebound<span class="sy0">|</span>ra-updated<span class="br0">&#41;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">exit</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw2">ip</span> <span class="re5">-6</span> route delete default dev <span class="st0">&quot;<span class="es3">${DHCPC_IF}</span>&quot;</span>
<span class="kw2">ip</span> <span class="re5">-6</span> route add default via <span class="st0">&quot;<span class="es3">${DHCPC_GW}</span>&quot;</span> dev <span class="st0">&quot;<span class="es3">${DHCPC_IF}</span>&quot;</span>
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Updating IPv6 default route&quot;,&quot;hid&quot;:&quot;updating_ipv6_default_route&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:7,&quot;range&quot;:&quot;1673-2073&quot;} -->
<h3 class="sectionedit8" id="updating_dhcp_server_route">Updating DHCP server route</h3>
<div class="level3">

<p>
Update <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> server route.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>udhcpc.user.d<span class="sy0">/</span><span class="nu0">30</span>-dhcp-route
<span class="re2">DHCPC_EVENT</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="re2">DHCPC_IF</span>=<span class="st0">&quot;<span class="es3">${interface}</span>&quot;</span>
<span class="re2">DHCPC_SERV</span>=<span class="st0">&quot;<span class="es3">${serverid}</span>&quot;</span>
<span class="kw1">case</span> <span class="co1">${DHCPC_EVENT}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>bound<span class="sy0">|</span>renew<span class="br0">&#41;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">exit</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw2">ip route</span> delete <span class="st0">&quot;<span class="es3">${DHCPC_SERV}</span>&quot;</span> dev <span class="st0">&quot;<span class="es3">${DHCPC_IF}</span>&quot;</span>
<span class="kw2">ip route</span> add <span class="st0">&quot;<span class="es3">${DHCPC_SERV}</span>&quot;</span> dev <span class="st0">&quot;<span class="es3">${DHCPC_IF}</span>&quot;</span>
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Updating DHCP server route&quot;,&quot;hid&quot;:&quot;updating_dhcp_server_route&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:8,&quot;range&quot;:&quot;2074-2434&quot;} -->
<h3 class="sectionedit9" id="providing_isp_dns_with_dhcp">Providing ISP DNS with DHCP</h3>
<div class="level3">

<p>
Announce <abbr title="Internet Service Provider">ISP</abbr> <abbr title="Domain Name System">DNS</abbr> servers with <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>udhcpc.user.d<span class="sy0">/</span><span class="nu0">50</span>-isp-dns
<span class="re2">DHCP_POOL</span>=<span class="st0">&quot;lan&quot;</span>
<span class="re2">DHCPC_EVENT</span>=<span class="st0">&quot;<span class="es3">${1}</span>&quot;</span>
<span class="re2">DNS_SERV</span>=<span class="st0">&quot;<span class="es3">${dns}</span>&quot;</span>
<span class="kw1">case</span> <span class="co1">${DHCPC_EVENT}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>bound<span class="sy0">|</span>renew<span class="br0">&#41;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">exit</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw1">for</span> DHCP_POOL <span class="kw1">in</span> <span class="co1">${DHCP_POOL}</span>
<span class="kw1">do</span> <span class="re2">DHCP_OPT</span>=<span class="st0">&quot;<span class="es4">$(uci -q get dhcp.${DHCP_POOL}.dhcp_option)</span>&quot;</span>
<span class="kw1">for</span> DHCP_OPT <span class="kw1">in</span> <span class="co1">${DHCP_OPT}</span>
<span class="kw1">do</span> <span class="kw1">case</span> <span class="co1">${DHCP_OPT%%,*}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span><span class="nu0">6</span><span class="sy0">|</span>option:dns-server<span class="br0">&#41;</span>
uci del_list dhcp.<span class="co1">${DHCP_POOL}</span>.dhcp_option=<span class="st0">&quot;<span class="es3">${DHCP_OPT}</span>&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw1">done</span>
uci add_list dhcp.<span class="co1">${DHCP_POOL}</span>.dhcp_option=<span class="st0">&quot;6,<span class="es3">${DNS_SERV// /,}</span>&quot;</span>
<span class="kw1">done</span>
uci commit dhcp
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>dnsmasq restart
EOF</pre>

<p>
Reconnect your clients to apply changes.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Providing ISP DNS with DHCP&quot;,&quot;hid&quot;:&quot;providing_isp_dns_with_dhcp&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:9,&quot;range&quot;:&quot;2435-3081&quot;} -->
<h3 class="sectionedit10" id="providing_ipv6_isp_dns_with_dhcpv6">Providing IPv6 ISP DNS with DHCPv6</h3>
<div class="level3">

<p>
Announce <abbr title="Internet Protocol version 6">IPv6</abbr> <abbr title="Internet Service Provider">ISP</abbr> <abbr title="Domain Name System">DNS</abbr> servers with DHCPv6.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>odhcp6c.user.d<span class="sy0">/</span><span class="nu0">50</span>-isp-dns
<span class="re2">DHCP_POOL</span>=<span class="st0">&quot;lan&quot;</span>
<span class="re2">DHCPC_EVENT</span>=<span class="st0">&quot;<span class="es3">${2}</span>&quot;</span>
<span class="re2">DNS_SERV</span>=<span class="st0">&quot;<span class="es3">${RA_DNS}</span> <span class="es3">${RDNSS}</span>&quot;</span>
<span class="kw1">case</span> <span class="co1">${DHCPC_EVENT}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>bound<span class="sy0">|</span>informed<span class="sy0">|</span>updated<span class="sy0">|</span>rebound<span class="sy0">|</span>ra-updated<span class="br0">&#41;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">exit</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw1">for</span> DHCP_POOL <span class="kw1">in</span> <span class="co1">${DHCP_POOL}</span>
<span class="kw1">do</span> uci <span class="re5">-q</span> delete dhcp.<span class="co1">${DHCP_POOL}</span>.dns
<span class="kw1">for</span> DNS_SERV <span class="kw1">in</span> <span class="co1">${DNS_SERV}</span>
<span class="kw1">do</span> uci add_list dhcp.<span class="co1">${DHCP_POOL}</span>.dns=<span class="st0">&quot;<span class="es3">${DNS_SERV}</span>&quot;</span>
<span class="kw1">done</span>
<span class="kw1">done</span>
uci commit dhcp
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>odhcpd restart
EOF</pre>

<p>
Reconnect your clients to apply changes.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Providing IPv6 ISP DNS with DHCPv6&quot;,&quot;hid&quot;:&quot;providing_ipv6_isp_dns_with_dhcpv6&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:10,&quot;range&quot;:&quot;3082-3639&quot;} -->
<h3 class="sectionedit11" id="getting_specific_wan_ip_address">Getting specific WAN IP address</h3>
<div class="level3">

<p>
Assuming your <abbr title="Internet Service Provider">ISP</abbr> provides a dynamic <abbr title="Internet Protocol">IP</abbr> address with <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>.
Reconnect until you get the one matching a specific regexp.
Delay for 10 seconds between reconnects.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>udhcpc.user.d<span class="sy0">/</span><span class="nu0">10</span>-wan-ipaddr
<span class="re2">WAN_ADDR</span>=<span class="st0">&quot;<span class="es3">${ip}</span>&quot;</span>
<span class="kw1">case</span> <span class="co1">${WAN_ADDR}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>??.???.<span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">exit</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw2">sleep</span> <span class="nu0">10</span>
<span class="kw2">ifup</span> <span class="co1">${INTERFACE}</span>
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Getting specific WAN IP address&quot;,&quot;hid&quot;:&quot;getting_specific_wan_ip_address&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:11,&quot;range&quot;:&quot;3640-4005&quot;} -->
<h3 class="sectionedit12" id="resolving_wanlan_subnet_conflicts">Resolving WAN/LAN subnet conflicts</h3>
<div class="level3">

<p>
Automatically resolve <abbr title="Wide Area Network">WAN</abbr>/<abbr title="Local Area Network">LAN</abbr> subnet conflicts.
Change <abbr title="Local Area Network">LAN</abbr> subnet if it overlaps with <abbr title="Wide Area Network">WAN</abbr>.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>udhcpc.user.d<span class="sy0">/</span><span class="nu0">10</span>-lan-ipaddr
<span class="re2">WAN_ADDR</span>=<span class="st0">&quot;<span class="es3">${ip}</span>&quot;</span>
<span class="re2">LAN_IF</span>=<span class="st0">&quot;lan&quot;</span>
<span class="re2">LAN_ADDR</span>=<span class="st0">&quot;<span class="es4">$(uci -q get network.${LAN_IF}.ipaddr)</span>&quot;</span>
<span class="kw1">case</span> <span class="co1">${WAN_ADDR}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span><span class="nu0">192.168</span>.<span class="sy0">*</span><span class="br0">&#41;</span> <span class="re2">NEW_ADDR</span>=<span class="st0">&quot;172.16.1.1&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="re2">NEW_ADDR</span>=<span class="st0">&quot;192.168.1.1&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw1">case</span> <span class="co1">${NEW_ADDR}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span><span class="co1">${LAN_ADDR}</span><span class="br0">&#41;</span> <span class="kw3">exit</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
uci <span class="kw1">set</span> network.<span class="co1">${LAN_IF}</span>.ipaddr=<span class="st0">&quot;<span class="es3">${NEW_ADDR}</span>&quot;</span>
uci commit network
<span class="kw2">ifup</span> <span class="co1">${LAN_IF}</span>
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Resolving WAN\/LAN subnet conflicts&quot;,&quot;hid&quot;:&quot;resolving_wanlan_subnet_conflicts&quot;,&quot;codeblockOffset&quot;:8,&quot;secid&quot;:12,&quot;range&quot;:&quot;4006-&quot;} -->