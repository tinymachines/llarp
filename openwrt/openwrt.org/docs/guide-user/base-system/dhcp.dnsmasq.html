
<h1 class="sectionedit1" id="dnsmasq_dhcp_server">Dnsmasq DHCP server</h1>
<div class="level1">

<p>
<a href="https://en.wikipedia.org/wiki/Dnsmasq" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Dnsmasq">Dnsmasq</a> is a lightweight, easy to configure <abbr title="Domain Name System">DNS</abbr>-forwarder and <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>-server.
It is designed to provide <abbr title="Domain Name System">DNS</abbr> and, optionally, <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>, to a small network.
It can serve the names of local machines which are not in the global <abbr title="Domain Name System">DNS</abbr>.
The <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>-server integrates with the <abbr title="Domain Name System">DNS</abbr> server and allows machines with <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>-allocated addresses to appear in the <abbr title="Domain Name System">DNS</abbr> with names configured either in each host or in a central configuration file.
Dnsmasq supports static and dynamic <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> leases and BOOTP for network booting of disk-less machines.
It is already installed and preconfigured on OpenWrt.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Dnsmasq DHCP server&quot;,&quot;hid&quot;:&quot;dnsmasq_dhcp_server&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-614&quot;} -->
<h2 class="sectionedit2" id="configuration">Configuration</h2>
<div class="level2">

<p>
The configuration is done with help of the uci-configuration file: <code>/etc/config/dhcp</code>, but you can use this together with the file <code>/etc/dnsmasq.conf</code>.
</p>

<p>
Depending on the setting in the uci-file, you may also use the files <code>/etc/ethers</code> and <code>/etc/hosts</code> additionally.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuration&quot;,&quot;hid&quot;:&quot;configuration&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;615-916&quot;} -->
<h3 class="sectionedit3" id="etcconfigdhcp">/etc/config/dhcp</h3>
<div class="level3">

<p>
→ <a href="/docs/guide-user/base-system/dhcp" class="wikilink1" title="docs:guide-user:base-system:dhcp" data-wiki-id="docs:guide-user:base-system:dhcp">/etc/config/dhcp</a> is a UCI configuration file and as such documented exclusively in <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">uci</a>.
Almost all settings can be configured with it!
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\/etc\/config\/dhcp&quot;,&quot;hid&quot;:&quot;etcconfigdhcp&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;917-1151&quot;} -->
<h3 class="sectionedit4" id="etcdnsmasqconf">/etc/dnsmasq.conf</h3>
<div class="level3">

<p>
It is possible to mix the traditional <code>/etc/dnsmasq.conf</code> configuration file with the options found in <code>/etc/config/dhcp</code>.
</p>

<p>
The <code>dnsmasq.conf</code> file does not exist by default but will be processed by dnsmasq on startup if it is present.
Note that options in <code>/etc/config/dhcp</code> take precendence over <code>dnsmasq.conf</code> since they are translated to command line arguments.
</p>

<p>
Example:
By default, Dnsmasq comes configured to put your hosts into the <code>.lan</code> domain.
This is specified in the configuration file as:
</p>
<pre class="code bash"><span class="co0"># allow /etc/hosts and dhcp lookups via *.lan</span>
<span class="re2">local</span>=<span class="sy0">/</span>lan<span class="sy0">/</span>
<span class="re2">domain</span>=lan</pre>

<p>
You can change this to whatever you&#039;d like your home domain to be.
Also, if you want your hosts to be available via your home domain without having to specify the domain in your <code>/etc/hosts</code> file, add the <code>expand-hosts</code> directive to your <code>/etc/dnsmasq.conf</code> file.
</p>

<p>
As an example, without <code>expand-hosts</code>, you can only reach <em>router, ubuntu-desktop and ubuntu-laptop</em>.
With <em>expand-hosts</em> on, you can reach <em>router, router.lan, ubuntu-desktop, ubuntu-desktop.lan, etc</em>.
This probably matches what you&#039;re looking for anyway.
</p>

<p>
Without this setting, you&#039;ll have to add <em>.lan</em> entries to your <code>/etc/hosts</code>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\/etc\/dnsmasq.conf&quot;,&quot;hid&quot;:&quot;etcdnsmasqconf&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;1152-2405&quot;} -->
<h3 class="sectionedit5" id="etcethers">/etc/ethers</h3>
<div class="level3">

<p>
In <code>/etc/ethers</code> static lease entries can be assigned.
See → <a href="/docs/guide-user/base-system/dhcp#static_leases" class="wikilink1" title="docs:guide-user:base-system:dhcp" data-wiki-id="docs:guide-user:base-system:dhcp">static_leases</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\/etc\/ethers&quot;,&quot;hid&quot;:&quot;etcethers&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:5,&quot;range&quot;:&quot;2406-2544&quot;} -->
<h3 class="sectionedit6" id="etchosts">/etc/hosts</h3>
<div class="level3">

<p>
In <code>/etc/hosts</code> <abbr title="Domain Name System">DNS</abbr> entries are configured.
Dnsmasq will utilize these entries to answer <abbr title="Domain Name System">DNS</abbr> queries on your network.
</p>

<p>
Format:
</p>
<pre class="code bash"><span class="br0">&#91;</span>IP_address<span class="br0">&#93;</span> host_name host_name_short ...</pre>

<p>
Example:
</p>
<pre class="code bash">192.168.1.1 router OpenWrt localhost
192.168.1.2 debian-server
192.168.1.3 ubuntu-laptop</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\/etc\/hosts&quot;,&quot;hid&quot;:&quot;etchosts&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:6,&quot;range&quot;:&quot;2545-2879&quot;} -->
<h2 class="sectionedit7" id="troubleshooting">Troubleshooting</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:7,&quot;range&quot;:&quot;2880-2907&quot;} -->
<h3 class="sectionedit8" id="dhcp_response_missing_due_to_network_overload">DHCP response missing due to network overload</h3>
<div class="level3">

<p>
Sometimes when an interface is on the edge of the capacity (especially WiFi over longer distances) a <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> request could be not replied in time.
Therefore the <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> client will not be able to receive proper network settings.
A possible workaround is using static IPs or very long <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> leases (more than 12h).
This is particularly important when one has several WiFi repeaters that use <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> and are distant from each other or not easily accessible.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;DHCP response missing due to network overload&quot;,&quot;hid&quot;:&quot;dhcp_response_missing_due_to_network_overload&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:8,&quot;range&quot;:&quot;2908-3410&quot;} -->
<h3 class="sectionedit9" id="log_spammed_with_dhcpinformdhcpack">Log spammed with DHCPINFORM/DHCPACK</h3>
<div class="level3">

<p>
Windows 7 among others ask for proxy settings using <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>.
The issue is that they do not stop asking until they have received an answer.
This results in that the log contains a lot information about these requests, an example can be found below (thanks to <a href="http://wiki.excito.com/w/index.php?title=Stop_DHCP_INFORM_flooding" class="urlextern" title="http://wiki.excito.com/w/index.php?title=Stop_DHCP_INFORM_flooding" rel="ugc nofollow">the excito wiki</a> for the info).
</p>

<p>
Solution:
</p>
<pre class="code bash">uci add_list dhcp.lan.dhcp_option=<span class="st_h">'252,&quot;\n&quot;'</span>
uci commit dhcp
service dnsmasq restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Log spammed with DHCPINFORM\/DHCPACK&quot;,&quot;hid&quot;:&quot;log_spammed_with_dhcpinformdhcpack&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:9,&quot;range&quot;:&quot;3411-3931&quot;} -->
<h3 class="sectionedit10" id="static_lease_issues">Static lease issues</h3>
<div class="level3">

<p>
Windows 7 has introduced a new <a href="http://answers.microsoft.com/en-us/windows/forum/windows_7-networking/windows-7-refuses-dhcp-addresses-if-they-were/1b72b289-0f58-492f-afb8-e76c80a81f00" class="urlextern" title="http://answers.microsoft.com/en-us/windows/forum/windows_7-networking/windows-7-refuses-dhcp-addresses-if-they-were/1b72b289-0f58-492f-afb8-e76c80a81f00" rel="ugc nofollow">Microsoft-enhanced</a> feature.
It won&#039;t assign <abbr title="Internet Protocol">IP</abbr> address obtained from a <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> server to an interface, if the <abbr title="Internet Protocol">IP</abbr> was used before for another interface, even if that other interface is <strong>NOT</strong> active currently (i.e. cable disconnected).
This behaviour is unique and was not reported for older Windows versions, Mac <abbr title="Operating System">OS</abbr> nor Linux.
</p>

<p>
If you try configure MAC address hot swap on your router, Windows 7 clients will end up in an infinite <a href="http://tools.ietf.org/html/rfc1531#section-3.1" class="urlextern" title="http://tools.ietf.org/html/rfc1531#section-3.1" rel="ugc nofollow">DORA</a> loop.
</p>

<p>
Solution:
</p>
<ol>
<li class="level1 node"><div class="li"> Create a <a href="https://www.google.com/search?q=windows%207%20create%20bridge" class="interwiki iw_google" title="https://www.google.com/search?q=windows%207%20create%20bridge">bridge</a> from the wireless and ethernet interfaces on your client</div>
<ul>
<li class="level2"><div class="li"> Add the MAC address of the bridge to <code>/etc/config/dhcp</code></div>
</li>
<li class="level2"><div class="li"> Since the bridge will probably take and alter your ethernet MAC address, you will lose SLAAC on wifi interface, making your laptop <abbr title="Internet Protocol version 6">IPv6</abbr>-disabled when only wireless is up.</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> Another solution is <abbr title="Internet Protocol version 6">IPv6</abbr> friendly, you don&#039;t need to create a bridge, nor add MAC address to dnsmasq config file, but it involves user interaction:</div>
<ul>
<li class="level2"><div class="li"> When you plug the ethernet cable in, disable wireless interface in control panel (power off wireless won&#039;t do it).</div>
</li>
<li class="level2"><div class="li"> When you unplug ethernet cable, enable wireless and disable ethernet.</div>
</li>
</ul>
</li>
</ol>
<pre class="code bash">uci add dhcp host
uci <span class="kw1">set</span>	dhcp.<span class="sy0">@</span>host<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.name=<span class="st0">&quot;example-host&quot;</span>
uci <span class="kw1">set</span>	dhcp.<span class="sy0">@</span>host<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.ip=<span class="st0">&quot;192.168.1.230&quot;</span>
uci <span class="kw1">set</span>	dhcp.<span class="sy0">@</span>host<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.mac=<span class="st0">&quot;00:a0:24:5a:33:69 00:11:22:33:44:55 02:a0:24:5a:33:69 02:11:22:33:44:55&quot;</span>
uci commit dhcp
service dnsmasq restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Static lease issues&quot;,&quot;hid&quot;:&quot;static_lease_issues&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:10,&quot;range&quot;:&quot;3932-5619&quot;} -->
<h3 class="sectionedit11" id="adguard_dns_and_dnsmasq_issues">Adguard DNS and dnsmasq issues</h3>
<div class="level3">

<p>
If you use Adguard <abbr title="Domain Name System">DNS</abbr> as forwarder (to have a cheap and efficient network adblocker), 
you need to disable Rebind protection, to avoid lag or site unreachable due to Rebin protection.
</p>

<p>
If not, you can see lot of this log in system.log, and have lag or host unreachable issue.
</p>
<pre class="code bash">daemon.warn dnsmasq<span class="br0">&#91;</span>xxx<span class="br0">&#93;</span>: possible DNS-rebind attack detected: any.adserver.dns</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Adguard DNS and dnsmasq issues&quot;,&quot;hid&quot;:&quot;adguard_dns_and_dnsmasq_issues&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:11,&quot;range&quot;:&quot;5620-6039&quot;} -->
<h2 class="sectionedit12" id="notes">Notes</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Project Homepage: <a href="http://thekelleys.org.uk/dnsmasq/doc.html" class="urlextern" title="http://thekelleys.org.uk/dnsmasq/doc.html" rel="ugc nofollow">http://thekelleys.org.uk/dnsmasq/doc.html</a></div>
</li>
<li class="level1"><div class="li"> Tutorial <a href="http://www.enterprisenetworkingplanet.com/netos/article.php/3377351" class="urlextern" title="http://www.enterprisenetworkingplanet.com/netos/article.php/3377351" rel="ugc nofollow">http://www.enterprisenetworkingplanet.com/netos/article.php/3377351</a></div>
</li>
<li class="level1"><div class="li"> Tutorial <a href="http://martybugs.net/wireless/openwrt/dnsmasq.cgi" class="urlextern" title="http://martybugs.net/wireless/openwrt/dnsmasq.cgi" rel="ugc nofollow">http://martybugs.net/wireless/openwrt/dnsmasq.cgi</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Notes&quot;,&quot;hid&quot;:&quot;notes&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:12,&quot;range&quot;:&quot;6040-&quot;} -->