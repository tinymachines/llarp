
<h1 class="sectionedit1" id="prosody_xmpp_server_open_messaging_protocol">Prosody XMPP Server (open messaging protocol)</h1>
<div class="level1">

<p>
<strong>Prosody</strong> writen in Lua and small enough for routers and easy to configure.
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://prosody.im/" class="urlextern" title="https://prosody.im/" rel="ugc nofollow">Homepage</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://prosody.im/doc/configure" class="urlextern" title="https://prosody.im/doc/configure" rel="ugc nofollow">Documentation</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://wiki.archlinux.org/title/Prosody" class="urlextern" title="https://wiki.archlinux.org/title/Prosody" rel="ugc nofollow">Wiki from Arch Linux</a> </div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Prosody XMPP Server (open messaging protocol)&quot;,&quot;hid&quot;:&quot;prosody_xmpp_server_open_messaging_protocol&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-302&quot;} -->
<h2 class="sectionedit2" id="install">Install</h2>
<div class="level2">
<pre class="code bash">opkg update
opkg <span class="kw2">install</span> prosody</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Install&quot;,&quot;hid&quot;:&quot;install&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;303-378&quot;} -->
<h2 class="sectionedit3" id="show_me_it_working_asap">Show me it working ASAP</h2>
<div class="level2">

<p>
Faster way is allowing auto-registration to @localhost.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Show me it working ASAP&quot;,&quot;hid&quot;:&quot;show_me_it_working_asap&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:3,&quot;range&quot;:&quot;379-471&quot;} -->
<h3 class="sectionedit4" id="allow_registration">allow_registration</h3>
<div class="level3">
<pre class="code bash"><span class="kw2">sed</span> <span class="re5">-i</span> <span class="re5">-e</span> <span class="st_h">'s/\(allow_registration = \)false;/\1true;/'</span> <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>prosody.cfg.lua
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>prosody restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;allow_registration&quot;,&quot;hid&quot;:&quot;allow_registration&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:4,&quot;range&quot;:&quot;472-634&quot;} -->
<h3 class="sectionedit5" id="xmpp_client">XMPP client</h3>
<div class="level3">

<p>
Use a XMPP client to add an account to 192.168.1.1 server like:
</p>
<ul>
<li class="level1"><div class="li"><a href="https://pidgin.im/install/" class="urlextern" title="https://pidgin.im/install/" rel="ugc nofollow">Pidgin</a> for Windows, Linux &amp; Mac <abbr title="Operating System">OS</abbr> X</div>
</li>
<li class="level1"><div class="li"><a href="https://conversations.im/" class="urlextern" title="https://conversations.im/" rel="ugc nofollow">Conversations</a> for Android</div>
</li>
<li class="level1"><div class="li"><a href="https://xmpp.org/software/" class="urlextern" title="https://xmpp.org/software/" rel="ugc nofollow">List of all clients</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;XMPP client&quot;,&quot;hid&quot;:&quot;xmpp_client&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:5,&quot;range&quot;:&quot;635-906&quot;} -->
<h3 class="sectionedit6" id="the_right_way">The right way?</h3>
<div class="level3">

<p>
Batch add users with the same password:
</p>
<pre class="code bash"><span class="kw1">for</span> f <span class="kw1">in</span> almursi jow maddes nilfred orca thelexi
<span class="kw1">do</span> prosodyctl register <span class="re1">$f</span> localhost pasword123
<span class="kw1">done</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;The right way?&quot;,&quot;hid&quot;:&quot;the_right_way&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:6,&quot;range&quot;:&quot;907-1093&quot;} -->
<h3 class="sectionedit7" id="not_so_easy">Not so easy</h3>
<div class="level3">

<p>
All users see all others registered users by default.
</p>
<pre class="code bash"><span class="co0"># A roster for everyone</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="re5">-m</span> <span class="nu0">775</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>roster
<span class="kw3">cd</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>roster
<span class="co0"># Make a list</span>
<span class="kw3">echo</span> <span class="st0">&quot;acoul
almursi
glp
hauke
jow
juhosg
maddes
nbd
nilfred
orca
thelexi&quot;</span> <span class="sy0">&gt;</span> lista.txt
<span class="kw1">for</span> f <span class="kw1">in</span> $<span class="br0">&#40;</span><span class="kw2">awk</span> <span class="st_h">'{print $1}'</span> lista.txt<span class="br0">&#41;</span>
<span class="co0"># Register</span>
<span class="kw1">do</span> prosodyctl register <span class="re1">$f</span> localhost <span class="nu0">123</span>
<span class="co0"># Add to group &quot;Familiares&quot; all others, but not self.</span>
<span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;/<span class="es2">$f</span>/ d&quot;</span> lista.txt <span class="sy0">|</span> <span class="kw2">awk</span> <span class="st_h">'BEGIN {print &quot;return {\n\t[false] = {\n\t\t[\&quot;version\&quot;] = 5;\n\t};\n\t[\&quot;pending\&quot;] = {};&quot;} {print &quot;\t[\&quot;&quot; $1 &quot;@localhost\&quot;] = {\n\t\t[\&quot;groups\&quot;] = {\n\t\t\t[\&quot;Familiares\&quot;] = true;\n\t\t};\n\t\t[\&quot;subscription\&quot;] = \&quot;both\&quot;;\n\t\t[\&quot;name\&quot;] = \&quot;&quot; toupper(substr($1, 1, 1)) substr($1, 2) &quot;\&quot;;\n\t};&quot;} END {print &quot;}&quot;}'</span> <span class="sy0">&gt;</span> <span class="re1">$f</span>.dat
<span class="kw1">done</span>
<span class="kw2">chmod</span> <span class="nu0">666</span> <span class="sy0">*</span>.dat
<span class="co0"># Move to flash at once</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="re5">-m</span> <span class="nu0">775</span> <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>data<span class="sy0">/</span>localhost<span class="sy0">/</span>roster
<span class="kw2">chown</span> prosody:prosody <span class="sy0">*</span>.dat . <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>data<span class="sy0">/</span>localhost<span class="sy0">/</span>roster
<span class="kw2">mv</span> <span class="sy0">*</span>.dat <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>data<span class="sy0">/</span>localhost<span class="sy0">/</span>roster<span class="sy0">/</span></pre>

<p>
The sausage do:
</p>
<ul>
<li class="level1"><div class="li">Remove the self name from the list</div>
</li>
<li class="level1"><div class="li">Print a head</div>
</li>
<li class="level1 node"><div class="li">Print a paragraph to each other with</div>
<ul>
<li class="level2"><div class="li">name@localhost</div>
</li>
<li class="level2"><div class="li">groups: Familiares</div>
</li>
<li class="level2"><div class="li">Nickname with first letter capitalized</div>
</li>
</ul>
</li>
<li class="level1"><div class="li">Print a tail to a file</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Not so easy&quot;,&quot;hid&quot;:&quot;not_so_easy&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:7,&quot;range&quot;:&quot;1094-2294&quot;} -->
<h2 class="sectionedit8" id="using_your_ddns_domain">Using your DDNS domain</h2>
<div class="level2">

<p>
This example requires you to get a example.no-ip.biz domain and install luci-app-ddns. Then is exactly the same as @localhost:
</p>
<pre class="code bash"><span class="co0"># Allow registration?</span>
<span class="kw2">sed</span> <span class="re5">-i</span> <span class="re5">-e</span> <span class="st_h">'s/\(allow_registration = \)false;/\1true;/'</span> <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>prosody.cfg.lua
<span class="kw2">chmod</span> +r <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>prosody.cfg.lua
<span class="co0"># Start once to create the prosody:prosody account</span>
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>prosody start
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>prosody stop
<span class="kw2">chown</span> <span class="re5">-R</span> prosody:prosody <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>data
<span class="kw2">sed</span> <span class="re5">-i</span> <span class="re5">-e</span> <span class="st_h">'s/example.com/example.no-ip.biz/;/enabled = false/ d'</span> <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>prosody.cfg.lua
<span class="co0"># A roster for everyone</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="re5">-m</span> <span class="nu0">775</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>roster
<span class="kw3">cd</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>roster
<span class="co0"># Make a list</span>
<span class="kw3">echo</span> <span class="st0">&quot;acoul
almursi
glp
hauke
jow
juhosg
maddes
nbd
nilfred
orca
thelexi&quot;</span> <span class="sy0">&gt;</span> lista.txt
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="re5">-m</span> <span class="nu0">775</span> <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>data<span class="sy0">/</span>example.no-ip.biz<span class="sy0">/</span>roster
<span class="kw2">chown</span> <span class="re5">-R</span> prosody:prosody <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>data
<span class="kw1">for</span> f <span class="kw1">in</span> $<span class="br0">&#40;</span><span class="kw2">awk</span> <span class="st_h">'{print $1}'</span> lista.txt<span class="br0">&#41;</span>
<span class="kw1">do</span> prosodyctl register <span class="re1">$f</span> example.no-ip.biz <span class="nu0">123</span>
<span class="kw2">sed</span> <span class="re5">-e</span> <span class="st0">&quot;/<span class="es2">$f</span>/ d&quot;</span> lista.txt <span class="sy0">|</span> <span class="kw2">awk</span> <span class="st_h">'BEGIN {print &quot;return {\n\t[false] = {\n\t\t[\&quot;version\&quot;] = 1;\n\t};\n\t[\&quot;pending\&quot;] = {};&quot;} {print &quot;\t[\&quot;&quot; $1 &quot;@example.no-ip.biz\&quot;] = {\n\t\t[\&quot;groups\&quot;] = {\n\t\t\t[\&quot;Familiares\&quot;] = true;\n\t\t};\n\t\t[\&quot;subscription\&quot;] = \&quot;both\&quot;;\n\t\t[\&quot;name\&quot;] = \&quot;&quot; toupper(substr($1, 1, 1)) substr($1, 2) &quot;\&quot;;\n\t};&quot;} END {print &quot;}&quot;}'</span> <span class="sy0">&gt;</span> <span class="re1">$f</span>.dat
<span class="kw1">done</span>
<span class="kw2">chmod</span> <span class="nu0">666</span> <span class="sy0">*</span>.dat
<span class="kw2">chown</span> prosody:prosody <span class="sy0">*</span>.dat .
<span class="kw2">mv</span> <span class="sy0">*</span>.dat <span class="sy0">/</span>etc<span class="sy0">/</span>prosody<span class="sy0">/</span>data<span class="sy0">/</span>example.no-ip.biz<span class="sy0">/</span>roster<span class="sy0">/</span>
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>prosody start
<span class="co0"># All OK?</span>
<span class="kw2">cat</span> <span class="sy0">/</span>var<span class="sy0">/</span>log<span class="sy0">/</span>prosody<span class="sy0">/</span>prosody.err
<span class="kw2">cat</span> <span class="sy0">/</span>var<span class="sy0">/</span>log<span class="sy0">/</span>prosody<span class="sy0">/</span>prosody.log</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Using your DDNS domain&quot;,&quot;hid&quot;:&quot;using_your_ddns_domain&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:8,&quot;range&quot;:&quot;2295-3793&quot;} -->
<h3 class="sectionedit9" id="set_your_router_a_ddns_name">Set your router a DDNS name</h3>
<div class="level3">

<p>
After reading how to setup <a href="/docs/guide-user/services/ddns/client" class="wikilink1" title="docs:guide-user:services:ddns:client" data-wiki-id="docs:guide-user:services:ddns:client">DDNS client</a>, you should end with something like this working configuration:
</p>
<pre class="code bash">uci batch <span class="co2">&lt;&lt;'EOF'
set ddns.myddns.domain=example.no-ip.biz
set ddns.myddns.enabled=0
set ddns.myddns.force_interval=22
set ddns.myddns.ip_interface=pppoe-wan
set ddns.myddns.ip_source=interface
delete ddns.myddns.ip_url
set ddns.myddns.password=password
set ddns.myddns.service_name=no-ip.com
set ddns.myddns.username=username
commit ddns
EOF</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Set your router a DDNS name&quot;,&quot;hid&quot;:&quot;set_your_router_a_ddns_name&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:9,&quot;range&quot;:&quot;3794-4339&quot;} -->
<h3 class="sectionedit10" id="set_your_router_the_same_lan_name_as_wan">Set your router the same LAN name as WAN</h3>
<div class="level3">

<p>
It would be wise if your router has the same name for <abbr title="Local Area Network">LAN</abbr> clients, so has to not go out and redirected back.
</p>
<pre class="code bash">uci batch <span class="co2">&lt;&lt;'EOF'
add dhcp domain
set dhcp.@domain[-1].ip=192.168.1.1
set dhcp.@domain[-1].name=tplinklogin.net
add dhcp domain
set dhcp.@domain[-1].ip=192.168.1.1
set dhcp.@domain[-1].name=routerlogin.net
add dhcp domain
set dhcp.@domain[-1].ip=192.168.1.1
set dhcp.@domain[-1].name=example.no-ip.biz
commit dhcp
EOF</span></pre>

<p>
Now these commands have the same effect in your <abbr title="Local Area Network">LAN</abbr>:
</p>
<pre class="code bash"><span class="kw2">ssh</span> root<span class="sy0">@</span>192.168.1.1
<span class="kw2">ssh</span> root<span class="sy0">@</span>routerlogin.net
<span class="kw2">ssh</span> root<span class="sy0">@</span>tplinklogin.net
<span class="kw2">ssh</span> root<span class="sy0">@</span>example.no-ip.biz</pre>

<p>
Your router now has a name!
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Set your router the same LAN name as WAN&quot;,&quot;hid&quot;:&quot;set_your_router_the_same_lan_name_as_wan&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:10,&quot;range&quot;:&quot;4340-5038&quot;} -->
<h3 class="sectionedit11" id="set_your_own_domain_name_srv_records">Set your own domain name SRV records</h3>
<div class="level3">

<p>
Very well! So, for your own domain name may need to setup SRV records if the xmpp server run in another subdomain like this:
</p>
<pre class="code">_xmpp-client._tcp.example.com. 18000 IN SRV 0 5 5222 xmpp.example.com.
_xmpp-server._tcp.example.com. 18000 IN SRV 0 5 5269 xmpp.example.com. </pre>

<p>
Translated to uci will look like this:
</p>
<pre class="code bash">uci batch <span class="co2">&lt;&lt;'EOF'
add dhcp srvhost
set dhcp.@srvhost[-1].srv=_xmpp-client._tcp.example.com
set dhcp.@srvhost[-1].target=xmpp.example.com
set dhcp.@srvhost[-1].port=5222
set dhcp.@srvhost[-1].class=0
set dhcp.@srvhost[-1].weight=5
add dhcp srvhost
set dhcp.@srvhost[-1].srv=_xmpp-server._tcp.example.com
set dhcp.@srvhost[-1].target=xmpp.example.com
set dhcp.@srvhost[-1].port=5269
set dhcp.@srvhost[-1].class=0
set dhcp.@srvhost[-1].weight=5
commit dhcp
EOF</span></pre>

<p>
This <abbr title="Domain Name System">DNS</abbr> trick is for someone@xmpp.example.com looks like someone@example.com, but also for fancy names like this full picture:
</p>
<pre class="code"># A record
your-server.EXAMPLE.COM                     IN A            1.2.3.4        # this *must* be an A record and not a CNAME
 
# CNAME records
anon.EXAMPLE.COM                          IN CNAME        your-server.EXAMPLE.COM. # this is what the anonymous binding (non-logged in web users) will connect to
topics.EXAMPLE.COM                        IN CNAME        your-server.EXAMPLE.COM. # to enable channels like food@topics.EXAMPLE.COM
 
# SRV records
_xmpp-client._tcp.EXAMPLE.COM.            IN SRV 5 0 5222 your-server.EXAMPLE.COM.
_xmpp-server._tcp.EXAMPLE.COM.            IN SRV 5 0 5269 your-server.EXAMPLE.COM.
_xmpp-server._tcp.anon.EXAMPLE.COM        IN SRV 5 0 5269 your-server.EXAMPLE.COM.
_xmpp-server._tcp.topics.EXAMPLE.COM      IN SRV 5 0 5269 your-server.EXAMPLE.COM. </pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Set your own domain name SRV records&quot;,&quot;hid&quot;:&quot;set_your_own_domain_name_srv_records&quot;,&quot;codeblockOffset&quot;:8,&quot;secid&quot;:11,&quot;range&quot;:&quot;5039-&quot;} -->