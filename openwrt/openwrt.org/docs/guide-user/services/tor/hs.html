
<h1 class="sectionedit1" id="tor_onion_services">Tor onion services</h1>
<div class="level1">

<p>
You can enable a remote access tunnel to your device over the Tor network and use it for <abbr title="Secure Shell">SSH</abbr> or to serve a web site.
This is often used not only for privacy but also just a method of <abbr title="Network Address Translation">NAT</abbr> traversal to a device that doesn&#039;t have a static <abbr title="Internet Protocol">IP</abbr>.
You can create your own <code>.onion</code> domain for free but it will be accessible only with the Tor Browser or via Tor SOCKS proxy.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Tor onion services&quot;,&quot;hid&quot;:&quot;tor_onion_services&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-401&quot;} -->
<h2 class="sectionedit2" id="introduction">Introduction</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="https://community.torproject.org/onion-services/overview/" class="urlextern" title="https://community.torproject.org/onion-services/overview/" rel="ugc nofollow">How do Onion Services work</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://community.torproject.org/onion-services/setup/" class="urlextern" title="https://community.torproject.org/onion-services/setup/" rel="ugc nofollow">How to set up an onion service</a> to share your local services with the Tor world.</div>
</li>
<li class="level1"><div class="li"> <a href="https://forum.torproject.net/c/support/onion-services/16" class="urlextern" title="https://forum.torproject.net/c/support/onion-services/16" rel="ugc nofollow">Tor Support Portal</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;402-747&quot;} -->
<h2 class="sectionedit3" id="tor_hs_configurator">Tor HS configurator</h2>
<div class="level2">

<p>
The <a href="/packages/pkgdata/tor-hs" class="wikilink1" title="packages:pkgdata:tor-hs" data-wiki-id="packages:pkgdata:tor-hs">tor-hs</a> package provides the Tor hidden service configurator that tries to simplify creation of hidden services on OpenWrt routers.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Tor HS configurator&quot;,&quot;hid&quot;:&quot;tor_hs_configurator&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;748-936&quot;} -->
<h3 class="sectionedit4" id="installation">Installation</h3>
<div class="level3">

<p>
To install the package with LUCI: in main menu select <code>System</code> / <code>Software</code>.
Press <code>Update lists..</code> and then type into Filter field <code>tor-hs</code>.
</p>

<p>
Or run in terminal:
</p>
<pre class="code">opkg update
opkg install tor-hs</pre>

<p>
There is a LUCI app luci-app-tor that provides a <abbr title="Graphical User Interface">GUI</abbr> for the <code>tor-hs</code>. You may install it with <code>opkg install luci-app-tor</code>. It may be not yet available in the main packages feed.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation&quot;,&quot;hid&quot;:&quot;installation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;937-1363&quot;} -->
<h3 class="sectionedit5" id="hidden_service_configuration">Hidden service configuration</h3>
<div class="level3">

<p>
UCI configuration is located in <code>/etc/config/tor-hs</code>.
You have to edit and adjust from terminal with <code>vi /etc/config/tor-hs</code>.
If you want to create a new hidden service, you have to add a hidden-service section.
For every hidden service, there should be a new <code>hidden-service</code> section.
</p>

<p>
Example of hidden service section for <abbr title="Secure Shell">SSH</abbr> server:
</p>
<pre class="code bash">config hidden-service
	option Name <span class="st_h">'sshd'</span>
	option Description <span class="st_h">'Hidden service for SSH'</span>
	option Enabled <span class="st_h">'false'</span>
	option IPv4 <span class="st_h">'127.0.0.1'</span>
	list PublicLocalPort <span class="st_h">'2222;22'</span></pre>
<div class="table sectionedit6"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Name </th><th class="col1"> Example value </th><th class="col2"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>Name</code> </td><td class="col1"> <code>sshd</code> </td><td class="col2"> Name of hidden service. It is used as directory name in <code>HSDir</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>Description</code> </td><td class="col1"> <code>Hidden service for ssh</code> </td><td class="col2"> Description used in <code>rpcd</code> service </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>Enabled</code> </td><td class="col1"> <code>false</code> </td><td class="col2"> Enable hidden service after running <code>tor-hs</code> init script </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code><abbr title="Internet Protocol version 4">IPv4</abbr></code> </td><td class="col1"> <code>127.0.0.1</code> </td><td class="col2"> Local <abbr title="Internet Protocol version 4">IPv4</abbr> address of service. Service could run on another device, in that case OpenWrt will redirect communication. </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <code>PublicLocalPort</code> </td><td class="col1"> <code>2222;22</code> </td><td class="col2"> List of public ports accessible via Tor network. Local port is normal port of service. </td>
	</tr>
	<tr class="row6">
		<td class="col0"> <code>HookScript</code> </td><td class="col1"> <code>/etc/tor/nextcloud-update.php</code> </td><td class="col2"> Path to script which is executed after starting tor-hs. Script is executed with parameters <code>--update-onion hostname</code>. The hostname is replaced with Onion v3 address for given hidden service. </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:6,&quot;range&quot;:&quot;1936-2769&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Hidden service configuration&quot;,&quot;hid&quot;:&quot;hidden_service_configuration&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:5,&quot;range&quot;:&quot;1364-2770&quot;} -->
<h3 class="sectionedit7" id="required_section_of_configuration">Required section of configuration</h3>
<div class="level3">

<p>
There is one required section common.
Example:
</p>
<pre class="code bash">config tor-hs common
	option GenConf <span class="st0">&quot;/etc/tor/torrc_hs&quot;</span>
	option HSDir <span class="st0">&quot;/etc/tor/hidden_service&quot;</span>
	option RestartTor <span class="st0">&quot;true&quot;</span>
	option UpdateTorConf <span class="st0">&quot;true&quot;</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Required section of configuration&quot;,&quot;hid&quot;:&quot;required_section_of_configuration&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:7,&quot;range&quot;:&quot;2771-3035&quot;} -->
<h3 class="sectionedit8" id="options_description">Options description</h3>
<div class="level3">
<div class="table sectionedit9"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> Name  </th><th class="col1"> Default </th><th class="col2"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>GenConf</code> </td><td class="col1"> <code>/etc/tor/torrc_generated</code> </td><td class="col2"> Generated config by tor-hs. </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>HSDir</code> </td><td class="col1"> <code>/etc/tor/hidden_service</code> </td><td class="col2"> Directory with meta-data for hidden services (hostname, keys, etc). </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>RestartTor</code> </td><td class="col1"> <code>true</code> </td><td class="col2"> It will restart tor after running starting the <code>tor-hs</code> service. </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code>UpdateTorConf</code> </td><td class="col1"> <code>true</code> </td><td class="col2"> Update <code>/etc/config/tor</code> with config from <code>GenConf</code> option. </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table1&quot;,&quot;secid&quot;:9,&quot;range&quot;:&quot;3066-3488&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Options description&quot;,&quot;hid&quot;:&quot;options_description&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:8,&quot;range&quot;:&quot;3036-3489&quot;} -->
<h3 class="sectionedit10" id="setup_from_command_line">Setup from command line</h3>
<div class="level3">

<p>
Allow remote access to the router with onion services.
It&#039;s recommended to enable <a href="/docs/guide-user/services/tor/extras#client_authorization" class="wikilink1" title="docs:guide-user:services:tor:extras" data-wiki-id="docs:guide-user:services:tor:extras">client authorization</a>.
</p>
<pre class="code bash"><span class="co0"># Configure Tor onion service</span>
uci <span class="re5">-q</span> delete tor-hs.ssh
uci <span class="kw1">set</span> tor-hs.ssh=<span class="st0">&quot;hidden-service&quot;</span>
uci <span class="kw1">set</span> tor-hs.ssh.Name=<span class="st0">&quot;ssh&quot;</span>
uci <span class="kw1">set</span> tor-hs.ssh.Enabled=<span class="st0">&quot;1&quot;</span>
uci <span class="kw1">set</span> tor-hs.ssh.IPv4=<span class="st0">&quot;127.0.0.1&quot;</span>
uci add_list tor-hs.ssh.PublicLocalPort=<span class="st0">&quot;22;22&quot;</span>
uci commit tor-hs
service tor-hs restart
&nbsp;
<span class="co0"># Fetch onion service hostname</span>
<span class="kw2">cat</span> <span class="sy0">/</span>etc<span class="sy0">/</span>tor<span class="sy0">/</span>hidden_service<span class="sy0">/</span>ssh<span class="sy0">/</span><span class="kw2">hostname</span></pre>

<p>
Access the onion service from Tor client.
</p>
<pre class="code bash"><span class="co0"># Install packages</span>
opkg update
opkg <span class="kw2">install</span> torsocks
&nbsp;
<span class="co0"># Access onion service</span>
torsocks <span class="kw2">ssh</span> <span class="co1">${TOR_HOST}</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Setup from command line&quot;,&quot;hid&quot;:&quot;setup_from_command_line&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:10,&quot;range&quot;:&quot;3490-4226&quot;} -->
<h3 class="sectionedit11" id="client_authorization">Client authorization</h3>
<div class="level3">

<p>
You can secure access to onion services with <a href="https://community.torproject.org/onion-services/advanced/client-auth/" class="urlextern" title="https://community.torproject.org/onion-services/advanced/client-auth/" rel="ugc nofollow">client authorization</a>.
</p>
<pre class="code bash"><span class="co0"># Install packages</span>
opkg update
opkg <span class="kw2">install</span> openssl-util coreutils-base32
&nbsp;
<span class="co0"># Enable client authorization</span>
openssl genpkey <span class="re5">-algorithm</span> x25519 <span class="re5">-out</span> <span class="sy0">/</span>etc<span class="sy0">/</span>tor<span class="sy0">/</span>hidden_service.pem
<span class="re2">TOR_KEY</span>=<span class="st0">&quot;$(openssl pkey -in /etc/tor/hidden_service.pem -outform der <span class="es1">\
</span>| tail -c 32 <span class="es1">\
</span>| base32 <span class="es1">\
</span>| sed -e &quot;</span>s<span class="sy0">/</span>=<span class="sy0">//</span>g<span class="st0">&quot;)&quot;</span>
<span class="re2">TOR_PUB</span>=<span class="st0">&quot;$(openssl pkey -in /etc/tor/hidden_service.pem -outform der -pubout <span class="es1">\
</span>| tail -c 32 <span class="es1">\
</span>| base32 <span class="es1">\
</span>| sed -e &quot;</span>s<span class="sy0">/</span>=<span class="sy0">//</span>g<span class="st0">&quot;)&quot;</span>
<span class="re2">TOR_HOST</span>=<span class="st0">&quot;<span class="es4">$(cat /etc/tor/hidden_service/ssh/hostname)</span>&quot;</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;</span> client.auth_private
<span class="co1">${TOR_HOST%.onion}</span>:descriptor:x25519:<span class="co1">${TOR_KEY}</span>
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>tor<span class="sy0">/</span>hidden_service<span class="sy0">/</span>ssh<span class="sy0">/</span>authorized_clients<span class="sy0">/</span>client.auth
descriptor:x25519:<span class="co1">${TOR_PUB}</span>
EOF
<span class="kw2">chown</span> <span class="re5">-R</span> tor:tor <span class="sy0">/</span>etc<span class="sy0">/</span>tor<span class="sy0">/</span>hidden_service
service tor restart</pre>

<p>
Configure authorization on the client using the private key.
</p>
<pre class="code bash"><span class="co0"># Configure client authorization</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>tor<span class="sy0">/</span>custom
ClientOnionAuthDir <span class="sy0">/</span>etc<span class="sy0">/</span>tor<span class="sy0">/</span>onion_auth
EOF
<span class="kw3">umask</span> <span class="re2">go</span>=
<span class="re2">TOR_AUTH</span>=<span class="st0">&quot;<span class="es4">$(cat client.auth_private)</span>&quot;</span>
<span class="re2">TOR_HOST</span>=<span class="st0">&quot;<span class="es3">${TOR_AUTH%%:*}</span>.onion&quot;</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>tor<span class="sy0">/</span>onion_auth
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>tor<span class="sy0">/</span>onion_auth<span class="sy0">/</span>client.auth_private
<span class="co1">${TOR_AUTH}</span>
EOF
<span class="kw2">chown</span> <span class="re5">-R</span> tor:tor <span class="sy0">/</span>etc<span class="sy0">/</span>tor<span class="sy0">/</span>onion_auth
service tor restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Client authorization&quot;,&quot;hid&quot;:&quot;client_authorization&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:11,&quot;range&quot;:&quot;4227-5565&quot;} -->
<h3 class="sectionedit12" id="running_service">Running service</h3>
<div class="level3">

<p>
To enable tor-hs service run:
</p>
<pre class="code bash">service tor-hs <span class="kw3">enable</span>
service tor-hs start</pre>

<p>
In case you enabled option <code>RestartTor</code> and <code>UpdateTorConf</code> hidden service should be running.
Otherwise, you should also restart tor daemon.
</p>
<pre class="code bash">service tor restart</pre>

<p>
After that you should also restart rpcd daemon, so you can use tor-hs RPCD service.
</p>
<pre class="code bash">service rpcd restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Running service&quot;,&quot;hid&quot;:&quot;running_service&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:12,&quot;range&quot;:&quot;5566-6000&quot;} -->
<h3 class="sectionedit13" id="rpcd">RPCD</h3>
<div class="level3">

<p>
The RPCD service helps users to access basic information about hidden services on the router.
After running HS, it contains an onion <abbr title="Uniform Resource Locator">URL</abbr> for a given hidden service in hostname value.
</p>
<pre class="code bash">$ ubus call tor-hs-rpc list-hs
<span class="br0">&#123;</span>
    <span class="st0">&quot;hs-list&quot;</span>: <span class="br0">&#91;</span>
        <span class="br0">&#123;</span>
            <span class="st0">&quot;name&quot;</span>: <span class="st0">&quot;sshd&quot;</span>,
            <span class="st0">&quot;description&quot;</span>: <span class="st0">&quot;Hidden service for SSH&quot;</span>,
            <span class="st0">&quot;enabled&quot;</span>: <span class="st0">&quot;1&quot;</span>,
            <span class="st0">&quot;ipv4&quot;</span>: <span class="st0">&quot;127.0.0.1&quot;</span>,
            <span class="st0">&quot;hostname&quot;</span>: <span class="st0">&quot;&lt;hidden-service-hostname&gt;.onion&quot;</span>,
            <span class="st0">&quot;ports&quot;</span>: <span class="br0">&#91;</span>
                <span class="st0">&quot;22;22&quot;</span>
            <span class="br0">&#93;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#93;</span>
<span class="br0">&#125;</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;RPCD&quot;,&quot;hid&quot;:&quot;rpcd&quot;,&quot;codeblockOffset&quot;:10,&quot;secid&quot;:13,&quot;range&quot;:&quot;6001-6560&quot;} -->
<h2 class="sectionedit14" id="client_authorization1">Client authorization</h2>
<div class="level2">

<p>
Secure access with <a href="https://community.torproject.org/onion-services/advanced/client-auth/" class="urlextern" title="https://community.torproject.org/onion-services/advanced/client-auth/" rel="ugc nofollow">client authorization</a>.
</p>
<ol>
<li class="level1"><div class="li"> Generate public-private key pair using instructions from <a href="https://community.torproject.org/onion-services/advanced/client-auth/" class="urlextern" title="https://community.torproject.org/onion-services/advanced/client-auth/" rel="ugc nofollow">Tor client authorization</a>.</div>
</li>
<li class="level1 node"><div class="li"> Place the generated public key in <code>&lt;HSDir&gt;/&lt;hidden-service.Name&gt;/authorized_clients/&lt;client-name&gt;.auth</code>.</div>
<ul>
<li class="level2"><div class="li"> For the example above (ssh server), and a client named <code>someone</code>, that will be <code>/etc/tor/hidden_service/sshd/authorized_clients/someone.auth</code>.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Use the private key in your browser when visiting the hidden service.</div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Client authorization&quot;,&quot;hid&quot;:&quot;client_authorization1&quot;,&quot;codeblockOffset&quot;:11,&quot;secid&quot;:14,&quot;range&quot;:&quot;6561-&quot;} -->