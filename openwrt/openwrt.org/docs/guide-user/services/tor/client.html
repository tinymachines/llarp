
<h1 class="sectionedit1" id="tor_client">Tor client</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Tor client&quot;,&quot;hid&quot;:&quot;tor_client&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-107&quot;} -->
<h2 class="sectionedit6" id="introduction">Introduction</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> This how-to describes the method for setting up <a href="https://en.wikipedia.org/wiki/Tor_(anonymity_network)" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Tor_(anonymity_network)">Tor</a> client on OpenWrt.</div>
</li>
<li class="level1"><div class="li"> Tor is limited to <abbr title="Domain Name System">DNS</abbr> and <abbr title="Transmission Control Protocol">TCP</abbr> traffic, use <a href="/docs/guide-user/services/vpn/start" class="wikilink1" title="docs:guide-user:services:vpn:start" data-wiki-id="docs:guide-user:services:vpn:start">VPN</a> to protect all traffic.</div>
</li>
<li class="level1"><div class="li"> Follow <a href="/docs/guide-user/services/tor/extras" class="wikilink1" title="docs:guide-user:services:tor:extras" data-wiki-id="docs:guide-user:services:tor:extras">Tor extras</a> for automated setup and additional tuning.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;108-458&quot;} -->
<h2 class="sectionedit7" id="goals">Goals</h2>
<div class="level2">
<ul>
<li class="level1 node"><div class="li"> Provide anonymous communication with onion routing.</div>
<ul>
<li class="level2"><div class="li"> Access the dark net and Tor hidden services.</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> Encrypt your internet connection to enforce security and privacy.</div>
<ul>
<li class="level2"><div class="li"> Prevent traffic leaks and spoofing on the client side.</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> Bypass regional restrictions using public relay providers.</div>
<ul>
<li class="level2"><div class="li"> Escape client side content filters and internet censorship.</div>
</li>
</ul>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Goals&quot;,&quot;hid&quot;:&quot;goals&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;459-844&quot;} -->
<h2 class="sectionedit8" id="command-line_instructions">Command-line instructions</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Command-line instructions&quot;,&quot;hid&quot;:&quot;command-line_instructions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;845-882&quot;} -->
<h3 class="sectionedit9" id="tor_client1">1. Tor client</h3>
<div class="level3">

<p>
Install the required packages.
Configure Tor client.
</p>
<pre class="code bash"><span class="co0"># Install packages</span>
opkg update
opkg <span class="kw2">install</span> tor
&nbsp;
<span class="co0"># Configure Tor client</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>tor<span class="sy0">/</span>custom
AutomapHostsOnResolve <span class="nu0">1</span>
AutomapHostsSuffixes .
VirtualAddrNetworkIPv4 172.16.0.0<span class="sy0">/</span><span class="nu0">12</span>
VirtualAddrNetworkIPv6 <span class="br0">&#91;</span>fc00::<span class="br0">&#93;</span><span class="sy0">/</span><span class="nu0">8</span>
DNSPort 0.0.0.0:<span class="nu0">9053</span>
DNSPort <span class="br0">&#91;</span>::<span class="br0">&#93;</span>:<span class="nu0">9053</span>
TransPort 0.0.0.0:<span class="nu0">9040</span>
TransPort <span class="br0">&#91;</span>::<span class="br0">&#93;</span>:<span class="nu0">9040</span>
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>sysupgrade.conf
<span class="sy0">/</span>etc<span class="sy0">/</span>tor
EOF
uci del_list tor.conf.tail_include=<span class="st0">&quot;/etc/tor/custom&quot;</span>
uci add_list tor.conf.tail_include=<span class="st0">&quot;/etc/tor/custom&quot;</span>
uci commit tor
service tor restart</pre>

<p>
Disable <a href="/docs/guide-user/network/ipv6/ipv6_extras#disabling_gua_prefix" class="wikilink1" title="docs:guide-user:network:ipv6:ipv6_extras" data-wiki-id="docs:guide-user:network:ipv6:ipv6_extras">IPv6 GUA prefix</a> and announce <a href="/docs/guide-user/network/ipv6/ipv6_extras#announcing_ipv6_default_route" class="wikilink1" title="docs:guide-user:network:ipv6:ipv6_extras" data-wiki-id="docs:guide-user:network:ipv6:ipv6_extras">IPv6 default route</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;1. Tor client&quot;,&quot;hid&quot;:&quot;tor_client1&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;883-1674&quot;} -->
<h3 class="sectionedit10" id="dns_over_tor">2. DNS over Tor</h3>
<div class="level3">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;docs:guide-user:firewall:fw3_configurations:intercept_dns&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:11,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__docs:guide-user:firewall:fw3_configurations:intercept_dns">
<div class="level3">

<p>
Configure firewall to intercept <abbr title="Domain Name System">DNS</abbr> traffic.
</p>
<pre class="code bash"><span class="co0"># Intercept DNS traffic</span>
uci <span class="re5">-q</span> del firewall.dns_int
uci <span class="kw1">set</span> firewall.dns_int=<span class="st0">&quot;redirect&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.name=<span class="st0">&quot;Intercept-DNS&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.family=<span class="st0">&quot;any&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.proto=<span class="st0">&quot;tcp udp&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.src=<span class="st0">&quot;lan&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.src_dport=<span class="st0">&quot;53&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.dest_port=<span class="st0">&quot;53&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.target=<span class="st0">&quot;DNAT&quot;</span>
uci commit firewall
service firewall restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;docs:guide-user:firewall:fw3_configurations:intercept_dns&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:12,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level3">

<p>
Redirect <abbr title="Domain Name System">DNS</abbr> traffic to Tor and prevent <abbr title="Domain Name System">DNS</abbr> leaks.
</p>
<pre class="code bash"><span class="co0"># Enable DNS over Tor</span>
service dnsmasq stop
uci <span class="kw1">set</span> dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.localuse=<span class="st0">&quot;0&quot;</span>
uci <span class="kw1">set</span> dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.noresolv=<span class="st0">&quot;1&quot;</span>
uci <span class="kw1">set</span> dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.rebind_protection=<span class="st0">&quot;0&quot;</span>
uci <span class="re5">-q</span> delete dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.server
uci add_list dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.server=<span class="st0">&quot;127.0.0.1#9053&quot;</span>
uci add_list dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.server=<span class="st0">&quot;::1#9053&quot;</span>
uci commit dhcp
service dnsmasq start</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;2. DNS over Tor&quot;,&quot;hid&quot;:&quot;dns_over_tor&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:10,&quot;range&quot;:&quot;1675-2245&quot;} -->
<h3 class="sectionedit13" id="firewall">3. Firewall</h3>
<div class="level3">

<p>
Configure firewall to intercept <abbr title="Local Area Network">LAN</abbr> traffic.
Disable <abbr title="Local Area Network">LAN</abbr> to <abbr title="Wide Area Network">WAN</abbr> forwarding to prevent traffic leaks.
</p>
<pre class="code bash"><span class="co0"># Intercept TCP traffic</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>nftables.d<span class="sy0">/</span>tor.sh
<span class="re2">TOR_CHAIN</span>=<span class="st0">&quot;dstnat_<span class="es4">$(uci -q get firewall.tcp_int.src)</span>&quot;</span>
<span class="re2">TOR_RULE</span>=<span class="st0">&quot;$(nft -a list chain inet fw4 <span class="es3">${TOR_CHAIN}</span> <span class="es1">\
</span>| sed -n -e &quot;</span><span class="sy0">/</span>Intercept-TCP<span class="sy0">/</span>p<span class="st0">&quot;)&quot;</span>
nft replace rule inet fw4 <span class="co1">${TOR_CHAIN}</span> \
handle <span class="co1">${TOR_RULE##* }</span> \
fib daddr <span class="kw3">type</span> <span class="sy0">!</span>= <span class="br0">&#123;</span> <span class="kw3">local</span>, broadcast <span class="br0">&#125;</span> <span class="co1">${TOR_RULE}</span>
EOF
uci <span class="re5">-q</span> delete firewall.tor_nft
uci <span class="kw1">set</span> firewall.tor_nft=<span class="st0">&quot;include&quot;</span>
uci <span class="kw1">set</span> firewall.tor_nft.path=<span class="st0">&quot;/etc/nftables.d/tor.sh&quot;</span>
uci <span class="re5">-q</span> delete firewall.tcp_int
uci <span class="kw1">set</span> firewall.tcp_int=<span class="st0">&quot;redirect&quot;</span>
uci <span class="kw1">set</span> firewall.tcp_int.name=<span class="st0">&quot;Intercept-TCP&quot;</span>
uci <span class="kw1">set</span> firewall.tcp_int.src=<span class="st0">&quot;lan&quot;</span>
uci <span class="kw1">set</span> firewall.tcp_int.src_dport=<span class="st0">&quot;0-65535&quot;</span>
uci <span class="kw1">set</span> firewall.tcp_int.dest_port=<span class="st0">&quot;9040&quot;</span>
uci <span class="kw1">set</span> firewall.tcp_int.proto=<span class="st0">&quot;tcp&quot;</span>
uci <span class="kw1">set</span> firewall.tcp_int.family=<span class="st0">&quot;any&quot;</span>
uci <span class="kw1">set</span> firewall.tcp_int.target=<span class="st0">&quot;DNAT&quot;</span>
&nbsp;
<span class="co0"># Disable LAN to WAN forwarding</span>
uci <span class="re5">-q</span> delete firewall.<span class="sy0">@</span>forwarding<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>
uci commit firewall
service firewall restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;3. Firewall&quot;,&quot;hid&quot;:&quot;firewall&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:13,&quot;range&quot;:&quot;2246-3300&quot;} -->
<h2 class="sectionedit14" id="testing">Testing</h2>
<div class="level2">

<p>
Verify that you are using Tor.
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://check.torproject.org/" class="urlextern" title="https://check.torproject.org/" rel="ugc nofollow">check.torproject.org</a></div>
</li>
</ul>

<p>
Check your <abbr title="Internet Protocol">IP</abbr> and <abbr title="Domain Name System">DNS</abbr> provider.
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://ipleak.net/" class="urlextern" title="https://ipleak.net/" rel="ugc nofollow">ipleak.net</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://www.dnsleaktest.com/" class="urlextern" title="https://www.dnsleaktest.com/" rel="ugc nofollow">dnsleaktest.com</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Testing&quot;,&quot;hid&quot;:&quot;testing&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:14,&quot;range&quot;:&quot;3301-3536&quot;} -->
<h2 class="sectionedit15" id="troubleshooting">Troubleshooting</h2>
<div class="level2">

<p>
Collect and analyze the following information.
</p>
<pre class="code bash"><span class="co0"># Restart services</span>
service log restart; service firewall restart; service tor restart
&nbsp;
<span class="co0"># Log and status</span>
logread <span class="re5">-e</span> Tor; <span class="kw2">netstat</span> <span class="re5">-l</span> <span class="re5">-n</span> <span class="re5">-p</span> <span class="sy0">|</span> <span class="kw2">grep</span> <span class="re5">-e</span> tor
&nbsp;
<span class="co0"># Runtime configuration</span>
pgrep <span class="re5">-f</span> <span class="re5">-a</span> tor
nft list ruleset
&nbsp;
<span class="co0"># Persistent configuration</span>
uci show firewall; uci show tor; <span class="kw2">grep</span> <span class="re5">-v</span> <span class="re5">-r</span> <span class="re5">-e</span> <span class="st0">&quot;^#&quot;</span> <span class="re5">-e</span> <span class="st0">&quot;^$&quot;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>tor</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:15,&quot;range&quot;:&quot;3537-&quot;} -->