
<h1 class="sectionedit1" id="bind-server-filter-aaaaforcing_domains_to_resolve_only_to_ipv4_addresses">bind-server-filter-aaaa: forcing domains to resolve only to IPv4 addresses</h1>
<div class="level1">

<p>
This guide explains how to set up a local nameserver that prevents certain domain names from resolving to <abbr title="Internet Protocol version 6">IPv6</abbr> addresses (<code>AAAA</code> records).  This is useful if you are using an <abbr title="Internet Protocol version 6">IPv6</abbr>-over-<abbr title="Internet Protocol version 4">IPv4</abbr> tunnel (such as <a href="/docs/guide-user/network/ipv6/ipv6_henet" class="wikilink1" title="docs:guide-user:network:ipv6:ipv6_henet" data-wiki-id="docs:guide-user:network:ipv6:ipv6_henet">IPv6 with Hurricane Electric</a>) and want to use network services that don&#039;t support <abbr title="Internet Protocol version 6">IPv6</abbr> tunnels.  This setup will strip <code>AAAA</code> records from your specified domains--forcing them to use <abbr title="Internet Protocol version 4">IPv4</abbr> only--while allowing <abbr title="Internet Protocol version 6">IPv6</abbr> for all other domains.
</p>

</div>

<h4 id="note">NOTE</h4>
<div class="level4">

<p>
Installing <code>bind-server</code> will temporarily interfere with/deactivate dnsmasq.  After you install <code>bind-server</code>, you will stop it and edit its configuration file so that it can coexist with dnsmasq.
</p>

</div>

<h4 id="installation">Installation</h4>
<div class="level4">

<p>
Log into the router through ssh.
</p>

<p>
Install at least the following packages:
</p>
<ul>
<li class="level1"><div class="li"> bind-rndc</div>
</li>
<li class="level1"><div class="li"> bind-server</div>
</li>
<li class="level1"><div class="li"> bind-server-filter-aaaa</div>
</li>
<li class="level1"><div class="li"> bind-dig</div>
</li>
</ul>

<p>
After installing bind-server, stop it with <code>/etc/init.d/named stop</code>.
</p>

</div>

<h4 id="configuration">Configuration</h4>
<div class="level4">

<p>
You will set up <code>named</code> to listen on port 2053 on loopback addresses, then configure dnsmasq to forward the domains that you want to filter to <code>named</code>.
</p>

</div>

<h5 id="editetcbindnamedconf">Edit /etc/bind/named.conf</h5>
<div class="level5">

<p>
At the top level add:
</p>
<pre class="code">plugin query &quot;/usr/lib/bind/filter-aaaa.so&quot; {
  filter-aaaa-on-v4 yes;
  filter-aaaa-on-v6 yes;
};</pre>

<p>
Add this inside the <code>options</code> section: 
</p>
<pre class="code">  	listen-on port 2053 { 127.0.0.1; };
  	listen-on-v6 port 2053 { ::1; };
        forward only;
        forwarders {
           // your ISP&#039;s DNS servers,
           // or your preferred replacements for them
           // examples:
           // 8.8.8.8;
           // 208.67.222.222;
        };</pre>

</div>

<h4 id="enable_and_restart_named">Enable and restart named</h4>
<div class="level4">
<pre class="code">service named enable
service named start</pre>

</div>

<h4 id="test_named">Test named</h4>
<div class="level4">

<p>
Test that your filtered domain (<code>example.com</code>) has no <code>AAAA</code> records, according to your <code>named</code>:
</p>
<pre class="code">dig @127.0.0.1 -p 2053 example.com AAAA</pre>

<p>
should provide you with a NOERROR response such as this:
</p>
<pre class="code">; &lt;&lt;&gt;&gt; DiG 9.18.0 &lt;&lt;&gt;&gt; @127.0.0.1 -p 2053 example.com AAAA
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 34488
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 0bfa47e834f331f5010000006225150efca3ef92e372acd9 (good)
;; QUESTION SECTION:
;example.com.			IN	AAAA

;; Query time: 50 msec
;; SERVER: 127.0.0.1#2053(127.0.0.1) (UDP)
;; WHEN: Sun Mar 06 15:09:50 EST 2022
;; MSG SIZE  rcvd: 68
</pre>

<p>
Whereas querying a public <abbr title="Domain Name System">DNS</abbr> server:
</p>
<pre class="code">dig @8.8.8.8 -p 53 example.com AAAA</pre>

<p>
will return the <abbr title="Internet Protocol version 6">IPv6</abbr> addresses for the filtered domain, such as:
</p>
<pre class="code">; &lt;&lt;&gt;&gt; DiG 9.18.0 &lt;&lt;&gt;&gt; @8.8.8.8 -p 53 example.com AAAA
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 8182
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;example.com.			IN	AAAA

;; ANSWER SECTION:
example.com.		60	IN	AAAA	fe80::1
example.com.		60	IN	AAAA	fe80::2
example.com.		60	IN	AAAA	fe80::3

;; Query time: 30 msec
;; SERVER: 8.8.8.8#53(8.8.8.8) (UDP)
;; WHEN: Sun Mar 06 15:10:39 EST 2022
;; MSG SIZE  rcvd: 124
</pre>

</div>

<h4 id="configure_dnsmasq">Configure dnsmasq</h4>
<div class="level4">

<p>
Now that named is filtering out <code>AAAA</code> records for all domains, you will add rules for dnsmasq to forward only the domains from which you want to strip <code>AAAA</code> records to your <code>named</code>:
</p>
<pre class="code">uci add_list dhcp.@dnsmasq[0].server=&#039;/example.com/127.0.0.1#2053&#039;
uci add_list dhcp.@dnsmasq[0].server=&#039;/example.net/127.0.0.1#2053&#039;
uci commit
/etc/init.d/dnsmasq restart</pre>

</div>

<h4 id="test_dnsmasq_forwarding_of_the_domains">Test dnsmasq forwarding of the domains</h4>
<div class="level4">

<p>
Test that your filtered domain (<code>example.com</code>) has no <code>AAAA</code> records, according to your dnsmasq:
</p>
<pre class="code">dig @127.0.0.1 -p 53 example.com AAAA</pre>

<p>
With a result similar to the result direct from named:
</p>
<pre class="code">; &lt;&lt;&gt;&gt; DiG 9.18.0 &lt;&lt;&gt;&gt; @127.0.0.1 -p 53 example.com AAAA
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 8399
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 9177638017b6a493010000006225159305ed84045f766c04 (good)
;; QUESTION SECTION:
;example.com.			IN	AAAA

;; Query time: 40 msec
;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)
;; WHEN: Sun Mar 06 15:12:03 EST 2022
;; MSG SIZE  rcvd: 68
</pre>

</div>
