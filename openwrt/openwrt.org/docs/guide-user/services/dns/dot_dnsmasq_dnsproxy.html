
<h1 class="sectionedit1" id="dohdoh3_dot_doq_and_dnscrypt_with_dnsmasq_and_dnsproxy">DoH/DoH3, DoT, DoQ and DNSCrypt with Dnsmasq and dnsproxy</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;DoH\/DoH3, DoT, DoQ and DNSCrypt with Dnsmasq and dnsproxy&quot;,&quot;hid&quot;:&quot;dohdoh3_dot_doq_and_dnscrypt_with_dnsmasq_and_dnsproxy&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-154&quot;} -->
<h2 class="sectionedit6" id="introduction">Introduction</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> This how-to describes the method for setting up <a href="https://en.wikipedia.org/wiki/DNS_over_HTTPS" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/DNS_over_HTTPS">DNS over HTTPS</a>, <a href="https://en.wikipedia.org/wiki/HTTP/3" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/HTTP/3">DNS over HTTP/3</a>, <a href="https://en.wikipedia.org/wiki/DNS_over_TLS" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/DNS_over_TLS">DNS over TLS</a>, <a href="https://en.wikipedia.org/wiki/QUIC" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/QUIC">DNS over QUIC</a> and <a href="https://en.wikipedia.org/wiki/DNSCrypt" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/DNSCrypt">DNSCrypt</a> on OpenWrt.</div>
</li>
<li class="level1"><div class="li"> It relies on <a href="/docs/guide-user/base-system/dhcp.dnsmasq" class="wikilink1" title="docs:guide-user:base-system:dhcp.dnsmasq" data-wiki-id="docs:guide-user:base-system:dhcp.dnsmasq">Dnsmasq</a> and <a href="/packages/pkgdata/dnsproxy" class="wikilink1" title="packages:pkgdata:dnsproxy" data-wiki-id="packages:pkgdata:dnsproxy">dnsproxy</a> for resource efficiency and performance.</div>
</li>
<li class="level1"><div class="li"> Follow <a href="/docs/guide-user/firewall/fw3_configurations/intercept_dns" class="wikilink1" title="docs:guide-user:firewall:fw3_configurations:intercept_dns" data-wiki-id="docs:guide-user:firewall:fw3_configurations:intercept_dns">DNS hijacking</a> to intercept <abbr title="Domain Name System">DNS</abbr> traffic or use <a href="/docs/guide-user/services/vpn/start" class="wikilink1" title="docs:guide-user:services:vpn:start" data-wiki-id="docs:guide-user:services:vpn:start">VPN</a> to protect all traffic.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;155-742&quot;} -->
<h2 class="sectionedit7" id="goals">Goals</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;docs:guide-user:services:dns:dnscrypt_dnsmasq_dnscrypt-proxy&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:8,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__docs:guide-user:services:dns:dnscrypt_dnsmasq_dnscrypt-proxy">
<div class="level2">
<ul>
<li class="level1 node"><div class="li"> Encrypt your <abbr title="Domain Name System">DNS</abbr> traffic improving security and privacy.</div>
<ul>
<li class="level2"><div class="li"> Prevent <abbr title="Domain Name System">DNS</abbr> leaks and <abbr title="Domain Name System">DNS</abbr> hijacking.</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> Bypass regional restrictions using public <abbr title="Domain Name System">DNS</abbr> providers.</div>
<ul>
<li class="level2"><div class="li"> Escape <abbr title="Domain Name System">DNS</abbr>-based content filters and internet censorship.</div>
</li>
</ul>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;docs:guide-user:services:dns:dnscrypt_dnsmasq_dnscrypt-proxy&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:9,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Goals&quot;,&quot;hid&quot;:&quot;goals&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;743-871&quot;} -->
<h2 class="sectionedit10" id="command-line_instructions">Command-line instructions</h2>
<div class="level2">

<p>
1. Install the required packages:
</p>
<pre class="code bash">opkg update
opkg <span class="kw2">install</span> dnsproxy</pre>

<p>
2. Enable <abbr title="Domain Name System">DNS</abbr> encryption:
</p>
<pre class="code bash"><span class="co0"># Configure dnsmasq</span>
service dnsmasq stop
uci <span class="kw1">set</span> dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.noresolv=<span class="st0">&quot;1&quot;</span>
uci <span class="kw1">set</span> dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.cachesize=<span class="st0">&quot;10000&quot;</span>
uci <span class="kw1">set</span> dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.min_cache_ttl=<span class="st0">&quot;3600&quot;</span>
uci <span class="kw1">set</span> dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.max_cache_ttl=<span class="st0">&quot;86400&quot;</span>
uci <span class="re5">-q</span> del dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.server
uci add_list dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.server=<span class="st0">&quot;127.0.0.1#5354&quot;</span>
uci add_list dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.server=<span class="st0">&quot;::1#5354&quot;</span>
uci commit dhcp
service dnsmasq start
&nbsp;
<span class="co0"># Configure dnsproxy</span>
uci <span class="kw1">set</span> dnsproxy.global.enabled=<span class="st0">&quot;1&quot;</span>
uci del dnsproxy.global.listen_port
uci add_list dnsproxy.global.listen_port=<span class="st0">&quot;5354&quot;</span>
uci <span class="kw1">set</span> dnsproxy.cache.enabled=<span class="st0">&quot;0&quot;</span>  <span class="co0"># &quot;1&quot; to enable (Enable this ONLY if you want to test &quot;cache_optimistic&quot; option)</span>
uci <span class="kw1">set</span> dnsproxy.cache.cache_optimistic=<span class="st0">&quot;1&quot;</span>
uci <span class="kw1">set</span> dnsproxy.cache.size=<span class="st0">&quot;2097152&quot;</span>  <span class="co0"># Equal to 2 MB (in binary)</span>
uci del dnsproxy.servers.bootstrap
uci add_list dnsproxy.servers.bootstrap=<span class="st0">&quot;8.8.8.8&quot;</span>
uci add_list dnsproxy.servers.bootstrap=<span class="st0">&quot;tcp://8.8.8.8&quot;</span>
uci commit dnsproxy
service dnsproxy restart</pre>

<p>
3. It is recommended to increase the maximum buffer size: <a href="https://github.com/quic-go/quic-go/wiki/UDP-Buffer-Sizes" class="urlextern" title="https://github.com/quic-go/quic-go/wiki/UDP-Buffer-Sizes" rel="ugc nofollow">UDP Buffer Sizes</a>
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>sysctl.d<span class="sy0">/</span><span class="nu0">12</span>-buffer-size.conf
net.core.rmem_max=<span class="nu0">7500000</span>
net.core.wmem_max=<span class="nu0">7500000</span>
EOF
sysctl <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>sysctl.d<span class="sy0">/</span><span class="nu0">12</span>-buffer-size.conf</pre>

<p>
4. Ensure <abbr title="Network Time Protocol">NTP</abbr> (Network Time Protocol) can work without <abbr title="Domain Name System">DNS</abbr>:
</p>
<pre class="code bash">uci del system.ntp.server
uci add_list system.ntp.server=<span class="st0">&quot;216.239.35.0&quot;</span>     <span class="co0"># time.google.com</span>
uci add_list system.ntp.server=<span class="st0">&quot;216.239.35.4&quot;</span>     <span class="co0"># time.google.com</span>
uci add_list system.ntp.server=<span class="st0">&quot;216.239.35.8&quot;</span>     <span class="co0"># time.google.com</span>
uci add_list system.ntp.server=<span class="st0">&quot;216.239.35.12&quot;</span>    <span class="co0"># time.google.com</span>
uci add_list system.ntp.server=<span class="st0">&quot;162.159.200.123&quot;</span>  <span class="co0"># time.cloudflare.com</span>
uci add_list system.ntp.server=<span class="st0">&quot;162.159.200.1&quot;</span>    <span class="co0"># time.cloudflare.com</span>
uci commit system
service system restart</pre>

<p>
5. Optional: <a href="/docs/guide-user/firewall/fw3_configurations/intercept_dns#command-line_instructions" class="wikilink1" title="docs:guide-user:firewall:fw3_configurations:intercept_dns" data-wiki-id="docs:guide-user:firewall:fw3_configurations:intercept_dns">DNS hijacking</a>: Configure firewall to intercept <abbr title="Domain Name System">DNS</abbr> traffic:
</p>
<pre class="code bash"><span class="co0"># Intercept DNS traffic</span>
uci <span class="re5">-q</span> del firewall.dns_int
uci <span class="kw1">set</span> firewall.dns_int=<span class="st0">&quot;redirect&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.name=<span class="st0">&quot;Intercept-DNS&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.family=<span class="st0">&quot;any&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.proto=<span class="st0">&quot;tcp udp&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.src=<span class="st0">&quot;lan&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.src_dport=<span class="st0">&quot;53&quot;</span>
uci <span class="kw1">set</span> firewall.dns_int.target=<span class="st0">&quot;DNAT&quot;</span>
uci commit firewall
service firewall restart</pre>

<p>
<abbr title="Local Area Network">LAN</abbr> clients should use Dnsmasq as a primary resolver.
Dnsmasq forwards <abbr title="Domain Name System">DNS</abbr> queries to dnsproxy which encrypts <abbr title="Domain Name System">DNS</abbr> traffic.
</p>

<p>
For documents, please see:
</p>
<ul>
<li class="level1"><div class="li"> <strong><a href="https://github.com/openwrt/packages/blob/master/net/dnsproxy/files/dnsproxy.config" class="urlextern" title="https://github.com/openwrt/packages/blob/master/net/dnsproxy/files/dnsproxy.config" rel="ugc nofollow">Default &quot;dnsproxy.config&quot; file in OpenWrt</a></strong></div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/AdguardTeam/dnsproxy#usage" class="urlextern" title="https://github.com/AdguardTeam/dnsproxy#usage" rel="ugc nofollow">AdguardTeam/dnsproxy: Simple DNS proxy with DoH, DoT, DoQ and DNSCrypt support</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/AdguardTeam/AdGuardHome/wiki/Configuration#upstreams" class="urlextern" title="https://github.com/AdguardTeam/AdGuardHome/wiki/Configuration#upstreams" rel="ugc nofollow">AdguardTeam/AdGuardHome: Configuring upstreams</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://help.nextdns.io/t/x2hmvas/what-is-dns-over-tls-dot-dns-over-quic-doq-and-dns-over-https-doh-doh3" class="urlextern" title="https://help.nextdns.io/t/x2hmvas/what-is-dns-over-tls-dot-dns-over-quic-doq-and-dns-over-https-doh-doh3" rel="ugc nofollow">What is DNS over TLS (DoT), DNS over Quic (DoQ) and DNS over HTTPS (DoH &amp; DoH3)? - NextDNS Help Center</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Command-line instructions&quot;,&quot;hid&quot;:&quot;command-line_instructions&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:10,&quot;range&quot;:&quot;872-4180&quot;} -->
<h2 class="sectionedit11" id="testing">Testing</h2>
<div class="level2">

<p>
Verify domain name resolution with <a href="http://man.cx/nslookup%281%29" class="interwiki iw_man" title="http://man.cx/nslookup%281%29">nslookup</a>:
</p>
<pre class="code bash">nslookup openwrt.org localhost</pre>

<p>
To check your <abbr title="Domain Name System">DNS</abbr> provider, you can use:
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://one.one.one.one/help/" class="urlextern" title="https://one.one.one.one/help/" rel="ugc nofollow">Cloudflare Test</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://adguard.com/en/test.html" class="urlextern" title="https://adguard.com/en/test.html" rel="ugc nofollow">AdGuard Test</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://test.nextdns.io/" class="urlextern" title="https://test.nextdns.io/" rel="ugc nofollow"> NextDNS Test</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://mullvad.net/en/check" class="urlextern" title="https://mullvad.net/en/check" rel="ugc nofollow">Mullvad Test</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://on.quad9.net/" class="urlextern" title="https://on.quad9.net/" rel="ugc nofollow">Quad9 Test</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://welcome.opendns.com/" class="urlextern" title="https://welcome.opendns.com/" rel="ugc nofollow">OpenDNS Test</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://www.cloudflare.com/ssl/encrypted-sni/" class="urlextern" title="https://www.cloudflare.com/ssl/encrypted-sni/" rel="ugc nofollow">Cloudflare Browser Check</a></div>
</li>
</ul>

<p>
<abbr title="Domain Name System">DNS</abbr> Leak Test and DNSSEC Test:
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://dnsleaktest.com/" class="urlextern" title="https://dnsleaktest.com/" rel="ugc nofollow">DNS Leak Test #1</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://dnscheck.tools/" class="urlextern" title="https://dnscheck.tools/" rel="ugc nofollow">DNS Leak Test #2</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://dnssec-or-not.com/" class="urlextern" title="http://dnssec-or-not.com/" rel="ugc nofollow">DNSSEC Test #1</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://wander.science/projects/dns/dnssec-resolver-test/" class="urlextern" title="https://wander.science/projects/dns/dnssec-resolver-test/" rel="ugc nofollow">DNSSEC Test #2</a></div>
</li>
</ul>

<p>
Alternative test via CLI:
* check connection to Quad9 <abbr title="Domain Name System">DNS</abbr> (it require to use Quad9 <abbr title="Domain Name System">DNS</abbr> servers):
</p>
<pre class="code">dig +short txt proto.on.quad9.net.
# should print: doh. or dot.</pre>

<p>
* check connection to NextDNS (it require to use NextDNS <abbr title="Domain Name System">DNS</abbr> servers):
</p>
<pre class="code">curl -SL https://test.nextdns.io/
{
        &quot;status&quot;: &quot;ok&quot;,
        &quot;protocol&quot;: &quot;DOT&quot;,
        &quot;profile&quot;: &quot;SOMEPROFILE&quot;,
        &quot;client&quot;: &quot;80.XXX.XXX.XXX&quot;,
        &quot;srcIP&quot;: &quot;80.XXX.XXX.XXX&quot;,
        &quot;destIP&quot;: &quot;XX.XX.28.0&quot;,
        &quot;anycast&quot;: true,
        &quot;server&quot;: &quot;zepto-ber-1&quot;,
        &quot;clientName&quot;: &quot;unknown-dot&quot;
}</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Testing&quot;,&quot;hid&quot;:&quot;testing&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:11,&quot;range&quot;:&quot;4181-5578&quot;} -->
<h2 class="sectionedit12" id="troubleshooting">Troubleshooting</h2>
<div class="level2">

<p>
Collect and analyze the following information.
</p>
<pre class="code bash"><span class="co0"># Set verbose mode</span>
uci <span class="kw1">set</span> dnsproxy.global.verbose=<span class="st0">&quot;1&quot;</span>; uci commit dnsproxy
&nbsp;
<span class="co0"># Restart services</span>
service log restart; service dnsmasq restart; service dnsproxy restart
&nbsp;
<span class="co0"># Log and status</span>
logread <span class="re5">-e</span> dnsmasq; <span class="kw2">netstat</span> <span class="re5">-l</span> <span class="re5">-n</span> <span class="re5">-p</span> <span class="sy0">|</span> <span class="kw2">grep</span> <span class="re5">-e</span> dnsmasq
logread <span class="re5">-e</span> dnsproxy; <span class="kw2">netstat</span> <span class="re5">-l</span> <span class="re5">-n</span> <span class="re5">-p</span> <span class="sy0">|</span> <span class="kw2">grep</span> <span class="re5">-e</span> dnsproxy
&nbsp;
<span class="co0"># Runtime configuration</span>
pgrep <span class="re5">-f</span> <span class="re5">-a</span> dnsmasq; pgrep <span class="re5">-f</span> <span class="re5">-a</span> dnsproxy
<span class="kw2">head</span> <span class="re5">-v</span> <span class="re5">-n</span> <span class="re5">-0</span> <span class="sy0">/</span>etc<span class="sy0">/</span>resolv.<span class="sy0">*</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>resolv.<span class="sy0">*</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>resolv.<span class="sy0">*/*</span>
&nbsp;
<span class="co0"># Persistent configuration</span>
uci show dhcp; uci show dnsproxy</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:8,&quot;secid&quot;:12,&quot;range&quot;:&quot;5579-6157&quot;} -->
<h2 class="sectionedit13" id="extras">Extras</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Extras&quot;,&quot;hid&quot;:&quot;extras&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:13,&quot;range&quot;:&quot;6158-6177&quot;} -->
<h3 class="sectionedit14" id="configure_dns_provider">Configure DNS provider</h3>
<div class="level3">

<p>
<strong>dnsproxy</strong> is configured with Cloudflare <abbr title="Domain Name System">DNS</abbr> by default.
You can change it to Google <abbr title="Domain Name System">DNS</abbr> or any other <strong><a href="https://adguard-dns.io/kb/general/dns-providers/" class="urlextern" title="https://adguard-dns.io/kb/general/dns-providers/" rel="ugc nofollow">Known DNS Providers</a></strong> or <strong><a href="https://dnscrypt.info/public-servers" class="urlextern" title="https://dnscrypt.info/public-servers" rel="ugc nofollow">DNS Stamp</a></strong> used for DNSCrypt.
Use resolvers supporting DNSSEC validation if necessary.
Specify several resolvers to improve fault tolerance.
</p>
<pre class="code bash">Example with <span class="st0">&quot;AdGuard DNS (Default)&quot;</span>
&nbsp;
<span class="co0"># DNS over HTTPS (DoH)</span>
uci del dnsproxy.servers.upstream
uci add_list dnsproxy.servers.upstream=<span class="st0">&quot;https://dns.adguard-dns.com/dns-query&quot;</span>
uci commit dnsproxy
service dnsproxy restart
&nbsp;
<span class="co0"># DNS over HTTP/3 (DoH3)</span>
uci del dnsproxy.servers.upstream
uci add_list dnsproxy.servers.upstream=<span class="st0">&quot;h3://dns.adguard-dns.com/dns-query&quot;</span>
uci commit dnsproxy
service dnsproxy restart
&nbsp;
<span class="co0"># DNS over TLS (DoT)</span>
uci del dnsproxy.servers.upstream
uci add_list dnsproxy.servers.upstream=<span class="st0">&quot;tls://dns.adguard-dns.com&quot;</span>
uci commit dnsproxy
service dnsproxy restart
&nbsp;
<span class="co0"># DNS over QUIC (DoQ)</span>
uci del dnsproxy.servers.upstream
uci add_list dnsproxy.servers.upstream=<span class="st0">&quot;quic://dns.adguard-dns.com&quot;</span>
uci commit dnsproxy
service dnsproxy restart
&nbsp;
<span class="co0"># DNSCrypt (&quot;DNS Stamp&quot; of AdGuard DNS)</span>
uci del dnsproxy.servers.upstream
uci add_list dnsproxy.servers.upstream=<span class="st0">&quot;sdns://AQMAAAAAAAAAETk0LjE0MC4xNC4xNDo1NDQzINErR_JS3PLCu_iZEIbq95zkSV2LFsigxDIuUso_OQhzIjIuZG5zY3J5cHQuZGVmYXVsdC5uczEuYWRndWFyZC5jb20&quot;</span>
uci commit dnsproxy
service dnsproxy restart
&nbsp;
<span class="co0"># DNS over HTTPS (&quot;DNS Stamp&quot; of AdGuard DNS)</span>
uci del dnsproxy.servers.upstream
uci add_list dnsproxy.servers.upstream=<span class="st0">&quot;sdns://AgMAAAAAAAAADDk0LjE0MC4xNS4xNSCaOjT3J965vKUQA9nOnDn48n3ZxSQpAcK6saROY1oCGQw5NC4xNDAuMTUuMTUKL2Rucy1xdWVyeQ&quot;</span>
uci commit dnsproxy
service dnsproxy restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configure DNS provider&quot;,&quot;hid&quot;:&quot;configure_dns_provider&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:14,&quot;range&quot;:&quot;6178-7915&quot;} -->
<h3 class="sectionedit15" id="web_interface">Web interface</h3>
<div class="level3">

<p>
If you want to manage the settings using web interface.
Install the necessary packages.
The package is not officially in OpenWrt, you need to download the package, upload and install it through the Luci interface (<strong>System → Software → Upload Package...</strong>):
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://github.com/muink/luci-app-dnsproxy" class="urlextern" title="https://github.com/muink/luci-app-dnsproxy" rel="ugc nofollow">https://github.com/muink/luci-app-dnsproxy</a></div>
</li>
</ul>

<p>
Navigate to <strong>LuCI → Services → <abbr title="Domain Name System">DNS</abbr> Proxy</strong> to configure.
</p>

<p>
<strong>Note:</strong> I hope someone wants to become the maintainer of “<strong><a href="https://github.com/muink/luci-app-dnsproxy" class="urlextern" title="https://github.com/muink/luci-app-dnsproxy" rel="ugc nofollow">luci-app-dnsproxy</a></strong>” package and make it an official OpenWrt package.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Web interface&quot;,&quot;hid&quot;:&quot;web_interface&quot;,&quot;codeblockOffset&quot;:10,&quot;secid&quot;:15,&quot;range&quot;:&quot;7916-&quot;} -->