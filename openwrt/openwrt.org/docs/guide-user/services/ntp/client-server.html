


<h1 class="sectionedit1" id="ntp_clientntp_server">NTP client / NTP server</h1>
<div class="level1">

<p>
See also <a href="/docs/guide-user/advanced/ntp_configuration" class="wikilink1" title="docs:guide-user:advanced:ntp_configuration" data-wiki-id="docs:guide-user:advanced:ntp_configuration">NTP</a>
</p>

<p>
 <strong><code>Note:</code></strong> most devices supported by OpenWrt do not have a hardware clock.
</p>

<p>
You can set the system date and time using one of the following methods:
</p>
<ul>
<li class="level1"><div class="li">  <em><em class="u">Manually</em></em> by utilizing <strong><code>busybox-date</code></strong>, e.g.<pre class="code">date -s  hh:mm[:ss] or [YYYY.]MM.DD-hh:mm[:ss] or YYYY-MM-DD hh:mm[:ss] or [[[[[YY]YY]MM]DD]hh]mm[.ss]</pre>
</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li">  <em><em class="u"><a href="https://en.wikipedia.org/wiki/Network Time Protocol" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Network Time Protocol">Network Time Protocol</a></em></em> by invoking <strong><code>busybox-ntpd</code></strong> once, e.g.: <pre class="code bash">ntpd <span class="re5">-q</span> <span class="re5">-p</span> ptbtime1.ptb.de</pre>

<p>
, or configure <code><a href="/docs/guide-user/base-system/system_configuration" class="wikilink1" title="docs:guide-user:base-system:system_configuration" data-wiki-id="docs:guide-user:base-system:system_configuration">/etc/config/system</a></code> accordingly to have nptd run as <abbr title="Network Time Protocol">NTP</abbr> client (and optionally additionally as <abbr title="Network Time Protocol">NTP</abbr> server) daemon. By default busybox-ntpd runs as a client and does not serve time. You can set the UCI option <code>enable_server</code> in <code>/etc/config/system</code> (in the ntp section) to enable serving time as well.
</p>
</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li">  <em><em class="u"><a href="https://en.wikipedia.org/wiki/Time Protocol" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Time Protocol">Time Protocol</a></em></em> <img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> <strong>Obsolete</strong>  Use rdate (<strong><code>busybox-rdate</code></strong>) to set the time: <pre class="code">rdate -s time.protocol.server.org</pre>

<p>
  Use with <code><a href="/docs/guide-user/base-system/notuci.config#etccrontabsroot" class="wikilink1" title="docs:guide-user:base-system:notuci.config" data-wiki-id="docs:guide-user:base-system:notuci.config">/etc/crontabs/root</a></code>
</p>
</div>
</li>
</ul>
<ol>
<li class="level1"><div class="li"> <em><em class="u">Other <abbr title="Network Time Protocol">NTP</abbr> packages</em></em>  If the default busybox-ntpd isn&#039;t sufficient, one of the following alternate ntpd packages can be installed:</div>
</li>
</ol>
<div class="table sectionedit2"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> Name       </th><th class="col1 leftalign"> Version  </th><th class="col2 centeralign">  Size  </th><th class="col3 leftalign"> Description  </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign"> ntpclient  </td><td class="col1 centeralign">  2007_365-4  </td><td class="col2 rightalign">   12.970 </td><td class="col3 leftalign"> <abbr title="Network Time Protocol">NTP</abbr> client for setting system time from <abbr title="Network Time Protocol">NTP</abbr> servers.  </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> ntpd       </td><td class="col1 centeralign">  4.2.6p4-1   </td><td class="col2 rightalign">  168.021 </td><td class="col3 leftalign"> The ISC ntp suite is a collection of tools used to synchronize the system clock with remote <abbr title="Network Time Protocol">NTP</abbr> time servers and run/montior local <abbr title="Network Time Protocol">NTP</abbr> servers. This package contains the <a href="https://en.wikipedia.org/wiki/ntpd" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/ntpd">ntpd</a> server. See <a href="http://man.cx/ntpd" class="interwiki iw_man" title="http://man.cx/ntpd">ntpd</a>  </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"> ntpd-ssl   </td><td class="col1 centeralign">  4.2.6p4-1   </td><td class="col2 rightalign">  179.511 </td><td class="col3 leftalign"> The ISC ntp ... . This package contains the ntpd server with OpenSSL support.  </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign"> ntpdate    </td><td class="col1 centeralign">  4.2.6p4-1   </td><td class="col2 rightalign">   36.642 </td><td class="col3"> The ISC ntp ... . This package contains <a href="https://en.wikipedia.org/wiki/ntpdate" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/ntpdate">ntpdate</a>. See <a href="http://man.cx/ntpdate" class="interwiki iw_man" title="http://man.cx/ntpdate">ntpdate</a> </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign"> ntp-utils  </td><td class="col1 centeralign">  4.2.6p4-1   </td><td class="col2 rightalign">  158.035 </td><td class="col3 leftalign"> The ISC ntp ... . This package contains <code>ntpdc</code> and <code>ntpq</code>.  </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;1341-2087&quot;} -->
<p>
<abbr title="Network Time Protocol">NTP</abbr> (Network Time Protocol) is used to keep computer clocks accurate by synchronizing them over the Internet or a local network, or by following an accurate hardware receiver that interprets GPS, DCF-77, NIST or similar time signals.
</p>

<p>
This package contains the <abbr title="Network Time Protocol">NTP</abbr> daemon and utility programs. An <abbr title="Network Time Protocol">NTP</abbr> daemon needs to be running on each host that is to have its clock accuracy controlled by <abbr title="Network Time Protocol">NTP</abbr>. The same <abbr title="Network Time Protocol">NTP</abbr> daemon is also used to provide <abbr title="Network Time Protocol">NTP</abbr> service to other hosts.
</p>
<div class="table sectionedit3"><table class="inline">
	<tr class="row0">
		<td class="col0"> <img src="/_media/meta/icons/tango/48px-outdated.svg.png" class="media" loading="lazy" alt="" /> </td><td class="col1 leftalign"> In <a href="https://dev.openwrt.org/changeset/28612" class="urlextern" title="https://dev.openwrt.org/changeset/28612" rel="ugc nofollow">R28612</a> and <a href="https://dev.openwrt.org/changeset/28613" class="urlextern" title="https://dev.openwrt.org/changeset/28613" rel="ugc nofollow">R28613</a> <code>busybox-rdate</code> has been replaced with <code>busybox-ntpd</code> by default.<br/>
If you check the entire file <a href="https://dev.openwrt.org/browser/trunk/package/busybox/config/networking/Config.in?rev=28613" class="urlextern" title="https://dev.openwrt.org/browser/trunk/package/busybox/config/networking/Config.in?rev=28613" rel="ugc nofollow">Config.in</a> not only the diffs above, you will learn that busybox-ntpd <em>is</em> employable as server as well by default.  </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table1&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;2559-3039&quot;} -->
<p>
The <code>busybox-ntpd</code> will auto-tune its sync rate depending on clock drift and other factors, it varies between 1-60min, and yes its a daemon which keeps syncing the time. When invoking it with <code>-q</code> it would act like ntpdate, means do a burst poll/sync cycle and exit.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;NTP client \/ NTP server&quot;,&quot;hid&quot;:&quot;ntp_clientntp_server&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;11-3315&quot;} -->
<h2 class="sectionedit4" id="installation">Installation</h2>
<div class="level2">

<p>
See <a href="/docs/guide-user/additional-software/opkg" class="wikilink1" title="docs:guide-user:additional-software:opkg" data-wiki-id="docs:guide-user:additional-software:opkg">opkg</a> for more details on using the OpenWrt package manager.
</p>

<p>
By default, <strong>busybox-ntpd</strong>, can supply both a client for setting time, and a server for supplying time to the local net. This is installed out of the box and should take care of most time syncing needs. It doesnt support advanced features like query, so the server cannot be monitored from other systems like Nagios.
</p>
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_important plugin_wrap">
<p>
Some packages, such as <strong><code>luci-app-ntpc</code></strong> and <strong><code>ntpclient</code></strong>, may conflict with the built-in <strong><code>busybox-ntpd</code></strong> installation. If an <abbr title="Network Time Protocol">NTP</abbr> client or server fails to work as expected, you can check if there is another program using the <abbr title="Network Time Protocol">NTP</abbr> port by calling <strong><code>netstat -np | grep 123</code></strong> to search for clients, and <strong><code>netstat -nlp | grep 123</code></strong> to look for servers.
</p>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:6,&quot;range&quot;:&quot;0-&quot;} -->
<p>
Example (install the real ntpd package (=not busybox-ntpd):
</p>
<pre class="code bash">opkg update
opkg <span class="kw2">install</span> ntpd
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>sysntpd disable
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>ntpd <span class="kw3">enable</span>
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>ntpd start
<span class="kw2">netstat</span> <span class="re5">-l</span> <span class="sy0">|</span> <span class="kw2">grep</span> ntp</pre>

<p>
When you use ntpd, make sure you disable sysntpd daemon.
An ntpd server should be listening on the default <abbr title="Network Time Protocol">NTP</abbr> port (<abbr title="User Datagram Protocol">UDP</abbr> 123).
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation&quot;,&quot;hid&quot;:&quot;installation&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:4,&quot;range&quot;:&quot;3316-4496&quot;} -->
<h2 class="sectionedit7" id="configuration">Configuration</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> The busybox-ntpd is configured in <code><a href="/docs/guide-user/base-system/system_configuration" class="wikilink1" title="docs:guide-user:base-system:system_configuration" data-wiki-id="docs:guide-user:base-system:system_configuration">/etc/config/system</a></code>.</div>
</li>
</ul>

<p>
By default, it runs as a client and does not serve time to other peers.   A server can be enabled by adding the flag “-l” to “local args” in /etc/init.d/sysntpd (line 23). Starting with Backfire 10.3.1 this is not anymore needed and can be also changed in /etc/config/system.
</p>
<ul>
<li class="level1"><div class="li"> The package <code>ntpclient</code> is configured in <code><a href="/docs/guide-user/services/ntp/client" class="wikilink1" title="docs:guide-user:services:ntp:client" data-wiki-id="docs:guide-user:services:ntp:client">/etc/config/ntpclient</a></code>.</div>
</li>
</ul>

<p>
<code>ntpdate</code> is a command line tool that usually is used for one time synchronizations with remote ntp peers:
</p>
<pre class="code">ntpdate pool.ntp.org</pre>

<p>
and also in conjuction with <code><a href="/docs/guide-user/base-system/notuci.config#etccrontabsroot" class="wikilink1" title="docs:guide-user:base-system:notuci.config" data-wiki-id="docs:guide-user:base-system:notuci.config">/etc/crontabs/root</a></code>
</p>
<ul>
<li class="level1"><div class="li"> <code>ntpd</code> is a daemon that runs all the time in the background for permanent synchronization.</div>
</li>
</ul>

<p>
According to <a href="http://packages.debian.org/squeeze/ntp" class="urlextern" title="http://packages.debian.org/squeeze/ntp" rel="ugc nofollow">Debian</a> the same <abbr title="Network Time Protocol">NTP</abbr> daemon is also used to provide <abbr title="Network Time Protocol">NTP</abbr> service to other hosts.
</p>

<p>
To use ntpd as <abbr title="Network Time Protocol">NTP</abbr> client daemon, no change to the firewall is required, to run as <abbr title="Network Time Protocol">NTP</abbr> server daemon, open port 123 <abbr title="User Datagram Protocol">UDP</abbr> for your <abbr title="Network Time Protocol">NTP</abbr> clients (which is by default open in <abbr title="Local Area Network">LAN</abbr>). An example to run <code>ntpd</code> as a server:
</p>
<pre class="code">driftfile  /var/lib/ntp/ntp.drift

server 0.openwrt.pool.ntp.org iburst
server 1.openwrt.pool.ntp.org iburst
server 2.openwrt.pool.ntp.org iburst
server 3.openwrt.pool.ntp.org iburst

#exchange time with everybody but dont allow configuration (noquery to forbid query)
restrict -4 default kod notrap nomodify nopeer
restrict -6 default kod notrap nomodify nopeer

#local users may interrogate the ntp server more closely
restrict 127.0.0.1
restrict ::1</pre>

<p>
Depending on your configuration ntpd won&#039;t start properly when
</p>
<pre class="code">restrict 127.0.0.1
restrict ::1</pre>

<p>
is not set. When ntpd is started and it tries to connect to a server for which only a hostname is known, e.g. 0.openwrt.pool.ntp.org, and for some reason <abbr title="Domain Name System">DNS</abbr> service is not available yet (e.g. you are on a dial-up connection and it takes some time to set everything up), then without the above snippet you&#039;ll find two processes of ntpd running (one as user &#039;root&#039;, the other as user &#039;ntp&#039;) and you will have errors like this in the log:
</p>
<pre class="code">ntp_intres.request: permission denied</pre>

<p>
The explanation I found at <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=571469" class="urlextern" title="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=571469" rel="ugc nofollow">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=571469</a>. The default configuration above sets “nomodify”. That configuration on localhost “will prevent the resolver process from adding the peers.” [...] “The nomodify will only be a problem in case the resolver process needs to be started, which it does when it can&#039;t resolve the hostsnames when ntpd starts.  So this is mostly when the network isn&#039;t up yet.” (explanation by Kurt, from Debian bug report mentioned above) (sic)
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuration&quot;,&quot;hid&quot;:&quot;configuration&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:7,&quot;range&quot;:&quot;4497-7316&quot;} -->
<h2 class="sectionedit8" id="rdate_server">rdate server</h2>
<div class="level2">

<p>
First of all: rdate is old, very simple and does not give you highly reliable time.
If you still want to run a server for rdate clients for some reason you can use the xinetd package.
</p>

<p>
After installing xinetd and running “/etc/init.d/xinetd enable”, create a file “/etc/xinetd.d/time-stream” with the following content:
</p>
<pre class="code">service time
{
	disable = no
	id		= time-stream
	type		= INTERNAL
	wait		= no
	socket_type	= stream
	flags		= IPv4
}</pre>

<p>
Finally run “/etc/init.d/xinetd restart” and your rdate-timeserver should be up and running.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;rdate server&quot;,&quot;hid&quot;:&quot;rdate_server&quot;,&quot;codeblockOffset&quot;:8,&quot;secid&quot;:8,&quot;range&quot;:&quot;7317-7888&quot;} -->
<h2 class="sectionedit9" id="testing_an_ntp_server">Testing an NTP Server</h2>
<div class="level2">

<p>
You can test any <abbr title="Network Time Protocol">NTP</abbr> server (including those in OpenWRT) by using the <code><strong>ntpdate</strong></code> utility, which is available in most Linux distributions. 
</p>
<pre class="code">ntpdate -q [OpenWRT IP Address]</pre>

<p>
This should return something like:
</p>
<pre class="code">server 192.168.1.1, stratum 2, offset -0.909611, delay 0.02853
30 Nov 00:43:21 ntpdate[44]: step time server 192.168.1.1 offset -0.909611 sec</pre>

<p>
If your system uses <strong><code>chrony</code></strong> instead of <strong><code>ntpdate</code></strong>, you need to add the server to your config file, even if you&#039;re just testing it. To do so:
</p>
<ol>
<li class="level1"><div class="li"> Add <code>server [OpenWRT <abbr title="Internet Protocol">IP</abbr>] iburst noselect</code> to your <code>chrony.config</code> - this will allow you to query the server, without using it to set system time.</div>
</li>
<li class="level1"><div class="li"> Run <code>chronyc ntpdata [OpenWRT <abbr title="Internet Protocol">IP</abbr>]</code> - this will return data about the <abbr title="Network Time Protocol">NTP</abbr> server. You may need to be root to execute this command.</div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Testing an NTP Server&quot;,&quot;hid&quot;:&quot;testing_an_ntp_server&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:9,&quot;range&quot;:&quot;7889-8734&quot;} -->
<h2 class="sectionedit10" id="troubleshooting">Troubleshooting</h2>
<div class="level2">

<p>
To enable syslog to show ntpd updates create <code>/etc/hotplug.d/ntp/20-ntpd-logger</code> and put the following into it. Restart ntpd with <code>/etc/init.d/sysntpd restart</code> and log updates will go to syslog.
</p>
<pre class="code bash"><span class="co0">#!/bin/sh</span>
<span class="br0">&#91;</span> <span class="re1">$ACTION</span> = <span class="st0">&quot;step&quot;</span> <span class="br0">&#93;</span>    <span class="sy0">&amp;&amp;</span> logger <span class="re5">-t</span> ntpd Time <span class="kw1">set</span>, <span class="re2">stratum</span>=<span class="re1">$stratum</span> <span class="re2">interval</span>=<span class="re1">$poll_interval</span> <span class="re2">offset</span>=<span class="re1">$offset</span>
<span class="br0">&#91;</span> <span class="re1">$ACTION</span> = <span class="st0">&quot;stratum&quot;</span> <span class="br0">&#93;</span> <span class="sy0">&amp;&amp;</span> logger <span class="re5">-t</span> ntpd Stratum change, <span class="re2">stratum</span>=<span class="re1">$stratum</span> <span class="re2">interval</span>=<span class="re1">$poll_interval</span> <span class="re2">offset</span>=<span class="re1">$offset</span></pre>

<p>
<strong>Log Output:</strong>
</p>
<pre class="code">Wed Jan  5 18:18:54 2022 user.notice ntpd: Stratum change, stratum=2 interval=2048 offset=0.007304
Wed Jan  5 18:18:54 2022 user.notice ntpd: Stratum change, stratum=3 interval=2048 offset=0.009748</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:10,&quot;range&quot;:&quot;8735-9446&quot;} -->
<h2 class="sectionedit11" id="notes">Notes</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Notes&quot;,&quot;hid&quot;:&quot;notes&quot;,&quot;codeblockOffset&quot;:11,&quot;secid&quot;:11,&quot;range&quot;:&quot;9447-&quot;} -->