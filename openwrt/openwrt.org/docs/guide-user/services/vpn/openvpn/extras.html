
<h1 class="sectionedit1" id="openvpn_extras">OpenVPN extras</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_info plugin_wrap">
<p>
This article relies on the following:
</p>
<ul>
<li class="level1"><div class="li"> Accessing <a href="/docs/guide-quick-start/walkthrough_login" class="wikilink1" title="docs:guide-quick-start:walkthrough_login" data-wiki-id="docs:guide-quick-start:walkthrough_login">web interface</a> / <a href="/docs/guide-quick-start/sshadministration" class="wikilink1" title="docs:guide-quick-start:sshadministration" data-wiki-id="docs:guide-quick-start:sshadministration">command-line interface</a></div>
</li>
<li class="level1"><div class="li"> Managing <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci">configs</a> / <a href="/docs/guide-user/additional-software/managing_packages" class="wikilink1" title="docs:guide-user:additional-software:managing_packages" data-wiki-id="docs:guide-user:additional-software:managing_packages">packages</a> / <a href="/docs/guide-user/base-system/managing_services" class="wikilink1" title="docs:guide-user:base-system:managing_services" data-wiki-id="docs:guide-user:base-system:managing_services">services</a> / <a href="/docs/guide-user/base-system/log.essentials" class="wikilink1" title="docs:guide-user:base-system:log.essentials" data-wiki-id="docs:guide-user:base-system:log.essentials">logs</a></div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;OpenVPN extras&quot;,&quot;hid&quot;:&quot;openvpn_extras&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-111&quot;} -->
<h2 class="sectionedit6" id="introduction">Introduction</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> This how-to describes the most common <a href="https://en.wikipedia.org/wiki/OpenVPN" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/OpenVPN">OpenVPN</a> tuning scenarios adapted for OpenWrt.</div>
</li>
<li class="level1"><div class="li"> Follow <a href="/docs/guide-user/services/vpn/openvpn/server" class="wikilink1" title="docs:guide-user:services:vpn:openvpn:server" data-wiki-id="docs:guide-user:services:vpn:openvpn:server">OpenVPN server</a> for server setup and <a href="/docs/guide-user/services/vpn/openvpn/client" class="wikilink1" title="docs:guide-user:services:vpn:openvpn:client" data-wiki-id="docs:guide-user:services:vpn:openvpn:client">OpenVPN client</a> for client setup.</div>
</li>
<li class="level1"><div class="li"> Follow <a href="/docs/guide-user/services/ddns/client" class="wikilink1" title="docs:guide-user:services:ddns:client" data-wiki-id="docs:guide-user:services:ddns:client">DDNS client</a> to use own server with dynamic <abbr title="Internet Protocol">IP</abbr> address.</div>
</li>
<li class="level1"><div class="li"> Follow <a href="/docs/guide-user/services/rng" class="wikilink1" title="docs:guide-user:services:rng" data-wiki-id="docs:guide-user:services:rng">Random generator</a> to overcome low entropy issues.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;112-616&quot;} -->
<h2 class="sectionedit7" id="extras">Extras</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Extras&quot;,&quot;hid&quot;:&quot;extras&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;617-635&quot;} -->
<h3 class="sectionedit8" id="references">References</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> <a href="https://openvpn.net/community-downloads/" class="urlextern" title="https://openvpn.net/community-downloads/" rel="ugc nofollow">OpenVPN for BSD/Linux/Windows</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/schwabe/ics-openvpn#openvpn-for-android" class="urlextern" title="https://github.com/schwabe/ics-openvpn#openvpn-for-android" rel="ugc nofollow">OpenVPN for Android</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://community.openvpn.net/" class="urlextern" title="https://community.openvpn.net/" rel="ugc nofollow">OpenVPN documentation</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;References&quot;,&quot;hid&quot;:&quot;references&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;636-884&quot;} -->
<h3 class="sectionedit9" id="web_interface">Web interface</h3>
<div class="level3">

<p>
If you want to manage <abbr title="Virtual Private Network">VPN</abbr> instances using web interface.
Install the necessary packages and provide <a href="/docs/guide-user/services/vpn/openvpn/extras#instance_management" class="wikilink1" title="docs:guide-user:services:vpn:openvpn:extras" data-wiki-id="docs:guide-user:services:vpn:openvpn:extras">instance management</a>.
</p>
<pre class="code bash"><span class="co0"># Install packages</span>
opkg update
opkg <span class="kw2">install</span> luci-app-openvpn
service rpcd restart</pre>

<p>
Navigate to <strong>LuCI → <abbr title="Virtual Private Network">VPN</abbr> → OpenVPN</strong> to manage OpenVPN instances.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Web interface&quot;,&quot;hid&quot;:&quot;web_interface&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;885-1270&quot;} -->
<h3 class="sectionedit10" id="instance_management">Instance management</h3>
<div class="level3">

<p>
If you need to manage multiple <abbr title="Virtual Private Network">VPN</abbr> instances or use web interface.
Configure <abbr title="Virtual Private Network">VPN</abbr> instances.
</p>
<pre class="code bash"><span class="co0"># Provide VPN instance management</span>
<span class="kw2">ls</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/*</span>.conf \
<span class="sy0">|</span> <span class="kw1">while</span> <span class="kw3">read</span> <span class="re5">-r</span> VPN_CONF
<span class="kw1">do</span> <span class="re2">VPN_ID</span>=<span class="st0">&quot;<span class="es4">$(basename ${VPN_CONF%.*} | sed -e &quot;s/\W/_/g&quot;)</span>&quot;</span>
uci <span class="re5">-q</span> delete openvpn.<span class="co1">${VPN_ID}</span>
uci <span class="kw1">set</span> openvpn.<span class="co1">${VPN_ID}</span>=<span class="st0">&quot;openvpn&quot;</span>
uci <span class="kw1">set</span> openvpn.<span class="co1">${VPN_ID}</span>.enabled=<span class="st0">&quot;1&quot;</span>
uci <span class="kw1">set</span> openvpn.<span class="co1">${VPN_ID}</span>.config=<span class="st0">&quot;<span class="es3">${VPN_CONF}</span>&quot;</span>
<span class="kw1">done</span>
uci commit openvpn
service openvpn restart</pre>

<p>
Be sure to specify a different <abbr title="Virtual Private Network">VPN</abbr> interface name for each instance.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Instance management&quot;,&quot;hid&quot;:&quot;instance_management&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:10,&quot;range&quot;:&quot;1271-1828&quot;} -->
<h3 class="sectionedit11" id="commercial_provider">Commercial provider</h3>
<div class="level3">

<p>
If you use a commercial <abbr title="Virtual Private Network">VPN</abbr> provider.
Set up credentials for username/password authentication.
</p>
<pre class="code bash"><span class="co0"># Save username/password credentials</span>
<span class="kw3">umask</span> <span class="re2">go</span>=
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>client.auth
USERNAME
PASSWORD
EOF
&nbsp;
<span class="co0"># Configure VPN service</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>client.conf
auth-user-pass client.auth
EOF
service openvpn restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Commercial provider&quot;,&quot;hid&quot;:&quot;commercial_provider&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:11,&quot;range&quot;:&quot;1829-2201&quot;} -->
<h3 class="sectionedit12" id="dynamic_connection">Dynamic connection</h3>
<div class="level3">

<p>
Set up <a href="/docs/guide-user/advanced/hotplug_extras" class="wikilink1" title="docs:guide-user:advanced:hotplug_extras" data-wiki-id="docs:guide-user:advanced:hotplug_extras">Hotplug extras</a> to restart <abbr title="Virtual Private Network">VPN</abbr> client upon reconnecting <abbr title="Wide Area Network">WAN</abbr> interface.
</p>
<pre class="code bash"><span class="co0"># Configure hotplug</span>
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>online
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>online<span class="sy0">/</span><span class="nu0">10</span>-openvpn
<span class="kw1">case</span> <span class="co1">${DEVICE}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>tun<span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">exit</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
service openvpn restart
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>sysupgrade.conf
<span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>online<span class="sy0">/</span><span class="nu0">10</span>-openvpn
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Dynamic connection&quot;,&quot;hid&quot;:&quot;dynamic_connection&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:12,&quot;range&quot;:&quot;2202-2614&quot;} -->
<h3 class="sectionedit13" id="dynamic_address">Dynamic address</h3>
<div class="level3">

<p>
Allow the peer to change its address/port.
</p>
<pre class="code bash"><span class="co0"># Configure VPN service</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>client.conf
float
EOF
service openvpn restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Dynamic address&quot;,&quot;hid&quot;:&quot;dynamic_address&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:13,&quot;range&quot;:&quot;2615-2802&quot;} -->
<h3 class="sectionedit14" id="network_interface">Network interface</h3>
<div class="level3">

<p>
If you want to set up <abbr title="Policy Based Routing">PBR</abbr>.
Declare the <abbr title="Virtual Private Network">VPN</abbr> interface.
</p>
<pre class="code bash">uci del_list firewall.wan.device=<span class="st0">&quot;tun+&quot;</span>
uci add_list firewall.wan.network=<span class="st0">&quot;vpn&quot;</span>
uci commit firewall
service firewall restart
uci <span class="re5">-q</span> delete network.vpn
uci <span class="kw1">set</span> network.vpn=<span class="st0">&quot;interface&quot;</span>
uci <span class="kw1">set</span> network.vpn.proto=<span class="st0">&quot;none&quot;</span>
uci <span class="kw1">set</span> network.vpn.device=<span class="st0">&quot;tun0&quot;</span>
uci commit network
service network restart</pre>

<p>
Be sure to resolve <a href="/docs/guide-user/services/vpn/openvpn/extras#dynamic_connection" class="wikilink1" title="docs:guide-user:services:vpn:openvpn:extras" data-wiki-id="docs:guide-user:services:vpn:openvpn:extras">race condition</a> with netifd service.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Network interface&quot;,&quot;hid&quot;:&quot;network_interface&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:14,&quot;range&quot;:&quot;2803-3322&quot;} -->
<h3 class="sectionedit15" id="static_addresses">Static addresses</h3>
<div class="level3">

<p>
Provide static <abbr title="Internet Protocol">IP</abbr> address allocation on <abbr title="Virtual Private Network">VPN</abbr> server assuming that:
</p>
<ul>
<li class="level1"><div class="li"> <code>192.168.9.0/24</code> - <abbr title="Virtual Private Network">VPN</abbr> network</div>
</li>
<li class="level1"><div class="li"> <code>fd00:9::/64</code> - <abbr title="Internet Protocol version 6">IPv6</abbr> <abbr title="Virtual Private Network">VPN</abbr> network</div>
</li>
</ul>
<pre class="code bash"><span class="kw3">umask</span> <span class="re2">go</span>=rx
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>ccd
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>ccd<span class="sy0">/</span>client
ifconfig-push 192.168.9.2 255.255.255.0
ifconfig-ipv6-push fd00:<span class="nu0">9</span>::<span class="nu0">2</span><span class="sy0">/</span><span class="nu0">64</span>
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>server.conf
client-config-dir ccd
EOF
service openvpn restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Static addresses&quot;,&quot;hid&quot;:&quot;static_addresses&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:15,&quot;range&quot;:&quot;3323-3754&quot;} -->
<h3 class="sectionedit16" id="site-to-site">Site-to-site</h3>
<div class="level3">

<p>
Implement plain routing between server side <abbr title="Local Area Network">LAN</abbr> and <a href="https://community.openvpn.net/openvpn/wiki/RoutedLans" class="urlextern" title="https://community.openvpn.net/openvpn/wiki/RoutedLans" rel="ugc nofollow">client side LAN</a> assuming that:
</p>
<ul>
<li class="level1"><div class="li"> <code>192.168.1.0/24</code> - server side <abbr title="Local Area Network">LAN</abbr></div>
</li>
<li class="level1"><div class="li"> <code>192.168.2.0/24</code> - client side <abbr title="Local Area Network">LAN</abbr></div>
</li>
</ul>

<p>
Add route to client side <abbr title="Local Area Network">LAN</abbr>, push route to server side <abbr title="Local Area Network">LAN</abbr>, selectively disable gateway redirection.
</p>
<pre class="code bash"><span class="kw3">umask</span> <span class="re2">go</span>=rx
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>ccd
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>ccd<span class="sy0">/</span>client
iroute 192.168.2.0 255.255.255.0
push-remove redirect-gateway
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>server.conf
client_config_dir ccd
route 192.168.2.0 255.255.255.0
push <span class="st0">&quot;route 192.168.1.0 255.255.255.0&quot;</span>
EOF
service openvpn restart</pre>

<p>
Consider <abbr title="Virtual Private Network">VPN</abbr> network as private and assign <abbr title="Virtual Private Network">VPN</abbr> interface to <abbr title="Local Area Network">LAN</abbr> zone on <abbr title="Virtual Private Network">VPN</abbr> client.
</p>
<pre class="code bash">uci del_list firewall.wan.device=<span class="st0">&quot;tun+&quot;</span>
uci add_list firewall.lan.device=<span class="st0">&quot;tun+&quot;</span>
uci commit firewall
service firewall restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Site-to-site&quot;,&quot;hid&quot;:&quot;site-to-site&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:16,&quot;range&quot;:&quot;3755-4658&quot;} -->
<h3 class="sectionedit17" id="default_gateway">Default gateway</h3>
<div class="level3">

<p>
If you do not need to route all traffic to <abbr title="Virtual Private Network">VPN</abbr>.
Disable gateway redirection on <abbr title="Virtual Private Network">VPN</abbr> client.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>client.conf
pull-filter ignore redirect-gateway
EOF</pre>

<p>
If you use a commercial <abbr title="Virtual Private Network">VPN</abbr> provider.
Ignore routes pushed by <abbr title="Virtual Private Network">VPN</abbr> server.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>client.conf
route-nopull
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Default gateway&quot;,&quot;hid&quot;:&quot;default_gateway&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:17,&quot;range&quot;:&quot;4659-5028&quot;} -->
<h3 class="sectionedit18" id="split_gateway">Split gateway</h3>
<div class="level3">

<p>
If <abbr title="Virtual Private Network">VPN</abbr> gateway is separate from your <abbr title="Local Area Network">LAN</abbr> gateway.
Implement plain routing between <abbr title="Local Area Network">LAN</abbr> and <abbr title="Virtual Private Network">VPN</abbr> networks assuming that:
</p>
<ul>
<li class="level1"><div class="li"> <code>192.168.1.0/24</code> - <abbr title="Local Area Network">LAN</abbr> network</div>
</li>
<li class="level1"><div class="li"> <code>192.168.1.2/24</code> - <abbr title="Virtual Private Network">VPN</abbr> gateway</div>
</li>
<li class="level1"><div class="li"> <code>192.168.9.0/24</code> - <abbr title="Virtual Private Network">VPN</abbr> network</div>
</li>
</ul>

<p>
Add port forwarding for <abbr title="Virtual Private Network">VPN</abbr> server on <abbr title="Local Area Network">LAN</abbr> gateway.
</p>
<pre class="code bash">uci <span class="re5">-q</span> delete firewall.ovpn
uci <span class="kw1">set</span> firewall.ovpn=<span class="st0">&quot;redirect&quot;</span>
uci <span class="kw1">set</span> firewall.ovpn.name=<span class="st0">&quot;Redirect-OpenVPN&quot;</span>
uci <span class="kw1">set</span> firewall.ovpn.src=<span class="st0">&quot;wan&quot;</span>
uci <span class="kw1">set</span> firewall.ovpn.src_dport=<span class="st0">&quot;1194&quot;</span>
uci <span class="kw1">set</span> firewall.ovpn.dest=<span class="st0">&quot;lan&quot;</span>
uci <span class="kw1">set</span> firewall.ovpn.dest_ip=<span class="st0">&quot;192.168.1.2&quot;</span>
uci <span class="kw1">set</span> firewall.ovpn.family=<span class="st0">&quot;ipv4&quot;</span>
uci <span class="kw1">set</span> firewall.ovpn.proto=<span class="st0">&quot;udp&quot;</span>
uci <span class="kw1">set</span> firewall.ovpn.target=<span class="st0">&quot;DNAT&quot;</span>
uci commit firewall
service firewall restart</pre>

<p>
Add route to <abbr title="Virtual Private Network">VPN</abbr> network via <abbr title="Virtual Private Network">VPN</abbr> gateway on <abbr title="Local Area Network">LAN</abbr> gateway.
</p>
<pre class="code bash">uci <span class="re5">-q</span> delete network.vpn
uci <span class="kw1">set</span> network.vpn=<span class="st0">&quot;route&quot;</span>
uci <span class="kw1">set</span> network.vpn.interface=<span class="st0">&quot;lan&quot;</span>
uci <span class="kw1">set</span> network.vpn.target=<span class="st0">&quot;192.168.9.0/24&quot;</span>
uci <span class="kw1">set</span> network.vpn.gateway=<span class="st0">&quot;192.168.1.2&quot;</span>
uci commit network
service network restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Split gateway&quot;,&quot;hid&quot;:&quot;split_gateway&quot;,&quot;codeblockOffset&quot;:11,&quot;secid&quot;:18,&quot;range&quot;:&quot;5029-6059&quot;} -->
<h3 class="sectionedit19" id="ipv6_gateway">IPv6 gateway</h3>
<div class="level3">

<p>
Set up <a href="/docs/guide-user/network/ipv6/ipv6_henet" class="wikilink1" title="docs:guide-user:network:ipv6:ipv6_henet" data-wiki-id="docs:guide-user:network:ipv6:ipv6_henet">IPv6 tunnel broker</a> or use <a href="/docs/guide-user/firewall/fw3_configurations/fw3_nat#ipv6_nat" class="wikilink1" title="docs:guide-user:firewall:fw3_configurations:fw3_nat" data-wiki-id="docs:guide-user:firewall:fw3_configurations:fw3_nat">IPv6 NAT or NPT</a> if necessary.
Enable <abbr title="Internet Protocol version 6">IPv6</abbr> tunnel on <abbr title="Virtual Private Network">VPN</abbr> server, offer <abbr title="Internet Protocol version 6">IPv6</abbr> <abbr title="Domain Name System">DNS</abbr>, redirect <abbr title="Internet Protocol version 6">IPv6</abbr> gateway.
</p>
<pre class="code bash"><span class="re2">VPN_POOL6</span>=<span class="st0">&quot;fd00:9::/64&quot;</span>
<span class="re2">VPN_DNS6</span>=<span class="st0">&quot;<span class="es3">${VPN_POOL6%:*}</span>:1&quot;</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>server.conf
proto udp6
server-ipv6 <span class="co1">${VPN_POOL6}</span>
push <span class="st0">&quot;dhcp-option DNS <span class="es3">${VPN_DNS6}</span>&quot;</span>
push <span class="st0">&quot;redirect-gateway ipv6&quot;</span>
EOF
service openvpn restart</pre>

<p>
Disable <a href="/docs/guide-user/network/ipv6/ipv6_extras#disabling_gua_prefix" class="wikilink1" title="docs:guide-user:network:ipv6:ipv6_extras" data-wiki-id="docs:guide-user:network:ipv6:ipv6_extras">ISP prefix delegation</a> to prevent <abbr title="Internet Protocol version 6">IPv6</abbr> leaks on <abbr title="Virtual Private Network">VPN</abbr> client.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;IPv6 gateway&quot;,&quot;hid&quot;:&quot;ipv6_gateway&quot;,&quot;codeblockOffset&quot;:13,&quot;secid&quot;:19,&quot;range&quot;:&quot;6060-6703&quot;} -->
<h3 class="sectionedit20" id="tcp">TCP</h3>
<div class="level3">

<p>
Use <a href="https://openvpn.net/faq/why-does-openvpn-use-udp-and-tcp/" class="urlextern" title="https://openvpn.net/faq/why-does-openvpn-use-udp-and-tcp/" rel="ugc nofollow">TCP</a> if necessary.
Beware of performance issues.
</p>
<pre class="code bash"><span class="re2">VPN_PROTO</span>=<span class="st0">&quot;tcp&quot;</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>server.conf
proto <span class="co1">${VPN_PROTO}</span>
proto <span class="co1">${VPN_PROTO}</span><span class="nu0">6</span>
EOF
service openvpn restart
uci <span class="kw1">set</span> firewall.ovpn.proto=<span class="st0">&quot;<span class="es3">${VPN_PROTO}</span>&quot;</span>
uci commit firewall
service firewall restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;TCP&quot;,&quot;hid&quot;:&quot;tcp&quot;,&quot;codeblockOffset&quot;:14,&quot;secid&quot;:20,&quot;range&quot;:&quot;6704-7063&quot;} -->
<h3 class="sectionedit21" id="bridging">Bridging</h3>
<div class="level3">

<p>
If you need to utilize <a href="https://openvpn.net/community-resources/ethernet-bridging/" class="urlextern" title="https://openvpn.net/community-resources/ethernet-bridging/" rel="ugc nofollow">bridging</a>.
Beware of compatibility issues.
</p>
<pre class="code bash"><span class="re2">VPN_ADDR</span>=<span class="st0">&quot;<span class="es4">$(uci -q get network.lan.ipaddr)</span>&quot;</span>
<span class="re2">VPN_MASK</span>=<span class="st0">&quot;<span class="es4">$(uci -q get network.lan.netmask)</span>&quot;</span>
<span class="re2">VPN_POOL</span>=<span class="st0">&quot;<span class="es3">${VPN_ADDR%.*}</span>.128 <span class="es3">${VPN_ADDR%.*}</span>.254&quot;</span>
<span class="re2">VPN_DNS</span>=<span class="st0">&quot;<span class="es3">${VPN_ADDR}</span>&quot;</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>server.conf
dev tap
server-bridge <span class="co1">${VPN_ADDR}</span> <span class="co1">${VPN_MASK}</span> <span class="co1">${VPN_POOL}</span>
push <span class="st0">&quot;dhcp-option DNS <span class="es3">${VPN_DNS}</span>&quot;</span>
EOF
service openvpn restart
uci <span class="re5">-q</span> delete firewall.lan.device
uci commit firewall
service firewall restart
uci add_list network.<span class="sy0">@</span>device<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.ports=<span class="st0">&quot;tap0&quot;</span>
uci commit network
service network restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Bridging&quot;,&quot;hid&quot;:&quot;bridging&quot;,&quot;codeblockOffset&quot;:15,&quot;secid&quot;:21,&quot;range&quot;:&quot;7064-7718&quot;} -->
<h3 class="sectionedit22" id="ipv6_windows_client">IPv6 Windows client</h3>
<div class="level3">

<p>
Fix <abbr title="Internet Protocol version 6">IPv6</abbr> routing for Windows desktop client.
</p>
<pre class="code bash"><span class="re2">NETSH_IPV6</span>=<span class="st0">&quot;C:\\\\Windows\\\\System32\\\\cmd.exe /c netsh interface ipv6&quot;</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>client.ovpn
script-security <span class="nu0">2</span>
up <span class="st_h">'${NETSH_IPV6} set privacy state=disabled store=active &amp; echo'</span>
ipchange <span class="st_h">'${NETSH_IPV6} set global randomizeidentifiers=disabled store=active &amp; echo'</span>
route-up <span class="st_h">'${NETSH_IPV6} delete route prefix=%ifconfig_ipv6_local%/%ifconfig_ipv6_netbits% interface=%dev_idx% store=active'</span>
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;IPv6 Windows client&quot;,&quot;hid&quot;:&quot;ipv6_windows_client&quot;,&quot;codeblockOffset&quot;:16,&quot;secid&quot;:22,&quot;range&quot;:&quot;7719-8226&quot;} -->
<h3 class="sectionedit23" id="dns_over_vpn">DNS over VPN</h3>
<div class="level3">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;docs:guide-user:services:vpn:wireguard:extras&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:24,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__docs:guide-user:services:vpn:wireguard:extras">
<div class="level3">

<p>
<a href="/docs/guide-user/base-system/dhcp_configuration#providing_dns_for_non-local_networks" class="wikilink1" title="docs:guide-user:base-system:dhcp_configuration" data-wiki-id="docs:guide-user:base-system:dhcp_configuration">Serve DNS</a> for <abbr title="Virtual Private Network">VPN</abbr> clients on OpenWrt server when using point-to-point topology.
</p>

<p>
Route <abbr title="Domain Name System">DNS</abbr> over <abbr title="Virtual Private Network">VPN</abbr> to prevent <abbr title="Domain Name System">DNS</abbr> leaks on <abbr title="Virtual Private Network">VPN</abbr> client.
</p>

<p>
<a href="/docs/guide-user/base-system/dhcp_configuration#upstream_dns_provider" class="wikilink1" title="docs:guide-user:base-system:dhcp_configuration" data-wiki-id="docs:guide-user:base-system:dhcp_configuration">Replace peer DNS</a> with public or <abbr title="Virtual Private Network">VPN</abbr>-specific <abbr title="Domain Name System">DNS</abbr> provider on OpenWrt client.
</p>

<p>
Modify the <abbr title="Virtual Private Network">VPN</abbr> connection using NetworkManager on Linux desktop client.
</p>
<pre class="code bash">nmcli connection modify <span class="kw2">id</span> VPN_CON \
ipv4.dns-search ~. ipv4.dns-priority <span class="re5">-50</span> \
ipv6.dns-search ~. ipv6.dns-priority <span class="re5">-50</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;docs:guide-user:services:vpn:wireguard:extras&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:25,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level3">

<p>
Modify the <abbr title="Virtual Private Network">VPN</abbr> client profile for Windows desktop client.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>client.ovpn
block-outside-dns
EOF</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;DNS over VPN&quot;,&quot;hid&quot;:&quot;dns_over_vpn&quot;,&quot;codeblockOffset&quot;:17,&quot;secid&quot;:23,&quot;range&quot;:&quot;8227-8493&quot;} -->
<h3 class="sectionedit26" id="dns_and_domain">DNS and domain</h3>
<div class="level3">

<p>
Use <abbr title="Domain Name System">DNS</abbr> and domain provided by <abbr title="Virtual Private Network">VPN</abbr> server on OpenWrt client.
</p>
<pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>net<span class="sy0">/</span><span class="nu0">10</span>-openvpn-resolv
<span class="kw1">case</span> <span class="co1">${INTERFACE}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>tun<span class="sy0">*</span><span class="br0">&#41;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw3">exit</span> <span class="nu0">0</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="re2">RES_FILE</span>=<span class="st0">&quot;<span class="es4">$(uci -q get dhcp.@dnsmasq[0].resolvfile)</span>&quot;</span>
<span class="kw1">case</span> <span class="co1">${ACTION}</span> <span class="kw1">in</span>
<span class="br0">&#40;</span>add<span class="br0">&#41;</span> <span class="re2">RES_FILE</span>=<span class="st0">&quot;<span class="es3">${RES_FILE%.*}</span>.vpn&quot;</span> <span class="sy0">;;</span>
<span class="br0">&#40;</span>remove<span class="br0">&#41;</span> <span class="re2">RES_FILE</span>=<span class="st0">&quot;<span class="es3">${RES_FILE%.*}</span>.auto&quot;</span> <span class="sy0">;;</span>
<span class="kw1">esac</span>
uci <span class="kw1">set</span> dhcp.<span class="sy0">@</span>dnsmasq<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.resolvfile=<span class="st0">&quot;<span class="es3">${RES_FILE}</span>&quot;</span>
service dnsmasq restart
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>openvpn<span class="sy0">/</span><span class="nu0">10</span>-resolv
<span class="re2">RES_FILE</span>=<span class="st0">&quot;<span class="es4">$(uci -q get dhcp.@dnsmasq[0].resolvfile)</span>&quot;</span>
<span class="kw2">env</span> <span class="sy0">|</span> <span class="kw2">sed</span> <span class="re5">-n</span> <span class="re5">-e</span> <span class="st0">&quot;
/^foreign_option_.*=dhcp-option.*DNS/s//nameserver/p
/^foreign_option_.*=dhcp-option.*DOMAIN/s//search/p
&quot;</span> <span class="sy0">|</span> <span class="kw2">sort</span> <span class="re5">-u</span> <span class="sy0">&gt;</span> <span class="st0">&quot;<span class="es3">${RES_FILE%.*}</span>.vpn&quot;</span>
EOF
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>sysupgrade.conf
<span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>net<span class="sy0">/</span><span class="nu0">10</span>-openvpn-resolv
<span class="sy0">/</span>etc<span class="sy0">/</span>hotplug.d<span class="sy0">/</span>openvpn<span class="sy0">/</span><span class="nu0">10</span>-resolv
EOF
service openvpn restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;DNS and domain&quot;,&quot;hid&quot;:&quot;dns_and_domain&quot;,&quot;codeblockOffset&quot;:19,&quot;secid&quot;:26,&quot;range&quot;:&quot;8494-9337&quot;} -->
<h3 class="sectionedit27" id="kill_switch">Kill switch</h3>
<div class="level3">

<p>
Prevent traffic leaks on OpenWrt client isolating <abbr title="Virtual Private Network">VPN</abbr> interface in a separate firewall zone.
</p>
<pre class="code bash">uci <span class="re5">-q</span> delete firewall.vpn
uci <span class="kw1">set</span> firewall.vpn=<span class="st0">&quot;zone&quot;</span>
uci <span class="kw1">set</span> firewall.vpn.name=<span class="st0">&quot;vpn&quot;</span>
uci <span class="kw1">set</span> firewall.vpn.input=<span class="st0">&quot;REJECT&quot;</span>
uci <span class="kw1">set</span> firewall.vpn.output=<span class="st0">&quot;ACCEPT&quot;</span>
uci <span class="kw1">set</span> firewall.vpn.forward=<span class="st0">&quot;REJECT&quot;</span>
uci <span class="kw1">set</span> firewall.vpn.masq=<span class="st0">&quot;1&quot;</span>
uci <span class="kw1">set</span> firewall.vpn.mtu_fix=<span class="st0">&quot;1&quot;</span>
uci add_list firewall.vpn.device=<span class="st0">&quot;tun+&quot;</span>
uci del_list firewall.wan.device=<span class="st0">&quot;tun+&quot;</span>
uci <span class="re5">-q</span> delete firewall.<span class="sy0">@</span>forwarding<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>
uci <span class="kw1">set</span> firewall.lan_vpn=<span class="st0">&quot;forwarding&quot;</span>
uci <span class="kw1">set</span> firewall.lan_vpn.src=<span class="st0">&quot;lan&quot;</span>
uci <span class="kw1">set</span> firewall.lan_vpn.dest=<span class="st0">&quot;vpn&quot;</span>
uci commit firewall
service firewall restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Kill switch&quot;,&quot;hid&quot;:&quot;kill_switch&quot;,&quot;codeblockOffset&quot;:20,&quot;secid&quot;:27,&quot;range&quot;:&quot;9338-10007&quot;} -->
<h3 class="sectionedit28" id="multi-client">Multi-client</h3>
<div class="level3">

<p>
Set up multi-client <abbr title="Virtual Private Network">VPN</abbr> server.
Use <a href="https://github.com/OpenVPN/easy-rsa#overview" class="urlextern" title="https://github.com/OpenVPN/easy-rsa#overview" rel="ugc nofollow">EasyRSA</a> to add clients or revoke their certificates via CRL.
</p>
<pre class="code bash"><span class="co0"># Add one more client</span>
easyrsa build-client-full client1 nopass
openvpn <span class="re5">--tls-crypt-v2</span> <span class="co1">${EASYRSA_PKI}</span><span class="sy0">/</span>private<span class="sy0">/</span>server.pem \
<span class="re5">--genkey</span> tls-crypt-v2-client <span class="co1">${EASYRSA_PKI}</span><span class="sy0">/</span>private<span class="sy0">/</span>client1.pem
&nbsp;
<span class="co0"># Revoke client certificate</span>
easyrsa revoke client
&nbsp;
<span class="co0"># Generate a CRL</span>
easyrsa gen-crl
&nbsp;
<span class="co0"># Enable CRL verification</span>
<span class="re2">VPN_PKI</span>=<span class="st0">&quot;/etc/easy-rsa/pki&quot;</span>
<span class="re2">VPN_CRL</span>=<span class="st0">&quot;<span class="es4">$(cat ${VPN_PKI}/crl.pem)</span>&quot;</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>openvpn<span class="sy0">/</span>server.conf
<span class="sy0">&lt;</span>crl-verify<span class="sy0">&gt;</span>
<span class="co1">${VPN_CRL}</span>
<span class="sy0">&lt;/</span>crl-verify<span class="sy0">&gt;</span>
EOF
service openvpn restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Multi-client&quot;,&quot;hid&quot;:&quot;multi-client&quot;,&quot;codeblockOffset&quot;:21,&quot;secid&quot;:28,&quot;range&quot;:&quot;10008-10665&quot;} -->
<h3 class="sectionedit29" id="automated">Automated</h3>
<div class="level3">

<p>
Automated <abbr title="Virtual Private Network">VPN</abbr> server installation and client profiles generation.
</p>
<pre class="code bash"><span class="re2">URL</span>=<span class="st0">&quot;https://openwrt.org/_export/code/docs/guide-user/services/vpn/openvpn/server&quot;</span>
<span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> EOF <span class="sy0">&gt;</span> openvpn-server.sh
$<span class="br0">&#40;</span><span class="kw2">wget</span> <span class="re5">-U</span> <span class="st0">&quot;&quot;</span> <span class="re5">-O</span> - <span class="st0">&quot;<span class="es3">${URL}</span>?codeblock=0&quot;</span><span class="br0">&#41;</span>
$<span class="br0">&#40;</span><span class="kw2">wget</span> <span class="re5">-U</span> <span class="st0">&quot;&quot;</span> <span class="re5">-O</span> - <span class="st0">&quot;<span class="es3">${URL}</span>?codeblock=1&quot;</span><span class="br0">&#41;</span>
$<span class="br0">&#40;</span><span class="kw2">wget</span> <span class="re5">-U</span> <span class="st0">&quot;&quot;</span> <span class="re5">-O</span> - <span class="st0">&quot;<span class="es3">${URL}</span>?codeblock=2&quot;</span><span class="br0">&#41;</span>
$<span class="br0">&#40;</span><span class="kw2">wget</span> <span class="re5">-U</span> <span class="st0">&quot;&quot;</span> <span class="re5">-O</span> - <span class="st0">&quot;<span class="es3">${URL}</span>?codeblock=3&quot;</span><span class="br0">&#41;</span>
EOF
<span class="kw2">sh</span> openvpn-server.sh</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Automated&quot;,&quot;hid&quot;:&quot;automated&quot;,&quot;codeblockOffset&quot;:22,&quot;secid&quot;:29,&quot;range&quot;:&quot;10666-&quot;} -->