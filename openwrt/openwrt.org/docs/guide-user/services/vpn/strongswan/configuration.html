
<h1 class="sectionedit1" id="strongswan_ipsec_configuration_via_uci">strongSwan IPsec Configuration via UCI</h1>
<div class="level1">

<p>
Linux Charon IPsec daemon can be configured through <code>/etc/config/ipsec</code>.
</p>

<p>
<strong>Note</strong>: this has been updated to the <code>swanctl</code>-based configuration, and is current as of <code>5.9.5</code> packaging.  For previous versions, use the Wiki&#039;s page history functionality.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;strongSwan IPsec Configuration via UCI&quot;,&quot;hid&quot;:&quot;strongswan_ipsec_configuration_via_uci&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-311&quot;} -->
<h2 class="sectionedit2" id="sections">Sections</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Sections&quot;,&quot;hid&quot;:&quot;sections&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;312-332&quot;} -->
<h3 class="sectionedit3" id="ipsec">ipsec</h3>
<div class="level3">
<div class="table sectionedit4"><table class="inline">
	<thead>
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Type</strong>  </td><th class="col1 leftalign"> Name    </th><th class="col2 leftalign"> Type    </th><th class="col3 leftalign"> Required  </th><th class="col4 leftalign"> Default  </th><th class="col5 leftalign"> Description                                                                                                       </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign"> option    </td><td class="col1 leftalign"> zone    </td><td class="col2 leftalign"> string  </td><td class="col3 leftalign"> no        </td><td class="col4 leftalign"> vpn      </td><td class="col5 leftalign"> Firewall zone. Has to match the defined <a href="/docs/guide-user/services/vpn/strongswan/firewall#zones" class="wikilink1" title="docs:guide-user:services:vpn:strongswan:firewall" data-wiki-id="docs:guide-user:services:vpn:strongswan:firewall">firewall zone</a>  </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> list      </td><td class="col1 leftalign"> interface  </td><td class="col2 leftalign"> string  </td><td class="col3 leftalign"> yes       </td><td class="col4 leftalign"> (none)   </td><td class="col5 leftalign"> Interface that accept <abbr title="Virtual Private Network">VPN</abbr> traffic (empty for all interfaces, multiple lines for several interfaces)               </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"> option    </td><td class="col1 leftalign"> debug   </td><td class="col2 leftalign"> number  </td><td class="col3 leftalign"> no        </td><td class="col4 leftalign"> 0        </td><td class="col5 leftalign"> Trace level: 0 is least verbose, 4 is most - logs visible from output of logread -f                               </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;349-1043&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;ipsec&quot;,&quot;hid&quot;:&quot;ipsec&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;333-1044&quot;} -->
<h3 class="sectionedit5" id="remote">remote</h3>
<div class="level3">

<p>
Contains tunnel definition.
</p>
<div class="table sectionedit6"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0">Name</th><th class="col1">Type</th><th class="col2">Required</th><th class="col3">Default</th><th class="col4">Description</th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">enabled</td><td class="col1">boolean</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">Configuration is enabled or not</td>
	</tr>
	<tr class="row2">
		<td class="col0">gateway</td><td class="col1">ipaddr</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4"><abbr title="Internet Protocol">IP</abbr> address or <abbr title="Fully Qualified Domain Name">FQDN</abbr> name of the tunnel remote endpoint, or permitted subnets that peers can initiate this configuration from (analogue to local_leftip)</td>
	</tr>
	<tr class="row3">
		<td class="col0">local_gateway</td><td class="col1">ipaddr</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4"><abbr title="Internet Protocol">IP</abbr> address or <abbr title="Fully Qualified Domain Name">FQDN</abbr> of the tunnel local endpoint</td>
	</tr>
	<tr class="row4">
		<td class="col0">local_sourceip</td><td class="col1">ipaddr</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Virtual <abbr title="Internet Protocol">IP</abbr>(s) to request in IKEv2 configuration payloads requests, or in IKEv1 mode config (enables sending them/initiating it instead of quick mode)</td>
	</tr>
	<tr class="row5">
		<td class="col0">local_ip</td><td class="col1">ipaddr</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Local address(es) to use in IKE negotiation when initiating; for responding, enumerates addresses we can negotiate from (and may by subnets or CIDRs)</td>
	</tr>
	<tr class="row6">
		<td class="col0">local_identifier</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Local identifier for IKE (phase 1)</td>
	</tr>
	<tr class="row7">
		<td class="col0">remote_identifier</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Remote identifier for IKE (phase 1)</td>
	</tr>
	<tr class="row8">
		<td class="col0">authentication_method</td><td class="col1">string</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">IKE authentication (phase 1). Only allowed value ath the moment is psk</td>
	</tr>
	<tr class="row9">
		<td class="col0">pre_shared_key</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">The preshared key for the tunnel if authentication is psk</td>
	</tr>
	<tr class="row10">
		<td class="col0">crypto_proposal</td><td class="col1">list</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">List of IKE (phase 1) proposals to use for authentication (see below)</td>
	</tr>
	<tr class="row11">
		<td class="col0">tunnel</td><td class="col1">list</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">Name of ESP/AH (phase 2) section (see below)</td>
	</tr>
	<tr class="row12">
		<td class="col0">keyingtries</td><td class="col1">integer</td><td class="col2">no</td><td class="col3">3</td><td class="col4">Number of retransmissions to attempt during initial negotiation</td>
	</tr>
	<tr class="row13">
		<td class="col0">dpddelay</td><td class="col1">interval</td><td class="col2">no</td><td class="col3">30s</td><td class="col4">Liveness interval for IKE</td>
	</tr>
	<tr class="row14">
		<td class="col0">encap</td><td class="col1">boolean</td><td class="col2">no</td><td class="col3">false</td><td class="col4">Force <abbr title="User Datagram Protocol">UDP</abbr> encapsulation of ESP packets to work around blocking of ESP packets.</td>
	</tr>
	<tr class="row15">
		<td class="col0">inactivity</td><td class="col1">interval</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Interval before closing an inactive CHILD_SA</td>
	</tr>
	<tr class="row16">
		<td class="col0">fragmentation</td><td class="col1">string</td><td class="col2">no</td><td class="col3">yes</td><td class="col4">Use IKE fragmentation (maybe “yes”, “accept”, “force”, or “no”)</td>
	</tr>
	<tr class="row17">
		<td class="col0">mobike</td><td class="col1">string</td><td class="col2">no</td><td class="col3">yes</td><td class="col4">Enable MOBIKE on IKEv2</td>
	</tr>
	<tr class="row18">
		<td class="col0">local_cert</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">List of cert pathnames to use for authentication</td>
	</tr>
	<tr class="row19">
		<td class="col0">local_key</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">List of private key pathnames to use with above certificates</td>
	</tr>
	<tr class="row20">
		<td class="col0">ca_cert</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">List of names of CA certificates that need to lie in remote peer&#039;s certificate&#039;s path of trust</td>
	</tr>
	<tr class="row21">
		<td class="col0">rekeytime</td><td class="col1">interval</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">IKEv2 interval to refresh keying material; also used to compute lifetime</td>
	</tr>
	<tr class="row22">
		<td class="col0">overtime</td><td class="col1">interval</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Limit on time to complete rekeying/reauthentication (defaults to 10% of rekeytime)</td>
	</tr>
	<tr class="row23">
		<td class="col0">send_cert</td><td class="col1">string</td><td class="col2">no</td><td class="col3">ifasked</td><td class="col4">Send certificate payloads when using certificate authentication. (“always”, “ifasked”, “never”)</td>
	</tr>
	<tr class="row24">
		<td class="col0">send_certreq</td><td class="col1">boolean</td><td class="col2">no</td><td class="col3">no</td><td class="col4">Send certificate request payloads to offer trusted root CA certificates to the peer.</td>
	</tr>
	<tr class="row25">
		<td class="col0">keyexchange</td><td class="col1">string</td><td class="col2">no</td><td class="col3">ikev2</td><td class="col4">Version of IKE to negotiation (“ikev1”, “ikev2”, or “ike” for both)</td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table1&quot;,&quot;secid&quot;:6,&quot;range&quot;:&quot;1091-3648&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;remote&quot;,&quot;hid&quot;:&quot;remote&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;1045-3649&quot;} -->
<h3 class="sectionedit7" id="crypto_proposal">crypto_proposal</h3>
<div class="level3">

<p>
Definition of encryption proposals. Derived from <a href="https://wiki.strongswan.org/projects/strongswan/wiki/IKEv2CipherSuites" class="urlextern" title="https://wiki.strongswan.org/projects/strongswan/wiki/IKEv2CipherSuites" rel="ugc nofollow">strongSwan cipher suites</a>
</p>
<div class="table sectionedit8"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0">Name</th><th class="col1">Type</th><th class="col2">Required</th><th class="col3">Default</th><th class="col4">Description</th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">encryption_algorithm</td><td class="col1">string</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">Encryption method (aes128, aes192, aes256, 3des)</td>
	</tr>
	<tr class="row2">
		<td class="col0">hash_algorithm</td><td class="col1">string</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">Hash algorithm (md5, sha1, sha2, ...) not permitted when an AEAD algorithm is used </td>
	</tr>
	<tr class="row3">
		<td class="col0">dh_group</td><td class="col1">string</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">Diffie-Hellman exponentiation (modp768, modp1024, ...)</td>
	</tr>
	<tr class="row4">
		<td class="col0">prf_algorithm</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Pseudo-Random Functions to use with IKE (prfmd5, prfsha1, prfsha256, ...); not applicable to ESP</td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table2&quot;,&quot;secid&quot;:8,&quot;range&quot;:&quot;3826-4289&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;crypto_proposal&quot;,&quot;hid&quot;:&quot;crypto_proposal&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;3650-4290&quot;} -->
<h3 class="sectionedit9" id="tunnel">tunnel</h3>
<div class="level3">

<p>
Contains network defintion per tunnel.
</p>
<div class="table sectionedit10"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0">Name</th><th class="col1">Type</th><th class="col2">Required</th><th class="col3">Default</th><th class="col4">Description</th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">local_subnet</td><td class="col1">list</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">Local network(s) one per line</td>
	</tr>
	<tr class="row2">
		<td class="col0">remote_subnet</td><td class="col1">list</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">Remote network(s) one per line</td>
	</tr>
	<tr class="row3">
		<td class="col0">local_nat</td><td class="col1">subnet</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4"><abbr title="Network Address Translation">NAT</abbr> range for tunnels with <a href="/docs/guide-user/services/vpn/strongswan/overlappingsubnets" class="wikilink1" title="docs:guide-user:services:vpn:strongswan:overlappingsubnets" data-wiki-id="docs:guide-user:services:vpn:strongswan:overlappingsubnets">overlapping IP addresses</a></td>
	</tr>
	<tr class="row4">
		<td class="col0">crypto_proposal</td><td class="col1">list</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">List of ESP (phase two) proposals</td>
	</tr>
	<tr class="row5">
		<td class="col0">startaction</td><td class="col1">string</td><td class="col2">no</td><td class="col3">route</td><td class="col4">Action on initial configuration load (none, start, route)</td>
	</tr>
	<tr class="row6">
		<td class="col0">updown</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Path to script to run on CHILD_SA up/down events</td>
	</tr>
	<tr class="row7">
		<td class="col0">lifetime</td><td class="col1">interval</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Maximum duration of the CHILD_SA before closing (defaults to 110% of rekeytime)</td>
	</tr>
	<tr class="row8">
		<td class="col0">rekeytime</td><td class="col1">interval</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Duration of the CHILD_SA before rekeying</td>
	</tr>
	<tr class="row9">
		<td class="col0">dpdaction</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Action done when DPD timeout occurs (may be “none”, “clear”, “hold”, “restart”, “trap”, or “start”)</td>
	</tr>
	<tr class="row10">
		<td class="col0">closeaction</td><td class="col1">string</td><td class="col2">no</td><td class="col3">route</td><td class="col4">Action done when CHILD_SA is closed (may be “add”, “route”, “start”, “none”, or “trap”)</td>
	</tr>
	<tr class="row11">
		<td class="col0">if_id</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">XFRM interface ID set on input and output interfaces (should be coordinated with “ifid” values in route entries on “xfrm” interfaces)</td>
	</tr>
	<tr class="row12">
		<td class="col0">priority</td><td class="col1">string</td><td class="col2">no</td><td class="col3">(none)</td><td class="col4">Priority of the CHILD_SA</td>
	</tr>
	<tr class="row13">
		<td class="col0">ipcomp</td><td class="col1">bool</td><td class="col2">no</td><td class="col3">false</td><td class="col4">Enable ipcomp compression</td>
	</tr>
	<tr class="row14">
		<td class="col0">hw_offload</td><td class="col1">bool</td><td class="col2">no</td><td class="col3">false</td><td class="col4">Enable H/W offload</td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table3&quot;,&quot;secid&quot;:10,&quot;range&quot;:&quot;4348-5623&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;tunnel&quot;,&quot;hid&quot;:&quot;tunnel&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;4291-5624&quot;} -->
<h3 class="sectionedit11" id="mschapv2_secrets">mschapv2_secrets</h3>
<div class="level3">

<p>
Contains <a href="https://docs.strongswan.org/docs/latest/interop/windowsEapServerConf.html#_eap_secrets" class="urlextern" title="https://docs.strongswan.org/docs/latest/interop/windowsEapServerConf.html#_eap_secrets" rel="ugc nofollow">EAP secrets</a> for authentication.
</p>
<div class="table sectionedit12"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0">Name</th><th class="col1">Type</th><th class="col2">Required</th><th class="col3">Default</th><th class="col4">Description</th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">id</td><td class="col1">string</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">EAP ID (i.e. Username)</td>
	</tr>
	<tr class="row2">
		<td class="col0">secret</td><td class="col1">string</td><td class="col2">yes</td><td class="col3">(none)</td><td class="col4">EAP Secret (i.e. Password)</td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table4&quot;,&quot;secid&quot;:12,&quot;range&quot;:&quot;5785-5925&quot;} -->
<p>
Local configuration for <code>/etc/config/ipsec</code>:
</p>
<pre class="code bash">config <span class="st_h">'ipsec'</span>
  <span class="co0"># useful so traffic isn't sourced from internal addresses,</span>
  <span class="co0"># which would then requiring NATting and port 4500, etc.</span>
  list <span class="st_h">'interface'</span> <span class="st_h">'wan'</span>
  option <span class="st_h">'zone'</span> <span class="st_h">'vpn'</span>
&nbsp;
config <span class="st_h">'remote'</span> <span class="st_h">'acme'</span>
  option <span class="st_h">'enabled'</span> <span class="st_h">'1'</span>
  <span class="co0"># address of wan device</span>
  option <span class="st_h">'local_ip'</span> <span class="st_h">'6.6.6.6'</span>
  <span class="co0"># peer has routable DHCP'd address which changes</span>
  option <span class="st_h">'gateway'</span> <span class="st_h">'any'</span>
  option <span class="st_h">'authentication_method'</span> <span class="st_h">'pubkey'</span>
  option <span class="st_h">'local_identifier'</span> <span class="st_h">'C=US, O=Acme Corporation, CN=headquarters'</span>
  option <span class="st_h">'remote_identifier'</span> <span class="st_h">'C=US, O=Acme Corporation, CN=soho'</span>
  option <span class="st_h">'local_cert'</span> <span class="st_h">'headquarters.crt'</span>
  option <span class="st_h">'local_key'</span> <span class="st_h">'headquarters.key'</span>
  option <span class="st_h">'ca_cert'</span> <span class="st_h">'acme.crt'</span>
  option <span class="st_h">'rekeytime'</span> <span class="st_h">'4h'</span>
  option <span class="st_h">'keyingtries'</span> <span class="st_h">'0'</span>
  option <span class="st_h">'mobike'</span> <span class="st_h">'0'</span>
  option <span class="st_h">'fragmentation'</span> <span class="st_h">'1'</span>
  list   <span class="st_h">'crypto_proposal'</span> <span class="st_h">'ike_proposal'</span>
  list   <span class="st_h">'tunnel'</span> <span class="st_h">'tun_soho'</span>
&nbsp;
config <span class="st_h">'crypto_proposal'</span> <span class="st_h">'ike_proposal'</span>
  option <span class="st_h">'encryption_algorithm'</span> <span class="st_h">'aes256gcm'</span>
  <span class="co0"># no hash_algorithm allowed with AEAD</span>
  option <span class="st_h">'dh_group'</span> <span class="st_h">'modp3072'</span>
  option prf_algorithm <span class="st_h">'prfsha512'</span>
&nbsp;
<span class="co0"># we don't specify subnets because we're going to use XFRM-interfaced based routes instead</span>
config <span class="st_h">'tunnel'</span> <span class="st_h">'tun_soho'</span>
  list   <span class="st_h">'local_subnet'</span> <span class="st_h">'0.0.0.0/0'</span>
  list   <span class="st_h">'remote_subnet'</span> <span class="st_h">'0.0.0.0/0'</span>
  option <span class="st_h">'if_id'</span> <span class="st_h">'357'</span>
  option <span class="st_h">'rekeytime'</span> <span class="st_h">'1h'</span>
  <span class="co0"># other end is behind NAT or we'd use 'route' to initiate</span>
  option <span class="st_h">'startaction'</span> <span class="st_h">'none'</span>
  option <span class="st_h">'closeaction'</span> <span class="st_h">'none'</span>
  list   <span class="st_h">'crypto_proposal'</span> <span class="st_h">'esp_proposal'</span>
&nbsp;
config <span class="st_h">'crypto_proposal'</span> <span class="st_h">'esp_proposal'</span>
  option <span class="st_h">'encryption_algorithm'</span> <span class="st_h">'aes256gcm'</span>
  <span class="co0"># no hash_algorithm with allowed with AEAD</span>
  option <span class="st_h">'dh_group'</span> <span class="st_h">'modp3072'</span></pre>

<p>
and to support XFRM-based interfaces with associated routing, we put the following into <code>/etc/config/network</code>:
</p>
<pre class="code bash">config <span class="st_h">'interface'</span> <span class="st_h">'xfrm0'</span>
  option <span class="st_h">'ifid'</span> <span class="st_h">'357'</span>
  option <span class="st_h">'tunlink'</span> <span class="st_h">'wan'</span>
  option <span class="st_h">'mtu'</span> <span class="st_h">'1438'</span>
  option <span class="st_h">'zone'</span> <span class="st_h">'vpn'</span>
  option <span class="st_h">'proto'</span> <span class="st_h">'xfrm'</span>
  <span class="co0"># useful if you want to run Bonjour/mDNS across VPN tunnels</span>
  option <span class="st_h">'multicast'</span> <span class="st_h">'true'</span>
&nbsp;
config <span class="st_h">'interface'</span> <span class="st_h">'xfrm0_s'</span>
  option <span class="st_h">'ifname'</span> <span class="st_h">'@xfrm0'</span>
  option <span class="st_h">'proto'</span> <span class="st_h">'static'</span>
  option <span class="st_h">'ipaddr'</span> <span class="st_h">'192.168.254.1/30'</span>
&nbsp;
config <span class="st_h">'route'</span>
  option <span class="st_h">'interface'</span> <span class="st_h">'xfrm0'</span>
  option <span class="st_h">'target'</span> <span class="st_h">'192.168.10.0/24'</span>
  option <span class="st_h">'source'</span> <span class="st_h">'192.168.1.1'</span></pre>

<p>
Lastly, <code>/etc/config/firewall</code> requires:
</p>
<pre class="code bash">config <span class="st_h">'zone'</span>
  option <span class="st_h">'name'</span> <span class="st_h">'vpn'</span>
  option <span class="st_h">'network'</span> <span class="st_h">'xfrm0'</span>
  option <span class="st_h">'input'</span> <span class="st_h">'ACCEPT'</span>
  option <span class="st_h">'output'</span> <span class="st_h">'ACCEPT'</span>
  option <span class="st_h">'forward'</span> <span class="st_h">'ACCEPT'</span>
  option <span class="st_h">'mtu_fix'</span> <span class="st_h">'1'</span>
&nbsp;
config <span class="st_h">'forwarding'</span>
  option <span class="st_h">'src'</span> <span class="st_h">'lan'</span>
  option <span class="st_h">'dest'</span> <span class="st_h">'vpn'</span>
&nbsp;
config <span class="st_h">'forwarding'</span>
  option <span class="st_h">'src'</span> <span class="st_h">'vpn'</span>
  option <span class="st_h">'dest'</span> <span class="st_h">'lan'</span>
&nbsp;
config <span class="st_h">'rule'</span>
  option <span class="st_h">'name'</span> <span class="st_h">'Allow-IPSec-ESP'</span>
  option <span class="st_h">'src'</span> <span class="st_h">'wan'</span>
  option <span class="st_h">'proto'</span> <span class="st_h">'esp'</span>
  option <span class="st_h">'family'</span> <span class="st_h">'ipv4'</span>
  option <span class="st_h">'target'</span> <span class="st_h">'ACCEPT'</span>
&nbsp;
config <span class="st_h">'rule'</span>
  option <span class="st_h">'name'</span> <span class="st_h">'Allow-ISP-ISAKMP'</span>
  option <span class="st_h">'src'</span> <span class="st_h">'wan'</span>
  option <span class="st_h">'src_port'</span> <span class="st_h">'500'</span>
  option <span class="st_h">'dest_port'</span> <span class="st_h">'500'</span>
  option <span class="st_h">'proto'</span> <span class="st_h">'udp'</span>
  option <span class="st_h">'family'</span> <span class="st_h">'ipv4'</span>
  option <span class="st_h">'target'</span> <span class="st_h">'ACCEPT'</span></pre>

<p>
Lastly generate the certificates for both ends on the hub:
</p>
<pre class="code bash"><span class="co4">root@HQ:~# </span>gencerts <span class="re5">-s</span> US acme.com <span class="st0">&quot;Acme Corporation&quot;</span> headquarters soho
Generated <span class="kw2">as</span> headquarters-certs.tar.gz
Generated <span class="kw2">as</span> soho-certs.tar.gz
<span class="co4">root@HQ:~# </span><span class="kw2">tar</span> ztvf headquarters-certs.tar.gz 
<span class="re5">-r--r--r--</span> <span class="nu0">0</span><span class="sy0">/</span><span class="nu0">0</span>      <span class="nu0">1870</span> <span class="nu0">2021</span>-06-<span class="nu0">17</span> <span class="nu0">19</span>:01:<span class="nu0">38</span> swanctl<span class="sy0">/</span>x509ca<span class="sy0">/</span>acme.crt
<span class="re5">-r--r--r--</span> <span class="nu0">0</span><span class="sy0">/</span><span class="nu0">0</span>      <span class="nu0">1923</span> <span class="nu0">2021</span>-06-<span class="nu0">17</span> <span class="nu0">19</span>:01:<span class="nu0">53</span> swanctl<span class="sy0">/</span>x509<span class="sy0">/</span>headquarters.crt
<span class="re5">-r--------</span> <span class="nu0">0</span><span class="sy0">/</span><span class="nu0">0</span>      <span class="nu0">3243</span> <span class="nu0">2021</span>-06-<span class="nu0">17</span> <span class="nu0">19</span>:01:<span class="nu0">53</span> swanctl<span class="sy0">/</span>private<span class="sy0">/</span>headquarters.key
<span class="co4">root@HQ:~# </span><span class="kw2">tar</span> ztvf soho-certs.tar.gz 
<span class="re5">-r--r--r--</span> <span class="nu0">0</span><span class="sy0">/</span><span class="nu0">0</span>      <span class="nu0">1870</span> <span class="nu0">2021</span>-06-<span class="nu0">17</span> <span class="nu0">19</span>:01:<span class="nu0">38</span> swanctl<span class="sy0">/</span>x509ca<span class="sy0">/</span>acme.crt
<span class="re5">-r--r--r--</span> <span class="nu0">0</span><span class="sy0">/</span><span class="nu0">0</span>      <span class="nu0">1903</span> <span class="nu0">2021</span>-06-<span class="nu0">17</span> <span class="nu0">19</span>:02:04 swanctl<span class="sy0">/</span>x509<span class="sy0">/</span>soho.crt
<span class="re5">-r--------</span> <span class="nu0">0</span><span class="sy0">/</span><span class="nu0">0</span>      <span class="nu0">3243</span> <span class="nu0">2021</span>-06-<span class="nu0">17</span> <span class="nu0">19</span>:02:04 swanctl<span class="sy0">/</span>private<span class="sy0">/</span>soho.key
<span class="co4">root@HQ:~# </span></pre>

<p>
Note that the filenames in <code>headquarters.tar.gz</code> correspond to <code>local_cert</code>, <code>local_key</code>, and <code>ca_cert</code> above.  Similarly, the certificate&#039;s subject corresponds to the <code>local_identifier</code>:
</p>
<pre class="code bash"><span class="co4">root@HQ:~# </span>openssl x509 <span class="re5">-in</span> <span class="sy0">/</span>etc<span class="sy0">/</span>swanctl<span class="sy0">/</span>x509<span class="sy0">/</span>headquarters.crt <span class="re5">-noout</span> <span class="re5">-subject</span>
<span class="re2">subject</span>=C = US, O = Acme Corporation, CN = headquarters
<span class="co4">root@OpenWrt2:~# </span></pre>

<p>
As these files are present on the headquarters firewall already, you can remove <code>headquarters.tar.gz</code>.  You can also remove:
</p>
<pre class="code bash"><span class="sy0">/</span>etc<span class="sy0">/</span>swanctl<span class="sy0">/</span>x509<span class="sy0">/</span>soho.crt
<span class="sy0">/</span>etc<span class="sy0">/</span>swanctl<span class="sy0">/</span>private<span class="sy0">/</span>soho.key</pre>

<p>
as these are only needed on the remote end (SoHo).
</p>

<p>
Now copy the <code>soho-certs.tar.gz</code> file over to the SoHo router, and unpack it with:
</p>
<pre class="code bash"><span class="co4">root@SoHo:~# </span><span class="kw2">tar</span> <span class="re5">-zxf</span> soho-certs.tar.gz <span class="re5">-C</span> <span class="sy0">/</span>etc</pre>

<p>
Lastly, configure <code>/etc/config/ipsec</code> on the SoHo router:
</p>
<pre class="code bash">config <span class="st_h">'ipsec'</span>
  option <span class="st_h">'zone'</span> <span class="st_h">'vpn'</span>
  listen <span class="st_h">'interface'</span> <span class="st_h">'wan'</span>
&nbsp;
config <span class="st_h">'remote'</span> <span class="st_h">'headquarters'</span>
  option <span class="st_h">'enabled'</span> <span class="st_h">'1'</span>
  option <span class="st_h">'local_ip'</span> <span class="st_h">'%any'</span>
  option <span class="st_h">'gateway'</span> <span class="st_h">'6.6.6.6'</span>
  option <span class="st_h">'local_identifier'</span> <span class="st_h">'C=US, O=Acme Corporation, CN=soho'</span>
  option <span class="st_h">'remote_identifier'</span> <span class="st_h">'C=US, O=Acme Corporation, CN=headquarters'</span>
  option <span class="st_h">'authentication_method'</span> <span class="st_h">'pubkey'</span>
  option <span class="st_h">'fragmentation'</span> <span class="st_h">'1'</span>
  option <span class="st_h">'local_cert'</span> <span class="st_h">'soho.crt'</span>
  option <span class="st_h">'local_key'</span> <span class="st_h">'soho.key'</span>
  option <span class="st_h">'ca_cert'</span> <span class="st_h">'acme.crt'</span>
  option <span class="st_h">'rekeytime'</span> <span class="st_h">'4h'</span>
  option <span class="st_h">'keyingtries'</span> <span class="st_h">'0'</span>
  option <span class="st_h">'mobike'</span> <span class="nu0">0</span>
  list <span class="st_h">'crypto_proposal'</span> <span class="st_h">'ike_proposal'</span>
  list <span class="st_h">'tunnel'</span> <span class="st_h">'tun_headquarters'</span>
&nbsp;
config <span class="st_h">'crypto_proposal'</span> <span class="st_h">'ike_proposal'</span>
  option <span class="st_h">'encryption_algorithm'</span> <span class="st_h">'aes256gcm128'</span>
  <span class="co0"># no hash_algorithm allowed with AEAD</span>
  option <span class="st_h">'dh_group'</span> <span class="st_h">'modp3072'</span>
  option <span class="st_h">'prf_algorithm'</span> <span class="st_h">'prfsha512'</span>
&nbsp;
config tunnel <span class="st_h">'tun_headquarters'</span>
  list   <span class="st_h">'local_subnet'</span> <span class="st_h">'0.0.0.0/0'</span>
  list   <span class="st_h">'remote_subnet'</span> <span class="st_h">'0.0.0.0/0'</span>
  option <span class="st_h">'if_id'</span> <span class="st_h">'308'</span>
  option <span class="st_h">'rekeytime'</span> <span class="st_h">'1h'</span>
  option <span class="st_h">'startaction'</span> <span class="st_h">'trap'</span>
  option <span class="st_h">'closeaction'</span> <span class="st_h">'none'</span>
  option <span class="st_h">'dpdaction'</span> <span class="st_h">'restart'</span>
  list <span class="st_h">'crypto_proposal'</span> <span class="st_h">'esp_proposal'</span>
&nbsp;
config <span class="st_h">'crypto_proposal'</span> <span class="st_h">'esp_proposal'</span>
  option <span class="st_h">'encryption_algorithm'</span> <span class="st_h">'aes256gcm128'</span>
  <span class="co0"># no hash_algorithm allowed with AEAD</span>
  option <span class="st_h">'dh_group'</span> <span class="st_h">'modp3072'</span></pre>

<p>
Now modify <code>/etc/config/firewall</code> as above, and <code>/etc/config/network</code> as:
</p>
<pre class="code bash">config <span class="st_h">'interface'</span> <span class="st_h">'xfrm0'</span>
  option <span class="st_h">'ifid'</span> <span class="st_h">'308'</span>
  option <span class="st_h">'tunlink'</span> <span class="st_h">'wan'</span>
  option <span class="st_h">'mtu'</span> <span class="st_h">'1438'</span>
  option <span class="st_h">'zone'</span> <span class="st_h">'vpn'</span>
  option <span class="st_h">'proto'</span> <span class="st_h">'xfrm'</span>
  <span class="co0"># useful if you want to run Bonjour/mDNS across VPN tunnels</span>
  option <span class="st_h">'multicast'</span> <span class="st_h">'true'</span>
&nbsp;
config <span class="st_h">'interface'</span> <span class="st_h">'xfrm0_s'</span>
  option <span class="st_h">'ifname'</span> <span class="st_h">'@xfrm0'</span>
  option <span class="st_h">'proto'</span> <span class="st_h">'static'</span>
  option <span class="st_h">'ipaddr'</span> <span class="st_h">'192.168.254.2/30'</span>
&nbsp;
config <span class="st_h">'route'</span>
  option <span class="st_h">'interface'</span> <span class="st_h">'xfrm0'</span>
  option <span class="st_h">'target'</span> <span class="st_h">'192.168.1.0/24'</span>
  <span class="co0"># assuming lan has the address 192.168.10.1/24</span>
  option <span class="st_h">'source'</span> <span class="st_h">'192.168.10.1'</span></pre>

<p>
And when this is all done, on both ends do:
</p>
<pre class="code bash"><span class="co4">root@HQ:~# </span><span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>swanctl <span class="kw3">enable</span>
<span class="co4">root@HQ:~# </span><span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>swanctl restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;mschapv2_secrets&quot;,&quot;hid&quot;:&quot;mschapv2_secrets&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:11,&quot;range&quot;:&quot;5625-&quot;} -->