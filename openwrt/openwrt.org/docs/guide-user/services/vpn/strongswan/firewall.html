
<h1 class="sectionedit1" id="ipsec_firewall">IPsec Firewall</h1>
<div class="level1">

<p>
When configuring firewalls, tunnels and zones we always have to keep security in mind. First rule should be: Everything that is not allowed explicitly should be denied automatically. This article provides an easy but quite powerful security concept for your IPsec <abbr title="Virtual Private Network">VPN</abbr> setup. If you missed the <a href="/docs/guide-user/services/vpn/strongswan/basics" class="wikilink1" title="docs:guide-user:services:vpn:strongswan:basics" data-wiki-id="docs:guide-user:services:vpn:strongswan:basics">basics</a> please have look over there first.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;IPsec Firewall&quot;,&quot;hid&quot;:&quot;ipsec_firewall&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-416&quot;} -->
<h2 class="sectionedit2" id="preface">Preface</h2>
<div class="level2">

<p>
In the following chapters you will find a detailed description of how to setup firewall rules for IPsec <abbr title="Virtual Private Network">VPN</abbr> connections. The experienced reader may notice that nowhere iptables IPsec policy rules are used (-m policy --pol ipsec). The reason for that is a special <abbr title="Virtual Private Network">VPN</abbr> scenario where both tunnel ends use <a href="/docs/guide-user/services/vpn/strongswan/overlappingsubnets" class="wikilink1" title="docs:guide-user:services:vpn:strongswan:overlappingsubnets" data-wiki-id="docs:guide-user:services:vpn:strongswan:overlappingsubnets">overlapping IP addresses</a>. In this case we have do use source <abbr title="Network Address Translation">NAT</abbr> (network address translation) rules. <strong>SNAT is only available in the POSTROUTING nat table</strong>. At this late firewall stage the system will discover for the first time that the packet has to pass the IPsec tunnel. Any ipsec policy based filter before will ignore the packet. 
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Preface&quot;,&quot;hid&quot;:&quot;preface&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;417-1142&quot;} -->
<h2 class="sectionedit3" id="zones">Zones</h2>
<div class="level2">

<p>
As in many commercial firewall solutions OpenWrt works with zones. A zone is more or less a bunch of computers that reside in the same network. Common examples are <abbr title="Wide Area Network">WAN</abbr>, <abbr title="Local Area Network">LAN</abbr>, <abbr title="Wireless Local Area Network">WLAN</abbr>, ... Why not introduce a new zone for computers behind tunnels. Here are two facts that should encourage the use of a new zone named <abbr title="Virtual Private Network">VPN</abbr>.
</p>
<ul>
<li class="level1"><div class="li"> When routing packets to a remote <abbr title="Virtual Private Network">VPN</abbr> side (e.g. 192.168.10.0/24) the packet will normally go through the firewall chain of the outside interface. </div>
</li>
<li class="level1"><div class="li"> Computers in a remote <abbr title="Virtual Private Network">VPN</abbr> are mostly in a secure zone. You should not mix them up with less secure machines (like servers in the internet)</div>
</li>
<li class="level1"><div class="li"> <abbr title="Virtual Private Network">VPN</abbr> and <abbr title="Wide Area Network">WAN</abbr> in the same zone needs fine granular rules to ensure that packets won&#039;t reach an unallowed target.</div>
</li>
</ul>

<p>
<strong>Conclusion: Create a new zone and call it vpn.</strong> It is not required to assign an interface to it. If you want to rename the zone to something else you have to adapt parameter <strong>zone</strong> in <a href="/docs/guide-user/services/vpn/strongswan/configuration" class="wikilink1" title="docs:guide-user:services:vpn:strongswan:configuration" data-wiki-id="docs:guide-user:services:vpn:strongswan:configuration">/etc/config/ipsec</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Zones&quot;,&quot;hid&quot;:&quot;zones&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;1143-2155&quot;} -->
<h2 class="sectionedit4" id="default_rules">Default Rules</h2>
<div class="level2">

<p>
We could build our own <abbr title="Virtual Private Network">VPN</abbr> firewall ruleset with iptables but why not go with LuCI. The interface should be flexible enough to build rules for our new OpenWrt IPsec enhanced router. The basic “Deny All” configuration can be achieved in the upper two panels. You should start with something like that:
</p>

<p>
<a href="/_detail/doc/howto/ipsec_firewall.png?id=docs%3Aguide-user%3Aservices%3Avpn%3Astrongswan%3Afirewall" class="media" title="doc:howto:ipsec_firewall.png"><img src="/_media/doc/howto/ipsec_firewall.png" class="media" loading="lazy" alt="" /></a>
</p>

<p>
Idea behind that is:
</p>
<ul>
<li class="level1"><div class="li"> The standard rule is to deny all (first panel)</div>
</li>
<li class="level1"><div class="li"> Depending on the zone we allow access to the device (INPUT). For our dual band router these are <abbr title="Local Area Network">LAN</abbr>, WLAN2 (2.5 <abbr title="Gigahertz">GHz</abbr>) and WLAN5 (5 <abbr title="Gigahertz">GHz</abbr>)</div>
</li>
<li class="level1"><div class="li"> The router is allowed to send data into all zones (OUTPUT).</div>
</li>
<li class="level1"><div class="li"> Sending data between zones is disabled (FORWARD). This will be achieved through firewall rules afterwards.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Default Rules&quot;,&quot;hid&quot;:&quot;default_rules&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;2156-2906&quot;} -->
<h2 class="sectionedit5" id="tunnel_endpoints">Tunnel Endpoints</h2>
<div class="level2">

<p>
To allow IPsec communications from a remote <abbr title="Virtual Private Network">VPN</abbr> Gateway the router must be able to terminate incoming connections. Three rules are required.
</p>
<ul>
<li class="level1"><div class="li"> ESP payload: the encrypted data packets</div>
</li>
<li class="level1"><div class="li"> ISAKMP: Handling of security associations (SA)</div>
</li>
<li class="level1"><div class="li"> <abbr title="Network Address Translation">NAT</abbr>-T: Handling of IPsec between natted devices</div>
</li>
</ul>

<p>
The easiest will be to allow all traffic to the Endpoint ports. Although being security paranoid we have to think about <a href="/docs/guide-user/services/vpn/ipsec/racoon/roadwarrior" class="wikilink2" title="docs:guide-user:services:vpn:ipsec:racoon:roadwarrior" rel="nofollow" data-wiki-id="docs:guide-user:services:vpn:ipsec:racoon:roadwarrior">road warriors</a> that want to connect from random internet addresses. The input_rule queue is a a good place to activate those rules manually with the following commands.
</p>
<pre class="code">iptables -A input_rule -p esp -j ACCEPT 
iptables -A input_rule -p udp --dport 500 -j ACCEPT 
iptables -A input_rule -p udp --dport 4500 -j ACCEPT </pre>

<p>
But we are not interested in manual setup. The solution should automatically integrate itself into the OpenWrt environment. So nothing to do now. We will discuss all different security aspects in detail and at the end of the page you will find a all-in-one script that will take care of everything.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Tunnel Endpoints&quot;,&quot;hid&quot;:&quot;tunnel_endpoints&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;2907-4036&quot;} -->
<h2 class="sectionedit6" id="vpn_rule_orders">VPN Rule Orders</h2>
<div class="level2">

<p>
Rules for the <abbr title="Virtual Private Network">VPN</abbr> zone require special considerations especially if you want to edit them with LuCI. Think of the <abbr title="Internet Protocol">IP</abbr> address/interface overlap. Your routers default outgoing interface is normally the <abbr title="Wide Area Network">WAN</abbr> connection. Every packet that does not match your internal network will leave there. But with active security profiles in the kernel packets e.g. to the remote <abbr title="Virtual Private Network">VPN</abbr> subnet 192.168.10.0/24 will go out through the <abbr title="Wide Area Network">WAN</abbr> interface too. Of course they will be encrypted in advance. A simple rule “Allow all <abbr title="Local Area Network">LAN</abbr> Zone to <abbr title="Wide Area Network">WAN</abbr> Zone” matches any packet to one of the remote <abbr title="Virtual Private Network">VPN</abbr> networks. Placed at the wrong position on top of the list it may conflict with other <abbr title="Virtual Private Network">VPN</abbr> specific rules that follow. 
</p>

<p>
<strong>Conclusion: The firewall script of at least version 10 will take care about that. You do not have to bother. </strong>
</p>

<p>
<a href="/_detail/doc/howto/ipsec_vpn_rules.png?id=docs%3Aguide-user%3Aservices%3Avpn%3Astrongswan%3Afirewall" class="media" title="doc:howto:ipsec_vpn_rules.png"><img src="/_media/doc/howto/ipsec_vpn_rules.png" class="media" loading="lazy" alt="" /></a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;VPN Rule Orders&quot;,&quot;hid&quot;:&quot;vpn_rule_orders&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:6,&quot;range&quot;:&quot;4037-4906&quot;} -->
<h2 class="sectionedit7" id="outgoing_vpn_packets">Outgoing VPN Packets</h2>
<div class="level2">

<p>
Up to here it was easy. Now it is time for a deeper firewall inspection. A packet from zone SRC to any other zone will sometime pass the <strong>zone_SRC_forward</strong> chain. At this point the firewall checks the packets destination address and forwards or drops it. For each rule we created from SRC to somwhere else an entry has been placed into this chain. The chain sequence is analogous to the order of rules. A comparison of the following picture with the above ruleset should make it clear.
</p>

<p>
<a href="/_detail/doc/howto/ipsec_forward_chain.png?id=docs%3Aguide-user%3Aservices%3Avpn%3Astrongswan%3Afirewall" class="media" title="doc:howto:ipsec_forward_chain.png"><img src="/_media/doc/howto/ipsec_forward_chain.png" class="media" loading="lazy" alt="" /></a>
</p>

<p>
First of all two rules to zone <abbr title="Virtual Private Network">VPN</abbr> afterwards one to <abbr title="Wide Area Network">WAN</abbr> and one to <abbr title="Local Area Network">LAN</abbr>. But with a sharp eye there are still two faults in our chain. 
</p>
<ul>
<li class="level1"><div class="li"> The packets to zone <abbr title="Virtual Private Network">VPN</abbr> are not only accepted but forwarded two another still empty chain called zone_vpn_ACCEPT. The explanation lies in the rulset generator of LuCI. A zone is normally bound to an interface. A chain with name zone_xxx_ACCEPT will check if a source or target of a packet matches the zone XXX. With no interface assigned to zone <abbr title="Virtual Private Network">VPN</abbr> this chain is left empty. So the packet will not be accepted.</div>
</li>
<li class="level1"><div class="li"> Not only are we loosing packets but also it would be possible that a packet is allowed to pass because a following rule to a completely different zone has a match. E.g. a packet from zone WLAN2 to <abbr title="Internet Protocol">IP</abbr> address 192.168.10.2. Both <abbr title="Virtual Private Network">VPN</abbr> rules will have no match. But as the packet will leave the router on the <abbr title="Wide Area Network">WAN</abbr> interface it will match the third rule (WLAN2→<abbr title="Wide Area Network">WAN</abbr> ANY). But that is not our intention. A packet to zone <abbr title="Virtual Private Network">VPN</abbr> should never be accepted by a rule to another zone.</div>
</li>
</ul>

<p>
Two problems two solutions. 
</p>
<ul>
<li class="level1"><div class="li"> Populating the zone_vpn_ACCEPT chain is easy. For each remote <abbr title="Virtual Private Network">VPN</abbr> network put an ACCEPT entry into that chain. So even a misconfiguration in LuCI will not mess anything up.</div>
</li>
<li class="level1"><div class="li"> The second one was quite trickier. Sort the <abbr title="Virtual Private Network">VPN</abbr> rules to the top of the list and put a blocking rule behind the last <abbr title="Virtual Private Network">VPN</abbr> rule in the chain. This new blocking rule must of course once again check against all networks behind <abbr title="Virtual Private Network">VPN</abbr> tunnels.</div>
</li>
</ul>

<p>
And that what it has to look like afterwards. The zone_<abbr title="Virtual Private Network">VPN</abbr>_ACCEPT and zone_<abbr title="Virtual Private Network">VPN</abbr>_REJECT are populated and zone_<abbr title="Virtual Private Network">VPN</abbr>_REJECT chain inserted at the right position. The <abbr title="Virtual Private Network">VPN</abbr> networks defined in our /etc/config/ipsec are 192.168.10.0/24 and 62.40.12.192/26. 
</p>

<p>
<a href="/_detail/doc/howto/ipsec_chain_mod.png?id=docs%3Aguide-user%3Aservices%3Avpn%3Astrongswan%3Afirewall" class="media" title="doc:howto:ipsec_chain_mod.png"><img src="/_media/doc/howto/ipsec_chain_mod.png" class="media" loading="lazy" alt="" /></a>
</p>

<p>
The naming convention follows the LuCI standard so you won&#039;t get confused. Once again no action has to be taken because we will use a script.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Outgoing VPN Packets&quot;,&quot;hid&quot;:&quot;outgoing_vpn_packets&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:7,&quot;range&quot;:&quot;4907-7375&quot;} -->
<h2 class="sectionedit8" id="incoming_vpn_packets">Incoming VPN Packets</h2>
<div class="level2">

<p>
Now that outgoing packets are covered by new policies we take care about the other direction. This is much easyier than before. The forward chain misses the jump into zone_vpn_forward chain as LuCI once again left it out due to missing associated interfaces. Without an interface we cannot insert the link directly but have to do subnet checkings in a new layer in between. As the picture shows we jump along the chains forward → zone_<abbr title="Virtual Private Network">VPN</abbr>_forward (new) → zone_vpn_forward (existing).
</p>

<p>
<a href="/_detail/doc/howto/ipsec_chain_mod2.png?id=docs%3Aguide-user%3Aservices%3Avpn%3Astrongswan%3Afirewall" class="media" title="doc:howto:ipsec_chain_mod2.png"><img src="/_media/doc/howto/ipsec_chain_mod2.png" class="media" loading="lazy" alt="" /></a>
</p>

<p>
In this case a single rule from remote machine 192.168.10.1 to local machine 192.168.213.66 was defined. With the new chain links it will be evaluated by the firewall. This modification will also be accomplished by our script.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Incoming VPN Packets&quot;,&quot;hid&quot;:&quot;incoming_vpn_packets&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:8,&quot;range&quot;:&quot;7376-8161&quot;} -->
<h2 class="sectionedit9" id="packets_to_the_device">Packets To The Device</h2>
<div class="level2">

<p>
If we want to reach the device through a <abbr title="Virtual Private Network">VPN</abbr> tunnel we have to check the correctness of the INPUT chain. It branches into the input (lowercase!) chain where the system checks it for the different zones. The jump over to the vpn_zone  is missing by default although the chain itself already exists and is populated. So just put this entry at the beginning.
</p>

<p>
<a href="/_detail/doc/howto/ipsec_chain_in.png?id=docs%3Aguide-user%3Aservices%3Avpn%3Astrongswan%3Afirewall" class="media" title="doc:howto:ipsec_chain_in.png"><img src="/_media/doc/howto/ipsec_chain_in.png" class="media" loading="lazy" alt="" /></a>
</p>

<p>
This feature has been introduced in version 9 of our firewall script.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Packets To The Device&quot;,&quot;hid&quot;:&quot;packets_to_the_device&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:9,&quot;range&quot;:&quot;8162-8659&quot;} -->
<h2 class="sectionedit10" id="nat_translation">NAT Translation</h2>
<div class="level2">

<p>
Some of our interfaces will run in masquerade mode. The source address of packets that will leave through these interfaces will be translated to the interface address itself. This is an unwanted contrast to <abbr title="Virtual Private Network">VPN</abbr> networks where <abbr title="Internet Protocol">IP</abbr> addresses are usually untouched. Maybe sometime later we will have look at overlapping <abbr title="Virtual Private Network">VPN</abbr> subnets. This time our challenge lies in the <abbr title="Network Address Translation">NAT</abbr> POSTROUTING chain. For each interface that you flagged with masquerading in LuCI a rule is inserted there. When taking no action something like this will happen.
</p>
<ul>
<li class="level1"><div class="li"> Our <abbr title="Local Area Network">LAN</abbr> is connected via IPsec to the remote subnet 192.168.10.0/24</div>
</li>
<li class="level1"><div class="li"> We send a packet to the remote subnet.</div>
</li>
<li class="level1"><div class="li"> After all filter rules have been applied the packet enters the <abbr title="Network Address Translation">NAT</abbr> table</div>
</li>
<li class="level1"><div class="li"> Our tunnel is terminated on the <abbr title="Wide Area Network">WAN</abbr> interface (PPPOE-<abbr title="Wide Area Network">WAN</abbr>) with activated masquerading</div>
</li>
<li class="level1"><div class="li"> The <abbr title="Network Address Translation">NAT</abbr> ruleset chooses the <abbr title="Wide Area Network">WAN</abbr> zone for the packet </div>
</li>
<li class="level1"><div class="li"> Therefore the packet source address is translated to our offical <abbr title="Wide Area Network">WAN</abbr> <abbr title="Internet Protocol">IP</abbr></div>
</li>
<li class="level1"><div class="li"> Afterwards it is put into the tunnel</div>
</li>
<li class="level1"><div class="li"> Ouch!</div>
</li>
</ul>

<p>
So once again we have to fix the queue. Therefore we will put a rule at the first position in the chain. This will ensure that packets to foreign <abbr title="Virtual Private Network">VPN</abbr> subnets will remain untouched. 
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;NAT Translation&quot;,&quot;hid&quot;:&quot;nat_translation&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:10,&quot;range&quot;:&quot;8660-9869&quot;} -->
<h2 class="sectionedit11" id="firewall_integration">Firewall integration</h2>
<div class="level2">

<p>
To enable custom firewall rules we hook up with the default firewall mechanism. Ensure that firewall user scripts are loaded and reloaded everytime we (re)start the OpenWrt firewall. Verify/adapt the following lines in /etc/config/firewall
</p>
<pre class="code">config include
        option path &#039;/etc/firewall.user&#039;
        option reload 1</pre>

<p>
Additionally place the call to the ipsec user firewall script into /etc/firewall.user.
</p>
<pre class="code"># This file is interpreted as shell script.
# Put your custom iptables rules here, they will
# be executed with each firewall (re-)start.

# Internal uci firewall chains are flushed and recreated on reload, so
# put custom rules into the root chains e.g. INPUT or FORWARD or into the
# special user chains, e.g. input_wan_rule or postrouting_lan_rule.

/etc/firewall.ipsec </pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Firewall integration&quot;,&quot;hid&quot;:&quot;firewall_integration&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:11,&quot;range&quot;:&quot;9870-10717&quot;} -->
<h2 class="sectionedit12" id="vpn_firewall_script">VPN Firewall Script</h2>
<div class="level2">

<p>
Finally we have a look at the script. It injects all the additionally required settings according to 
<a href="/docs/guide-user/services/vpn/strongswan/configuration" class="wikilink1" title="docs:guide-user:services:vpn:strongswan:configuration" data-wiki-id="docs:guide-user:services:vpn:strongswan:configuration">/etc/config/ipsec</a> into the OpenWrt firewall. Save it as <strong>/etc/ipsec/firewall.sh</strong> and put a calling line into <strong>/etc/firewall.user</strong> so it gets loaded automatically. <strong>REMARK: This script only enables <abbr title="Virtual Private Network">VPN</abbr> firewall rules that have been set in the LUCI web interface. There is no guarantee that manually implemented rules in /etc/config/firewall will work!</strong>
</p>
<pre class="code bash"><span class="co0">#!/bin/sh</span>
<span class="co0">#/etc/ipsec/firewall.sh - version 2</span>
&nbsp;
. <span class="sy0">/</span>etc<span class="sy0">/</span>functions.sh
&nbsp;
GetZone<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
  config_get zone <span class="st0">&quot;$1&quot;</span> zone vpn
<span class="br0">&#125;</span>
&nbsp;
GetTunnel<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
  <span class="kw3">local</span> remote_subnet
  <span class="kw3">local</span> local_subnet
  <span class="kw3">local</span> local_nat
&nbsp;
  config_get remote_subnet <span class="st0">&quot;$1&quot;</span> remote_subnet
  config_get local_subnet  <span class="st0">&quot;$1&quot;</span> local_subnet
  config_get local_nat     <span class="st0">&quot;$1&quot;</span> local_nat <span class="st0">&quot;&quot;</span>
  iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_ACCEPT <span class="re5">-d</span> <span class="re1">$remote_subnet</span> <span class="re5">-j</span> ACCEPT
  iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_ACCEPT <span class="re5">-s</span> <span class="re1">$remote_subnet</span> <span class="re5">-j</span> ACCEPT
  iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_REJECT <span class="re5">-d</span> <span class="re1">$remote_subnet</span> <span class="re5">-j</span> reject
  iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_REJECT <span class="re5">-s</span> <span class="re1">$remote_subnet</span> <span class="re5">-j</span> reject
  iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_INPUT <span class="re5">-s</span> <span class="re1">$remote_subnet</span> <span class="re5">-j</span> zone_<span class="co1">${zone}</span>
  iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_FORWARD <span class="re5">-s</span> <span class="re1">$remote_subnet</span> <span class="re5">-j</span> zone_<span class="co1">${zone}</span>_forward
&nbsp;
  <span class="kw1">if</span> <span class="br0">&#91;</span> <span class="st0">&quot;<span class="es2">$local_nat</span>&quot;</span> == <span class="st0">&quot;&quot;</span> <span class="br0">&#93;</span>; <span class="kw1">then</span>
    iptables <span class="re5">-t</span> nat <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_nat <span class="re5">-d</span> <span class="re1">$remote_subnet</span> <span class="re5">-j</span> ACCEPT
  <span class="kw1">else</span>
    iptables <span class="re5">-t</span> nat <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_nat <span class="re5">-d</span> <span class="re1">$remote_subnet</span> \
             <span class="re5">-s</span> <span class="re1">$local_subnet</span> <span class="re5">-j</span> NETMAP <span class="re5">--to</span> <span class="re1">$local_nat</span>
    iptables <span class="re5">-t</span> nat <span class="re5">-A</span> prerouting_<span class="co1">${zone}</span> <span class="re5">-s</span> <span class="re1">$remote_subnet</span> \
             <span class="re5">-d</span> <span class="re1">$local_nat</span> <span class="re5">-j</span> NETMAP <span class="re5">--to</span> <span class="re1">$local_subnet</span>
  <span class="kw1">fi</span>
<span class="br0">&#125;</span>
&nbsp;
GetRemote<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
  <span class="kw3">local</span> enabled
  <span class="kw3">local</span> gateway
&nbsp;
  config_get_bool enabled <span class="st0">&quot;$1&quot;</span> enabled <span class="nu0">0</span>
  config_get      gateway <span class="st0">&quot;$1&quot;</span> gateway
  <span class="br0">&#91;</span><span class="br0">&#91;</span> <span class="st0">&quot;<span class="es2">$enabled</span>&quot;</span> == <span class="st0">&quot;0&quot;</span> <span class="br0">&#93;</span><span class="br0">&#93;</span> <span class="sy0">&amp;&amp;</span> <span class="kw3">return</span>
&nbsp;
  config_list_foreach <span class="st0">&quot;$1&quot;</span> tunnel GetTunnel
<span class="br0">&#125;</span>
&nbsp;
GetDevice<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
  . <span class="sy0">/</span>lib<span class="sy0">/</span>functions<span class="sy0">/</span>network.sh
  <span class="kw3">local</span> <span class="re2">interface</span>=<span class="st0">&quot;$1&quot;</span>
  network_get_device listen <span class="st0">&quot;<span class="es2">$interface</span>&quot;</span>
  <span class="co0"># open IPsec endpoint</span>
  <span class="kw1">if</span> <span class="br0">&#91;</span> <span class="st0">&quot;<span class="es2">$listen</span>&quot;</span> == <span class="st0">&quot;&quot;</span> <span class="br0">&#93;</span>; <span class="kw1">then</span>
    iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-p</span> esp <span class="re5">-j</span> ACCEPT
    iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-p</span> udp <span class="re5">--dport</span> <span class="nu0">500</span> <span class="re5">-j</span> ACCEPT
    iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-p</span> udp <span class="re5">--dport</span> <span class="nu0">4500</span> <span class="re5">-j</span> ACCEPT
    <span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re1">$has_ip6tables</span> <span class="re5">-eq</span> <span class="nu0">1</span> <span class="br0">&#93;</span>; <span class="kw1">then</span>
      ip6tables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-p</span> esp <span class="re5">-j</span> ACCEPT
      ip6tables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-p</span> udp <span class="re5">--dport</span> <span class="nu0">500</span> <span class="re5">-j</span> ACCEPT
      ip6tables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-p</span> udp <span class="re5">--dport</span> <span class="nu0">4500</span> <span class="re5">-j</span> ACCEPT
    <span class="kw1">fi</span>
  <span class="kw1">else</span>
    iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-i</span> <span class="re1">$listen</span> <span class="re5">-p</span> esp <span class="re5">-j</span> ACCEPT
    iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-i</span> <span class="re1">$listen</span> <span class="re5">-p</span> udp <span class="re5">--dport</span> <span class="nu0">500</span> <span class="re5">-j</span> ACCEPT
    iptables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-i</span> <span class="re1">$listen</span> <span class="re5">-p</span> udp <span class="re5">--dport</span> <span class="nu0">4500</span> <span class="re5">-j</span> ACCEPT
    <span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re1">$has_ip6tables</span> <span class="re5">-eq</span> <span class="nu0">1</span> <span class="br0">&#93;</span>; <span class="kw1">then</span>
      ip6tables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-i</span> <span class="re1">$listen</span> <span class="re5">-p</span> esp <span class="re5">-j</span> ACCEPT
      ip6tables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-i</span> <span class="re1">$listen</span> <span class="re5">-p</span> udp <span class="re5">--dport</span> <span class="nu0">500</span> <span class="re5">-j</span> ACCEPT
      ip6tables <span class="re5">-A</span> zone_<span class="co1">${zone}</span>_gateway <span class="re5">-i</span> <span class="re1">$listen</span> <span class="re5">-p</span> udp <span class="re5">--dport</span> <span class="nu0">4500</span> <span class="re5">-j</span> ACCEPT
    <span class="kw1">fi</span>
  <span class="kw1">fi</span>
&nbsp;
<span class="br0">&#125;</span>
&nbsp;
GetInterface<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
  config_list_foreach <span class="st0">&quot;$1&quot;</span> listen GetDevice
<span class="br0">&#125;</span>
&nbsp;
<span class="re2">zone</span>=vpn
config_load ipsec
config_foreach GetZone ipsec
&nbsp;
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-x</span> <span class="sy0">/</span>usr<span class="sy0">/</span>sbin<span class="sy0">/</span>ip6tables <span class="br0">&#93;</span>; <span class="kw1">then</span>
  <span class="re2">has_ip6tables</span>=<span class="nu0">1</span>
<span class="kw1">else</span>
  <span class="re2">has_ip6tables</span>=<span class="nu0">0</span>
<span class="kw1">fi</span>
&nbsp;
iptables <span class="re5">-F</span> zone_<span class="co1">${zone}</span>_ACCEPT
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re1">$has_ip6tables</span> <span class="re5">-eq</span> <span class="nu0">1</span> <span class="br0">&#93;</span>; <span class="kw1">then</span>
  ip6tables <span class="re5">-F</span> zone_<span class="co1">${zone}</span>_ACCEPT
<span class="kw1">fi</span>
&nbsp;
iptables <span class="re5">-N</span> zone_<span class="co1">${zone}</span>_gateway
iptables <span class="re5">-I</span> input <span class="re5">-j</span> zone_<span class="co1">${zone}</span>_gateway
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re1">$has_ip6tables</span> <span class="re5">-eq</span> <span class="nu0">1</span> <span class="br0">&#93;</span>; <span class="kw1">then</span>
  ip6tables <span class="re5">-N</span> zone_<span class="co1">${zone}</span>_gateway
  ip6tables <span class="re5">-I</span> input <span class="re5">-j</span> zone_<span class="co1">${zone}</span>_gateway
<span class="kw1">fi</span>
config_foreach GetInterface ipsec
&nbsp;
iptables <span class="re5">-t</span> nat <span class="re5">-F</span> zone_<span class="co1">${zone}</span>_nat
iptables <span class="re5">-t</span> nat <span class="re5">-I</span> POSTROUTING <span class="nu0">2</span> <span class="re5">-j</span> zone_<span class="co1">${zone}</span>_nat
iptables <span class="re5">-t</span> nat <span class="re5">-I</span> PREROUTING <span class="nu0">2</span> <span class="re5">-j</span> zone_<span class="co1">${zone}</span>_prerouting
&nbsp;
<span class="co0"># sort VPN rules to top of forward zones and insert VPN reject marker afterwards</span>
<span class="re2">ForwardZones</span>=<span class="sy0">`</span>iptables <span class="re5">-S</span> <span class="sy0">|</span> <span class="kw2">awk</span> <span class="st_h">'/.N.*zone.*_forward/{print $2}'</span> <span class="sy0">|</span> <span class="kw2">grep</span> <span class="re5">-v</span> <span class="co1">${zone}</span><span class="sy0">`</span>
<span class="kw1">for</span> ForwardZone <span class="kw1">in</span> <span class="re1">$ForwardZones</span> ; <span class="kw1">do</span>
  <span class="kw3">echo</span> <span class="st0">&quot;iptables -F <span class="es2">$ForwardZone</span>&quot;</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>fwrebuild
  iptables <span class="re5">-S</span> <span class="re1">$ForwardZone</span> <span class="sy0">|</span> <span class="kw2">grep</span> zone_<span class="co1">${zone}</span>_ACCEPT <span class="sy0">|</span> \
    <span class="kw2">grep</span> <span class="re5">-v</span> <span class="st0">&quot;^-N&quot;</span> <span class="sy0">|</span> <span class="kw2">awk</span> <span class="st_h">'{ print &quot;iptables &quot; $0}'</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>fwrebuild
  <span class="kw3">echo</span> <span class="st0">&quot;iptables -A <span class="es2">$ForwardZone</span> -j zone_<span class="es3">${zone}</span>_REJECT&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>fwrebuild
  iptables <span class="re5">-S</span> <span class="re1">$ForwardZone</span> <span class="sy0">|</span> <span class="kw2">grep</span> <span class="re5">-v</span> zone_<span class="co1">${zone}</span>_ACCEPT <span class="sy0">|</span> \
    <span class="kw2">grep</span> <span class="re5">-v</span> <span class="st0">&quot;^-N&quot;</span> <span class="sy0">|</span> <span class="kw2">awk</span> <span class="st_h">'{ print &quot;iptables &quot; $0}'</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>fwrebuild
&nbsp;
  <span class="kw2">chmod</span> +x <span class="sy0">/</span>tmp<span class="sy0">/</span>fwrebuild
  <span class="sy0">/</span>tmp<span class="sy0">/</span>fwrebuild
  <span class="kw2">rm</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>fwrebuild
<span class="kw1">done</span>
&nbsp;
<span class="co0"># link zone_vpn via zone_vpn_INPUT</span>
iptables <span class="re5">-N</span> zone_<span class="co1">${zone}</span>_INPUT
iptables <span class="re5">-I</span> input <span class="re5">-j</span> zone_<span class="co1">${zone}</span>_INPUT
&nbsp;
<span class="co0"># link zone_vpn_forward via zone_vpn_FORWARD</span>
iptables <span class="re5">-N</span> zone_<span class="co1">${zone}</span>_FORWARD
iptables <span class="re5">-I</span> forward <span class="re5">-j</span> zone_<span class="co1">${zone}</span>_FORWARD
&nbsp;
config_foreach GetRemote remote</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;VPN Firewall Script&quot;,&quot;hid&quot;:&quot;vpn_firewall_script&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:12,&quot;range&quot;:&quot;10718-15272&quot;} -->
<h2 class="sectionedit13" id="what_s_next">What&#039;s next</h2>
<div class="level2">

<p>
With the firewall ready we can start our first IPSec <abbr title="Virtual Private Network">VPN</abbr> scenario. A <a href="/docs/guide-user/services/vpn/strongswan/site2site" class="wikilink1" title="docs:guide-user:services:vpn:strongswan:site2site" data-wiki-id="docs:guide-user:services:vpn:strongswan:site2site">site to site</a> connection.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;What&#039;s next&quot;,&quot;hid&quot;:&quot;what_s_next&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:13,&quot;range&quot;:&quot;15273-&quot;} -->