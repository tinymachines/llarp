
<h1 class="sectionedit1" id="ipsec_performance">IPsec Performance</h1>
<div class="level1">

<p>
This page is optional and only documentation for the speed freak.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;IPsec Performance&quot;,&quot;hid&quot;:&quot;ipsec_performance&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-100&quot;} -->
<h2 class="sectionedit2" id="hardware_performance">Hardware performance</h2>
<div class="level2">

<p>
In the times of broadband internet connections encryption and decryption speed of SOME low-end routers can limit throughput of <abbr title="Virtual Private Network">VPN</abbr> tunnels. CPU utilization can max out at 100 percent and impacts other services of the device like a web server. FOR REFERENCE: Strongswan will run just FINE on a WNDR3700 (MIPS 680 Mhz, 64 Mb RAM). If your router is underpowered, here are some other options:
</p>
<ul>
<li class="level1"><div class="li"> Older firewall devices with hardware accelerated <abbr title="Virtual Private Network">VPN</abbr> are sold for a few bucks on Ebay. Juniper Netscreen 5GT for example can easily reach a <abbr title="Virtual Private Network">VPN</abbr> throughput of 20 MBit/sec. Downside is that firmware updates are only possible with a Juniper support contract. So check twice for a bargain.</div>
</li>
<li class="level1"><div class="li"> Firewall devices are built to support IPsec out of the box. A convenient web interface helps the administrator to build a tunnel in a few seconds. OpenWrt still lacks a standard LuCI config panel. If you only go with 1-5 <abbr title="Virtual Private Network">VPN</abbr> tunnels this should be no concern to you.</div>
</li>
</ul>

<p>
To find the right OpenWrt hardware for your <abbr title="Virtual Private Network">VPN</abbr> you should have a look at the following benchmark table. It is build on a simple test without any claim of perfection. Nevertheless the numbers are quite close to what you can expect from an AES 128/256 bit encrypted IPsec Tunnel connection with standard kernel modules. You may notice that those numbers differ from what is written on the <a href="/docs/guide-user/perf_and_log/benchmark.openssl" class="wikilink1" title="docs:guide-user:perf_and_log:benchmark.openssl" data-wiki-id="docs:guide-user:perf_and_log:benchmark.openssl">OpenSSL wiki page</a>. But simply remember: <strong>The tests over there do not include network traffic</strong>. If you want to add a new device onto the list check the encrpytion throughput using the following prerequisites
</p>
<ul>
<li class="level1"><div class="li"> Logon to a fast Linux machine </div>
</li>
<li class="level1"><div class="li"> Use a direct <abbr title="Local Area Network">LAN</abbr> connection to the router</div>
</li>
<li class="level1"><div class="li"> Ensure the router is idle</div>
</li>
<li class="level1"><div class="li"> Transfer 100 <abbr title="Megabyte">MB</abbr> of data using ssh</div>
</li>
<li class="level1"><div class="li"> Calculate the speed from the elapsed time. Throughput = 800 / SecondsElapsed</div>
</li>
</ul>
<pre class="code">ssh -2 -c aes128-cbc root@&lt;router&gt; time dd if=/dev/zero bs=500000 count=200 &gt; /dev/null
ssh -2 -c aes256-cbc root@&lt;router&gt; time dd if=/dev/zero bs=500000 count=200 &gt; /dev/null</pre>

<p>
You can have a look at the realtime traffic graph in a dry run afterwards to verify the speed. But do not open it during your test because it invalidates the results.
</p>
<div class="table sectionedit3"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> CPU </th><th class="col1"> <abbr title="Megahertz">MHz</abbr> </th><th class="col2"> tested device </th><th class="col3">AES128 (s)</th><th class="col4">AES128 (MBit/s)</th><th class="col5">AES256 (s)</th><th class="col6">AES256 (MBit/s)</th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> PPC </td><td class="col1"> 800 </td><td class="col2"> <a href="/toh/tp-link/tl-wdr4900" class="wikilink1" title="toh:tp-link:tl-wdr4900" data-wiki-id="toh:tp-link:tl-wdr4900">TP-Link TL-WDR4900</a> </td><td class="col3 rightalign">  14.2 </td><td class="col4 rightalign">  56.3 </td><td class="col5 rightalign">  16.2 </td><td class="col6 rightalign">  49.4 </td>
	</tr>
	<tr class="row2">
		<td class="col0"> MIPS 24k </td><td class="col1"> 680 </td><td class="col2"> <a href="/toh/d-link/dir-825" class="wikilink1" title="toh:d-link:dir-825" data-wiki-id="toh:d-link:dir-825">D-Link DIR-825</a> <a href="/toh/netgear/wndr3700" class="wikilink1" title="toh:netgear:wndr3700" data-wiki-id="toh:netgear:wndr3700">Netgear WNDR3700</a> </td><td class="col3 rightalign">  28.2 </td><td class="col4 rightalign">  28.5 </td><td class="col5 rightalign">  32.4 </td><td class="col6 rightalign">  24.6 </td>
	</tr>
	<tr class="row3">
		<td class="col0"> MIPS 24k </td><td class="col1"> 400 </td><td class="col2"> <a href="/toh/tp-link/tl-wr703n" class="wikilink1" title="toh:tp-link:tl-wr703n" data-wiki-id="toh:tp-link:tl-wr703n">TP-Link TL-WR703N</a> </td><td class="col3 rightalign">  47.7 </td><td class="col4 rightalign">  16.5 </td><td class="col5 rightalign">  56.1 </td><td class="col6 rightalign">  14.2 </td>
	</tr>
	<tr class="row4">
		<td class="col0"> MIPS R3000 </td><td class="col1"> 125 </td><td class="col2"> <a href="/toh/asus/wl500g" class="wikilink1" title="toh:asus:wl500g" data-wiki-id="toh:asus:wl500g">Asus WL-500g</a> </td><td class="col3 rightalign">  164.8 </td><td class="col4 rightalign">  4.8 </td><td class="col5 rightalign">  183.5 </td><td class="col6 rightalign">  4.3 </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;2328-2825&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Hardware performance&quot;,&quot;hid&quot;:&quot;hardware_performance&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;101-2826&quot;} -->
<h2 class="sectionedit4" id="ipsec_security_speed">IPsec security &amp; speed</h2>
<div class="level2">

<p>
If you use a default OpenWrt installation you will discover that working with the most secure AES256/SHA256 tunnel options will hit <abbr title="Virtual Private Network">VPN</abbr> performance. If you go for raw throughput going down the less secure AES128, SHA1 &amp; MD5 functions can be a helpful alternative. One may remark that MD5 is <a href="http://en.wikipedia.org/wiki/Md5#Security" class="urlextern" title="http://en.wikipedia.org/wiki/Md5#Security" rel="ugc nofollow">not very secure</a> but for IPsec connections it should be enough as we are talking about hash values of encrypted data with a key that is changed <a href="/docs/guide-user/services/vpn/ipsec/racoon/basic#p2_proposal" class="wikilink2" title="docs:guide-user:services:vpn:ipsec:racoon:basic" rel="nofollow" data-wiki-id="docs:guide-user:services:vpn:ipsec:racoon:basic">every hour</a> according to phase 2 proposals. A good tradeoff could be to choose AES256/SHA256 for phase 1 and AES128/MD5 for phase 2.  
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;IPsec security &amp; speed&quot;,&quot;hid&quot;:&quot;ipsec_security_speed&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:4,&quot;range&quot;:&quot;2827-3541&quot;} -->
<h2 class="sectionedit5" id="tuning_crypto_providers">Tuning crypto providers</h2>
<div class="level2">

<p>
Read on if you have some time and want to enhance your <abbr title="Virtual Private Network">VPN</abbr> speed. The kernel IPsec architecture relies on different crypto providers. E.g. if you build a tunnel with SHA1 checksums you must have a module that can calculate those values. A look at /proc/crypto will reveal what modules are loaded and which algorithms they provide. The standard Linux Kernel modules are far from being optimized. If you opted for a cheap router there won&#039;t be any hardware crpyto device. 
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Tuning crypto providers&quot;,&quot;hid&quot;:&quot;tuning_crypto_providers&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:5,&quot;range&quot;:&quot;3542-4050&quot;} -->
<h2 class="sectionedit6" id="ppc_tuning">PPC tuning</h2>
<div class="level2">

<p>
Users of a TP-Link WDR4900 might enjoy the benefits of some recent module developments. 
</p>
<ul>
<li class="level1"><div class="li"> Assembler optimized AES: Patch in the <a href="https://git.kernel.org/cgit/linux/kernel/git/herbert/cryptodev-2.6.git/log/?qt=grep&amp;q=powerpc%2Faes" class="urlextern" title="https://git.kernel.org/cgit/linux/kernel/git/herbert/cryptodev-2.6.git/log/?qt=grep&amp;q=powerpc%2Faes" rel="ugc nofollow">linux crypto development git</a>. Waiting for inclusion into mainline.</div>
</li>
<li class="level1"><div class="li"> Assembler optimized MD5: Patch on the <a href="http://marc.info/?l=linux-crypto-vger&amp;m=142523463626661&amp;w=2" class="urlextern" title="http://marc.info/?l=linux-crypto-vger&amp;m=142523463626661&amp;w=2" rel="ugc nofollow">linux crypto mailing list</a>. Waiting for inclusion into development git.</div>
</li>
<li class="level1"><div class="li"> Assembler optimized SHA1: Patch on the <a href="http://marc.info/?l=linux-crypto-vger&amp;m=142480660217788&amp;w=2" class="urlextern" title="http://marc.info/?l=linux-crypto-vger&amp;m=142480660217788&amp;w=2" rel="ugc nofollow">linux crypto mailing list</a>. Waiting for inclusion into development git.</div>
</li>
<li class="level1"><div class="li"> Assembler optimized SHA256: Patch in the <a href="https://git.kernel.org/cgit/linux/kernel/git/herbert/cryptodev-2.6.git/log/?qt=grep&amp;q=ppc%2Fsha256" class="urlextern" title="https://git.kernel.org/cgit/linux/kernel/git/herbert/cryptodev-2.6.git/log/?qt=grep&amp;q=ppc%2Fsha256" rel="ugc nofollow">linux crypto development git</a>. Waiting for inclusion into mainline.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;PPC tuning&quot;,&quot;hid&quot;:&quot;ppc_tuning&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:6,&quot;range&quot;:&quot;4051-4947&quot;} -->
<h2 class="sectionedit7" id="mips_tuning">MIPS tuning</h2>
<div class="level2">

<p>
Those of you that are on MIPS <strong>big endian</strong><img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> machines can replace the default aes_generic.ko, sha_generic.ko, cbc.ko and md5.ko modules with a single assembler optimized <a href="https://sourceforge.net/projects/mcespi/files/" class="urlextern" title="https://sourceforge.net/projects/mcespi/files/" rel="ugc nofollow">mcespi.ko</a>. The module is quite some years old and a first experience with crypto modules. Nevertheless it will work quite fine but needs manual compiling. The easyiest way to install it includes a few steps.
</p>
<ul>
<li class="level1"><div class="li"> create a buildroot environment</div>
</li>
<li class="level1"><div class="li"> compile an image for your router once</div>
</li>
<li class="level1"><div class="li"> put the mcespi.c into the the folder build_dir/target-&lt;arch&gt;/linux-&lt;cpu-model&gt;/linux-X.Y.Z/crypto</div>
</li>
<li class="level1"><div class="li"> Include the line <strong>obj-$(CONFIG_CRYPTO_MD5) += mcespi.o</strong> into build_dir/target-&lt;arch&gt;/linux-&lt;cpu-model&gt;/linux-X.Y.Z/crypto/Makefile</div>
</li>
<li class="level1"><div class="li"> compile the image once again.</div>
</li>
<li class="level1"><div class="li"> Afterwards you will find build_dir/target-&lt;arch&gt;/linux-&lt;cpu-model&gt;/linux-X.Y.Z/crypto/mcespi.ko</div>
</li>
<li class="level1"><div class="li"> Put mcespi.ko to your router into /lib/modules/&lt;X.Y.Z&gt;</div>
</li>
<li class="level1"><div class="li"> Load the module with insmod </div>
</li>
<li class="level1"><div class="li"> For automatic loading create a new /etc/modules.d/09-crypto-mcespi with corresponding content.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;MIPS tuning&quot;,&quot;hid&quot;:&quot;mips_tuning&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:7,&quot;range&quot;:&quot;4948-6048&quot;} -->
<h2 class="sectionedit8" id="what_s_next">What&#039;s next</h2>
<div class="level2">

<p>
Basic setup and performance ok? So continue with the <a href="/docs/guide-user/services/vpn/strongswan/firewall" class="wikilink1" title="docs:guide-user:services:vpn:strongswan:firewall" data-wiki-id="docs:guide-user:services:vpn:strongswan:firewall">firewall modifications</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;What&#039;s next&quot;,&quot;hid&quot;:&quot;what_s_next&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:8,&quot;range&quot;:&quot;6049-&quot;} -->