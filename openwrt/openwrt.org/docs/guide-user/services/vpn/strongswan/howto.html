
<h1 class="sectionedit1" id="ipsec_legacy_ikev1_configuration">IPsec Legacy IKEv1 Configuration</h1>
<div class="level1">

<p>
mostly taken from <a href="https://forum.openwrt.org/viewtopic.php?id=39560" class="urlextern" title="https://forum.openwrt.org/viewtopic.php?id=39560" rel="ugc nofollow">https://forum.openwrt.org/viewtopic.php?id=39560</a>
</p>

<p>
This IPsec IKEv1 (+xauth) howto was written for old Apple iOS “IPsec” clients. The same kind of setup could be found on some commercial gateways (Netgear, AVM FritzBox, etc.) and third-party IPsec <abbr title="Virtual Private Network">VPN</abbr> softwares like TheGreenBow or ShrewSoft. For modern deployments, look for IPsec IKEv2 instead.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;IPsec Legacy IKEv1 Configuration&quot;,&quot;hid&quot;:&quot;ipsec_legacy_ikev1_configuration&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-416&quot;} -->
<h1 class="sectionedit2" id="install_necessary_packages">install necessary packages</h1>
<div class="level1">
<pre class="code">      opkg update</pre>
<pre class="code">      opkg install strongswan-default strongswan-mod-dhcp strongswan-mod-af-alg strongswan-mod-gcrypt \ 
      strongswan-mod-blowfish strongswan-mod-md4 strongswan-mod-openssl strongswan-mod-pkcs11 \
      strongswan-mod-pkcs8 strongswan-mod-test-vectors strongswan-mod-farp</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;install necessary packages&quot;,&quot;hid&quot;:&quot;install_necessary_packages&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;417-763&quot;} -->
<h1 class="sectionedit3" id="ipsec_config">ipsec config</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;ipsec config&quot;,&quot;hid&quot;:&quot;ipsec_config&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;764-790&quot;} -->
<h2 class="sectionedit4" id="etcipsecconf">/etc/ipsec.conf</h2>
<div class="level2">
<pre class="code">      # ipsec.conf - strongSwan IPsec configuration file
      
      conn ios
              keyexchange=ikev1
              authby=xauthrsasig
              xauth=server
              left=%any
              leftsubnet=0.0.0.0/0
              leftfirewall=yes
              leftcert=serverCert.pem
              right=%any
              rightsubnet=192.168.1.0/24
              rightsourceip=%dhcp
              rightcert=clientCert.pem
              forceencaps=yes
              auto=add</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\/etc\/ipsec.conf&quot;,&quot;hid&quot;:&quot;etcipsecconf&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;791-1342&quot;} -->
<h2 class="sectionedit5" id="etcipsecsecrets">/etc/ipsec.secrets</h2>
<div class="level2">
<pre class="code">      # /etc/ipsec.secrets - strongSwan IPsec secrets file
      
      : RSA serverKey.pem
      anyuser : XAUTH &quot;anypassword&quot;</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\/etc\/ipsec.secrets&quot;,&quot;hid&quot;:&quot;etcipsecsecrets&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;1343-1510&quot;} -->
<h2 class="sectionedit6" id="etcinitdipsec">/etc/init.d/ipsec</h2>
<div class="level2">
<pre class="code">      #!/bin/sh /etc/rc.common
      # ipsec init script
      
      START=46
      STOP=01
      
      start() {
      ipsec start
      }
      
      stop() {
      ipsec stop
      }
      
      restart() {
      ipsec restart
      }
      
      reload() {
      ipsec update
      }</pre>

<p>
remember to run /etc/init.d/ipsec enable when done to enable startup on boot
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\/etc\/init.d\/ipsec&quot;,&quot;hid&quot;:&quot;etcinitdipsec&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;1511-1954&quot;} -->
<h1 class="sectionedit7" id="strongswan_config">strongswan config</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;strongswan config&quot;,&quot;hid&quot;:&quot;strongswan_config&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;1955-1986&quot;} -->
<h2 class="sectionedit8" id="etcstrongswanconf">/etc/strongswan.conf</h2>
<div class="level2">
<pre class="code">      # strongswan.conf - strongSwan configuration file
      
      charon {
      
              dns1 = 192.168.1.1
      
              threads = 16
      
              plugins {
      
                      dhcp {
                              server = 192.168.1.1
                      }
              }
      
      }
      
      pluto {
      
      }
      
      libstrongswan {
      
              #  set to no, the DH exponent size is optimized
              #  dh_exponent_ansi_x9_42 = no
      }</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\/etc\/strongswan.conf&quot;,&quot;hid&quot;:&quot;etcstrongswanconf&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;1987-2585&quot;} -->
<h1 class="sectionedit9" id="firewall_config">firewall config</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;firewall config&quot;,&quot;hid&quot;:&quot;firewall_config&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;2586-2615&quot;} -->
<h2 class="sectionedit10" id="etcfirewalluser">/etc/firewall.user</h2>
<div class="level2">
<pre class="code">      iptables -I INPUT  -m policy --dir in --pol ipsec --proto esp -j ACCEPT
      iptables -I FORWARD  -m policy --dir in --pol ipsec --proto esp -j ACCEPT
      iptables -I FORWARD  -m policy --dir out --pol ipsec --proto esp -j ACCEPT
      iptables -I OUTPUT   -m policy --dir out --pol ipsec --proto esp -j ACCEPT</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\/etc\/firewall.user&quot;,&quot;hid&quot;:&quot;etcfirewalluser&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:10,&quot;range&quot;:&quot;2616-2976&quot;} -->
<h2 class="sectionedit11" id="etcconfigfirewall">/etc/config/firewall</h2>
<div class="level2">
<pre class="code">      config rule
              option &#039;src&#039; &#039;wan&#039;
              option &#039;proto&#039; &#039;esp&#039;
              option &#039;target&#039; &#039;ACCEPT&#039;
      
      config rule
              option &#039;src&#039; &#039;wan&#039;
              option &#039;proto&#039; &#039;udp&#039;
              option &#039;dest_port&#039; &#039;500&#039;
              option &#039;target&#039; &#039;ACCEPT&#039;
      
      config rule
              option &#039;src&#039; &#039;wan&#039;
              option &#039;proto&#039; &#039;udp&#039;
              option &#039;dest_port&#039; &#039;4500&#039;
              option &#039;target&#039; &#039;ACCEPT&#039;
      
      config rule
              option &#039;src&#039; &#039;wan&#039;
              option &#039;proto&#039; &#039;ah&#039;
              option &#039;target&#039; &#039;ACCEPT&#039;</pre>

<p>
next (certificates) is taken from <a href="http://wiki.strongswan.org/projects/strongswan/wiki/IOS_(Apple)" class="urlextern" title="http://wiki.strongswan.org/projects/strongswan/wiki/IOS_(Apple)" rel="ugc nofollow">http://wiki.strongswan.org/projects/strongswan/wiki/IOS_(Apple)</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\/etc\/config\/firewall&quot;,&quot;hid&quot;:&quot;etcconfigfirewall&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:11,&quot;range&quot;:&quot;2977-3754&quot;} -->
<h1 class="sectionedit12" id="certificates_generation">certificates generation</h1>
<div class="level1">
<pre class="code">      ipsec pki --gen --outform pem &gt; caKey.pem
      ipsec pki --self --in caKey.pem --dn &quot;C=DE, O=xxx, CN=xxxx&quot; --ca --outform pem &gt; caCert.pem</pre>
<pre class="code">      ipsec pki --gen --outform pem &gt; serverKey.pem
      ipsec pki --pub --in serverKey.pem | ipsec pki --issue --cacert caCert.pem --cakey caKey.pem --dn &quot;C=DE, O=xxx, CN=xxx.dyndns.org&quot; \
      --san=&quot;xxx.dyndns.org&quot; --flag serverAuth --flag ikeIntermediate --outform pem &gt; serverCert.pem</pre>
<pre class="code">      ipsec pki --gen --outform pem &gt; clientKey.pem
      ipsec pki --pub --in clientKey.pem | ipsec pki --issue --cacert caCert.pem --cakey caKey.pem --dn &quot;C=DE, O=xxx, CN=client&quot; --outform pem &gt; clientCert.pem</pre>
<pre class="code">      openssl pkcs12 -export -inkey clientKey.pem -in clientCert.pem -name &quot;client&quot; -certfile caCert.pem -caname &quot;xxxx&quot; -out clientCert.p12</pre>

<p>
Replace xxx.dyndns.org with the hostname or <abbr title="Internet Protocol">IP</abbr> adress which is used to contact the <abbr title="Virtual Private Network">VPN</abbr> server.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;certificates generation&quot;,&quot;hid&quot;:&quot;certificates_generation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:12,&quot;range&quot;:&quot;3755-4697&quot;} -->
<h1 class="sectionedit13" id="copy_certificates">copy certificates</h1>
<div class="level1">
<pre class="code">      cp caCert.pem /etc/ipsec.d/cacerts/
      cp serverCert.pem /etc/ipsec.d/certs/
      cp serverKey.pem /etc/ipsec.d/private/</pre>
<pre class="code">      cp clientCert.pem /etc/ipsec.d/certs/
      cp clientKey.pem /etc/ipsec.d/private/</pre>

<p>
Email caCert.pem and clientCert.p12 to Your IPhone/IPad and import them. Create an IPSec <abbr title="Virtual Private Network">VPN</abbr> Connection from the settings app and use the client certificated and the credentials added to /etc/ipsec.secrets ... and you&#039;re done.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;copy certificates&quot;,&quot;hid&quot;:&quot;copy_certificates&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:13,&quot;range&quot;:&quot;4698-5189&quot;} -->
<h1 class="sectionedit14" id="troubleshooting">Troubleshooting</h1>
<div class="level1">

<p>
If you experience errors, like:
</p>
<pre class="code">      07[KNL] received netlink error: Function not implemented (89)
      07[KNL] unable to add SAD entry with SPI ccc321fa
      07[KNL] received netlink error: Function not implemented (89)
      07[KNL] unable to add SAD entry with SPI 07d0af31
      07[IKE] unable to install inbound and outbound IPsec SA (SAD) in kernel</pre>

<p>
You are most likely missing following packages: 
</p>
<pre class="code">      strongswan-mod-kernel-libipsec
      kmod-tun</pre>

<p>
After these are installed, problem should be fixed.
</p>

<p>
If you have problems with reaching of <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>.. You probably should install also following modules:
</p>
<pre class="code">      ipset
      iptables-mod-filter
      iptables-mod-nat-extra
      ppp-mod-pppoe</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:14,&quot;range&quot;:&quot;5190-&quot;} -->