
<h1 class="sectionedit1" id="cloudflare_tunnel">Cloudflare tunnel</h1>
<div class="level1">
<blockquote><div class="no">
 <a href="https://www.cloudflare.com/products/tunnel/" class="urlextern" title="https://www.cloudflare.com/products/tunnel/" rel="ugc nofollow">Cloudflare Tunnel</a> provides you with a secure way to connect your resources to <a href="https://www.cloudflare.com/" class="urlextern" title="https://www.cloudflare.com/" rel="ugc nofollow">Cloudflare</a> without a publicly routable <abbr title="Internet Protocol">IP</abbr> address. With Tunnel, you do not send traffic to an external <abbr title="Internet Protocol">IP</abbr> — instead, a lightweight daemon in your infrastructure <code>cloudflared</code> creates outbound-only connections to Cloudflare’s global network. <a href="https://www.cloudflare.com/products/tunnel/" class="urlextern" title="https://www.cloudflare.com/products/tunnel/" rel="ugc nofollow">Cloudflare Tunnel</a> can connect <abbr title="Hypertext Transfer Protocol">HTTP</abbr> web servers, <abbr title="Secure Shell">SSH</abbr> servers, remote desktops, and other protocols safely to <a href="https://www.cloudflare.com/" class="urlextern" title="https://www.cloudflare.com/" rel="ugc nofollow">Cloudflare</a>. This way, your origins can serve traffic through <a href="https://www.cloudflare.com/" class="urlextern" title="https://www.cloudflare.com/" rel="ugc nofollow">Cloudflare</a> without being vulnerable to attacks that bypass <a href="https://www.cloudflare.com/" class="urlextern" title="https://www.cloudflare.com/" rel="ugc nofollow">Cloudflare</a>.</div></blockquote>

<p>
Beyond enhancing security and privacy, Cloudflare Zero Trust Tunnel is frequently used for <abbr title="Network Address Translation">NAT</abbr> traversal, especially in environments with <a href="https://en.wikipedia.org/wiki/Carrier-grade_NAT" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Carrier-grade_NAT">CGN</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Cloudflare tunnel&quot;,&quot;hid&quot;:&quot;cloudflare_tunnel&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-993&quot;} -->
<h2 class="sectionedit2" id="site">Site</h2>
<div class="level2">

<p>
Start by creating an account at <a href="https://www.cloudflare.com/plans/" class="urlextern" title="https://www.cloudflare.com/plans/" rel="ugc nofollow">https://www.cloudflare.com/plans/</a>.
The <em>free plan</em> is sufficient for most users.
</p>

<p>
You require a domain to add as a site to Cloudflare&#039;s service.
You receive instructions on how to point the domain to selected Cloudflare <abbr title="Domain Name System">DNS</abbr> servers
Sometimes it takes a while for <abbr title="Domain Name System">DNS</abbr> to propagate.
In the meantime set up the rest of your settings.
I registered a cheap domain specific for this purpose and have no plans to host anything there for an audience.
Finally, once <abbr title="Domain Name System">DNS</abbr> has propagated and your site&#039;s status says active, we can proceed.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Site&quot;,&quot;hid&quot;:&quot;site&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;994-1575&quot;} -->
<h3 class="sectionedit3" id="zero_trust">Zero trust</h3>
<div class="level3">

<p>
Select <em>Zero Trust</em> from the sidebar; this is where tunnels are managed.
Set up things as you like. For example, under <em>Gateway</em> you find <abbr title="Domain Name System">DNS</abbr> and Firewall policies;
there is no need to touch them at all to get tunnel(s) working. Under <em>Settings</em> → <em>General settings</em> you can find your <strong>Team domain</strong>.
The sub-domain/hostname part, meaning that part before <em>.cloudflareaccess.com</em> is something that you should remember.
When you log in with <strong>WARP</strong> (available for desktop OSs and phones) to establish a client connection, this Team ID is asked upon logon.
So write it down if it is difficult to remember.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Zero trust&quot;,&quot;hid&quot;:&quot;zero_trust&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;1576-2216&quot;} -->
<h3 class="sectionedit4" id="important_note">Important note</h3>
<div class="level3">

<p>
Under <em>Settings</em> → <em>Network</em> are settings for the proxy. To get tunnels working, you <strong>must</strong> enable the proxy.
By default, it seems to be disabled. When you enable it, you can select either <abbr title="Transmission Control Protocol">TCP</abbr> or <abbr title="User Datagram Protocol">UDP</abbr>, or both.
This part is rarely mentioned in other guides.
</p>

<p>
Other settings on that page are not important for tunneling, except <em>Split tunnels and local domain fallback</em> - so select <strong>manage</strong>.
There, are settings for <strong>device enrolments</strong>. Make necessary changes there for login requirements.
For example, <em>*.yourmaildomain.com</em>.
</p>

<p>
Edit also the <em>default profile</em> - there you find the section <em>Split tunnels</em>. Select what you prefer.
In this example, we choose to <strong>Exclude IPs and domains</strong>.
Click <em>manage</em> then find a list of subnets, <abbr title="Internet Protocol">IP</abbr> addresses, and domain names.
Make sure that the network you want to connect to is not on the list.
For example, if your <abbr title="Local Area Network">LAN</abbr> is 192.168.0.1/24, make sure none of the subnets on the list include your used <abbr title="Internet Protocol">IP</abbr> range.
</p>

<p>
For service mode, I chose <em>Gateway with WARP</em>. Unsure whether other modes work.
It should be chosen as default.
</p>

<p>
If you want local <abbr title="Domain Name System">DNS</abbr> to resolve to <abbr title="Internet Protocol">IP</abbr> addresses, set this under <em>Local Domain Fallback</em>.
As I did not use it, I cannot comment.
</p>

<p>
On <em>Device posture</em>, as <em>WARP Client checks</em>, I added <strong>Gateway</strong> with name <em>Gateway</em> - but that is possibly not a requirement.
Other settings on that page can be left as-is.
</p>

<p>
Finally, basic setup is complete.
<strong>Keep your browser open and make sure you stay logged in to Cloudflare</strong>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Important note&quot;,&quot;hid&quot;:&quot;important_note&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;2217-3752&quot;} -->
<h2 class="sectionedit5" id="openwrt_shell">OpenWrt shell</h2>
<div class="level2">

<p>
Login to your router and install <em>cloudflared</em> package:
</p>
<pre class="code">opkg update
opkg install cloudflared</pre>

<p>
Settings are in <code>/etc/config/cloudflared</code>, but the only setting that should be changed is the <code>enabled</code> boolean.
It is <code>false</code> by default.
</p>

<p>
Another location is at <code>/etc/cloudflared</code>, some changes there are necessary but at this moment, we won&#039;t touch anything there.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;OpenWrt shell&quot;,&quot;hid&quot;:&quot;openwrt_shell&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;3753-4168&quot;} -->
<h2 class="sectionedit6" id="let_s_create_our_tunnel">Let&#039;s create our tunnel</h2>
<div class="level2">

<p>
You can create a tunnel in the Cloudflare dashboard or via command line on your machine (“locally managed”).
</p>

<p>
Go to Zero Trust Dashboard at <a href="https://one.dash.cloudflare.com/" class="urlextern" title="https://one.dash.cloudflare.com/" rel="ugc nofollow">https://one.dash.cloudflare.com/</a>
Open <em>Networks</em> → <em>Tunnels</em> and click on <em>Create a tunnel</em>.
</p>

<p>
You can copy the token from “4. Run the following command:” and put it into <code>/etc/config/cloudflared</code> option <code>token</code>.
</p>

<p>
Then you need to specify a Public Hostname with type <abbr title="Hypertext Transfer Protocol">HTTP</abbr> and <abbr title="Uniform Resource Locator">URL</abbr> <code><a href="http://localhost:80" class="urlextern" title="http://localhost:80" rel="ugc nofollow">http://localhost:80</a></code> where your Luci or website is running.
</p>

<p>
Then restart daemon with <code>/etc/init.d/cloudflared restart</code>.
It may take up to 3 minutes while the tunnel will be established.
Once you see in logs <code>Updated to new configuration config=“{\”ingress\</code> then your local tunnel was established and received its config.
</p>

<p>
Since a tunnel is configured remotely you may need to open <code>/etc/cloudflared/config.yml</code> and comment all lines there.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Let&#039;s create our tunnel&quot;,&quot;hid&quot;:&quot;let_s_create_our_tunnel&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:6,&quot;range&quot;:&quot;4169-5088&quot;} -->
<h2 class="sectionedit7" id="create_tunnel_from_a_command_line">Create tunnel from a command line</h2>
<div class="level2">

<p>
First you&#039;ll need to run <code>cloudflared tunnel login</code>:
</p>
<pre class="code">root@openwrt:/etc/cloudflared# cloudflared tunnel login
Please open the following URL and log in with your Cloudflare account:

https://dash.cloudflare.com/argotunnel?callback=https%3A%2F%2Flogin.cloudflareaccess.org%2FXXXXXXXXXX

Leave cloudflared running to download the cert automatically.</pre>

<p>
Copy the link and open it in your <strong>browser</strong> to proceed. If you were still logged in, you will
get a view where you see the site as option that we added in the beginning.
Select your site and click <strong>Authorize</strong>.
</p>

<p>
Go back to your OpenWrt shell, and you see a notification that <strong>cert.pem</strong> has been created.
We copy it to <code>cloudflared</code>s <strong>config path</strong>.
</p>
<pre class="code">You have successfully logged in.
If you wish to copy your credentials to a server, they have been saved to:
/root/.cloudflared/cert.pem
root@openwrt:/etc/cloudflared# cp /root/.cloudflared/cert.pem /etc/cloudflared/</pre>

<p>
Next we create the tunnel named <code>TUNNELNAME</code>.
Copy the generated <code>json</code> config file to the <code>/etc/cloudflared/</code> config path. <code>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</code> is the generated id.
</p>
<pre class="code">root@openwrt:/etc/cloudflared# cloudflared tunnel create TUNNELNAME
Tunnel credentials written to /root/.cloudflared/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX.json. cloudflared chose this file based on where your origin certificate was found. Keep this file secret. To revoke these credentials, delete the tunnel.

Created tunnel TUNNELNAME with id XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
root@openwrt:/etc/cloudflared# cp /root/.cloudflared/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX.json /etc/cloudflared/</pre>

</div>

<h4 id="get_json_file_from_configured_tunnel_token">Get JSON file from configured tunnel token</h4>
<div class="level4">

<p>
<strong>I already created my tunnel from CF dashboard, how can i get json file?</strong>
</p>

<p>
Token and JSON actually contain the same information, just in slightly different formats.
</p>

<p>
<strong>How to convert token to JSON</strong>
</p>
<ol>
<li class="level1"><div class="li"> Decode token from base64. It will become a JSON data with one-letter keys.</div>
</li>
<li class="level1"><div class="li"> Replace keys with longer versions: a → AccountTag, t → TunnelID, s → TunnelSecret.</div>
</li>
</ol>

<p>
<strong>How to convert JSON to token</strong>
</p>

<p>
Just the opposite:
</p>
<ol>
<li class="level1"><div class="li"> Convert keys to short versions: AccountTag → a, TunnelID → t, TunnelSecret → s</div>
</li>
<li class="level1"><div class="li"> Remove whitespaces and line ends, if any</div>
</li>
<li class="level1"><div class="li"> Encode to base64, probably removing trailing = if any.</div>
</li>
</ol>

<p>
Edit <code>/etc/cloudflared/config.yml</code>: I commented out the first line about the <abbr title="Uniform Resource Locator">URL</abbr> which is superfluous:
</p>
<dl class="code">
<dt><a href="/_export/code/docs/guide-user/services/vpn/cloudfare_tunnel?codeblock=4" title="Download Snippet" class="mediafile mf_yml">/etc/cloudflared/config.yml</a></dt>
<dd><pre class="code">#url: http://localhost:8000
tunnel: XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
credentials-file: /etc/cloudflared/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX.json</pre>
</dd></dl>

<p>
I got errors logged about wrong <code>sysctl</code> values so put the settings to I created the <code>/etc/sysctl.d/30-cloudflared-conf</code> file:
</p>
<dl class="code">
<dt><a href="/_export/code/docs/guide-user/services/vpn/cloudfare_tunnel?codeblock=5" title="Download Snippet" class="mediafile mf_d_30-cloudflared-conf">/etc/sysctl.d/30-cloudflared-conf</a></dt>
<dd><pre class="code bash">net.ipv4.ping_group_range=<span class="st0">&quot;0 429296729&quot;</span>
net.core.rmem_max=<span class="nu0">2500000</span></pre>
</dd></dl>

<p>
After this, restart the service: <code>/etc/init.d/cloudflared restart</code>
</p>

<p>
Return to the browser and at <em>Cloudflare Zero Trust</em>, open <em>Access</em> → <em>Tunnels</em>.
In the list should be our freshly created <code>TUNNELNAME</code>.
</p>

<p>
Choose to configure it and you are prompted that <code>TUNNELNAME</code> must be irreversibly migrated.
Go ahead and migrate it, confirm all queries.
Now, re-configure it. Choose <em>Private Network</em> tab and add new network.
On the CIDR prompt add your <abbr title="Local Area Network">LAN</abbr> subnet. In this example it was 192.168.0.0/24.
</p>

<p>
After this we enable, and restart <code>cloudflared</code>:
</p>
<pre class="code bash"><span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>cloudflared stop
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>cloudflared <span class="kw3">enable</span>
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>cloudflared start</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Create tunnel from a command line&quot;,&quot;hid&quot;:&quot;create_tunnel_from_a_command_line&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:7,&quot;range&quot;:&quot;5089-8694&quot;} -->
<h2 class="sectionedit8" id="test_network">Test network</h2>
<div class="level2">

<p>
Install <strong>Cloudflare WARP</strong> to your phone, <strong>disable wi-fi</strong> staying on the mobile network and start <strong>WARP</strong>. In <em>Settings</em> → <em>Account</em>, enter your <strong>team name</strong>. This is in Cloudflare <em>General Settings</em>. If you added suitable rules to <em>Settings</em> → <em>Warp settings</em> → <em>Device enrollment</em> you will be asked your credentials, i.e. email address. You are emailed a verification code which you need to enter there.
</p>

<p>
Under <em>WARP&#039;s Settings</em> → <em>Advanced</em> → <em>Connection options</em> → <em>Excluded routes</em> verify
that your <abbr title="Local Area Network">LAN</abbr> subnet is absent from the list - we previously excluded it. Under <em>Virtual Networks</em>,  verify that the profile you chose is checked. I edited the default profile without creating a new one. Finally, exit settings. The front page should say Zero Trust, Connected and Your internet is protected. Open your web browser and point it to your <strong>router&#039;s <abbr title="Internet Protocol">IP</abbr></strong> at 192.168.0.1 and if all went well,
LuCi opens (in case you have it installed).
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Test network&quot;,&quot;hid&quot;:&quot;test_network&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:8,&quot;range&quot;:&quot;8695-9697&quot;} -->
<h2 class="sectionedit9" id="one_final_note">One final note</h2>
<div class="level2">

<p>
You may notice that <abbr title="Internet Control Message Protocol">ICMP</abbr> <strong>ping</strong> doesn&#039;t work. This is normal and you cannot do anything about it
because we enabled <abbr title="Transmission Control Protocol">TCP</abbr> and <abbr title="User Datagram Protocol">UDP</abbr>, while <strong><abbr title="Internet Control Message Protocol">ICMP</abbr></strong> used by ping is unavailable as a feature on <code>cloudflared</code>.
</p>

<p>
If you see a message “failed to dial to edge with quic” this is a known issue <a href="https://github.com/openwrt/packages/issues/23596" class="urlextern" title="https://github.com/openwrt/packages/issues/23596" rel="ugc nofollow">https://github.com/openwrt/packages/issues/23596</a>.
The <abbr title="User Datagram Protocol">UDP</abbr> and QUIC are not so important unless you are on mobile internet with many packet loses.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;One final note&quot;,&quot;hid&quot;:&quot;one_final_note&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:9,&quot;range&quot;:&quot;9698-10158&quot;} -->
<h2 class="sectionedit10" id="see_also">See also</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="https://community.cloudflare.com/t/openwrt-support/610306" class="urlextern" title="https://community.cloudflare.com/t/openwrt-support/610306" rel="ugc nofollow">Support forum</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/configure-tunnels/tunnel-run-parameters/" class="urlextern" title="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/configure-tunnels/tunnel-run-parameters/" rel="ugc nofollow">Tunnel general-purpose parameters</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/configure-tunnels/local-management/configuration-file/" class="urlextern" title="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/configure-tunnels/local-management/configuration-file/" rel="ugc nofollow">config.yml file parameters</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/Coralesoft/OpenwrtCloudflare" class="urlextern" title="https://github.com/Coralesoft/OpenwrtCloudflare" rel="ugc nofollow">install-cloudflared.sh</a> Install wizard script</div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/cloudflare/cloudflared/issues/929#issuecomment-2078157277" class="urlextern" title="https://github.com/cloudflare/cloudflared/issues/929#issuecomment-2078157277" rel="ugc nofollow"> How to convert token to JSON</a> </div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;See also&quot;,&quot;hid&quot;:&quot;see_also&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:10,&quot;range&quot;:&quot;10159-&quot;} -->