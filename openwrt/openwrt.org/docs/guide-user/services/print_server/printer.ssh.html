
<h1 class="sectionedit1" id="printing_over_ssh">Printing over SSH</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Printing over SSH&quot;,&quot;hid&quot;:&quot;printing_over_ssh&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-33&quot;} -->
<h2 class="sectionedit2" id="introduction">Introduction</h2>
<div class="level2">

<p>
This page describes a way to make CUPS print, over <abbr title="Secure Shell">SSH</abbr>,
to a USB printer attached to an OpenWrt device.
</p>

<p>
No extra software is required, other than some shell scripts and the
standard USB driver; and no storage is required on the OpenWrt device.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Introduction&quot;,&quot;hid&quot;:&quot;introduction&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;34-306&quot;} -->
<h2 class="sectionedit3" id="cups_setup">CUPS setup</h2>
<div class="level2">

<p>
Install the following script on a system running CUPS,
using the instructions in its comment block.
<code>DeviceURI</code> in <code>printers.conf</code> should point to your OpenWrt system.
</p>
<pre class="code bash"><span class="co0">#!/bin/sh</span>
<span class="co0"># copyright waived as per CC0:</span>
<span class="co0"># https://creativecommons.org/publicdomain/zero/1.0/legalcode-plain</span>
&nbsp;
<span class="co0"># This CUPS backend will forward each job to the standard input of a program on</span>
<span class="co0"># a remote system, via ssh.</span>
<span class="co0">#</span>
<span class="co0"># Install it as /usr/lib/cups/backend/ssh; either use &quot;chmod u+x,go-wx&quot; to make</span>
<span class="co0"># it run as root, or &quot;chmod ugo+x,go-w&quot; to run as the CUPS user (generally lp).</span>
<span class="co0"># Create a passwordless ssh key as that user, e.g.:</span>
<span class="co0">#   # mkdir -p -m 711 ~lp</span>
<span class="co0">#   # chown lp: ~lp</span>
<span class="co0">#   # su -s /bin/sh lp -c &quot;ssh-keygen -N '' -t rsa -b 2048&quot;</span>
<span class="co0"># And add the key to an ssh authorized_keys file on the remote system:</span>
<span class="co0">#   command=&quot;./recv-lpjob&quot;,no-pty,no-port-forwarding ssh-rsa AAAAB2...19Q== lp@cups.example.net</span>
<span class="co0">#</span>
<span class="co0"># To enable it, add this to /etc/cups/printers.conf while cups is not running:</span>
<span class="co0">#   &lt;Printer ssh_example&gt;</span>
<span class="co0">#   UUID urn:uuid:e2f74bc0-2d45-4afd-915e-a16df20c49a1</span>
<span class="co0">#   DeviceURI ssh://root@openwrt.example.net:22/dev/usb/lp0</span>
<span class="co0">#   State Idle</span>
<span class="co0">#   Type 8388612</span>
<span class="co0">#   Accepting Yes</span>
<span class="co0">#   Shared No</span>
<span class="co0">#   ErrorPolicy retry-current-job</span>
<span class="co0">#   &lt;/Printer&gt;</span>
<span class="co0"># Be sure to connect once manually so the host key fingerprint is known:</span>
<span class="co0">#   # su -s /bin/bash lp</span>
<span class="co0">#   $ ssh -p 22 root@openwrt.example.net &lt; /dev/null</span>
<span class="co0"># Install a PPD file as /etc/cups/ppd/ssh_example.ppd if necessary.</span>
<span class="co0">#</span>
<span class="co0"># To debug, set &quot;LogLevel warn&quot; in /etc/cups/cupsd.conf; stderr will be saved</span>
<span class="co0"># in /var/log/cups/error_log.</span>
&nbsp;
<span class="kw1">set</span> <span class="re5">-o</span> errexit
<span class="kw1">set</span> <span class="re5">-o</span> nounset
&nbsp;
<span class="re2">remote_cmd</span>=.<span class="sy0">/</span>recv-lpjob
&nbsp;
<span class="re2">CUPS_BACKEND_OK</span>=<span class="nu0">0</span>
<span class="re2">CUPS_BACKEND_FAILED</span>=<span class="nu0">1</span>
<span class="re2">CUPS_BACKEND_AUTH_REQUIRED</span>=<span class="nu0">2</span>  <span class="co0"># cups will rewrite printers.conf with auth. data</span>
<span class="re2">CUPS_BACKEND_HOLD</span>=<span class="nu0">3</span>
<span class="re2">CUPS_BACKEND_STOP</span>=<span class="nu0">4</span>
<span class="re2">CUPS_BACKEND_CANCEL</span>=<span class="nu0">5</span>  <span class="co0"># could be bad options</span>
<span class="re2">CUPS_BACKEND_RETRY</span>=<span class="nu0">6</span>
<span class="re2">CUPS_BACKEND_RETRY_CURRENT</span>=<span class="nu0">7</span>
&nbsp;
debugf <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="re2">dbg</span>=<span class="st0">&quot;[backend/ssh] $1&quot;</span>
	<span class="kw3">shift</span>
	<span class="kw3">printf</span> <span class="st0">&quot;<span class="es2">$dbg</span>&quot;</span> <span class="st0">&quot;$@&quot;</span> <span class="sy0">&gt;&amp;</span><span class="nu0">2</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="st0">&quot;$#&quot;</span> <span class="re5">-eq</span> <span class="nu0">0</span> <span class="br0">&#93;</span>
<span class="kw1">then</span>
	debugf <span class="st_h">'in discovery mode\n'</span>
&nbsp;
	<span class="co0"># Output zero or more lines in any of these formats:</span>
	<span class="co0">#   device-class scheme &quot;Unknown&quot; &quot;device-info&quot;</span>
	<span class="co0">#   device-class device-uri &quot;device-make-and-model&quot; &quot;device-info&quot;</span>
	<span class="co0">#   device-class device-uri &quot;device-make-and-model&quot; &quot;device-info&quot; &quot;device-id&quot;</span>
	<span class="co0">#   device-class device-uri &quot;device-make-and-model&quot; &quot;device-info&quot; &quot;device-id&quot; &quot;device-location&quot;</span>
	<span class="co0"># Quoted strings use '\' as escape.</span>
&nbsp;
	<span class="kw3">printf</span> <span class="st_h">'direct ssh &quot;Unknown&quot; &quot;%s&quot;\n'</span> <span class="st0">&quot;prints via ssh&quot;</span>
	<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_OK</span>&quot;</span>
<span class="kw1">elif</span> <span class="br0">&#91;</span> <span class="st0">&quot;$#&quot;</span> <span class="re5">-lt</span> <span class="nu0">5</span> <span class="br0">&#93;</span>
<span class="kw1">then</span>
	<span class="kw3">printf</span> <span class="st_h">'Usage: %s job-id user title copies options [file ...]\n'</span> <span class="st0">&quot;$0&quot;</span> <span class="sy0">&gt;&amp;</span><span class="nu0">2</span>
	<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_FAILED</span>&quot;</span>
<span class="kw1">fi</span>
&nbsp;
<span class="re2">ssh_user</span>=<span class="st_h">''</span>
<span class="re2">ssh_host</span>=<span class="st_h">''</span>
<span class="re2">ssh_port</span>=<span class="st_h">''</span>
<span class="re2">ssh_path</span>=<span class="st_h">''</span>
&nbsp;
<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$DEVICE_URI</span>&quot;</span> <span class="kw1">in</span>
ssh:<span class="sy0">//*</span><span class="br0">&#41;</span>  <span class="co0"># https://tools.ietf.org/html/draft-ietf-secsh-scp-sftp-ssh-uri-04</span>
	<span class="re2">x</span>=<span class="co1">${DEVICE_URI#ssh://}</span>
&nbsp;
	<span class="co0"># strip off any path; the other end can try to handle it</span>
	<span class="re2">y</span>=<span class="co1">${x%%/*}</span>
	<span class="re2">ssh_path</span>=<span class="co1">${x#&quot;$y&quot;}</span>
	<span class="re2">x</span>=<span class="re1">$y</span>
&nbsp;
	<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$x</span>&quot;</span> <span class="kw1">in</span> <span class="sy0">*%*</span><span class="br0">&#41;</span>
		debugf <span class="st_h">'Unescaping not implemented for URI &quot;%s&quot;\n'</span> \
				<span class="st0">&quot;<span class="es2">$DEVICE_URI</span>&quot;</span>
		<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_CANCEL</span>&quot;</span>
	<span class="kw1">esac</span>
&nbsp;
	<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$x</span>&quot;</span> <span class="kw1">in</span> <span class="sy0">*@*</span><span class="br0">&#41;</span>
		<span class="re2">ssh_user</span>=<span class="co1">${x%%@*}</span>
		<span class="re2">x</span>=<span class="co1">${x#*@}</span>
		<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$ssh_user</span>&quot;</span> <span class="kw1">in</span> <span class="st_h">''</span> <span class="sy0">|</span> <span class="sy0">*</span>:<span class="sy0">*</span> <span class="sy0">|</span> <span class="sy0">*</span>\;<span class="sy0">*</span> <span class="sy0">|</span> -<span class="sy0">*</span><span class="br0">&#41;</span>
			debugf <span class="st_h">'Bad/unsupported userinfo &quot;%s&quot; in URI &quot;%s&quot;\n'</span> \
					<span class="st0">&quot;<span class="es2">$ssh_user</span>&quot;</span> <span class="st0">&quot;<span class="es2">$DEVICE_URI</span>&quot;</span>
			<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_CANCEL</span>&quot;</span>
		<span class="kw1">esac</span>
	<span class="kw1">esac</span>
&nbsp;
	<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$x</span>&quot;</span> <span class="kw1">in</span>
	<span class="st_h">''</span> <span class="sy0">|</span> <span class="br0">&#91;</span>-:<span class="br0">&#93;</span><span class="sy0">*</span> <span class="sy0">|</span> <span class="sy0">*</span>:<span class="sy0">*</span>:<span class="sy0">*</span><span class="br0">&#41;</span>
		debugf <span class="st_h">'Bad address &quot;%s&quot; in URI &quot;%s&quot;\n'</span> \
				<span class="st0">&quot;<span class="es2">$x</span>&quot;</span> <span class="st0">&quot;<span class="es2">$DEVICE_URI</span>&quot;</span>
		<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_CANCEL</span>&quot;</span>
		<span class="sy0">;;</span>
	<span class="sy0">*</span>:<span class="sy0">*</span><span class="br0">&#41;</span>
		<span class="re2">ssh_port</span>=<span class="co1">${x#*:}</span>
		<span class="re2">x</span>=<span class="co1">${x%%:*}</span>
	<span class="kw1">esac</span>
&nbsp;
	<span class="re2">ssh_host</span>=<span class="re1">$x</span>
	<span class="sy0">;;</span>
<span class="sy0">*</span><span class="br0">&#41;</span>
	debugf <span class="st_h">'Bad scheme in URI &quot;%s&quot;\n'</span> <span class="st0">&quot;<span class="es2">$DEVICE_URI</span>&quot;</span>
	<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_CANCEL</span>&quot;</span>
<span class="kw1">esac</span>
&nbsp;
debugf <span class="st_h">'ssh-user: %s\n'</span> <span class="st0">&quot;<span class="es2">$ssh_user</span>&quot;</span>
debugf <span class="st_h">'ssh-host: %s\n'</span> <span class="st0">&quot;<span class="es2">$ssh_host</span>&quot;</span>
debugf <span class="st_h">'ssh-port: %s\n'</span> <span class="st0">&quot;<span class="es2">$ssh_port</span>&quot;</span>
debugf <span class="st_h">'ssh-path: %s\n'</span> <span class="st0">&quot;<span class="es2">$ssh_path</span>&quot;</span>
&nbsp;
<span class="re2">job_id</span>=<span class="re4">$1</span>
<span class="re2">user</span>=<span class="re4">$2</span>
<span class="re2">title</span>=<span class="re4">$3</span>
<span class="re2">copies</span>=<span class="re4">$4</span>
<span class="re2">options</span>=<span class="re4">$5</span>
<span class="kw3">shift</span> <span class="nu0">5</span>
<span class="co0"># remaining arguments are filenames</span>
&nbsp;
debugf <span class="st_h">'job-id: %s\n'</span> <span class="st0">&quot;<span class="es2">$job_id</span>&quot;</span>
debugf <span class="st_h">'user: %s\n'</span> <span class="st0">&quot;<span class="es2">$user</span>&quot;</span>
debugf <span class="st_h">'title: %s\n'</span> <span class="st0">&quot;<span class="es2">$title</span>&quot;</span>
debugf <span class="st_h">'copies: %s\n'</span> <span class="st0">&quot;<span class="es2">$copies</span>&quot;</span>
debugf <span class="st_h">'options: %s\n'</span> <span class="st0">&quot;<span class="es2">$options</span>&quot;</span>
<span class="br0">&#91;</span> <span class="st0">&quot;$#&quot;</span> <span class="re5">-gt</span> <span class="nu0">0</span> <span class="br0">&#93;</span> <span class="sy0">||</span> debugf <span class="st_h">'file not set\n'</span>
<span class="kw1">for</span> <span class="kw2">file</span>
<span class="kw1">do</span>
	debugf <span class="st_h">'file: %s\n'</span> <span class="st0">&quot;<span class="es2">$file</span>&quot;</span>
<span class="kw1">done</span>
&nbsp;
do_printing <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw3">printf</span> <span class="st_h">'set path=%s\n'</span> <span class="st0">&quot;<span class="es2">$ssh_path</span>&quot;</span>
	<span class="kw3">printf</span> <span class="st_h">'set job_id=%s\n'</span> <span class="st0">&quot;<span class="es2">$job_id</span>&quot;</span>
	<span class="kw3">printf</span> <span class="st_h">'set user=%s\n'</span> <span class="st0">&quot;<span class="es2">$user</span>&quot;</span>
	<span class="kw3">printf</span> <span class="st_h">'set title=%s\n'</span> <span class="st0">&quot;<span class="es2">$title</span>&quot;</span>
	<span class="kw3">printf</span> <span class="st_h">'set options=%s\n'</span> <span class="st0">&quot;<span class="es2">$options</span>&quot;</span>
	<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="st0">&quot;$#&quot;</span> <span class="re5">-eq</span> <span class="nu0">0</span> <span class="br0">&#93;</span>
	<span class="kw1">then</span>
		debugf <span class="st_h">'printing stdin\n'</span>
		<span class="kw3">printf</span> <span class="st_h">'print\n'</span>
		<span class="kw2">cat</span>
		<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="st0">&quot;<span class="es2">$copies</span>&quot;</span> <span class="re5">-gt</span> <span class="nu0">1</span> <span class="br0">&#93;</span>
		<span class="kw1">then</span>
			debugf <span class="st_h">'cannot print multiple copies from stdin\n'</span>
		<span class="kw1">fi</span>
	<span class="kw1">else</span>
		<span class="kw1">while</span> <span class="br0">&#91;</span> <span class="st0">&quot;<span class="es2">$copies</span>&quot;</span> <span class="re5">-gt</span> <span class="nu0">0</span> <span class="br0">&#93;</span>
		<span class="kw1">do</span>
			<span class="re2">copies</span>=$<span class="br0">&#40;</span><span class="br0">&#40;</span>copies - <span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
			<span class="re2">n</span>=<span class="re4">$#</span>
			<span class="kw1">while</span> <span class="br0">&#91;</span> <span class="st0">&quot;<span class="es2">$n</span>&quot;</span> <span class="re5">-gt</span> <span class="nu0">0</span> <span class="br0">&#93;</span>
			<span class="kw1">do</span>
				<span class="re2">n</span>=$<span class="br0">&#40;</span><span class="br0">&#40;</span>n -= <span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
				<span class="re2">file</span>=<span class="re4">$1</span>
				<span class="kw3">shift</span>
				<span class="kw1">set</span> <span class="re5">--</span> <span class="st0">&quot;$@&quot;</span> <span class="st0">&quot;<span class="es2">$file</span>&quot;</span>
&nbsp;
				debugf <span class="st_h">'printing file %s\n'</span> <span class="st0">&quot;<span class="es2">$file</span>&quot;</span>
				<span class="kw3">printf</span> <span class="st_h">'print '</span>; <span class="kw2">wc</span> <span class="re5">-c</span> <span class="st0">&quot;<span class="es2">$file</span>&quot;</span>
				<span class="kw2">cat</span> <span class="sy0">&lt;</span><span class="st0">&quot;<span class="es2">$file</span>&quot;</span>
			<span class="kw1">done</span>
		<span class="kw1">done</span>
	<span class="kw1">fi</span>
	debugf <span class="st_h">'done printing\n'</span>
<span class="br0">&#125;</span>
do_ssh <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">set</span> <span class="re5">--</span> <span class="kw2">ssh</span> <span class="re5">-o</span> <span class="re2">BatchMode</span>=<span class="kw2">yes</span> <span class="re5">-o</span> <span class="re2">RequestTTY</span>=no
	<span class="br0">&#91;</span> <span class="re5">-z</span> <span class="st0">&quot;<span class="es2">$ssh_port</span>&quot;</span> <span class="br0">&#93;</span> <span class="sy0">||</span> <span class="kw1">set</span> <span class="re5">--</span> <span class="st0">&quot;$@&quot;</span> <span class="re5">-p</span> <span class="st0">&quot;<span class="es2">$ssh_port</span>&quot;</span>
	<span class="co0"># use ~/.ssh/config (man ssh_config) to set global or per-host options</span>
&nbsp;
	<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-n</span> <span class="st0">&quot;<span class="es2">$ssh_user</span>&quot;</span> <span class="br0">&#93;</span>
	<span class="kw1">then</span>
		<span class="kw1">set</span> <span class="re5">--</span> <span class="st0">&quot;$@&quot;</span> <span class="st0">&quot;<span class="es2">$ssh_user</span>@<span class="es2">$ssh_host</span>&quot;</span>
	<span class="kw1">else</span>
		<span class="kw1">set</span> <span class="re5">--</span> <span class="st0">&quot;$@&quot;</span> <span class="st0">&quot;<span class="es2">$ssh_host</span>&quot;</span>
	<span class="kw1">fi</span>
&nbsp;
	<span class="kw1">set</span> <span class="re5">--</span> <span class="st0">&quot;$@&quot;</span> <span class="st0">&quot;<span class="es2">$remote_cmd</span>&quot;</span>
	debugf <span class="st_h">'will run %s\n'</span> <span class="st0">&quot;$*&quot;</span>
&nbsp;
	<span class="st0">&quot;$@&quot;</span> <span class="sy0">&gt;/</span>dev<span class="sy0">/</span>null <span class="sy0">&amp;&amp;</span> <span class="kw1">set</span> <span class="re5">--</span> <span class="nu0">0</span> <span class="sy0">||</span> <span class="kw1">set</span> <span class="re5">--</span> <span class="st0">&quot;$?&quot;</span>
	debugf <span class="st_h">'ssh exited with status %d\n'</span> <span class="st0">&quot;$1&quot;</span>
	<span class="kw3">printf</span> <span class="st_h">'%d\n'</span> <span class="st0">&quot;$1&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="re2">rc</span>=$<span class="br0">&#40;</span>do_printing <span class="st0">&quot;$@&quot;</span> <span class="sy0">|</span> do_ssh<span class="br0">&#41;</span>
debugf <span class="st_h">'exit status &quot;%s&quot;\n'</span> <span class="st0">&quot;<span class="es2">$rc</span>&quot;</span>
&nbsp;
<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$rc</span>&quot;</span> <span class="kw1">in</span>
<span class="st_h">''</span> <span class="sy0">|</span> <span class="sy0">*</span><span class="br0">&#91;</span><span class="sy0">!</span><span class="nu0">0</span>-<span class="nu0">9</span><span class="br0">&#93;</span><span class="sy0">*</span><span class="br0">&#41;</span>
	<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_FAILED</span>&quot;</span>
	<span class="sy0">;;</span>
<span class="nu0">127</span> <span class="sy0">|</span> <span class="nu0">255</span><span class="br0">&#41;</span>  <span class="co0"># ssh error</span>
	<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_RETRY_CURRENT</span>&quot;</span>
	<span class="sy0">;;</span>
<span class="kw1">esac</span>
<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$rc</span>&quot;</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;CUPS setup&quot;,&quot;hid&quot;:&quot;cups_setup&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;307-5654&quot;} -->
<h2 class="sectionedit4" id="openwrt_setup">OpenWrt setup</h2>
<div class="level2">

<p>
Save the following script as <code>/root/recv-lpjob</code> on your OpenWrt device:
</p>
<pre class="code bash"><span class="co0">#!/bin/sh</span>
<span class="co0"># copyright waived as per CC0:</span>
<span class="co0"># https://creativecommons.org/publicdomain/zero/1.0/legalcode-plain</span>
&nbsp;
<span class="kw1">set</span> <span class="re5">-o</span> errexit
<span class="kw1">set</span> <span class="re5">-o</span> nounset
&nbsp;
<span class="re2">CUPS_BACKEND_OK</span>=<span class="nu0">0</span>
<span class="re2">CUPS_BACKEND_FAILED</span>=<span class="nu0">1</span>
<span class="re2">CUPS_BACKEND_AUTH_REQUIRED</span>=<span class="nu0">2</span>  <span class="co0"># cups will rewrite printers.conf with auth. data</span>
<span class="re2">CUPS_BACKEND_HOLD</span>=<span class="nu0">3</span>
<span class="re2">CUPS_BACKEND_STOP</span>=<span class="nu0">4</span>
<span class="re2">CUPS_BACKEND_CANCEL</span>=<span class="nu0">5</span>  <span class="co0"># could be bad options</span>
<span class="re2">CUPS_BACKEND_RETRY</span>=<span class="nu0">6</span>
<span class="re2">CUPS_BACKEND_RETRY_CURRENT</span>=<span class="nu0">7</span>
&nbsp;
<span class="co0"># state variables</span>
<span class="re2">printer</span>=<span class="st_h">''</span>
<span class="re2">locked</span>=<span class="st_h">''</span>
<span class="kw3">exec</span> <span class="nu0">3</span><span class="sy0">&gt;&amp;</span>-
&nbsp;
<span class="co0"># var_* variables controlled by sender</span>
<span class="re2">var_path</span>=<span class="st_h">''</span>
<span class="re2">var_job_id</span>=<span class="st_h">''</span>
<span class="re2">var_user</span>=<span class="st_h">''</span>
<span class="re2">var_title</span>=<span class="st_h">''</span>
<span class="re2">var_options</span>=<span class="st_h">''</span>
&nbsp;
debugf <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="re2">dbg</span>=<span class="st0">&quot;[recv-lpjob] $1&quot;</span>
	<span class="kw3">shift</span>
	<span class="kw3">printf</span> <span class="st0">&quot;<span class="es2">$dbg</span>&quot;</span> <span class="st0">&quot;$@&quot;</span> <span class="sy0">&gt;&amp;</span><span class="nu0">2</span>
<span class="br0">&#125;</span>
&nbsp;
set_lock <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	debugf <span class="st_h">'setting locked=%d for &quot;%s&quot;\n'</span> <span class="st0">&quot;$2&quot;</span> <span class="st0">&quot;$1&quot;</span>
	<span class="br0">&#91;</span> <span class="st0">&quot;$1&quot;</span> <span class="sy0">!</span>= <span class="sy0">/</span>dev<span class="sy0">/</span>null <span class="br0">&#93;</span> <span class="sy0">||</span> <span class="kw3">return</span> <span class="nu0">0</span>
&nbsp;
	<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-x</span> <span class="sy0">/</span>bin<span class="sy0">/</span>lock <span class="br0">&#93;</span>
	<span class="kw1">then</span>
		debugf <span class="st_h">'using /bin/lock\n'</span>
		<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="st0">&quot;$2&quot;</span> <span class="re5">-eq</span> <span class="nu0">0</span> <span class="br0">&#93;</span>
		<span class="kw1">then</span>
			<span class="sy0">/</span>bin<span class="sy0">/</span>lock <span class="re5">-u</span> <span class="st0">&quot;$1.lock&quot;</span> <span class="sy0">||</span> <span class="kw3">return</span>
		<span class="kw1">else</span>
			<span class="sy0">/</span>bin<span class="sy0">/</span>lock <span class="st0">&quot;$1.lock&quot;</span> <span class="sy0">||</span> <span class="kw3">return</span>
		<span class="kw1">fi</span>
	<span class="kw1">else</span>
		debugf <span class="st_h">'no locks available\n'</span>
		<span class="co0"># it's OK to continue without locking;</span>
		<span class="co0"># Linux will fail a second open() with EBUSY</span>
	<span class="kw1">fi</span>
<span class="br0">&#125;</span>
&nbsp;
lock_and_open_printer <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-n</span> <span class="st0">&quot;<span class="es2">$printer</span>&quot;</span> <span class="br0">&#93;</span>
	<span class="kw1">then</span>
		close_printer
		<span class="co0"># unlock if we're switching printers</span>
		<span class="br0">&#91;</span> <span class="st0">&quot;$1&quot;</span> = <span class="st0">&quot;<span class="es2">$locked</span>&quot;</span> <span class="br0">&#93;</span> <span class="sy0">||</span> unlock_printer
	<span class="kw1">fi</span>
&nbsp;
	<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-z</span> <span class="st0">&quot;<span class="es2">$locked</span>&quot;</span> <span class="br0">&#93;</span>
	<span class="kw1">then</span>
		<span class="kw1">if</span> <span class="sy0">!</span> set_lock <span class="st0">&quot;$1&quot;</span> <span class="nu0">1</span>
		<span class="kw1">then</span>
			debugf <span class="st_h">'failed to lock &quot;%s&quot;\n'</span> <span class="st0">&quot;$1&quot;</span>
			<span class="kw3">return</span> <span class="nu0">1</span>
		<span class="kw1">fi</span>
		<span class="kw1">if</span> <span class="sy0">!</span> <span class="br0">&#91;</span> <span class="re5">-c</span> <span class="st0">&quot;$1&quot;</span> <span class="br0">&#93;</span>
		<span class="kw1">then</span>
			debugf <span class="st_h">'printer &quot;%s&quot; not found\n'</span> <span class="st0">&quot;$1&quot;</span>
			<span class="kw3">return</span> <span class="nu0">1</span>
		<span class="kw1">fi</span>
&nbsp;
		<span class="re2">locked</span>=<span class="re4">$1</span>
	<span class="kw1">fi</span>
&nbsp;
	<span class="kw1">if</span> <span class="kw3">exec</span> <span class="nu0">3</span><span class="sy0">&gt;</span><span class="st0">&quot;$1&quot;</span>
	<span class="kw1">then</span>
		debugf <span class="st_h">'opened printer &quot;%s&quot;\n'</span> <span class="st0">&quot;$1&quot;</span>
	<span class="kw1">else</span>
		debugf <span class="st_h">'failed to open printer &quot;%s&quot;\n'</span> <span class="st0">&quot;$1&quot;</span>
	<span class="kw1">fi</span>
	<span class="re2">printer</span>=<span class="re4">$1</span>
<span class="br0">&#125;</span>
&nbsp;
cat_to_printer <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw2">cat</span> <span class="sy0">&gt;&amp;</span><span class="nu0">3</span>
<span class="br0">&#125;</span>
&nbsp;
close_printer <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-n</span> <span class="st0">&quot;<span class="es2">$printer</span>&quot;</span> <span class="br0">&#93;</span>
	<span class="kw1">then</span>
		debugf <span class="st_h">'closing printer &quot;%s&quot;\n'</span> <span class="st0">&quot;<span class="es2">$printer</span>&quot;</span>
		<span class="kw3">exec</span> <span class="nu0">3</span><span class="sy0">&gt;&amp;</span>-
		<span class="re2">printer</span>=<span class="st_h">''</span>
	<span class="kw1">fi</span>
<span class="br0">&#125;</span>
&nbsp;
unlock_printer <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-n</span> <span class="st0">&quot;<span class="es2">$locked</span>&quot;</span> <span class="br0">&#93;</span>
	<span class="kw1">then</span>
		set_lock <span class="st0">&quot;<span class="es2">$locked</span>&quot;</span> <span class="nu0">0</span>
		<span class="re2">locked</span>=<span class="st_h">''</span>
	<span class="kw1">fi</span>
<span class="br0">&#125;</span>
&nbsp;
handle_set <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	debugf <span class="st_h">'got %s\n'</span> <span class="st0">&quot;$1&quot;</span>
	<span class="kw1">case</span> <span class="st0">&quot;$1&quot;</span> <span class="kw1">in</span>
	<span class="sy0">*</span>=<span class="sy0">*</span><span class="br0">&#41;</span>
		<span class="re2">key</span>=<span class="co1">${1%%=*}</span>
		<span class="re2">val</span>=<span class="co1">${1#&quot;$key&quot;}</span>
		<span class="re2">val</span>=<span class="co1">${val#=}</span>
		<span class="sy0">;;</span>
	<span class="sy0">*</span><span class="br0">&#41;</span>
		debugf <span class="st_h">'bad set command &quot;%s&quot;\n'</span> <span class="st0">&quot;<span class="es2">$line</span>&quot;</span>
		<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_CANCEL</span>&quot;</span>
	<span class="kw1">esac</span>
&nbsp;
	<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$key</span>&quot;</span> <span class="kw1">in</span> <span class="st_h">''</span> <span class="sy0">|</span> <span class="br0">&#91;</span><span class="nu0">0</span>-<span class="nu0">9</span><span class="br0">&#93;</span><span class="sy0">*</span> <span class="sy0">|</span> <span class="sy0">*</span><span class="br0">&#91;</span><span class="sy0">!</span>a-zA-Z_0-<span class="nu0">9</span><span class="br0">&#93;</span><span class="sy0">*</span><span class="br0">&#41;</span>
		debugf <span class="st_h">'bad key &quot;%s&quot;\n'</span> <span class="st0">&quot;<span class="es2">$key</span>&quot;</span>
		<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_CANCEL</span>&quot;</span>
	<span class="kw1">esac</span>
	<span class="kw3">eval</span> <span class="st0">&quot;var_<span class="es2">$key</span>=<span class="es1">\$</span>val&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
write_exitcode <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="st0">&quot;$@&quot;</span> <span class="sy0">&gt;/</span>dev<span class="sy0">/</span>null <span class="sy0">&amp;&amp;</span> <span class="kw1">set</span> <span class="re5">--</span> <span class="nu0">0</span> <span class="sy0">||</span> <span class="kw1">set</span> <span class="re5">--</span> <span class="st0">&quot;$?&quot;</span>
	<span class="kw3">printf</span> <span class="st_h">'%d\n'</span> <span class="st0">&quot;$1&quot;</span>
<span class="br0">&#125;</span>
&nbsp;
handle_print <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$var_path</span>&quot;</span> <span class="kw1">in</span>
	<span class="st_h">''</span> <span class="sy0">|</span> <span class="sy0">/</span><span class="br0">&#41;</span>
		<span class="kw1">set</span> <span class="re5">--</span> <span class="sy0">/</span>dev<span class="sy0">/</span>usb<span class="sy0">/</span><span class="kw2">lp</span><span class="sy0">*</span>
		<span class="kw1">if</span> <span class="sy0">!</span> <span class="br0">&#91;</span> <span class="re5">-e</span> <span class="st0">&quot;$1&quot;</span> <span class="br0">&#93;</span>
		<span class="kw1">then</span>
			debugf <span class="st_h">'no default printer found\n'</span>
			<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_RETRY_CURRENT</span>&quot;</span>
		<span class="kw1">fi</span>
		<span class="re2">var_path</span>=<span class="re4">$1</span>
		<span class="sy0">;;</span>
	<span class="sy0">/</span>dev<span class="sy0">/</span>usb<span class="sy0">/</span><span class="kw2">lp</span><span class="br0">&#91;</span><span class="nu0">0</span>-<span class="nu0">9</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">;;</span>
	<span class="sy0">/</span>dev<span class="sy0">/</span>null<span class="br0">&#41;</span> <span class="sy0">;;</span>
	<span class="sy0">*</span><span class="br0">&#41;</span>
		debugf <span class="st_h">'printer &quot;%s&quot; disallowed\n'</span> <span class="st0">&quot;<span class="es2">$var_path</span>&quot;</span>
		<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_CANCEL</span>&quot;</span>
	<span class="kw1">esac</span>
&nbsp;
	lock_and_open_printer <span class="st0">&quot;<span class="es2">$var_path</span>&quot;</span> <span class="sy0">||</span> <span class="kw3">return</span>
&nbsp;
	<span class="re2">arg</span>=<span class="co1">${1%% *}</span>
	<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$arg</span>&quot;</span> <span class="kw1">in</span>
	<span class="st_h">''</span><span class="br0">&#41;</span>
		debugf <span class="st_h">'printing to eof\n'</span>
		cat_to_printer
		<span class="sy0">;;</span>
	<span class="nu0">0</span>?<span class="sy0">*</span> <span class="sy0">|</span> <span class="sy0">*</span><span class="br0">&#91;</span><span class="sy0">!</span><span class="nu0">0</span>-<span class="nu0">9</span><span class="br0">&#93;</span><span class="sy0">*</span><span class="br0">&#41;</span>
		debugf <span class="st_h">'bad print size &quot;%s&quot;\n'</span> <span class="st0">&quot;<span class="es2">$arg</span>&quot;</span>
		<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_CANCEL</span>&quot;</span>
		<span class="sy0">;;</span>
	<span class="sy0">*</span><span class="br0">&#41;</span>
		<span class="re2">arg</span>=$<span class="br0">&#40;</span><span class="br0">&#40;</span>arg<span class="br0">&#41;</span><span class="br0">&#41;</span>
		debugf <span class="st_h">'printing %d bytes\n'</span> <span class="st0">&quot;<span class="es2">$arg</span>&quot;</span>
		<span class="re2">rc</span>=$<span class="br0">&#40;</span><span class="kw2">head</span> <span class="re5">-c</span> <span class="st0">&quot;<span class="es2">$arg</span>&quot;</span> <span class="sy0">|</span> write_exitcode cat_to_printer<span class="br0">&#41;</span>
		<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$rc</span>&quot;</span> <span class="kw1">in</span> <span class="st_h">''</span> <span class="sy0">|</span> <span class="sy0">*</span><span class="br0">&#91;</span><span class="sy0">!</span><span class="nu0">0</span>-<span class="nu0">9</span><span class="br0">&#93;</span><span class="sy0">*</span><span class="br0">&#41;</span>
			<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_FAILED</span>&quot;</span>
		<span class="kw1">esac</span>
		<span class="br0">&#91;</span> <span class="st0">&quot;<span class="es2">$rc</span>&quot;</span> <span class="re5">-eq</span> <span class="nu0">0</span> <span class="br0">&#93;</span> <span class="sy0">||</span> <span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$rc</span>&quot;</span>
		<span class="sy0">;;</span>
	<span class="kw1">esac</span>
	debugf <span class="st_h">'print command completed\n'</span>
<span class="br0">&#125;</span>
&nbsp;
onexit <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	debugf <span class="st_h">'exiting\n'</span>
	close_printer
	unlock_printer
<span class="br0">&#125;</span>
&nbsp;
<span class="kw3">trap</span> onexit <span class="nu0">0</span>
&nbsp;
<span class="re2">IFS</span>=<span class="st_h">''</span>
<span class="kw1">while</span> <span class="kw3">read</span> <span class="re5">-r</span> line
<span class="kw1">do</span>
	<span class="re2">cmd</span>=<span class="co1">${line%% *}</span>
	<span class="re2">arg</span>=<span class="co1">${line#&quot;$cmd&quot;}</span>
	<span class="re2">arg</span>=<span class="co1">${arg# }</span>
	<span class="kw1">case</span> <span class="st0">&quot;<span class="es2">$cmd</span>&quot;</span> <span class="kw1">in</span>
	<span class="kw1">set</span><span class="br0">&#41;</span> handle_set <span class="st0">&quot;<span class="es2">$arg</span>&quot;</span><span class="sy0">;;</span>
	print<span class="br0">&#41;</span> handle_print <span class="st0">&quot;<span class="es2">$arg</span>&quot;</span><span class="sy0">;;</span>
	<span class="sy0">*</span><span class="br0">&#41;</span>
		debugf <span class="st_h">'unknown protocol command &quot;%s&quot;\n'</span> <span class="st0">&quot;<span class="es2">$cmd</span>&quot;</span>
		<span class="kw3">exit</span> <span class="st0">&quot;<span class="es2">$CUPS_BACKEND_CANCEL</span>&quot;</span>
	<span class="kw1">esac</span>
<span class="kw1">done</span></pre>

<p>
Make sure <code>/etc/dropbear/authorized_keys</code> will allow CUPS to connect
(as described in the backend/ssh script); e.g.,
</p>
<pre class="code">command=&quot;./recv-lpjob&quot;,no-pty,no-port-forwarding ssh-rsa AAAAB2...19Q== lp@cups.example.net</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;OpenWrt setup&quot;,&quot;hid&quot;:&quot;openwrt_setup&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:4,&quot;range&quot;:&quot;5655-9336&quot;} -->
<h2 class="sectionedit5" id="non-cups_usage">Non-CUPS usage</h2>
<div class="level2">

<p>
If not using CUPS, the backend can be called manually
from the command line; e.g. (assuming the printer wants PJL):
</p>
<pre class="code bash"><span class="kw3">export</span> <span class="re2">DEVICE_URI</span>=ssh:<span class="sy0">//</span>root<span class="sy0">@</span>openwrt.example.net<span class="sy0">/</span>dev<span class="sy0">/</span>usb<span class="sy0">/</span>lp0
<span class="sy0">/</span>usr<span class="sy0">/</span>lib<span class="sy0">/</span>cups<span class="sy0">/</span>backend<span class="sy0">/</span><span class="kw2">ssh</span> <span class="nu0">0</span> . <span class="st_h">''</span> <span class="nu0">1</span> <span class="st_h">''</span> test.pjl</pre>

<p>
If no filename is given, it will read from stdin.
You can replace <code>/dev/usb/lp0</code> with <code>/dev/null</code> (in the <abbr title="Uniform Resource Identifier">URI</abbr>) for testing.
</p>

<p>
To embed a raw PostScript file in PJL and send it:
</p>
<pre class="code bash"><span class="kw3">export</span> <span class="re2">DEVICE_URI</span>=ssh:<span class="sy0">//</span>root<span class="sy0">@</span>openwrt.example.net<span class="sy0">/</span>dev<span class="sy0">/</span>usb<span class="sy0">/</span>lp0
<span class="br0">&#40;</span>
<span class="kw3">printf</span> <span class="st_h">'\33%%-12345X@PJL\n@PJL ENTER LANGUAGE = POSTSCRIPT\n'</span>
<span class="kw2">cat</span> test.ps
<span class="kw3">printf</span> <span class="st_h">'\33%%-12345X'</span>
<span class="br0">&#41;</span> <span class="sy0">|</span> <span class="sy0">/</span>usr<span class="sy0">/</span>lib<span class="sy0">/</span>cups<span class="sy0">/</span>backend<span class="sy0">/</span><span class="kw2">ssh</span> <span class="nu0">0</span> . <span class="st_h">''</span> <span class="nu0">1</span> <span class="st_h">''</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Non-CUPS usage&quot;,&quot;hid&quot;:&quot;non-cups_usage&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:5,&quot;range&quot;:&quot;9337-&quot;} -->