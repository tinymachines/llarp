
<h1 class="sectionedit1" id="bandwith_monitoring_with_wrtbwmon">Bandwith Monitoring with wrtbwmon</h1>
<div class="level1">

<p>
wrtbwmon is a small and basic shell script designed to run on linux powered routers (OpenWRT, DD-WRT, Tomato, and other routers where shell access is available).
It provides per user bandwidth monitoring capabilities and generates usage reports.
See the screenshot <a href="https://raw.githubusercontent.com/pyrovski/wrtbwmon/master/example.png" class="urlextern" title="https://raw.githubusercontent.com/pyrovski/wrtbwmon/master/example.png" rel="ugc nofollow">here</a>.
</p>

<p>
Original wrtbwmon is hosted on <a href="https://code.google.com/p/wrtbwmon/" class="urlextern" title="https://code.google.com/p/wrtbwmon/" rel="ugc nofollow">code.google</a>, but it has been dead since 2010.
We have a fork for OpenWrt which is hosted on <a href="https://github.com/pyrovski/wrtbwmon" class="urlextern" title="https://github.com/pyrovski/wrtbwmon" rel="ugc nofollow">github</a> by pyrovski.
</p>

<p>
There are many good general descriptions about how to install it:
</p>
<ol>
<li class="level1"><div class="li"> <a href="https://code.google.com/p/wrtbwmon/wiki/Deploying" class="urlextern" title="https://code.google.com/p/wrtbwmon/wiki/Deploying" rel="ugc nofollow">google code</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.kallisti.net.nz/blog/2010/12/per-user-traffic-monitoring-on-openwrt/" class="urlextern" title="http://www.kallisti.net.nz/blog/2010/12/per-user-traffic-monitoring-on-openwrt/" rel="ugc nofollow">kallisti</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/pyrovski/wrtbwmon" class="urlextern" title="https://github.com/pyrovski/wrtbwmon" rel="ugc nofollow">pyrovski</a></div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Bandwith Monitoring with wrtbwmon&quot;,&quot;hid&quot;:&quot;bandwith_monitoring_with_wrtbwmon&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-908&quot;} -->
<h2 class="sectionedit2" id="installation">Installation</h2>
<div class="level2">

<p>
Based on these 3 descriptions I&#039;ve created a step-by-step manual for installing wrtbwmon on OpenWrt:
</p>
<ul>
<li class="level1"><div class="li"> download latest tar.gz from <a href="https://github.com/pyrovski/wrtbwmon/releases" class="urlextern" title="https://github.com/pyrovski/wrtbwmon/releases" rel="ugc nofollow">https://github.com/pyrovski/wrtbwmon/releases</a></div>
</li>
<li class="level1"><div class="li"> tar -zxvf /tmp/wrtbwmon-0.2.tar.gz</div>
</li>
<li class="level1"><div class="li"> copy that 7 files to any folder, eg /opt/wrtbwmon/</div>
</li>
<li class="level1"><div class="li"> edit wrtbwmon.sh to set both baseDir and dataDir to point to directory of readDB.awk and usage.htm* (eg /opt/wrtbwmon/)</div>
</li>
</ul>

<p>
Note: If you&#039;re looking for an install that will collect data for you in a sqlite3 database
</p>
<ul>
<li class="level1"><div class="li"> Download latest tar.gz from <a href="https://github.com/Jcarnage/wrtbwmon.git" class="urlextern" title="https://github.com/Jcarnage/wrtbwmon.git" rel="ugc nofollow">https://github.com/Jcarnage/wrtbwmon.git</a>.</div>
</li>
<li class="level1"><div class="li"> It&#039;s based on the pyrovski base release package but adds a remote scripts for capturing and displaying all the data.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation&quot;,&quot;hid&quot;:&quot;installation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;909-1627&quot;} -->
<h2 class="sectionedit3" id="using_first_time">using first time</h2>
<div class="level2">

<p>
Using wrtbwmon consists of three separated steps: setup, update and publish.
</p>

<p>
Note: The setup below uses pyrovski&#039;s version of wrtbwmon. Other versions may differ.
</p>
<ul>
<li class="level1 node"><div class="li"> ./wrtbwmon setup /tmp/usage.db # this will create iptables chains and rules</div>
<ul>
<li class="level2"><div class="li"> to verify 1st step, run: iptables -t mangle -L | grep -i rrd</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> ./wrtbwmon update /tmp/usage.db # this will copy usage statistics from iptables to usage.db file</div>
<ul>
<li class="level2"><div class="li"> to verify 2nd step, run: cat /tmp/usage.db</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> ./wrtbwmon publish /tmp/usage.db /tmp/usage.htm</div>
</li>
<li class="level1"><div class="li"> ln -s /tmp/usage.htm /www/usage.htm</div>
</li>
<li class="level1"><div class="li"> check result at <a href="http://192.168.1.1/usage.htm" class="urlextern" title="http://192.168.1.1/usage.htm" rel="ugc nofollow">http://192.168.1.1/usage.htm</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;using first time&quot;,&quot;hid&quot;:&quot;using_first_time&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;1628-2264&quot;} -->
<h2 class="sectionedit4" id="schedule_the_whole_process">schedule the whole process</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;schedule the whole process&quot;,&quot;hid&quot;:&quot;schedule_the_whole_process&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;2265-2303&quot;} -->
<h3 class="sectionedit5" id="setup">Setup</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> ./wrtbwmon setup /tmp/usage.db</div>
</li>
<li class="level1"><div class="li"> it must run once after every boot in order to restore required iptables chains and rules</div>
</li>
<li class="level1"><div class="li"> one way to do this is to insert this command into /etc/rc.local</div>
</li>
<li class="level1"><div class="li"> <pre class="code bash"><span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re5">-x</span> <span class="sy0">/</span>opt<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>wrtbwmon <span class="br0">&#93;</span>; <span class="kw1">then</span>
	logger <span class="re5">-t</span> <span class="st_h">'rc.local'</span> <span class="st0">&quot;Starting wrtbwmon setup...&quot;</span>
	<span class="sy0">/</span>opt<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>wrtbwmon setup  <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.db
<span class="kw1">fi</span></pre>
</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Setup&quot;,&quot;hid&quot;:&quot;setup&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;2304-2678&quot;} -->
<h3 class="sectionedit6" id="update">Update</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> ./wrtbwmon update /tmp/usage.db</div>
</li>
<li class="level1"><div class="li"> it must run regularly, eg every 5 minutes</div>
</li>
<li class="level1"><div class="li"> one way to do this is cron</div>
</li>
<li class="level1"><div class="li"> <pre class="code bash"><span class="kw2">cat</span> <span class="sy0">&lt;&lt;</span> <span class="st0">&quot;EOF&quot;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>etc<span class="sy0">/</span>crontabs<span class="sy0">/</span>root
<span class="sy0">*/</span><span class="nu0">5</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">/</span>opt<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>wrtbwmon update <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.db
EOF
service cron restart
logread <span class="re5">-l</span> <span class="nu0">5</span> <span class="re5">-f</span></pre>
</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Update&quot;,&quot;hid&quot;:&quot;update&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:6,&quot;range&quot;:&quot;2679-2965&quot;} -->
<h3 class="sectionedit7" id="publish">Publish</h3>
<div class="level3">
<ul>
<li class="level1 node"><div class="li"> in order to have friendly-names insted of mac-addresses, create a text file</div>
<ul>
<li class="level2"><div class="li"> echo “00:aa:bb:cc:dd:ee,friendlyname1” &gt;  /opt/wrtbwmon/macusers.txt</div>
</li>
<li class="level2"><div class="li"> echo “11:22:33:44:55:66,friendlyname1” &gt;&gt; /opt/wrtbwmon/macusers.txt</div>
</li>
<li class="level2"><div class="li"> letters in mac address must be lowercase!</div>
</li>
<li class="level2"><div class="li"> unnecessary to insert devices using static-leases or in /etc/hosts file</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> publishing /tmp/usage.htm file can be accomplished by two different ways:</div>
<ul>
<li class="level2"><div class="li"> we can publish it regularly via cron, but this is not necessary</div>
</li>
<li class="level2"><div class="li"> or</div>
</li>
<li class="level2"><div class="li"> we can publish it on demand via cgi-bin: create a file to /www/cgi-bin/usage</div>
</li>
<li class="level2"><div class="li"> <pre class="code bash"><span class="co0">#!/bin/sh</span>
<span class="kw3">echo</span> <span class="st_h">'Content-Type: text/html'</span>
<span class="kw3">echo</span> <span class="st_h">'X-Dummy: dummy'</span>
<span class="kw3">echo</span>
<span class="sy0">/</span>opt<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>wrtbwmon update  <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.db
<span class="sy0">/</span>opt<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>wrtbwmon publish <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.db <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.htm <span class="sy0">/</span>opt<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>macusers.txt
<span class="kw2">cat</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.htm</pre>
</div>
</li>
<li class="level2"><div class="li"> chmod +x /www/cgi-bin/usage</div>
</li>
<li class="level2"><div class="li"> check result at <a href="http://192.168.1.1/cgi-bin/usage" class="urlextern" title="http://192.168.1.1/cgi-bin/usage" rel="ugc nofollow">http://192.168.1.1/cgi-bin/usage</a></div>
</li>
</ul>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Publish&quot;,&quot;hid&quot;:&quot;publish&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:7,&quot;range&quot;:&quot;2966-3918&quot;} -->
<h2 class="sectionedit8" id="extras">Extras</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Extras&quot;,&quot;hid&quot;:&quot;extras&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:8,&quot;range&quot;:&quot;3919-3937&quot;} -->
<h3 class="sectionedit9" id="log_level">Log level</h3>
<div class="level3">

<p>
You can change loglevel of cron in order to write only error messages into syslog by:
</p>
<pre class="code bash">uci <span class="kw1">set</span> system.<span class="sy0">@</span>system<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.cronloglevel=<span class="st0">&quot;9&quot;</span>
uci commit system
service cron restart
logread <span class="re5">-l</span> <span class="nu0">5</span> <span class="re5">-f</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Log level&quot;,&quot;hid&quot;:&quot;log_level&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:9,&quot;range&quot;:&quot;3938-4163&quot;} -->
<h3 class="sectionedit10" id="log_rotation">Log rotation</h3>
<div class="level3">

<p>
If you are interested in the traffic of the current day, then usage.db file has to be deleted every day at midnight.
If we move usage.db file instead of deleting, then it can be used later for publishing via cgi-bin.
</p>
<pre class="code bash"> <span class="nu0">0</span> <span class="nu0">0</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="kw2">mv</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.db <span class="sy0">/</span>mnt<span class="sy0">/</span>usbdrive<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>usage-$<span class="br0">&#40;</span><span class="kw2">date</span> <span class="st_h">'+%Y.%m.%d'</span><span class="br0">&#41;</span>.db</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Log rotation&quot;,&quot;hid&quot;:&quot;log_rotation&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:10,&quot;range&quot;:&quot;4164-4505&quot;} -->
<h3 class="sectionedit11" id="peak_and_offpeak_times">Peak and offpeak times</h3>
<div class="level3">

<p>
Note: this only works with kallisti&#039;s version.
Bandwidth usage can be separated to peak and offpeak times.
</p>

<p>
In this example the off-peak counters get updated from 4:00 to 8:59, the peak counters the rest of the day.
</p>
<pre class="code bash"><span class="sy0">*/</span><span class="nu0">30</span> <span class="nu0">0</span>-<span class="nu0">3</span>    <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">/</span>opt<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>wrtbwmon update  <span class="sy0">/</span>tmp<span class="sy0">/</span>wrtbwmon.db peak
<span class="sy0">*/</span><span class="nu0">30</span>,<span class="nu0">59</span> <span class="nu0">4</span>-<span class="nu0">8</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">/</span>opt<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>wrtbwmon update  <span class="sy0">/</span>tmp<span class="sy0">/</span>wrtbwmon.db offpeak
<span class="sy0">*/</span><span class="nu0">30</span> <span class="nu0">9</span>-<span class="nu0">23</span>   <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">/</span>opt<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>wrtbwmon update  <span class="sy0">/</span>tmp<span class="sy0">/</span>wrtbwmon.db peak</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Peak and offpeak times&quot;,&quot;hid&quot;:&quot;peak_and_offpeak_times&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:11,&quot;range&quot;:&quot;4506-4992&quot;} -->
<h3 class="sectionedit12" id="backup">Backup</h3>
<div class="level3">

<p>
The /tmp/usage.db file is a database file that contains the accounting records.
It will be written to very often, so it is not recommended to put it on flash memory, but should be put in RAM (like in /tmp/ directory).
If you put it in RAM, schedule a periodic backup task and restore it if missing, for example:
</p>
<pre class="code bash"><span class="co0"># local backup storage</span>
<span class="nu0">15</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="kw2">cp</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.db <span class="sy0">/</span>mnt<span class="sy0">/</span>usbdrive<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>
 <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="br0">&#91;</span> <span class="sy0">!</span> <span class="re5">-f</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.db <span class="br0">&#93;</span> <span class="sy0">&amp;&amp;</span> <span class="kw2">cp</span> <span class="sy0">/</span>mnt<span class="sy0">/</span>usbdrive<span class="sy0">/</span>wrtbwmon<span class="sy0">/</span>usage.db <span class="sy0">/</span>tmp<span class="sy0">/</span>
<span class="co0"># online backup storage</span>
<span class="nu0">15</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="kw3">cd</span> <span class="sy0">/</span>tmp <span class="sy0">&amp;&amp;</span> ftpput <span class="re5">-u</span> username <span class="re5">-p</span> password usage.db . some_ftp_server_url
 <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="sy0">*</span> <span class="br0">&#91;</span> <span class="sy0">!</span> <span class="re5">-f</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.db <span class="br0">&#93;</span> <span class="sy0">&amp;&amp;</span> <span class="kw2">wget</span> some_url<span class="sy0">/</span>usage.db <span class="re5">-O</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>usage.db</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Backup&quot;,&quot;hid&quot;:&quot;backup&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:12,&quot;range&quot;:&quot;4993-5681&quot;} -->
<h2 class="sectionedit13" id="enhanced_version">Enhanced version</h2>
<div class="level2">

<p>
You may use a forked version and is luci companion.
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://github.com/brvphoenix/wrtbwmon" class="urlextern" title="https://github.com/brvphoenix/wrtbwmon" rel="ugc nofollow">wrtbwmon</a> - pyrovski&#039;s forked enhanced version</div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/brvphoenix/luci-app-wrtbwmon" class="urlextern" title="https://github.com/brvphoenix/luci-app-wrtbwmon" rel="ugc nofollow">luci-app-wrtbwmon</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Enhanced version&quot;,&quot;hid&quot;:&quot;enhanced_version&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:13,&quot;range&quot;:&quot;5682-&quot;} -->