
<p>
The word NetBoot can be applied to multiple concepts, see <a href="/inbox/howto/netboot_pointers" class="wikilink1" title="inbox:howto:netboot_pointers" data-wiki-id="inbox:howto:netboot_pointers">netboot_pointers</a>.  This manual outlines how to use an external USB storage media on the OpenWRT router to serve boot images and a NFS root partition for a (presumably) diskless client.  There is a simplified instruction on how to fix the OpenWRT router to serve a boot image on <a href="/inbox/howto/setting_up_openwrt_to_serve_archlinux_netboot" class="wikilink1" title="inbox:howto:setting_up_openwrt_to_serve_archlinux_netboot" data-wiki-id="inbox:howto:setting_up_openwrt_to_serve_archlinux_netboot">Setting up OpenWRT to serve Archlinux NetBoot</a>
</p>

<h1 class="sectionedit1" id="pxe-boot_network_boot_server">PXE-Boot network boot server</h1>
<div class="level1">

<p>
You can use your OpenWrt device as a PXE-Server to store network boot images for booting other devices over the network. 
Possibilities:
</p>
<ul>
<li class="level1"><div class="li"> Boot Ubuntu / Debian / CentOS Live Systems</div>
</li>
<li class="level1"><div class="li"> Install any Linux Distrib. or Windows (via winpe) over network</div>
</li>
<li class="level1"><div class="li"> Boot debugging tools like knoppix / gparted / clonezilla / backtrack</div>
</li>
<li class="level1"><div class="li"> boot a Windows image prepared for network boot (not described in this tutorial)</div>
</li>
</ul>

<p>
The following example shows how to provide PXE-Booting for Ubuntu Live System on an OpenWrt Router.
</p>

<p>
Basic idea:
</p>
<ul>
<li class="level1"><div class="li"> Connect USB Mass Storage to router to store PXE-Boot files and Live Images</div>
</li>
<li class="level1"><div class="li"> use dnsmasq service for dhcp &amp; tftp readonly booting</div>
</li>
<li class="level1"><div class="li"> use nfs for further service booting (required by e.g. ubuntu)</div>
</li>
</ul>

<p>
Booting other Linux based distributions is not very different, only the boot parameters differ and can be found everywhere on the internet.
</p>

<p>
The following instructions have been done step-by-step on an OpenWrt Attitude Adjustment 12.09 on a <a href="/toh/tp-link/tl-wdr3600_v1" class="wikilink1" title="toh:tp-link:tl-wdr3600_v1" data-wiki-id="toh:tp-link:tl-wdr3600_v1">tl-wdr3600_v1</a>on 6th of December 2013
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;PXE-Boot network boot server&quot;,&quot;hid&quot;:&quot;pxe-boot_network_boot_server&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;416-1478&quot;} -->
<h2 class="sectionedit2" id="install_mass_storage">1. Install Mass Storage</h2>
<div class="level2">

<p>
Note: you can also check <a href="/docs/guide-user/storage/usb-drives-quickstart" class="wikilink1" title="docs:guide-user:storage:usb-drives-quickstart" data-wiki-id="docs:guide-user:storage:usb-drives-quickstart">usb-drives-quickstart</a>
</p>

<p>
Install USB-Support (you may also need to install a filesystem module like `kmod-fs-vfat`)
</p>
<pre class="code">root@OpenWrt:~# opkg install usbutils kmod-usb-storage  block-mount</pre>

<p>
Show connected USB-Devices
</p>
<pre class="code">root@OpenWrt:~# lsusb
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 001 Device 002: ID 05e3:0608 Genesys Logic, Inc. USB-2.0 4-Port HUB
Bus 001 Device 003: ID 0951:1600 Kingston Technology DataTraveler G3 4GB</pre>

<p>
Verify the USB-device in /dev
</p>

<p>
We assume that the USB-device is plugged in and has been formatted to FAT32 or EXT2,3
</p>

<p>
If you have a NTFS filesystem please install NTFS support: opkg install ntfs-3g
For more information on NTFS see <a href="/docs/guide-user/storage/writable_ntfs" class="wikilink1" title="docs:guide-user:storage:writable_ntfs" data-wiki-id="docs:guide-user:storage:writable_ntfs">writable_ntfs</a>
</p>
<pre class="code">root@OpenWrt:~# ls -l /dev/sd*
brw-r--r--    1 root    root        8,   0 Jan  1  1970 /dev/sda
brw-r--r--    1 root    root        8,   1 Dec  6 17:52 /dev/sda1</pre>

<p>
Create mountpoint for usbdevice
</p>
<pre class="code">root@OpenWrt:~# mkdir /mnt/extstorage</pre>

<p>
Enable automatic mounting of external USB Storage. For additional Information see <a href="/docs/guide-user/storage/fstab" class="wikilink1" title="docs:guide-user:storage:fstab" data-wiki-id="docs:guide-user:storage:fstab">fstab</a>
</p>
<pre class="code">root@OpenWrt:~# vim /etc/config/fstab
config global automount
        option from_fstab 1
        option anon_mount 1

config global autoswap
        option from_fstab 1
        option anon_swap 0

config mount
        option target   /mnt/extstorage
        option device   /dev/sda1
        option enabled  1
        option enabled_fsck 0</pre>

<p>
Now enable start of fstab-service on boot of OpenWrt
</p>
<pre class="code">root@OpenWrt:~# /etc/init.d/fstab enable</pre>

<p>
Start fstab this time manually
</p>
<pre class="code">root@OpenWrt:~# /etc/init.d/fstab start</pre>

<p>
Verify that the USB Mass Storage /dev/sda1 is mounted to /mnt/extstorage
</p>
<pre class="code">root@OpenWrt:~# mount | grep extstorage
/dev/sda1 on /mnt/extstorage type fuseblk (rw,relatime,user_id=0,group_id=0,allow_other,blksize=4096)</pre>

<p>
For testing purposes, touch a file on the usb-stick and reboot OpenWrt router:
</p>
<pre class="code">root@OpenWrt:~# touch /mnt/extstorage/test.txt
root@OpenWrt:~# reboot</pre>

<p>
After the reboot you should be able to verify again that the USB Mass Storage is mounted to /mnt/extstorage and that the test.txt exists.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;1. Install Mass Storage&quot;,&quot;hid&quot;:&quot;install_mass_storage&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;1479-3771&quot;} -->
<h2 class="sectionedit3" id="prepare_files_for_pxe-booting">2. Prepare files for PXE-Booting</h2>
<div class="level2">

<p>
Generate <abbr title="Trivial File Transfer Protocol">TFTP</abbr>-Boot folder structure and files:
</p>
<pre class="code">root@OpenWrt:~# cd /mnt/extstorage
root@OpenWrt:~# mkdir tftp tftp/pxelinux.cfg tftp/disks tftp/disks/ubuntu1604-64</pre>

<p>
Now you have to download syslinux.
Download <a href="https://www.kernel.org/pub/linux/utils/boot/syslinux/" class="urlextern" title="https://www.kernel.org/pub/linux/utils/boot/syslinux/" rel="ugc nofollow">Syslinux</a>
Direct-Link to 13-Oct-2013 <a href="https://www.kernel.org/pub/linux/utils/boot/syslinux/syslinux-6.03.tar.gz" class="urlextern" title="https://www.kernel.org/pub/linux/utils/boot/syslinux/syslinux-6.03.tar.gz" rel="ugc nofollow">Syslinux v6.03</a>
</p>

<p>
The basic wget from OpenWrt does NOT support wget from <a href="https://." class="urlextern" title="https://." rel="ugc nofollow">https://.</a> The following steps could be done by downloading the syslinux to your pc and transfer the required files manually to your usb-stick. 
</p>

<p>
Because the basic OpenWrt wget does not support https, we have to install the package wget (thanks to theoradicus for giving this important hint) and the extended tar command to extract the compressed archive afterwards:
</p>
<pre class="code">root@OpenWrt:~# opkg update
root@OpenWrt:~# opkg install wget tar</pre>

<p>
Now we can download the syslinux archive and extract it. We do not have the public <abbr title="Secure Socket Layer">SSL</abbr>-CAs on our OpenWrt so we have to NOT check the server-certificate:
</p>
<pre class="code">root@OpenWrt:~# mkdir /mnt/extstorage/syslinux-download
root@OpenWrt:~# cd /mnt/extstorage/syslinux-download
root@OpenWrt:/mnt/extstorage/syslinux-download# wget --no-check-certificate https://www.kernel.org/pub/linux/utils/boot/syslinux/syslinux-6.03.tar.gz
root@OpenWrt:/mnt/extstorage/syslinux-download# tar -xzf syslinux-6.03.tar.gz</pre>

<p>
You have to copy the following files from the syslinux to your tftp-folder:
</p>
<ul>
<li class="level1"><div class="li"> ./bios/core/pxelinux.0</div>
</li>
<li class="level1"><div class="li"> ./bios/com32/elflink/ldlinux/ldlinux.c32</div>
</li>
<li class="level1"><div class="li"> ./bios/com32/menu/vesamenu.c32</div>
</li>
<li class="level1"><div class="li"> ./bios/com32/lib/libcom32.c32</div>
</li>
<li class="level1"><div class="li"> ./bios/com32/libutil/libutil.c32</div>
</li>
</ul>

<p>
As one single long copy-command:
</p>
<pre class="code">root@OpenWrt:~# cd /mnt/extstorage/syslinux-download/syslinux-6.03/bios
root@OpenWrt:/mnt/extstorage/syslinux-download/syslinux-6.03/bios# cp core/pxelinux.0 com32/elflink/ldlinux/ldlinux.c32 com32/menu/vesamenu.c32 com32/lib/libcom32.c32 com32/libutil/libutil.c32 /mnt/extstorage/tftp</pre>

<p>
<strong>Hint</strong>: We do a BIOS / Legacy PXE Boot - NOT an UEFI boot, this is something completely different!
</p>

<p>
Now we create our default menu-file:
</p>
<pre class="code">root@OpenWrt:~# vim /mnt/extstorage/tftp/pxelinux.cfg/default
DEFAULT vesamenu.c32
PROMPT 0
MENU TITLE OpenWrt PXE-Boot Menu

label Ubuntu
        MENU LABEL Ubuntu Live 16.04 64-Bit
        KERNEL disks/ubuntu1604-64/casper/vmlinuz.efi
        APPEND boot=casper ide=nodma netboot=nfs nfsroot=192.168.1.1:/mnt/extstorage/tftp/disks/ubuntu1604-64/ initrd=disks/ubuntu1604-64/casper/initrd.lz
        TEXT HELP
                Starts the Ubuntu Live-CD - Version 16.04 64-Bit
        ENDTEXT</pre>

<p>
As you can see we need nfs for this operating system. Other operating systems like clonezilla can be fully booted via <abbr title="Trivial File Transfer Protocol">TFTP</abbr> an do not need an additional nfs service.
</p>

<p>
We now have to download and extract the Ubuntu 16.04 to the USB-Drive. 
</p>

<p>
One Option is to do this directly on the OpenWrt itself, but I downloaded the Ubuntu ISO on my computer and plugged in the USB-Drive from OpenWrt and put only the extracted files onto the USB-Drive
</p>

<p>
Finally, you should have something like the following folder structure:
</p>
<pre class="code">root@OpenWrt:~#  cd ..
root@OpenWrt:~# # find /mnt/extstorage/tftp/
/mnt/extstorage/tftp/
/mnt/extstorage/tftp/disks
/mnt/extstorage/tftp/disks/ubuntu1604-64
/mnt/extstorage/tftp/disks/ubuntu1604-64/pics
...
/mnt/extstorage/tftp/disks/ubuntu1604-64/EFI
...
/mnt/extstorage/tftp/disks/ubuntu1604-64/README.diskdefines
/mnt/extstorage/tftp/disks/ubuntu1604-64/casper
/mnt/extstorage/tftp/disks/ubuntu1604-64/casper/filesystem.size
/mnt/extstorage/tftp/disks/ubuntu1604-64/casper/initrd.lz
/mnt/extstorage/tftp/disks/ubuntu1604-64/casper/vmlinuz.efi
/mnt/extstorage/tftp/disks/ubuntu1604-64/casper/filesystem.manifest
/mnt/extstorage/tftp/disks/ubuntu1604-64/casper/filesystem.manifest-remove
/mnt/extstorage/tftp/disks/ubuntu1604-64/casper/filesystem.squashfs
/mnt/extstorage/tftp/disks/ubuntu1604-64/isolinux
...
/mnt/extstorage/tftp/disks/ubuntu1604-64/pool
...
/mnt/extstorage/tftp/disks/ubuntu1604-64/preseed
...
/mnt/extstorage/tftp/disks/ubuntu1604-64/md5sum.txt
/mnt/extstorage/tftp/disks/ubuntu1604-64/install
/mnt/extstorage/tftp/disks/ubuntu1604-64/install/mt86plus
/mnt/extstorage/tftp/disks/ubuntu1604-64/dists
...
/mnt/extstorage/tftp/disks/ubuntu1604-64/ubuntu
/mnt/extstorage/tftp/disks/ubuntu1604-64/boot
...
/mnt/extstorage/tftp/ldlinux.c32
/mnt/extstorage/tftp/libcom32.c32
/mnt/extstorage/tftp/libutil.c32
/mnt/extstorage/tftp/pxelinux.0
/mnt/extstorage/tftp/pxelinux.cfg
/mnt/extstorage/tftp/pxelinux.cfg/default
/mnt/extstorage/tftp/vesamenu.c32</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;2. Prepare files for PXE-Booting&quot;,&quot;hid&quot;:&quot;prepare_files_for_pxe-booting&quot;,&quot;codeblockOffset&quot;:9,&quot;secid&quot;:3,&quot;range&quot;:&quot;3772-8470&quot;} -->
<h2 class="sectionedit4" id="enable_tftp_and_nfs_service">3. Enable TFTP and NFS Service</h2>
<div class="level2">

<p>
Configure dnsmasq service to enable read-only tftp-service
</p>
<pre class="code">root@OpenWrt:~# vim /etc/config/dhcp
config dnsmasq
         ... a lot of config done before...
        option enable_tftp &#039;1&#039;
        option tftp_root &#039;/mnt/extstorage/tftp&#039;
        ... a lot more config

config boot linux
        option filename &#039;pxelinux.0&#039;
        option serveraddress &#039;192.168.1.1&#039;
        option servername &#039;OpenWrt&#039;

root@OpenWrt:~# /etc/init.d/dnsmasq restart</pre>

<p>
Some devices requires two additional lines in section <em>config boot linux</em>:
</p>
<pre class="code">        list dhcp_option &#039;209,pxelinux.cfg/default&#039;
        option force &#039;1&#039;</pre>

<p>
Without this parameters some PXE devices won&#039;t boot to default menu. 
</p>

<p>
Now we have to install and configure the NFS-Service:
</p>
<pre class="code">root@OpenWrt:~# opkg install nfs-kernel-server</pre>

<p>
Configure NFS-Share now
</p>
<pre class="code">root@OpenWrt:~# vim /etc/exports
/mnt/extstorage/tftp/disks  *(ro,async,no_subtree_check)</pre>

<p>
Now enable portmap and nfsd and (re)start them
</p>
<pre class="code">root@OpenWrt:~# /etc/init.d/portmap enable
root@OpenWrt:~# /etc/init.d/portmap restart
root@OpenWrt:~# /etc/init.d/nfsd enable
root@OpenWrt:~# /etc/init.d/nfsd restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;3. Enable TFTP and NFS Service&quot;,&quot;hid&quot;:&quot;enable_tftp_and_nfs_service&quot;,&quot;codeblockOffset&quot;:15,&quot;secid&quot;:4,&quot;range&quot;:&quot;8471-9693&quot;} -->
<h2 class="sectionedit5" id="testing_it_out">4. Testing it out</h2>
<div class="level2">

<p>
And now we are ready to go! Just grab a computer (or Virtual Machine) and PXE Boot - you should be able to fully boot into Ubuntu 16.04 via your OpenWrt Router <img src="/lib/images/smileys/biggrin.svg" class="icon smiley" alt=":-D" />
Hint: you often have to enable PXE-Booting in BIOS and press e.g. F12 to get into the Boot-Menu.
</p>

<p>
Note: It will help immensely to check your sys.log to see what path is actually being used to pull the pxelinux.0, vmlinuz.efi (kernel file), initrd.lz (which are transferred via tftp), etc...but of course you have to set that up on the router as well.
</p>

<p>
For instance in sys.log I received the following messages when I got mine working:
</p>
<pre class="code">Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: error 0 TFTP Aborted received from 192.168.1.235
Tue Nov  7 19:28:20 2017 daemon.info dnsmasq-tftp[16313]: failed sending /mnt/extstorage/tftp/pxelinux.0 to 192.168.1.235
Tue Nov  7 19:28:20 2017 daemon.info dnsmasq-tftp[16313]: sent /mnt/extstorage/tftp/pxelinux.0 to 192.168.1.235
Tue Nov  7 19:28:20 2017 daemon.info dnsmasq-tftp[16313]: sent /mnt/extstorage/tftp/ldlinux.c32 to 192.168.1.235
Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: file /mnt/extstorage/tftp/pxelinux.cfg/44454c4c-4e00-104e-8038-b6c04f4a4431 not found
Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: file /mnt/extstorage/tftp/pxelinux.cfg/01-00-1c-23-86-01-07 not found
Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: file /mnt/extstorage/tftp/pxelinux.cfg/C0A801EB not found
Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: file /mnt/extstorage/tftp/pxelinux.cfg/C0A801E not found
Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: file /mnt/extstorage/tftp/pxelinux.cfg/C0A801 not found
Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: file /mnt/extstorage/tftp/pxelinux.cfg/C0A80 not found
Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: file /mnt/extstorage/tftp/pxelinux.cfg/C0A8 not found
Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: file /mnt/extstorage/tftp/pxelinux.cfg/C0A not found
Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: file /mnt/extstorage/tftp/pxelinux.cfg/C0 not found
Tue Nov  7 19:28:20 2017 daemon.err dnsmasq-tftp[16313]: file /mnt/extstorage/tftp/pxelinux.cfg/C not found
Tue Nov  7 19:28:20 2017 daemon.info dnsmasq-tftp[16313]: sent /mnt/extstorage/tftp/pxelinux.cfg/default to 192.168.1.235
Tue Nov  7 19:28:20 2017 daemon.info dnsmasq-tftp[16313]: sent /mnt/extstorage/tftp/vesamenu.c32 to 192.168.1.235
Tue Nov  7 19:28:20 2017 daemon.info dnsmasq-tftp[16313]: sent /mnt/extstorage/tftp/libcom32.c32 to 192.168.1.235
Tue Nov  7 19:28:20 2017 daemon.info dnsmasq-tftp[16313]: sent /mnt/extstorage/tftp/libutil.c32 to 192.168.1.235
Tue Nov  7 19:28:20 2017 daemon.info dnsmasq-tftp[16313]: sent /mnt/extstorage/tftp/pxelinux.cfg/default to 192.168.1.235
Tue Nov  7 19:28:34 2017 daemon.info dnsmasq-tftp[16313]: sent /mnt/extstorage/tftp/disks/ubuntu1604-64/casper/vmlinuz.efi to 192.168.1.235
Tue Nov  7 19:28:42 2017 daemon.info dnsmasq-tftp[16313]: sent /mnt/extstorage/tftp/disks/ubuntu1604-64/casper/initrd.lz to 192.168.1.235
Tue Nov  7 19:29:24 2017 daemon.info dnsmasq-dhcp[16313]: DHCPDISCOVER(br-lan) 00:1c:23:86:01:07 
Tue Nov  7 19:29:24 2017 daemon.info dnsmasq-dhcp[16313]: DHCPOFFER(br-lan) 192.168.1.235 00:1c:23:86:01:07 
Tue Nov  7 19:29:24 2017 daemon.info dnsmasq-dhcp[16313]: DHCPREQUEST(br-lan) 192.168.1.235 00:1c:23:86:01:07 
Tue Nov  7 19:29:24 2017 daemon.info dnsmasq-dhcp[16313]: DHCPACK(br-lan) 192.168.1.235 00:1c:23:86:01:07 
Tue Nov  7 19:29:24 2017 daemon.notice rpc.mountd[16219]: authenticated mount request from 192.168.1.235:777 for /mnt/extstorage/tftp/disks/ubuntu1604-64 (/mnt/extstorage/tftp/disks)</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;4. Testing it out&quot;,&quot;hid&quot;:&quot;testing_it_out&quot;,&quot;codeblockOffset&quot;:20,&quot;secid&quot;:5,&quot;range&quot;:&quot;9694-13428&quot;} -->
<h2 class="sectionedit6" id="trouble_shooting">5. Trouble shooting</h2>
<div class="level2">
<pre class="code">&gt;&gt;Checking Media Presence......
&gt;&gt;Media Present......
&gt;&gt;Start PXE over IPv4.
  Station IP address is 192.168.1.239
  
  Server IP address is 192.168.1.1
  NBP filename is pxelinux.0
  NBP filesize is 0 Bytes
  PXE-E23: Client received TFTP error from...</pre>

<p>
Check that your tftp-server is up and running and serves the file &#039;pxelinux.0&#039;:
</p>
<pre class="code">user@server:~# opkg update
user@server:~# opkg install atftp
user@server:~# atftp 192.168.1.1
tftp&gt; get pxelinux.0
tftp&gt; error received from server &lt;file /mnt/extstorage/tftp/pxelinux.0&gt; not found
tftp&gt; aborting
tftp&gt;</pre>

<p>
If the file pxelinux.0 is at the expected location, try restarting the tftp server:
</p>
<pre class="code">user@server:~# /etc/init.d/dnsmasq restart
udhcpc: started, v1.35.0
udhcpc: broadcasting discover
udhcpc: no lease, failing
user@server:~#</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;5. Trouble shooting&quot;,&quot;hid&quot;:&quot;trouble_shooting&quot;,&quot;codeblockOffset&quot;:21,&quot;secid&quot;:6,&quot;range&quot;:&quot;13429-&quot;} -->