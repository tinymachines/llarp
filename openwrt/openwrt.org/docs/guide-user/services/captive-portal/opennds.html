
<h1 class="sectionedit1" id="opennds_captive_portal">OpenNDS Captive Portal</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;OpenNDS Captive Portal&quot;,&quot;hid&quot;:&quot;opennds_captive_portal&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-38&quot;} -->
<h2 class="sectionedit2" id="overview">Overview</h2>
<div class="level2">

<p>
openNDS (open Network Demarcation Service) is a high performance, small footprint, Captive Portal.
</p>

<p>
It provides a border control gateway between a public local area network and the Internet.
</p>

<p>
It supports all ranges between small stand alone venues through to large mesh networks with multiple portal entry points.
</p>

<p>
Both the client driven Captive Portal Detection (CPD) method and gateway driven Captive Portal Identification method (CPI - <abbr title="Request for Comments">RFC</abbr> 8910 and <abbr title="Request for Comments">RFC</abbr> 8908) are supported.
</p>

<p>
In its default configuration, openNDS offers a dynamically generated and adaptive splash page sequence. Internet access is granted by a click to continue button, accepting Terms of Service. A simple option enables input forms for user login.
</p>

<p>
The package incorporates the FAS <abbr title="Application Programming Interface">API</abbr> allowing many flexible customisation options.
</p>

<p>
The creation of sophisticated third party authentication applications is fully supported.
</p>

<p>
Internet hosted https portals can be implemented with no security errors, to inspire maximum user confidence.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Overview&quot;,&quot;hid&quot;:&quot;overview&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;39-1067&quot;} -->
<h2 class="sectionedit3" id="documentation">Documentation</h2>
<div class="level2">

<p>
Full documentation can be found at:
</p>

<p>
<a href="https://opennds.readthedocs.io" class="urlextern" title="https://opennds.readthedocs.io" rel="ugc nofollow">https://opennds.readthedocs.io</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Documentation&quot;,&quot;hid&quot;:&quot;documentation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;1068-1162&quot;} -->
<h2 class="sectionedit4" id="official_repository">Official Repository</h2>
<div class="level2">

<p>
The official repository can be found here:
</p>

<p>
<a href="https://github.com/openNDS/openNDS" class="urlextern" title="https://github.com/openNDS/openNDS" rel="ugc nofollow">https://github.com/openNDS/openNDS</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Official Repository&quot;,&quot;hid&quot;:&quot;official_repository&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;1163-1274&quot;} -->
<h2 class="sectionedit5" id="how_opennds_nds_works">How OpenNDS (NDS) works</h2>
<div class="level2">

<p>
OpenNDS is a Captive Portal Engine. Any Captive Portal, including NDS, will have two main components:
</p>
<ul>
<li class="level1"><div class="li"> Something that does the capturing, and</div>
</li>
<li class="level1"><div class="li"> Something to provide a Portal for client users to log in. </div>
</li>
</ul>

<p>
A wireless router will typically be running OpenWrt or some other Linux distribution.
</p>

<p>
A router, by definition, will have two or more interfaces, at least one to connect to the wide area network (<abbr title="Wide Area Network">WAN</abbr>) or Internet feed, and at least one connecting to the local area network (<abbr title="Local Area Network">LAN</abbr>).
</p>

<p>
Each <abbr title="Local Area Network">LAN</abbr> interface must also act as the Default <abbr title="Internet Protocol">IP</abbr> Gateway for its <abbr title="Local Area Network">LAN</abbr>, ideally with the interface serving <abbr title="Internet Protocol">IP</abbr> addresses to client devices using <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>.
</p>

<p>
Multiple <abbr title="Local Area Network">LAN</abbr> interfaces can be combined into a single bridge interface. For example, ethernet, 2.4Ghz and 5Ghz networks are typically combined into a single bridge interface. Logical interface names will be assigned such as eth0, wlan0, wlan1 etc. with the combined bridge interface named as br-lan.
</p>

<p>
NDS will manage one or more of them of them. This will typically be br-lan, the bridge to both the wireless and wired <abbr title="Local Area Network">LAN</abbr>, but could be, for example, wlan0 if you wanted NDS to work just on the wireless interface.
</p>

</div>

<h4 id="summary_of_operation">Summary of Operation</h4>
<div class="level4">

<p>
By default, NDS blocks everything.
</p>

<p>
A client will find out it is in a captured state by one of two basic methods:
</p>

</div>

<h5 id="captive_portal_detection_cpd">1. Captive Portal Detection (CPD)</h5>
<div class="level5">

<p>
CPD is a client driven process available on all modern mobile devices, most desktop operating systems and most browsers. The CPD process automatically issues a port 80 request on connection to a network as a means of probing for a captive state.
</p>

<p>
Sometimes known as a “canary test”, this process, driven by the client, has evolved over a number of years to be a reliable de-facto standard. openNDS detects this probing and serves a special “splash” web page sequence to the connecting client device.
</p>

</div>

<h5 id="captive_portal_identification_cpi">2. Captive Portal Identification (CPI)</h5>
<div class="level5">

<p>
CPI is a Gateway driven process as defined in standards RFC8910 (Captive-Portal Identification in <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> and Router Advertisements) and RFC8908 (Captive Portal <abbr title="Application Programming Interface">API</abbr>).
A gateway router informs a connecting client that it is in a captive state by providing a url at which a client can access for authentication.
A client may access this url to be served the same portal “splash” page sequence as it would have in the traditional CPD method.
</p>

<p>
Alternatively, a client may use this url to access the RFC8908 Captive Portal <abbr title="Application Programming Interface">API</abbr>, ultimately being served a splash page sequence for authentication.
</p>

<p>
From openNDS v9.5.0, The CPI method is supported in both forms and enabled by default. It can be disabled in a config option.
</p>

<p>
Note: Very few client devices support CPI at the time of writing (November 2021)
</p>

<p>
Update: Most new devices now support CPI at least to some degree, indicating a probable “S” curve adoption. (January 2023)
</p>

</div>

<h4 id="the_portal">The Portal</h4>
<div class="level4">

<p>
 The client browser is redirected to the Portal component. This is a web service that is configured to know how to communicate with the core engine of NDS.
 This is commonly known as the “Splash Page”.
</p>

<p>
 NDS has its own web server built in and is used in the basic modes of operation to serve the Portal “Splash” pages to the client browser. Alternatively, a separate web server can be used.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;How OpenNDS (NDS) works&quot;,&quot;hid&quot;:&quot;how_opennds_nds_works&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;1275-4531&quot;} -->
<h3 class="sectionedit6" id="nds_comes_with_multiple_default_splash_page_options">NDS comes with multiple default Splash Page options</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> A trivial Click to Continue splash page sequence (default configuration)</div>
</li>
<li class="level1"><div class="li"> A Client User form requiring Name and Email address to be entered.</div>
</li>
<li class="level1"><div class="li"> Admin definable themed page sequences, supporting optional remote content</div>
</li>
</ul>

<p>
 A single uci config option is used to choose the default splash page sequence for client login.
</p>

<p>
For the simple “Click to Continue” pages:
</p>
<pre class="code"> option login_option_enabled &#039;1&#039;
 </pre>

<p>
For the “username/email” pages:
</p>
<pre class="code"> option login_option_enabled &#039;2&#039;</pre>

<p>
For admin defined Themespec pages:
</p>
<pre class="code"> option login_option_enabled &#039;3&#039;
 </pre>

<p>
 The default splash page options can be customised or a complete specialised Portal can be written by the installer (See ThemeSpec, FAS, PreAuth in the documentation).
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;NDS comes with multiple default Splash Page options&quot;,&quot;hid&quot;:&quot;nds_comes_with_multiple_default_splash_page_options&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;4532-5312&quot;} -->
<h3 class="sectionedit7" id="fas_or_forward_authentication_service">FAS, or Forward Authentication Service</h3>
<div class="level3">

<p>
 FAS, or Forward Authentication Service may use the web server embedded in NDS, a separate web server installed on the NDS router, a web server residing on the local network or an Internet hosted web server.
</p>

<p>
 The user of the client device will always be expected to complete some actions on the splash or captive portal page.
 Once the user on the client device has successfully completed the splash page actions, that page then links directly back to NDS.
</p>

<p>
 For security, NDS expects to receive a token, hashed using a pre-shared key.
</p>

<p>
 If this hashed token is valid, NDS then “authenticates” the client device, allowing access to the Internet.
</p>

<p>
 Post authentication processing extensions may be added to NDS (See BinAuth in the documentation). Once NDS has received the valid token it will, if enabled, call a BinAuth script.
</p>

<p>
 BinAuth Post Authentication processing is most often used to provide a mechanism for generating local client access logs.
</p>

<p>
 Binauth can override the FAS and deny access or override quotas and data rate restrictions that may be set by the FAS or globally in the configuration.
</p>

<p>
 If FAS Secure is enabled (Levels 1 (default), 2 and 3), the client authentication token is kept secret at all times. Instead, faskey is used to generate a hashed id value (hid) and this is sent by openNDS to the FAS. The FAS must then in turn generate a new return hash id (rhid) to return to openNDS in its authentication request.
</p>

<p>
 <strong>If set to “0” The FAS is enforced by NDS to use http protocol.</strong> The client token is sent to the FAS in clear text in the query string of the redirect along with authaction and redir. This method is easy to bypass and useful only for the simplest systems where security does not matter.
</p>

<p>
 <strong>If set to “1” The FAS is enforced by NDS to use http protocol.</strong> A base64 encoded query string containing the hid is sent to the FAS, along with the clientip, clientmac, gatewayname, client_hid, gatewayaddress, authdir, originurl, clientif and custom parameters and variables.
</p>

<p>
 Should the sha256sum utility not be available, openNDS will terminate with an error message on startup.
</p>

<p>
 <strong>If set to “2” The FAS is enforced by NDS to use http protocol.</strong>
</p>

<p>
 clientip, clientmac, gatewayname, client_hid, gatewayaddress, authdir, originurl and clientif are encrypted using faskey and passed to FAS in the query string.
</p>

<p>
 The query string will also contain a randomly generated initialization vector to be used by the FAS for decryption.
</p>

<p>
 The cipher used is “AES-256-CBC”.
</p>

<p>
 The “php-cli” package and the “php-openssl” module must both be installed for fas_secure level 2.
</p>

<p>
 openNDS does not depend on this package and module, but will exit gracefully if this package and module are not installed when this level is set.
</p>

<p>
 The FAS must use the query string passed initialisation vector and the pre shared fas_key to decrypt the query string. An example FAS level 2 php script (fas-aes.php) is stored in the /etc/opennds directory and also supplied in the source code. This should be copied the the web root of a suitable web server for use.
</p>

<p>
 <strong>If set to “3” The FAS is enforced by openNDS to use https protocol.</strong> Level 3 is the same as level 2 except the use of https protocol is enforced for FAS. In addition, the “authmon” daemon is loaded. This allows the external FAS, after client verification, to effectively traverse inbound firewalls and address translation to achieve NDS authentication without generating browser security warnings or errors. An example FAS level 3 php script (fas-aes-https.php) is pre-installed in the /etc/opennds directory and also supplied in the source code. This should be copied the the web root of a suitable web server for use.
</p>

<p>
 Option faskey has a default value. It is recommended that this is set to some secret value in the config file and the FAS script set to use a matching value, ie faskey must be pre-shared with FAS.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;FAS, or Forward Authentication Service&quot;,&quot;hid&quot;:&quot;fas_or_forward_authentication_service&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;5313-9290&quot;} -->
<h3 class="sectionedit8" id="a_note_on_captive_portal_detection_cpd">A Note on Captive Portal Detection (CPD)</h3>
<div class="level3">

<p>
All modern mobile devices, most desktop operating systems and most browsers now have a CPD process that automatically issues a port 80 request on connection to a network. NDS detects this and serves a special “splash” web page to the connecting client device.
</p>

<p>
The port 80 html request made by the client CPD can be one of many vendor specific URLs.
</p>

<p>
Typical CPD URLs used are, for example:
</p>
<ul>
<li class="level1"><div class="li"> <a href="http://captive.apple.com/hotspot-detect.html" class="urlextern" title="http://captive.apple.com/hotspot-detect.html" rel="ugc nofollow">http://captive.apple.com/hotspot-detect.html</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://connectivitycheck.gstatic.com/generate_204" class="urlextern" title="http://connectivitycheck.gstatic.com/generate_204" rel="ugc nofollow">http://connectivitycheck.gstatic.com/generate_204</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://connectivitycheck.platform.hicloud.com/generate_204" class="urlextern" title="http://connectivitycheck.platform.hicloud.com/generate_204" rel="ugc nofollow">http://connectivitycheck.platform.hicloud.com/generate_204</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.samsung.com/" class="urlextern" title="http://www.samsung.com/" rel="ugc nofollow">http://www.samsung.com/</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://detectportal.firefox.com/success.txt" class="urlextern" title="http://detectportal.firefox.com/success.txt" rel="ugc nofollow">http://detectportal.firefox.com/success.txt</a></div>
</li>
<li class="level1"><div class="li">  Plus many more</div>
</li>
</ul>

<p>
It is important to remember that CPD is designed primarily for mobile devices to automatically detect the presence of a portal and to trigger the login page, without having to resort to breaking <abbr title="Secure Socket Layer">SSL</abbr>/<abbr title="Transport Layer Security">TLS</abbr> security by requiring the portal to redirect port 443 for example.
</p>

<p>
Just about all current CPD implementations work very well but some compromises are necessary depending on the application.
</p>

<p>
The vast majority of devices attaching to a typical Captive Portal are mobile devices. CPD works well giving the initial login page.
</p>

<p>
For a typical guest wifi, eg a coffee shop, bar, club, hotel etc., a device connects, the Internet is accessed for a while, then the user takes the device out of range.
</p>

<p>
When taken out of range, a typical mobile device begins periodically polling the wireless spectrum for SSIDs that it knows about to try to obtain a connection again, subject to timeouts to preserve battery life.
</p>

<p>
Most Captive Portals have a session duration limit (openNDS included).
</p>

<p>
If a previously logged in device returns to within the coverage of the portal, the previously used SSID is recognised and CPD is triggered and tests for an Internet connection in the normal way. Within the session duration limit of the portal, the Internet connection will be established, if the session has expired, the splash page will be displayed again.
</p>

<p>
Early mobile device implementations of CPD used to poll their detection <abbr title="Uniform Resource Locator">URL</abbr> at regular intervals, typically around 30 to 300 seconds. This would trigger the Portal splash page quite quickly if the device stayed in range and the session limit had been reached. 
</p>

<p>
However it was very quickly realised that this polling kept the WiFi on the device enabled continuously having a very negative effect on battery life, so this polling whilst connected was either increased to a very long interval or removed all together (depending on vendor) to preserve battery charge. As most mobile devices come and go into and out of range, this is not an issue.
</p>

<p>
<strong>A common issue raised is:</strong>
</p>

<p>
<em>“My devices show the splash page when they first connect, but when the authorization expires, they just announce there is no internet connection. I have to make them “forget” the wireless network to see the splash page again. Is this how is it supposed to work?”</em>
</p>

<p>
This is normal, but you will find just manually disconnecting or turning WiFi off and on will simulate a “going out of range”, initialising an immediate trigger of the CPD. One or any combination of these solutions should work, again depending on the particular vendor&#039;s implementation of CPD.
</p>

<p>
In contrast, most laptop/desktop operating systems, and browser versions for these still implement CPD polling whilst online as battery considerations are not so important.
</p>

<p>
For example, Gnome desktop has its own built in CPD browser with a default interval of 300 seconds. Firefox also defaults to something like 300 seconds. Windows 10 is similar.
</p>

<p>
This IS how it is supposed to work, but does involve some compromises.
</p>

<p>
The best solution is to set the session timeout to a value greater than the expected length of time a client device is likely to be present. Experience shows a limit of 24 hours covers most situations eg bars, clubs, coffee shops, motels etc. If for example an hotel has guests regularly staying for a few days, then increase the session timeout as required.
</p>

<p>
Staff at the venue could have their devices added to the Trusted List if appropriate, but experience shows, it is better not to do this as they very soon learn what to do and can help guests who encounter the issue. (Anything that reduces support calls is good!)
</p>

<p>
Most such issues with CPD are potentially solved by the use of CPI instead but would require its adoption by all client device vendors.
CPI is a new standard that is evolving as it is universally adopted. At the time of writing, most new devices support it to some degree.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;A Note on Captive Portal Detection (CPD)&quot;,&quot;hid&quot;:&quot;a_note_on_captive_portal_detection_cpd&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;9291-&quot;} -->