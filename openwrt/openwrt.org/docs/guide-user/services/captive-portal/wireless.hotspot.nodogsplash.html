
<h1 class="sectionedit1" id="nodogsplash_outdated_document">Nodogsplash (Outdated document)</h1>
<div class="level1">

<p>
<span style='color:#ed1c24; '><strong>!!!Warning!!!</strong></span>
This document is VERY outdated and in some instances misleading due to its outdated nature.
Please go to:
</p>

<p>
<a href="/docs/guide-user/services/captive-portal/opennds" class="wikilink1" title="docs:guide-user:services:captive-portal:opennds" data-wiki-id="docs:guide-user:services:captive-portal:opennds">OpenNDS</a>
</p>

<p>
<code>Nodogsplash</code> offers a simple way to open a free <a href="https://en.wikipedia.org/wiki/Hotspot (Wi-Fi)" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Hotspot (Wi-Fi)">Hotspot (Wi-Fi)</a> providing restricted access to an Internet connection.<br/>

The goal was to use a single wireless router to both provide local secure wifi, and share a portion of our bandwidth as a free hotspot, with a splash page to advertise who is providing the hotspot, and the fact that secure, faster access is available for a small contribution towards costs.
</p>

<p>
This page describes setting up a simple wireless hotspot with the following features:
</p>
<ul>
<li class="level1"><div class="li"> Open access to the hotspot</div>
</li>
<li class="level1"><div class="li"> Capture (splash) page</div>
</li>
<li class="level1"><div class="li"> Port restrictions</div>
</li>
<li class="level1"><div class="li"> Bandwidth Limit</div>
</li>
<li class="level1"><div class="li"> Separate, secure wireless access for local use</div>
</li>
</ul>

<p>
The secure wireless is bridged to the hard-wired ports, the hotspot is separate and isolated from the local network.
</p>

<p>
Official documentation: <a href="https://nodogsplashdocs.readthedocs.io/en/stable/" class="urlextern" title="https://nodogsplashdocs.readthedocs.io/en/stable/" rel="ugc nofollow">https://nodogsplashdocs.readthedocs.io/en/stable/</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Nodogsplash (Outdated document)&quot;,&quot;hid&quot;:&quot;nodogsplash_outdated_document&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-1110&quot;} -->
<h2 class="sectionedit2" id="overview">Overview</h2>
<div class="level2">

<p>
The nodogsplash captive portal runs as a service that manages client traffic over a router by adjusting firewall rules based on client tracking tools that interact with a users browser and client network requests.
</p>

<p>
In order to fully setup user and password authentication or more complex configuration. You will need to read the linked documentation to gain better understanding of the layers that are involved.
</p>

<p>
Usually this will require some basic script/web source editing and web server setup and modification. On Openwrt if user credentials are to be local to the router this will also need to be considered.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Overview&quot;,&quot;hid&quot;:&quot;overview&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;1111-1749&quot;} -->
<h2 class="sectionedit3" id="installation">Installation</h2>
<div class="level2">

<p>
<a href="/docs/guide-user/additional-software/opkg" class="wikilink1" title="docs:guide-user:additional-software:opkg" data-wiki-id="docs:guide-user:additional-software:opkg">opkg</a>
</p>
<pre class="code">opkg update
opkg install nodogsplash</pre>

<p>
In <strong>/etc/config/nodogsplash</strong> ensure option enabled is 1
</p>
<pre class="code">  option enabled 1</pre>

<p>
Enable and start the nodogsplash ( NDS ) service.
</p>
<pre class="code">/etc/init.d/nodogsplash enable
/etc/init.d/nodogsplash start</pre>

<p>
Some useful commands are listed below.
</p>
<pre class="code">/usr/bin/ndsctl status                 ( check if nodogsplash is up )
/usr/bin/ndsctl clients                ( list connected clients and status )
/usr/bin/ndsctl deauth 192.168.1.10    ( useful for testing )</pre>

<p>
See <a href="https://github.com/nodogsplash/nodogsplash#7-debugging-nodogsplash" class="urlextern" title="https://github.com/nodogsplash/nodogsplash#7-debugging-nodogsplash" rel="ugc nofollow">https://github.com/nodogsplash/nodogsplash#7-debugging-nodogsplash</a> about how to debug start-up issues.
</p>

<p>
Documentation can be found online <a href="https://nodogsplash.readthedocs.io/en/latest/" class="urlextern" title="https://nodogsplash.readthedocs.io/en/latest/" rel="ugc nofollow">here</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation&quot;,&quot;hid&quot;:&quot;installation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;1750-2555&quot;} -->
<h2 class="sectionedit4" id="configuration">Configuration</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuration&quot;,&quot;hid&quot;:&quot;configuration&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:4,&quot;range&quot;:&quot;2556-2582&quot;} -->
<h3 class="sectionedit5" id="nodogsplash_configuration_file">Nodogsplash Configuration File</h3>
<div class="level3">

<p>
Older versions use <code>/etc/nodogsplash/nodogsplash.conf</code>, while versions starting at 0.9_beta9.9.9-5 in Chaos Calmer 15.05 use UCI with <code>/etc/config/nodogsplash</code>.
</p>

<p>
The “/etc/config/nodogsplash” config file can be seen <a href="https://github.com/openwrt-routing/packages/blob/master/nodogsplash/files/nodogsplash.config" class="urlextern" title="https://github.com/openwrt-routing/packages/blob/master/nodogsplash/files/nodogsplash.config" rel="ugc nofollow">here</a> or <a href="https://raw.githubusercontent.com/nodogsplash/nodogsplash/master/openwrt/nodogsplash/files/etc/config/nodogsplash" class="urlextern" title="https://raw.githubusercontent.com/nodogsplash/nodogsplash/master/openwrt/nodogsplash/files/etc/config/nodogsplash" rel="ugc nofollow">here</a>, and is documented below.
</p>

<p>
Below is a documented version of the “/etc/config/nodogsplash” file. This UCI file is automatically turned into a temporary config file with the old format when nodogsplash starts. That file can be viewed in /tmp/etc/. 
</p>
<pre class="code">config nodogsplash
  # Set to 1 to enable nodogsplash
  option enabled 0

  # Use plain configuration file
  #option config &#039;/etc/nodogsplash/nodogsplash.conf&#039;

  # The network the users are connected to - if you connect to &#039;br-lan&#039;, enter &#039;lan&#039; here.
  option network &#039;lan&#039;
  
  # Set GatewayName to the name of your gateway. This value
  # will be available as variable $gatewayname in the splash page source
  # and in status output from ndsctl, but otherwise doesn&#039;t matter.
  # If none is supplied, the value &quot;NoDogSplash&quot; is used.
  option gatewayname &#039;OpenWrt Nodogsplash&#039;
  
  # Set MaxClients to the maximum number of users allowed to
  # connect at any time. (Does not include users on the TrustedMACList,
  # who do not authenticate.)
  option maxclients &#039;250&#039;
  
  # Set ClientIdleTimeout to the desired of number of minutes
  # of inactivity before a user is automatically &#039;deauthenticated&#039;.
  option clientidletimeout &#039;1200&#039;
  
  # Set ClientForceTimeout to the desired number of minutes before
  # a user is automatically &#039;deauthenticated&#039;, whether active or not
  # option clientforcetimeout &#039;1200&#039;

  ###########################
  # ## authenticated_users ##
  ###########################
  # Control access for users after authentication.
  # These rules are inserted at the beginning of the
  # FORWARD chain of the router&#039;s filter table, and
  # apply to packets that have come in to the router
  # over the GatewayInterface from MAC addresses that
  # have authenticated with Nodogsplash, and that are
  # destined to be routed through the router. The rules are
  # considered in order, and the first rule that matches
  # a packet applies to it.
  # If there are any rules in this ruleset, an authenticated
  # packet that does not match any rule is rejected.
  # N.B.: This ruleset is completely independent of
  # the preauthenticated-users ruleset.
  
  # You may want to open access to a machine on a local
  # subnet that is otherwise blocked (for example, to
  # serve a redirect page; see RedirectURL). If so,
  # allow that explicitly, e.g:
  # list authenticated_users &#039;allow tcp port 80 to 192.168.254.254&#039;

  # Your router may have several interfaces, and you
  # probably want to keep them private from the network/gatewayinterface.
  # If so, you should block the entire subnets on those interfaces, e.g.:
  list authenticated_users &#039;block to 192.168.0.0/16&#039;
  list authenticated_users &#039;block to 10.0.0.0/8&#039;

  # Typical ports you will probably want to open up.
  list authenticated_users &#039;allow tcp port 22&#039;
  list authenticated_users &#039;allow tcp port 53&#039;
  list authenticated_users &#039;allow udp port 53&#039;
  list authenticated_users &#039;allow tcp port 80&#039;
  list authenticated_users &#039;allow tcp port 443&#039;

  ##############################
  # ## preauthenticated_users ##
  ##############################
  # Control access for users before authentication.
  # These rules are inserted in the PREROUTING chain
  # of the router&#039;s nat table, and in the
  # FORWARD chain of the router&#039;s filter table.
  # These rules apply to packets that have come in to the
  # router over the GatewayInterface from MAC addresses that
  # are not on the BlockedMACList or TrustedMACList,
  # are *not* authenticated with Nodogsplash. The rules are
  # considered in order, and the first rule that matches
  # a packet applies to it. A packet that does not match
  # any rule here is rejected.
  # N.B.: This ruleset is completely independent of
  # the authenticated-users and users-to-router rulesets.
 
  # For splash page content not hosted on the router, you
  # will want to allow port 80 tcp to the remote host here.
  # Doing so circumvents the usual capture and redirect of
  # any port 80 request to this remote host.
  # Note that the remote host&#039;s numerical IP address must be known
  # and used here.
  # list preauthenticated_users &#039;allow tcp port 80 to 123.321.123.321&#039;
 
  # For preauthenticated users to resolve IP addresses in their
  # initial request not using the router itself as a DNS server,
  list preauthenticated_users &#039;allow tcp port 53&#039;
  list preauthenticated_users &#039;allow udp port 53&#039;


  #######################
  # ## users_to_router ##
  #######################
  # Control access to the router itself from the GatewayInterface.
  # These rules are inserted at the beginning of the
  # INPUT chain of the router&#039;s filter table, and
  # apply to packets that have come in to the router
  # over the GatewayInterface from MAC addresses that
  # are not on the TrustedMACList, and are destined for
  # the router itself. The rules are considered
  # in order, and the first rule that matches a packet applies
  # to it.
  # If there are any rules in this ruleset, a
  # packet that does not match any rule is rejected.
  
  # Allow ports for SSH/Telnet/DNS/DHCP/HTTP/HTTPS
  list users_to_router &#039;allow tcp port 22&#039;
  list users_to_router &#039;allow tcp port 23&#039;
  list users_to_router &#039;allow tcp port 53&#039;
  list users_to_router &#039;allow udp port 53&#039;
  list users_to_router &#039;allow udp port 67&#039;
  list users_to_router &#039;allow tcp port 80&#039;
  list users_to_router &#039;allow tcp port 443&#039;

  # MAC addresses that are / are not allowed to access the splash page
  # Value is either &#039;allow&#039; or &#039;block&#039;. The allowedmac or blockedmac list is used.
  #option macmechanism &#039;allow&#039;
  #list allowedmac &#039;00:00:C0:01:D0:0D&#039;
  #list allowedmac &#039;00:00:C0:01:D0:1D&#039;
  #list blockedmac &#039;00:00:C0:01:D0:2D&#039;

  #MAC addresses that do not need to authenticate
  #list trustedmac &#039;00:00:C0:01:D0:1D&#039;

  # EmptyRuleSetPolicy directives
  # The FirewallRuleSets that NoDogSplash permits are:
  #
  # authenticated-users
  # preauthenticated-users
  # users-to-router
  # trusted-users
  # trusted-users-to-router
  #
  # For each of these, an EmptyRuleSetPolicy can be specified.
  # An EmptyRuleSet policy applies to a FirewallRuleSet if the
  # FirewallRuleSet is missing from this configuration file,
  # or if it exists but contains no FirewallRules.
  #
  # The possible values of an EmptyRuleSetPolicy are:
  # allow -- packets are accepted
  # block -- packets are rejected
  # passthrough -- packets are passed through to pre-existing firewall rules
  #
  # Default EmptyRuleSetPolicies are set as follows:
  # EmptyRuleSetPolicy authenticated-users passthrough
  # EmptyRuleSetPolicy preauthenticated-users block
  # EmptyRuleSetPolicy users-to-router block
  # EmptyRuleSetPolicy trusted-users allow
  # EmptyRuleSetPolicy trusted-users-to-router allow

  # This should be autodetected on an OpenWRT system, but if not:
  # Set GatewayAddress to the IP address of the router on
  # the GatewayInterface. This is the address that the Nodogsplash
  # server listens on.
  # option gatewayaddress &#039;192.168.1.1&#039;

  # This should be autodetected from /proc/net/route on a OpenWRT system, but if
  # not: set ExtrnalInterface to the &#039;external&#039; interface on your router,
  # i.e. the one which provides the default route to the internet.
  # Typically vlan1 for OpenWRT.
  # option externalinterface &#039;vlan1&#039;


  # After authentication, normally a user is redirected
  # to their initially requested page.
  # If RedirectURL is set, the user is redirected to this URL instead.
  # option redirecturl &#039;http://www.ilesansfil.org/&#039;

  # Nodogsplash&#039;s own http server uses GatewayAddress as its IP address.
  # The port it listens to at that IP can be set here; default is 2050.
  # option gatewayport &#039;2050&#039;


  # Set to yes (or true or 1), to immediately authenticate users
  # who make a http port 80 request on the GatewayInterface (that is,
  # do not serve a splash page, just redirect to the user&#039;s request,
  # or to RedirectURL if set).
  # option authenticateimmediately &#039;no&#039;

  # Either block or allow.
  # If &#039;block&#039;, MAC addresses on BlockedMACList are blocked from
  # authenticating, and all others are allowed.
  # If &#039;allow&#039;, MAC addresses on AllowedMACList are allowed to
  # authenticate, and all other (non-trusted) MAC&#039;s are blocked.
  # option macmechanism &#039;block&#039;

  # Set to yes (or true or 1), to require a password matching
  # the Password parameter to be supplied when authenticating.
  # option passwordauthentication &#039;no&#039;

  # Whitespace delimited string that is compared to user-supplied
  # password when authenticating.
  # option password &#039;nodog&#039;

  # Set to yes (or true or 1), to require a username matching
  # the Username parameter to be supplied when authenticating.
  # option usernameauthentication &#039;no&#039;

  # Whitespace delimited string that is compared to user-supplied
  # username when authenticating.
  # option username &#039;guest&#039;

  # Integer number of failed password/username entries before
  # a user is forced to reauthenticate.
  # option passwordattempts &#039;5&#039;

  # By setting this parameter, you can specify a range of IP addresses
  # on the GatewayInterface that will be responded to and managed by
  # Nodogsplash. Addresses outside this range do not have their packets
  # touched by Nodogsplash at all.
  # Defaults to 0.0.0.0/0, that is, all addresses.
  # option gatewayiprange &#039;0.0.0.0/0&#039;</pre>

<p>
Allow access to email:
</p>
<pre class="code">  list authenticated_users &#039;allow tcp port 995&#039;
  list authenticated_users &#039;allow tcp port 993&#039;
  list authenticated_users &#039;allow tcp port 465&#039;
  list authenticated_users &#039;allow tcp port 110&#039;
  list authenticated_users &#039;allow tcp port 143&#039;</pre>

<p>
Restrict access to the gateway from the hotspot side:
</p>
<pre class="code">  list users_to_router &#039;allow tcp port 22&#039;
  list users_to_router &#039;allow tcp port 80&#039;
  list users_to_router &#039;allow tcp port 443&#039;</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Nodogsplash Configuration File&quot;,&quot;hid&quot;:&quot;nodogsplash_configuration_file&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:5,&quot;range&quot;:&quot;2583-12871&quot;} -->
<h3 class="sectionedit6" id="mwan3_compatibility">mwan3 Compatibility</h3>
<div class="level3">

<p>
NDS and mwan3 both mess with iptables. As such they need a little extra configuration sometimes to work together.
</p>

<p>
<strong>NDS 0.9</strong>
</p>

<p>
Add the following lines to /etc/nodogsplash/nodogsplash.conf:
</p>
<pre class="code">FW_MARK_AUTHENTICATED 262144
FW_MARK_TRUSTED 131072
FW_MARK_BLOCKED 65536</pre>

<p>
<strong>NDS 1.0</strong>
</p>

<p>
Make the following changes per <a href="https://github.com/nodogsplash/nodogsplash/issues/218" class="urlextern" title="https://github.com/nodogsplash/nodogsplash/issues/218" rel="ugc nofollow">this</a> issue.
</p>

<p>
In /etc/config/nodogsplash:
</p>
<pre class="code">list fw_mark_authenticated &#039;30000&#039;
list fw_mark_trusted &#039;20000&#039;
list fw_mark_blocked &#039;10000&#039;</pre>

<p>
In /etc/config/mwan3:
</p>
<pre class="code">config globals &#039;globals&#039;</pre>

<p>
<strong>NDS 2.0</strong>
<em>(compatible by default)</em>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;mwan3 Compatibility&quot;,&quot;hid&quot;:&quot;mwan3_compatibility&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:6,&quot;range&quot;:&quot;12872-13539&quot;} -->
<h3 class="sectionedit7" id="check_status">Check status</h3>
<div class="level3">

<p>
Nodogsplash package provides the <code>ndsctl</code> binary to manage it. Run ndsctl without arguments to see the help.
</p>
<pre class="code">root@openWrt:~# ndsctl       
Usage: ndsctl [options] command [arguments]

options:
  -s &lt;path&gt;           Path to the socket
  -h                  Print usage

commands:
  status              View the status of nodogsplash
  clients             Display machine-readable client list
  json             	  Display machine-readable client list in json format
  stop                Stop the running nodogsplash
  auth mac|ip|token   Authenticate user with specified mac, ip or token
  deauth mac|ip|token Deauthenticate user with specified mac, ip or token
  block mac           Block the given MAC address
  unblock mac         Unblock the given MAC address
  allow mac           Allow the given MAC address
  unallow mac         Unallow the given MAC address
  trust mac           Trust the given MAC address
  untrust mac         Untrust the given MAC address
  loglevel n          Set logging level to n
  password pass       Set gateway password
  username name       Set gateway username
</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Check status&quot;,&quot;hid&quot;:&quot;check_status&quot;,&quot;codeblockOffset&quot;:10,&quot;secid&quot;:7,&quot;range&quot;:&quot;13540-14683&quot;} -->
<h2 class="sectionedit8" id="customise_splash_page">Customise splash page</h2>
<div class="level2">

<p>
Edit these files to customize the “splash page” / “error page”:
</p>
<ul>
<li class="level1"><div class="li"> <code>/etc/nodogsplash/htdocs/splash.html</code></div>
</li>
<li class="level1"><div class="li"> <code>/etc/nodogsplash/htdocs/infoskel.html</code></div>
</li>
</ul>

<p>
Note, to include an external <code>*.css</code> file, put it in the images directory, and include as so:
</p>
<pre class="code">@import url(&quot;$imagesdir/stylesheet.css&quot;);</pre>

<p>
Somewhere in <code>splash.html</code> you should include a link for the authentication, e.g:
</p>
<pre class="code html4strict"><span class="sc2">&lt;<a href="http://december.com/html/4/element/h3.html"><span class="kw2">h3</span></a>&gt;</span> Click <span class="sc2">&lt;<a href="http://december.com/html/4/element/a.html"><span class="kw2">a</span></a> <span class="kw3">href</span><span class="sy0">=</span><span class="st0">&quot;$authtarget&quot;</span>&gt;</span> HERE<span class="sc2">&lt;<span class="sy0">/</span><a href="http://december.com/html/4/element/a.html"><span class="kw2">a</span></a>&gt;</span> to start browsing <span class="sc2">&lt;<span class="sy0">/</span><a href="http://december.com/html/4/element/h3.html"><span class="kw2">h3</span></a>&gt;</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Customise splash page&quot;,&quot;hid&quot;:&quot;customise_splash_page&quot;,&quot;codeblockOffset&quot;:11,&quot;secid&quot;:8,&quot;range&quot;:&quot;14684-15203&quot;} -->
<h2 class="sectionedit9" id="restrict_access_to_domains">Restrict access to domains</h2>
<div class="level2">

<p>
If you would want to restrict the access to the <abbr title="Internet Protocol">IP</abbr> address 20.20.20.20 you can use this <a href="/docs/guide-user/firewall/netfilter-iptables/netfilter" class="wikilink2" title="docs:guide-user:firewall:netfilter-iptables:netfilter" rel="nofollow" data-wiki-id="docs:guide-user:firewall:netfilter-iptables:netfilter">netfilter</a> command (supposing 10.20.30.0/24 is your hotspot network and you redirect clients to your nodogsplash webserver)
</p>
<pre class="code">  iptables -t nat -I ndsOUT -p tcp -s 10.20.30.0/24 -d 20.20.20.20 --dport 80 -j DNAT --to 10.20.30.1:2050</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Restrict access to domains&quot;,&quot;hid&quot;:&quot;restrict_access_to_domains&quot;,&quot;codeblockOffset&quot;:13,&quot;secid&quot;:9,&quot;range&quot;:&quot;15204-15626&quot;} -->
<h3 class="sectionedit10" id="restrict_access_to_multiple_domains">Restrict access to multiple domains</h3>
<div class="level3">

<p>
Some domains resolve to multiple different ip addresses so you need to ban all of them.
</p>
<ol>
<li class="level1"><div class="li"> Create <code>/root/banned.txt</code> with the domains to ban (do not add domains with www):<pre class="code">root@openWrt:~# head /root/banned.txt 
alice.cc
malware.ru
sersnkis.com
superdupertorrent.com
ultraload.com
downloadmuch.com</pre>
</div>
</li>
<li class="level1"><div class="li"> Create following script <code>/root/ban-domains.sh</code>:<pre class="code bash"><span class="co0">#!/bin/sh</span>
&nbsp;
<span class="kw1">for</span> domain <span class="kw1">in</span> <span class="sy0">`</span><span class="kw2">cat</span> <span class="sy0">/</span>root<span class="sy0">/</span>banned.txt<span class="sy0">`</span>; <span class="kw1">do</span>
	<span class="kw2">dig</span> <span class="sy0">@</span>8.8.8.8 <span class="re1">$domain</span> <span class="sy0">|</span> <span class="kw2">egrep</span> <span class="br0">&#91;</span><span class="nu0">0</span>-<span class="nu0">9</span><span class="br0">&#93;</span> <span class="sy0">|</span> <span class="kw2">grep</span> IN<span class="sy0">|</span> <span class="kw2">awk</span> <span class="br0">&#123;</span><span class="st_h">'print $5'</span><span class="br0">&#125;</span> <span class="sy0">&gt;&gt;</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>ips.txt
	<span class="kw1">done</span>
&nbsp;
<span class="kw1">for</span> <span class="kw2">ip</span> <span class="kw1">in</span> <span class="sy0">`</span><span class="kw2">cat</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>ips.txt<span class="sy0">`</span>; <span class="kw1">do</span>
	iptables <span class="re5">-t</span> nat <span class="re5">-I</span> ndsOUT <span class="re5">-p</span> tcp <span class="re5">-s</span> 10.20.30.0<span class="sy0">/</span><span class="nu0">24</span> <span class="re5">-d</span> <span class="re1">$ip</span> <span class="re5">--dport</span> <span class="nu0">80</span> <span class="re5">-j</span> DNAT <span class="re5">--to</span> 10.20.30.1:<span class="nu0">80</span>
	<span class="kw1">done</span>
&nbsp;
<span class="kw2">rm</span> <span class="re5">-fr</span> <span class="sy0">/</span>tmp<span class="sy0">/</span>ips.txt</pre>
</div>
</li>
<li class="level1"><div class="li"> run <pre class="code">chmod +x /root/ban-domains.sh&quot;</pre>
</div>
</li>
<li class="level1"><div class="li"> install dig package: <pre class="code">opkg install bind-dig</pre>
</div>
</li>
<li class="level1"><div class="li"> add <code>/root/ban-domains.sh</code> to your <code>/etc/rc.local</code> file.</div>
</li>
</ol>

<p>
after executing the script you can check if it works ok running “iptables -t nat -L -n” and you should get something like this:
</p>
<pre class="code">Chain ndsOUT (1 references)
target     prot opt source               destination         
DNAT       tcp  --  10.20.30.0/24        199.58.211.41       tcp dpt:80 to:10.20.30.1:80 
DNAT       tcp  --  10.20.30.0/24        69.163.39.214       tcp dpt:80 to:10.20.30.1:80 
DNAT       tcp  --  10.20.30.0/24        78.140.135.6        tcp dpt:80 to:10.20.30.1:80 
DNAT       tcp  --  10.20.30.0/24        74.117.114.96       tcp dpt:80 to:10.20.30.1:80 
DNAT       tcp  --  10.20.30.0/24        88.85.73.158        tcp dpt:80 to:10.20.30.1:80 
DNAT       tcp  --  10.20.30.0/24        216.69.227.108      tcp dpt:80 to:10.20.30.1:80 
DNAT       tcp  --  10.20.30.0/24        72.8.129.153        tcp dpt:80 to:10.20.30.1:80 </pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Restrict access to multiple domains&quot;,&quot;hid&quot;:&quot;restrict_access_to_multiple_domains&quot;,&quot;codeblockOffset&quot;:14,&quot;secid&quot;:10,&quot;range&quot;:&quot;15627-17399&quot;} -->
<h3 class="sectionedit11" id="restrict_access_to_dns_vpns">Restrict access to DNS VPNs</h3>
<div class="level3">

<p>
The default config opens <abbr title="Transmission Control Protocol">TCP</abbr> and <abbr title="User Datagram Protocol">UDP</abbr> port 53 without redirecting it to a <abbr title="Domain Name System">DNS</abbr> server, and this could be exploited with iodine or any <abbr title="Virtual Private Network">VPN</abbr> software by using those ports. Limit it by changing:
</p>
<pre class="code">  #list preauthenticated_users &#039;allow tcp port 53&#039;
  list preauthenticated_users &#039;allow udp port 53 to 208.67.222.222&#039;
  list preauthenticated_users &#039;allow udp port 53 to 208.67.220.220&#039;</pre>

<p>
In your /etc/config/nodogsplash file, and change the <abbr title="Domain Name System">DNS</abbr> for ones you use.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Restrict access to DNS VPNs&quot;,&quot;hid&quot;:&quot;restrict_access_to_dns_vpns&quot;,&quot;codeblockOffset&quot;:19,&quot;secid&quot;:11,&quot;range&quot;:&quot;17400-17906&quot;} -->
<h2 class="sectionedit12" id="external_links">External links</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="http://kokoro.ucsd.edu/nodogsplash/" class="urlextern" title="http://kokoro.ucsd.edu/nodogsplash/" rel="ugc nofollow">Original Nodogsplash project homepage</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/nodogsplash/nodogsplash" class="urlextern" title="https://github.com/nodogsplash/nodogsplash" rel="ugc nofollow">Current Nodogsplash source repository</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/openwrt-routing/packages" class="urlextern" title="https://github.com/openwrt-routing/packages" rel="ugc nofollow">Nodogsplash OpenWrt package</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;External links&quot;,&quot;hid&quot;:&quot;external_links&quot;,&quot;codeblockOffset&quot;:20,&quot;secid&quot;:12,&quot;range&quot;:&quot;17907-18185&quot;} -->
<h1 class="sectionedit13" id="misc">Misc.</h1>
<div class="level1">

<p>
If your configuration does NOT use <abbr title="Network Address Translation">NAT</abbr>, you need to check “force connection tracking” in the firewall configuration of the zone nodogsplash is handling. Without connection tracking, the <abbr title="Network Address Translation">NAT</abbr> tables of will not run and redirecting to the splash page does not work.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Misc.&quot;,&quot;hid&quot;:&quot;misc&quot;,&quot;codeblockOffset&quot;:20,&quot;secid&quot;:13,&quot;range&quot;:&quot;18186-18469&quot;} -->
<h2 class="sectionedit14" id="nodogsplash_on_openwrt_1209_access_point">NoDogSplash on OpenWRT 12.09+ Access Point</h2>
<div class="level2">

<p>
The following instructions are touching NoDogSplash configuration on the OpenWRT 12.09 and later firmwares with “router” configured as a <strong>switch</strong> or <strong>Access Point</strong> (<abbr title="Access Point">AP</abbr>). OpenWrt is not configured as a router here! This is a common setup where users want to add additional <abbr title="Access Point">AP</abbr> to extend their home WiFi coverage and do not want to mess with router from their Internet providers.
Example setup:
</p>
<ul>
<li class="level1"><div class="li">  Non OpenWRT router for intranet with address 192.168.1.1</div>
</li>
<li class="level1"><div class="li">  OpenWRT <abbr title="Access Point">AP</abbr> with static address 192.168.1.3</div>
</li>
<li class="level1"><div class="li">  Clients get <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> subnet range 192.168.1.200-250 by router</div>
</li>
<li class="level1"><div class="li">  Clients can connect to <abbr title="Access Point">AP</abbr> WiFi within secure SSID</div>
</li>
<li class="level1"><div class="li">  Guest hotspot SSID are getting their own 192.168.15.0/24 subnet and <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> on isolated segment</div>
</li>
</ul>

<p>
Configuration of the <abbr title="Access Point">AP</abbr> is as usual except that <abbr title="Access Point">AP</abbr> needs to have <abbr title="Network Address Translation">NAT</abbr> for the hotspot segment only. To achieve this one needs to add custom iptables rule
</p>
<pre class="code">iptables -A POSTROUTING -t nat -j SNAT --to-source 192.168.1.3</pre>

<p>
and delete all provided firewall rules fy using OpenWRT web interface.
</p>

<p>
Detailed configuration for <abbr title="Access Point">AP</abbr> only OpenWRT is:
</p>
<ol>
<li class="level1"><div class="li"> Install package <em>nodogsplash</em></div>
</li>
<li class="level1"><div class="li"> With web interface <em>Network→WiFi</em> create: additional ESSID named hotstpot and create additional network hotstpot along with existing lan and unused wan.</div>
</li>
<li class="level1"><div class="li"> Edit <em>Network→Interfaces→HOTSPOT</em> and select Protocol: Static address with <abbr title="Internet Protocol version 4">IPv4</abbr> address 192.168.5.1 and Netmask: 255.255.255.0. Leave gateway, broadcast and <abbr title="Domain Name System">DNS</abbr> servers empty. Add <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> server for this interface with default settings. This HOTSPOT interface is internally named as wlan0-1 and will be used as NoDogSplash gateway address.</div>
</li>
<li class="level1"><div class="li"> Edit <em>Network→<abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> and <abbr title="Domain Name System">DNS</abbr></em>-Forwarder by unchecking Authoritative and add <abbr title="Domain Name System">DNS</abbr> forwardings: 192.168.1.1 to router <abbr title="Domain Name System">DNS</abbr> masquerading and/or external <abbr title="Domain Name System">DNS</abbr> servers from your internet provider.</div>
</li>
<li class="level1"><div class="li"> Remove all <em>Network→Firewall Zones</em> and add <em>Network→Firewall→Custom Rules</em> by adding iptables rule described above.</div>
</li>
<li class="level1"><div class="li"> Change <code>/etc/nodogsplash/nodogsplash.conf</code> affected lines to</div>
</li>
</ol>
<pre class="code">        GatewayInterface wlan0-1
        ExternalInterface br-lan</pre>

<p>
FirewallRuleSet authenticated-users can remain unchanged. You can also start iptables SNAT command manually if not rebooted meanwhile. Check the presence of this rule by <code>iptables -t nat -v -n -L</code>. Enable and start NoDogSplash. After above setup everything should work. Trafic shapping due to the lack of IMQ currently does not work on OpenWrt 12.09 (Attitude Adjustment).  One possibility is to install qos-scripts and luci-app-qos. Adding additional interface HOTSPOT to QOS configuration cannot separate between <abbr title="Wide Area Network">WAN</abbr> and HOTSPOT bandwidth limit. One can choose to limit NoDogSplash and secure WiFi together to certain Upload and Download rate, but not separate!
</p>

<p>
<strong>Added by NetoMX (2016/03/30): In my case, I needed to add in the default firewall rules, FORWARD→ACCEPT to make this work. I didn&#039;t make point 4 and it still works. For bandwitdh limit, use WShaper.

==== Legacy NDS - Bandwidth Control ====

In backfire 10.03.1rc5, you need to edit /etc/init.d/nodogsplash and uncomment last lines to make bandwidth control to work</strong>
</p>
<pre class="code">    # if not using traffic control,
    # you can comment out the following 3 lines:
    do_module_tests &quot;imq&quot; &quot;numdevs=2&quot;
    do_module_tests &quot;ipt_IMQ&quot;
    do_module_tests &quot;sch_htb&quot;</pre>

<p>
Note: <em>ipt_IMQ = xt_IMQ</em>
</p>

<p>
<strong>You also need to install some extra kernel modules:</strong>
</p>
<pre class="code">    opkg install iptables-mod-imq
    opkg install kmod-ipt-imq
    opkg install kmod-sched</pre>

<p>
And some utilities
</p>
<pre class="code">    opkg install ip
    opkg install tc</pre>

<p>
NOTE: In Attitude Adjustment 12.09 there is no <code>iptables-mod-imq</code> package and so traffic control no longer works.
</p>

<p>
For bandwidth control in <strong>Attitude Adjustment 12.09</strong> you can install <a href="http://lartc.org/wondershaper/" class="urlextern" title="http://lartc.org/wondershaper/" rel="ugc nofollow">WonderShaper</a> (which also uses <a href="/docs/guide-user/network/traffic-shaping/packet.scheduler" class="wikilink1" title="docs:guide-user:network:traffic-shaping:packet.scheduler" data-wiki-id="docs:guide-user:network:traffic-shaping:packet.scheduler">tc</a> as its back-end):
</p>
<pre class="code">    opkg install wshaper</pre>

<p>
WonderShaper&#039;s UCI config file is stored in <code>/etc/config/wshaper</code>. A simple configuration for a guest network might look like this:
</p>
<pre class="code">config wshaper &#039;settings&#039;
	option network &#039;public&#039;
	option downlink &#039;64&#039;
	option uplink &#039;512&#039;</pre>

<p>
<strong>Note:</strong> The <code>downlink</code> and <code>uplink</code> maximum values will usually need to be reversed from what one might, at first glance, expect. Also note that due to overhead, actual speeds will be slightly lower.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;NoDogSplash on OpenWRT 12.09+ Access Point&quot;,&quot;hid&quot;:&quot;nodogsplash_on_openwrt_1209_access_point&quot;,&quot;codeblockOffset&quot;:20,&quot;secid&quot;:14,&quot;range&quot;:&quot;18470-&quot;} -->