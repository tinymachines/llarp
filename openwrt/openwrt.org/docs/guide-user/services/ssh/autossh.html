
<h1 class="sectionedit1" id="autossh">Autossh</h1>
<div class="level1">

<p>
Autossh monitors a ssh connection and reconnects the ssh-session if the connection fails.
</p>

<p>
To automatically log in you need to use an authentication key.
</p>

<p>
The package, slightly outdated, can be found in the &#039;oldpackages&#039; feed.
</p>

<p>
Alternative packages:
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://github.com/hewenhao2008/autossh-openwrt" class="urlextern" title="https://github.com/hewenhao2008/autossh-openwrt" rel="ugc nofollow">https://github.com/hewenhao2008/autossh-openwrt</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/aa65535/openwrt-autossh" class="urlextern" title="https://github.com/aa65535/openwrt-autossh" rel="ugc nofollow">https://github.com/aa65535/openwrt-autossh</a></div>
</li>
</ul>

<p>
<a href="/docs/guide-user/services/ssh/sshtunnel" class="wikilink1" title="docs:guide-user:services:ssh:sshtunnel" data-wiki-id="docs:guide-user:services:ssh:sshtunnel">sshtunnel</a> is a simpler, functionally-identical package.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Autossh&quot;,&quot;hid&quot;:&quot;autossh&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-481&quot;} -->
<h2 class="sectionedit2" id="use_case">Use Case</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> You want to forward a local port (e.g. the webserver/ssh) to a remote server.</div>
</li>
<li class="level1"><div class="li"> If your client running OpenWrt is behind a <abbr title="Network Address Translation">NAT</abbr>, this allows to connect to a server that is not behind a <abbr title="Network Address Translation">NAT</abbr> and create a reverse tunnel to the local ssh server.</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Use Case&quot;,&quot;hid&quot;:&quot;use_case&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;482-750&quot;} -->
<h2 class="sectionedit3" id="installation">Installation</h2>
<div class="level2">
<ol>
<li class="level1"><div class="li"> Install autossh <pre class="code">opkg install autossh</pre>
</div>
</li>
<li class="level1 node"><div class="li"> Create a key <pre class="code">dropbearkey -t rsa -f /etc/dropbear/id_rsa</pre>
</div>
<ul>
<li class="level2"><div class="li"> On <em><strong>LEDE</strong> 17.01.x</em> use <pre class="code">dropbearkey -t rsa -f /root/.ssh/id_dropbear</pre>
</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> <code>dropbearkey</code> will print the public key, starting with <code>ssh-rsa</code>.</div>
<ul>
<li class="level2"><div class="li"> You can reprint the key using <pre class="code">dropbearkey -y -f /etc/dropbear/id_rsa</pre>
</div>
</li>
<li class="level2"><div class="li"> or you can write it to a file (e.g. <code>/tmp/pubkey</code>) <pre class="code">dropbearkey -y -f /etc/dropbear/id_rsa | grep ssh-rsa &gt; /tmp/pubkey</pre>
</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Add the key to the <code>authorized_keys</code> file on your server, e.g. copy pubkey file to the server and do <pre class="code">cat pubkey &gt;&gt; ~/.ssh/authorized_keys</pre>
</div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation&quot;,&quot;hid&quot;:&quot;installation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;751-1454&quot;} -->
<h2 class="sectionedit4" id="configuration">Configuration</h2>
<div class="level2">

<p>
Autossh is configured using the <a href="/docs/guide-user/base-system/uci" class="wikilink1" title="docs:guide-user:base-system:uci" data-wiki-id="docs:guide-user:base-system:uci"> Unified Configuration Interface</a> (<code>/etc/config/autossh</code>). 
</p>

<p>
A typical configuration is as follows:
</p>
<pre class="code">config autossh
        option ssh      &#039;-i /root/.ssh/dropbear -N -T -R 2222:192.168.1.1:22 remote_host_user_name@remote_host&#039;
        option gatetime &#039;0&#039;
        option monitorport      &#039;20000&#039;
        option poll     &#039;100&#039;
        option enabled  &#039;1&#039;</pre>

<p>
You need to replace <code>/root/.ssh/dropbear</code> with your key generated by dropbear.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuration&quot;,&quot;hid&quot;:&quot;configuration&quot;,&quot;codeblockOffset&quot;:6,&quot;secid&quot;:4,&quot;range&quot;:&quot;1455-2000&quot;} -->
<h2 class="sectionedit5" id="run_as_service">Run as Service</h2>
<div class="level2">

<p>
Autossh is often used as reverse proxy. It&#039;s probably because your <abbr title="Internet Service Provider">ISP</abbr> does not give you a public address or your router firewall policies. To make autossh run even when router restarts, your need to set up a service.
</p>

<p>
In <code>/etc/init.d/autossh</code>, most content of the files has been generated when you first install autossh. But you need add a line <code>procd_set_param env HOME=“/root”</code> in <code>start_instance()</code> or the the service will <strong>NOT</strong> work when the router reboots. This is a known bug not fixed yet. <a href="https://github.com/openwrt/packages/issues/5559" class="urlextern" title="https://github.com/openwrt/packages/issues/5559" rel="ugc nofollow">https://github.com/openwrt/packages/issues/5559</a>
</p>
<pre class="code">      start_instance() {
              local section=&quot;$1&quot;
      
              config_get ssh &quot;$section&quot; &#039;ssh&#039;
              config_get gatetime &quot;$section&quot; &#039;gatetime&#039;
              config_get monitorport &quot;$section&quot; &#039;monitorport&#039;
              config_get poll &quot;$section&quot; &#039;poll&#039;
              config_get_bool enabled &quot;$section&quot; &#039;enabled&#039; &#039;1&#039;
              
              [ &quot;$enabled&quot; = 1 ] || exit 0
              
              procd_open_instance
              procd_set_param command /usr/sbin/autossh -M ${monitorport:-20000} ${ssh}
              procd_set_param respawn ${respawn_threshold:-3600} ${respawn_timeout:-5} ${respawn_retry:-5}
              procd_set_param env AUTOSSH_GATETIME=&quot;${gatetime:-30}&quot; 
              procd_set_param env AUTOSSH_POLL=&quot;${poll:-600}&quot;
              procd_set_param env HOME=&quot;/root&quot;
              procd_close_instance</pre>

<p>
For the first time you connect, you need to make sure that the server is in the trusted-host list, otherwise autossh will restart in a loop.
</p>
<pre class="code">user.info autossh[17709]: starting ssh (count 10)
user.info autossh[17709]: ssh child pid is 17742
user.info autossh[17709]: ssh exited with error status 1; restarting ssh</pre>

<p>
Just run an <code>ssh -p port user@host</code> and accept.
Now you can enable the service by <code>/etc/init.d/autossh enable</code> and enjoy it.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Run as Service&quot;,&quot;hid&quot;:&quot;run_as_service&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:5,&quot;range&quot;:&quot;2001-3928&quot;} -->
<h2 class="sectionedit6" id="fixes">Fixes</h2>
<div class="level2">

<p>
To get ssh working you need to replace <code>localhost</code> in <code>2222:localhost:22</code> of the <code>ssh</code> variable to the local ip. 
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Fixes&quot;,&quot;hid&quot;:&quot;fixes&quot;,&quot;codeblockOffset&quot;:7,&quot;secid&quot;:6,&quot;range&quot;:&quot;3929-&quot;} -->