
<h1 class="sectionedit1" id="e-mailrelay">E-MailRelay</h1>
<div class="level1">

<p>
E-MailRelay is an e-mail store-and-forward message transfer agent and proxy server. E-MailRelay does three things: it stores any incoming e-mail messages that it receives, it forwards e-mail messages on to another remote e-mail server, and it serves up stored e-mail messages to local e-mail reader programs. More technically, it acts as a <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> storage daemon, a <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> forwarding agent, and a POP3 server.
</p>

<p>
E-MailRelay does not do routing of individual messages; it is not a routing MTA. It forwards all e-mail messages to a pre-configured <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> server, regardless of any message addressing or <abbr title="Domain Name System">DNS</abbr> redirects.
</p>

<p>
Package <a href="https://openwrt.org/packages/pkgdata/emailrelay" class="urlextern" title="https://openwrt.org/packages/pkgdata/emailrelay" rel="ugc nofollow">emailrelay</a> takes up to 1.4mb space and installs following files: 
</p>
<pre class="code">/usr/bin/emailrelay
/usr/bin/emailrelay-filter-copy
/usr/bin/emailrelay-passwd
/usr/bin/emailrelay-submit
/etc/config/emailrelay
/etc/emailrelay.auth</pre>

<p>
Its uci configuration is located in <code>/etc/config/emailrelay</code>. The config starts <em>emailrelay</em> command with options that are described in <a href="https://emailrelay.sourceforge.net/" class="urlextern" title="https://emailrelay.sourceforge.net/" rel="ugc nofollow">manual</a>.
You can also use plain config file <code>/etc/emailrelay.conf</code>. See full sample <a href="https://sourceforge.net/p/emailrelay/code/HEAD/tree/trunk/etc/emailrelay.conf.in" class="urlextern" title="https://sourceforge.net/p/emailrelay/code/HEAD/tree/trunk/etc/emailrelay.conf.in" rel="ugc nofollow">emailrelay.conf</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;E-MailRelay&quot;,&quot;hid&quot;:&quot;e-mailrelay&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-1295&quot;} -->
<h2 class="sectionedit2" id="sections">Sections</h2>
<div class="level2">

<p>
The default emailrelay config file contains <em>server</em>, <em>proxy</em> and <em>cmdline</em> sections.
</p>

<p>
The possible options are listed in the table below.
</p>
<div class="table sectionedit3"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Name </th><th class="col1"> Type </th><th class="col2"> Required </th><th class="col3"> Default </th><th class="col4"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>enabled</code> </td><td class="col1"> boolean </td><td class="col2"> yes </td><td class="col3"> <em>0</em> </td><td class="col4"> Listen <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>mode</code> </td><td class="col1"> string </td><td class="col2"> yes </td><td class="col3"> <em>server</em>, <em>proxy</em>, <em>client</em> or <em>cmdline</em> </td><td class="col4"> Mode: <em>--as-server</em> or <em>--as-proxy</em>. The <em>cmdline</em> means append <em>extra_cmdline</em> </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>smarthost</code> </td><td class="col1"> string </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> For <em>proxy</em> mode specify the <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> to forward emails. The option for <em>--as-proxy &lt;host:port&gt;</em> </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code>port</code> </td><td class="col1"> integer </td><td class="col2"> yes </td><td class="col3"> <em>25</em> </td><td class="col4"> Port to listen incoming emails. </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <code>remote_clients</code> </td><td class="col1"> boolean </td><td class="col2"> yes </td><td class="col3"> <em>0</em> </td><td class="col4"> To allow connections from anywhere. By default only local allowed. Check your firewall to avoid spam. See <em>--remote-clients</em> </td>
	</tr>
	<tr class="row6">
		<td class="col0"> <code>dnsbl</code> </td><td class="col1"> list </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> List of DNSBL servers that are used to reject <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> connections from blocked addresses. See <em>--dnsbl</em> </td>
	</tr>
	<tr class="row7">
		<td class="col0"> <code>address_verifier</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Runs the specified external program to verify a message recipient&#039;s e-mail address. See <em>--address-verifier</em> </td>
	</tr>
	<tr class="row8">
		<td class="col0"> <code>domain</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Specifies the network name that is used in <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> <code>EHLO</code>. The default is derived from a <abbr title="Domain Name System">DNS</abbr> lookup of the local hostname. See <em>--domain</em> </td>
	</tr>
	<tr class="row9">
		<td class="col0"> <code>anonymous</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <em>0</em> </td><td class="col4"> Disables the server&#039;s <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> VRFY command. See <em>--anonymous</em> </td>
	</tr>
	<tr class="row10">
		<td class="col0"> <code>server_tls</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <em>0</em> </td><td class="col4 leftalign"> For <em>server</em> and <em>proxy</em> mode. See <em>--server-tls</em> Doesn&#039;t work in v2.1, see <a href="https://github.com/openwrt/packages/pull/18536" class="urlextern" title="https://github.com/openwrt/packages/pull/18536" rel="ugc nofollow">fix</a>  </td>
	</tr>
	<tr class="row11">
		<td class="col0"> <code>server_tls_required</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <em>0</em> </td><td class="col4"> Makes the <abbr title="Transport Layer Security">TLS</abbr> mandatory for incoming <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> and <abbr title="Post Office Protocol">POP</abbr> connections. See <em>--server-tls-required</em></td>
	</tr>
	<tr class="row12">
		<td class="col0"> <code>server_tls_key</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Path to private key PEM file. See <em>--server-tls-certificate</em> </td>
	</tr>
	<tr class="row13">
		<td class="col0"> <code>server_tls_certificate</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Path to certificate PEM file. See <em>--server-tls-certificate</em> </td>
	</tr>
	<tr class="row14">
		<td class="col0"> <code>server_tls_verify</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Path to trusted CAs. Verify remote <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> and <abbr title="Post Office Protocol">POP</abbr> clients certificates against the trusted CA certificates. See <em>--server-tls-verify</em> </td>
	</tr>
	<tr class="row15">
		<td class="col0"> <code>server_auth</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> For <em>server</em> and <em>proxy</em> mode. See <em>--server-auth</em> and /etc/emailrelay.auth </td>
	</tr>
	<tr class="row16">
		<td class="col0"> <code>filter</code> </td><td class="col1"> list </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Filter program whenever a mail message is stored. See <em>--filter</em> </td>
	</tr>
	<tr class="row17">
		<td class="col0"> <code>client_tls</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <em>0</em> </td><td class="col4"> For <em>proxy</em> mode. See <em>--client-tls</em> </td>
	</tr>
	<tr class="row18">
		<td class="col0"> <code>client_tls_required</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <em>0</em> </td><td class="col4"> Makes the use of <abbr title="Transport Layer Security">TLS</abbr> mandatory for outgoing <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> connections. The <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> <code>STARTTLS</code> command will be used before mail messages are sent out. See <em>--client-tls-required</em> </td>
	</tr>
	<tr class="row19">
		<td class="col0"> <code>client_tls_key</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Path to <abbr title="Transport Layer Security">TLS</abbr> private key PEM file when acting as a <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> client. See <em>--client-tls-certificate</em> </td>
	</tr>
	<tr class="row20">
		<td class="col0"> <code>client_tls_certificate</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Path to <abbr title="Transport Layer Security">TLS</abbr> certificate file when acting as a <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> client. See <em>--client-tls-certificate</em> </td>
	</tr>
	<tr class="row21">
		<td class="col0"> <code>client_tls_verify</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Enables verification of the remote <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> server&#039;s certificate against any of the trusted CA certificates in the specified file or directory. See <em>--client-tls-verify</em> </td>
	</tr>
	<tr class="row22">
		<td class="col0"> <code>client_auth</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> For <em>proxy</em> mode. See <em>--client-auth</em> and <code>/etc/emailrelay.auth</code> </td>
	</tr>
	<tr class="row23">
		<td class="col0"> <code>smtp_client_interface</code> </td><td class="col1"> list </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> The <abbr title="Internet Protocol">IP</abbr> network address to be used to bind the local end of outgoing <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> connections. See <em>--client-interface</em> </td>
	</tr>
	<tr class="row24">
		<td class="col0"> <code>client_filter</code> </td><td class="col1"> list </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Filter program whenever a mail message is forwarded. See <em>--client-filter</em> </td>
	</tr>
	<tr class="row25">
		<td class="col0"> <code>pop</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <em>0</em> </td><td class="col4"> Enable <abbr title="Post Office Protocol">POP</abbr> server. See <em>--pop</em> </td>
	</tr>
	<tr class="row26">
		<td class="col0"> <code>pop_port</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>110</em> </td><td class="col4"> Port for incoming <abbr title="Post Office Protocol">POP</abbr> connections. See <em>--pop-port</em> </td>
	</tr>
	<tr class="row27">
		<td class="col0"> <code>pop_auth</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> A file containing <abbr title="Post Office Protocol">POP</abbr> account details. See <em>--pop-auth</em> and <code>/etc/emailrelay.auth</code> </td>
	</tr>
	<tr class="row28">
		<td class="col0"> <code>pop_by_name</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <em>0</em> </td><td class="col4"> Makes spool directory to be the sub-directory with the same name as the user-id used for <abbr title="Post Office Protocol">POP</abbr> authentication. See <em>--pop-by-name</em> </td>
	</tr>
	<tr class="row29">
		<td class="col0"> <code>pop_server_interface</code> </td><td class="col1"> list </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> The <abbr title="Internet Protocol">IP</abbr> network address to for <abbr title="Post Office Protocol">POP</abbr> connections. See <em>--interface</em> </td>
	</tr>
	<tr class="row30">
		<td class="col0"> <code>spool_dir</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>/var/spool/emailrelay</em> </td><td class="col4"> The directory used for holding mail messages that have been received but not yet forwarded. See <em>--spool-dir</em> </td>
	</tr>
	<tr class="row31">
		<td class="col0"> <code>delivery_dir</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>/var/spool/emailrelay/in</em> </td><td class="col4"> The base directory for mailboxes when delivering messages that have local recipients. See <em>--delivery-dir</em> </td>
	</tr>
	<tr class="row32">
		<td class="col0"> <code>extra_cmdline</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Extra command line options. See <a href="https://emailrelay.sourceforge.net/#reference_md_Reference" class="urlextern" title="https://emailrelay.sourceforge.net/#reference_md_Reference" rel="ugc nofollow">https://emailrelay.sourceforge.net/#reference_md_Reference</a> for command line reference </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;1463-6086&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Sections&quot;,&quot;hid&quot;:&quot;sections&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:2,&quot;range&quot;:&quot;1296-6087&quot;} -->
<h3 class="sectionedit4" id="server">Server</h3>
<div class="level3">

<p>
A minimal <code>server</code> declaration:
</p>
<pre class="code">config emailrelay &#039;server&#039;
        option enabled &#039;0&#039;
        option mode &#039;server&#039;
        option port &#039;25&#039;
        option remote_clients &#039;0&#039;</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Server&quot;,&quot;hid&quot;:&quot;server&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:4,&quot;range&quot;:&quot;6088-6297&quot;} -->
<h3 class="sectionedit5" id="proxy">Proxy</h3>
<div class="level3">

<p>
A minimal <code>proxy</code> declaration:
</p>
<pre class="code">config emailrelay &#039;proxy&#039;
        option enabled &#039;0&#039;
        option mode &#039;proxy&#039;
        option smarthost &#039;192.0.2.1:25&#039;
        option port &#039;25&#039;
        option remote_clients &#039;0&#039;</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Proxy&quot;,&quot;hid&quot;:&quot;proxy&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:5,&quot;range&quot;:&quot;6298-6543&quot;} -->
<h3 class="sectionedit6" id="plain_commands">Plain commands</h3>
<div class="level3">

<p>
A minimal <code>cmdline</code> declaration:
</p>
<pre class="code">config emailrelay &#039;cmdline&#039;
        option enabled &#039;0&#039;
        option mode &#039;cmdline&#039;
        # specify all arguments that should be passed to emailrelay here
        # see https://emailrelay.sourceforge.net/#reference_md_Reference for command line reference
        option extra_cmdline &#039;--some-other --cmdline-options&#039;</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Plain commands&quot;,&quot;hid&quot;:&quot;plain_commands&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:6,&quot;range&quot;:&quot;6544-6940&quot;} -->
<h2 class="sectionedit7" id="useful_options">Useful options</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Useful options&quot;,&quot;hid&quot;:&quot;useful_options&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:7,&quot;range&quot;:&quot;6941-6966&quot;} -->
<h3 class="sectionedit8" id="configure_tls">Configure TLS</h3>
<div class="level3">

<p>
<a href="/docs/guide-user/services/tls/certs" class="wikilink1" title="docs:guide-user:services:tls:certs" data-wiki-id="docs:guide-user:services:tls:certs">Obtain a TLS cert</a>
Then configure <code>server_tls</code> option and put private key and then after a comma a fullchain.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configure TLS&quot;,&quot;hid&quot;:&quot;configure_tls&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:8,&quot;range&quot;:&quot;6967-7142&quot;} -->
<h3 class="sectionedit9" id="mail_storage_location">Mail storage location</h3>
<div class="level3">

<p>
By default mails are stored into <code>/var/spool/emailrelay</code>. On the OpenWrt the entire <code>/var/</code> directory is tmpfs stored in RAM memory and will be lost on a router reboot.
So you need to change it to store them into some USB disk. To do this you have to create a folder e.g. <code>/mnt/usb_disk/spool/</code> and configure emailrelay to use it by setting:
</p>
<pre class="code">option extra_cmdline &#039;--spool-dir /mnt/usb_disk/spool/&#039; </pre>

<p>
In next versions of the emailrelay package you&#039;ll have a separate UCI option <code>spool_dir</code>
</p>

<p>
Also if you are using the “<abbr title="Post Office Protocol">POP</abbr> by name” option then you need to create a subfolders for each account
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Mail storage location&quot;,&quot;hid&quot;:&quot;mail_storage_location&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:9,&quot;range&quot;:&quot;7143-7787&quot;} -->
<h3 class="sectionedit10" id="reading_email_with_pop">Reading email with POP</h3>
<div class="level3">

<p>
If you are using email client (MUA) like Thunderbird, Outlook then you can fetch received mails by enabling <abbr title="Post Office Protocol">POP</abbr> protocol.
</p>

<p>
<code>option extra_cmdline &#039;--pop --pop-auth=/etc/pop.auth</code>&#039;. Also you must allow an access so set <code>option remote_clients=&#039;1</code>&#039;.
Then you must create the <code>/etc/pop.auth</code> file as described in <a href="https://emailrelay.sourceforge.net/index.html#userguide_md_Running_as_a_POP_server" class="urlextern" title="https://emailrelay.sourceforge.net/index.html#userguide_md_Running_as_a_POP_server" rel="ugc nofollow">https://emailrelay.sourceforge.net/index.html#userguide_md_Running_as_a_POP_server</a>.
Please note that if you are going to read emails from internet then you have to configure <abbr title="Transport Layer Security">TLS</abbr> for security.
See below how to open a port for internet.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Reading email with POP&quot;,&quot;hid&quot;:&quot;reading_email_with_pop&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:10,&quot;range&quot;:&quot;7788-8370&quot;} -->
<h2 class="sectionedit11" id="open_ports_for_internet_in_firewall">Open ports for internet in Firewall</h2>
<div class="level2">

<p>
This is a very bad idea for security and don&#039;t do this unless you know what are you doing.
Add to <code>/etc/config/firewall</code>:
</p>
<pre class="code">config rule
        option name &#039;Allow-WAN-SMTP&#039;
        option target &#039;ACCEPT&#039;
        option src &#039;wan&#039;
        option proto &#039;tcp&#039;
        option dest_port &#039;25&#039;
config rule
        option name &#039;Allow-WAN-SMTP-Submission&#039;
        option target &#039;ACCEPT&#039;
        option src &#039;wan&#039;
        option proto &#039;tcp&#039;
        option dest_port &#039;587&#039;  
config rule
        option name &#039;Allow-WAN-POP&#039;
        option target &#039;ACCEPT&#039;
        option src &#039;wan&#039;
        option proto &#039;tcp&#039;
        option dest_port &#039;110&#039;</pre>

<p>
You can add these rules with command line:
</p>
<pre class="code">uci add firewall rule
uci set firewall.wan_https_turris_rule=rule
uci set firewall.wan_https_turris_rule.name=&#039;Allow-WAN-SMTP&#039;
uci set firewall.wan_https_turris_rule.src=&#039;wan&#039;
uci set firewall.wan_https_turris_rule.proto=&#039;tcp&#039;
uci set firewall.wan_https_turris_rule.dest_port=&#039;25&#039;
uci set firewall.wan_https_turris_rule.target=&#039;ACCEPT&#039;

uci add firewall rule
uci set firewall.wan_https_turris_rule=rule
uci set firewall.wan_https_turris_rule.name=&#039;Allow-WAN-SMTP-Submission&#039;
uci set firewall.wan_https_turris_rule.src=&#039;wan&#039;
uci set firewall.wan_https_turris_rule.proto=&#039;tcp&#039;
uci set firewall.wan_https_turris_rule.dest_port=&#039;587&#039;
uci set firewall.wan_https_turris_rule.target=&#039;ACCEPT&#039;


uci add firewall rule
uci set firewall.wan_https_turris_rule=rule
uci set firewall.wan_https_turris_rule.name=&#039;Allow-WAN-POP&#039;
uci set firewall.wan_https_turris_rule.src=&#039;wan&#039;
uci set firewall.wan_https_turris_rule.proto=&#039;tcp&#039;
uci set firewall.wan_https_turris_rule.dest_port=&#039;110&#039;
uci set firewall.wan_https_turris_rule.target=&#039;ACCEPT&#039;

uci commit firewall
service firewall restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Open ports for internet in Firewall&quot;,&quot;hid&quot;:&quot;open_ports_for_internet_in_firewall&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:11,&quot;range&quot;:&quot;8371-&quot;} -->