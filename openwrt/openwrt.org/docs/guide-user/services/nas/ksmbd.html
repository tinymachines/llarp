
<h1 class="sectionedit1" id="ksmbd">ksmbd</h1>
<div class="level1">

<p>
<a href="https://docs.kernel.org/next/filesystems/smb/ksmbd.html" class="urlextern" title="https://docs.kernel.org/next/filesystems/smb/ksmbd.html" rel="ugc nofollow">KSMBD</a> is a server which implements SMB3 protocol in kernel space for sharing files over your network. It can be used as a <a href="/docs/guide-user/services/nas/cifs.server" class="wikilink1" title="docs:guide-user:services:nas:cifs.server" data-wiki-id="docs:guide-user:services:nas:cifs.server">Samba</a> alternative.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;ksmbd&quot;,&quot;hid&quot;:&quot;ksmbd&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-268&quot;} -->
<h2 class="sectionedit2" id="installation">Installation</h2>
<div class="level2">

<p>
To use ksmbd with <a href="/docs/guide-user/luci/start" class="wikilink1" title="docs:guide-user:luci:start" data-wiki-id="docs:guide-user:luci:start">LuCI</a> install <code>luci-app-ksmbd</code> which will automatically install the server and dependencies. To use ksmbd only on the command line install <code>ksmbd-server</code> and <code>ksmbd-tools</code>.
</p>

<p>
If you are sharing a USB or eSATA drive be sure to install your appropriate drivers and filesystem as outlined on the Samba <a href="/docs/guide-user/services/nas/cifs.server#prerequisites" class="wikilink1" title="docs:guide-user:services:nas:cifs.server" data-wiki-id="docs:guide-user:services:nas:cifs.server">prerequisites</a> section.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation&quot;,&quot;hid&quot;:&quot;installation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;269-716&quot;} -->
<h2 class="sectionedit3" id="configuration">Configuration</h2>
<div class="level2">

<p>
In LuCI, go to Services → Network Shares. Here you can assign an interface, name the shares, set a path to drive folder (e.g. /mnt/sda1), set allowed users, etc.
</p>

<p>
For command line, the UCI configuration file is located at <code>/etc/config/ksmbd</code>. Some options are hardcoded in the <code>/etc/ksmbd/ksmb.conf.template</code>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuration&quot;,&quot;hid&quot;:&quot;configuration&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;717-1059&quot;} -->
<h3 class="sectionedit4" id="example">Example</h3>
<div class="level3">

<p>
This example assumes you have a <a href="/docs/guide-user/storage/fstab" class="wikilink1" title="docs:guide-user:storage:fstab" data-wiki-id="docs:guide-user:storage:fstab">block device</a> attached on <code>/mnt/sda1</code> (typical Linux/OpenWrt mount points).<br/>

Multiple devices and shares may be added by providing a <code>config share</code> section with a name and mount location for each.
</p>

<p>
To access storage anonymously over the <abbr title="Local Area Network">LAN</abbr> using the <code>nobody/nogroup</code> user, first assign ownership for all files and directories at these mounting points to that user:
</p>
<pre class="code">chown -R nobody:nogroup /mnt/sda1</pre>

<p>
To access a shared storage over the <abbr title="Local Area Network">LAN</abbr> using a <strong>username</strong> and <strong>password</strong>, login via <abbr title="Secure Shell">SSH</abbr> and use the <code>ksmbd.adduser</code> command. The file <code>/etc/ksmbd/ksmbdpwd.db</code> will be created.
</p>

<p>
Be sure to enter that username in the Allowed users box in the LuCI Services → Network Shares page.
</p>
<pre class="code">root@OpenWrt:~# ksmbd.adduser --help
Usage: ksmbd.adduser [-v] [-P PWDDB] [-c CONF] [-a | -u | -d] [-p PWD] USER

If neither `-a&#039;, `-u&#039;, nor `-d&#039; is given, either add or update USER.
USER must be UTF-8 and [1, 48) bytes.
USER cannot contain colon (`:&#039;).

  -a, --add             add USER to user database
  -u, --update          update USER in user database
  -d, --delete          delete USER from user database
  -p, --password=PWD    use PWD as user password instead of prompting;
                        PWD must be UTF-8 and [0, 129) bytes
  -P, --pwddb=PWDDB     use PWDDB as user database instead of
                        `/etc/ksmbd/ksmbdpwd.db&#039;
  -C, --config=CONF     use CONF as configuration file instead of
                        `/etc/ksmbd/ksmbd.conf&#039;
  -v, --verbose         be verbose
  -V, --version         output version information and exit
  -h, --help            display this help and exit

See ksmbd.adduser(8) for more details.</pre>

<p>
Configure shares in LuCI → Services → Network Shares or by editing <code>/etc/config/ksmbd</code>:
</p>
<pre class="code">config globals
	option workgroup &#039;WORKGROUP&#039;
	option description &#039;Ksmbd on OpenWrt&#039;
	option interface &#039;lan&#039;

config share
	option name &#039;ssd&#039;
	option path &#039;/mnt/sda1&#039;
	option read_only &#039;no&#039;
	option guest_ok &#039;yes&#039;
	option create_mask &#039;0666&#039;
	option dir_mask &#039;0777&#039;</pre>

<p>
or the above config will look similar to this when allowed users have been added
</p>
<pre class="code">config globals
	option workgroup &#039;WORKGROUP&#039;
	option description &#039;Ksmbd on your_router_name&#039;

config share
	option name &#039;router-USB1&#039;
	option path &#039;/mnt/sda1&#039;
	option read_only &#039;no&#039;
	option guest_ok &#039;no&#039;
	option create_mask &#039;0666&#039;
	option dir_mask &#039;0777&#039;
	option users &#039;user1&#039;</pre>

<p>
On devices with sufficient RAM (&gt;256MB) performance can be improved, increase or comment out the preset buffer limits in LuCI → Services → Network Shares → Edit Template. Save and apply. <br/>

As of <a href="https://github.com/openwrt/packages/pull/25519" class="urlextern" title="https://github.com/openwrt/packages/pull/25519" rel="ugc nofollow">commit 25519</a> these values are now adjusted automatically when running main snapshot builds. <br/>

For versions 24.10 and below you can edit the template and simply comment out the 5 lines accordingly.
</p>
<pre class="code">	#smb2 max read = 512K
	#smb2 max write = 512K
	#smb2 max trans = 512K

	32 ~ 64MB RAM, set the value to 64K
	64 ~ 128MB, set it to 128KB
	128 ~ 256MB, set it to 1MB
	More than 256MB leave default size to 4MB

	With 64MB and 128MB it is better also to disable the read/write cache
	#cache read buffers = no
	#cache write buffers = no</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Example&quot;,&quot;hid&quot;:&quot;example&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;1060-4372&quot;} -->
<h2 class="sectionedit5" id="global_section">Global section</h2>
<div class="level2">

<p>
The <code>globals</code> section contains share-independent options.
</p>
<div class="table sectionedit6"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Name </th><th class="col1"> Type </th><th class="col2"> Required </th><th class="col3"> Default </th><th class="col4"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>workgroup</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <code>WORKGROUP</code> </td><td class="col4"> Workgroup name </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>description</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <code>Ksmbd on OpenWrt</code> </td><td class="col4"> Server description </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>allow_legacy_protocols</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <code>0</code> </td><td class="col4"> Enables support for <strong>insecure</strong> versions of SMB3 protocol </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:6,&quot;range&quot;:&quot;4461-4769&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Global section&quot;,&quot;hid&quot;:&quot;global_section&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:5,&quot;range&quot;:&quot;4373-4770&quot;} -->
<h2 class="sectionedit7" id="share_sections">Share sections</h2>
<div class="level2">
<div class="table sectionedit8"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Name </th><th class="col1"> Type </th><th class="col2"> Required </th><th class="col3"> Default </th><th class="col4"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>name</code> </td><td class="col1"> string </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Share name that will be displayed in a file browser </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>path</code> </td><td class="col1"> string </td><td class="col2"> yes </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Directory path </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>comment</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code>users</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <code>create_mask</code> </td><td class="col1"> number </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> <code>chmod</code> mask for created files </td>
	</tr>
	<tr class="row6">
		<td class="col0"> <code>dir_mask</code> </td><td class="col1"> number </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> <code>chmod</code> mask for created directories </td>
	</tr>
	<tr class="row7">
		<td class="col0"> <code>browseable</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row8">
		<td class="col0"> <code>read_only</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row9">
		<td class="col0"> <code>writeable</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row10">
		<td class="col0"> <code>guest_ok</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row11">
		<td class="col0"> <code>force_root</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row12">
		<td class="col0"> <code>write_list</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row13">
		<td class="col0"> <code>read_list</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row14">
		<td class="col0"> <code>users</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row15">
		<td class="col0"> <code>hide_dot_files</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row16">
		<td class="col0"> <code>veto_files</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row17">
		<td class="col0"> <code>inherit_owner</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row18">
		<td class="col0"> <code>force_create_mode</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row19">
		<td class="col0"> <code>force_directory_mode</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table1&quot;,&quot;secid&quot;:8,&quot;range&quot;:&quot;4798-5895&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Share sections&quot;,&quot;hid&quot;:&quot;share_sections&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:7,&quot;range&quot;:&quot;4771-&quot;} -->