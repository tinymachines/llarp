
<h1 class="sectionedit1" id="gitolite_user-restricted_git_hosting">Gitolite user-restricted git hosting</h1>
<div class="level1">

<p>
Gitolite is a user-restricted git hosting system after ssh authorized a user.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Gitolite user-restricted git hosting&quot;,&quot;hid&quot;:&quot;gitolite_user-restricted_git_hosting&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-131&quot;} -->
<h3 class="sectionedit2" id="a_typical_usage_scenariowhy_gitolite">A typical usage scenario / Why gitolite?</h3>
<div class="level3">

<p>
You and a colleague would like to develop something together, so you&#039;d usually like to have some kind of version control system (VCS). The things you&#039;re developing should be no open source software, so you can&#039;t use platforms like Github. You&#039;ll want to have some 24/7 server in order to let both of you pull and push source whenever you want though. So setting up a VCS on your OpenWrt router which is running 24/7 anyways would make sense.
</p>

<p>
Because your project isn&#039;t open source nobody else should be able to see it. So you need a way to encrypt data before it is sent to your OpenWrt box.
One idea would be to install an apache server including the svn module, but you&#039;ll run into two problems:
</p>
<ul>
<li class="level1"><div class="li"> The SVN module usually isn&#039;t compiled in the OpenWrt packages to save space.</div>
</li>
<li class="level1"><div class="li"> You&#039;ll need to encrypt the data using <abbr title="Secure Socket Layer">SSL</abbr>.</div>
</li>
</ul>

<p>
Setting up this solution isn&#039;t trivial.
</p>

<p>
This is the point where you&#039;ll like to set up a git repository using tools already packaged by the OpenWrt developers. Git usually offers two mechanisms for authentication and encryption:
</p>
<ul>
<li class="level1"><div class="li"> <abbr title="Secure Shell">SSH</abbr></div>
</li>
<li class="level1"><div class="li"> <abbr title="Hypertext Transfer Protocol Secure">HTTPS</abbr>-Basic</div>
</li>
</ul>

<p>
Getting a valid <abbr title="Hypertext Transfer Protocol Secure">HTTPS</abbr> certificate which won&#039;t make clients complain every time usually costs money, so you&#039;d like to use <abbr title="Secure Shell">SSH</abbr>. If you know your colleague very well you two could just use the root account on the OpenWrt box. You could log into that <abbr title="Secure Shell">SSH</abbr>-Account using git and would be done.
</p>

<p>
If you don&#039;t trust your colleague that much you&#039;d most likely just want them to be able to access the repositories R/W and nothing further should be possible. On many other UNIX boxes you could just create them another system account and point the login shell to the so called &#039;git-shell&#039;. If you set up your system this way, they would reach a shell which only allows them to issue git-commands after they have authenticated themself.
</p>

<p>
This would be the simpliest way to do authentification, but be carefull. Creating a new account for your colleage could also open doors on other services than ssh. In a worst case scenario a service configured to let any authenticated user connect by default could make the git-shell restrictions useless. Another problem you&#039;ll get is that multi-user setups are usually <a href="https://forum.openwrt.org/viewtopic.php?id=4409" class="urlextern" title="https://forum.openwrt.org/viewtopic.php?id=4409" rel="ugc nofollow">omitted on OpenWrt</a>. You just don&#039;t know if the guy who packaged for example your ftp service ever thought about the fact that there could be more users than root on an OpenWrt box. This is probably the point where you&#039;ll want to set up gitolite.
</p>

<p>
Gitolite acts after your ssh-authentification mechanism and will differ and authorize users by their <abbr title="Secure Shell">SSH</abbr>-public keys. It will in turn log them into different shells (Normal ash or gitolite) using ony one system account.
</p>

<p>
A typical git clone on your local box would look like that:
</p>
<pre class="code">git clone git@OpenWrt:repository</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;A typical usage scenario \/ Why gitolite?&quot;,&quot;hid&quot;:&quot;a_typical_usage_scenariowhy_gitolite&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;132-2990&quot;} -->
<h3 class="sectionedit3" id="prerequisites">Prerequisites</h3>
<div class="level3">

<p>
openssh-server
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Prerequisites&quot;,&quot;hid&quot;:&quot;prerequisites&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:3,&quot;range&quot;:&quot;2991-3029&quot;} -->
<h2 class="sectionedit4" id="installation_and_setup_for_18060_and_later">Installation and Setup for 18.06.0 and later</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation and Setup for 18.06.0 and later&quot;,&quot;hid&quot;:&quot;installation_and_setup_for_18060_and_later&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:4,&quot;range&quot;:&quot;3030-3086&quot;} -->
<h3 class="sectionedit5" id="sizestorage">Size/Storage</h3>
<div class="level3">

<p>
You need enough space to install gitolite (only requires cli).  A larger than 8MB flash is required for a pure CLI install of just gitolite plus storage drivers for whatever external storage you choose (assuming your flash is not multi-<abbr title="Gigabyte">GB</abbr>).  Alternatively install using <a href="/docs/guide-user/additional-software/extroot_configuration" class="wikilink1" title="docs:guide-user:additional-software:extroot_configuration" data-wiki-id="docs:guide-user:additional-software:extroot_configuration">extroot</a>.
</p>

<p>
OpenWrt&#039;s gitolite package expects that <code>/srv/git</code> is where your repos will be hosted (and will be a UNIX home directory of the <code>git</code> user).  Mount your repo storage on <code>/srv/git</code> or make a symlink to a location on your storage which is mounted elsewhere.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Size\/Storage&quot;,&quot;hid&quot;:&quot;sizestorage&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:5,&quot;range&quot;:&quot;3087-3715&quot;} -->
<h3 class="sectionedit6" id="access">Access</h3>
<div class="level3">

<p>
Once you&#039;ve booted into your device, set dropbear to run from a port other than port 22 (alternatively in the steps below configure openssh to run on a port other than 22 and continue to use port 22 / dropbear for device admin access).
</p>

<p>
e.g.
</p>
<pre class="code">config dropbear
        option Port &#039;22222&#039;
        ... (other option you had before)</pre>

<p>
Then restart dropbear (future logins will need to be done using an <abbr title="Secure Shell">SSH</abbr> syntax such as <code>ssh -p 2222 root@192.168.1.1</code>).
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Access&quot;,&quot;hid&quot;:&quot;access&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:6,&quot;range&quot;:&quot;3716-4200&quot;} -->
<h3 class="sectionedit7" id="copy_the_gitolite_admin_user_s_ssh_key_to_your_device">Copy the gitolite admin user&#039;s SSH key to your device</h3>
<div class="level3">

<p>
Assuming you changed dropbear as above, from computer from which you are using <abbr title="Secure Shell">SSH</abbr> into the deivice, do:
</p>

<p>
<code>scp -P 2222 /path/to/admin/id_rsa.pub root@192.168.1.1:admin.pub</code>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Copy the gitolite admin user&#039;s SSH key to your device&quot;,&quot;hid&quot;:&quot;copy_the_gitolite_admin_user_s_ssh_key_to_your_device&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:7,&quot;range&quot;:&quot;4201-4441&quot;} -->
<h3 class="sectionedit8" id="the_actual_install">The actual install</h3>
<div class="level3">
<ol>
<li class="level1"><div class="li"> <code>opkg update &amp;&amp; opkg install gitolite</code></div>
</li>
<li class="level1"><div class="li"> <code>mkdir -p /srv/git/.ssh</code></div>
</li>
<li class="level1"><div class="li"> <code>chmod 700 /srv/git/.ssh</code></div>
</li>
<li class="level1"><div class="li"> <code>cp /etc/dropbear/authorized_keys /srv/git/.ssh/authorized_keys</code></div>
</li>
<li class="level1"><div class="li"> <code>chmod 600 /srv/git/.ssh/authorized_keys</code></div>
</li>
<li class="level1"><div class="li"> <code>cp /root/admin.pub /srv/git</code></div>
</li>
<li class="level1"><div class="li"> <code>chown -R git:git /srv/git</code></div>
</li>
<li class="level1"><div class="li">  From the host from which you are accessing the gitolite device: <code>ssh git@192.168.1.1 “gitolite setup -pk admin.pub”</code>  </div>
</li>
<li class="level1 node"><div class="li"> <strong>IFF your admin.pub is the same as a key in /etc/dropbear/authorized_keys</strong>:</div>
<ol>
<li class="level2"><div class="li"> <code>ssh git@192.168.1.1.</code></div>
</li>
<li class="level2"><div class="li"> <code>vi /srv/git/.ssh/authorized_keys</code></div>
</li>
<li class="level2"><div class="li"> Use the &#039;j&#039; and &#039;k&#039; keys to navigate to the offending line.</div>
</li>
<li class="level2"><div class="li"> Press <code>dd</code>, then press the Esc or Escape key followed by <code>:wq</code>.</div>
</li>
<li class="level2"><div class="li"> <code>exit</code>.</div>
</li>
</ol>
</li>
<li class="level1"><div class="li"> Now if you <code>ssh git@192.168.1.1</code> you should get a list of repos readable (and/or writable) by the admin user.</div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;The actual install&quot;,&quot;hid&quot;:&quot;the_actual_install&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:8,&quot;range&quot;:&quot;4442-5323&quot;} -->
<h2 class="sectionedit9" id="installation_and_setup_before_18060">Installation and Setup before 18.06.0</h2>
<div class="level2">

<p>
This tutorial will show you how to setup the OpenWrt default <abbr title="Secure Shell">SSH</abbr> deamon dropbear to work together with gitolite.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Installation and Setup before 18.06.0&quot;,&quot;hid&quot;:&quot;installation_and_setup_before_18060&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:9,&quot;range&quot;:&quot;5324-5489&quot;} -->
<h3 class="sectionedit10" id="dependencies">Dependencies</h3>
<div class="level3">

<p>
You&#039;ll most likely want to run your OpenWrt box from a USB memory key using <a href="/docs/guide-user/additional-software/extroot_configuration" class="wikilink1" title="docs:guide-user:additional-software:extroot_configuration" data-wiki-id="docs:guide-user:additional-software:extroot_configuration">extroot</a>. Just installing the dependencies could make small devices run out of space and you haven&#039;t even stored any repository data yet.
</p>

<p>
Gitolite was written in perl. This commands should install all required packages to run the application:
</p>
<pre class="code">opkg update
opkg install git perl perlbase-essential perlbase-getopt perlbase-findbin perlbase-cwd perlbase-config perlbase-file perlbase-data perlbase-bytes perlbase-xsloader openssh-keygen perlbase-hostname perlbase-fcntl perlbase-io perlbase-symbol perlbase-selectsaver perlbase-errno perlbase-base</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Dependencies&quot;,&quot;hid&quot;:&quot;dependencies&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:10,&quot;range&quot;:&quot;5490-6212&quot;} -->
<h3 class="sectionedit11" id="backing_up_the_old_dropbear_configuration">Backing up the old dropbear configuration</h3>
<div class="level3">

<p>
Make sure your /etc/config/dropbear loos like this one, so normal password-based login will work as backup if something goes wrong:
</p>
<pre class="code">config dropbear
        option Port &#039;22&#039;
        option PasswordAuth &#039;on&#039;</pre>

<p>
Backup your authorized_keys file if it is existing:
</p>
<pre class="code">cp -p /etc/dropbear/authorized_keys /etc/dropbear/authorized_keys_backup</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Backing up the old dropbear configuration&quot;,&quot;hid&quot;:&quot;backing_up_the_old_dropbear_configuration&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:11,&quot;range&quot;:&quot;6213-6628&quot;} -->
<h3 class="sectionedit12" id="downloading_and_installing_gitolite">Downloading and installing gitolite</h3>
<div class="level3">

<p>
Download gitolite to your homedirectory:
</p>
<pre class="code">cd /root
git clone git://github.com/sitaramc/gitolite</pre>

<p>
Install a link to gitolite executable into /usr/bin... The gitolite developers provide a simple way for doing that in their documentation:
</p>
<pre class="code">cd /root/
gitolite/install -ln /usr/bin</pre>

<p>
Create the gitolite logfile directory:
</p>
<pre class="code">mkdir /root/.gitolite
mkdir /root/.gitolite/logs</pre>

<p>
Copy your ssh public key from your machine to your OpenWrt box. From your local machine issue:
</p>
<pre class="code">scp ~/.ssh/id_rsa.pub root@openwrthostname:/root/</pre>

<p>
Back again on your openwrt box, rename the file from id_rsa.pub to username.pub with username as the name of your useraccount on your local machine which generated the public key. This is important because gitolite will set up the default configuration with this username. An example with didi1357 as the account on your local machine:
</p>
<pre class="code">cd /root/
mv id_rsa.pub didi1357.pub</pre>

<p>
Setup gitolite:
</p>
<pre class="code">gitolite setup -pk didi1357.pub</pre>

<p>
Now you can delete your public key file. Gitolite already kopied it to it&#039;s keydir:
</p>
<pre class="code">rm didi1357.pub</pre>

<p>
Gitolite sets up and expects the authorized_keys file for the root account in /root/.ssh/, but Dropbear and LuCI expect this file to be in in /etc/dropbear/
</p>

<p>
This issue can be solved by creating a symbolic link to /root/.ssh/authorized_keys in /etc/dropbear/authorized_keys
</p>
<pre class="code">rm /etc/dropbear/authorized_keys
ln -s /root/.ssh/authorized_keys /etc/dropbear/authorized_keys</pre>

<p>
Now you can append the old keys from your authorized_keys_backup to the authorized_keys file, but pay attention to not having a key listed twice in that file. If you&#039;re using linux and would still want to use public key authentication you could create a public key for your local machines root account and use your usual accounts public key for gitolite.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Downloading and installing gitolite&quot;,&quot;hid&quot;:&quot;downloading_and_installing_gitolite&quot;,&quot;codeblockOffset&quot;:5,&quot;secid&quot;:12,&quot;range&quot;:&quot;6629-8557&quot;} -->
<h2 class="sectionedit13" id="administrating_gitolite">Administrating gitolite</h2>
<div class="level2">

<p>
Administrating gitolite usually works by cloning the gitolite-admin repository to your local machine, making changes to it and pushing them back to the openwrt box. From your local machine issue:
</p>
<pre class="code">git clone root@OpenWRTBox:gitolite-admin</pre>

<p>
The syntax of this repository can be looked up at: <a href="http://gitolite.com/gitolite/basic-admin.html" class="urlextern" title="http://gitolite.com/gitolite/basic-admin.html" rel="ugc nofollow">http://gitolite.com/gitolite/basic-admin.html</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Administrating gitolite&quot;,&quot;hid&quot;:&quot;administrating_gitolite&quot;,&quot;codeblockOffset&quot;:13,&quot;secid&quot;:13,&quot;range&quot;:&quot;8558-&quot;} -->