<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:outdated&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:1,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:outdated" id="plugin_include__meta__infobox__outdated">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_outdated wrap_center plugin_wrap" style="width: 70%;">
<p>
<strong>Outdated Information!</strong><br/>

This article contains information that is outdated or no longer valid. You can edit this page to update it. 
</p>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:outdated&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --></div>

<h1 class="sectionedit5" id="miniupnpd">miniupnpd</h1>
<div class="level1">

<p>
MiniUPnPd is a lightweight implementation of a UPnP IGD daemon. More info at <a href="http://miniupnp.free.fr" class="urlextern" title="http://miniupnp.free.fr" rel="ugc nofollow">http://miniupnp.free.fr</a>
</p>

<p>
See also <a href="/docs/guide-user/firewall/upnp/upnp_setup" class="wikilink1" title="docs:guide-user:firewall:upnp:upnp_setup" data-wiki-id="docs:guide-user:firewall:upnp:upnp_setup">upnp_setup</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;miniupnpd&quot;,&quot;hid&quot;:&quot;miniupnpd&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;61-242&quot;} -->
<h2 class="sectionedit6" id="default">Default</h2>
<div class="level2">
<pre class="code">config upnpd config
	option enabled		0
	option enable_natpmp	1
	option enable_upnp	1
	option secure_mode	1
	option log_output	0
	option download		1024
	option upload		512
#by default, looked up dynamically from ubus
#	option external_iface	wan
	option internal_iface	lan
	option port		5000
	option upnp_lease_file	/var/run/miniupnpd.leases
	option igdv1		1

config perm_rule
	option action		allow
	option ext_ports	1024-65535
	option int_addr		0.0.0.0/0	# Does not override secure_mode
	option int_ports	1024-65535
	option comment		&quot;Allow high ports&quot;

config perm_rule
	option action		deny
	option ext_ports	0-65535
	option int_addr		0.0.0.0/0
	option int_ports	0-65535
	option comment		&quot;Default deny&quot;</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Default&quot;,&quot;hid&quot;:&quot;default&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;243-981&quot;} -->
<h2 class="sectionedit7" id="config_upnpd_config">config upnpd &#039;config&#039;</h2>
<div class="level2">
<div class="table sectionedit8"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Name </th><th class="col1"> Type </th><th class="col2"> Required </th><th class="col3"> Default </th><th class="col4"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>clean_ruleset_threshold</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Minimum number of redirections before clearing rules table of old (active) redirections.  Code default is 20. </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>clean_ruleset_interval</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Number of seconds before cleaning redirections.  Code default is 600 which is sane. </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>config_file</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Use the specified configuration file if present.  If specified the uci options are not used, except that external_iface determines the iptables table used. </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code>download</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Bandwidth available for traffic coming in from the external interface in kilobytes per second.  Note that this only information given to clients, it doesn&#039;t control the speed. </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <code>upload</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Bandwidth available for traffic out the external interface in kilobytes per second. Note that this only information given to clients, it doesn&#039;t control the speed. </td>
	</tr>
	<tr class="row6">
		<td class="col0"> <code>enable_natpmp</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <code>1</code> </td><td class="col4"> Enable <abbr title="Network Address Translation">NAT</abbr>-<a href="https://tools.ietf.org/html/rfc6886" class="urlextern" title="https://tools.ietf.org/html/rfc6886" rel="ugc nofollow">PMP</a> and <a href="https://tools.ietf.org/html/rfc6887" class="urlextern" title="https://tools.ietf.org/html/rfc6887" rel="ugc nofollow">PCP</a>. </td>
	</tr>
	<tr class="row7">
		<td class="col0"> <code>enable_upnp</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <code>1</code> </td><td class="col4"> Enable UPnP. </td>
	</tr>
	<tr class="row8">
		<td class="col0"> <code>external_iface</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(auto)</em> </td><td class="col4"> External interface. The default is to autodetect the first interface with a default route, which usually is <code>wan</code>. </td>
	</tr>
	<tr class="row9">
		<td class="col0"> <code>external_iface6</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(auto)</em> </td><td class="col4"> External ipv6 interface. The default is to autodetect the first interface with a default route, which usually is <code>wan6</code>. </td>
	</tr>
	<tr class="row10">
		<td class="col0"> <code>external_ip</code> </td><td class="col1"> ipv4addr </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Manually specified external <abbr title="Internet Protocol">IP</abbr> - if not specified the default ipv4 address of the external interface is used. Conflicts with <code>use_stun</code> option. </td>
	</tr>
	<tr class="row11">
		<td class="col0"><code>internal_iface</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <code>lan</code> </td><td class="col4"> Space separated list of internal interfaces (lans) </td>
	</tr>
	<tr class="row12">
		<td class="col0"> <code>log_output</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <code>0</code> </td><td class="col4"> Log messages normally sent to stderr/out to syslog. </td>
	</tr>
	<tr class="row13">
		<td class="col0"> <code>model_number</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Specify model number for XML Root Desc. </td>
	</tr>
	<tr class="row14">
		<td class="col0"> <code>notify_interval</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> </td>
	</tr>
	<tr class="row15">
		<td class="col0"> <code>port</code> </td><td class="col1"> integer (or string &#039;auto&#039;) </td><td class="col2"> no </td><td class="col3"> <code>5000</code> </td><td class="col4"> Port to listen for <abbr title="Hypertext Transfer Protocol">HTTP</abbr> requests.  If set to &#039;auto&#039; a random port is used. </td>
	</tr>
	<tr class="row16">
		<td class="col0"> <code>presentation_url</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Presentation url for the Root Desc.  If not specified the first <abbr title="Internet Protocol">IP</abbr> in the first internal interface is used. </td>
	</tr>
	<tr class="row17">
		<td class="col0"> <code>secure_mode</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <code>1</code> </td><td class="col4"> Secure mode; client can only redirect an incoming port to the client itself (same <abbr title="Internet Protocol">IP</abbr> as the request comes from). </td>
	</tr>
	<tr class="row18">
		<td class="col0"> <code>serial_number</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Specify serial number for XML Root Desc. </td>
	</tr>
	<tr class="row19">
		<td class="col0"> <code>use_stun</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <code>0</code> </td><td class="col4"> Use the STUN server to resolve an external <abbr title="Internet Protocol">IP</abbr>.  Conflicts with <code>external_ip</code> option. </td>
	</tr>
	<tr class="row20">
		<td class="col0"> <code>stun_host</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> The STUN server to use e.g. <code>stun.cloudflare.com</code> or <code>stun2.l.google.com</code>. </td>
	</tr>
	<tr class="row21">
		<td class="col0"> <code>stun_port</code> </td><td class="col1"> integer </td><td class="col2"> no </td><td class="col3"> <code>3478</code> </td><td class="col4"> The STUN server port. </td>
	</tr>
	<tr class="row22">
		<td class="col0"> <code>upnp_lease_file</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>(none)</em> </td><td class="col4"> Store active UPnP redirects in a lease file (specified), like <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> leases. </td>
	</tr>
	<tr class="row23">
		<td class="col0"> <code>system_uptime</code> </td><td class="col1"> boolean </td><td class="col2"> no </td><td class="col3"> <code>1</code> </td><td class="col4"> Use system uptime as UPnP uptime instead of miniupnpd daemon uptime. </td>
	</tr>
	<tr class="row24">
		<td class="col0"> <code>uuid</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <em>UUID autogenerated on first launch of miniupnpd</em> </td><td class="col4"> UUID for UPnP IGD.  If none specified one will be autogenerated and added to the config file.  &#039;nocli&#039; means a non-unique UUID from the code will be used (previous default behaviour). </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:8,&quot;range&quot;:&quot;1016-4493&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;config upnpd &#039;config&#039;&quot;,&quot;hid&quot;:&quot;config_upnpd_config&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:7,&quot;range&quot;:&quot;982-4494&quot;} -->
<h2 class="sectionedit9" id="config_perm_rule">config &#039;perm_rule&#039;</h2>
<div class="level2">

<p>
These rules define what holes may be opened by UPnP or <abbr title="Network Address Translation">NAT</abbr>-PMP clients on the internal interfaces.  Note that if secure_mode is set above, then a client may only open a hole to itself (the same <abbr title="Internet Protocol">IP</abbr> as it makes the UPnP request from).  Rules are applied in the order they appear in the configuration file (so the above deny rule before anything else will block all UPnP actions).
</p>
<div class="table sectionedit10"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Name </th><th class="col1"> Type </th><th class="col2"> Required </th><th class="col3"> Default </th><th class="col4"> Description </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> <code>action</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <code>deny</code> </td><td class="col4"> One of <code>allow</code> or <code>deny</code>.  Allow or deny the redirection(s) described by this rule. </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <code>ext_ports</code> </td><td class="col1"> portrange </td><td class="col2"> no </td><td class="col3"> <code>0-65535</code> </td><td class="col4"> Range of ports on the external side (incoming) for this rule.  Can be x, x-y, or x:y. </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <code>int_addr</code> </td><td class="col1"> cidr </td><td class="col2"> no </td><td class="col3"> <code>0.0.0.0/0</code> </td><td class="col4"> CIDR of address or addresses to which the redirection may be directed.   Must be of the form n.n.n.n/n even for single IPs.  Note that doesn&#039;t allow redirections that aren&#039;t allowed because of secure_mode. </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <code>int_ports</code> </td><td class="col1"> portrange </td><td class="col2"> no </td><td class="col3"> <code>0-65535</code> </td><td class="col4"> Range of ports on the internal side (destination) for this rule.  Can be x, x-y, or x:y. </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <code>comment</code> </td><td class="col1"> string </td><td class="col2"> no </td><td class="col3"> <code></code> </td><td class="col4"> Comment to show in luci-app-upnp </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table1&quot;,&quot;secid&quot;:10,&quot;range&quot;:&quot;4906-5688&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;config &#039;perm_rule&#039;&quot;,&quot;hid&quot;:&quot;config_perm_rule&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:9,&quot;range&quot;:&quot;4495-5689&quot;} -->
<h2 class="sectionedit11" id="pcpnat-pmp">PCP/NAT-PMP</h2>
<div class="level2">

<p>
To enable <abbr title="Network Address Translation">NAT</abbr>-PMP and disable the UPnP edit the <code>/etc/config/upnpd</code> file:
</p>
<pre class="code">option &#039;enable_natpmp&#039; &#039;1&#039;
option &#039;enable_upnp&#039; &#039;0&#039;</pre>

<p>
Or you can do this with following command:
</p>
<pre class="code bash">uci <span class="kw1">set</span> upnpd.config.enable_natpmp=<span class="nu0">1</span>
uci <span class="kw1">set</span> upnpd.config.enable_upnp=<span class="nu0">0</span>
<span class="sy0">/</span>etc<span class="sy0">/</span>init.d<span class="sy0">/</span>miniupnpd restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;PCP\/NAT-PMP&quot;,&quot;hid&quot;:&quot;pcpnat-pmp&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:11,&quot;range&quot;:&quot;5690-6027&quot;} -->
<h2 class="sectionedit12" id="notes">Notes</h2>
<div class="level2">

<p>
After installing and enabling, do not forget to restart the firewall.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Notes&quot;,&quot;hid&quot;:&quot;notes&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:12,&quot;range&quot;:&quot;6028-6117&quot;} -->
<h2 class="sectionedit13" id="security">Security</h2>
<div class="level2">

<p>
CAUTION: mixing up <abbr title="Wide Area Network">WAN</abbr> and <abbr title="Local Area Network">LAN</abbr> interfaces may introduce <a href="https://community.rapid7.com/community/metasploit/blog/2014/10/21/r7-2014-17-nat-pmp-implementation-and-configuration-vulnerabilities" class="urlextern" title="https://community.rapid7.com/community/metasploit/blog/2014/10/21/r7-2014-17-nat-pmp-implementation-and-configuration-vulnerabilities" rel="ugc nofollow">security risks</a>! See also <a href="https://www.kb.cert.org/vuls/id/184540" class="urlextern" title="https://www.kb.cert.org/vuls/id/184540" rel="ugc nofollow">Incorrect implementation of NAT-PMP in multiple devices</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Security&quot;,&quot;hid&quot;:&quot;security&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:13,&quot;range&quot;:&quot;6118-&quot;} -->