**Outdated Information!**  
This article contains information that is outdated or no longer valid. You can edit this page to update it.

# Universal Plug and Play and PCP/NAT-PMP on OpenWrt

[UPnP (Universal Plug and Play)](https://en.wikipedia.org/wiki/Internet_Gateway_Device_Protocol "https://en.wikipedia.org/wiki/Internet_Gateway_Device_Protocol") is a protocol that enables programs running on a host to automatically configure port forwardings on their NAT-Router. UPnP basically allows a program to make the router to open necessary ports, without any intervention from the user, without making any check. For this reason, there is a security risk associated with enabling UPnP on your router: technically a worm or malware program could use this function to compromise security for the entire LAN.

Thus, it is recommended to set up port forwarding manually whenever possible, and leave UPnP disabled. However, in some cases dynamic port forwarding is required and manual port forwarding becomes impractical, leaving the user with no other option than to enable UPnP.

[NAT-PMP](https://en.wikipedia.org/wiki/NAT-PMP "https://en.wikipedia.org/wiki/NAT-PMP") and its newer version [PCP](https://en.wikipedia.org/wiki/Port_Control_Protocol "https://en.wikipedia.org/wiki/Port_Control_Protocol") is a simpler binary protocol similar to UPnP, that is currently an IETF standard, and a number of Windows and Linux applications support it. It was originally developed by Apple for their routers but didn't receive wide adoption.

## Security Concerns

![Important!](/_media/meta/icons/tango/48px-emblem-important.svg.png "Important!") CAUTION: mixing up WAN and LAN interfaces may introduce [security risks](https://community.rapid7.com/community/metasploit/blog/2014/10/21/r7-2014-17-nat-pmp-implementation-and-configuration-vulnerabilities "https://community.rapid7.com/community/metasploit/blog/2014/10/21/r7-2014-17-nat-pmp-implementation-and-configuration-vulnerabilities")! See also [Incorrect implementation of NAT-PMP in multiple devices](https://www.kb.cert.org/vuls/id/184540 "https://www.kb.cert.org/vuls/id/184540").

miniupnpd in OpenWrt 10 Backfire is vulnerable to remote code execution [CVE-2013-0230](http://www.cvedetails.com/cve/CVE-2013-0230 "http://www.cvedetails.com/cve/CVE-2013-0230"). It is strongly recommended not to use UPnP on this OpenWRT version.

## Setting up UPnP in OpenWrt

The repository for OpenWrt contains `miniupnpd` to provide UPnP support, plus the (not mandatory) `luci-app-upnp` containing the webUI parts. It is configured in `/etc/config/upnpd`.

Once the `miniupnpd` is installed, it may be necessary to take an addition step to enable it. Navigate to `Services` &gt; `UPnP`, and ensure that the `Start service` option is enabled. If it is not, enable it, and click on `Save & Apply`.

You can do this from a command line:

```
uci set upnpd.config.enabled=1
uci commit
/etc/init.d/miniupnpd restart
```

### Troubleshooting

Read logs with `logread -e miniupnpd`.

You can enable verbose logs:

```
 
uci set upnpd.config.log_output=1
uci commit
/etc/init.d/miniupnpd restart
```

Use [miniupnpc](https://manpages.debian.org/unstable/miniupnpc/upnpc.1.html "https://manpages.debian.org/unstable/miniupnpc/upnpc.1.html") to open a port with UPnP. Or use [natpmpc](https://manpages.debian.org/bookworm/natpmpc/natpmpc.1.html "https://manpages.debian.org/bookworm/natpmpc/natpmpc.1.html") for NAT-PMP/PCP.

The GUI tool [UPnP Router Control](https://gitlab.gnome.org/DnaX/upnp-router-control "https://gitlab.gnome.org/DnaX/upnp-router-control") allows viewing network usage and currently open ports.

Some apps like Transmission allows opening a port with both UPnP and NAT-PMP/PCP. Internally, it uses `libminiupnpc` and `libnatpmp` libraries from the `miniupnpd` author.

#### Checking if UPnP is working

Click on `Status` &gt; `Firewall`. If UPnP has been properly enabled, the chains `zone_wan_forward` and `zone_wan_prerouting` will both contain an entry named `miniupnpd`. Additionally if you have any UPnP application working, you will be able to find their port mappings. Please note if you have just enabled UPnP, your application may need to be restarted, in order to reconfigure the firewall.

#### Checking if NAT-PMP is working

From a shell, issue the command:

```
logread -e "\-PMP"
```

If NAT-PMP is enabled, you'll see something like this:

```
Listening for NAT-PMP/PCP traffic on port 5351
```

Otherwise, you will see no message.

## Security considerations

As UPnP provides no authentication mechanisms, it is commonly regarded as one giant security hole. A great deal of concern was also generated by the discovery of a buffer overflow vulnerability in the UPnP stack of Windows XP in 2001, which made it possible to obtain SYSTEM level access, and some institutions recommended disabling it altogether. For an historical perspective, see this page from [Gibson Research](http://www.grc.com/unpnp/unpnp.htm "http://www.grc.com/unpnp/unpnp.htm").

It is also been speculated that the design flaws in UPnP would lead to development of a new class of attacks which relied on UPnP. More information about this and possible exploits can been seen in this talk: [Martin Zeiser: UPnP - Universal Pwn n Play](https://www.youtube.com/watch?v=rseMaljMcBY "https://www.youtube.com/watch?v=rseMaljMcBY").

### Check if a router has the insecure UPnP

You can check your device with [Metasploit](https://www.metasploit.com/ "https://www.metasploit.com/"):

```
msfconsole
msf>
msf > use auxiliary/scanner/upnp/ssdp_msearch
msf auxiliary(ssdp_msearch) > set RHOSTS 192.168.0.0/24
msf auxiliary(ssdp_msearch) > run
```

Look for something like:

```
[*] 192.168.0.9:1900 SSDP Net-OS 5.xx UPnP/1.0 | 192.168.0.9:3278/etc/linuxigd/gatedesc.xml
[+] 192.168.0.254:1900 SSDP miniupnpd/1.0 UPnP/1.0 | vulns:2 (CVE-2013-0229, CVE-2013-0230)
```
