<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:outdated&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:1,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:outdated" id="plugin_include__meta__infobox__outdated">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_outdated wrap_center plugin_wrap" style="width: 70%;">
<p>
<strong>Outdated Information!</strong><br/>

This article contains information that is outdated or no longer valid. You can edit this page to update it. 
</p>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:outdated&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --></div>

<h1 class="sectionedit5" id="universal_plug_and_play_and_pcpnat-pmp_on_openwrt">Universal Plug and Play and PCP/NAT-PMP on OpenWrt</h1>
<div class="level1">

<p>
<a href="https://en.wikipedia.org/wiki/Internet_Gateway_Device_Protocol" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Internet_Gateway_Device_Protocol">UPnP (Universal Plug and Play)</a>  is a protocol that enables programs running on a host to automatically configure port forwardings on their <abbr title="Network Address Translation">NAT</abbr>-Router. UPnP basically allows a program to make the router to open necessary ports, without any intervention from the user, without making any check. For this reason, there is a security risk associated with enabling UPnP on your router: technically a worm or malware program could use this function to compromise security for the entire <abbr title="Local Area Network">LAN</abbr>.
</p>

<p>
Thus, it is recommended to set up port forwarding manually whenever possible, and leave UPnP disabled. However, in some cases dynamic port forwarding is required and manual port forwarding becomes impractical, leaving the user with no other option than to enable UPnP.
</p>

<p>
<a href="https://en.wikipedia.org/wiki/NAT-PMP" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/NAT-PMP">NAT-PMP</a> and its newer version <a href="https://en.wikipedia.org/wiki/Port_Control_Protocol" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Port_Control_Protocol">PCP</a> is a simpler binary protocol similar to UPnP, that is currently an IETF standard, and a number of Windows and Linux applications support it. It was originally developed by Apple for their routers but didn&#039;t receive wide adoption. 
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Universal Plug and Play and PCP\/NAT-PMP on OpenWrt&quot;,&quot;hid&quot;:&quot;universal_plug_and_play_and_pcpnat-pmp_on_openwrt&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;61-1233&quot;} -->
<h2 class="sectionedit6" id="security_concerns">Security Concerns</h2>
<div class="level2">

<p>
<img src="/_media/meta/icons/tango/48px-emblem-important.svg.png" class="medialeft" loading="lazy" title="Important!" alt="Important!" /> CAUTION: mixing up <abbr title="Wide Area Network">WAN</abbr> and <abbr title="Local Area Network">LAN</abbr> interfaces may introduce <a href="https://community.rapid7.com/community/metasploit/blog/2014/10/21/r7-2014-17-nat-pmp-implementation-and-configuration-vulnerabilities" class="urlextern" title="https://community.rapid7.com/community/metasploit/blog/2014/10/21/r7-2014-17-nat-pmp-implementation-and-configuration-vulnerabilities" rel="ugc nofollow">security risks</a>! See also <a href="https://www.kb.cert.org/vuls/id/184540" class="urlextern" title="https://www.kb.cert.org/vuls/id/184540" rel="ugc nofollow">Incorrect implementation of NAT-PMP in multiple devices</a>.
</p>

<p>
miniupnpd in OpenWrt 10 Backfire is vulnerable to remote code execution <a href="http://www.cvedetails.com/cve/CVE-2013-0230" class="urlextern" title="http://www.cvedetails.com/cve/CVE-2013-0230" rel="ugc nofollow">CVE-2013-0230</a>. It is strongly recommended not to use UPnP on this OpenWRT version.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Security Concerns&quot;,&quot;hid&quot;:&quot;security_concerns&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;1234-1859&quot;} -->
<h2 class="sectionedit7" id="setting_up_upnp_in_openwrt">Setting up UPnP in OpenWrt</h2>
<div class="level2">

<p>
The repository for OpenWrt contains <code>miniupnpd</code> to provide UPnP support, plus the (not mandatory) <code>luci-app-upnp</code> containing the webUI parts. It is configured in <code><a href="/docs/guide-user/firewall/upnp/miniupnpd" class="wikilink1" title="docs:guide-user:firewall:upnp:miniupnpd" data-wiki-id="docs:guide-user:firewall:upnp:miniupnpd">/etc/config/upnpd</a></code>.
</p>

<p>
Once the <code>miniupnpd</code> is installed, it may be necessary to take an addition step to enable it.
Navigate to <code>Services</code> &gt; <code>UPnP</code>, and ensure that the <code>Start service</code> option is enabled.
If it is not, enable it, and click on <code>Save &amp; Apply</code>.
</p>

<p>
You can do this from a command line:
</p>
<pre class="code">uci set upnpd.config.enabled=1
uci commit
/etc/init.d/miniupnpd restart</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Setting up UPnP in OpenWrt&quot;,&quot;hid&quot;:&quot;setting_up_upnp_in_openwrt&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;1860-2505&quot;} -->
<h3 class="sectionedit8" id="troubleshooting">Troubleshooting</h3>
<div class="level3">

<p>
Read logs with <code>logread -e miniupnpd</code>.
</p>

<p>
You can enable verbose logs:
</p>
<pre class="code"> 
uci set upnpd.config.log_output=1
uci commit
/etc/init.d/miniupnpd restart</pre>

<p>
Use <a href="https://manpages.debian.org/unstable/miniupnpc/upnpc.1.html" class="urlextern" title="https://manpages.debian.org/unstable/miniupnpc/upnpc.1.html" rel="ugc nofollow">miniupnpc</a> to open a port with UPnP.
Or use <a href="https://manpages.debian.org/bookworm/natpmpc/natpmpc.1.html" class="urlextern" title="https://manpages.debian.org/bookworm/natpmpc/natpmpc.1.html" rel="ugc nofollow">natpmpc</a> for <abbr title="Network Address Translation">NAT</abbr>-PMP/PCP.
</p>

<p>
The <abbr title="Graphical User Interface">GUI</abbr> tool <a href="https://gitlab.gnome.org/DnaX/upnp-router-control" class="urlextern" title="https://gitlab.gnome.org/DnaX/upnp-router-control" rel="ugc nofollow">UPnP Router Control</a> allows viewing network usage and currently open ports.
</p>

<p>
Some apps like Transmission allows opening a port with both UPnP and <abbr title="Network Address Translation">NAT</abbr>-PMP/PCP. Internally, it uses <code>libminiupnpc</code> and <code>libnatpmp</code> libraries from the <code>miniupnpd</code> author.
</p>

</div>

<h4 id="checking_if_upnp_is_working">Checking if UPnP is working</h4>
<div class="level4">

<p>
Click on <code>Status</code> &gt; <code>Firewall</code>. If UPnP has been properly enabled, the chains <code>zone_wan_forward</code> and <code>zone_wan_prerouting</code> will both contain an entry named <code>miniupnpd</code>. Additionally if you have any UPnP application working, you will be able to find their port mappings. Please note if you have just enabled UPnP, your application may need to be restarted, in order to reconfigure the firewall.
</p>

</div>

<h4 id="checking_if_nat-pmp_is_working">Checking if NAT-PMP is working</h4>
<div class="level4">

<p>
From a shell, issue the command:
</p>
<pre class="code">logread -e &quot;\-PMP&quot;</pre>

<p>
If <abbr title="Network Address Translation">NAT</abbr>-PMP is enabled, you&#039;ll see something like this:
</p>
<pre class="code">Listening for NAT-PMP/PCP traffic on port 5351</pre>

<p>
Otherwise, you will see no message.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Troubleshooting&quot;,&quot;hid&quot;:&quot;troubleshooting&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:8,&quot;range&quot;:&quot;2506-3926&quot;} -->
<h2 class="sectionedit9" id="security_considerations">Security considerations</h2>
<div class="level2">

<p>
As UPnP provides no authentication mechanisms, it is commonly regarded as one giant security hole. A great deal of concern was also generated by the discovery of a buffer overflow vulnerability in the UPnP stack of Windows XP in 2001, which made it possible to obtain SYSTEM level access, and some institutions recommended disabling it altogether. For an historical perspective, see this page from <a href="http://www.grc.com/unpnp/unpnp.htm" class="urlextern" title="http://www.grc.com/unpnp/unpnp.htm" rel="ugc nofollow">Gibson Research</a>.
</p>

<p>
It is also been speculated that the design flaws in UPnP would lead to development of a new class of attacks which relied on UPnP. More information about this and possible exploits can been seen in this talk: <a href="https://www.youtube.com/watch?v=rseMaljMcBY" class="urlextern" title="https://www.youtube.com/watch?v=rseMaljMcBY" rel="ugc nofollow">Martin Zeiser: UPnP - Universal Pwn n Play</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Security considerations&quot;,&quot;hid&quot;:&quot;security_considerations&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:9,&quot;range&quot;:&quot;3927-4720&quot;} -->
<h3 class="sectionedit10" id="check_if_a_router_has_the_insecure_upnp">Check if a router has the insecure UPnP</h3>
<div class="level3">

<p>
You can check your device with <a href="https://www.metasploit.com/" class="urlextern" title="https://www.metasploit.com/" rel="ugc nofollow">Metasploit</a>:
</p>
<pre class="code">msfconsole
msf&gt;
msf &gt; use auxiliary/scanner/upnp/ssdp_msearch
msf auxiliary(ssdp_msearch) &gt; set RHOSTS 192.168.0.0/24
msf auxiliary(ssdp_msearch) &gt; run</pre>

<p>
Look for something like:
</p>
<pre class="code">[*] 192.168.0.9:1900 SSDP Net-OS 5.xx UPnP/1.0 | 192.168.0.9:3278/etc/linuxigd/gatedesc.xml
[+] 192.168.0.254:1900 SSDP miniupnpd/1.0 UPnP/1.0 | vulns:2 (CVE-2013-0229, CVE-2013-0230)</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Check if a router has the insecure UPnP&quot;,&quot;hid&quot;:&quot;check_if_a_router_has_the_insecure_upnp&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:10,&quot;range&quot;:&quot;4721-&quot;} -->