
<h1 class="sectionedit1" id="netfilter_management">Netfilter Management</h1>
<div class="level1">

<p>
This section discusses techniques and tools to manage fw3, fw4 and netfilter rules.
</p>

<p>
Almost all the issues with the firewall can be gleaned from inspecting the
netfilter tables and analyzing their relationships.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:howto_links">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_important plugin_wrap">
<p>
The firewall backend has been changed from iptables (fw3) to nftables (fw4) in OpenWrt 22.03
</p>
<ul>
<li class="level1"><div class="li"> Native UCI configuration works exactly in the same way and requires no adaptation</div>
</li>
<li class="level1"><div class="li"> However, any custom firewall configuration using <code>iptables</code> will need to be replaced by an equivalent <code>nft</code> mechanism</div>
</li>
</ul>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:howto_links&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Netfilter Management&quot;,&quot;hid&quot;:&quot;netfilter_management&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-325&quot;} -->
<h2 class="sectionedit6" id="inspecting_tables_using_fw4_2203_and_later">Inspecting tables using fw4 (22.03 and later)</h2>
<div class="level2">

<p>
The <a href="/docs/guide-user/firewall/overview" class="wikilink1" title="docs:guide-user:firewall:overview" data-wiki-id="docs:guide-user:firewall:overview">fw4 application</a> is the nftables frontend used in OpenWrt.
</p>

<p>
<code>fw4 print</code> dumps the nftables configuration that is built by fw4 and passed to nftables.
It contains slightly higher-level code than the raw nftables state: fw4 uses variables, include files...
</p>

<p>
When debugging rules emitted by fw4, this is a good starting point.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Inspecting tables using fw4 (22.03 and later)&quot;,&quot;hid&quot;:&quot;inspecting_tables_using_fw4_2203_and_later&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;326-751&quot;} -->
<h2 class="sectionedit7" id="inspecting_tables_using_nft_2203_and_later">Inspecting tables using nft (22.03 and later)</h2>
<div class="level2">

<p>
<code>nft list ruleset</code> dumps the full nftables configuration from the kernel. This dump mixes data from different sources:
</p>
<ul>
<li class="level1"><div class="li"> rules generated by fw4</div>
</li>
<li class="level1"><div class="li"> rules included from external files (<code>/etc/nftables.d/*.nft</code> or <code>/usr/share/nftables.d/</code>)</div>
</li>
<li class="level1"><div class="li"> rules added manually through the <code>nft</code> command</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Inspecting tables using nft (22.03 and later)&quot;,&quot;hid&quot;:&quot;inspecting_tables_using_nft_2203_and_later&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;752-1110&quot;} -->
<h2 class="sectionedit8" id="use_nftables_tracing_to_debug_fw4_rules_2203_and_later">Use nftables tracing to debug fw4 rules (22.03 and later)</h2>
<div class="level2">

<p>
Somethings, the nftables ruleset may exhibit unexpected behaviour, such as a packet being dropped while it should not. In that case, <strong>tracing</strong> can help: it allows to print all rules traversed by a given packet.
</p>

<p>
See <a href="https://wiki.nftables.org/wiki-nftables/index.php/Ruleset_debug/tracing" class="urlextern" title="https://wiki.nftables.org/wiki-nftables/index.php/Ruleset_debug/tracing" rel="ugc nofollow">https://wiki.nftables.org/wiki-nftables/index.php/Ruleset_debug/tracing</a> for the full explanation. The following is simply an adaptation of this wiki page to the fw4 ruleset.
</p>

<p>
You first need to add a tracing chain:
</p>
<pre class="code">nft add chain inet fw4 trace_chain { type filter hook prerouting priority -301\; }</pre>

<p>
Then add one or more rules to match packets you are interested in, such as:
</p>
<pre class="code">nft add rule inet fw4 trace_chain ip saddr 203.0.113.42 meta nftrace set 1
nft add rule inet fw4 trace_chain udp dport 50014 meta nftrace set 1</pre>

<p>
Finally, you can look at the result of the trace (ideally in another terminal):
</p>
<pre class="code">nft monitor trace</pre>

<p>
Beware, each traced packet will generate a huge amount of output!
</p>

<p>
To stop the tracing, remove the chain:
</p>
<pre class="code">nft delete chain inet fw4 trace_chain</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Use nftables tracing to debug fw4 rules (22.03 and later)&quot;,&quot;hid&quot;:&quot;use_nftables_tracing_to_debug_fw4_rules_2203_and_later&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;1111-2175&quot;} -->
<h2 class="sectionedit9" id="inspecting_tables_using_fw3_2102_and_earlier">Inspecting tables using fw3 (21.02 and earlier)</h2>
<div class="level2">

<p>
The <a href="/docs/guide-user/firewall/overview" class="wikilink1" title="docs:guide-user:firewall:overview" data-wiki-id="docs:guide-user:firewall:overview">fw3 application</a> is a good command
line interface to see all the netfilter rules.
</p>

<p>
<code>fw3 print</code> dumps all the netfilter rules to stdout as a set of <code>iptables</code>
directives.  Each directive is a complete <code>iptables</code> command, runnable in a
shell.
</p>

<p>
Additionally, the directives are organized hierarchically so the entire
dump <strong>could</strong> be run as a script to recreate the firewall rule set.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Inspecting tables using fw3 (21.02 and earlier)&quot;,&quot;hid&quot;:&quot;inspecting_tables_using_fw3_2102_and_earlier&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;2176-2666&quot;} -->
<h2 class="sectionedit10" id="inspecting_tables_using_iptables_2102_and_earlier">Inspecting tables using iptables (21.02 and earlier)</h2>
<div class="level2">

<p>
<code>fw3 print</code> is the main utility to inspect iptable rules.  Additionally the
<code>iptable</code> command can be used to sort the rules differently and retrieve
packet counts for matching rules.  There are a number of arguments but the two
most useful examples are:
</p>
<pre class="file">iptables -t &lt;table&gt; -vnL
iptables -t &lt;table&gt; -vS</pre>

<p>
where
</p>
<ul>
<li class="level1"><div class="li"> &lt;table&gt; is one of: <code>filter</code> (default), <code>nat</code>, <code>mangle</code></div>
</li>
<li class="level1"><div class="li"> <code>-v</code>: verbose, includes packet counts and physical interface name</div>
</li>
<li class="level1"><div class="li"> <code>-n</code>: numeric output</div>
</li>
<li class="level1"><div class="li"> <code>-L</code>: list rules</div>
</li>
<li class="level1"><div class="li"> <code>-S</code>: print rules</div>
</li>
</ul>

<p>
The <code>-L</code> and <code>-S</code> arguments sort/format the output differently.  The <code>-S</code>
option is equivalent to using the <code>iptable-save</code> command.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Inspecting tables using iptables (21.02 and earlier)&quot;,&quot;hid&quot;:&quot;inspecting_tables_using_iptables_2102_and_earlier&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:10,&quot;range&quot;:&quot;2667-3414&quot;} -->
<h3 class="sectionedit11" id="analyzing_netfilter_rules">Analyzing netfilter rules</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> rules created by fw3 have “!fw3”</div>
</li>
</ul>

</div>

<h4 id="netfilter_rule_debugging_example">Netfilter Rule Debugging Example</h4>
<div class="level4">

<p>
You want to add a LOG target to see all <abbr title="Hypertext Transfer Protocol">HTTP</abbr> traffic forwarded from your <abbr title="Local Area Network">LAN</abbr> to your <abbr title="Wide Area Network">WAN</abbr>.
</p>
<ul>
<li class="level1"><div class="li"> Run <code>fw3</code> or <code>iptables -Ln</code> to see the possible chains and rules,</div>
</li>
<li class="level1"><div class="li"> <code>zone_lan_forward</code> looks like a good chain to add a new rule for LOG,</div>
</li>
<li class="level1"><div class="li"> in <code>/etc/firewall.user</code> add <code>iptables -A zone_lan_forward --dport 80 -j LOG --log-prefix “<abbr title="Hypertext Transfer Protocol">HTTP</abbr>-<abbr title="Local Area Network">LAN</abbr>-ALL:”</code></div>
</li>
</ul>

<p>
Now reload the rules and send a <code>curl</code> request from a <abbr title="Local Area Network">LAN</abbr> station, check the
local syslog and only SYN/FIN packets are logged.  The rule is sort of working
but where are all the packets between the SYN setup and FIN release?
</p>

<p>
Use <code>iptables -nL</code> to inspect the FORWARD chain:
</p>
<pre class="file">Chain FORWARD (policy DROP)
num  target     prot opt source               destination         
1    forwarding_rule  all  --  0.0.0.0/0            0.0.0.0/0            /* !fw3: user chain for forwarding */
2    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED /* !fw3 */
3    zone_lan_forward  all  --  0.0.0.0/0            0.0.0.0/0            /* !fw3 */
4    zone_wan_forward  all  --  0.0.0.0/0            0.0.0.0/0            /* !fw3 */
5    reject     all  --  0.0.0.0/0            0.0.0.0/0            /* !fw3 */</pre>

<p>
From this one can see that the <code>zone_lan_forward</code> chain is only tested when a connection is being initialized
or torn down.  For ESTABLISHED connections, the ACCEPT in rule #2 ends the chain traversal.
</p>

<p>
To fix this, append your LOG rule to the <code>forwarding_rule</code> chain.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Analyzing netfilter rules&quot;,&quot;hid&quot;:&quot;analyzing_netfilter_rules&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:11,&quot;range&quot;:&quot;3415-5016&quot;} -->
<h2 class="sectionedit12" id="conntrack_diagnostics">Conntrack Diagnostics</h2>
<div class="level2">

<p>
Many netfilter features, especially <abbr title="Network Address Translation">NAT</abbr>, depend on the <code>nf_conntrack</code> modules to track
<abbr title="Internet Protocol">IP</abbr> connections between the <abbr title="Wide Area Network">WAN</abbr>-side and the <abbr title="Local Area Network">LAN</abbr>-side.  Access to the conntrack tables can be
invaluable when debugging traffic rules.  The kernel presents the table
through the <a href="https://en.wikipedia.org/wiki/Procfs" class="urlextern" title="https://en.wikipedia.org/wiki/Procfs" rel="ugc nofollow">procfs filesystem</a>
at <code>/proc/net/nf_conntrack</code>.
</p>

<p>
Here is a typical conntrack entry:
</p>
<pre class="file">ipv4     2 tcp      6 4088 ESTABLISHED src=192.168.3.171 dst=192.168.10.175 sport=33284 dport=22 packets=24 bytes=1248 src=192.168.10.175 dst=192.168.3.171 sport=22 dport=33284 packets=24 bytes=1248 [ASSURED] mark=0 use=2</pre>

<p>
This is a ipv4 tcp session on port=22 (<abbr title="Secure Shell">SSH</abbr>).  It shows a connection from STA1 to STA2 and then the reverse mapping.
</p>

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> The nf_conntrack parameters can be tuned using parameters in the sysfs
filesystem under <code>/proc/sys/net/netfilter</code>.  This is almost never desirable. 
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Conntrack Diagnostics&quot;,&quot;hid&quot;:&quot;conntrack_diagnostics&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:12,&quot;range&quot;:&quot;5017-&quot;} -->