
<h1 class="sectionedit1" id="firewall_overview">Firewall overview</h1>
<div class="level1">

<p>
OpenWrt uses the firewall4 (<code>fw4</code>) netfilter <a href="https://wiki.nftables.org/wiki-nftables/index.php/What_is_nftables%3F" class="urlextern" title="https://wiki.nftables.org/wiki-nftables/index.php/What_is_nftables%3F" rel="ugc nofollow">nftables</a>, a Linux kernel packet classification and rule builder system. It runs in user-space to parse a configuration file into a set of <code>nftables</code> rules, sending each to the kernel netfilter modules.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Firewall overview&quot;,&quot;hid&quot;:&quot;firewall_overview&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-358&quot;} -->
<h2 class="sectionedit2" id="purpose">Purpose</h2>
<div class="level2">

<p>
The netfilter rule set can be very complex for a typical router.
This is by necessity; each rule is tailored to a discrete capability provided by the router to protect its supported networks, provide <a href="/docs/guide-user/firewall/fw3_configurations/fw3_nat" class="wikilink1" title="docs:guide-user:firewall:fw3_configurations:fw3_nat" data-wiki-id="docs:guide-user:firewall:fw3_configurations:fw3_nat">NAT</a> to conserve scarce <abbr title="Internet Protocol version 4">IPv4</abbr> addresses, even <code>mangle</code> the packets during routing.
A typical router has over 100 rules designed to support packet routing.
</p>

<p>
The <code>fw4</code> application is used by OpenWrt to “safely” construct a rule set while hiding much of the details.
</p>

<p>
On inspecting the netfilter rule set using <code>fw4 print</code>, you will see a number of netfilter/nftables rules either not explicitly defined in the firewall configuration files, or more difficult to understand (thank goodness for the <code>--comment</code> match!)
The netfilter rules include:
</p>
<ul>
<li class="level1"><div class="li"> A number of chains (mis-termed <code>_rule</code>) for each special target and zone.</div>
</li>
<li class="level1"><div class="li"> INPUT and OUTPUT for the often forgotten loopback interface.</div>
</li>
<li class="level1"><div class="li"> The <code>option syn_flood 1</code> or <code>option mtu_fix 1</code> each translate to complex nftables rules.</div>
</li>
<li class="level1"><div class="li"> The <code>option masq 1</code> translates to the &#039;-j MASQUERADE&#039; target for <abbr title="Network Address Translation">NAT</abbr>.</div>
</li>
<li class="level1"><div class="li"> <code>mangle</code> rules that match bits in the packets <abbr title="Transmission Control Protocol">TCP</abbr> header and then modify the packet.</div>
</li>
</ul>

<p>
The firewall configuration is fairly straight forward and automatically provides the router with a base rule set of rules and an understandable configuration file for additional rules.
</p>

<p>
The rules consumed by netfilter are, at best, difficult to comprehend due to the exacting nature of netfilter.
However, every rule provides desired capability or <strong>blocks</strong> malicious capability, and therefore necessary.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Purpose&quot;,&quot;hid&quot;:&quot;purpose&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;359-2004&quot;} -->
<h2 class="sectionedit3" id="process_control">Process control</h2>
<div class="level2">

<p>
<code>fw4</code> is managed by the <code>firewall</code> service.
The shell script accepts the following
set of arguments:
</p>
<ul>
<li class="level1"><div class="li"> <code>boot</code>: this is invoked during system init (bootup)</div>
</li>
<li class="level1"><div class="li"> <code>start</code>: parse configuration files and write to the netfilter kernel modules</div>
</li>
<li class="level1"><div class="li"> <code>stop</code>: flush configuration rules from the kernel modules (they will not be unloaded)</div>
</li>
<li class="level1"><div class="li"> <code>restart</code>, <code>reload</code>: read the netfilter rules from the kernel, replace using the configuration files, and write back to the netfilter kernel modules.</div>
</li>
<li class="level1"><div class="li"> <code>flush</code>: (dangerous) delete all rules, delete non-default chains, and reset default policies to <code>ACCEPT</code>.</div>
</li>
</ul>

<p>
In some cases, the argument will be accompanied by additional flags to suppress log messages, or calls to internal functions as described above to verify the configuration files.
</p>

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> When invoking <code>stop</code>, <strong>only</strong> the rules in the configuration files will be flushed.
Those rules automatically generated by <code>fw4</code> will be retained.
</p>

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> If <strong>all</strong> the rules are flushed by invoking <code>flush</code>, the default policy is set to <code>ACCEPT</code> and the router will pass all packets to, or forward on, to the destination network, providing <strong>no security</strong>.
</p>

<p>
In cases where the router becomes inaccessible due to <code>DROP</code> set as the default policy, access can be restored through one of two methods:
</p>
<ul>
<li class="level1"><div class="li"> Connecting via <a href="/docs/techref/hardware/port.serial" class="wikilink1" title="docs:techref:hardware:port.serial" data-wiki-id="docs:techref:hardware:port.serial">Serial Console</a></div>
</li>
<li class="level1"><div class="li"> Performing a <a href="/docs/guide-user/troubleshooting/failsafe_and_factory_reset" class="wikilink1" title="docs:guide-user:troubleshooting:failsafe_and_factory_reset" data-wiki-id="docs:guide-user:troubleshooting:failsafe_and_factory_reset">Factory Reset</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Process control&quot;,&quot;hid&quot;:&quot;process_control&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;2005-3501&quot;} -->
<h2 class="sectionedit4" id="references">References</h2>
<div class="level2">

<p>
<a href="https://git.openwrt.org/project/firewall4.git" class="urlextern" title="https://git.openwrt.org/project/firewall4.git" rel="ugc nofollow">Source code</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;References&quot;,&quot;hid&quot;:&quot;references&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;3502-&quot;} -->