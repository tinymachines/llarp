
<h1 class="sectionedit1" id="preinit_and_root_mount_and_firstboot_scripts">Preinit and Root Mount and Firstboot Scripts</h1>
<div class="level1">

<p>
<img src="/lib/images/smileys/fixme.svg" class="icon smiley" alt="FIXME" /> Information may be outdated and obsolete information as of April, 2018; Overview, Preinit and Overview, Failsafe updated from April 2018 based on reading <code>master</code> code.
</p>

<p>
See <a href="/docs/guide-user/additional-software/extroot_configuration" class="wikilink1" title="docs:guide-user:additional-software:extroot_configuration" data-wiki-id="docs:guide-user:additional-software:extroot_configuration">Rootfs on External Storage</a> for information on external rootfs mounting.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Preinit and Root Mount and Firstboot Scripts&quot;,&quot;hid&quot;:&quot;preinit_and_root_mount_and_firstboot_scripts&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-379&quot;} -->
<h1 class="sectionedit2" id="abstract">Abstract</h1>
<div class="level1">

<p>
This document presents the preinit / firstboot boot sequence. The boot system is extensible via (new) packages such as rootfs on usb, or 
enhanced failsafe.
</p>

<p>
We describe the portion of the OpenWrt boot sequence that occurs before the &#039;init&#039; program is executed (when booting in multiuser mode), as well as the script that is responsible for creating and initializing the root filesystem on the first boot after flashing the device with OpenWrt.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Abstract&quot;,&quot;hid&quot;:&quot;abstract&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;380-849&quot;} -->
<h1 class="sectionedit3" id="contextboot_sequence">Context:  Boot Sequence</h1>
<div class="level1">

<p>
The basic OpenWrt boot sequence is:
</p>
<ol>
<li class="level1"><div class="li"> boot loader loads kernel</div>
</li>
<li class="level1"><div class="li"> kernel loads whilst scanning the mtd partition <em>rootfs</em> for a valid superblock for mounting the SquashFS partition (which contains /etc). More info at <a href="/docs/techref/filesystems#technicaldetails" class="wikilink1" title="docs:techref:filesystems" data-wiki-id="docs:techref:filesystems">technical.details</a></div>
</li>
<li class="level1"><div class="li"> <del>kernel calls <code>/etc/preinit</code> (the kernel considers this to be the <code>init</code> (or root) process</del> <code>/sbin/init</code> now the init process, which in turn launches <code>/sbin/procd -h /etc/hotplug-preinit.json</code> (a.k.a., “plugd”) followed by <code>/bin/sh /etc/preinit</code>.  Each is launched via <code>fork</code> and <code>execvp</code> and managed by the uloop library in libubox.</div>
</li>
<li class="level1"><div class="li"> <code>/etc/preinit</code> prepares system for multiuser mode</div>
</li>
<li class="level1"><div class="li"> <code>/etc/preinit</code> <code>exec</code>s <code>/sbin/init</code> which becomes the <code>init</code> (or root) process and launches multiuser</div>
</li>
<li class="level1"><div class="li"> <code>/sbin/init</code> launches processes according to /etc/inittab. </div>
</li>
<li class="level1"><div class="li"> Typically the first process launched is <code>/etc/init.d/rcS</code> which causes the scripts in <code>/etc/rc.d</code> which begin with &#039;S&#039; to be launched (in glob sort order). The <code>/etc/rc.d</code> directory is populated with symlinks to the scripts in <code>/etc/init.d</code>. Each script in <code>/etc/init.d</code> accepts <code>enable</code> and <code>disable</code> arguments for creating and removing the symlinks.</div>
</li>
<li class="level1"><div class="li"> These script initialize the system and also initialize daemons that wait for input, so that when all the scripts have executed the normal system is active.  On first boot this initializing includes the process of preparing the root filesystem for use.</div>
</li>
</ol>
<hr />

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Context:  Boot Sequence&quot;,&quot;hid&quot;:&quot;contextboot_sequence&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;850-2388&quot;} -->
<h1 class="sectionedit4" id="overview">Overview</h1>
<div class="level1">

<p>
The following preinit scripts are available in the OpenWrt master branches for base and packages feed (Status September 2024)
</p>
<div class="table sectionedit5"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> repo     </td><td class="col1 leftalign"> packages         </td><td class="col2 leftalign"> target      </td><td class="col3 leftalign"> subtarget   </td><td class="col4 leftalign"> file-repo                                                                          </td><td class="col5 leftalign"> file-target                                </td><td class="col6 leftalign"> hook               </td><td class="col7 leftalign"> info                  </td>
	</tr>
	<tr class="row1">
		<td class="col0"> packages </td><td class="col1 leftalign"> openssh          </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> net/openssh/files/sshd.failsafe                                                    </td><td class="col5 leftalign"> /lib/preinit/99_10_failsafe_sshd           </td><td class="col6 leftalign"> failsafe           </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row2">
		<td class="col0"> packages </td><td class="col1 leftalign"> btrfs-progs      </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> utils/btrfs-progs/files/btrfs-scan.init                                            </td><td class="col5 leftalign"> /lib/preinit/85_btrfs_scan                 </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign"> INITRAMFS check &#039;NO&#039;  </td>
	</tr>
	<tr class="row3">
		<td class="col0"> packages </td><td class="col1 leftalign"> lvm2             </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> utils/lvm2/files/lvm2.preinit                                                      </td><td class="col5 leftalign"> /lib/preinit/80_lvm2                       </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign"> INITRAMFS check &#039;NO&#039;  </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> dropbear         </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/network/services/dropbear/files/dropbear.failsafe                          </td><td class="col5 leftalign"> /lib/preinit/99_10_failsafe_dropbear       </td><td class="col6 leftalign"> failsafe           </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign"> base     </td><td class="col1"> zyxel-bootconfig </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/utils/zyxel-bootconfig/files/95_apply_bootconfig                           </td><td class="col5 leftalign"> /lib/preinit/95_apply_bootconfig           </td><td class="col6 leftalign"> preinit_main       </td><td class="col7"> INITRAMFS check &#039;YES&#039; </td>
	</tr>
	<tr class="row6">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> imx         </td><td class="col3 leftalign"> cortexa53   </td><td class="col4 leftalign"> target/linux/imx/cortexa53/base-files/lib/preinit/79_move_config                   </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row7">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> imx         </td><td class="col3 leftalign"> cortexa7    </td><td class="col4 leftalign"> target/linux/imx/cortexa7/base-files/lib/preinit/79_move_config                    </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row8">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> imx         </td><td class="col3 leftalign"> cortexa9    </td><td class="col4 leftalign"> target/linux/imx/cortexa9/base-files/lib/preinit/79_move_config                    </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row9">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> rockchip    </td><td class="col3 leftalign"> armv8       </td><td class="col4 leftalign"> target/linux/rockchip/armv8/base-files/lib/preinit/79_move_config                  </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row10">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> omap        </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/omap/base-files/lib/preinit/79_move_config                            </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row11">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> qoriq       </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/qoriq/base-files/lib/preinit/79_move_config                           </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row12">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> sifiveu     </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/sifiveu/base-files/lib/preinit/79_move_config                         </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row13">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> tegra       </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/tegra/base-files/lib/preinit/79_move_config                           </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row14">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> sunxi       </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/sunxi/base-files/lib/preinit/79_move_config                           </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row15">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/02_default_set_state                          </td><td class="col5 leftalign"> /lib/preinit/02_default_set_state          </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row16">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/02_sysinfo                                    </td><td class="col5 leftalign"> /lib/preinit/02_sysinfo                    </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row17">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/10_indicate_failsafe                          </td><td class="col5 leftalign"> /lib/preinit/10_indicate_failsafe          </td><td class="col6 leftalign"> failsafe           </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row18">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/10_indicate_preinit                           </td><td class="col5 leftalign"> /lib/preinit/10_indicate_preinit           </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row19">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/30_failsafe_wait                              </td><td class="col5 leftalign"> /lib/preinit/30_failsafe_wait              </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row20">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/40_run_failsafe_hook                          </td><td class="col5 leftalign"> /lib/preinit/40_run_failsafe_hook          </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row21">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/50_indicate_regular_preinit                   </td><td class="col5 leftalign"> /lib/preinit/50_indicate_regular_preinit   </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row22">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/70_initramfs_test                             </td><td class="col5 leftalign"> /lib/preinit/70_initramfs_test             </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row23">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/80_mount_root                                 </td><td class="col5 leftalign"> /lib/preinit/80_mount_root                 </td><td class="col6 leftalign"> preinit_main       </td><td class="col7"> INITRAMFS check &#039;YES&#039; </td>
	</tr>
	<tr class="row24">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/99_10_failsafe_login                          </td><td class="col5 leftalign"> /lib/preinit/99_10_failsafe_login          </td><td class="col6 leftalign"> failsafe           </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row25">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> base-files       </td><td class="col2 leftalign"> all         </td><td class="col3 leftalign"> all         </td><td class="col4 leftalign"> package/base-files/files/lib/preinit/99_10_run_init                                </td><td class="col5 leftalign"> /lib/preinit/99_10_run_init                </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign"> INITRAMFS check &#039;NO&#039;  </td>
	</tr>
	<tr class="row26">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> bcm47xx     </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/bcm47xx/base-files/lib/preinit/01_sysinfo                             </td><td class="col5 leftalign"> /lib/preinit/01_sysinfo                    </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row27">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> lantiq      </td><td class="col3"> xway_legacy </td><td class="col4"> target/linux/lantiq/xway_legacy/base-files/lib/preinit/05_set_preinit_iface_lantiq </td><td class="col5 leftalign"> /lib/preinit/05_set_preinit_iface_lantiq   </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row28">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> lantiq      </td><td class="col3 leftalign"> xway        </td><td class="col4 leftalign"> target/linux/lantiq/xway/base-files/lib/preinit/05_set_preinit_iface_lantiq        </td><td class="col5 leftalign"> /lib/preinit/05_set_preinit_iface_lantiq   </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row29">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> lanitq      </td><td class="col3 leftalign"> ase         </td><td class="col4 leftalign"> target/linux/lantiq/ase/base-files/lib/preinit/05_set_preinit_iface_lantiq         </td><td class="col5 leftalign"> /lib/preinit/05_set_preinit_iface_lantiq   </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row30">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> armsr       </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/armsr/base-files/lib/preinit/01_sysinfo_acpi                          </td><td class="col5 leftalign"> /lib/preinit/01_sysinfo_acpi               </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row31">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> armsr       </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/armsr/base-files/lib/preinit/79_move_config                           </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row32">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> x86         </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/x86/base-files/lib/preinit/02_load_x86_ucode                          </td><td class="col5 leftalign"> /lib/preinit/02_load_x86_ucode             </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row33">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> x86         </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/x86/base-files/lib/preinit/15_essential_fs_x86                        </td><td class="col5 leftalign"> /lib/preinit/15_essential_fs_x86           </td><td class="col6 leftalign"> ?                  </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row34">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> x86         </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/x86/base-files/lib/preinit/20_check_iso                               </td><td class="col5 leftalign"> /lib/preinit/20_check_iso                  </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row35">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> x86         </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/x86/base-files/lib/preinit/79_move_config                             </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row36">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> x86         </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/x86/generic/base-files/lib/preinit/45_mount_xenfs                     </td><td class="col5 leftalign"> /lib/preinit/45_mount_xenfs                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row37">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> x86         </td><td class="col3 leftalign"> 64          </td><td class="col4 leftalign"> target/linux/x86/64/base-files/lib/preinit/45_mount_xenfs                          </td><td class="col5 leftalign"> /lib/preinit/45_mount_xenfs                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row38">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> bcm27xx     </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/bcm27xx/base-files/lib/preinit/05_set_preinit_iface_brcm2708          </td><td class="col5"> /lib/preinit/05_set_preinit_iface_brcm2708 </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row39">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> bcm27xx     </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/bcm27xx/base-files/lib/preinit/79_move_config                         </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row40">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> bcm27xx     </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/bcm27xx/base-files/lib/preinit/81_set_root_part                       </td><td class="col5 leftalign"> /lib/preinit/81_set_root_part              </td><td class="col6 leftalign"> preinit_main       </td><td class="col7"> INITRAMFS check &#039;YES&#039; </td>
	</tr>
	<tr class="row41">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mediatek    </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/mediatek/base-files/lib/preinit/05_set_preinit_iface                  </td><td class="col5 leftalign"> /lib/preinit/05_set_preinit_iface          </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row42">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mediatek    </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/mediatek/base-files/lib/preinit/06_set_rps_sock_flow                  </td><td class="col5 leftalign"> /lib/preinit/06_set_rps_sock_flow          </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row43">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mediatek    </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/mediatek/base-files/lib/preinit/07_trigger_fip_scrubbing              </td><td class="col5 leftalign"> /lib/preinit/07_trigger_fip_scrubbing      </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row44">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mediatek    </td><td class="col3 leftalign"> mt7623      </td><td class="col4 leftalign"> target/linux/mediatek/mt7623/base-files/lib/preinit/07_set_iface_mac               </td><td class="col5 leftalign"> /lib/preinit/07_set_iface_mac              </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row45">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mediatek    </td><td class="col3 leftalign"> mt7623      </td><td class="col4 leftalign"> target/linux/mediatek/mt7623/base-files/lib/preinit/79_move_config                 </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row46">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mediatek    </td><td class="col3 leftalign"> filogic     </td><td class="col4 leftalign"> target/linux/mediatek/filogic/base-files/lib/preinit/04_set_netdev_label           </td><td class="col5 leftalign"> /lib/preinit/04_set_netdev_label           </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row47">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mediatek    </td><td class="col3 leftalign"> filogic     </td><td class="col4 leftalign"> target/linux/mediatek/filogic/base-files/lib/preinit/05_extract_factory_data.sh    </td><td class="col5 leftalign"> /lib/preinit/05_extract_factory_data.sh    </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row48">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mediatek    </td><td class="col3 leftalign"> filogic     </td><td class="col4 leftalign"> target/linux/mediatek/filogic/base-files/lib/preinit/09_mount_cfg_part             </td><td class="col5 leftalign"> /lib/preinit/09_mount_cfg_part             </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row49">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mediatek    </td><td class="col3 leftalign"> filogic     </td><td class="col4 leftalign"> target/linux/mediatek/filogic/base-files/lib/preinit/10_fix_eth_mac.sh             </td><td class="col5 leftalign"> /lib/preinit/10_fix_eth_mac.sh             </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row50">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mediatek    </td><td class="col3 leftalign"> filogic     </td><td class="col4 leftalign"> target/linux/mediatek/filogic/base-files/lib/preinit/75_rootfs_prepare             </td><td class="col5 leftalign"> /lib/preinit/75_rootfs_prepare             </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign"> INITRAMFS check &#039;NO&#039;  </td>
	</tr>
	<tr class="row51">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> apm821xx    </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/apm821xx/base-files/lib/preinit/05_set_preinit_iface_apm821xx         </td><td class="col5"> /lib/preinit/05_set_preinit_iface_apm821xx </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row52">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> apm821xx    </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/apm821xx/base-files/lib/preinit/05_set_iface_mac_apm821xx             </td><td class="col5 leftalign"> /lib/preinit/05_set_iface_mac_apm821xx     </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row53">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> apm821xx    </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/apm821xx/base-files/lib/preinit/79_move_config                        </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row54">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> ixp4xx      </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/ixp4xx/base-files/lib/preinit/05_set_ether_mac_ixp4xx                 </td><td class="col5 leftalign"> /lib/preinit/05_set_ether_mac_ixp4xx       </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row55">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> kirkwood    </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/kirkwood/base-files/lib/preinit/07_set_iface_mac                      </td><td class="col5 leftalign"> /lib/preinit/07_set_iface_mac              </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row56">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mvebu       </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/mvebu/base-files/lib/preinit/79_move_config                           </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row57">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mvebu       </td><td class="col3 leftalign"> cortexa53   </td><td class="col4 leftalign"> target/linux/mvebu/cortexa53/base-files/lib/preinit/82_uDPU                        </td><td class="col5 leftalign"> /lib/preinit/82_uDPU                       </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign"> INITRAMFS check &#039;NO&#039;  </td>
	</tr>
	<tr class="row58">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mvebu       </td><td class="col3 leftalign"> cortexa9    </td><td class="col4 leftalign"> target/linux/mvebu/cortexa9/base-files/lib/preinit/81_linksys_syscfg               </td><td class="col5 leftalign"> /lib/preinit/81_linksys_syscfg             </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign"> INITRAMFS check &#039;NO&#039;  </td>
	</tr>
	<tr class="row59">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> ipq806x     </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/ipq806x/base-files/lib/preinit/04_reorder_eth                         </td><td class="col5 leftalign"> /lib/preinit/04_reorder_eth                </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row60">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> ath79       </td><td class="col3 leftalign"> generic     </td><td class="col4 leftalign"> target/linux/ath79/generic/base-files/lib/preinit/02_sysinfo_fixup                 </td><td class="col5 leftalign"> /lib/preinit/02_sysinfo_fixup              </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row61">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> ath79       </td><td class="col3 leftalign"> generic     </td><td class="col4 leftalign"> target/linux/ath79/generic/base-files/lib/preinit/10_fix_eth_mac.sh                </td><td class="col5 leftalign"> /lib/preinit/10_fix_eth_mac.sh             </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row62">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> ath79       </td><td class="col3 leftalign"> nand        </td><td class="col4 leftalign"> target/linux/ath79/nand/base-files/lib/preinit/10_fix_eth_mac.sh                   </td><td class="col5 leftalign"> /lib/preinit/10_fix_eth_mac.sh             </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row63">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> bcm4908     </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/bcm4908/base-files/lib/preinit/75_rootfs_prepare                      </td><td class="col5 leftalign"> /lib/preinit/75_rootfs_prepare             </td><td class="col6 leftalign"> preinit_main       </td><td class="col7"> INITRAMFS check &#039;NO&#039; </td>
	</tr>
	<tr class="row64">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> gemini      </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/gemini/base-files/lib/preinit/05_set_ether_mac_gemini                 </td><td class="col5 leftalign"> /lib/preinit/05_set_ether_mac_gemini       </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row65">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2"> loongarch64 </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/loongarch64/base-files/lib/preinit/01_sysinfo_acpi                    </td><td class="col5 leftalign"> /lib/preinit/01_sysinfo_acpi               </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row66">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2"> loongarch64 </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/loongarch64/base-files/lib/preinit/79_move_config                     </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row67">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mpc85xx     </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/mpc85xx/base-files/lib/preinit/05_set_preinit_iface_mpc85xx           </td><td class="col5 leftalign"> /lib/preinit/05_set_preinit_iface_mpc85xx  </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row68">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> mpc85xx     </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/mpc85xx/base-files/lib/preinit/10_fix_eth_mac.sh                      </td><td class="col5 leftalign"> /lib/preinit/10_fix_eth_mac.sh             </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row69">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> layerscape  </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/layerscape/base-files/lib/preinit/02_sysinfo_fixup                    </td><td class="col5 leftalign"> /lib/preinit/02_sysinfo_fixup              </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row70">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> layerscape  </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/layerscape/base-files/lib/preinit/79_move_config                      </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row71">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> ramips      </td><td class="col3 leftalign"> mt7621      </td><td class="col4 leftalign"> target/linux/ramips/mt7621/base-files/lib/preinit/04_set_netdev_label              </td><td class="col5 leftalign"> /lib/preinit/04_set_netdev_label           </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row72">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> ramips      </td><td class="col3 leftalign"> rt305x      </td><td class="col4 leftalign"> target/linux/ramips/rt305x/base-files/lib/preinit/04_handle_checksumming           </td><td class="col5 leftalign"> /lib/preinit/04_handle_checksumming        </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row73">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> ramips      </td><td class="col3 leftalign"> rt3883      </td><td class="col4 leftalign"> target/linux/ramips/rt3883/base-files/lib/preinit/04_handle_checksumming           </td><td class="col5 leftalign"> /lib/preinit/04_handle_checksumming        </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row74">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> ipq40xx     </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/ipq40xx/base-files/lib/preinit/05_set_iface_mac_ipq40xx.sh            </td><td class="col5 leftalign"> /lib/preinit/05_set_iface_mac_ipq40xx.sh   </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row75">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> octeon      </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/octeon/base-files/lib/preinit/01_sysinfo                              </td><td class="col5 leftalign"> /lib/preinit/01_sysinfo                    </td><td class="col6 leftalign"> preinit_main       </td><td class="col7 leftalign">                       </td>
	</tr>
	<tr class="row76">
		<td class="col0 leftalign"> base     </td><td class="col1 leftalign"> linux            </td><td class="col2 leftalign"> octeon      </td><td class="col3 leftalign">             </td><td class="col4 leftalign"> target/linux/octeon/base-files/lib/preinit/79_move_config                          </td><td class="col5 leftalign"> /lib/preinit/79_move_config                </td><td class="col6"> preinit_mount_root </td><td class="col7 leftalign">                       </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;2538-20631&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Overview&quot;,&quot;hid&quot;:&quot;overview&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;2389-20635&quot;} -->
<h2 class="sectionedit6" id="preinit">Preinit</h2>
<div class="level2">

<p>
Preinit brings the system from raw kernel to ready for multiuser.  To do so, as of April, 2018,
<code>/etc/preinit</code> (ar71xx, Archer C7) performs the following tasks:
</p>
<ol>
<li class="level1"><div class="li"> Checks to see if <code>$PREINIT</code> is empty; if so <code>exec /sbin/init</code> and skip the rest</div>
</li>
<li class="level1 node"><div class="li"> Sources a set of files for common functions for boot/mount:</div>
<ul>
<li class="level2"><div class="li"> <code>/lib/functions.sh</code></div>
</li>
<li class="level2"><div class="li"> <code>/lib/functions/preinit.sh</code></div>
</li>
<li class="level2"><div class="li">  <code>/lib/functions/system.sh</code></div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> Prepares the “hooks” for the various stages of the preinit process</div>
<ul>
<li class="level2"><div class="li"> preinit_essential</div>
</li>
<li class="level2"><div class="li"> preinit_main</div>
</li>
<li class="level2"><div class="li"> failsafe</div>
</li>
<li class="level2"><div class="li"> initramfs</div>
</li>
<li class="level2"><div class="li"> preinit_mount_root</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Source the contents of <code>/lib/preinit/*</code> which generally add <code>sh</code> functions to the appropriate hooks</div>
</li>
<li class="level1"><div class="li"> Runs the <code>preinit_essential</code> hooks</div>
</li>
<li class="level1"><div class="li"> Runs the <code>preinit_main</code> hooks</div>
</li>
</ol>

<p>
On an ar71xx device (Archer C7) the default functions added to the various hooks include (with functions from device-specific files in <em>italics):</em>
</p>
<ul>
<li class="level1 node"><div class="li"> <strong>preinit_main</strong></div>
<ol>
<li class="level2"><div class="li"> <em>do_ar71xx</em></div>
</li>
<li class="level2"><div class="li"> define_default_set_state</div>
</li>
<li class="level2"><div class="li"> do_sysinfo_generic</div>
</li>
<li class="level2"><div class="li"> <em>preinit_set_mac_address</em></div>
</li>
<li class="level2"><div class="li"> <em>set_preinit_iface</em></div>
</li>
<li class="level2"><div class="li"> preinit_ip</div>
</li>
<li class="level2"><div class="li"> pi_indicate_preinit</div>
</li>
<li class="level2"><div class="li"> failsafe_wait</div>
</li>
<li class="level2 node"><div class="li"> run_failsafe_hook </div>
<ul>
<li class="level3 node"><div class="li"> <strong>failsafe</strong> (if “$pi_preinit_no_failsafe” != “y” and “$FAILSAFE” = “true”)</div>
<ol>
<li class="level4"><div class="li"> indicate_failsafe</div>
</li>
<li class="level4"><div class="li"> failsafe_netlogin</div>
</li>
<li class="level4"><div class="li"> failsafe_shell</div>
</li>
</ol>
</li>
</ul>
</li>
<li class="level2"><div class="li"> indicate_regular_preinit</div>
</li>
<li class="level2"><div class="li"> do_mount_root (if “$INITRAMFS” != “1”)</div>
</li>
<li class="level2"><div class="li"> do_urandom_seed</div>
</li>
<li class="level2"><div class="li"> <em>check_patch_ath10k_firmware</em></div>
</li>
<li class="level2"><div class="li"> run_init</div>
</li>
</ol>
</li>
</ul>

<p>
Presently unused hooks, at least for the ar71xx Archer C7, appear to include
</p>
<ul>
<li class="level1"><div class="li"> preinit_essential</div>
</li>
<li class="level1"><div class="li"> initramfs</div>
</li>
<li class="level1"><div class="li"> preinit_mount_root</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Preinit&quot;,&quot;hid&quot;:&quot;preinit&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;20636-22283&quot;} -->
<h2 class="sectionedit7" id="failsafe">Failsafe</h2>
<div class="level2">

<p>
The <em>root file system</em> is actually an overlay which can be consisted of a read-only SquashFS file system (mounted at <code>/rom</code>) and a writable JFFS2 partition (mounted under <code>/overlay</code>). In Failsafe mode only the squashfs FS will be mounted (changes made to jffs2 partitons will be ignored), plus the following steps:
</p>
<ol>
<li class="level1"><div class="li"> Notifies that failsafe mode is being entered (indicate_failsafe)</div>
</li>
<li class="level1"><div class="li"> Launches daemon to allow network logins (failsafe_netlogin)</div>
</li>
<li class="level1 node"><div class="li"> Allows login via serial console, if there is one (failsafe_shell)</div>
<ul>
<li class="level2"><div class="li"> If the serial console login process exits, failsafe doesn&#039;t exit, but restarts the process for additional logins.</div>
</li>
</ul>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Failsafe&quot;,&quot;hid&quot;:&quot;failsafe&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;22284-22952&quot;} -->
<h2 class="sectionedit8" id="mount_root_filesystem">Mount Root Filesystem</h2>
<div class="level2">

<p>
all_jffs2 refers to a &#039;jffs2&#039; target in menuconfig; e.g. firmware has
no squashfs, but is purely a rw filesystem (jffs2), while, jffs2 in
the following text refers to the jffs2 portion of a <a href="/docs/techref/filesystems#overlayfs" class="wikilink1" title="docs:techref:filesystems" data-wiki-id="docs:techref:filesystems">squashfs/jffs2</a> system.
</p>
<ol>
<li class="level1"><div class="li"> Kernel has previously mounted squashfs partition by scanning the mtd partition <code>rootfs</code> for a valid superblock (see step 2 of <a href="/docs/techref/preinit_mount#contextbootsequencel" class="wikilink1" title="docs:techref:preinit_mount" data-wiki-id="docs:techref:preinit_mount">contextboot.sequencel</a>) <img src="/lib/images/smileys/fixme.svg" class="icon smiley" alt="FIXME" /> <strong>Make sure it&#039;s correct</strong></div>
</li>
<li class="level1"><div class="li"> If there is no mtd device with label <code>rootfs_data</code>, then mounts <code>/dev/root</code> (e.g. squashfs or all_jffs2 with no squashfs) as root filesystem, and indicates that further steps should be skipped</div>
</li>
<li class="level1"><div class="li"> If mtd device <code>rootfs_data</code> has not already been formatted, mounts a tmpfs (ramdisk) as root filesystem, and indicates that further steps should be skipped.</div>
</li>
<li class="level1"><div class="li"> Mounts previously formatted jffs2 partition on <code>/overlay</code> and indicates successful mount.</div>
</li>
<li class="level1"><div class="li"> Makes successfully mounted <code>/overlay</code> (if it exists) the new root filesystem and moves previous root filesystem to <code>/rom</code>, and indicates to skip further steps.</div>
</li>
<li class="level1"><div class="li"> This is only reached on an error condition; attempts to mount a tmpfs (ramdisk) as root filesystem</div>
</li>
<li class="level1"><div class="li"> This is only reached if no other step succeeds; attempt to mount <code>/dev/root</code> (e.g. squashfs/all_jffs2) as root filesystem.</div>
</li>
</ol>

<p>
<strong> * </strong> <code>/overlay</code> was previously named <code>/jffs2</code>.<br/>

<strong> * </strong> NOTE: If volatile files (e.g. a config) were preserved across firmware update via <code>sysupgrade</code>, step 3 is skipped. Instead, preinit_main hangs while the rootfs_data partition is formatted and the jffs2 overlay is mounted. Hypothetically, this is fatal on systems with weak cpu and exceptionally large rootfs_data partitions. For more information <a href="https://forum.openwrt.org/t/error-in-preinit-documentation-regarding-overlays/60188/4" class="urlextern" title="https://forum.openwrt.org/t/error-in-preinit-documentation-regarding-overlays/60188/4" rel="ugc nofollow">consult this forum post</a>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Mount Root Filesystem&quot;,&quot;hid&quot;:&quot;mount_root_filesystem&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;22953-24848&quot;} -->
<h2 class="sectionedit9" id="first_boot">First Boot</h2>
<div class="level2">

<p>
Updated to version 23.05. And, likely applies to a number of previous versions.
</p>

<p>
<code>/sbin/firstboot</code> is a script that simply calls <code>/sbin/jffs2reset $@</code> which clears the overlay if it&#039;s mounted:
</p>
<ul>
<li class="level1"><div class="li"> -y Answer yes to “Are you sure?”</div>
</li>
<li class="level1"><div class="li"> -r Reboot instead of returning control to the caller.</div>
</li>
<li class="level1"><div class="li"> -k Keep the file <code>/sysupgrade.tgz</code> while clearing the overlay.</div>
</li>
</ul>

<p>
<code>/lib/preinit/80_mount_root</code> will extract the contents of <code>/sysupgrade.tgz</code> into the overlay after the reboot. This mechanism may be used to write into <code>/etc/uci-defaults</code> as a way to create a custom configuration immediately after the reboot.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;First Boot&quot;,&quot;hid&quot;:&quot;first_boot&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;24849-25484&quot;} -->
<h3 class="sectionedit10" id="common">Common</h3>
<div class="level3">
<ol>
<li class="level1"><div class="li"> Source <code>/lib/functions/boot.sh</code> for common functions (e.g. also used by preinit)</div>
</li>
<li class="level1"><div class="li"> Source files used by hooks</div>
</li>
<li class="level1"><div class="li"> Determine how called, and branch to appropriate commands.</div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Common&quot;,&quot;hid&quot;:&quot;common&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:10,&quot;range&quot;:&quot;25485-25683&quot;} -->
<h3 class="sectionedit11" id="sourced_rather_than_executed">Sourced rather than executed</h3>
<div class="level3">
<ol>
<li class="level1"><div class="li"> Determine (and set variable for) MTD rootfs_data partition</div>
</li>
<li class="level1"><div class="li"> Determine (and set variable for) rom partition</div>
</li>
<li class="level1"><div class="li"> Determine (and set variable for) jffs2 partition</div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Sourced rather than executed&quot;,&quot;hid&quot;:&quot;sourced_rather_than_executed&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:11,&quot;range&quot;:&quot;25684-25891&quot;} -->
<h3 class="sectionedit12" id="executed_with_no_parameters">Executed with no parameters</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> Resets jffs2 to original settings, if possible.</div>
</li>
<li class="level1"><div class="li"> If jffs2 is not mounted, erases mtd and attempts format, mount, and pivot jffs2 as root.</div>
</li>
</ul>

<p>
If jffs2 is mounted, <code>firstboot</code> runs hook <code>jffs2reset</code>
</p>
<ol>
<li class="level1"><div class="li"> Determine (and set variable for) MTD rootfs_data partition</div>
</li>
<li class="level1"><div class="li"> Determine (and set variable for) rom partition</div>
</li>
<li class="level1"><div class="li"> Determine (and set variable for) jffs2 partition</div>
</li>
<li class="level1"><div class="li"> Determine (and set variable to indicate) whether the mini overlay filesystem type is supported.</div>
</li>
<li class="level1"><div class="li"> If overlay is supported, remove all files on jffs2 and remount it.</div>
</li>
<li class="level1"><div class="li"> If overlay not supported, create directories and symlinks, copying only certain critical files </div>
</li>
</ol>
<ul>
<li class="level1"><div class="li"> Note: since r35712 the firstboot script requires an inputted &#039;y&#039; as confirmation. If using firstboot in a reset button script, you need to get that y inputted, e.g. by using the yes command:  yes | firstboot</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Executed with no parameters&quot;,&quot;hid&quot;:&quot;executed_with_no_parameters&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:12,&quot;range&quot;:&quot;25892-26789&quot;} -->
<h3 class="sectionedit13" id="executed_with_parameter_switch2jffs">Executed with parameter &#039;switch2jffs&#039;</h3>
<div class="level3">
<ol>
<li class="level1"><div class="li"> Determine (and set variable for) MTD rootfs_data partition</div>
</li>
<li class="level1"><div class="li"> Determine (and set variable for) rom partition</div>
</li>
<li class="level1"><div class="li"> Determine (and set variable for) jffs2 partition</div>
</li>
<li class="level1"><div class="li"> Determine if mini overlay is supported.  If not run hook no_fo</div>
</li>
<li class="level1"><div class="li"> Otherwise, if mounted, skip the rest, otherwise mount under squashfs (<code>/rom/jffs</code>)</div>
</li>
<li class="level1"><div class="li"> Copy ramdisk to jffs2</div>
</li>
<li class="level1"><div class="li"> Move <code>/jffs</code> to <code>/</code> (root) and move <code>/</code> (root) to <code>/rom</code></div>
</li>
<li class="level1"><div class="li"> Cleanup</div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Executed with parameter &#039;switch2jffs&#039;&quot;,&quot;hid&quot;:&quot;executed_with_parameter_switch2jffs&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:13,&quot;range&quot;:&quot;26790-27270&quot;} -->
<h3 class="sectionedit14" id="hook_no_fo">hook no_fo</h3>
<div class="level3">
<ol>
<li class="level1"><div class="li"> Switch to kernel fs, get rid of union overlay and bind from /tmp/root</div>
</li>
<li class="level1"><div class="li"> Mount jffs (and make it safe for union)</div>
</li>
<li class="level1"><div class="li"> If not mounted, mount; copy from squashfs, and pivot so that /jffs is now / (root)</div>
</li>
<li class="level1"><div class="li"> Copy files from ramdisk</div>
</li>
<li class="level1"><div class="li"> Get rid of unnecessary mounts (cleanup)</div>
</li>
</ol>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;hook no_fo&quot;,&quot;hid&quot;:&quot;hook_no_fo&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:14,&quot;range&quot;:&quot;27271-27571&quot;} -->
<h1 class="sectionedit15" id="preinit_operation">Preinit Operation</h1>
<div class="level1">

<p>
Preinit consists of a number of scripts.  The main script is <code>/etc/preinit</code>
which reads in the scripts.  The scripts define functions which they attach to
hooks.  These hooks are, when processed, launching the functions in the order they
were added to the hooks.
</p>

<p>
Currently there are five hooks used by the preinit system:
</p>
<ul>
<li class="level1"><div class="li"> <code>preinit_essential</code></div>
</li>
<li class="level1"><div class="li"> <code>preinit_main</code></div>
</li>
<li class="level1"><div class="li"> <code>failsafe</code></div>
</li>
<li class="level1"><div class="li"> <code>initramfs</code></div>
</li>
<li class="level1"><div class="li"> <code>preinit_mount_root</code></div>
</li>
</ul>

<p>
Each hook have a corresponding string variable containing the name of each function to
be executed, separated by spaces.  The hook variables have <code>_hook</code> appended to
the hook name.  Thus the name of the variable for the <code>preinit_essential</code> hook
is <code>preinit_essential_hook</code>.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Preinit Operation&quot;,&quot;hid&quot;:&quot;preinit_operation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:15,&quot;range&quot;:&quot;27572-28321&quot;} -->
<h2 class="sectionedit16" id="main_preinit_script">Main Preinit Script</h2>
<div class="level2">

<p>
The main preinit script is actually quite empty. It:
</p>
<ol>
<li class="level1"><div class="li"> Initializes some variables (including the hook variables)</div>
</li>
<li class="level1"><div class="li"> Defines the function <code>pi_hook_add</code>, which is used to add functions to a hook</div>
</li>
<li class="level1"><div class="li"> Defines the function <code>pi_run_hook</code>, which executes the functions that were added to a hook</div>
</li>
<li class="level1"><div class="li"> Sources (reads) the shell scripts under folder <code>/lib/preinit/</code>, in glob sort order</div>
</li>
<li class="level1"><div class="li"> Processes the hook <code>preinit_essential</code></div>
</li>
<li class="level1"><div class="li"> Initializes variables used by <code>preinit_main</code></div>
</li>
<li class="level1"><div class="li"> Processes the hook <code>preinit_main</code></div>
</li>
</ol>

<p>
That&#039;s it.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Main Preinit Script&quot;,&quot;hid&quot;:&quot;main_preinit_script&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:16,&quot;range&quot;:&quot;28322-28888&quot;} -->
<h2 class="sectionedit17" id="variables">Variables</h2>
<div class="level2">

<p>
There are a number of variables that control options of preinit.  Defaults are
defined in the main script <code>/etc/preinit</code> defined by the <code>base-files</code> package.
However the variables are customizable via <code>make menuconfig</code>, in section 
“Preinit configuration options”. The OpenWrt build process will then create 
the file <code>/lib/preinit/00_preinit.conf</code> which will be sourced by the main 
script.
</p>

<p>
The variables defined at present are:
</p>
<div class="table sectionedit18"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> Variable           </th><th class="col1 leftalign"> Description                                             </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign"><code>pi_ifname</code>        </td><td class="col1 leftalign"> The device name of the network interface used to emit network messages during preinit (except failsafe)                                 </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"><code>pi_ip</code>            </td><td class="col1 leftalign"> The <abbr title="Internet Protocol">IP</abbr> address of the preinit network (see above)       </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"><code>pi_broadcast</code>     </td><td class="col1"> The broadcast address of the preinit network (see above)</td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign"><code>pi_netmask</code>        </td><td class="col1 leftalign"> The netmask for the preinit network (see above)        </td>
	</tr>
	<tr class="row5">
		<td class="col0"><code>fs_failsafe_wait_timeout</code></td><td class="col1 leftalign"> How long to pause while allowing the user to choose to enter failsafe mode.  Default is two (2) seconds.                       </td>
	</tr>
	<tr class="row6">
		<td class="col0"><code>pi_suppress_stderr</code></td><td class="col1 leftalign"> If this is “y”, then output on standard error (stderr, file descriptor 2), is ignored during preinit.  This is the default in previous versions of OpenWrt (which did not have this option)                           </td>
	</tr>
	<tr class="row7">
		<td class="col0"><code>pi_init_suppress_stderr</code></td><td class="col1 leftalign"> If <code>pi_suppress_stderr</code> is not “y” (i.e. stderr is not suppressed for preinit), then this option controls whether init, and process run by init, except those associated with a terminal device (e.g. <code>tts/0</code>, <code>ttyS0</code>, <code>tty1</code>, <code>pts/0</code>, or other similar devices) will have stderr suppressed (not that network terminals such as those from <abbr title="Secure Shell">SSH</abbr> are associated with a pseudo-terminal device such as <code>pty0/pty1</code> and are thus unaffected).  As with <code>pi_suppress_stderr</code>, the default, and behaviour from previous versions of  OpenWrt is “y”.      </td>
	</tr>
	<tr class="row8">
		<td class="col0 leftalign"><code>pi_init_path</code>      </td><td class="col1 leftalign"> The default search PATH for binaries for commands run by init.  Default is <code>/bin:/sbin:/usr/bin:/usr/sbin</code>                            </td>
	</tr>
	<tr class="row9">
		<td class="col0 leftalign"><code>pi_init_cmd</code>       </td><td class="col1"> The command to run as <code>init</code>.  Default is <code>/sbin/init</code></td>
	</tr>
	<tr class="row10">
		<td class="col0"><code>pi_preinit_no_failsafe_netmsg</code> </td><td class="col1"> suppress netmsg to say that one can enter failsafe mode </td>
	</tr>
	<tr class="row11">
		<td class="col0"><code>pi_preinit_net_messages</code> </td><td class="col1"> If enabled, show more network messages than just the message that one can enter failsafe mode </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table1&quot;,&quot;secid&quot;:18,&quot;range&quot;:&quot;29352-31292&quot;} -->
<p>
There are also variables used in the operation of preinit.  They are:
</p>
<div class="table sectionedit19"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> Variable             </th><th class="col1 leftalign"> Description                                                                    </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"><code>preinit_essential_hook</code></td><td class="col1"> Variable containing hook names to execute, in order, for hook <code>preinit_essential</code></td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"><code>preinit_main_hook</code>     </td><td class="col1 leftalign"> Ditto, for <code>preinit_main</code>                                                        </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"><code>failsafe_hook</code>         </td><td class="col1 leftalign"> Ditto, for <code>failsafe</code>                                                            </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign"><code>initramfs_hook</code>        </td><td class="col1 leftalign"> Ditto, for <code>initramfs</code>                                                           </td>
	</tr>
	<tr class="row5">
		<td class="col0"><code>preinit_mount_root_hook</code></td><td class="col1 leftalign"> Ditto, for <code>preinit_mount_root</code>                                                 </td>
	</tr>
	<tr class="row6">
		<td class="col0 leftalign"><code>pi_mount_skip_next</code>    </td><td class="col1"> During hook <code>preinit_mount_root</code>, skips most steps; usually set by a preceeding step </td>
	</tr>
	<tr class="row7">
		<td class="col0"><code>pi_jffs2_mount_success</code></td><td class="col1"> During hook <code>preinit_mount_root</code>, used by steps following mount attempt to determine which action they should take </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table2&quot;,&quot;secid&quot;:19,&quot;range&quot;:&quot;31365-32306&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Variables&quot;,&quot;hid&quot;:&quot;variables&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:17,&quot;range&quot;:&quot;28889-32307&quot;} -->
<h2 class="sectionedit20" id="hooks">Hooks</h2>
<div class="level2">

<p>
The following sections describe the files and functions used by the various 
hooks.
</p>

<p>
<strong>NB</strong>: The files, even though divided by hook here are all in the single
<code>/lib/preinit</code> directory, and are thus combined in the directory lists, and
are processed in glob sort order, not by hook (when sourcing them, the hooks
specify the order of the execution of functions, which is as listed below)
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Hooks&quot;,&quot;hid&quot;:&quot;hooks&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:20,&quot;range&quot;:&quot;32308-32717&quot;} -->
<h3 class="sectionedit21" id="development">Development</h3>
<div class="level3">

<p>
For the purposes of development, you will locate the files under <code>$ROOTDIR/package/base-files/files/lib/preinit</code>, for the existing files, and you can add new files anywhere that ultimately ends up in <code>/lib/preinit</code> on the router (while in preinit, e.g. not by user edits after read-write is mounted).
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Development&quot;,&quot;hid&quot;:&quot;development&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:21,&quot;range&quot;:&quot;32718-33046&quot;} -->
<h3 class="sectionedit22" id="preinit_essentials">preinit_essentials</h3>
<div class="level3">

<p>
<img src="/lib/images/smileys/exclaim.svg" class="icon smiley" alt=":!:" /> With the introduction of <a href="/docs/techref/procd" class="wikilink1" title="docs:techref:procd" data-wiki-id="docs:techref:procd">procd</a>, effective in Chaos Calmer release, the tasks of this hook are done in c code and at least on some images (verified on a BRCM63xx one) this hook is unused.
</p>

<p>
The preinit_essentials hook takes care of mounting essential kernel
filesystems such as proc, and initializing the console.
</p>

<p>
Files containing the functions executed by this hook
</p>
<div class="table sectionedit23"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> File                </th><th class="col1 leftalign"> Functions                                              </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign">10_essential_fs    </td><td class="col1 leftalign"> do_mount_procfs, do_mount_sysfs, do_mount_tmpfs  </td>
	</tr>
	<tr class="row2">
		<td class="col0">20_device_fs_mount</td><td class="col1 leftalign"> do_mount_devfs, do_mount_hotplug, do_mount_udev, choose_device_fs                                                              </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">30_device_daemons  </td><td class="col1 leftalign"> init_hotplug, init_udev, init_device_fs            </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign">40_init_shm        </td><td class="col1 leftalign"> init_shm                                              </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign">40_pts_mount       </td><td class="col1 leftalign"> do_mount_pts                                         </td>
	</tr>
	<tr class="row6">
		<td class="col0 leftalign">50_choose_console  </td><td class="col1 leftalign"> choose_console                                        </td>
	</tr>
	<tr class="row7">
		<td class="col0 leftalign">60_init_console    </td><td class="col1 leftalign"> init_console                                          </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table3&quot;,&quot;secid&quot;:23,&quot;range&quot;:&quot;33471-34160&quot;} -->
<p>
Functions, in order, executed by this hook (doesn&#039;t list the functions only
called by other functions)
</p>
<div class="table sectionedit24"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function            </th><th class="col1 leftalign"> Description                                             </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign">do_mount_procfs   </td><td class="col1 leftalign"> mounts /proc                                            </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">do_mount_sysfs    </td><td class="col1 leftalign"> mounts /sys                                             </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">do_mount_tmpfs    </td><td class="col1 leftalign"> mounts /tmp                                             </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign">choose_device_fs  </td><td class="col1 leftalign"> determines type of device daemon and the appropriate filesystem to mount on /dev for that device daemon                             </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign">init_device_fs    </td><td class="col1 leftalign"> launches daemons (if any) responsible for population /dev, and/or creating hotplug events when devices are added/removed (and for initial coldplug events)                                                          </td>
	</tr>
	<tr class="row6">
		<td class="col0 leftalign">init_shm          </td><td class="col1 leftalign"> makes sure /dev/shm exists                               </td>
	</tr>
	<tr class="row7">
		<td class="col0 leftalign">init_pts          </td><td class="col1 leftalign"> makes sure /dev/pts exists                               </td>
	</tr>
	<tr class="row8">
		<td class="col0 leftalign">do_mount_pts     </td><td class="col1 leftalign"> mounts devpts on /dev/pts (pseudo-terminals)             </td>
	</tr>
	<tr class="row9">
		<td class="col0 leftalign">choose_console    </td><td class="col1 leftalign"> determines devices for stdin, stdout, and stderr         </td>
	</tr>
	<tr class="row10">
		<td class="col0 leftalign">init_console      </td><td class="col1 leftalign"> activates stdin, stdout, and stderr of preinit (and  subsequent init) (prior to this they are not present in the environment)            </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table4&quot;,&quot;secid&quot;:24,&quot;range&quot;:&quot;34266-35452&quot;} -->
<p>
Functions which are called by other functions, rather than directly as part of a hook
</p>
<div class="table sectionedit25"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function            </th><th class="col1 leftalign"> Description                                             </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign"> do_mount_devfs     </td><td class="col1 leftalign"> mount devfs on /dev                                     </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> do_mount_hotplug   </td><td class="col1 leftalign"> mount tmpfs on /dev (for hotplug)                       </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"> do_mount_udev      </td><td class="col1 leftalign"> mount tmpfs on /dev (for udev)                          </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign"> init_hotplug       </td><td class="col1"> set hotplug handler (actually initiated after console  init) </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign"> init_udev          </td><td class="col1 leftalign"> start udev                                              </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table5&quot;,&quot;secid&quot;:25,&quot;range&quot;:&quot;35541-36031&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;preinit_essentials&quot;,&quot;hid&quot;:&quot;preinit_essentials&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:22,&quot;range&quot;:&quot;33047-36032&quot;} -->
<h3 class="sectionedit26" id="preinit_main">preinit_main</h3>
<div class="level3">

<p>
The <em>preinit_main</em> hook performs all the functions required of preinit,
except those functions, like console, that are essential even for preinit 
tasks.
</p>
<div class="table sectionedit27"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">File                         </th><th class="col1 leftalign"> Description                                    </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign">10_indicate_preinit        </td><td class="col1 leftalign"> preinit_ip, preinit_ip_deconfig, preinit_net_echo, preinit_echo, pi_indicate_led, pi_indicate_preinit                </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">30_failsafe_wait           </td><td class="col1 leftalign"> fs_wait_for_key, failsafe_wait             </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">40_run_failsafe_hook      </td><td class="col1 leftalign"> run_failsafe_hook                            </td>
	</tr>
	<tr class="row4">
		<td class="col0">50_indicate_regular_preinit</td><td class="col1 leftalign"> indicate_regular_preinit_boot           </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign">60_init_hotplug            </td><td class="col1 leftalign"> init_hotplug                                  </td>
	</tr>
	<tr class="row6">
		<td class="col0 leftalign">70_initramfs_test          </td><td class="col1 leftalign"> initramfs_test                                </td>
	</tr>
	<tr class="row7">
		<td class="col0 leftalign">80_mount_root              </td><td class="col1 leftalign"> do_mount_root                                </td>
	</tr>
	<tr class="row8">
		<td class="col0 leftalign">90_restore_config          </td><td class="col1 leftalign"> restore_config                                </td>
	</tr>
	<tr class="row9">
		<td class="col0 leftalign">99_10_run_init            </td><td class="col1 leftalign"> run_init                                      </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table6&quot;,&quot;secid&quot;:27,&quot;range&quot;:&quot;36214-37054&quot;} -->
<p>
Functions, in order, executed by this hook (doesn&#039;t list the functions only
called by other functions)
</p>
<div class="table sectionedit28"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function          </th><th class="col1 leftalign"> Description                                               </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign">init_hotplug     </td><td class="col1 leftalign"> Initialize hotplug, if needed (that is for devfs).  Hotplug or a device daemon is needed so that devices are available for use for preinit                                                                                </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">preinit_ip       </td><td class="col1 leftalign"> Initialize network interface (if one has been defined for as available for preinit)                                                       </td>
	</tr>
	<tr class="row3">
		<td class="col0">pi_indicate_preinit</td><td class="col1 leftalign"> Send messages to console, network, and/or led, depending on which, if any, of these is present which say that we are in preinit mode   </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign">failsafe_wait   </td><td class="col1 leftalign"> Emits messages (to network and console) that indicate the user has the option to enter failsafe mode and wait for the configured period of time (default two seconds) for the user to select failsafe mode                 </td>
	</tr>
	<tr class="row5">
		<td class="col0">run_failsafe_hook </td><td class="col1 leftalign"> If user chooses to enter failsafe mode, run the *failsafe* hook (which at present doesn&#039;t return, which means no more functions from preinit_main get run on this boot)                                                </td>
	</tr>
	<tr class="row6">
		<td class="col0">indicate_regular_preinit_boot</td><td class="col1 leftalign"> Emits messages to network, console, and/or LED depending on which (if any) is present, indicating that it&#039;s a regular boot not a failsafe boot                                                              </td>
	</tr>
	<tr class="row7">
		<td class="col0 leftalign">initramfs_test    </td><td class="col1"> If initramfs is present run the *initramfs* hook and exit</td>
	</tr>
	<tr class="row8">
		<td class="col0 leftalign">do_mount_root    </td><td class="col1"> Executes hook *preinit_mount_root* </td>
	</tr>
	<tr class="row9">
		<td class="col0 leftalign">restore_config    </td><td class="col1 leftalign"> If a previous configuration was stored by sysupgrade, restore it to the rootfs                                                           </td>
	</tr>
	<tr class="row10">
		<td class="col0 leftalign">run_init          </td><td class="col1 leftalign"> Exec the command defined by `pi_init_cmd` with the environment variables defined by `pi_init_env`, plus PATH `pi_init_path`        </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table7&quot;,&quot;secid&quot;:28,&quot;range&quot;:&quot;37160-38966&quot;} -->
<p>
Functions which are called by other functions, rather than directly as part of a hook.
</p>
<div class="table sectionedit29"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function            </th><th class="col1 leftalign"> Description                                             </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">preinit_ip_deconfig </td><td class="col1"> deconfigure interface used for preinit network messages etc </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">preinit_net_echo    </td><td class="col1 leftalign"> emit a message on the preinit network interface         </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">preinit_echo        </td><td class="col1 leftalign"> emit a message on the (serial) console                  </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign">pi_indicate_led     </td><td class="col1 leftalign"> set LED status to indicate preinit mode                 </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign">fs_wait_for_key     </td><td class="col1"> wait for reset button press, CTRL-C, or &lt;some_key&gt;&lt;ENTER&gt;, with timeout</td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table8&quot;,&quot;secid&quot;:29,&quot;range&quot;:&quot;39056-39560&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;preinit_main&quot;,&quot;hid&quot;:&quot;preinit_main&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:26,&quot;range&quot;:&quot;36033-39561&quot;} -->
<h3 class="sectionedit30" id="failsafe1">failsafe</h3>
<div class="level3">

<p>
Do what needs to done to prepare failsafe mode and enter it.
</p>
<div class="table sectionedit31"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">File                  </th><th class="col1 leftalign"> Description                                           </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">10_indicate_failsafe</td><td class="col1 leftalign"> indicate_failsafe_led, indicate_failsafe           </td>
	</tr>
	<tr class="row2">
		<td class="col0">99_10_failsafe_login</td><td class="col1 leftalign"> failsafe_netlogin, failsafe_shell                  </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table9&quot;,&quot;secid&quot;:31,&quot;range&quot;:&quot;39644-39876&quot;} -->
<p>
Functions, in order, executed by this hook (doesn&#039;t list the functions only
called by other functions)
</p>
<div class="table sectionedit32"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function             </th><th class="col1 leftalign"> Description                                            </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign">indicate_failsafe   </td><td class="col1 leftalign"> Emit message/status to network, console, and/or LED (depending on which, if any, are present) indicating that the device is now in failsafe mode                                                                       </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">failsafe_netlogin   </td><td class="col1 leftalign"> Launch telnet daemon to allow telnet login on the defined network interface (if any)                                                   </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">failsafe_shell      </td><td class="col1 leftalign"> Launch a shell for access via serial console (if present)                                                                              </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table10&quot;,&quot;secid&quot;:32,&quot;range&quot;:&quot;39982-40622&quot;} -->
<p>
Functions which are called by other functions, rather than directly as part of a hook
</p>
<div class="table sectionedit33"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function            </th><th class="col1 leftalign"> Description                                             </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">indicate_failsafe_led</td><td class="col1 leftalign"> set LED status to indicate preinit mode                </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table11&quot;,&quot;secid&quot;:33,&quot;range&quot;:&quot;40712-40873&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;failsafe&quot;,&quot;hid&quot;:&quot;failsafe1&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:30,&quot;range&quot;:&quot;39562-40874&quot;} -->
<h3 class="sectionedit34" id="preinit_mount_root">preinit_mount_root</h3>
<div class="level3">

<p>
Mount the root filesystem
</p>
<div class="table sectionedit35"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">File                  </th><th class="col1 leftalign"> Description                                           </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign">05_mount_skip         </td><td class="col1 leftalign"> check_skip                                            </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">10_check_for_mtd      </td><td class="col1 leftalign"> mount_no_mtd, check_for_mtd                           </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table12&quot;,&quot;secid&quot;:35,&quot;range&quot;:&quot;40932-41174&quot;} -->
<p>
Functions, in order, executed by this hook (doesn&#039;t list the functions only
called by other functions)
</p>
<div class="table sectionedit36"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function             </th><th class="col1 leftalign"> Description                                            </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign">check_for_mtd        </td><td class="col1"> Check for a mtd partition named rootfs_data.  If not present mount kernel fs as root (e.g. all_jjfs2 or squashfs only) and skip rest. </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">check_for_jffs2      </td><td class="col1"> Check if jffs2 formatted yet.  If not, mount ramoverlay and skip rest </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">do_mount_jffs2       </td><td class="col1"> find jffs2 partition and mount it, indicating result </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign">rootfs_pivot         </td><td class="col1"> if jffs2 mounted, make it root (/) and old root (squashfs) /rom , skipping rest on success</td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign">do_mount_no_jffs2    </td><td class="col1"> If nothing was mounted so far, mount ramdisk (ram overlay), skipping rest on success</td>
	</tr>
	<tr class="row6">
		<td class="col0 leftalign">do_mount_no_mtd      </td><td class="col1"> If there was nothing mounted , mount /dev/root as root (/) </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table13&quot;,&quot;secid&quot;:36,&quot;range&quot;:&quot;41281-42007&quot;} -->
<p>
Functions which are called by other functions, rather than directly as part of a hook
</p>
<div class="table sectionedit37"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function            </th><th class="col1 leftalign"> Description                                             </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign">mount_no_mtd        </td><td class="col1"> if there is not mtd partition named rootfs_data, mount /dev/root as / (root).  E.g. this can occur if the firmware filesystem is entirely a jffs2 partition, with no squashfs) </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">mount_no_jffs2      </td><td class="col1"> mount ramdisk (ram overlay) if there is rootfs_data, but it has not been formatted yet) </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">find_mount_jffs2    </td><td class="col1 leftalign"> find and mount rootfs_data jffs2 partition on /jffs     </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign">jffs2_not_mounted   </td><td class="col1 leftalign"> returns true (0) if jffs2 is not mounted                </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table14&quot;,&quot;secid&quot;:37,&quot;range&quot;:&quot;42096-42651&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;preinit_mount_root&quot;,&quot;hid&quot;:&quot;preinit_mount_root&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:34,&quot;range&quot;:&quot;40875-42652&quot;} -->
<h3 class="sectionedit38" id="initramfs">initramfs</h3>
<div class="level3">

<p>
No files or functions at this time.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;initramfs&quot;,&quot;hid&quot;:&quot;initramfs&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:38,&quot;range&quot;:&quot;42653-42710&quot;} -->
<h1 class="sectionedit39" id="firstboot_operation">Firstboot Operation</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Firstboot Operation&quot;,&quot;hid&quot;:&quot;firstboot_operation&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:39,&quot;range&quot;:&quot;42711-42745&quot;} -->
<h2 class="sectionedit40" id="main_firstboot_script">Main Firstboot Script</h2>
<div class="level2">
<ol>
<li class="level1"><div class="li"> Source common functions</div>
</li>
<li class="level1"><div class="li"> Source functions for hooks</div>
</li>
<li class="level1"><div class="li"> if block:</div>
</li>
</ol>

<p>
    if invoked as executable
</p>
<pre class="code">       if called with `switch2jffs` parameter (i.e. from rcS)
           run hook `switch2jffs`
       if called standalone (e.g. from commandline)
           if there is a jffs2 partition mounted
                run hook `jffs2reset`
           else
                erase rootfs_data mtd partition
                format
                and remount it
           end
       end
 if sourced (that is not executed)
      set some variables
 end</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Main Firstboot Script&quot;,&quot;hid&quot;:&quot;main_firstboot_script&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:40,&quot;range&quot;:&quot;42746-43355&quot;} -->
<h2 class="sectionedit41" id="hooks1">Hooks</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Hooks&quot;,&quot;hid&quot;:&quot;hooks1&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:41,&quot;range&quot;:&quot;43356-43374&quot;} -->
<h3 class="sectionedit42" id="switch2jffs">switch2jffs</h3>
<div class="level3">

<p>
Make the filesystem that we want to be the rootfs, to be the rootfs
</p>
<div class="table sectionedit43"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">File                  </th><th class="col1 leftalign"> Description                                           </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign">10_determine_parts  </td><td class="col1">deterimine_mtd_part, determine_rom_part, determine_jffs2_part, set_mtd_part, set_rom_part, set_jffs2_part </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">20_has_mini_fo     </td><td class="col1 leftalign">check_for_mini_fo                                   </td>
	</tr>
	<tr class="row3">
		<td class="col0">30_is_rootfs_mounted</td><td class="col1 leftalign">skip_if_rootfs_mounted                             </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign">40_copy_ramoverlay  </td><td class="col1 leftalign">copy_ramoverlay                                       </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign">50_pivot              </td><td class="col1 leftalign">with_fo_pivot                                        </td>
	</tr>
	<tr class="row6">
		<td class="col0">99_10_with_fo_cleanup </td><td class="col1 leftalign"> with_fo_cleanup                                 </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table15&quot;,&quot;secid&quot;:43,&quot;range&quot;:&quot;43467-44059&quot;} -->
<p>
Functions, in order, executed by this hook (doesn&#039;t list the functions only
called by other functions)
</p>
<div class="table sectionedit44"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function             </th><th class="col1 leftalign"> Description                                            </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">determine_mtd_part </td><td class="col1 leftalign"> exit if no mtd partition at all                         </td>
	</tr>
	<tr class="row2">
		<td class="col0">determine_rom_part </td><td class="col1"> exit if not squashfs partition (firstboot not for all_jffs2) </td>
	</tr>
	<tr class="row3">
		<td class="col0">determine_jffs2_part</td><td class="col1"> figure out the jffs2 partition (assuming we have an mtd part</td>
	</tr>
	<tr class="row4">
		<td class="col0">check_for_mini_fo </td><td class="col1"> determine if we have mini_fo overlay in kernel.  If not run *no_fo* hook</td>
	</tr>
	<tr class="row5">
		<td class="col0">skip_if_rootfs_mounted</td><td class="col1"> attempt mount jffs2 on /rom/jffs2.  If partition already mounted exit </td>
	</tr>
	<tr class="row6">
		<td class="col0 leftalign">copy_ramoverlay     </td><td class="col1">copy the data from the temporary rootfs (on the ramdisk overlay over the squashfs) to the new jffs2 partition </td>
	</tr>
	<tr class="row7">
		<td class="col0 leftalign">with_fo_pivot      </td><td class="col1">make current jffs2 partition the root partition and the current root /rom </td>
	</tr>
	<tr class="row8">
		<td class="col0 leftalign">with_fo_cleanup    </td><td class="col1 leftalign">clean up unneeded mount of ramdisk, if possible          </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table16&quot;,&quot;secid&quot;:44,&quot;range&quot;:&quot;44165-44998&quot;} -->
<p>
Functions which are called by other functions, rather than directly as part of a hook
</p>
<div class="table sectionedit45"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function              </th><th class="col1 leftalign"> Description                                             </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign">set_mtd_part        </td><td class="col1 leftalign"> set variables for mtd partition                         </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">set_rom_part        </td><td class="col1 leftalign"> set variable for squashfs (rom) partition               </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">set_jffs_part       </td><td class="col1 leftalign"> set variable for jffs2 partition                        </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table17&quot;,&quot;secid&quot;:45,&quot;range&quot;:&quot;45088-45413&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;switch2jffs&quot;,&quot;hid&quot;:&quot;switch2jffs&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:42,&quot;range&quot;:&quot;43375-45414&quot;} -->
<h3 class="sectionedit46" id="no_fo">no_fo</h3>
<div class="level3">

<p>
Make the filesystem that we want to be the rootfs, to be the rootfs, given that we have no mini\_fo overlay filesystem
</p>
<div class="table sectionedit47"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">File                  </th><th class="col1 leftalign"> Description                                           </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">10_no_fo_clear_overlay </td><td class="col1 leftalign">no_fo_clear_overlay                            </td>
	</tr>
	<tr class="row2">
		<td class="col0">20_no_fo_mount_jffs </td><td class="col1 leftalign"> no_fo_mount_jffs                                 </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">30_no_fo_pivot     </td><td class="col1 leftalign"> no_fo_pivot                                         </td>
	</tr>
	<tr class="row4">
		<td class="col0">40_no_fo_copy_ram_overlay </td><td class="col1 leftalign"> no_fo_copy_ram_overlay                   </td>
	</tr>
	<tr class="row5">
		<td class="col0">99_10_no_fo_cleanup </td><td class="col1 leftalign"> no_fo_cleanup                                     </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table18&quot;,&quot;secid&quot;:47,&quot;range&quot;:&quot;45552-46003&quot;} -->
<p>
Functions, in order, executed by this hook (doesn&#039;t list the functions only
called by other functions)
</p>
<div class="table sectionedit48"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function             </th><th class="col1 leftalign"> Description                                            </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">no_fo_clear_overlay </td><td class="col1 leftalign"> stop ramdisk overlaying the squashfs                 </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">no_fo_mount_jffs  </td><td class="col1"> attempt to mount jffs (work around problem with union).  If already mounted exit </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">no_fo_pivot        </td><td class="col1 leftalign"> make jffs root and old root /rom                       </td>
	</tr>
	<tr class="row4">
		<td class="col0">no_fo_copy_ram_overlay</td><td class="col1"> copy data from ram overlay to jffs2 overlay of squashfs </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign">no_fo_cleanup      </td><td class="col1 leftalign"> get rid of extra binds and mounts                      </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table19&quot;,&quot;secid&quot;:48,&quot;range&quot;:&quot;46109-46612&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;no_fo&quot;,&quot;hid&quot;:&quot;no_fo&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:46,&quot;range&quot;:&quot;45415-46613&quot;} -->
<h3 class="sectionedit49" id="jffs2reset">jffs2reset</h3>
<div class="level3">

<p>
Reset jffs2 to defaults
</p>
<div class="table sectionedit50"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">File                  </th><th class="col1 leftalign"> Description                                           </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">10_rest_has_mini_fo </td><td class="col1 leftalign"> reset_check_for_mini_fo                         </td>
	</tr>
	<tr class="row2">
		<td class="col0">20_reset_clear_jffs </td><td class="col1 leftalign"> reset_clear_jffs                                   </td>
	</tr>
	<tr class="row3">
		<td class="col0">30_reset_copy_rom </td><td class="col1 leftalign"> reset_copy_rom                                       </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table20&quot;,&quot;secid&quot;:50,&quot;range&quot;:&quot;46661-46966&quot;} -->
<p>
Functions, in order, executed by this hook (doesn&#039;t list the functions only
called by other functions)
</p>
<div class="table sectionedit51"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Function             </th><th class="col1 leftalign"> Description                                            </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0">reset_check_for_mini_fo </td><td class="col1"> Determine if the kernel supports mini_fo overlay</td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">reset_clear_jffs   </td><td class="col1"> if mini_fo is supported, erase all data in overlay and remount (resets back to &#039;pure&#039; squashfs versions </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">reset_copy_rom     </td><td class="col1"> if mini_fo is not supported, make symlinks and copy critical files from squashfs to jffs </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table21&quot;,&quot;secid&quot;:51,&quot;range&quot;:&quot;47072-47470&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;jffs2reset&quot;,&quot;hid&quot;:&quot;jffs2reset&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:49,&quot;range&quot;:&quot;46614-47471&quot;} -->
<h1 class="sectionedit52" id="customizing_the_system">Customizing the system</h1>
<div class="level1">

<p>
<strong>NB</strong>: These files must be added to the *squashfs* (or if using a all_jffs2 system, to the jffs2).  That means, for instance adding it to the image&#039;s rootfs.  This can be done, for instace, by creating `${ROOTDIR}/files/filename` (with appropriate substitutions of course).
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Customizing the system&quot;,&quot;hid&quot;:&quot;customizing_the_system&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:52,&quot;range&quot;:&quot;47472-47785&quot;} -->
<h2 class="sectionedit53" id="overriding_example">Overriding Example</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:dangerous&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:54,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:dangerous" id="plugin_include__meta__infobox__dangerous">
<div class="level2">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:56,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_center wrap_dangerous plugin_wrap" style="width: 70%;">
<p>
<strong>Warning!</strong><br/>

This section describes actions that might damage your device or firmware. Proceed with care!
</p>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:57,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:dangerous&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:55,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level2">

<p>
Customizing the system is quite simple.  We give an example of changing the message for preinit from &#039;- preinit -&#039; to &#039;- setting the table for dinner -&#039;
</p>

<p>
Create a file that replaces the function `indicate_regular_preinit_boot`.
`pi_indicate_preinit` is defined in `20_indicate_preinit`, so we define our replace functions in `25_dinner_not_router`.
</p>

<p>
`/lib/preinit/25_dinner_not_router`
</p>
<pre class="code">   pi_indicate_preinit() { 
         echo &quot;- setting the table for dinner -&quot;
         preinit_net_echo &quot;Dinner is just about ready!&quot;
         pi_indicate_led
   }
   </pre>

<p>
This results in the following boot log:
</p>
<pre class="code">NET: Registered protocol family 17
802.1Q VLAN Support v1.8 Ben Greear &lt;greearb@candelatech.com&gt;
All bugs added by David S. Miller &lt;davem@redhat.com&gt;
VFS: Mounted root (squashfs filesystem) readonly on device 31:2.
Freeing unused kernel memory: 132k freed
Please be patient, while OpenWrt loads ...
eth1: link forced UP - 100/full - flow control off/off
- setting the table for dinner -
Press CTRL-C or Press f&lt;ENTER&gt; to enter failsafe mode
switching to jffs2
mini_fo: using base directory: /
mini_fo: using storage directory: /jffs
- init -</pre>

<p>
The default boot log is
</p>
<pre class="code">NET: Registered protocol family 17
802.1Q VLAN Support v1.8 Ben Greear &lt;greearb@candelatech.com&gt;
All bugs added by David S. Miller &lt;davem@redhat.com&gt;
VFS: Mounted root (squashfs filesystem) readonly on device 31:2.
Freeing unused kernel memory: 132k freed
Please be patient, while OpenWrt loads ...
eth1: link forced UP - 100/full - flow control off/off
- preinit -
Press CTRL-C or Press f&lt;ENTER&gt; to enter failsafe mode
switching to jffs2
mini_fo: using base directory: /
mini_fo: using storage directory: /jffs
- init -
   </pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Overriding Example&quot;,&quot;hid&quot;:&quot;overriding_example&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:53,&quot;range&quot;:&quot;47786-49607&quot;} -->
<h2 class="sectionedit58" id="adding_example">Adding Example</h2>
<div class="level2">

<p>
As another example we will add a message to failsafe, between the notice that we&#039;re in failsafe mode in the shell.  You could use this, for example, to create a text menu system, or to launch a simple web server (with cgi scripts) to permit the user to do failsafe things.
</p>

<p>
We want to add the message, &#039;Remember, at this point there are no writable filesystems&#039;
</p>

<p>
We create the file `50_failsafe_remember_no_rw`, in `/lib/preinit`
</p>
<pre class="code">  remember_no_rw() {
      echo &quot;Remember, at this point there are no writable filesystems&quot;
  }
  
  boot_hook_add failsafe remember_no_rw
  </pre>

<p>
This creates the function `remember_no_rw` and adds it to the failsafe hook, in between `10_indicate_failsafe` and `99_10_failsafe_login` which define the other functions in the `failsafe` hook.  This wasn&#039;t necessary for the previous example because the function was already in a hook.
</p>

<p>
The boot log for this, when entering failsafe, is:
</p>
<pre class="code">VFS: Mounted root (squashfs filesystem) readonly on device 31:2.
Freeing unused kernel memory: 132k freed
Please be patient, while OpenWrt loads ...
eth1: link forced UP - 100/full - flow control off/off
- preinit -
Press CTRL-C or Press f&lt;ENTER&gt; to enter failsafe mode
f
- failsafe -
Remember, at this point there are no writable filesystems</pre>
<pre class="code">BusyBox v1.15.3 (2010-01-20 19:26:26 EST) built-in shell (ash)
Enter &#039;help&#039; for a list of built-in commands.</pre>
<pre class="code">ash: can&#039;t access tty; job control turned off</pre>
<pre class="code">  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
                |__| W I R E L E S S   F R E E D O M</pre>
<pre class="code"> KAMIKAZE (bleeding edge, r19235) ------------------
  * 10 oz Vodka       Shake well with ice and strain
  * 10 oz Triple sec  mixture into 10 shot glasses.
  * 10 oz lime juice  Salute!
 ---------------------------------------------------</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Adding Example&quot;,&quot;hid&quot;:&quot;adding_example&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:58,&quot;range&quot;:&quot;49608-51587&quot;} -->
<h1 class="sectionedit59" id="architecture-specific_notes">Architecture-specific notes</h1>
<div class="level1">

<p>
Some architectures have additional files and functions (or overrides of the above functions) in order to accommodate specific needs of that hardware.  In that case the files are located in the source tree under <code>$ROOTDIR/target/linux/&lt;architecture[/subarch]/base-files/lib/preinit</code>.  During build they are merged and appear under <code>/lib/preinit</code> along with the rest.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Architecture-specific notes&quot;,&quot;hid&quot;:&quot;architecture-specific_notes&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:59,&quot;range&quot;:&quot;51588-&quot;} -->