
<h1 class="sectionedit1" id="imagemakefile_details">image/Makefile Details</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:wip&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:wip" id="plugin_include__meta__infobox__wip">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_center wrap_wip plugin_wrap" style="width: 70%;">
<p>
<strong>Work in Progress!</strong><br/>

This page is a continuous work in progress. You can edit this page to contribute information. 
</p>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:wip&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">
<ul>
<li class="level1"><div class="li"> I think its(this page) needed to clarify the intent, preferred style and function of the image/Makefile.</div>
</li>
<li class="level1 node"><div class="li"> I believe one of the following should be placed here:</div>
<ul>
<li class="level2"><div class="li"> Adding a new platform (new buildroot howto section?)</div>
</li>
<li class="level2"><div class="li"> OpenWrt Buildroot - new platform (new page/how-to on adding platform support to the buildroot system)</div>
</li>
</ul>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;image\/Makefile Details&quot;,&quot;hid&quot;:&quot;imagemakefile_details&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-427&quot;} -->
<h2 class="sectionedit6" id="imagemakefile_from_scratch_or_modify">image/Makefile from scratch or modify</h2>
<div class="level2">

<p>
Inside your platform directory you will need to create a file to tell the buildroot system how to process the results of a compiled kernel. Most of the work is done automatically by image.mk but different platforms and individual devices will need specific work for images to be useful.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;image\/Makefile from scratch or modify&quot;,&quot;hid&quot;:&quot;imagemakefile_from_scratch_or_modify&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;428-765&quot;} -->
<h2 class="sectionedit7" id="basic_function">Basic Function</h2>
<div class="level2">

<p>
See example.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Basic Function&quot;,&quot;hid&quot;:&quot;basic_function&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;766-806&quot;} -->
<h3 class="sectionedit8" id="imageprepare">Image/Prepare</h3>
<div class="level3">

<p>
Can be used to append data to image but often used simply to move to another directory such as $(KDIR)
</p>

<p>
Example:
</p>
<pre class="code">cat $(LINUX_DIR)/arch/arm/boot/zImage &gt;&gt; $(KDIR)/$(call zimage_name,$(1))</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Image\/Prepare&quot;,&quot;hid&quot;:&quot;imageprepare&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;807-1020&quot;} -->
<h3 class="sectionedit9" id="imagebuildinitramfs">Image/Build/Initramfs</h3>
<div class="level3">

<p>
This section allows automated modification of the elf file before loading onto the device.
The file can be found with this line 
</p>
<pre class="code">$(BIN_DIR)/$(IMG_PREFIX)-vmlinux.elf</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Image\/Build\/Initramfs&quot;,&quot;hid&quot;:&quot;imagebuildinitramfs&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;1021-1221&quot;} -->
<h3 class="sectionedit10" id="imagebuildjffs2-64k">Image/Build/jffs2-64k</h3>
<div class="level3">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Image\/Build\/jffs2-64k&quot;,&quot;hid&quot;:&quot;imagebuildjffs2-64k&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:10,&quot;range&quot;:&quot;1222-1254&quot;} -->
<h3 class="sectionedit11" id="imagebuildjffs2-128k">Image/Build/jffs2-128k</h3>
<div class="level3">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Image\/Build\/jffs2-128k&quot;,&quot;hid&quot;:&quot;imagebuildjffs2-128k&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:11,&quot;range&quot;:&quot;1255-1288&quot;} -->
<h3 class="sectionedit12" id="imagebuildsquashfs">Image/Build/squashfs</h3>
<div class="level3">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Image\/Build\/squashfs&quot;,&quot;hid&quot;:&quot;imagebuildsquashfs&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:12,&quot;range&quot;:&quot;1289-1320&quot;} -->
<h3 class="sectionedit13" id="imagebuild">Image/Build</h3>
<div class="level3">

<p>
Appears to be used to call the other build defines (squashfs, jffs2-64k, jffs2-128k, etc)
after they were processed and their resulting files were placed into $(TARGET_DIR)
</p>

<p>
to call a define for each use:
</p>
<pre class="code">$(call Image/Build/$(1),$(1))</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Image\/Build&quot;,&quot;hid&quot;:&quot;imagebuild&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:13,&quot;range&quot;:&quot;1321-1580&quot;} -->
<h2 class="sectionedit14" id="example">Example</h2>
<div class="level2">

<p>
Example of: <strong>trunk/target/linux<em>/platform</em>/image/Makefile</strong>
</p>
<pre class="code make"><span class="co1"># </span>
<span class="co1"># Copyright (C) 2010 OpenWrt.org</span>
<span class="co1">#</span>
<span class="co1"># This is free software, licensed under the GNU General Public License v2.</span>
<span class="co1"># See /LICENSE for more information.</span>
<span class="co1">#</span>
<span class="kw1">include</span> <span class="sy0">$</span><span class="br0">&#40;</span><span class="re2">TOPDIR</span><span class="br0">&#41;</span><span class="sy0">/</span>rules<span class="sy0">.</span>mk
<span class="kw1">include</span> <span class="sy0">$</span><span class="br0">&#40;</span><span class="re2">INCLUDE_DIR</span><span class="br0">&#41;</span><span class="sy0">/</span>image<span class="sy0">.</span>mk
&nbsp;
define Image<span class="sy0">/</span>Prepare
&nbsp;
endef
&nbsp;
define Image<span class="sy0">/</span>Build<span class="sy0">/</span>Initramfs
	<span class="sy0">$</span><span class="br0">&#40;</span><span class="re2">BIN_DIR</span><span class="br0">&#41;</span><span class="sy0">/$</span><span class="br0">&#40;</span><span class="re2">IMG_PREFIX</span><span class="br0">&#41;</span><span class="sy0">-</span>vmlinux<span class="sy0">.</span>elf
endef
&nbsp;
define Image<span class="sy0">/</span>BuildKernel
&nbsp;
endef
&nbsp;
define Image<span class="sy0">/</span>Build<span class="sy0">/</span>jffs2<span class="sy0">-</span>64k
	dd if<span class="sy0">=$</span><span class="br0">&#40;</span><span class="re2">KDIR</span><span class="br0">&#41;</span><span class="sy0">/</span>root<span class="sy0">.$</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span> of<span class="sy0">=$</span><span class="br0">&#40;</span><span class="re2">BIN_DIR</span><span class="br0">&#41;</span><span class="sy0">/</span>openwrt<span class="sy0">-$</span><span class="br0">&#40;</span><span class="re2">BOARD</span><span class="br0">&#41;</span><span class="sy0">-$</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">.</span>img bs<span class="sy0">=</span><span class="nu0">65536</span> conv<span class="sy0">=</span>sync
endef
&nbsp;
define Image<span class="sy0">/</span>Build<span class="sy0">/</span>jffs2<span class="sy0">-</span>128k
	dd if<span class="sy0">=$</span><span class="br0">&#40;</span><span class="re2">KDIR</span><span class="br0">&#41;</span><span class="sy0">/</span>root<span class="sy0">.$</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span> of<span class="sy0">=$</span><span class="br0">&#40;</span><span class="re2">BIN_DIR</span><span class="br0">&#41;</span><span class="sy0">/</span>openwrt<span class="sy0">-$</span><span class="br0">&#40;</span><span class="re2">BOARD</span><span class="br0">&#41;</span><span class="sy0">-$</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">.</span>img bs<span class="sy0">=</span><span class="nu0">131072</span> conv<span class="sy0">=</span>sync
endef
&nbsp;
define Image<span class="sy0">/</span>Build<span class="sy0">/</span>squashfs
	<span class="sy0">$</span><span class="br0">&#40;</span><span class="re1">call</span> prepare_generic_squashfs<span class="sy0">,$</span><span class="br0">&#40;</span><span class="re2">KDIR</span><span class="br0">&#41;</span><span class="sy0">/</span>root<span class="sy0">.</span>squashfs<span class="br0">&#41;</span>
endef
&nbsp;
define Image<span class="sy0">/</span>Build
	<span class="sy0">$</span><span class="br0">&#40;</span><span class="re1">call</span> Image<span class="sy0">/</span>Build<span class="sy0">/$</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">,$</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
endef</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Example&quot;,&quot;hid&quot;:&quot;example&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:14,&quot;range&quot;:&quot;1581-2424&quot;} -->
<h2 class="sectionedit15" id="see_also">See also</h2>
<div class="level2">

<p>
have a look at your copy of <strong>trunk/include/image.mk</strong>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;See also&quot;,&quot;hid&quot;:&quot;see_also&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:15,&quot;range&quot;:&quot;2425-2501&quot;} -->
<h1 class="sectionedit16" id="platformdevice_configuration_files">Platform/Device configuration files</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Platform\/Device configuration files&quot;,&quot;hid&quot;:&quot;platformdevice_configuration_files&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:16,&quot;range&quot;:&quot;2502-2551&quot;} -->
<h2 class="sectionedit17" id="config-4x">config-4.x</h2>
<div class="level2">

<p>
Kernel options required by the platform + kernel version.
</p>
<pre class="code make">CONFIG_QCOM_PM<span class="sy0">=</span>y
CONFIG_QCOM_QFPROM<span class="sy0">=</span>y
CONFIG_QCOM_RPMCC<span class="sy0">=</span>y</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;config-4.x&quot;,&quot;hid&quot;:&quot;config-4x&quot;,&quot;codeblockOffset&quot;:1,&quot;secid&quot;:17,&quot;range&quot;:&quot;2552-2712&quot;} -->
<h2 class="sectionedit18" id="files-4x">files-4.x</h2>
<div class="level2">

<p>
Kernel specific device source. Primarily the location of device DTS files. You will need to add a new device dts here and reference in image/Makefile under DEVICE_DTS.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;files-4.x&quot;,&quot;hid&quot;:&quot;files-4x&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:18,&quot;range&quot;:&quot;2713-2903&quot;} -->
<h2 class="sectionedit19" id="patches-4x">patches-4.x</h2>
<div class="level2">

<p>
Kernel source additions. No changes for basic device additions.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;patches-4.x&quot;,&quot;hid&quot;:&quot;patches-4x&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:19,&quot;range&quot;:&quot;2904-2992&quot;} -->
<h2 class="sectionedit20" id="makefile">Makefile</h2>
<div class="level2">

<p>
Platform wide device definition and common package set. Generally does not require modification when adding additional platform devices.
</p>
<pre class="code make"><span class="kw1">include</span> <span class="sy0">$</span><span class="br0">&#40;</span><span class="re2">TOPDIR</span><span class="br0">&#41;</span><span class="sy0">/</span>rules<span class="sy0">.</span>mk
&nbsp;
ARCH<span class="sy0">:=</span>arm
BOARD<span class="sy0">:=</span>ipq806x
BOARDNAME<span class="sy0">:=</span>Qualcomm Atheros IPQ806X
FEATURES<span class="sy0">:=</span>squashfs nand fpu ramdisk
CPU_TYPE<span class="sy0">:=</span>cortex<span class="sy0">-</span>a15
CPU_SUBTYPE<span class="sy0">:=</span>neon<span class="sy0">-</span>vfpv4
MAINTAINER<span class="sy0">:=</span>John Crispin <span class="sy0">&lt;</span>john<span class="sy0">@</span>phrozen<span class="sy0">.</span>org<span class="sy0">&gt;</span>
&nbsp;
KERNEL_PATCHVER<span class="sy0">:=</span><span class="nu0">4.14</span>
&nbsp;
KERNELNAME<span class="sy0">:=</span>zImage Image dtbs
&nbsp;
<span class="kw1">include</span> <span class="sy0">$</span><span class="br0">&#40;</span><span class="re2">INCLUDE_DIR</span><span class="br0">&#41;</span><span class="sy0">/</span>target<span class="sy0">.</span>mk
DEFAULT_PACKAGES <span class="sy0">+=</span> \
	kmod<span class="sy0">-</span>leds<span class="sy0">-</span>gpio kmod<span class="sy0">-</span>gpio<span class="sy0">-</span>button<span class="sy0">-</span>hotplug swconfig \
	kmod<span class="sy0">-</span>ata<span class="sy0">-</span>core kmod<span class="sy0">-</span>ata<span class="sy0">-</span>ahci kmod<span class="sy0">-</span>ata<span class="sy0">-</span>ahci<span class="sy0">-</span>platform \
	kmod<span class="sy0">-</span>usb<span class="sy0">-</span>core kmod<span class="sy0">-</span>usb<span class="sy0">-</span>ohci kmod<span class="sy0">-</span>usb2 kmod<span class="sy0">-</span>usb<span class="sy0">-</span>ledtrig<span class="sy0">-</span>usbport \
	kmod<span class="sy0">-</span>usb3 kmod<span class="sy0">-</span>usb<span class="sy0">-</span>dwc3<span class="sy0">-</span>of<span class="sy0">-</span>simple kmod<span class="sy0">-</span>usb<span class="sy0">-</span>phy<span class="sy0">-</span>qcom<span class="sy0">-</span>dwc3 \
	kmod<span class="sy0">-</span>ath10k<span class="sy0">-</span>ct wpad<span class="sy0">-</span>basic \
	uboot<span class="sy0">-</span>envtools
&nbsp;
<span class="sy0">$</span><span class="br0">&#40;</span><span class="re1">eval</span> <span class="sy0">$</span><span class="br0">&#40;</span><span class="re1">call</span> BuildTarget<span class="br0">&#41;</span><span class="br0">&#41;</span></pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Makefile&quot;,&quot;hid&quot;:&quot;makefile&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:20,&quot;range&quot;:&quot;2993-3802&quot;} -->
<h2 class="sectionedit21" id="imagemakefile">image/Makefile</h2>
<div class="level2">

<p>
Device specific image creation parameters and image generation functions.
</p>
<pre class="code make">define Device<span class="sy0">/</span>zyxel_nbg6817
	DEVICE_DTS <span class="sy0">:=</span> qcom<span class="sy0">-</span>ipq8065<span class="sy0">-</span>nbg6817
	KERNEL_SIZE <span class="sy0">:=</span> 4096k
	BLOCKSIZE <span class="sy0">:=</span> 64k
	BOARD_NAME <span class="sy0">:=</span> nbg6817
	RAS_BOARD <span class="sy0">:=</span> NBG6817
	RAS_ROOTFS_SIZE <span class="sy0">:=</span> 20934k
	RAS_VERSION <span class="sy0">:=</span> <span class="st0">&quot;V1.99(OWRT.9999)C0&quot;</span>
	SUPPORTED_DEVICES <span class="sy0">+=</span> nbg6817
	DEVICE_VENDOR <span class="sy0">:=</span> ZyXEL
	DEVICE_MODEL <span class="sy0">:=</span> NBG6817
	DEVICE_PACKAGES <span class="sy0">:=</span> ath10k<span class="sy0">-</span>firmware<span class="sy0">-</span>qca9984<span class="sy0">-</span>ct e2fsprogs kmod<span class="sy0">-</span>fs<span class="sy0">-</span>ext4 losetup
	<span class="sy0">$</span><span class="br0">&#40;</span><span class="re1">call</span> Device<span class="sy0">/</span>ZyXELImage<span class="br0">&#41;</span>
endef
TARGET_DEVICES <span class="sy0">+=</span> zyxel_nbg6817</pre>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;image\/Makefile&quot;,&quot;hid&quot;:&quot;imagemakefile&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:21,&quot;range&quot;:&quot;3803-4360&quot;} -->
<h2 class="sectionedit22" id="base-files">base-files</h2>
<div class="level2">

<p>
Initialization scripts. Instantiation of LED, wifi and upgrade/install routines. etc. Many changes needed to add new device.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;base-files&quot;,&quot;hid&quot;:&quot;base-files&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:22,&quot;range&quot;:&quot;4361-4509&quot;} -->
<h2 class="sectionedit23" id="profiles00-defaultmk">profiles/00-default.mk</h2>
<div class="level2">

<p>
Board core firmware.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;profiles\/00-default.mk&quot;,&quot;hid&quot;:&quot;profiles00-defaultmk&quot;,&quot;codeblockOffset&quot;:4,&quot;secid&quot;:23,&quot;range&quot;:&quot;4510-&quot;} -->