
<h1 class="sectionedit1" id="smpcmt_broadcom_63xx">SMP/CMT Broadcom 63xx</h1>
<div class="level1">

</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_start&quot;,&quot;name&quot;:&quot;meta:infobox:wip&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:2,&quot;range&quot;:&quot;0-&quot;} --><div class="plugin_include_content plugin_include__meta:infobox:wip" id="plugin_include__meta__infobox__wip">
<div class="level1">
<!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_start&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:4,&quot;range&quot;:&quot;0-&quot;} --><div class="wrap_center wrap_wip plugin_wrap" style="width: 70%;">
<p>
<strong>Work in Progress!</strong><br/>

This page is a continuous work in progress. You can edit this page to contribute information. 
</p>
</div><!-- EDIT{&quot;target&quot;:&quot;plugin_wrap_end&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:5,&quot;range&quot;:&quot;0-&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;plugin_include_end&quot;,&quot;name&quot;:&quot;meta:infobox:wip&quot;,&quot;hid&quot;:&quot;&quot;,&quot;secid&quot;:3,&quot;range&quot;:&quot;0-&quot;} --></div>
<div class="level1">

<p>
An example of SMP initialization on BCM6358 SoC: <a href="http://pastebin.com/wV3njK7c" class="urlextern" title="http://pastebin.com/wV3njK7c" rel="ugc nofollow">http://pastebin.com/wV3njK7c</a> taken from 
<del><a href="http://www.livebox-floss.com/Products//LiveBox/LiveBox1/Thomson/vunknown/linux-2.6.12.tar.bz2" class="urlextern" title="http://www.livebox-floss.com/Products//LiveBox/LiveBox1/Thomson/vunknown/linux-2.6.12.tar.bz2" rel="ugc nofollow">linux-2.6.12.tar.bz2</a></del>, mirror →<a href="https://drive.google.com/uc?export=download&amp;id=0B-EMoBe-_OdBRnppenZMOExOUEU" class="urlextern" title="https://drive.google.com/uc?export=download&amp;id=0B-EMoBe-_OdBRnppenZMOExOUEU" rel="ugc nofollow">linux-2.6.12-inv.zip</a>
</p>

<p>
OpenWrt SMP on BMIPS cores: <a href="http://lxr.free-electrons.com/source/arch/mips/kernel/smp-bmips.c" class="urlextern" title="http://lxr.free-electrons.com/source/arch/mips/kernel/smp-bmips.c" rel="ugc nofollow">smp-bmips.c</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;SMP\/CMT Broadcom 63xx&quot;,&quot;hid&quot;:&quot;smpcmt_broadcom_63xx&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;1-538&quot;} -->
<h2 class="sectionedit6" id="main_thread">Main Thread</h2>
<div class="level2">

<p>
The main thread is configured by the bootloader (CFE) when the SoC is initialized. It can be checked in the log returned by CFE via serial. Example:
</p>
<pre class="code">CFE version cfe.d081.5003 for BCM96358 (32bit,SP,BE)
Build Date: Wed Nov 11 10:36:35 CST 2009 (Lihua_68693)
Copyright (C) 2006 Huawei Technologies Co. Ltd.


Boot Address 0xbe000000

Initializing Arena.
Initializing Devices.

@w45260: Flash Manufacture id :c2

@w45260Flash Device id :2201

@w45260flipCFIGeometry:1
Parallel flash device: name , id 0x2201, size 16384KB
*** GetHG556aBoardVersion = &lt;0&gt; ***

CPU type 0x2A010: 300MHz, Bus: 133MHz, Ref: 64MHz
Total memory: 67108864 bytes (64MB)

Total memory used by CFE:  0x80401000 - 0x8052A510 (1217808)
Initialized Data:          0x8041F3C0 - 0x80421B60 (10144)
BSS Area:                  0x80421B60 - 0x80428510 (27056)
Local Heap:                0x80428510 - 0x80528510 (1048576)
Stack Area:                0x80528510 - 0x8052A510 (8192)
Text (code) segment:       0x80401000 - 0x8041F3B4 (123828)
Boot area (physical):      0x0052B000 - 0x0056B000
Relocation Factor:         I:00000000 - D:00000000

*** GetHG556aBoardVersion = &lt;0&gt; ***

Board IP address                  : 192.168.1.1  
Host IP address                   : 192.168.1.35  
Gateway IP address                :   
Run from flash/host (f/h)         : h  
Default host run file name        : vmlinux  
Default host flash file name      : bcm963xx_fs_kernel  
Boot delay (0-9 seconds)          : 1  
Board Id Name                     : HW556  
Psi size in KB                    : 64
Number of MAC Addresses (1-32)    : 14  
Base MAC Address                  : 5c:4c:a9:6e:4a:a2  
Ethernet PHY Type                 : Internal
Memory size in MB                 : 64
CMT Thread Number                 : 1</pre>

<p>
Here we have
</p>
<pre class="code">CMT Thread Number                 : 1</pre>

<p>
Then the main thread will be the core1. This is important since the BCM6358 SoC cores haven&#039;t the same features:
</p>
<div class="table sectionedit7"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> BCM6358   </th><th class="col1 centeralign">  Data cache  </th><th class="col2 centeralign">  Instruction cache  </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 centeralign">   core0   </td><td class="col1 centeralign" rowspan="2">     16kB     </td><td class="col2 centeralign">        32kB         </td>
	</tr>
	<tr class="row2">
		<td class="col0 centeralign">   core1   </td><td class="col1 centeralign">        16kB         </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table&quot;,&quot;secid&quot;:7,&quot;range&quot;:&quot;2523-2675&quot;} -->
<p>
This parameter is located between <strong>offsets 0x014-0x017</strong> in <a href="/docs/techref/bootloader/cfe#bcm63xx_cfe" class="wikilink1" title="docs:techref:bootloader:cfe" data-wiki-id="docs:techref:bootloader:cfe">CFE</a>. We can change it HEX editing the CFE. Setting the value to 0, makes the core0 the main thread. This brings 32kB instead 16kB icache to the operating system and therefore increases the performance.
</p>

<p>
Some CFEs allow to change the Main thread using the command line interface. This option is probably only present in most recent SoCs such as BCM6368.
</p>

<p>
BCM6368 SoC cores are identical:
</p>
<div class="table sectionedit8"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> BCM6368   </th><th class="col1 centeralign">  Data cache  </th><th class="col2 centeralign">  Instruction cache  </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 centeralign">   core0   </td><td class="col1 centeralign" rowspan="2">     32kB     </td><td class="col2 centeralign">        64kB         </td>
	</tr>
	<tr class="row2">
		<td class="col0 centeralign">   core1   </td><td class="col1 centeralign">        64kB         </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table1&quot;,&quot;secid&quot;:8,&quot;range&quot;:&quot;3169-3321&quot;} -->
<p>
So no benefit using a different core for the main thread.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Main Thread&quot;,&quot;hid&quot;:&quot;main_thread&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;539-3380&quot;} -->
<h2 class="sectionedit9" id="cp0_registers">CP0 Registers</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;CP0 Registers&quot;,&quot;hid&quot;:&quot;cp0_registers&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:9,&quot;range&quot;:&quot;3381-3406&quot;} -->
<h3 class="sectionedit10" id="configuration_registers">Configuration Registers</h3>
<div class="level3">

<p>
To know if your CPU has concurrent multi-threading support (CMT) check <strong>bit 18</strong> at BRCM Configuration register (read_c0_brcm_config_0):<br/>

0 = 1 core<br/>

1 = 2 cores, multi-thread supported<br/>

</p>

<p>
Also check the <strong>bit 12</strong>:<br/>

1 = Multicore CPU with split I-cache<br/>

0 = Multicore CPU with shared I-cache
</p>
<div class="table sectionedit11"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0" colspan="3"> c0_register($22, 0) </th>
	</tr>
	<tr class="row1">
		<th class="col0"> Name </th><th class="col1"> bit </th><th class="col2"> typical value </th>
	</tr>
	</thead>
	<tr class="row2">
		<td class="col0"> Instruction Cache enabled </td><td class="col1"> 31 </td><td class="col2 centeralign">  1  </td>
	</tr>
	<tr class="row3">
		<td class="col0"> Data Cache enabled </td><td class="col1"> 30 </td><td class="col2 centeralign">  1  </td>
	</tr>
	<tr class="row4">
		<td class="col0"> RAC presence </td><td class="col1"> 29 </td><td class="col2 centeralign">  1  </td>
	</tr>
	<tr class="row5">
		<td class="col0"> TLB power save disabled </td><td class="col1"> 28 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row6">
		<td class="col0"> EJTAG power save disabled </td><td class="col1"> 27 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row7">
		<td class="col0"> unknown </td><td class="col1"> 26 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row8">
		<td class="col0"> DSU Power save enabled </td><td class="col1"> 25 </td><td class="col2 centeralign">  1  </td>
	</tr>
	<tr class="row9">
		<td class="col0"> D-Cache power save enabled </td><td class="col1"> 24 </td><td class="col2 centeralign">  1  </td>
	</tr>
	<tr class="row10">
		<td class="col0"> unknown </td><td class="col1"> 23 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row11">
		<td class="col0"> ADSL with extra instructions </td><td class="col1"> 22 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row12">
		<td class="col0"> Branch prediction disabled </td><td class="col1"> 21 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row13">
		<td class="col0"> Critical Line First </td><td class="col1"> 20 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row14">
		<td class="col0"> Ordered Write Buffer </td><td class="col1"> 19 </td><td class="col2 centeralign">  1  </td>
	</tr>
	<tr class="row15">
		<td class="col0"> <strong>CMT support</strong> </td><td class="col1"> <strong>18</strong> </td><td class="col2 centeralign">  <strong>1</strong>  </td>
	</tr>
	<tr class="row16">
		<td class="col0"> NBK (non blocking Data Cache) </td><td class="col1"> 17 </td><td class="col2 centeralign">  1  </td>
	</tr>
	<tr class="row17">
		<td class="col0"> weak order flags </td><td class="col1"> 16 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row18">
		<td class="col0"> unknown </td><td class="col1"> 15 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row19">
		<td class="col0"> unknown </td><td class="col1"> 14 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row20">
		<td class="col0"> unknown </td><td class="col1"> 13 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row21">
		<td class="col0"> <strong>split I-cache for each thread</strong> </td><td class="col1"> <strong>12</strong> </td><td class="col2 centeralign">  <strong>1</strong>  </td>
	</tr>
	<tr class="row22">
		<td class="col0"> unknown </td><td class="col1"> 11 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row23">
		<td class="col0"> unknown </td><td class="col1"> 10 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row24">
		<td class="col0"> unknown </td><td class="col1"> 9 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row25">
		<td class="col0"> unknown </td><td class="col1"> 8 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row26">
		<td class="col0"> unknown </td><td class="col1"> 7 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row27">
		<td class="col0"> unknown </td><td class="col1"> 6 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row28">
		<td class="col0"> unknown </td><td class="col1"> 5 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row29">
		<td class="col0"> unknown </td><td class="col1"> 4 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row30">
		<td class="col0"> unknown </td><td class="col1"> 3 </td><td class="col2 centeralign">  0  </td>
	</tr>
	<tr class="row31">
		<td class="col0"> unknown </td><td class="col1"> 2 </td><td class="col2 centeralign">  1  </td>
	</tr>
	<tr class="row32">
		<td class="col0"> unknown </td><td class="col1"> 1 </td><td class="col2 centeralign">  1  </td>
	</tr>
	<tr class="row33">
		<td class="col0"> Counter Register disabled </td><td class="col1"> 0 </td><td class="col2 centeralign">  0  </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table2&quot;,&quot;secid&quot;:11,&quot;range&quot;:&quot;3739-4787&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Configuration Registers&quot;,&quot;hid&quot;:&quot;configuration_registers&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:10,&quot;range&quot;:&quot;3407-4788&quot;} -->
<h3 class="sectionedit12" id="cmt_interrupt_registers">CMT Interrupt Registers</h3>
<div class="level3">

<p>
read_c0_brcm_cmt_intr();
</p>
<div class="table sectionedit13"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0" colspan="4"> register($22, 1) </th>
	</tr>
	<tr class="row1">
		<th class="col0"> Name </th><th class="col1"> bit </th><th class="col2"> value </th><th class="col3"> description </th>
	</tr>
	</thead>
	<tr class="row2">
		<td class="col0"> <strong>external interrupt 4 routing</strong> </td><td class="col1"> 31 </td><td class="col2 centeralign">  1<br/>
0  </td><td class="col3"> IP4: set A to T1, set B to T0<br/>
IP4: set A to T0, set B to T1 </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <strong>external interrupt 3 routing</strong> </td><td class="col1"> 30 </td><td class="col2 centeralign">  1<br/>
0  </td><td class="col3"> IP3: set A to T1, set B to T0<br/>
IP3: set A to T0, set B to T1 </td>
	</tr>
	<tr class="row4">
		<td class="col0"> <strong>external interrupt 2 routing</strong> </td><td class="col1"> 29 </td><td class="col2 centeralign">  1<br/>
0  </td><td class="col3"> IP2: set A to T1, set B to T0<br/>
IP2: set A to T0, set B to T1 </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <strong>external interrupt 1 routing</strong> </td><td class="col1"> 28 </td><td class="col2 centeralign">  1<br/>
0  </td><td class="col3"> IP1: set A to T1, set B to T0<br/>
IP1: set A to T0, set B to T1 </td>
	</tr>
	<tr class="row6">
		<td class="col0"> <strong>external interrupt 0 routing</strong> </td><td class="col1"> 27 </td><td class="col2 centeralign">  1<br/>
0  </td><td class="col3"> IP0: set A to T1, set B to T0<br/>
IP0: set A to T0, set B to T1 </td>
	</tr>
	<tr class="row7">
		<td class="col0"> unknown </td><td class="col1"> 26 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row8">
		<td class="col0"> unknown </td><td class="col1"> 25 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row9">
		<td class="col0"> unknown </td><td class="col1"> 24 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row10">
		<td class="col0"> unknown </td><td class="col1"> 23 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row11">
		<td class="col0"> unknown </td><td class="col1"> 22 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row12">
		<td class="col0"> unknown </td><td class="col1"> 21 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row13">
		<td class="col0"> unknown </td><td class="col1"> 20 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row14">
		<td class="col0"> unknown </td><td class="col1"> 19 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row15">
		<td class="col0"> unknown </td><td class="col1"> 18 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row16">
		<td class="col0"> unknown </td><td class="col1"> 17 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row17">
		<td class="col0"> <strong>software interrupt 1 routing</strong> </td><td class="col1"> 16 </td><td class="col2 centeralign">  1<br/>
0  </td><td class="col3"> SOFT1: set A to T1, set B to T0<br/>
SOFT1: set A to T0, set B to T1 </td>
	</tr>
	<tr class="row18">
		<td class="col0"> <strong>software interrupt 0 routing</strong> </td><td class="col1"> 15 </td><td class="col2 centeralign">  1<br/>
0  </td><td class="col3"> SOFT0: set A to T1, set B to T0<br/>
SOFT0: set A to T0, set B to T1 </td>
	</tr>
	<tr class="row19">
		<td class="col0"> unknown </td><td class="col1"> 14 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row20">
		<td class="col0"> unknown </td><td class="col1"> 13 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row21">
		<td class="col0"> unknown </td><td class="col1"> 12 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row22">
		<td class="col0"> unknown </td><td class="col1"> 11 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row23">
		<td class="col0"> unknown </td><td class="col1"> 10 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row24">
		<td class="col0"> unknown </td><td class="col1"> 9 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row25">
		<td class="col0"> unknown </td><td class="col1"> 8 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row26">
		<td class="col0"> unknown </td><td class="col1"> 7 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row27">
		<td class="col0"> unknown </td><td class="col1"> 6 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row28">
		<td class="col0"> unknown </td><td class="col1"> 5 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row29">
		<td class="col0"> unknown </td><td class="col1"> 4 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row30">
		<td class="col0"> unknown </td><td class="col1"> 3 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row31">
		<td class="col0"> unknown </td><td class="col1"> 2 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row32">
		<td class="col0"> <strong>NMI interrupt routing to thread</strong> </td><td class="col1"> 1<br/>
0 </td><td class="col2 centeralign">  01<br/>
10  </td><td class="col3"> NMI routed to thread 0<br/>
NMI routed to thread 1 </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table3&quot;,&quot;secid&quot;:13,&quot;range&quot;:&quot;4848-6405&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;CMT Interrupt Registers&quot;,&quot;hid&quot;:&quot;cmt_interrupt_registers&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:12,&quot;range&quot;:&quot;4789-6406&quot;} -->
<h3 class="sectionedit14" id="cmt_control_registers">CMT Control Registers</h3>
<div class="level3">

<p>
read_c0_brcm_cmt_ctrl();
</p>
<div class="table sectionedit15"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0" colspan="4"> register($22, 2) </th>
	</tr>
	<tr class="row1">
		<th class="col0"> Name </th><th class="col1"> bit </th><th class="col2"> value </th><th class="col3"> description </th>
	</tr>
	</thead>
	<tr class="row2">
		<td class="col0"> DSU_TP1 </td><td class="col1"> 31 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row3">
		<td class="col0"> unknown </td><td class="col1"> 30 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row4">
		<td class="col0"> unknown </td><td class="col1"> 29 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row5">
		<td class="col0"> unknown </td><td class="col1"> 28 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row6">
		<td class="col0"> unknown </td><td class="col1"> 27 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row7">
		<td class="col0"> unknown </td><td class="col1"> 26 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row8">
		<td class="col0"> unknown </td><td class="col1"> 25 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row9">
		<td class="col0"> unknown </td><td class="col1"> 24 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row10">
		<td class="col0"> unknown </td><td class="col1"> 23 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row11">
		<td class="col0"> unknown </td><td class="col1"> 22 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row12">
		<td class="col0"> unknown </td><td class="col1"> 21 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row13">
		<td class="col0"> unknown </td><td class="col1"> 20 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row14">
		<td class="col0"> TPS3 </td><td class="col1"> 19 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row15">
		<td class="col0"> TPS2 </td><td class="col1"> 18 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row16">
		<td class="col0"> TPS1 </td><td class="col1"> 17 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row17">
		<td class="col0"> TPS0 </td><td class="col1"> 16 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row18">
		<td class="col0"> unknown </td><td class="col1"> 15 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row19">
		<td class="col0"> unknown </td><td class="col1"> 14 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row20">
		<td class="col0"> unknown </td><td class="col1"> 13 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row21">
		<td class="col0"> unknown </td><td class="col1"> 12 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row22">
		<td class="col0"> unknown </td><td class="col1"> 11 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row23">
		<td class="col0"> unknown </td><td class="col1"> 10 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row24">
		<td class="col0"> unknown </td><td class="col1"> 9 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row25">
		<td class="col0"> unknown </td><td class="col1"> 8 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row26">
		<td class="col0"> unknown </td><td class="col1"> 7 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row27">
		<td class="col0"> unknown </td><td class="col1"> 6 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row28">
		<td class="col0"> <strong>give exception priority to thread 1</strong> </td><td class="col1"> 5 </td><td class="col2 centeralign">  1  </td><td class="col3"> D-cache priority to thread 1 </td>
	</tr>
	<tr class="row29">
		<td class="col0"> <strong>give exception priority to thread 0</strong> </td><td class="col1"> 4 </td><td class="col2 centeralign">  1  </td><td class="col3"> D-cache priority to thread 0 </td>
	</tr>
	<tr class="row30">
		<td class="col0"> unknown </td><td class="col1"> 3 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row31">
		<td class="col0"> unknown </td><td class="col1"> 2 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row32">
		<td class="col0"> unknown </td><td class="col1"> 1 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row33">
		<td class="col0"> <strong>thread 1 reset</strong> </td><td class="col1"> 0 </td><td class="col2 centeralign">  1  </td><td class="col3"> </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table4&quot;,&quot;secid&quot;:15,&quot;range&quot;:&quot;6464-7435&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;CMT Control Registers&quot;,&quot;hid&quot;:&quot;cmt_control_registers&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:14,&quot;range&quot;:&quot;6407-7436&quot;} -->
<h3 class="sectionedit16" id="cmt_local_registers">CMT Local Registers</h3>
<div class="level3">

<p>
read_c0_brcm_cmt_local();
</p>
<div class="table sectionedit17"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0" colspan="4"> register($22, 3) </th>
	</tr>
	<tr class="row1">
		<th class="col0"> Name </th><th class="col1"> bit </th><th class="col2"> value </th><th class="col3"> description </th>
	</tr>
	</thead>
	<tr class="row2">
		<td class="col0"> <strong>Thread identifier</strong> </td><td class="col1"> 31 </td><td class="col2 centeralign">  0  </td><td class="col3"> Return the thread ID where the code is executed </td>
	</tr>
	<tr class="row3">
		<td class="col0"> unknown </td><td class="col1"> 30 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row4">
		<td class="col0"> unknown </td><td class="col1"> 29 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row5">
		<td class="col0"> unknown </td><td class="col1"> 28 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row6">
		<td class="col0"> unknown </td><td class="col1"> 27 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row7">
		<td class="col0"> unknown </td><td class="col1"> 26 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row8">
		<td class="col0"> unknown </td><td class="col1"> 25 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row9">
		<td class="col0"> unknown </td><td class="col1"> 24 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row10">
		<td class="col0"> unknown </td><td class="col1"> 23 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row11">
		<td class="col0"> unknown </td><td class="col1"> 22 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row12">
		<td class="col0"> unknown </td><td class="col1"> 21 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row13">
		<td class="col0"> unknown </td><td class="col1"> 20 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row14">
		<td class="col0"> unknown </td><td class="col1"> 19 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row15">
		<td class="col0"> unknown </td><td class="col1"> 18 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row16">
		<td class="col0"> unknown </td><td class="col1"> 17 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row17">
		<td class="col0"> unknown </td><td class="col1"> 16 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row18">
		<td class="col0"> unknown </td><td class="col1"> 15 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row19">
		<td class="col0"> unknown </td><td class="col1"> 14 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row20">
		<td class="col0"> unknown </td><td class="col1"> 13 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row21">
		<td class="col0"> unknown </td><td class="col1"> 12 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row22">
		<td class="col0"> unknown </td><td class="col1"> 11 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row23">
		<td class="col0"> unknown </td><td class="col1"> 10 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row24">
		<td class="col0"> unknown </td><td class="col1"> 9 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row25">
		<td class="col0"> unknown </td><td class="col1"> 8 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row26">
		<td class="col0"> unknown </td><td class="col1"> 7 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row27">
		<td class="col0"> unknown </td><td class="col1"> 6 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row28">
		<td class="col0"> unknown </td><td class="col1"> 5 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row29">
		<td class="col0"> unknown </td><td class="col1"> 4 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row30">
		<td class="col0"> unknown </td><td class="col1"> 3 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row31">
		<td class="col0"> unknown </td><td class="col1"> 2 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row32">
		<td class="col0"> unknown </td><td class="col1"> 1 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
	<tr class="row33">
		<td class="col0"> unknown </td><td class="col1"> 0 </td><td class="col2 centeralign">  0  </td><td class="col3"> </td>
	</tr>
</table></div>
<!-- EDIT{&quot;target&quot;:&quot;table&quot;,&quot;name&quot;:&quot;&quot;,&quot;hid&quot;:&quot;table5&quot;,&quot;secid&quot;:17,&quot;range&quot;:&quot;7493-8405&quot;} -->
</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;CMT Local Registers&quot;,&quot;hid&quot;:&quot;cmt_local_registers&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:16,&quot;range&quot;:&quot;7437-8406&quot;} -->
<h2 class="sectionedit18" id="tlb_exception_handlers">TLB exception handlers</h2>
<div class="level2">

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;TLB exception handlers&quot;,&quot;hid&quot;:&quot;tlb_exception_handlers&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:18,&quot;range&quot;:&quot;8407-8441&quot;} -->
<h3 class="sectionedit19" id="bcm6358">BCM6358</h3>
<div class="level3">

<p>
On a CMT CPU, the TLB is shared between the two cores. Since hardware exception serialization must be turned off to allow ipis to reach the other core during operations such as I-cache flushing, we need to use software locking to ensure serialized access to the TLB and the corresponding CP0 registers.
</p>

<p>
Besides locking, the implementation is slightly different than on a standard SMP, as the CP0_CONTEXT is shared between the cores. Therefore it cannot be used to store <strong>the processor number</strong>, which <strong>is obtained from the CP0 CMT local register</strong> instead. It cannot be used to find the faulting address either.
</p>

<p>
If the lock cannot be taken, we must return from exception to allow software interrupts (of higher priority than TLB exceptions) to be serviced. The TLB exception will be retaken if really needed and we can try again to obtain the lock.
</p>

<p>
An entry may also be added on one core while the other core enters a TLB handler, so we must ensure the exception is is still valid by probing the TLB to avoid the following race:
</p>
<pre class="code">		TP0			TP1
	TLB exception
	acquire lock
	...			access Badvaddr corresponding to entry X
	write to tlb entry X	enter TLB exception
	release lock		acquire lock
				...
	&lt;refill:		Badvaddr may be present in the TLB now&gt;
	&lt;mod/load/store:	Badvaddr may have been removed from the TLB&gt;</pre>

<p>
 → <a href="http://pastebin.com/JWCFs0qz" class="urlextern" title="http://pastebin.com/JWCFs0qz" rel="ugc nofollow">http://pastebin.com/JWCFs0qz</a>
</p>

<p>
Note: 
Enable CMT support for the BCM6358 should be possible reviewing the code of linux-2.6.12.tar.bz2 (in the top of the page) and adapting it to a recent kernel.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;BCM6358&quot;,&quot;hid&quot;:&quot;bcm6358&quot;,&quot;codeblockOffset&quot;:2,&quot;secid&quot;:19,&quot;range&quot;:&quot;8442-9993&quot;} -->
<h3 class="sectionedit20" id="bcm6362_bcm6368">BCM6362, BCM6368</h3>
<div class="level3">

<p>
BCM6362 and BCM6368 have a private TLB for each thread.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;BCM6362, BCM6368&quot;,&quot;hid&quot;:&quot;bcm6362_bcm6368&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:20,&quot;range&quot;:&quot;9994-10077&quot;} -->
<h2 class="sectionedit21" id="openwrt_status">OpenWrt status</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> No support in BCM6358, mainly caused by the shared TLB.</div>
</li>
<li class="level1"><div class="li"> BCM6362 and BCM6368 are supported. Available through the SMP subtarget in trunk versions:<br/>
<a href="https://dev.openwrt.org/changeset/36526" class="urlextern" title="https://dev.openwrt.org/changeset/36526" rel="ugc nofollow">https://dev.openwrt.org/changeset/36526</a><br/>
<a href="https://dev.openwrt.org/changeset/36527" class="urlextern" title="https://dev.openwrt.org/changeset/36527" rel="ugc nofollow">https://dev.openwrt.org/changeset/36527</a></div>
</li>
<li class="level1"><div class="li"> Fatal bug causing jffs2 data corruption → temporal workaround <a href="https://dev.openwrt.org/changeset/40396" class="urlextern" title="https://dev.openwrt.org/changeset/40396" rel="ugc nofollow">https://dev.openwrt.org/changeset/40396</a></div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;OpenWrt status&quot;,&quot;hid&quot;:&quot;openwrt_status&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:21,&quot;range&quot;:&quot;10078-10462&quot;} -->
<h2 class="sectionedit22" id="devices">Devices</h2>
<div class="level2">

<p>
The list of related devices:
<a href="/tag/bcm63xx?do=showtag&amp;tag=bcm63xx" class="wikilink1 tag label label-default mx-1" title="tag:bcm63xx" rel="tag"><span class="iconify"  data-icon="mdi:tag-text-outline"></span> bcm63xx</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Devices&quot;,&quot;hid&quot;:&quot;devices&quot;,&quot;codeblockOffset&quot;:3,&quot;secid&quot;:22,&quot;range&quot;:&quot;10463-&quot;} -->